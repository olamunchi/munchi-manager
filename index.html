<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munchi Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- OCR Libraries - PDF.js Legacy + Tesseract -->
  <!-- Vers√£o 3.11 √© mais est√°vel que 4.x -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuzzball@2.1.2/dist/fuzzball.umd.min.js"></script>
  
  <script>
    // Configurar PDF.js worker
    console.log('üìÑ Carregando PDF.js v3.11 (legacy est√°vel)...');
    
    const configurePDFJS = () => {
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        console.log('‚úÖ PDF.js v3.11 configurado!');
        return true;
      }
      return false;
    };
    
    // Tentar configurar imediatamente
    if (!configurePDFJS()) {
      // Retry ap√≥s 500ms
      setTimeout(() => {
        if (!configurePDFJS()) {
          // Retry final ap√≥s 1.5s
          setTimeout(() => {
            if (!configurePDFJS()) {
              console.error('‚ùå PDF.js n√£o carregou ap√≥s 2 segundos');
            }
          }, 1000);
        }
      }, 500);
    }
  </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

// Icons
const Plus = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
const Trash2 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
const Upload = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
const Download = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>;
const TrendingUp = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
const DollarSign = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const Package = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>;
const FileText = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
const Calculator = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>;
const BarChart3 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>;
const Target = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
const Check = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;
const X = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
const AlertCircle = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const ChevronDown = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>;
const ChevronUp = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>;
const Search = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
const Settings = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
const Edit2 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
const Edit = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>;
const Save = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>;
const Users = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;
const Paperclip = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>;
const FilePdf = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>;
const Eye = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>;

// ==================== GITHUB GIST SYNC ====================
const GitHubSync = {
  GIST_ID_KEY: 'munchi_gist_id',
  TOKEN_KEY: 'munchi_github_token',
  LAST_SYNC_KEY: 'munchi_last_sync',
  
  async saveToGist(data, token) {
    try {
      const gistId = localStorage.getItem(this.GIST_ID_KEY);
      const url = gistId 
        ? `https://api.github.com/gists/${gistId}`
        : 'https://api.github.com/gists';
      
      const method = gistId ? 'PATCH' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          description: 'Munchi Manager - Backup Autom√°tico',
          public: false,
          files: {
            'munchi-data.json': {
              content: JSON.stringify(data, null, 2)
            }
          }
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`GitHub API error: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      
      if (!gistId) {
        localStorage.setItem(this.GIST_ID_KEY, result.id);
      }
      
      localStorage.setItem(this.LAST_SYNC_KEY, new Date().toISOString());
      
      return { success: true, gistId: result.id, url: result.html_url };
    } catch (error) {
      console.error('Erro ao guardar no GitHub:', error);
      return { success: false, error: error.message };
    }
  },
  
  async loadFromGist(token) {
    try {
      const gistId = localStorage.getItem(this.GIST_ID_KEY);
      if (!gistId) {
        return { success: false, error: 'Nenhum backup encontrado' };
      }
      
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: {
          'Authorization': `token ${token}`,
        }
      });
      
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }
      
      const gist = await response.json();
      const content = gist.files['munchi-data.json'].content;
      const data = JSON.parse(content);
      
      return { success: true, data };
    } catch (error) {
      console.error('Erro ao carregar do GitHub:', error);
      return { success: false, error: error.message };
    }
  },
  
  isConfigured() {
    return !!localStorage.getItem(this.TOKEN_KEY);
  },
  
  getToken() {
    return localStorage.getItem(this.TOKEN_KEY);
  },
  
  setToken(token) {
    localStorage.setItem(this.TOKEN_KEY, token);
  },
  
  clearConfig() {
    localStorage.removeItem(this.TOKEN_KEY);
    localStorage.removeItem(this.GIST_ID_KEY);
    localStorage.removeItem(this.LAST_SYNC_KEY);
  },
  
  getLastSync() {
    const lastSync = localStorage.getItem(this.LAST_SYNC_KEY);
    return lastSync ? new Date(lastSync) : null;
  },
  
  getGistUrl() {
    const gistId = localStorage.getItem(this.GIST_ID_KEY);
    return gistId ? `https://gist.github.com/${gistId}` : null;
  },
  
  getAutoSyncEnabled() {
    const enabled = localStorage.getItem('munchi_auto_sync_enabled');
    return enabled === null ? true : enabled === 'true';
  },
  
  setAutoSyncEnabled(enabled) {
    localStorage.setItem('munchi_auto_sync_enabled', enabled.toString());
  }
};

// Novos √≠cones para cloud sync
const Cloud = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>;
const CloudCheck = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const RefreshCw = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;


if (typeof window.storage === 'undefined') {
  window.storage = {
    get: (key) => { try { const value = localStorage.getItem(key); return value ? { key, value, shared: false } : null; } catch { return null; } },
    set: (key, value) => { try { localStorage.setItem(key, value); return { key, value, shared: false }; } catch { return null; } },
    delete: (key) => { try { localStorage.removeItem(key); return { key, deleted: true, shared: false }; } catch { return null; } },
    list: () => ({ keys: Object.keys(localStorage), shared: false })
  };
}




const CloudSyncPanel = ({ 
  onSync, 
  isSyncing, 
  lastSync, 
  syncError,
  autoSyncEnabled,
  setAutoSyncEnabled 
}) => {
  const [showConfig, setShowConfig] = React.useState(false);
  const [token, setToken] = React.useState('');
  const [showToken, setShowToken] = React.useState(false);
  
  const isConfigured = GitHubSync.isConfigured();
  const gistUrl = GitHubSync.getGistUrl();
  
  const saveToken = () => {
    if (token.trim()) {
      GitHubSync.setToken(token.trim());
      setShowConfig(false);
      setToken('');
      alert('‚úÖ Token guardado! A sincronizar dados...');
      setTimeout(onSync, 500);
    }
  };
  
  const clearConfig = () => {
    if (confirm('‚ö†Ô∏è Tem a certeza que quer desconectar o GitHub?\n\nOs dados locais N√ÉO ser√£o apagados, mas o backup autom√°tico ser√° desativado.')) {
      GitHubSync.clearConfig();
      setShowConfig(false);
      alert('‚úÖ GitHub desconectado');
    }
  };
  
  const getTimeSince = (date) => {
    if (!date) return 'Nunca';
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Agora mesmo';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `H√° ${minutes} min`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `H√° ${hours}h`;
    const days = Math.floor(hours / 24);
    return `H√° ${days} ${days === 1 ? 'dia' : 'dias'}`;
  };
  
  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Cloud className="w-6 h-6 text-blue-600" />
          <div>
            <h3 className="font-bold text-blue-900">Backup Cloud (GitHub)</h3>
            {isConfigured && !showConfig && (
              <p className="text-xs text-blue-700">Auto-sync: {autoSyncEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</p>
            )}
          </div>
        </div>
        <button
          onClick={() => setShowConfig(!showConfig)}
          className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded transition"
          title="Configura√ß√µes"
        >
          <Settings className="w-5 h-5" />
        </button>
      </div>
      
      {showConfig ? (
        <div className="space-y-3 bg-white rounded-lg p-4 border border-blue-300">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üîë GitHub Personal Access Token
            </label>
            <div className="relative">
              <input
                type={showToken ? "text" : "password"}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                className="w-full px-3 py-2 pr-20 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-semibold"
              >
                {showToken ? 'Ocultar' : 'Mostrar'}
              </button>
            </div>
            
            <div className="mt-2 space-y-1 text-xs text-gray-600">
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">1.</span>
                <span>Crie token em: <a href="https://github.com/settings/tokens/new?scopes=gist&description=Munchi%20Manager%20Backup" target="_blank" className="text-blue-600 underline font-semibold hover:text-blue-800">github.com/settings/tokens</a></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">2.</span>
                <span>Marque apenas: <strong className="text-green-700">‚úì gist</strong></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">3.</span>
                <span>Cole aqui e clique em "Guardar"</span>
              </p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={saveToken}
              disabled={!token.trim()}
              className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
            >
              üíæ Guardar Token
            </button>
            {isConfigured && (
              <button
                onClick={clearConfig}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition"
              >
                üîå Desconectar
              </button>
            )}
          </div>
          
          <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-900">
            <p className="font-semibold mb-1 flex items-center gap-1">
              üîí Seguran√ßa & Privacidade
            </p>
            <ul className="space-y-1 ml-4 text-yellow-800">
              <li>‚Ä¢ Token guardado <strong>localmente</strong> no seu browser</li>
              <li>‚Ä¢ Nunca partilhado com servidores externos</li>
              <li>‚Ä¢ Gist criado como <strong>privado</strong> (s√≥ voc√™ v√™)</li>
              <li>‚Ä¢ Pode revogar token a qualquer momento</li>
            </ul>
          </div>
        </div>
      ) : (
        <>
          {!isConfigured ? (
            <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              <p className="text-sm text-yellow-800 flex items-center gap-2">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <span>Configure o GitHub para ativar backup autom√°tico na cloud</span>
              </p>
              <button
                onClick={() => setShowConfig(true)}
                className="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-semibold transition text-sm"
              >
                ‚öôÔ∏è Configurar Agora
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              {/* Status Card */}
              <div className="bg-white rounded-lg p-3 border-2 border-green-300 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <CloudCheck className="w-5 h-5 text-green-600" />
                    <div>
                      <p className="text-sm font-semibold text-green-900">Conectado ‚úì</p>
                      <p className="text-xs text-green-700">√öltimo backup: {getTimeSince(lastSync)}</p>
                    </div>
                  </div>
                  <button
                    onClick={onSync}
                    disabled={isSyncing}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    {isSyncing ? 'A sincronizar...' : 'Sync'}
                  </button>
                </div>
                
                {gistUrl && (
                  <a
                    href={gistUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1"
                  >
                    üîó Ver backup no GitHub
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
              
              {/* Error Message */}
              {syncError && (
                <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                  <p className="text-sm text-red-800 flex items-start gap-2">
                    <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                    <span><strong>Erro:</strong> {syncError}</span>
                  </p>
                  <button
                    onClick={() => setShowConfig(true)}
                    className="mt-2 text-xs text-red-700 hover:text-red-900 underline font-semibold"
                  >
                    ‚Üí Reconfigurar token
                  </button>
                </div>
              )}
              
              {/* Auto-sync Toggle */}
              <div className="flex items-center justify-between bg-white rounded p-2 border border-gray-200">
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="autoSyncToggle"
                    checked={autoSyncEnabled}
                    onChange={(e) => setAutoSyncEnabled(e.target.checked)}
                    className="w-4 h-4 rounded text-blue-600 focus:ring-2 focus:ring-blue-500"
                  />
                  <label htmlFor="autoSyncToggle" className="text-sm text-gray-700 cursor-pointer">
                    üîÑ Auto-sync a cada 5 minutos
                  </label>
                </div>
                <span className={`text-xs font-semibold px-2 py-1 rounded ${autoSyncEnabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                  {autoSyncEnabled ? 'ON' : 'OFF'}
                </span>
              </div>
              
              {/* Info Box */}
              <div className="bg-blue-50 border border-blue-200 rounded p-2 text-xs text-blue-800">
                <p className="font-semibold mb-1">üí° Como funciona:</p>
                <ul className="space-y-0.5 ml-3">
                  <li>‚Ä¢ Dados guardados automaticamente no GitHub</li>
                  <li>‚Ä¢ Aceda de qualquer dispositivo com o mesmo token</li>
                  <li>‚Ä¢ Hist√≥rico completo no seu Gist privado</li>
                </ul>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

const ComprasAnalysis = ({ despesas, faturas = [], ingredientes, fornecedores }) => {
  const [searchCompra, setSearchCompra] = React.useState('');
  const [expandedIngrediente, setExpandedIngrediente] = React.useState(null); // Ingrediente expandido na an√°lise
  const [categoriaCompra, setCategoriaCompra] = React.useState('all');
  
  // Combinar despesas antigas com faturas novas
  const todasCompras = React.useMemo(() => {
    const compras = [];
    
    // Adicionar despesas antigas (se existirem)
    despesas.forEach(d => {
      if (d.ingredienteId && d.quantidade && d.quantidade > 0) {
        compras.push({
          ingredienteId: d.ingredienteId,
          quantidade: d.quantidade,
          fornecedor: d.fornecedor,
          precoUnitario: d.valor / d.quantidade,
          data: d.data
        });
      }
    });
    
    // Adicionar items de faturas novas
    faturas.forEach(f => {
      if (f.itens && Array.isArray(f.itens)) {
        f.itens.forEach(item => {
          compras.push({
            ingredienteId: item.ingredienteId || item.ingrediente,
            quantidade: item.quantidade,
            fornecedor: f.fornecedor || f.fornecedorNome,
            precoUnitario: item.precoUnitario,
            data: f.data
          });
        });
      }
    });
    
    return compras;
  }, [despesas, faturas]);
  
  
  // Categorize ingredients
  const categorias = {
    'vegetais': ['alface', 'tomate', 'cebola', 'cenoura', 'batata', 'cogumelo', 'pimento', 'alho', 'couve', 'br√≥colos', 'espinafre'],
    'carnes': ['frango', 'carne', 'porco', 'vaca', 'peru', 'bacon', 'salsicha', 'bife', 'costela'],
    'peixe': ['salm√£o', 'atum', 'bacalhau', 'camar√£o', 'polvo', 'lula', 'peixe', 'marisco'],
    'latic√≠nios': ['leite', 'queijo', 'iogurte', 'manteiga', 'nata', 'mozzarella', 'requeij√£o', 'mozarela'],
    'padaria': ['p√£o'],
    'pastelaria': ['farinha', 'fermento', 'chocolate', 'cacau', 'baunilha', 'am√™ndoa', 'noz'],
    'compotas': ['a√ß√∫car', 'pectina', '√°cido c√≠trico'],
    'bebidas': ['√°gua', 'sumo', 'refrigerante', 'vinho', 'cerveja', 'caf√©', 'ch√°'],
    'temperos': ['sal', 'pimenta', 'azeite', 'vinagre', 'oreg√£os', 'especiaria', 'canela', 'colorau']
  };
  
  const getCategoria = (ingrediente) => {
    return ingrediente.categoria || 'outros';
  };
  
  // Build price comparison data
  const comprasPorIngrediente = React.useMemo(() => {
    const result = {};
    todasCompras.forEach(compra => {
      const ing = ingredientes.find(i => i.id == compra.ingredienteId);
      if (!ing) return;
      
      if (!result[compra.ingredienteId]) {
        result[compra.ingredienteId] = {
          nome: ing.nome,
          unidade: ing.unidade,
          categoria: getCategoria(ing),
          compras: []
        };
      }
      
      result[compra.ingredienteId].compras.push({
        fornecedor: compra.fornecedor,
        precoUnitario: compra.precoUnitario,
        data: compra.data,
        quantidade: compra.quantidade
      });
    });
    return result;
  }, [todasCompras, ingredientes]);
  
  // Filter ingredients
  const ingredientesFiltrados = React.useMemo(() => {
    let filtered = Object.values(comprasPorIngrediente).filter(ing => ing.compras.length > 0);
    
    if (categoriaCompra !== 'all') {
      filtered = filtered.filter(ing => ing.categoria === categoriaCompra);
    }
    
    if (searchCompra) {
      filtered = filtered.filter(ing => 
        ing.nome.toLowerCase().includes(searchCompra.toLowerCase())
      );
    }
    
    return filtered.slice(0, 50);
  }, [comprasPorIngrediente, categoriaCompra, searchCompra]);
  
  // Count by category
  const countByCategoria = React.useMemo(() => {
    const counts = {};
    Object.values(comprasPorIngrediente).forEach(ing => {
      counts[ing.categoria] = (counts[ing.categoria] || 0) + 1;
    });
    return counts;
  }, [comprasPorIngrediente]);
  
  const allCount = Object.values(comprasPorIngrediente).filter(ing => ing.compras.length > 0).length;
  
  return (
    <div className="bg-white rounded-lg shadow p-3">
      <h2 className="text-base font-bold mb-3">üìä An√°lise de Compras</h2>
      
      {/* Summary Cards */}
<div className="grid grid-cols-3 gap-2 mb-3">
        <div className="bg-blue-50 rounded p-3 border border-blue-200">
          <p className="text-xs text-blue-700 mb-1">Total Compras</p>
          <p className="text-xl font-bold text-blue-900">
            ‚Ç¨{todasCompras.reduce((sum, c) => sum + (c.precoUnitario * c.quantidade), 0).toFixed(2)}
          </p>
        </div>
        <div className="bg-green-50 rounded p-3 border border-green-200">
          <p className="text-xs text-green-700 mb-1">N¬∫ Fornecedores</p>
          <p className="text-xl font-bold text-green-900">{(fornecedores || []).length}</p>
        </div>
        <div className="bg-purple-50 rounded p-3 border border-purple-200">
          <p className="text-xs text-purple-700 mb-1">Ingredientes</p>
          <p className="text-xl font-bold text-purple-900">{(ingredientes || []).length}</p>
        </div>
      </div>

      {/* Price Comparison */}
      <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded border border-blue-200 p-3">
        <h3 className="text-sm font-bold mb-3 text-blue-900">üí∞ Compara√ß√£o de Pre√ßos</h3>
        
        {/* Category Tabs */}
        <div className="flex gap-1 mb-3 overflow-x-auto bg-white p-1 rounded">
          {[
            {id: 'all', emoji: 'üì¶', label: 'Todos', count: allCount},
            {id: 'vegetais', emoji: 'ü•¨', label: 'Vegetais', count: countByCategoria['vegetais'] || 0},
            {id: 'carnes', emoji: 'ü•©', label: 'Carnes', count: countByCategoria['carnes'] || 0},
            {id: 'peixe', emoji: 'üêü', label: 'Peixe', count: countByCategoria['peixe'] || 0},
            {id: 'latic√≠nios', emoji: 'üßÄ', label: 'Latic√≠nios', count: countByCategoria['latic√≠nios'] || 0},
            {id: 'padaria', emoji: 'ü•ñ', label: 'Padaria', count: countByCategoria['padaria'] || 0},
            {id: 'pastelaria', emoji: 'üç∞', label: 'Pastelaria', count: countByCategoria['pastelaria'] || 0},
            {id: 'compotas', emoji: 'üçØ', label: 'Compotas', count: countByCategoria['compotas'] || 0},
            {id: 'bebidas', emoji: 'ü•§', label: 'Bebidas', count: countByCategoria['bebidas'] || 0},
            {id: 'temperos', emoji: 'üßÇ', label: 'Temperos', count: countByCategoria['temperos'] || 0},
            {id: 'embalagens', emoji: 'üì¶', label: 'Embalagens', count: countByCategoria['embalagens'] || 0},
            {id: 'limpeza', emoji: 'üßπ', label: 'Limpeza', count: countByCategoria['limpeza'] || 0},
            {id: 'outros', emoji: 'üìã', label: 'Outros', count: countByCategoria['outros'] || 0}
          ].map(cat => (
            <button
              key={cat.id}
              onClick={() => setCategoriaCompra(cat.id)}
              className={`px-3 py-1.5 rounded text-xs font-semibold whitespace-nowrap transition-colors ${
                categoriaCompra === cat.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {cat.emoji} {cat.label} ({cat.count})
            </button>
          ))}
        </div>
        
        {/* Search Bar */}
        <div className="mb-3">
          <input
            type="text"
            placeholder="üîç Procurar ingrediente..."
            value={searchCompra}
            onChange={(e) => setSearchCompra(e.target.value)}
            className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
          />
        </div>
        
        {/* Results */}
        {ingredientesFiltrados.length === 0 ? (
          <div className="text-center py-8 bg-white rounded border">
            <p className="text-sm text-gray-600">
              {searchCompra ? `Nenhum ingrediente encontrado com "${searchCompra}"` : 'Nenhum ingrediente nesta categoria'}
            </p>
          </div>
        ) : (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {ingredientesFiltrados.map(ing => {
              const precoMedio = ing.compras.reduce((s, c) => s + c.precoUnitario, 0) / ing.compras.length;
              const precoMin = Math.min(...ing.compras.map(c => c.precoUnitario));
              const precoMax = Math.max(...ing.compras.map(c => c.precoUnitario));
              const melhorCompra = ing.compras.reduce((best, curr) => 
                curr.precoUnitario < best.precoUnitario ? curr : best
              );
              
              const isExpanded = expandedIngrediente === ing.nome;
              
              return (
                <div key={ing.nome} className="bg-white rounded border hover:shadow-md transition-shadow">
                  {/* HEADER - Sempre vis√≠vel e clic√°vel */}
                  <div 
                    onClick={() => setExpandedIngrediente(isExpanded ? null : ing.nome)}
                    className="p-2 cursor-pointer hover:bg-gray-50 transition-colors"
                  >
                    <div className="flex justify-between items-start mb-1">
                      <div className="flex items-center gap-2">
                        <span className="text-gray-500">
                          {isExpanded ? '‚ñº' : '‚ñ∂'}
                        </span>
                        <span className="font-bold text-sm text-gray-800">{ing.nome}</span>
                      </div>
                      <div className="text-right">
                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded block">
                          {ing.compras.length} compra{ing.compras.length > 1 ? 's' : ''}
                        </span>
                        {(() => {
                          // Calculate monthly average
                          if (ing.compras.length === 0) return null;
                          
                          const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                          const firstDate = new Date(sortedCompras[0].data);
                          const lastDate = new Date(sortedCompras[sortedCompras.length - 1].data);
                          
                          // Calculate months between first and last purchase
                          const monthsDiff = (lastDate.getFullYear() - firstDate.getFullYear()) * 12 + 
                                            (lastDate.getMonth() - firstDate.getMonth()) + 1; // +1 to include both months
                          
                          const comprasPorMes = ing.compras.length / monthsDiff;
                          const qtdTotal = ing.compras.reduce((sum, c) => sum + c.quantidade, 0);
                          const qtdPorMes = qtdTotal / monthsDiff;
                          const gastoTotal = ing.compras.reduce((sum, c) => sum + (c.precoUnitario * c.quantidade), 0);
                          const gastoPorMes = gastoTotal / monthsDiff;
                          
                          return (
                            <div className="mt-1 text-[10px] text-gray-600 space-y-0.5">
                              <div className="bg-purple-50 px-1.5 py-0.5 rounded">
                                üìä {comprasPorMes.toFixed(1)}x/m√™s
                              </div>
                              <div className="bg-green-50 px-1.5 py-0.5 rounded">
                                üì¶ {qtdPorMes.toFixed(1)}{ing.unidade}/m√™s
                              </div>
                              <div className="bg-orange-50 px-1.5 py-0.5 rounded">
                                üí∞ ‚Ç¨{gastoPorMes.toFixed(2)}/m√™s
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-xs">
                      <div>
                        <span className="text-gray-600">M√©dio:</span>
                        <span className="font-semibold ml-1">‚Ç¨{precoMedio.toFixed(2)}/{ing.unidade}</span>
                      </div>
                      <div>
                        <span className="text-green-600">Min:</span>
                        <span className="font-semibold ml-1 text-green-700">‚Ç¨{precoMin.toFixed(2)}</span>
                      </div>
                      <div>
                        <span className="text-red-600">Max:</span>
                        <span className="font-semibold ml-1 text-red-700">‚Ç¨{precoMax.toFixed(2)}</span>
                      </div>
                    </div>
                    {melhorCompra.fornecedor && (
                      <p className="text-xs text-gray-600 mt-1">
                        üí° Melhor: <span className="font-semibold">{melhorCompra.fornecedor}</span> - ‚Ç¨{melhorCompra.precoUnitario.toFixed(2)}/{ing.unidade}
                      </p>
                    )}
                  </div>
                  
                  {/* CONTE√öDO EXPAND√çVEL - S√≥ vis√≠vel quando expandido */}
                  {isExpanded && (
                    <div className="px-2 pb-2 pt-2 border-t border-gray-200 bg-gray-50">
                      
                      {/* Hist√≥rico Completo de Compras */}
                      <div className="mb-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded p-2 border border-blue-200">
                        <p className="text-xs font-bold text-blue-900 mb-2">üìÖ Hist√≥rico Completo de Compras:</p>
                        <div className="space-y-1">
                          {ing.compras
                            .sort((a, b) => new Date(b.data) - new Date(a.data)) // Mais recente primeiro
                            .map((compra, idx) => {
                              const isMelhor = compra.precoUnitario === precoMin;
                              const isPior = compra.precoUnitario === precoMax;
                              return (
                                <div key={idx} className={`text-xs flex justify-between items-center p-1.5 rounded ${
                                  isMelhor ? 'bg-green-100 border border-green-300 font-semibold text-green-900' : 
                                  isPior ? 'bg-red-50 border border-red-200 text-red-800' : 
                                  'bg-white border border-gray-200 text-gray-700'
                                }`}>
                                  <span className="flex items-center gap-2">
                                    {isMelhor && 'üèÜ'}
                                    {isPior && '‚ö†Ô∏è'}
                                    {new Date(compra.data).toLocaleDateString('pt-PT')}
                                    {compra.fornecedor && ` ‚Ä¢ ${compra.fornecedor}`}
                                  </span>
                                  <span className="font-semibold">
                                    {compra.quantidade}{ing.unidade} √ó ‚Ç¨{compra.precoUnitario.toFixed(2)} = ‚Ç¨{(compra.quantidade * compra.precoUnitario).toFixed(2)}
                                  </span>
                                </div>
                              );
                            })}
                        </div>
                        <div className="mt-2 pt-2 border-t border-blue-200 text-xs text-blue-900">
                          <strong>Total gasto:</strong> ‚Ç¨{ing.compras.reduce((sum, c) => sum + (c.quantidade * c.precoUnitario), 0).toFixed(2)}
                        </div>
                      </div>
                  
                  {/* Hist√≥rico de Compras - sempre resumo */}
                  {ing.compras.length > 1 && (
                    <div className="mt-2 bg-gray-50 rounded p-2">
                      <p className="text-xs font-semibold text-gray-700 mb-1">üìÖ √öltimas Compras:</p>
                      <div className="space-y-0.5">
                        {ing.compras
                          .sort((a, b) => new Date(b.data) - new Date(a.data))
                          .slice(0, 3) // S√≥ mostrar as 3 mais recentes
                          .map((compra, idx) => {
                            const isMelhor = compra.precoUnitario === precoMin;
                            return (
                              <div key={idx} className={`text-xs flex justify-between items-center ${isMelhor ? 'font-semibold text-green-700' : 'text-gray-600'}`}>
                                <span>
                                  {new Date(compra.data).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' })} 
                                  {' ‚Ä¢ '}
                                  {compra.fornecedor}
                                </span>
                                <span>
                                  ‚Ç¨{compra.precoUnitario.toFixed(2)}/{ing.unidade}
                                  {isMelhor && ' ‚≠ê'}
                                </span>
                              </div>
                            );
                          })}
                      </div>
                      {isExpanded && <p className="text-xs text-blue-600 mt-1">üëá Ver detalhes completos abaixo</p>}
                    </div>
                  )}
                  
                  {/* Price Evolution Chart */}
                  {ing.compras.length > 2 && (
                    <div className="mt-2 bg-blue-50 rounded p-2 border border-blue-200">
                      <p className="text-xs font-semibold text-blue-900 mb-2">üìà Evolu√ß√£o de Pre√ßos</p>
                      <div className="relative h-40 bg-white rounded p-3">
                        {(() => {
                          const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                          const precos = sortedCompras.map(c => c.precoUnitario);
                          const minPreco = Math.min(...precos);
                          const maxPreco = Math.max(...precos);
                          const range = maxPreco - minPreco || 1;
                          
                          return (
                            <>
                              {/* Grid lines with labels */}
                              <div className="absolute inset-0 p-2 pointer-events-none">
                                {[0, 0.25, 0.5, 0.75, 1].map((percent, idx) => {
                                  const price = minPreco + (maxPreco - minPreco) * (1 - percent);
                                  const yPos = `${percent * 100}%`;
                                  return (
                                    <div key={idx} className="absolute w-full" style={{top: yPos}}>
                                      <div className={`border-t ${idx === 0 || idx === 4 ? 'border-gray-400' : 'border-gray-200'} border-dashed`}></div>
                                      <span className="absolute left-0 -top-2 text-[9px] font-semibold text-gray-700 bg-white/90 px-1">
                                        ‚Ç¨{price.toFixed(2)}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {/* Price line */}
                              <svg className="absolute inset-0 w-full h-full p-2" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                                <polyline
                                  points={sortedCompras.map((c, i) => {
                                    const x = (i / (sortedCompras.length - 1)) * 100;
                                    const y = 100 - ((c.precoUnitario - minPreco) / range) * 80;
                                    return `${x},${y}`;
                                  }).join(' ')}
                                  fill="none"
                                  stroke="#3b82f6"
                                  strokeWidth="0.8"
                                  vectorEffect="non-scaling-stroke"
                                />
                                {/* Points */}
                                {sortedCompras.map((c, i) => {
                                  const x = (i / (sortedCompras.length - 1)) * 100;
                                  const y = 100 - ((c.precoUnitario - minPreco) / range) * 80;
                                  const isMelhor = c.precoUnitario === minPreco;
                                  
                                  // Determine color based on price change
                                  let priceColor = '#6b7280'; // gray for first point
                                  if (i > 0) {
                                    const prevPrice = sortedCompras[i - 1].precoUnitario;
                                    if (c.precoUnitario < prevPrice) {
                                      priceColor = '#10b981'; // GREEN (desceu)
                                    } else if (c.precoUnitario > prevPrice) {
                                      priceColor = '#ef4444'; // RED (subiu)
                                    } else {
                                      priceColor = '#6b7280'; // GRAY (igual)
                                    }
                                  }
                                  
                                  return (
                                    <g key={i}>
                                      <circle
                                        cx={x}
                                        cy={y}
                                        r="2"
                                        fill={isMelhor ? '#10b981' : '#3b82f6'}
                                        stroke="white"
                                        strokeWidth="0.3"
                                      />
                                      {/* Price label */}
                                      <text
                                        x={x}
                                        y={y + 6}
                                        fontSize="6"
                                        fontWeight="800"
                                        fill={priceColor}
                                        stroke="white"
                                        strokeWidth="0.4"
                                        textAnchor="middle"
                                        className="pointer-events-none"
                                      >
                                        ‚Ç¨{c.precoUnitario.toFixed(2)}
                                      </text>
                                      {/* Date label */}
                                      <text
                                        x={x}
                                        y={y + 13}
                                        fontSize="4"
                                        fontWeight="700"
                                        fill="#6b7280"
                                        textAnchor="middle"
                                        className="pointer-events-none"
                                      >
                                        {new Date(c.data).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' })}
                                      </text>
                                    </g>
                                  );
                                })}
                              </svg>
                              

                              {/* Date labels - Smart spacing */}
                              <div className="absolute bottom-0 left-0 right-0 flex justify-between px-2 text-[9px] font-semibold text-blue-700">
                                {(() => {
                                  // Show 4-6 date markers evenly spaced
                                  const numLabels = Math.min(6, sortedCompras.length);
                                  const step = Math.max(1, Math.floor(sortedCompras.length / (numLabels - 1)));
                                  const labels = [];
                                  
                                  for (let i = 0; i < sortedCompras.length; i += step) {
                                    if (labels.length >= numLabels - 1) break;
                                    labels.push(i);
                                  }
                                  // Always include last
                                  if (labels[labels.length - 1] !== sortedCompras.length - 1) {
                                    labels.push(sortedCompras.length - 1);
                                  }
                                  
                                  return labels.map((idx, i) => (
                                    <span key={i} className="bg-blue-50/90 px-1 py-0.5 rounded">
                                      {new Date(sortedCompras[idx].data).toLocaleDateString('pt-PT', { day: 'numeric', month: 'short' })}
                                    </span>
                                  ));
                                })()}
                              </div>
                            </>
                          );
                        })()}
                      </div>
                      
                      {/* Trend indicator */}
                      {(() => {
                        const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                        const primeiroPreco = sortedCompras[0].precoUnitario;
                        const ultimoPreco = sortedCompras[sortedCompras.length - 1].precoUnitario;
                        const variacao = ((ultimoPreco - primeiroPreco) / primeiroPreco) * 100;
                        const isSubiu = variacao > 0;
                        
                        return (
                          <div className={`mt-1 text-xs flex items-center gap-1 ${isSubiu ? 'text-red-600' : variacao < 0 ? 'text-green-600' : 'text-gray-600'}`}>
                            {isSubiu ? 'üìà' : variacao < 0 ? 'üìâ' : '‚û°Ô∏è'}
                            <span className="font-semibold">
                              {isSubiu ? '+' : ''}{variacao.toFixed(1)}%
                            </span>
                            <span>desde {new Date(sortedCompras[0].data).toLocaleDateString('pt-PT', { month: 'short' })}</span>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                  
                  {/* Price Alerts */}
                  {ing.compras.length > 1 && (() => {
                    const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                    const precos = sortedCompras.map(c => c.precoUnitario);
                    const minPreco = Math.min(...precos);
                    const maxPreco = Math.max(...precos);
                    const variacao = ((maxPreco - minPreco) / minPreco) * 100;
                    
                    // Check last 30 days
                    const hoje = new Date();
                    const trinta_dias = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
                    const comprasRecentes = sortedCompras.filter(c => new Date(c.data) >= trinta_dias);
                    
                    // Trend in last month
                    let trendAlert = null;
                    if (comprasRecentes.length >= 2) {
                      const primeiraRecente = comprasRecentes[0].precoUnitario;
                      const ultimaRecente = comprasRecentes[comprasRecentes.length - 1].precoUnitario;
                      const variacaoMes = ((ultimaRecente - primeiraRecente) / primeiraRecente) * 100;
                      
                      if (variacaoMes > 5) {
                        trendAlert = { type: 'warning', message: `Pre√ßo subiu ${variacaoMes.toFixed(1)}% este m√™s`, icon: '‚ö†Ô∏è' };
                      } else if (variacaoMes < -5) {
                        trendAlert = { type: 'success', message: `Pre√ßo desceu ${Math.abs(variacaoMes).toFixed(1)}% este m√™s`, icon: '‚úÖ' };
                      }
                    }
                    
                    // Best price recently
                    const melhorCompraRecente = sortedCompras.find(c => c.precoUnitario === minPreco);
                    const diasDesdeRecorde = melhorCompraRecente ? Math.floor((hoje - new Date(melhorCompraRecente.data)) / (24 * 60 * 60 * 1000)) : 999;
                    const recordeRecente = diasDesdeRecorde <= 30;
                    
                    // High variation alert
                    const altaVariacao = variacao > 10;
                    
                    const alerts = [];
                    if (trendAlert) alerts.push(trendAlert);
                    if (recordeRecente) alerts.push({ 
                      type: 'info', 
                      message: `Melhor pre√ßo nos √∫ltimos 30 dias (${melhorCompraRecente.fornecedor})`,
                      icon: 'üéØ'
                    });
                    if (altaVariacao) alerts.push({
                      type: 'warning',
                      message: `Varia√ß√£o de ${variacao.toFixed(1)}% entre fornecedores`,
                      icon: 'üìä'
                    });
                    
                    return alerts.length > 0 ? (
                      <div className="mt-2 space-y-1">
                        {alerts.map((alert, idx) => (
                          <div 
                            key={idx}
                            className={`text-xs px-2 py-1 rounded flex items-start gap-1 ${
                              alert.type === 'warning' ? 'bg-orange-50 text-orange-800 border border-orange-200' :
                              alert.type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
                              'bg-blue-50 text-blue-800 border border-blue-200'
                            }`}
                          >
                            <span>{alert.icon}</span>
                            <span className="flex-1">{alert.message}</span>
                          </div>
                        ))}
                      </div>
                    ) : null;
                  })()}
                    </div>
                  )}
                </div>
              );
            })}
            {ingredientesFiltrados.length === 50 && (
              <p className="text-xs text-center text-gray-500 py-2">
                A mostrar 50 ingredientes. Refine a pesquisa para ver mais resultados espec√≠ficos.
              </p>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// ==================== GITHUB BACKUP PANEL COMPONENT ====================
const GitHubBackupPanel = ({ onSync }) => {
  const [token, setToken] = React.useState('');
  const [showToken, setShowToken] = React.useState(false);
  const [showConfig, setShowConfig] = React.useState(false);
  const [isSyncing, setIsSyncing] = React.useState(false);
  const [passwordInput, setPasswordInput] = React.useState('');
  const [showSavedToken, setShowSavedToken] = React.useState(false);
  
  const isConfigured = GitHubSync.isConfigured();
  const gistUrl = GitHubSync.getGistUrl();
  const lastSync = GitHubSync.getLastSync();
  const autoSyncEnabled = GitHubSync.getAutoSyncEnabled();

  const saveToken = () => {
    if (token.trim()) {
      GitHubSync.setToken(token.trim());
      setShowConfig(false);
      setToken('');
      alert('‚úÖ Token guardado! A sincronizar dados...');
      handleSync();
    }
  };

  const clearConfig = () => {
    if (confirm('‚ö†Ô∏è Tem a certeza que quer desconectar o GitHub?\\n\\nOs dados locais N√ÉO ser√£o apagados, mas o backup autom√°tico ser√° desativado.')) {
      GitHubSync.clearConfig();
      setShowConfig(false);
      alert('‚úÖ GitHub desconectado');
    }
  };

  const handleSync = async () => {
    setIsSyncing(true);
    try {
      await onSync();
    } finally {
      setIsSyncing(false);
    }
  };

  const getTimeSince = (dateString) => {
    if (!dateString) return 'Nunca';
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'Agora mesmo';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `H√° ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `H√° ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
    const days = Math.floor(hours / 24);
    return `H√° ${days} ${days === 1 ? 'dia' : 'dias'}`;
  };
  
  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Cloud className="w-6 h-6 text-blue-600" />
          <div>
            <h3 className="font-bold text-blue-900">Backup Cloud (GitHub)</h3>
            {isConfigured && !showConfig && (
              <p className="text-xs text-blue-700">Auto-sync: {autoSyncEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</p>
            )}
          </div>
        </div>
        <button
          onClick={() => setShowConfig(!showConfig)}
          className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded transition"
          title="Configura√ß√µes"
        >
          <Settings className="w-5 h-5" />
        </button>
      </div>
      
      {showConfig ? (
        <div className="space-y-3 bg-white rounded-lg p-4 border border-blue-300">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üîë GitHub Personal Access Token
            </label>
            <div className="relative">
              <input
                type={showToken ? "text" : "password"}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                className="w-full px-3 py-2 pr-20 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-semibold"
              >
                {showToken ? 'Ocultar' : 'Mostrar'}
              </button>
            </div>
            
            <div className="mt-2 space-y-1 text-xs text-gray-600">
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">1.</span>
                <span>Crie token em: <a href="https://github.com/settings/tokens/new?scopes=gist&description=Munchi%20Manager%20Backup" target="_blank" className="text-blue-600 underline font-semibold hover:text-blue-800">github.com/settings/tokens</a></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">2.</span>
                <span>Marque apenas: <strong className="text-green-700">‚úì gist</strong></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">3.</span>
                <span>Cole aqui e clique em "Guardar"</span>
              </p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={saveToken}
              disabled={!token.trim()}
              className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
            >
              üíæ Guardar Token
            </button>
            {isConfigured && (
              <button
                onClick={clearConfig}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition"
              >
                üîå Desconectar
              </button>
            )}
          </div>
          
          <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-900">
            <p className="font-semibold mb-1 flex items-center gap-1">
              üîí Seguran√ßa & Privacidade
            </p>
            <ul className="space-y-1 ml-4 text-yellow-800">
              <li>‚Ä¢ Token guardado <strong>localmente</strong> no seu browser</li>
              <li>‚Ä¢ Nunca partilhado com servidores externos</li>
              <li>‚Ä¢ Gist criado como <strong>privado</strong> (s√≥ voc√™ v√™)</li>
              <li>‚Ä¢ Pode revogar token a qualquer momento</li>
            </ul>
          </div>
        </div>
      ) : (
        <>
          {!isConfigured ? (
            <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              <p className="text-sm text-yellow-800 flex items-center gap-2">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <span>Configure o GitHub para ativar backup autom√°tico na cloud</span>
              </p>
              <button
                onClick={() => setShowConfig(true)}
                className="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-semibold transition text-sm"
              >
                ‚öôÔ∏è Configurar Agora
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="bg-white rounded-lg p-3 border-2 border-green-300 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <CloudCheck className="w-5 h-5 text-green-600" />
                    <div>
                      <p className="text-sm font-semibold text-green-900">Conectado ‚úì</p>
                      <p className="text-xs text-green-700">√öltimo backup: {getTimeSince(lastSync)}</p>
                    </div>
                  </div>
                  <button
                    onClick={handleSync}
                    disabled={isSyncing}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    {isSyncing ? 'A sincronizar...' : 'Sync'}
                  </button>
                </div>
                
                {gistUrl && (
                  <a
                    href={gistUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1"
                  >
                    üîó Ver backup no GitHub
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
              
              {/* Ver Token Protegido por Password */}
              <div className="bg-white rounded-lg p-3 border border-gray-300">
                <div className="space-y-2">
                  <p className="text-sm font-semibold text-gray-900 flex items-center gap-2">
                    üîê Ver Token
                    <span className="text-xs font-normal text-gray-500">(para copiar noutro dispositivo)</span>
                  </p>
                  
                  {!showSavedToken ? (
                    <div className="space-y-2">
                      <div className="flex gap-2">
                        <input
                          type="password"
                          value={passwordInput}
                          onChange={(e) => setPasswordInput(e.target.value)}
                          placeholder="Password de prote√ß√£o"
                          className="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              const savedPwd = localStorage.getItem('munchi_token_password');
                              
                              if (!savedPwd) {
                                // Primeira vez - define a password
                                localStorage.setItem('munchi_token_password', passwordInput);
                                setShowSavedToken(true);
                                setPasswordInput('');
                                alert('‚úÖ Password definida! Use esta password para ver o token no futuro.');
                              } else if (passwordInput === savedPwd) {
                                // Password correta
                                setShowSavedToken(true);
                                setPasswordInput('');
                              } else {
                                // Password errada
                                alert('‚ùå Password incorreta!');
                                setPasswordInput('');
                              }
                            }
                          }}
                        />
                        <button
                          onClick={() => {
                            const savedPwd = localStorage.getItem('munchi_token_password');
                            
                            if (!savedPwd) {
                              localStorage.setItem('munchi_token_password', passwordInput);
                              setShowSavedToken(true);
                              setPasswordInput('');
                              alert('‚úÖ Password definida! Use esta password para ver o token no futuro.');
                            } else if (passwordInput === savedPwd) {
                              setShowSavedToken(true);
                              setPasswordInput('');
                            } else {
                              alert('‚ùå Password incorreta!');
                              setPasswordInput('');
                            }
                          }}
                          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition text-sm whitespace-nowrap"
                        >
                          üëÅÔ∏è Ver
                        </button>
                      </div>
                      <p className="text-xs text-gray-500">
                        {localStorage.getItem('munchi_token_password') 
                          ? 'üí° Introduce a tua password para ver o token' 
                          : 'üí° Define uma password para proteger o acesso ao token'}
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="relative">
                        <input
                          type="text"
                          value={GitHubSync.getToken()}
                          readOnly
                          className="w-full px-3 py-2 pr-24 border border-gray-300 rounded text-xs bg-gray-50 font-mono"
                        />
                        <button
                          onClick={() => {
                            navigator.clipboard.writeText(GitHubSync.getToken());
                            alert('‚úÖ Token copiado para a √°rea de transfer√™ncia!');
                          }}
                          className="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold"
                        >
                          üìã Copiar
                        </button>
                      </div>
                      <button
                        onClick={() => {
                          setShowSavedToken(false);
                          setPasswordInput('');
                        }}
                        className="text-xs text-blue-600 hover:text-blue-800 font-semibold"
                      >
                        üîí Ocultar
                      </button>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="bg-white rounded-lg p-3 border border-gray-300">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-semibold text-gray-900">Sincroniza√ß√£o Autom√°tica</p>
                    <p className="text-xs text-gray-600">Backup a cada 5 minutos</p>
                  </div>
                  <button
                    onClick={() => {
                      GitHubSync.setAutoSyncEnabled(!autoSyncEnabled);
                      window.location.reload();
                    }}
                    className={`w-12 h-6 rounded-full transition ${autoSyncEnabled ? 'bg-green-500' : 'bg-gray-300'} relative`}
                  >
                    <div className={`w-5 h-5 rounded-full bg-white absolute top-0.5 transition-all ${autoSyncEnabled ? 'left-6' : 'left-0.5'}`}></div>
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

// Tooltip Component
const Tooltip = ({ children, text, position = 'top' }) => {
  const [show, setShow] = React.useState(false);
  
  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2'
  };
  
  return (
    <div className="relative inline-block">
      <div
        onMouseEnter={() => setShow(true)}
        onMouseLeave={() => setShow(false)}
        className="cursor-help"
      >
        {children}
      </div>
      {show && (
        <div className={`absolute ${positionClasses[position]} z-50 w-64 pointer-events-none`}>
          <div className="bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg">
            {text}
            <div className={`absolute w-2 h-2 bg-gray-900 transform rotate-45 ${
              position === 'top' ? 'bottom-[-4px] left-1/2 -translate-x-1/2' :
              position === 'bottom' ? 'top-[-4px] left-1/2 -translate-x-1/2' :
              position === 'left' ? 'right-[-4px] top-1/2 -translate-y-1/2' :
              'left-[-4px] top-1/2 -translate-y-1/2'
            }`}></div>
          </div>
        </div>
      )}
    </div>
  );
};

// ===== MODAL CONFIRMA√á√ÉO OCR =====
const ModalConfirmacaoOCR = ({ linhas, ingredientes, metadata, onConfirmar, onCancelar, fornecedores }) => {
  const [linhasEditadas, setLinhasEditadas] = useState(linhas);
  const [stats, setStats] = useState(null);
  const [ingredientesLocais, setIngredientesLocais] = useState(ingredientes); // Lista local que pode crescer
  const [mostrarModalCriarIng, setMostrarModalCriarIng] = useState(false);
  const [novoIngrediente, setNovoIngrediente] = useState({
    nome: '',
    categoria: 'outros',
    unidade: 'kg',
    custo: '',
    iva: '13'
  });
  const [linhaIndexCriando, setLinhaIndexCriando] = useState(null);
  
  // States para search de ingredientes
  const [searchIngredienteOCR, setSearchIngredienteOCR] = useState({});
  const [showDropdownOCR, setShowDropdownOCR] = useState({});
  
  // States para documento
  const [numeroFaturaManual, setNumeroFaturaManual] = useState(metadata.numeroFatura || '');
  const [fornecedorManual, setFornecedorManual] = useState('');
  const [fornecedoresLocais, setFornecedoresLocais] = useState(fornecedores); // Lista local
  const [mostrarModalNovoFornecedor, setMostrarModalNovoFornecedor] = useState(false);
  const [novoFornecedor, setNovoFornecedor] = useState({
    nome: '',
    nif: metadata.nif || '',
    contacto: '',
    email: ''
  });

  useEffect(() => {
    const calculateStats = (linhas) => {
      const total = linhas.length;
      const comSugestao = linhas.filter(l => l.ingredienteSugerido).length;
      const altaConfianca = linhas.filter(l => l.confiancaSugestao >= 80).length;
      const mediaConfianca = linhas.filter(l => l.confiancaSugestao >= 60 && l.confiancaSugestao < 80).length;
      return {
        total, comSugestao, altaConfianca, mediaConfianca,
        semSugestao: total - comSugestao,
        percentagemAuto: total > 0 ? Math.round((altaConfianca / total) * 100) : 0
      };
    };
    setStats(calculateStats(linhasEditadas));
  }, [linhasEditadas]);

  const handleIngredienteChange = (index, ingredienteId) => {
    const novas = [...linhasEditadas];
    novas[index].ingredienteConfirmado = ingredienteId;
    setLinhasEditadas(novas);
  };

  const handleQuantidadeChange = (index, quantidade) => {
    const novas = [...linhasEditadas];
    novas[index].quantidade = parseFloat(quantidade) || null;
    setLinhasEditadas(novas);
  };

  const handleUnidadeChange = (index, unidade) => {
    const novas = [...linhasEditadas];
    novas[index].unidade = unidade;
    setLinhasEditadas(novas);
  };

  const handlePrecoChange = (index, preco) => {
    const novas = [...linhasEditadas];
    novas[index].preco = parseFloat(preco) || null;
    setLinhasEditadas(novas);
  };

  const handleRemoverLinha = (index) => {
    setLinhasEditadas(linhasEditadas.filter((_, i) => i !== index));
  };
  
  // üö´ Adicionar linha √† blacklist e remover
  const handleBlacklistLinha = (index) => {
    const linha = linhasEditadas[index];
    
    // Buscar NIF: 1) metadata.nif, 2) fornecedor selecionado manualmente
    let nifFornecedor = metadata.nif;
    
    if (!nifFornecedor && fornecedorManual) {
      // Buscar NIF do fornecedor selecionado
      const fornecedorObj = fornecedoresLocais.find(f => f.id === fornecedorManual);
      if (fornecedorObj && fornecedorObj.nif) {
        nifFornecedor = fornecedorObj.nif;
      }
    }
    
    if (!nifFornecedor) {
      alert('‚ö†Ô∏è NIF do fornecedor n√£o detectado ou fornecedor n√£o tem NIF cadastrado. N√£o √© poss√≠vel adicionar √† blacklist.');
      return;
    }
    
    // Confirmar a√ß√£o
    if (confirm(`üö´ Adicionar √† blacklist permanente?\n\nLinha: "${linha.textoOriginal.substring(0, 60)}..."\n\nEsta linha nunca mais aparecer√° em faturas deste fornecedor (NIF: ${nifFornecedor}).`)) {
      // Adicionar √† blacklist (via window global para chamar fun√ß√£o do componente pai)
      if (window._adicionarABlacklist) {
        window._adicionarABlacklist(nifFornecedor, linha.textoOriginal);
      }
      
      // Remover da lista
      setLinhasEditadas(linhasEditadas.filter((_, i) => i !== index));
    }
  };

  const handleCriarIngrediente = () => {
    // Validar
    if (!novoIngrediente.nome || !novoIngrediente.custo) {
      alert('‚ùå Preencha nome e custo!');
      return;
    }
    
    // Criar
    const novoIng = {
      id: `ing_${Date.now()}`,
      nome: novoIngrediente.nome,
      categoria: novoIngrediente.categoria,
      unidade: novoIngrediente.unidade,
      custoUnitario: parseFloat(novoIngrediente.custo),
      precoUnitario: parseFloat(novoIngrediente.custo),
      iva: parseFloat(novoIngrediente.iva)
    };
    
    // Adicionar √† lista
    setIngredientesLocais([...ingredientesLocais, novoIng]);
    
    // Guardar globalmente
    if (!window._novosIngredientes) window._novosIngredientes = [];
    window._novosIngredientes.push(novoIng);
    
    // Selecionar automaticamente
    if (linhaIndexCriando !== null) {
      handleIngredienteChange(linhaIndexCriando, novoIng.id);
    }
    
    // Fechar modal
    setMostrarModalCriarIng(false);
    setNovoIngrediente({ nome: '', categoria: 'outros', unidade: 'kg', custo: '', iva: '13' });
  };

  const handleConfirmar = () => {
    const linhasSemIngrediente = linhasEditadas.filter(
      l => !l.ingredienteConfirmado && !l.ingredienteSugerido
    );
    if (linhasSemIngrediente.length > 0) {
      if (!confirm(`${linhasSemIngrediente.length} linha(s) sem ingrediente. Continuar?`)) return;
    }
    const linhasFinais = linhasEditadas.map(linha => ({
      ...linha,
      ingredienteConfirmado: linha.ingredienteConfirmado || linha.ingredienteSugerido?.id
    }));
    
    // Passar novos ingredientes criados no modal
    const novosIngs = window._novosIngredientes || [];
    
    // Adicionar dados do documento √† metadata
    const numeroFinal = numeroFaturaManual || metadata.numeroFatura || null;
    
    // Adicionar "FT " se n√∫mero existe mas n√£o tem prefixo
    let numeroComPrefixo = numeroFinal;
    if (numeroFinal && !numeroFinal.toUpperCase().startsWith('FT')) {
      numeroComPrefixo = 'FT ' + numeroFinal;
    }
    
    const metadataCompleta = { 
      ...metadata,
      numeroFatura: numeroComPrefixo,
      tipoDocumento: numeroComPrefixo ? 'fatura' : 'recibo', // Auto-detecta tipo
      fornecedorManual: fornecedorManual, // ID do fornecedor selecionado manualmente
      novosIngredientes: novosIngs 
    };
    
    // Limpar cache de novos ingredientes
    window._novosIngredientes = [];
    
    onConfirmar(linhasFinais, metadataCompleta);
  };

  const getConfidenceClass = (confianca) => {
    if (confianca >= 80) return 'text-green-600 bg-green-50';
    if (confianca >= 60) return 'text-yellow-600 bg-yellow-50';
    return 'text-red-600 bg-red-50';
  };

  const getConfidenceIcon = (confianca) => {
    if (confianca >= 80) return '‚úì';
    if (confianca >= 60) return '‚ö†';
    return '‚úó';
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[95vh] flex flex-col">
        <div className="p-4 border-b flex-shrink-0">
          <h2 className="text-xl font-bold mb-2">üìÑ Confirmar Produtos Extra√≠dos</h2>
          
          {/* Info do Documento - COMPACTO */}
          <div className="mb-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded">
            <div className="grid grid-cols-3 gap-3 text-sm">
              {/* N√∫mero Fatura */}
              <div>
                <label className="text-xs font-semibold text-gray-600 block mb-1">üìã N√∫mero</label>
                {metadata.numeroFatura ? (
                  <div className="px-2 py-1 bg-white border border-green-300 rounded font-bold text-green-700 text-sm">
                    {metadata.numeroFatura}
                  </div>
                ) : (
                  <div className="flex items-center gap-1">
                    <span className="px-2 py-1 bg-gray-100 border rounded text-sm font-semibold text-gray-600">FT</span>
                    <input
                      type="text"
                      value={numeroFaturaManual}
                      onChange={(e) => setNumeroFaturaManual(e.target.value)}
                      placeholder="2025/156"
                      className="flex-1 px-2 py-1 border rounded text-sm"
                    />
                  </div>
                )}
              </div>
              
              {/* Fornecedor */}
              <div>
                <label className="text-xs font-semibold text-gray-600 block mb-1">üè¢ Fornecedor</label>
                {(() => {
                  const fornecedorDetectado = metadata.nif 
                    ? fornecedores.find(f => f.nif === metadata.nif)
                    : null;
                  
                  if (fornecedorDetectado) {
                    return (
                      <div className="px-2 py-1 bg-white border border-blue-300 rounded text-sm">
                        <span className="font-bold text-blue-700">{fornecedorDetectado.nome}</span>
                      </div>
                    );
                  } else {
                    return (
                      <select
                        value={fornecedorManual}
                        onChange={(e) => {
                          if (e.target.value === 'novo') {
                            setMostrarModalNovoFornecedor(true);
                          } else {
                            setFornecedorManual(e.target.value);
                          }
                        }}
                        className="w-full px-2 py-1 border rounded text-sm"
                      >
                        <option value="">Escolher...</option>
                        {fornecedoresLocais.map(f => (
                          <option key={f.id} value={f.id}>
                            {f.nome}
                          </option>
                        ))}
                        <option value="novo" className="font-bold">‚ûï Criar Novo</option>
                      </select>
                    );
                  }
                })()}
              </div>
              
              {/* Badge Tipo */}
              <div className="flex items-end">
                <span className={`px-3 py-1 rounded text-xs font-bold ${
                  metadata.numeroFatura || numeroFaturaManual
                    ? 'bg-green-100 text-green-700' 
                    : 'bg-gray-100 text-gray-700'
                }`}>
                  {metadata.numeroFatura || numeroFaturaManual ? 'üßæ FATURA' : 'üìù RECIBO'}
                </span>
              </div>
            </div>
          </div>
          
          {/* Stats - COMPACTO */}
          {stats && (
            <div className="flex gap-2 text-xs">
              <div className="bg-blue-50 px-2 py-1 rounded"><strong>{stats.total}</strong> produtos</div>
              <div className="bg-green-50 px-2 py-1 rounded"><strong>{stats.altaConfianca}</strong> alta</div>
              <div className="bg-yellow-50 px-2 py-1 rounded"><strong>{stats.mediaConfianca}</strong> verificar</div>
              <div className="bg-red-50 px-2 py-1 rounded"><strong>{stats.semSugestao}</strong> manual</div>
              <div className="bg-purple-50 px-2 py-1 rounded"><strong>{stats.percentagemAuto}%</strong> auto</div>
            </div>
          )}
        </div>
        <div className="flex-1 overflow-auto p-6">
          <table className="w-full border-collapse">
            <thead className="sticky top-0 bg-gray-100">
              <tr>
                <th className="border p-2 text-left text-sm font-semibold">Texto PDF</th>
                <th className="border p-2 text-left text-sm font-semibold">Ingrediente</th>
                <th className="border p-2 text-center text-sm font-semibold w-20">Conf.</th>
                <th className="border p-2 text-center text-sm font-semibold w-24">Qtd</th>
                <th className="border p-2 text-center text-sm font-semibold w-20">Un</th>
                <th className="border p-2 text-center text-sm font-semibold w-24">Pre√ßo</th>
                <th className="border p-2 text-center text-sm font-semibold w-16">A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              {linhasEditadas.map((linha, index) => {
                const ingredienteSugerido = linha.ingredienteSugerido ? 
                  ingredientesLocais.find(i => i.id === linha.ingredienteConfirmado) : null;
                const confianca = linha.confiancaSugestao || 0;
                const historico = linha.historicoSugestao;
                
                return (
                  <tr key={index} className="hover:bg-gray-50">
                    <td className="border p-2 text-sm">
                      <div className="font-mono text-xs text-gray-600 mb-1">{linha.textoOriginal}</div>
                      <div className="text-sm font-semibold">{linha.nomeProduto}</div>
                    </td>
                    <td className="border p-2">
                      <div className="flex gap-1">
                        {/* Search + Dropdown de ingredientes */}
                        <div className="flex-1 relative">
                          <input
                            type="text"
                            value={searchIngredienteOCR[index] || ''}
                            onChange={(e) => {
                              const valor = e.target.value;
                              setSearchIngredienteOCR({...searchIngredienteOCR, [index]: valor});
                              setShowDropdownOCR({...showDropdownOCR, [index]: valor.length >= 2});
                            }}
                            onFocus={() => {
                              if ((searchIngredienteOCR[index] || '').length >= 2) {
                                setShowDropdownOCR({...showDropdownOCR, [index]: true});
                              }
                            }}
                            onBlur={() => {
                              // Delay para permitir click no dropdown
                              setTimeout(() => {
                                setShowDropdownOCR({...showDropdownOCR, [index]: false});
                              }, 200);
                            }}
                            placeholder="Digite para buscar..."
                            className={`w-full px-2 py-1 text-sm border rounded ${getConfidenceClass(confianca)}`}
                          />
                          
                          {/* Dropdown de sugest√µes */}
                          {showDropdownOCR[index] && (
                            (() => {
                              const search = (searchIngredienteOCR[index] || '').toLowerCase();
                              const sugestoes = ingredientesLocais
                                .filter(ing => ing.nome.toLowerCase().includes(search))
                                .slice(0, 10);
                              
                              if (sugestoes.length === 0) return null;
                              
                              return (
                                <div className="absolute top-full left-0 right-0 bg-white border shadow-lg z-50 max-h-60 overflow-y-auto mt-1 rounded">
                                  {sugestoes.map(ing => (
                                    <div
                                      key={ing.id}
                                      onMouseDown={(e) => {
                                        e.preventDefault();
                                        handleIngredienteChange(index, ing.id);
                                        setSearchIngredienteOCR({...searchIngredienteOCR, [index]: ing.nome});
                                        setShowDropdownOCR({...showDropdownOCR, [index]: false});
                                      }}
                                      className="p-2 hover:bg-blue-50 cursor-pointer border-b"
                                    >
                                      <div className="font-semibold text-sm">{ing.nome}</div>
                                      <div className="text-xs text-gray-600">
                                        ‚Ç¨{ing.custoUnitario.toFixed(2)}/{ing.unidade} ¬∑ {ing.categoria}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              );
                            })()
                          )}
                          
                          {/* Mostrar ingrediente selecionado */}
                          {linha.ingredienteConfirmado && !searchIngredienteOCR[index] && (
                            (() => {
                              const ingSelecionado = ingredientesLocais.find(i => i.id === linha.ingredienteConfirmado);
                              if (ingSelecionado) {
                                return (
                                  <div className="mt-1 text-xs text-blue-600 font-semibold">
                                    ‚úì {ingSelecionado.nome}
                                  </div>
                                );
                              }
                              return null;
                            })()
                          )}
                        </div>
                        
                        <button
                          onClick={() => {
                            setNovoIngrediente({
                              nome: linha.nomeProduto || '',
                              categoria: 'outros',
                              unidade: linha.unidade || 'kg',
                              custo: linha.preco ? linha.preco.toString() : '',
                              iva: linha.iva ? linha.iva.toString() : (metadata.iva ? metadata.iva.toString() : '13')
                            });
                            setLinhaIndexCriando(index);
                            setMostrarModalCriarIng(true);
                          }}
                          className="ml-1 px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                          title="Criar novo ingrediente"
                        >
                          +
                        </button>
                      </div>
                      {linha.ingredienteSugerido && ingredienteSugerido && (
                        <div className="text-xs mt-1 flex items-center gap-1">
                          <span className="text-blue-600">üîµ</span>
                          <span className="text-gray-600">
                            Sugest√£o: <strong>{ingredienteSugerido.nome}</strong>
                            {historico && ` (${historico.confirmacoes} confirma√ß√µes)`}
                          </span>
                        </div>
                      )}
                    </td>
                    <td className={`border p-2 text-center ${getConfidenceClass(confianca)}`}>
                      <div className="text-sm font-bold">{linha.ingredienteSugerido ? `${confianca}%` : '--'}</div>
                      <div className="text-xs">{getConfidenceIcon(confianca)}</div>
                    </td>
                    <td className="border p-2">
                      <input
                        type="number"
                        step="0.01"
                        value={linha.quantidade || ''}
                        onChange={(e) => handleQuantidadeChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded text-center"
                        placeholder="--"
                      />
                    </td>
                    <td className="border p-2">
                      <select
                        value={linha.unidade || ''}
                        onChange={(e) => handleUnidadeChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded"
                      >
                        <option value="">--</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="l">l</option>
                        <option value="ml">ml</option>
                        <option value="un">un</option>
                      </select>
                    </td>
                    <td className="border p-2">
                      <input
                        type="number"
                        step="0.01"
                        value={linha.preco || ''}
                        onChange={(e) => handlePrecoChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded text-right"
                        placeholder="--"
                      />
                    </td>
                    <td className="border p-2 text-center">
                      <button
                        onClick={() => handleRemoverLinha(index)}
                        className="text-red-600 hover:text-red-800 text-sm mr-1"
                        title="Apagar (s√≥ desta vez)"
                      >
                        üóëÔ∏è
                      </button>
                      <button
                        onClick={() => handleBlacklistLinha(index)}
                        className="text-gray-700 hover:text-black text-sm"
                        title="Blacklist (nunca mais aparece)"
                      >
                        üö´
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {linhasEditadas.length === 0 && (
            <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
              <p className="text-gray-600 mb-3">‚ö†Ô∏è Nenhum produto detectado no OCR</p>
              <p className="text-sm text-gray-500 mb-4">Adicione produtos manualmente clicando no bot√£o abaixo</p>
              <button
                onClick={() => {
                  const novaLinha = {
                    nomeProduto: '',
                    quantidade: '',
                    preco: '',
                    ingredienteConfirmado: null
                  };
                  setLinhasEditadas([novaLinha]);
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ûï Adicionar Primeira Linha
              </button>
            </div>
          )}
        </div>
        <div className="p-6 border-t bg-gray-50">
          <div className="flex justify-between items-center mb-3">
            <div className="text-sm text-gray-600">
              {stats && stats.comSugestao > 0 ? (
                <span>
                  üß† <strong>{stats.comSugestao}/{stats.total}</strong> reconhecidos automaticamente
                  {stats.altaConfianca > 0 && ` (${stats.altaConfianca} com alta confian√ßa)`}
                </span>
              ) : (
                <span>üìö Primeira vez com este fornecedor - sistema vai aprender!</span>
              )}
            </div>
          </div>
          <div className="flex justify-between items-center">
            <div className="text-xs text-gray-500">
              üí° Verde (‚â•80%) = alta confian√ßa | Amarelo (60-79%) = verificar | Cinza = escolher manualmente
            </div>
            <div className="flex gap-3">
            <button
              onClick={onCancelar}
              className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold"
            >
              Cancelar
            </button>
            <button
              onClick={handleConfirmar}
              disabled={linhasEditadas.length === 0}
              className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-semibold"
            >
              Confirmar {linhasEditadas.length > 0 && `(${linhasEditadas.length})`}
            </button>
          </div>
          </div>
        </div>
      </div>

      {/* Modal Criar Ingrediente */}
      {mostrarModalCriarIng && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6">
            <h3 className="text-xl font-bold mb-4 text-gray-800">‚ú® Criar Novo Ingrediente</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoIngrediente.nome}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, nome: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: Tomate Cherry"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Categoria *</label>
                <select
                  value={novoIngrediente.categoria}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, categoria: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="vegetais">ü•¨ Vegetais</option>
                  <option value="frutas">üçé Frutas</option>
                  <option value="carnes">ü•© Carnes</option>
                  <option value="peixe">üêü Peixe/Marisco</option>
                  <option value="latic√≠nios">ü•õ Latic√≠nios</option>
                  <option value="√≥leos">ü´í √ìleos/Gorduras</option>
                  <option value="cereais">üåæ Cereais/Massas</option>
                  <option value="especiarias">üå∂Ô∏è Especiarias</option>
                  <option value="bebidas">üç∫ Bebidas</option>
                  <option value="embalagens">üì¶ Embalagens</option>
                  <option value="limpeza">üßπ Limpeza</option>
                  <option value="compotas">üçØ Compotas/Doces</option>
                  <option value="outros">üìã Outros</option>
                </select>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Unidade *</label>
                  <select
                    value={novoIngrediente.unidade}
                    onChange={(e) => setNovoIngrediente({...novoIngrediente, unidade: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="l">l</option>
                    <option value="ml">ml</option>
                    <option value="un">un</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Custo (‚Ç¨) *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={novoIngrediente.custo}
                    onChange={(e) => setNovoIngrediente({...novoIngrediente, custo: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">IVA (%) *</label>
                <select
                  value={novoIngrediente.iva}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, iva: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="6">6% (Essencial)</option>
                  <option value="13">13% (Reduzido)</option>
                  <option value="23">23% (Normal)</option>
                </select>
              </div>
            </div>
            
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => {
                  setMostrarModalCriarIng(false);
                  setNovoIngrediente({ nome: '', categoria: 'outros', unidade: 'kg', custo: '', iva: '13' });
                }}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold text-gray-700"
              >
                Cancelar
              </button>
              <button
                onClick={handleCriarIngrediente}
                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
              >
                ‚ú® Criar Ingrediente
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Modal Criar Fornecedor */}
      {mostrarModalNovoFornecedor && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60]">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 className="text-xl font-bold mb-4">‚ûï Criar Novo Fornecedor</h3>
            
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-semibold mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoFornecedor.nome}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nome: e.target.value})}
                  placeholder="Ex: Pingo Doce"
                  className="w-full px-3 py-2 border rounded"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">NIF</label>
                <input
                  type="text"
                  value={novoFornecedor.nif}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nif: e.target.value})}
                  placeholder="9 d√≠gitos"
                  maxLength="9"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Contacto</label>
                <input
                  type="text"
                  value={novoFornecedor.contacto}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, contacto: e.target.value})}
                  placeholder="Telefone"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Email</label>
                <input
                  type="email"
                  value={novoFornecedor.email}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, email: e.target.value})}
                  placeholder="email@exemplo.com"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            
            <div className="flex gap-2 mt-6">
              <button
                onClick={() => {
                  setMostrarModalNovoFornecedor(false);
                  setNovoFornecedor({ nome: '', nif: metadata.nif || '', contacto: '', email: '' });
                }}
                className="flex-1 px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              >
                Cancelar
              </button>
              <button
                onClick={() => {
                  if (!novoFornecedor.nome.trim()) {
                    alert('Nome √© obrigat√≥rio!');
                    return;
                  }
                  
                  // Criar fornecedor tempor√°rio
                  const novoFornTemp = {
                    id: 'temp_' + Date.now(),
                    nome: novoFornecedor.nome.trim(),
                    nif: novoFornecedor.nif.trim(),
                    contacto: novoFornecedor.contacto.trim(),
                    email: novoFornecedor.email.trim()
                  };
                  
                  // Adicionar √† lista LOCAL (aparece no dropdown imediatamente)
                  setFornecedoresLocais([...fornecedoresLocais, novoFornTemp]);
                  
                  // Adicionar ao metadata para ser processado depois
                  if (!window._novosFornecedores) window._novosFornecedores = [];
                  window._novosFornecedores.push(novoFornTemp);
                  
                  // Selecionar o fornecedor rec√©m-criado
                  setFornecedorManual(novoFornTemp.id);
                  
                  // Fechar modal
                  setMostrarModalNovoFornecedor(false);
                  setNovoFornecedor({ nome: '', nif: metadata.nif || '', contacto: '', email: '' });
                }}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ú® Criar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== MODAL DE CONFIRMA√á√ÉO DE TIPO DE FATURA ====================
// Este componente deve ser adicionado antes do componente RestauranteGestor (por volta da linha 2300)

/**
 * Modal para confirmar tipo de fatura detectado
 */
const ModalConfirmacaoFatura = ({ dadosFatura, onConfirmar, onCancelar }) => {
  const [tipoSelecionado, setTipoSelecionado] = React.useState(dadosFatura.tipo);
  
  const handleConfirmar = () => {
    onConfirmar({
      ...dadosFatura,
      tipo: tipoSelecionado
    });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold">Confirmar Tipo de Fatura</h3>
          {dadosFatura.pdfUrl && (
            <button
              onClick={() => window.open(dadosFatura.pdfUrl, '_blank')}
              className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
              title="Visualizar PDF original"
            >
              <FileText className="w-4 h-4" />
              Ver PDF
            </button>
          )}
        </div>
        
        <div className="mb-4 p-4 bg-blue-50 rounded-lg">
          <p className="text-sm text-gray-700">
            <strong>Tipo detectado:</strong> {INVOICE_TYPES[dadosFatura.tipo]?.label || dadosFatura.tipo}
          </p>
          {dadosFatura.numero !== 'N/A' && (
            <p className="text-sm text-gray-700 mt-1">
              <strong>N√∫mero:</strong> {dadosFatura.numero}
            </p>
          )}
          <p className="text-sm text-gray-700 mt-1">
            <strong>Fornecedor:</strong> {dadosFatura.fornecedor.nome}
          </p>
          {dadosFatura.fornecedor.nif && (
            <p className="text-sm text-gray-700 mt-1">
              <strong>NIF:</strong> {dadosFatura.fornecedor.nif}
            </p>
          )}
          <p className="text-sm text-gray-700 mt-1">
            <strong>Data:</strong> {dadosFatura.data}
          </p>
          {dadosFatura.totais.total > 0 && (
            <p className="text-sm text-gray-700 mt-1">
              <strong>Total:</strong> {dadosFatura.totais.total.toFixed(2)}‚Ç¨
            </p>
          )}
        </div>
        
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Selecionar tipo de fatura:
          </label>
          
          <div className="space-y-2">
            {Object.entries(INVOICE_TYPES).map(([tipo, config]) => (
              <label
                key={tipo}
                className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${
                  tipoSelecionado === tipo
                    ? 'border-green-500 bg-green-50'
                    : 'border-gray-200 hover:border-green-300 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center">
                  <input
                    type="radio"
                    name="tipoFatura"
                    value={tipo}
                    checked={tipoSelecionado === tipo}
                    onChange={(e) => setTipoSelecionado(e.target.value)}
                    className="mr-3 h-4 w-4 text-green-600"
                  />
                  <div>
                    <div className="font-semibold">{config.label}</div>
                    <div className="text-sm text-gray-600">{config.description}</div>
                  </div>
                </div>
              </label>
            ))}
          </div>
        </div>
        
        <div className="flex gap-3">
          <button
            onClick={handleConfirmar}
            className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors"
          >
            Confirmar
          </button>
          <button
            onClick={onCancelar}
            className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  );
};

// ==================== COMPONENTE DE BLACKLIST ====================

// ==================== COMPONENTE DE CONFIGURA√á√ïES ====================

/**
 * Painel de Configura√ß√µes
 */
const PainelConfiguracoes = ({ configuracoes, onSalvar, vendas, setVendas, showNotification }) => {
  const [config, setConfig] = React.useState(configuracoes);
  const [mostrarSucesso, setMostrarSucesso] = React.useState(false);
  const [alertasExpanded, setAlertasExpanded] = React.useState(false);
  
  const handleSalvar = () => {
    onSalvar(config);
    setMostrarSucesso(true);
    setTimeout(() => setMostrarSucesso(false), 3000);
  };
  
  const atualizarConfig = (secao, campo, valor) => {
    const novoConfig = {
      ...config,
      [secao]: {
        ...config[secao],
        [campo]: valor
      }
    };
    setConfig(novoConfig);
    
    // ‚úÖ ATUALIZAR IMEDIATAMENTE para filtros de m√©tricas
    if (secao === 'metricas') {
      console.log(`üîÑ Filtro de m√©tricas mudou`);
      onSalvar(novoConfig);
    }
  };
  
  return (
    <div className="space-y-4">
      {/* Filtro de M√©tricas com Tags Individuais */}
      <div className="bg-gray-50 rounded-lg p-4">
        <h4 className="font-semibold mb-3 text-gray-700">üè∑Ô∏è Filtro de M√©tricas por Tags</h4>
        <p className="text-xs text-gray-600 mb-3">Seleciona quais origens incluir nas m√©tricas do dashboard</p>
        
        {/* Vendas */}
        <div className="mb-4">
          <p className="text-sm font-semibold text-gray-700 mb-2">üìä Vendas</p>
          <div className="space-y-2">
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirMoloni !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirMoloni', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">MOLONI</span>
                Vendas importadas do Moloni
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-blue-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirZobaze !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirZobaze', e.target.checked)}
                className="mr-2 h-4 w-4 text-blue-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-bold mr-2">ZOBAZE</span>
                Vendas importadas do Zobaze
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-gray-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirManual !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirManual', e.target.checked)}
                className="mr-2 h-4 w-4 text-gray-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-xs font-bold mr-2">MANUAL</span>
                Vendas adicionadas manualmente
              </span>
            </label>
          </div>
        </div>
        
        {/* Faturas/Despesas */}
        <div>
          <p className="text-sm font-semibold text-gray-700 mb-2">üìÑ Faturas de Compras</p>
          <div className="space-y-2">
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFT !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFT', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">FT</span>
                Faturas (oficial para contabilista)
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFR !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFR', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">FR</span>
                Faturas-Recibo (oficial para contabilista)
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-orange-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFS !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFS', e.target.checked)}
                className="mr-2 h-4 w-4 text-orange-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-bold mr-2">FS</span>
                Faturas Simplificadas (n√£o oficial)
              </span>
            </label>
          </div>
        </div>
        
        {/* Atalhos R√°pidos */}
        <div className="mt-4 pt-4 border-t border-gray-300">
          <p className="text-xs font-semibold text-gray-600 mb-2">‚ö° Atalhos</p>
          <div className="flex gap-2">
            <button
              onClick={() => {
                const novoConfig = {
                  ...config,
                  metricas: {
                    ...config.metricas,
                    incluirMoloni: true,
                    incluirZobaze: false,
                    incluirManual: true,
                    incluirFT: true,
                    incluirFR: true,
                    incluirFS: false
                  }
                };
                setConfig(novoConfig);
                onSalvar(novoConfig);
              }}
              className="flex-1 bg-green-600 text-white px-3 py-1.5 rounded text-xs hover:bg-green-700 transition font-semibold"
            >
              üìä S√≥ Oficial
            </button>
            <button
              onClick={() => {
                const novoConfig = {
                  ...config,
                  metricas: {
                    ...config.metricas,
                    incluirMoloni: true,
                    incluirZobaze: true,
                    incluirManual: true,
                    incluirFT: true,
                    incluirFR: true,
                    incluirFS: true
                  }
                };
                setConfig(novoConfig);
                onSalvar(novoConfig);
              }}
              className="flex-1 bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 transition font-semibold"
            >
              üìà Tudo
            </button>
          </div>
        </div>
      </div>
      
      {/* Alertas de Margem */}
      <div className="border rounded-lg overflow-hidden">
        <button
          onClick={() => setAlertasExpanded(!alertasExpanded)}
          className="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition"
        >
          <div className="text-left">
            <h4 className="font-semibold text-gray-700">Alertas de Margem</h4>
            <p className="text-sm text-gray-600">
              Configurar limites de margem baixa e cr√≠tica
            </p>
          </div>
          {alertasExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
        </button>
        
        {alertasExpanded && (
          <div className="p-4 bg-white border-t space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Margem baixa (alerta amarelo):
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={config.alertas.margemBaixa}
                  onChange={(e) => atualizarConfig('alertas', 'margemBaixa', parseFloat(e.target.value))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg"
                />
                <span>%</span>
                <span className="text-sm text-gray-600">(default: 70%)</span>
              </div>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Margem cr√≠tica (alerta vermelho):
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={config.alertas.margemCritica}
                  onChange={(e) => atualizarConfig('alertas', 'margemCritica', parseFloat(e.target.value))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg"
                />
                <span>%</span>
                <span className="text-sm text-gray-600">(default: 55%)</span>
              </div>
            </div>
          </div>
        )}
      </div>
      
      <button
        onClick={handleSalvar}
        className="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
      >
        <Save className="w-5 h-5" />
        Guardar Defini√ß√µes
      </button>
      
      {/* Bot√£o Apagar Vendas */}
      <div className="border border-gray-300 rounded-lg p-4 bg-gray-50">
        <p className="text-sm font-semibold text-gray-700 mb-2">
          üóëÔ∏è Limpar Dados
        </p>
        <p className="text-xs text-gray-600 mb-3">
          Apaga todas as vendas. √ötil para importar dados novos.
        </p>
        <button
          onClick={() => {
            if (window.confirm(`Apagar ${vendas.length} vendas?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
              setVendas([]);
              showNotification('Vendas apagadas!', 'success');
            }
          }}
          className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition"
        >
          Apagar Todas as Vendas ({vendas.length})
        </button>
      </div>
      
      {mostrarSucesso && (
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg flex items-center gap-2">
          <Check className="w-5 h-5" />
          <span>Defini√ß√µes guardadas com sucesso!</span>
        </div>
      )}
    </div>
  );
};

// ==================== DISPLAY DE MARGENS ====================

/**
 * Componente para mostrar margens de produto com c√≥digo de cores
 */
const DisplayMargem = ({ produto, configuracoes }) => {
  const margens = calcularMargensProduto(produto, configuracoes);
  
  if (!margens) {
    return <span className="text-gray-400">N/A</span>;
  }
  
  const corClasses = {
    green: 'bg-green-100 border-green-500 text-green-800',
    yellow: 'bg-yellow-100 border-yellow-500 text-yellow-800',
    red: 'bg-red-100 border-red-500 text-red-800'
  };
  
  const corClass = corClasses[margens.status.cor] || corClasses.green;
  
  return (
    <div className={`p-3 rounded-lg border-l-4 ${corClass}`}>
      <div className="flex items-center justify-between">
        <span className="font-semibold">Margem Bruta:</span>
        <span className="text-lg font-bold">{margens.margemBruta.toFixed(1)}%</span>
      </div>
      
      {margens.status.status === 'critical' && (
        <div className="mt-2 pt-2 border-t border-red-300 text-sm">
          <div className="flex items-start gap-2">
            <AlertCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
            <div>
              <div className="font-semibold">Margem abaixo de {configuracoes?.alertas?.margemCritica || 55}%</div>
              <div>A√ß√£o sugerida: rever pre√ßo ou receita</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== FUN√á√ïES GLOBAIS NECESS√ÅRIAS ====================

const CONFIGURACOES_DEFAULT = {
  metricas: {
    // Tags individuais (padr√£o = tudo ativado)
    incluirMoloni: true,
    incluirZobaze: true,
    incluirManual: true,
    incluirFT: true,
    incluirFR: true,
    incluirFS: true,
    // Legacy (manter para compatibilidade)
    apenasOficial: false
  },
  alertas: {
    margemBaixa: 70,
    margemCritica: 55
  }
};

const carregarConfiguracoes = () => {
  try {
    const guardado = localStorage.getItem('munchi_configuracoes');
    return guardado ? JSON.parse(guardado) : CONFIGURACOES_DEFAULT;
  } catch (e) {
    console.error('Erro ao carregar configura√ß√µes:', e);
    return CONFIGURACOES_DEFAULT;
  }
};

const guardarConfiguracoes = (configuracoes) => {
  try {
    localStorage.setItem('munchi_configuracoes', JSON.stringify(configuracoes));
    console.log('‚úÖ Configura√ß√µes guardadas');
    return true;
  } catch (e) {
    console.error('Erro ao guardar configura√ß√µes:', e);
    return false;
  }
};

// ==================== TIPOS DE FATURA ====================

const INVOICE_TYPES = {
  FT: {
    label: 'Fatura (FT)',
    description: 'Vai para contabilista',
    patterns: [
      /Fatura\s+N[.¬∫¬∞]\s*FT\s+\d{4}\/\d+/i,
      /FT\s+\d{4}\/\d+/,
      /^Fatura$/i
    ],
    numberPatterns: [
      /Fatura\s+N[.¬∫¬∞]\s*(FT\s*\d{4}\/\d+)/i,
      /N[.¬∫¬∞]\s*(FT[_\s-]?\d{4}[\/\s-]?\d+)/i,
      /(FT\s*\d{4}\/\d+)/,
      /PP\s+(\d+)/
    ]
  },
  FR: {
    label: 'Fatura-Recibo (FR)',
    description: 'Vai para contabilista',
    patterns: [
      /Fatura[_\s\/-]Recibo/i,
      /\d{2}\/Fatura\/Recibo/,
      /FR\s+\d{4}\/\d+/,
      /04\/Fatura/
    ],
    numberPatterns: [
      /Fatura[_\s-]Recibo.*?(\d{4}[-_]\d{2}[-_]\d{2})/,
      /04\/Fatura\/Recibo\s+(\d{4}[-_]\d{2}[-_]\d{2})/,
      /(FR\s*\d{4}\/\d+)/,
      /(FT\s*\d{4}\/\d+)/,
      /PP\s+(\d+)/
    ]
  },
  FS: {
    label: 'Fatura Simplificada (FS)',
    description: 'N√ÉO vai para contabilista',
    patterns: [
      /Fatura\s+Simplificada/i,
      /FS\s+\d{4}\/\d+/,
      /Recibo\s+N[.¬∫¬∞]\s*\d+/,
      /Simplificada/i
    ],
    numberPatterns: [
      /Simplificada\s+N[.¬∫¬∞]\s*(FS\s*\d{4}\/\d+)/i,
      /(FS\s*\d{4}\/\d+)/,
      /Recibo\s+N[.¬∫¬∞]\s*(\d+)/,
      /Simplificada\s+(\d+)/
    ]
  }
};

const FORNECEDORES_CONHECIDOS = {
  recheio: {
    nome: 'Recheio Cash & Carry',
    patterns: [
      /Recheio\s+Cash\s+&\s+Carry/i,
      /PT\s+HF\s+9568126/
    ],
    nif: '9568126'
  },
  mania: {
    nome: 'MANIA CERVEJEIRA',
    patterns: [
      /MANIA\s+CERVEJEIRA/i,
      /Stefan\s+Hunold/i
    ],
    nif: '278240160'
  }
};

console.log('‚úÖ Componentes React V2.0 carregados!');

const RestauranteGestor = () => {
  const [activeTab, setActiveTab] = useState('dashboard');

  const [isSyncing, setIsSyncing] = React.useState(false);
  const [lastSync, setLastSync] = React.useState(GitHubSync.getLastSync());
  const [syncError, setSyncError] = React.useState(null);
  const [autoSyncEnabled, setAutoSyncEnabled] = React.useState(true);
  
  // Google Drive states
  const [driveAccessToken, setDriveAccessToken] = useState(null);
  const [driveUser, setDriveUser] = useState(null);
  const [driveSyncing, setDriveSyncing] = useState(false);
  const [driveFileId, setDriveFileId] = useState(localStorage.getItem('munchi_drive_file_id'));
  const [driveLastSync, setDriveLastSync] = useState(null);
  const [driveError, setDriveError] = useState(null);
  

  const [dashboardSubTab, setDashboardSubTab] = useState('resumo');
  const [dateFilter, setDateFilter] = useState('all'); // all, today, week, month, custom
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [gestaoSubTab, setGestaoSubTab] = useState('ingredientes');
  const [produtos, setProdutos] = useState([]);
  const [ingredientes, setIngredientes] = useState([]);
  const [vendas, setVendas] = useState([]);
  const [despesas, setDespesas] = useState([]);
  const [fornecedores, setFornecedores] = useState([]);
  const [vocabularioFornecedor, setVocabularioFornecedor] = useState([]); // üß† Sistema de aprendizagem
  const [templatesOCR, setTemplatesOCR] = useState([]); // üìã Templates por fornecedor
  const [novoProduto, setNovoProduto] = useState({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
  const [editandoProduto, setEditandoProduto] = useState(false);
  const [produtoEditandoId, setProdutoEditandoId] = useState(null);
  
  // Estados para venda manual
  const [mostrarVendaManual, setMostrarVendaManual] = useState(false);
  const [vendaEditando, setVendaEditando] = useState(null); // ID da venda sendo editada
  const [mostrarEditarVenda, setMostrarEditarVenda] = useState(false);
  const [novaVenda, setNovaVenda] = useState({
    data: new Date().toISOString().split('T')[0],
    produtoId: '',
    quantidade: 1,
    valorManual: '',
    usarValorManual: false,
    // Campos adicionais para documenta√ß√£o oficial
    numeroDocumento: '',
    tipoDocumento: 'Venda',
    formaPagamento: 'Dinheiro',
    observacoes: ''
  });
  
  // Estados para delivery apps
  const [deliveryApps, setDeliveryApps] = useState([
    { 
      id: 'uber', 
      nome: 'Uber Eats', 
      comissao: 25, 
      ativo: false, 
      cor: '#06c167',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    },
    { 
      id: 'glovo', 
      nome: 'Glovo', 
      comissao: 28, 
      ativo: false, 
      cor: '#ffc244',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    },
    { 
      id: 'bolt', 
      nome: 'Bolt Food', 
      comissao: 27, 
      ativo: false, 
      cor: '#34d186',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    }
  ]);
  const [editandoApp, setEditandoApp] = useState(null);
  const [novaApp, setNovaApp] = useState({ nome: '', comissao: '25' });
  const [embalagens, setEmbalagens] = useState([]);
  const [novaEmbalagem, setNovaEmbalagem] = useState({ nome: '', custoUnitario: '', categoria: 'copos' });
  const [searchIngrediente, setSearchIngrediente] = useState('');
  const [searchIngredienteGlobal, setSearchIngredienteGlobal] = useState('');
  const [searchProdutoGlobal, setSearchProdutoGlobal] = useState('');

  // Auto-save GitHub (handled by GitHubSync internally)

  const [showIngredienteSuggestions, setShowIngredienteSuggestions] = useState(false);
  const [searchIngredienteFatura, setSearchIngredienteFatura] = useState('');
  const [showIngredienteSuggestionsFatura, setShowIngredienteSuggestionsFatura] = useState(false);
  
  // ==================== NOVOS ESTADOS V2.0 ====================
  const [modalConfirmacaoFatura, setModalConfirmacaoFatura] = useState({ mostrar: false, dados: null });
  const [blacklist, setBlacklist] = useState([]);
  const [configuracoes, setConfiguracoes] = useState(carregarConfiguracoes());
  const [novoIngrediente, setNovoIngrediente] = useState({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
  const [editandoIngrediente, setEditandoIngrediente] = useState(false);
  const [ingredienteEditandoId, setIngredienteEditandoId] = useState(null);
  const [novaDespesa, setNovaDespesa] = useState({ 
    descricao: '', 
    valor: '', 
    iva: '23', 
    data: new Date().toISOString().split('T')[0], 
    categoria: 'compras',
    fornecedor: '',
    ingredienteId: null,
    quantidade: '',
    num_funcionarios: 1,
    frequencia_pagamento: 'mensal',
    // Campos adicionais para documenta√ß√£o oficial
    numeroDocumento: '',
    tipoDocumento: 'Fatura',
    formaPagamento: 'Transfer√™ncia',
    notas: '',
    // Documento fiscal (PDF)
    documentoPDF: null, // Armazena o ficheiro PDF como base64
    nomeDocumento: '' // Nome original do ficheiro
  });
  const [searchDespesaIngrediente, setSearchDespesaIngrediente] = useState('');
  const [showDespesaSuggestions, setShowDespesaSuggestions] = useState(false);
  const [showPriceHistory, setShowPriceHistory] = useState(false);
  const [showPriceAlert, setShowPriceAlert] = useState(false);
  const [priceAlertData, setPriceAlertData] = useState(null);
  const [ordenadoDesejado, setOrdenadoDesejado] = useState(920);
  const [incluirSubsidioAlimentacao, setIncluirSubsidioAlimentacao] = useState(false);
  const [valorSubsidioAlimentacao, setValorSubsidioAlimentacao] = useState(6.00);
  const [modoSimulador, setModoSimulador] = useState('fulltime'); // 'fulltime' ou 'parttime'
  const [horasSemanaisPartTime, setHorasSemanaisPartTime] = useState(8);
  const [horasSemanais, setHorasSemanais] = useState(20);
  const [valorHora, setValorHora] = useState(10);
  const [simuladorAberto, setSimuladorAberto] = useState(false);
  const [notification, setNotification] = useState(null);
  const [expandedProduct, setExpandedProduct] = useState(null);
  const [searchTakeAway, setSearchTakeAway] = useState('');
  
  // Novos estados para Dados da Empresa
  const [dadosEmpresa, setDadosEmpresa] = useState({
    nif: '',
    nome: '',
    morada: '',
    codigoPostal: '',
    cidade: '',
    cae: '',
    email: '',
    telefone: ''
  });
  
  // Novos estados para Faturas
  const [faturas, setFaturas] = useState([]);

  // ============================================
  // üì¶ SISTEMA DE IMPORTA√á√ÉO AUTOM√ÅTICA
  // ============================================
  
  // Mapeamento de nomes Moloni/Zobaze ‚Üí Sistema
  const MAPEAMENTO_PRODUTOS = {"Expresso":"Caf√© Expresso","Bica/Expresso":"Caf√© Expresso","Expresso Take Away":"Caf√© Expresso","Bica/Take Away":"Caf√© Expresso","Meia De Leite":"Meia de Leite","Meia Leite":"Meia de Leite","Meia de Leite/White Coffee":"Meia de Leite","Meia de Leite Take Away":"Meia de Leite","Meia de Leite/White Coffee Take Away":"Meia de Leite","Capuccino":"Cappuccino","Cappuccino Take Away":"Cappuccino","Americano Take Away":"Americano","Americano/Black Coffee":"Americano","Descafeinado/Decaf":"Descafeinado","Galao":"Gal√£o","Matcha com Leite/Matcha Latte":"Matcha Latte","Matcha com Leite/Matcha Latte Take Away":"Matcha Latte","Matcha":"Matcha Latte","Matcha TG":"Matcha Latte","Cha/Tea":"Ch√°","Sumo de Laranja":"Sumo Laranja","Sumo de Laranja/Orange Juice":"Sumo Laranja","Sumo de Laranja Take Away":"Sumo Laranja","Sumo de Laranja/Take Away":"Sumo Laranja","Sumo Laranja TG":"Sumo Laranja","Sumo Caseiro Take Away":"Sumo Caseiro","Sumo Caseiro/Home made juice Take Away":"Sumo Caseiro","Mojito Picante/Spicy Mojito":"Spicy Mojito","Mojito Spicy":"Spicy Mojito","Mojito S/ Alcool":"Mojito Sem √Ålcool","Agua 1.5l":"√Ågua 1.5L","Agua Penacova 1.5L":"√Ågua 1.5L","Agua/Water 0.33l":"√Ågua 33cl","Aguas Penacova 33":"√Ågua 33cl","Aguas Penacova 50cl":"√Ågua 50cl","√Ågua Com G√°s":"√Ågua com G√°s 33cl","Agua com Gas Castello 25cl":"√Ågua com G√°s 25cl","Agua com Gas/Sparkling Water 0.33l":"√Ågua com G√°s 33cl","Cerveja Super Bock/Beer Super Bock 33l":"Cerveja Super Bock","Super Bock":"Cerveja Super Bock","Super Bock 33cl":"Cerveja Super Bock","Super Bock Stout":"Cerveja Super Bock Stout","Cerveja Preta/Stout":"Cerveja Super Bock Stout","Cerveja Artesanal 33l":"Cerveja Artesanal Mania","Cerveja Artesanal/Craft Beer 33l":"Cerveja Artesanal Mania","Castelo Rodrigo (branco) Garrafa":"Castelo Rodrigo Branco Garrafa","Castelo Rogrido Branco Copo":"Castelo Rodrigo Branco Copo","Castelo Rodrigo 100% Touriga Nacional Tinto (Beira Interior)":"Castelo Rodrigo Tinto Garrafa","Convento Aguiar Reserva Branco (Beira Interior)":"Convento Aguiar Branco Garrafa","Ladeira Santa Branco (Garrafa)":"Ladeira Santa Branco Garrafa","Ladeira da Santa Colheita Branco (Dao)":"Ladeira Santa Branco Garrafa","Ladeira da Santa 2023 Tinto (Dao)":"Ladeira Santa Tinto Garrafa","Ladeira da Santa Encruzado 2023 Tinto (Dao)":"Ladeira Santa Tinto Garrafa","Ladeira Santa Rose Copo":"Ladeira Santa Ros√© Copo","Ladeira da Santa Rose (Dao)":"Ladeira Santa Ros√© Copo","Falat√≥rio Bastardo Tinto (Lisboa)":"Falat√≥rio Bastardo Tinto","Aromas 4u Verde Copo":"Ladeira Santa Branco Copo","Aromas4U Sentido (Verde)":"Ladeira Santa Branco Garrafa","Ovos Turcos / Turkish Eggs":"Ovos Turcos","Ovos Turcos / Turkish Eggs s/picante":"Ovos Turcos","Croissant":"Olh'√≥ Croissant","Croque Monsieur":"Croque Monsieur Munchi","Croque Monsiur":"Croque Monsieur Munchi","Tosta de Abacate":"Tosta Abacate","Tosta Aberta de Abacate":"Tosta Abacate","Tosta de Requeij√£o":"Tosta Requeij√£o","Tosta de Requeij√£o":"Tosta Requeij√£o","Tosta Aberta de Requeij√£o":"Tosta Requeij√£o","Tosta Aberta de Requeij√£o":"Tosta Requeij√£o","Tosta Amendoim":"Tosta Manteiga Amendoim","Tosta Aberta de Manteiga de Amendoim":"Tosta Manteiga Amendoim","Wrap":"Wrap Ovo Bacon","Burrito":"Wrap Ovo Bacon","Rolos Crocantes picantes":"Rolos Crocantes Picante","Queijo Chevre":"Queijo Ch√®vre Flambeado","Queijo Chevre Flambeado":"Queijo Ch√®vre Flambeado","Sandes Polvo":"Sandes de Polvo","Sandes de Presunto, Brie e Mel":"Sandes Presunto TA","Sandes de Salm√£o Fumado e Salada de Ovo":"Sandes Salm√£o TA","Sandes de Salm√£o Fumado e Salada de Ovo":"Sandes Salm√£o TA","Salada de Queijo Burrata com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata e P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata e P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada Burrata":"Salada P√™ssegos Grelhados","Salada Burrata C/Presunto":"Salada P√™ssegos Grelhados","Salada de Burrata e P√™ssego Grelhado C/ Presunto":"Salada P√™ssegos Grelhados","Salada de Burrata e P√™ssego Grelhado C/ Presunto":"Salada P√™ssegos Grelhados","Salada de Queijo Feta com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Feta com P√™ssego":"Salada P√™ssegos Grelhados","Salada Feta":"Salada P√™ssegos Grelhados","Salada de Queijo com P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada de Queijo com P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada Extra":"Salada P√™ssegos Grelhados","Bolo de Lim√£o/Lemon Cake":"Bolo de Lim√£o com Mirtilos","Bolo de Lim√£o/Lemon Cake":"Bolo de Lim√£o com Mirtilos","Bolo Lim√£o":"Bolo de Lim√£o com Mirtilos","Bolo Chocolate":"Bolo de Chocolate com Caramelo Salgado","Red Velvet":"Bolo Red Velvet com Frutos Vermelhos","Bolo Banana":"Bolo de Banana","Bolo Bolacha":"Bolo de Bolacha","Cheesecake Frutos Vermelhos":"Cheesecake de Frutos Vermelhos","Cheesecake Frutos Tropicais":"Cheesecake de Frutos Tropicais","Cheesecake frutos tropicais":"Cheesecake de Frutos Tropicais","Cheesecake Matcha":"Cheesecake de Matcha","Cheesecake Matcha Manga e Maracuja":"Cheesecake de Matcha","Cheesecake Merengue queimado":"Cheesecake Merengue Queimado","Pavlova":"Mini Pavlova de Frutos Vermelhos","Pudim Chia Frutos Vermelhos":"Pudim Chia","Pudim Chia com Matcha":"Pudim Chia Matcha","Pudin Chia Vegan":"Pudim Chia","Cebola 100":"Chutney Cebola 100ml","Cebola 100 ml":"Chutney Cebola 100ml","Cebola 250":"Chutney Cebola 250ml","Cebola 250 ml":"Chutney Cebola 250ml","Chipotle 100":"Chutney Chipotle 100ml","Chipotle 100 ml":"Chutney Chipotle 100ml","Chipotle 250":"Chutney Chipotle 250ml","Chipotle 250 ml":"Chutney Chipotle 250ml","Jalape√±os Verdes 100":"Chutney Jalape√±os Verde 100ml","Jalapenos Verde 100 ml":"Chutney Jalape√±os Verde 100ml","Jalape√±os Verdes 250":"Chutney Jalape√±os Verde 250ml","Jalapenos Verde 250 ml":"Chutney Jalape√±os Verde 250ml","Jalape√±os Vermelhos 100":"Chutney Jalape√±os Vermelho 100ml","Jalapenos Vermelhos 100 ml":"Chutney Jalape√±os Vermelho 100ml","Jalape√±os Vermelho 250":"Chutney Jalape√±os Vermelho 250ml","Jalapenos Vermelhos 250 ml":"Chutney Jalape√±os Vermelho 250ml","Pimentos Vermelhos 100":"Chutney Pimentos 100ml","Pimentos Vermelhos 100ml":"Chutney Pimentos 100ml","Pimentos Vermelhos 250ml":"Chutney Pimentos 250ml","Ab√≥bora 100":"Compota Ab√≥bora 100ml","Abobora 100 ml":"Compota Ab√≥bora 100ml","Ab√≥bora 250":"Compota Ab√≥bora 250ml","Abobora 250 ml":"Compota Ab√≥bora 250ml","Figo 100":"Compota Figo 100ml","Figo 250":"Compota Figo 250ml","Tomate 100":"Compota Tomate 100ml","Tomate 100 ml":"Compota Tomate 100ml","Tomate 250":"Compota Tomate 250ml","Tomate 250 ml":"Compota Tomate 250ml","Laranja 100":"Vinagrete Laranja 100ml","Laranja 100 ml":"Vinagrete Laranja 100ml","Laranja 250":"Vinagrete Laranja 250ml","Laranja 250 ml":"Vinagrete Laranja 250ml"};
  
  const mapearNomeProduto = (nome) => MAPEAMENTO_PRODUTOS[nome] || nome;
  
  const [mostrarImportacao, setMostrarImportacao] = useState(false);
  const [fonteImportacao, setFonteImportacao] = useState('moloni');
  
  // Importar vendas CSV
  const importarVendasCSV = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const texto = e.target.result;
        const linhas = texto.split('\n');
        const vendasImportadas = [];
        
        for (let i = 1; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;
          
          const campos = linha.split(',').map(c => c.replace(/"/g, '').trim());
          if (campos.length < 3) continue;
          
          const [data, nomeProduto, valorStr] = campos;
          const valor = parseFloat(valorStr);
          
          if (!data || !nomeProduto || isNaN(valor)) continue;
          
          const nomeCorrigido = mapearNomeProduto(nomeProduto);
          const produto = produtos.find(p => p.nome === nomeCorrigido);
          
          vendasImportadas.push({
            id: Date.now() + Math.random(),
            data: data,
            produto: nomeCorrigido,
            produtoId: produto?.id || null,
            quantidade: 1,
            valor: valor,
            iva: produto?.iva || 6,
            origem: fonteImportacao // ‚úÖ 'moloni' ou 'zobaze'
          });
        }
        
        if (vendasImportadas.length > 0) {
          const novasVendas = [...vendas, ...vendasImportadas];
          setVendas(novasVendas);
          setMostrarImportacao(false);
          
          const comEmparelhamento = vendasImportadas.filter(v => v.produtoId).length;
          const semEmparelhamento = vendasImportadas.length - comEmparelhamento;
          
          showNotification(
            `‚úÖ ${vendasImportadas.length} vendas importadas!\n` +
            `‚úì ${comEmparelhamento} emparelhadas\n` +
            `‚ö† ${semEmparelhamento} sem emparelhamento\n` +
            `Fonte: ${fonteImportacao}`,
            'success'
          );
        } else {
          alert('‚ùå Nenhuma venda v√°lida encontrada.');
        }
      } catch (error) {
        alert('‚ùå Erro: ' + error.message);
      }
    };
    reader.readAsText(file);
  };
  const [novaFatura, setNovaFatura] = useState({
    numero: '',
    tipoDocumento: 'fatura', // NOVO: 'fatura' ou 'recibo'
    data: new Date().toISOString().split('T')[0],
    fornecedorId: '',
    itens: [],
    notas: '',
    categoria: 'compras', // Nova: compras, renda, eletricidade, agua, gas, internet, salarios, marketing, consumiveis, manutencao, outros
    recorrente: false, // Nova: se repete mensalmente
    diaRecorrencia: 1, // Nova: dia do m√™s para repetir (1-31)
    documentoPDF: null, // PDF da fatura em base64
    nomeDocumento: '' // Nome original do ficheiro PDF
  });
  const [itemFatura, setItemFatura] = useState({
    ingredienteId: '',
    descricao: '', // Para despesas n√£o-compras
    quantidade: '',
    unidade: '',
    precoTotal: '',
    iva: '13',
    num_funcionarios: 1 // Para sal√°rios
  });
  const [criandoIngrediente, setCriandoIngrediente] = useState(false); // Modo cria√ß√£o inline
  const [showDropdownIngrediente, setShowDropdownIngrediente] = useState(false); // Controla dropdown
  const [expandedFatura, setExpandedFatura] = useState(null);
  const [editandoFatura, setEditandoFatura] = useState(false);
  const [faturaEditando, setFaturaEditando] = useState(null);
  const [modoFormulario, setModoFormulario] = useState('completo'); // 'completo' ou 'rapido'
  const [dadosEmpresaExpanded, setDadosEmpresaExpanded] = useState(false);
  const [blacklistExpanded, setBlacklistExpanded] = useState(false);
  const [configuracoesExpanded, setConfiguracoesExpanded] = useState(false);
  const [categoriaFiltroDesempenho, setCategoriaFiltroDesempenho] = useState('todos');
  const [mesSelecionado, setMesSelecionado] = useState(new Date().getMonth());
  const [anoSelecionado, setAnoSelecionado] = useState(new Date().getFullYear());
  const [backupExpanded, setBackupExpanded] = useState(false);
  
  // Estados OCR
  const [mostrarModalOCR, setMostrarModalOCR] = useState(false);
  const [linhasOCR, setLinhasOCR] = useState([]);
  const [metadataOCR, setMetadataOCR] = useState(null);
  const [processandoOCR, setProcessandoOCR] = useState(false);
  const [progressoOCR, setProgressoOCR] = useState('');
  
  // Verificar carregamento das bibliotecas OCR (Tesseract e Fuzzball apenas)
  useEffect(() => {
    let attempts = 0;
    const maxAttempts = 5;
    
    const checkLibraries = () => {
      const pdfjs = typeof pdfjsLib !== 'undefined';
      const tesseract = typeof Tesseract !== 'undefined';
      const fuzzball = typeof window.fuzzball !== 'undefined';
      
      if (pdfjs && tesseract && fuzzball) {
        console.log('‚úÖ Todas bibliotecas OCR carregadas: PDF.js + Tesseract + Fuzzball');
        showNotification('‚úÖ Sistema OCR completo pronto!', 'success');
        return true;
      }
      
      console.log(`‚è≥ Tentativa ${attempts + 1}/${maxAttempts}:`, { pdfjs, tesseract, fuzzball });
      return false;
    };
    
    // Verificar com retry
    const checkInterval = setInterval(() => {
      attempts++;
      
      if (checkLibraries()) {
        clearInterval(checkInterval);
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        console.error('‚ùå Bibliotecas OCR n√£o carregaram ap√≥s', maxAttempts, 'tentativas');
        console.error('Status final:', {
          pdfjsLib: typeof pdfjsLib,
          Tesseract: typeof Tesseract,
          fuzzball: typeof window.fuzzball
        });
        showNotification('‚ö†Ô∏è OCR pode n√£o funcionar. Tente recarregar a p√°gina.', 'warning');
      }
    }, 1000); // Verificar a cada 1 segundo
    
    return () => clearInterval(checkInterval);
  }, []);
  
  // ==================== CARREGAR BLACKLIST ====================
  useEffect(() => {
    const blacklistGuardada = localStorage.getItem('munchi_blacklist');
    if (blacklistGuardada) {
      try {
        setBlacklist(JSON.parse(blacklistGuardada));
        console.log('‚úÖ Blacklist carregada');
      } catch (e) {
        console.error('Erro ao carregar blacklist:', e);
      }
    }
  }, []);
  
  const [fornecedoresExpanded, setFornecedoresExpanded] = useState(false);
  const [deliveryAppsExpanded, setDeliveryAppsExpanded] = useState(false);
  const [editandoFornecedor, setEditandoFornecedor] = useState(false);
  const [fornecedorEditandoId, setFornecedorEditandoId] = useState(null);
  const [dadosFornecedor, setDadosFornecedor] = useState({
    nome: '',
    nif: '',
    morada: '',
    email: '',
    telefone: ''
  });

  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // ==================== HANDLERS V2.0 ====================
  
  const handleAdicionarBlacklist = (item) => {
    const novaBlacklist = [...blacklist, item];
    setBlacklist(novaBlacklist);
    localStorage.setItem('munchi_blacklist', JSON.stringify(novaBlacklist));
    showNotification(`"${item}" adicionado √† blacklist`, 'success');
  };

  const handleRemoverBlacklist = (item) => {
    const novaBlacklist = blacklist.filter(i => i !== item);
    setBlacklist(novaBlacklist);
    localStorage.setItem('munchi_blacklist', JSON.stringify(novaBlacklist));
    showNotification(`"${item}" removido da blacklist`, 'success');
  };

  const handleSalvarConfiguracoes = (novasConfiguracoes) => {
    setConfiguracoes(novasConfiguracoes);
    guardarConfiguracoes(novasConfiguracoes);
    
    // Recalcular m√©tricas com novas configura√ß√µes
    const novasMetricas = recalcularMetricas(faturas, vendas, novasConfiguracoes); // ‚úÖ USAR FATURAS
    // TODO: Atualizar state de m√©tricas quando implementado
    
    showNotification('‚úÖ Configura√ß√µes guardadas!', 'success');
  };

  const handleConfirmarFatura = (dadosConfirmados) => {
    console.log('‚úÖ Fatura confirmada:', dadosConfirmados);
    
    // Atualizar metadata OCR com dados confirmados
    setMetadataOCR(prev => ({
      ...prev,
      tipoFatura: dadosConfirmados.tipo,
      numeroFatura: dadosConfirmados.numero,
      fornecedor: dadosConfirmados.fornecedor.nome,
      nif: dadosConfirmados.fornecedor.nif,
      dataFatura: dadosConfirmados.data,
      atcud: dadosConfirmados.atcud,
      totais: dadosConfirmados.totais,
      precosComIVA: dadosConfirmados.precosComIVA // ‚úÖ CR√çTICO: passar flag de IVA
    }));
    
    console.log('üìã Metadata atualizada com precosComIVA:', dadosConfirmados.precosComIVA);
    
    // Fechar modal
    setModalConfirmacaoFatura({ mostrar: false, dados: null });
    
    showNotification(`Fatura ${dadosConfirmados.tipo} confirmada!`, 'success');
  };

  const handleCancelarFatura = () => {
    setModalConfirmacaoFatura({ mostrar: false, dados: null });
  };


  // ==================== üß† SISTEMA DE APRENDIZAGEM - FASE 1 ====================
  
  /**
   * Normaliza texto OCR para compara√ß√£o
   * Remove acentos, pontua√ß√£o, unidades, n√∫meros
   */
  const normalizarTexto = (texto) => {
    if (!texto) return '';
    
    return texto
      .toUpperCase()
      // Remover acentos
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      // Remover unidades comuns
      .replace(/\b(KG|GR|G|LT|L|ML|CX|UN|UND|UNID|PCT|PC|EMB)\b/gi, '')
      // Remover n√∫meros isolados
      .replace(/\b\d+\b/g, '')
      // Remover pontua√ß√£o e caracteres especiais
      .replace(/[^\w\s]/g, ' ')
      // Remover espa√ßos m√∫ltiplos
      .replace(/\s+/g, ' ')
      .trim();
  };

  /**
   * Calcula similaridade entre dois textos normalizados (0-100)
   * Usa algoritmo de Levenshtein via fuzzball
   */
  const calcularSimilaridade = (texto1, texto2) => {
    if (!texto1 || !texto2) return 0;
    if (typeof window.fuzzball === 'undefined') return 0;
    
    const norm1 = normalizarTexto(texto1);
    const norm2 = normalizarTexto(texto2);
    
    if (norm1 === norm2) return 100;
    
    try {
      return window.fuzzball.ratio(norm1, norm2);
    } catch (e) {
      console.warn('Erro ao calcular similaridade:', e);
      return 0;
    }
  };

  /**
   * Busca ingrediente no vocabul√°rio do fornecedor
   * Retorna: { ingredienteId, confianca, historico } ou null
   */
   
// ==================== MUNCHI INVOICE PROCESSOR V2.0 ====================
// Este c√≥digo deve ser adicionado ap√≥s a linha 2500 do index.html
// (depois das fun√ß√µes de normaliza√ß√£o existentes)

// ==================== CONFIGURA√á√ÉO DE TIPOS DE FATURA ====================

// ==================== FUN√á√ïES DE DETEC√á√ÉO ====================

/**
 * Detecta o tipo de fatura (FT, FR ou FS)
 */
const detectarTipoFatura = (texto) => {
  if (!texto) return 'FT';
  
  // Verificar em ordem: FR, FS, FT (do mais espec√≠fico para o mais gen√©rico)
  const ordemVerificacao = ['FR', 'FS', 'FT'];
  
  for (const tipo of ordemVerificacao) {
    const config = INVOICE_TYPES[tipo];
    for (const pattern of config.patterns) {
      if (pattern.test(texto)) {
        console.log(`‚úÖ Tipo detectado: ${tipo} usando pattern:`, pattern);
        return tipo;
      }
    }
  }
  
  console.log('‚ö†Ô∏è Tipo n√£o detectado, usando default: FT');
  return 'FT';
};

/**
 * Extrai o n√∫mero da fatura baseado no tipo
 */
const extrairNumeroFatura = (texto, tipoFatura) => {
  if (!texto) return null;
  
  const config = INVOICE_TYPES[tipoFatura];
  if (!config) return null;
  
  for (const pattern of config.numberPatterns) {
    const match = texto.match(pattern);
    if (match) {
      console.log(`‚úÖ N√∫mero extra√≠do: ${match[1]} usando pattern:`, pattern);
      return match[1].trim();
    }
  }
  
  console.log('‚ö†Ô∏è N√∫mero de fatura n√£o encontrado');
  return null;
};

/**
 * Detecta fornecedor conhecido
 */
const detectarFornecedor = (texto) => {
  if (!texto) return { nome: 'Fornecedor Desconhecido', nif: '' };
  
  for (const [chave, fornecedor] of Object.entries(FORNECEDORES_CONHECIDOS)) {
    for (const pattern of fornecedor.patterns) {
      if (pattern.test(texto)) {
        console.log(`‚úÖ Fornecedor detectado: ${fornecedor.nome}`);
        return {
          chave: chave,
          nome: fornecedor.nome,
          nif: fornecedor.nif
        };
      }
    }
  }
  
  // Tentar encontrar qualquer NIF
  const nifMatch = texto.match(/(?:NIF|Contribuinte)[:\s]+(\d{9})/);
  if (nifMatch) {
    return {
      chave: 'desconhecido',
      nome: 'Fornecedor Desconhecido',
      nif: nifMatch[1]
    };
  }
  
  return { nome: 'Fornecedor Desconhecido', nif: '' };
};

/**
 * Extrai ATCUD da fatura
 */
const extrairATCUD = (texto) => {
  if (!texto) return null;
  
  const patterns = [
    /ATCUD:\s*([A-Z0-9-]+)/,
    /ATCUD:([A-Z0-9-]+)/
  ];
  
  for (const pattern of patterns) {
    const match = texto.match(pattern);
    if (match) {
      console.log(`‚úÖ ATCUD extra√≠do: ${match[1]}`);
      return match[1].trim();
    }
  }
  
  return null;
};

/**
 * Extrai data da fatura
 */
const extrairDataFatura = (texto) => {
  if (!texto) return new Date().toISOString().split('T')[0];
  
  const patterns = [
    /Data\s+de\s+Emiss√£o:\s*(\d{2}-\d{2}-\d{4})/,
    /Data:\s*(\d{2}-\d{2}-\d{4})/,
    /(\d{2}-\d{2}-\d{4})/,
    /(\d{4})-(\d{2})-(\d{2})/,
    /2026[-\s](\d{2})[-\s](\d{2})/
  ];
  
  for (const pattern of patterns) {
    const match = texto.match(pattern);
    if (match) {
      let dateStr = match[0];
      // Normalizar para YYYY-MM-DD
      if (/\d{2}-\d{2}-\d{4}/.test(dateStr)) {
        const parts = dateStr.split('-');
        dateStr = `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      console.log(`‚úÖ Data extra√≠da: ${dateStr}`);
      return dateStr;
    }
  }
  
  return new Date().toISOString().split('T')[0];
};

/**
 * Extrai totais da fatura (subtotal, IVA, total)
 */
const extrairTotaisFatura = (texto) => {
  if (!texto) return { subtotal: 0, iva: 0, total: 0 };
  
  const result = { subtotal: 0, iva: 0, total: 0 };
  
  // Padr√µes para subtotal
  const subtotalPatterns = [
    /Total\s+Il√≠q[:\.\s]+([\d,\.]+)‚Ç¨?/i,
    /Subtotal[:\s]+([\d,\.]+)/i,
    /Total\s+s\/\s*imp[:\s]+([\d,\.]+)/i
  ];
  
  // Padr√µes para IVA
  const ivaPatterns = [
    /IVA\s+Normal[:\s]+([\d,\.]+)‚Ç¨?/i,
    /IVA[:\s]+([\d,\.]+)‚Ç¨?/i,
    /Total\s+IVA[:\s]+([\d,\.]+)/i
  ];
  
  // Padr√µes para total
  const totalPatterns = [
    /Total\s+a\s+pagar[:\s]+([\d,\.]+)‚Ç¨?/i,
    /Total[:\s]+([\d,\.]+)‚Ç¨?\s*$/im,
    /TOTAL[:\s]+([\d,\.]+)/i
  ];
  
  // Extrair subtotal
  for (const pattern of subtotalPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.subtotal = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }
  
  // Extrair IVA
  for (const pattern of ivaPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.iva = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }
  
  // Extrair total
  for (const pattern of totalPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.total = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }
  
  console.log('‚úÖ Totais extra√≠dos:', result);
  return result;
};

// ==================== PROCESSAMENTO PRINCIPAL ====================

/**
 * Processa texto OCR e extrai todos os dados da fatura
 */
const processarTextoFatura = (texto) => {
  console.log('üîç Iniciando processamento de fatura...');
  
  const tipoFatura = detectarTipoFatura(texto);
  const numeroFatura = extrairNumeroFatura(texto, tipoFatura);
  const fornecedor = detectarFornecedor(texto);
  const data = extrairDataFatura(texto);
  const atcud = extrairATCUD(texto);
  const totais = extrairTotaisFatura(texto);
  
  // Determinar se pre√ßos no PDF s√£o COM ou SEM IVA baseado no fornecedor
  let precosComIVA = true; // Default: pre√ßos COM IVA
  
  // MANIA CERVEJEIRA: pre√ßos SEM IVA
  if (fornecedor.nif === '278240160' || fornecedor.nome.includes('MANIA')) {
    precosComIVA = false;
  }
  
  // Recheio: pre√ßos COM IVA (padr√£o)
  if (fornecedor.nif === '9568126' || fornecedor.nome.includes('Recheio')) {
    precosComIVA = true;
  }
  
  const resultado = {
    tipo: tipoFatura,
    numero: numeroFatura || 'N/A',
    fornecedor: fornecedor,
    data: data,
    atcud: atcud,
    totais: totais,
    precosComIVA: precosComIVA, // NOVO: flag para saber se pre√ßos incluem IVA
    textoCompleto: texto
  };
  
  console.log('‚úÖ Fatura processada:', resultado);
  return resultado;
};

// ==================== C√ÅLCULOS DE PRE√áO COM IVA ====================

/**
 * Calcula breakdown de pre√ßo com IVA
 * @param {number} totalComIVA - Pre√ßo total com IVA
 * @param {number} quantidade - Quantidade de unidades
 * @param {number} taxaIVA - Taxa de IVA (ex: 23)
 * @returns {object} - { precoSemIVA, taxaIVA, valorIVA, precoComIVA }
 */
const calcularBreakdownPreco = (totalComIVA, quantidade, taxaIVA) => {
  const precoPorUnidadeComIVA = totalComIVA / quantidade;
  const precoPorUnidadeSemIVA = precoPorUnidadeComIVA / (1 + taxaIVA / 100);
  const valorIVAPorUnidade = precoPorUnidadeComIVA - precoPorUnidadeSemIVA;
  
  return {
    precoSemIVA: precoPorUnidadeSemIVA,
    taxaIVA: taxaIVA,
    valorIVA: valorIVAPorUnidade,
    precoComIVA: precoPorUnidadeComIVA,
    precoTotal: totalComIVA
  };
};

/**
 * Atualiza pre√ßo de ingrediente a partir de item da fatura
 * IMPORTANTE: Guarda o pre√ßo COM IVA!
 */
const atualizarPrecoIngrediente = (ingredienteId, dadosFatura, ingredientes) => {
  const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
  if (!ingrediente) {
    console.warn(`Ingrediente ${ingredienteId} n√£o encontrado`);
    return ingredientes;
  }
  
  // Calcular breakdown de pre√ßos
  const breakdown = calcularBreakdownPreco(
    dadosFatura.precoTotal,
    dadosFatura.quantidade,
    dadosFatura.taxaIVA
  );
  
  // Atualizar ingrediente com pre√ßo COM IVA
  ingrediente.custoUnitario = breakdown.precoComIVA;
  ingrediente.taxaIVA = breakdown.taxaIVA;
  ingrediente.ultimaAtualizacao = new Date().toISOString();
  
  // Guardar info de display
  ingrediente.infoDisplay = {
    comIVA: breakdown.precoComIVA,
    semIVA: breakdown.precoSemIVA,
    valorIVA: breakdown.valorIVA
  };
  
  console.log(`‚úÖ Ingrediente ${ingrediente.nome} atualizado:`, {
    precoComIVA: breakdown.precoComIVA.toFixed(3),
    precoSemIVA: breakdown.precoSemIVA.toFixed(3)
  });
  
  return [...ingredientes];
};

// ==================== C√ÅLCULOS DE MARGEM ====================

/**
 * Calcula margens de produto (markup E margem bruta)
 * @param {object} produto - Produto com precoVenda e custoReceita
 * @param {object} configuracoes - Configura√ß√µes de alertas
 * @returns {object} - Margens calculadas com status
 */
const calcularMargensProduto = (produto, configuracoes = null) => {
  const precoVenda = produto.precoVenda || 0;
  const custo = produto.custoReceita || 0;
  
  if (precoVenda === 0) return null;
  
  const lucro = precoVenda - custo;
  const markup = custo > 0 ? (lucro / custo) * 100 : 0;
  const margemBruta = (lucro / precoVenda) * 100;
  
  // Determinar status baseado nas configura√ß√µes
  let status = 'good';
  let cor = 'green';
  
  const limiarBaixo = configuracoes?.alertas?.margemBaixa || 70;
  const limiarCritico = configuracoes?.alertas?.margemCritica || 55;
  
  if (margemBruta < limiarCritico) {
    status = 'critical';
    cor = 'red';
  } else if (margemBruta < limiarBaixo) {
    status = 'warning';
    cor = 'yellow';
  }
  
  return {
    custo: custo,
    precoVenda: precoVenda,
    lucro: lucro,
    markup: markup,
    margemBruta: margemBruta,
    status: {
      status: status,
      cor: cor
    }
  };
};

// ==================== REC√ÅLCULO DE M√âTRICAS ====================

/**
 * Recalcula todas as m√©tricas ap√≥s mudan√ßas
 * Deve ser chamado ap√≥s: adicionar fatura, venda, ou mudar configura√ß√µes
 */
const recalcularMetricas = (faturas, vendas, configuracoes) => {
  console.log('üìä Recalculando m√©tricas...');
  console.log('üì¶ Faturas recebidas:', faturas.length);
  console.log('üí∞ Vendas recebidas:', vendas.length);
  
  const config = configuracoes || carregarConfiguracoes();
  console.log('‚öôÔ∏è Configura√ß√µes:', config);
  
  // Calcular despesas por tipo
  const despesas = {
    FT: 0,
    FR: 0,
    FS: 0,
    total: 0
  };
  
  faturas.forEach(fatura => {
    const total = fatura.totais?.total || fatura.total || 0;
    const tipo = fatura.tipo || 'FT';
    
    console.log(`üìù Fatura: tipo=${tipo}, total=‚Ç¨${total.toFixed(2)}`);
    
    if (tipo === 'FT') despesas.FT += total;
    else if (tipo === 'FR') despesas.FR += total;
    else if (tipo === 'FS') despesas.FS += total;
  });
  
  console.log('üí∏ Despesas por tipo:', despesas);
  
  // Aplicar filtro de configura√ß√µes
  if (config.metricas.apenasOficial) {
    // Oficial LIGADO: s√≥ FT e FR (sem FS)
    despesas.total = despesas.FT + despesas.FR;
  } else {
    // Oficial DESLIGADO: tudo (FS + FT + FR)
    despesas.total = despesas.FT + despesas.FR + despesas.FS;
  }
  
  // Calcular receita
  let receita = 0;
  let vendasMoloni = 0;
  let vendasZobaze = 0;
  
  vendas.forEach(venda => {
    // Filtro baseado em modo oficial
    const eZobaze = venda.origem === 'zobaze';
    const eMoloni = venda.origem === 'moloni' || !venda.origem; // Default √© Moloni
    const total = venda.total || 0;
    
    console.log(`üõí Venda: origem=${venda.origem || 'moloni (default)'}, total=‚Ç¨${total.toFixed(2)}`);
    
    if (eZobaze) vendasZobaze += total;
    if (eMoloni) vendasMoloni += total;
    
    if (config.metricas.apenasOficial) {
      // Oficial LIGADO: s√≥ Moloni
      if (eMoloni) {
        receita += total;
      }
    } else {
      // Oficial DESLIGADO: Moloni + Zobaze (tudo)
      receita += total;
    }
  });
  
  console.log(`üíµ Receitas: Moloni=‚Ç¨${vendasMoloni.toFixed(2)}, Zobaze=‚Ç¨${vendasZobaze.toFixed(2)}, Total aplicado=‚Ç¨${receita.toFixed(2)}`);
  
  // Calcular COGS (Cost of Goods Sold)
  // Isto deve ser calculado baseado nas receitas dos produtos vendidos
  const cogs = 0; // TODO: implementar c√°lculo real
  
  // Margem bruta
  const margemBruta = receita - cogs;
  const margemBrutaPercent = receita > 0 ? (margemBruta / receita) * 100 : 0;
  
  // Lucro l√≠quido (s√≥ se todas as despesas estiverem preenchidas)
  const lucroLiquido = margemBruta - despesas.total;
  
  const resultado = {
    receita: receita,
    despesas: despesas,
    cogs: cogs,
    margemBruta: margemBruta,
    margemBrutaPercent: margemBrutaPercent,
    lucroLiquido: lucroLiquido,
    timestamp: new Date().toISOString()
  };
  
  console.log('‚úÖ M√©tricas calculadas:', resultado);
  return resultado;
};

// ==================== √çNDICE DE DESPERD√çCIO ====================

/**
 * Calcula √≠ndice de desperd√≠cio
 * F√≥rmula: (Compras - Vendas convertidas em custo) / Compras * 100
 */
const calcularIndiceDesperdicio = (comprasPeriodo, vendasPeriodo, produtos) => {
  // Total de compras
  const totalCompras = comprasPeriodo.reduce((sum, compra) => {
    return sum + (compra.totais?.total || compra.total || 0);
  }, 0);
  
  // Calcular custo real das vendas
  let custoVendas = 0;
  vendasPeriodo.forEach(venda => {
    venda.itens?.forEach(item => {
      const produto = produtos.find(p => p.id === item.produtoId);
      if (produto) {
        custoVendas += produto.custoReceita * item.quantidade;
      }
    });
  });
  
  // Calcular desperd√≠cio
  const desperdicio = totalCompras - custoVendas;
  const desperdicioPercent = totalCompras > 0 ? (desperdicio / totalCompras) * 100 : 0;
  
  return {
    compras: totalCompras,
    custoVendas: custoVendas,
    desperdicio: desperdicio,
    desperdicioPercent: desperdicioPercent,
    status: desperdicioPercent > 10 ? 'alto' : 'normal'
  };
};

console.log('‚úÖ Munchi Invoice Processor V2.0 carregado!');

  // ==================== üß† SISTEMA DE APRENDIZAGEM - CONTINUA√á√ÉO ====================
  
  const buscarNoVocabulario = (textoOCR, nifFornecedor) => {
    if (!textoOCR || !nifFornecedor) return null;
    
    const textoNorm = normalizarTexto(textoOCR);
    
    // Filtrar vocabul√°rio deste fornecedor
    const vocabFornecedor = vocabularioFornecedor.filter(
      v => v.fornecedorNIF === nifFornecedor
    );
    
    if (vocabFornecedor.length === 0) return null;
    
    // Procurar melhor match
    let melhorMatch = null;
    let melhorSimilaridade = 0;
    
    vocabFornecedor.forEach(vocab => {
      const similaridade = calcularSimilaridade(textoNorm, vocab.textoNormalizado);
      
      if (similaridade > melhorSimilaridade && similaridade >= 70) {
        // Calcular confian√ßa baseada em hist√≥rico
        const confirmacoes = vocab.confirmacoes || 0;
        const correcoes = vocab.correcoes || 0;
        const fatorHistorico = confirmacoes / (confirmacoes + correcoes + 1);
        const confianca = (similaridade / 100) * fatorHistorico * 100;
        
        melhorMatch = {
          ingredienteId: vocab.ingredienteId,
          confianca: Math.round(confianca),
          similaridade: Math.round(similaridade),
          confirmacoes,
          correcoes,
          textoOriginal: vocab.textoOriginal
        };
        melhorSimilaridade = similaridade;
      }
    });
    
    return melhorMatch;
  };

  /**
   * Adiciona ou atualiza entrada no vocabul√°rio
   */
  const aprenderAssociacao = (textoOCR, ingredienteId, nifFornecedor, foiCorrecao = false) => {
    if (!textoOCR || !ingredienteId || !nifFornecedor) return;
    
    const textoNorm = normalizarTexto(textoOCR);
    
    // Verificar se j√° existe
    const indexExistente = vocabularioFornecedor.findIndex(
      v => v.fornecedorNIF === nifFornecedor && 
           v.textoNormalizado === textoNorm &&
           v.ingredienteId === ingredienteId
    );
    
    if (indexExistente >= 0) {
      // Atualizar existente
      const atualizado = [...vocabularioFornecedor];
      if (foiCorrecao) {
        atualizado[indexExistente].correcoes = (atualizado[indexExistente].correcoes || 0) + 1;
      } else {
        atualizado[indexExistente].confirmacoes = (atualizado[indexExistente].confirmacoes || 0) + 1;
      }
      atualizado[indexExistente].ultimaConfirmacao = new Date().toISOString();
      setVocabularioFornecedor(atualizado);
      
      console.log(`üìö Vocabul√°rio atualizado:`, atualizado[indexExistente]);
    } else {
      // Criar novo
      const novo = {
        id: `vocab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        fornecedorNIF: nifFornecedor,
        textoOriginal: textoOCR,
        textoNormalizado: textoNorm,
        ingredienteId: ingredienteId,
        confirmacoes: foiCorrecao ? 0 : 1,
        correcoes: foiCorrecao ? 1 : 0,
        ultimaConfirmacao: new Date().toISOString()
      };
      
      setVocabularioFornecedor([...vocabularioFornecedor, novo]);
      console.log(`üìö Nova entrada no vocabul√°rio:`, novo);
    }
  };

  // ==================== FIM SISTEMA DE APRENDIZAGEM ====================

  // ==================== üìã SISTEMA DE TEMPLATES OCR ====================
  
  const detectarLayoutFatura = (texto) => {
    const linhas = texto.split('\n').map(l => l.trim());
    const marcadoresInicio = [
      /ref.*artigo.*designa/i,
      /produto.*quantidade.*pre/i,
      /designa√ß√£o.*qtd.*pre√ßo/i
    ];
    const marcadoresFim = [
      /resumo.*impost/i,
      /total.*pagar/i,
      /informa.*banc√°ria/i
    ];
    
    let linhaInicio = -1;
    let linhaFim = linhas.length;
    
    for (let i = 0; i < linhas.length; i++) {
      if (marcadoresInicio.some(m => m.test(linhas[i]))) {
        linhaInicio = i + 1;
        break;
      }
    }
    
    for (let i = linhaInicio + 1; i < linhas.length; i++) {
      if (marcadoresFim.some(m => m.test(linhas[i]))) {
        linhaFim = i;
        break;
      }
    }
    
    return { linhaInicio: Math.max(0, linhaInicio), linhaFim };
  };
  
  const buscarTemplateOCR = (nifFornecedor) => {
    if (!nifFornecedor) return null;
    return templatesOCR.find(t => t.nifFornecedor === nifFornecedor);
  };
  
  // üö´ Extrair palavras-chave de uma linha para blacklist
  const extrairPalavrasChave = (linha) => {
    // Remove n√∫meros, s√≠mbolos, unidades comuns
    const texto = linha
      .toLowerCase()
      .replace(/[0-9‚Ç¨%\-\+\.,:\(\)]/g, ' ') // Remove n√∫meros e s√≠mbolos
      .replace(/\s+/g, ' ')
      .trim();
    
    // Palavras que N√ÉO devem ir para blacklist (s√£o normais em produtos)
    const palavrasComuns = ['kg', 'g', 'l', 'ml', 'un', 'cx', 'caixa', 'pack', 'unid', 'unidade', 'lts'];
    
    const palavras = texto
      .split(/\s+/)
      .filter(p => p.length > 2) // M√≠nimo 3 caracteres
      .filter(p => !palavrasComuns.includes(p))
      .slice(0, 3); // M√°ximo 3 palavras-chave por linha
    
    return palavras;
  };
  
  // üö´ Adicionar linha √† blacklist do template
  const adicionarABlacklist = (nifFornecedor, linha) => {
    console.log('üîç adicionarABlacklist chamada:', { nifFornecedor, linha });
    
    if (!nifFornecedor) {
      console.log('‚ùå NIF n√£o fornecido');
      showNotification('‚ùå NIF n√£o detectado! Imposs√≠vel adicionar √† blacklist.', 'error');
      return;
    }
    
    const palavras = extrairPalavrasChave(linha);
    console.log('üîç Palavras extra√≠das:', palavras);
    
    if (palavras.length === 0) {
      console.log('‚ùå Nenhuma palavra-chave extra√≠da');
      showNotification('‚ùå Nenhuma palavra-chave extra√≠da desta linha.', 'error');
      return;
    }
    
    let template = buscarTemplateOCR(nifFornecedor);
    console.log('üîç Template encontrado:', template ? 'SIM' : 'N√ÉO');
    
    // Se n√£o existe template, criar um novo
    if (!template) {
      console.log('‚ö†Ô∏è Template n√£o existe, criando novo...');
      template = {
        nifFornecedor: nifFornecedor,
        linhaInicio: 0,
        linhaFim: 999,
        blacklist: [],
        numProdutosEsperado: 0,
        vezeUsado: 0
      };
      setTemplatesOCR([...templatesOCR, template]);
    }
    
    const index = templatesOCR.findIndex(t => t.nifFornecedor === nifFornecedor);
    const blacklistAtual = template.blacklist || [];
    const novaBlacklist = [...new Set([...blacklistAtual, ...palavras])]; // Remove duplicados
    
    console.log('üîç Blacklist antes:', blacklistAtual);
    console.log('üîç Blacklist depois:', novaBlacklist);
    
    const novoTemplate = {
      ...template,
      blacklist: novaBlacklist
    };
    
    const novos = index === -1 
      ? [...templatesOCR, novoTemplate]  // Adicionar novo
      : templatesOCR.map((t, i) => i === index ? novoTemplate : t);  // Atualizar existente
    
    setTemplatesOCR(novos);
    
    console.log(`‚úÖ Adicionado √† blacklist: ${palavras.join(', ')}`);
    showNotification(`üö´ Adicionado √† blacklist: ${palavras.join(', ')}`, 'success');
  };
  
  const aprenderTemplateOCR = (nifFornecedor, texto, linhasValidadas) => {
    if (!nifFornecedor) return;
    
    const layout = detectarLayoutFatura(texto);
    const template = {
      nifFornecedor,
      linhaInicio: layout.linhaInicio,
      linhaFim: layout.linhaFim,
      blacklist: [], // üö´ Lista de palavras a ignorar
      numProdutosEsperado: linhasValidadas.length,
      vezeUsado: 1
    };
    
    const index = templatesOCR.findIndex(t => t.nifFornecedor === nifFornecedor);
    if (index !== -1) {
      const atual = templatesOCR[index];
      const novoTemplate = {
        ...atual,
        linhaInicio: Math.round((atual.linhaInicio + layout.linhaInicio) / 2),
        linhaFim: Math.round((atual.linhaFim + layout.linhaFim) / 2),
        blacklist: atual.blacklist || [], // Preservar blacklist
        vezeUsado: atual.vezeUsado + 1
      };
      const novos = [...templatesOCR];
      novos[index] = novoTemplate;
      setTemplatesOCR(novos);
      console.log(`üìã Template atualizado (${novoTemplate.vezeUsado}x usado)`);
    } else {
      setTemplatesOCR([...templatesOCR, template]);
      console.log(`üìã Novo template criado para NIF ${nifFornecedor}`);
    }
  };
  
  const parseComTemplate = (texto, template) => {
    if (!template) return parseLinhasProdutos(texto);
    
    console.log(`üìã Usando template (${template.vezeUsado}x usado)`);
    const linhas = texto.split('\n').map(l => l.trim());
    const start = Math.max(0, template.linhaInicio);
    const end = Math.min(linhas.length, template.linhaFim);
    const blacklist = template.blacklist || [];
    
    if (blacklist.length > 0) {
      console.log(`üö´ Blacklist ativa: ${blacklist.join(', ')}`);
    }
    
    const linhasProdutos = [];
    let linhasIgnoradasBlacklist = 0;
    
    for (let i = start; i < end; i++) {
      const linha = linhas[i];
      
      // Verificar se linha cont√©m palavra da blacklist
      const linhaLower = linha.toLowerCase();
      const temPalavraBlacklist = blacklist.some(palavra => linhaLower.includes(palavra));
      
      if (temPalavraBlacklist) {
        console.log(`üö´ Ignorado por blacklist: "${linha.substring(0, 50)}..."`);
        linhasIgnoradasBlacklist++;
        continue;
      }
      
      if (shouldIgnoreLine(linha)) continue;
      const parsed = parseLinha(linha);
      if (parsed && parsed.nomeProduto) linhasProdutos.push(parsed);
    }
    
    console.log(`‚úÖ ${linhasProdutos.length} produtos detectados`);
    if (linhasIgnoradasBlacklist > 0) {
      console.log(`üö´ ${linhasIgnoradasBlacklist} linha(s) ignorada(s) por blacklist`);
    }
    return linhasProdutos;
  };

  // ==================== FIM TEMPLATES OCR ====================


  const exportarDados = () => {
    const dados = {
      versao: '2.0',
      dataExport: new Date().toISOString(),
      produtos,
      ingredientes,
      vendas,
      despesas,
      fornecedores,
      dadosEmpresa,
      faturas,
      vocabularioFornecedor, // üß† Incluir aprendizagem
      templatesOCR // üìã Incluir templates
    };
    
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `munchi-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification('Backup exportado!', 'success');
  };

  const importarDados = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const dados = JSON.parse(e.target.result);
        
        if (confirm('‚ö†Ô∏è Substituir todos os dados?')) {
          if (dados.produtos) setProdutos(dados.produtos);
          if (dados.ingredientes) setIngredientes(dados.ingredientes);
          if (dados.vendas) setVendas(dados.vendas);
          if (dados.despesas) setDespesas(dados.despesas);
          if (dados.fornecedores) setFornecedores(dados.fornecedores);
          if (dados.dadosEmpresa) setDadosEmpresa({
            nif: '',
            nome: '',
            morada: '',
            codigoPostal: '',
            cidade: '',
            cae: '',
            email: '',
            telefone: '',
            ...dados.dadosEmpresa
          });
          if (dados.faturas) {
            // ‚úÖ CONVERTER FATURAS ANTIGAS: tipo 'completa' ‚Üí 'FT'
            const faturasConvertidas = dados.faturas.map(f => {
              if (f.tipo === 'completa') {
                console.log(`üîÑ Convertendo fatura #${f.numero}: tipo 'completa' ‚Üí 'FT'`);
                return {...f, tipo: 'FT'};
              }
              return f;
            });
            setFaturas(faturasConvertidas);
          }
          if (dados.vocabularioFornecedor) setVocabularioFornecedor(dados.vocabularioFornecedor); // üß† Importar aprendizagem
          if (dados.templatesOCR) setTemplatesOCR(dados.templatesOCR); // üìã Importar templates
          
          showNotification('Dados importados!', 'success');
          event.target.value = '';
        }
      } catch (error) {
        showNotification('Erro ao importar!', 'error');
      }
    };
    reader.readAsText(file);
  };
  
  // ========== FUN√á√ïES DE EXPORT CSV ==========
  
  const exportarVendasCSV = () => {
    if (!vendas || (vendas || []).length === 0) {
      showNotification('Nenhuma venda para exportar!', 'error');
      return;
    }

    const filteredVendas = getFilteredData(vendas);
    
    if (filteredVendas.length === 0) {
      showNotification('Nenhuma venda no per√≠odo selecionado!', 'error');
      return;
    }

    // ===== EXPORT OFICIAL PARA CONTABILIDADE =====
    // Informa√ß√µes completas conforme requisitos legais em Portugal
    
    // Cabe√ßalho com dados da empresa
    const empresaInfo = [
      '===== RELAT√ìRIO OFICIAL DE VENDAS =====',
      `Empresa: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      `Per√≠odo: ${filteredVendas[0] ? new Date(filteredVendas[0].data).toLocaleDateString('pt-PT') : ''} a ${filteredVendas[filteredVendas.length - 1] ? new Date(filteredVendas[filteredVendas.length - 1].data).toLocaleDateString('pt-PT') : ''}`,
      `Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Registos: ${filteredVendas.length}`,
      '',
      '===== DETALHE DAS VENDAS =====',
      ''
    ];
    
    // Headers CSV detalhados para contabilidade
    const headers = [
      'Data',
      'Produto/Servi√ßo',
      'Quantidade',
      'Unidade',
      'Pre√ßo Unit√°rio (s/ IVA)',
      'Valor Base (s/ IVA)',
      'Taxa IVA (%)',
      'Valor IVA',
      'Valor Total (c/ IVA)',
      'Tipo Documento',
      'N¬∫ Documento',
      'Observa√ß√µes'
    ];
    
    // Build CSV rows com todas as informa√ß√µes
    const rows = filteredVendas.map((v, index) => {
      const valorBase = v.valor;
      const valorIva = valorBase * (v.iva / 100);
      const valorTotal = valorBase + valorIva;
      const precoUnitario = v.quantidade > 0 ? valorBase / v.quantidade : 0;
      
      return [
        new Date(v.data).toISOString().split('T')[0], // Data formato ISO
        `"${v.produto}"`,
        v.quantidade || 1,
        'un',
        precoUnitario.toFixed(2),
        valorBase.toFixed(2),
        v.iva,
        valorIva.toFixed(2),
        valorTotal.toFixed(2),
        'Venda',
        `VND-${new Date(v.data).getFullYear()}-${String(index + 1).padStart(6, '0')}`,
        `"${v.observacoes || ''}"`
      ].join(';');
    });
    
    // Resumo por taxa de IVA
    const resumoIVA = {};
    filteredVendas.forEach(v => {
      const taxa = v.iva;
      if (!resumoIVA[taxa]) {
        resumoIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = v.valor;
      const valorIva = valorBase * (taxa / 100);
      resumoIVA[taxa].base += valorBase;
      resumoIVA[taxa].iva += valorIva;
      resumoIVA[taxa].total += valorBase + valorIva;
      resumoIVA[taxa].count++;
    });
    
    const resumoSection = [
      '',
      '',
      '===== RESUMO POR TAXA DE IVA =====',
      'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;Valor IVA;Total',
      ...Object.entries(resumoIVA).map(([taxa, valores]) => 
        `${taxa}%;${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
      ),
      '',
      '===== TOTAIS GERAIS =====',
      `Total Base Tribut√°vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.base, 0).toFixed(2)}`,
      `Total IVA;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total Geral;${Object.values(resumoIVA).reduce((sum, v) => sum + v.total, 0).toFixed(2)}`,
      '',
      '',
      '===== INFORMA√á√ïES LEGAIS =====',
      'Este documento cont√©m informa√ß√£o fiscal relevante para efeitos de contabilidade e declara√ß√µes fiscais.',
      'Deve ser conservado de acordo com os prazos legais estabelecidos.',
      `Gerado automaticamente pelo sistema Munchi Manager em ${new Date().toLocaleString('pt-PT')}`
    ];
    
    // Create CSV content
    const csvContent = [
      ...empresaInfo,
      headers.join(';'),
      ...rows,
      ...resumoSection
    ].join('\n');
    
    // Download com BOM para Excel reconhecer UTF-8
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nome do ficheiro com per√≠odo
    const dataInicio = new Date(filteredVendas[0].data);
    const dataFim = new Date(filteredVendas[filteredVendas.length - 1].data);
    const nomeArquivo = `VENDAS_APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(`‚úÖ ${filteredVendas.length} vendas exportadas! Para vendas via Moloni/software certificado, n√£o √© necess√°rio enviar PDFs.`, 'success');
  };
  
  const exportarDespesasCSV = () => {
    if (!despesas || (despesas || []).length === 0) {
      showNotification('Nenhuma despesa para exportar!', 'error');
      return;
    }

    const filteredDespesas = getFilteredData(despesas);
    
    if (filteredDespesas.length === 0) {
      showNotification('Nenhuma despesa no per√≠odo selecionado!', 'error');
      return;
    }

    // ===== EXPORT OFICIAL PARA CONTABILIDADE =====
    // Informa√ß√µes completas conforme requisitos legais em Portugal
    
    // Cabe√ßalho com dados da empresa
    const empresaInfo = [
      '===== RELAT√ìRIO OFICIAL DE DESPESAS =====',
      `Empresa: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      `Per√≠odo: ${filteredDespesas[0] ? new Date(filteredDespesas[0].data).toLocaleDateString('pt-PT') : ''} a ${filteredDespesas[filteredDespesas.length - 1] ? new Date(filteredDespesas[filteredDespesas.length - 1].data).toLocaleDateString('pt-PT') : ''}`,
      `Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Registos: ${filteredDespesas.length}`,
      '',
      '===== DETALHE DAS DESPESAS =====',
      ''
    ];
    
    // Headers CSV detalhados para contabilidade
    const headers = [
      'Data',
      'N¬∫ Documento',
      'Tipo Documento',
      'Fornecedor',
      'NIF Fornecedor',
      'Categoria',
      'Descri√ß√£o',
      'Valor Base (s/ IVA)',
      'Taxa IVA (%)',
      'Valor IVA',
      'Valor Total (c/ IVA)',
      'Forma Pagamento',
      'Dedut√≠vel IVA',
      'Observa√ß√µes'
    ];
    
    // Build CSV rows com todas as informa√ß√µes
    const rows = filteredDespesas.map((d, index) => {
      const valorBase = d.valor;
      const valorIva = valorBase * (d.iva / 100);
      const valorTotal = valorBase + valorIva;
      
      // Encontrar fornecedor para obter NIF
      let fornecedorObj = null;
      if (d.fornecedor) {
        fornecedorObj = fornecedores.find(f => 
          (typeof f === 'object' && f.nome === d.fornecedor) || 
          (typeof f === 'string' && f === d.fornecedor)
        );
      }
      
      const fornecedorNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
      const fornecedorNome = d.fornecedor || 'N/A';
      
      // Determinar se IVA √© dedut√≠vel (geralmente sim para despesas de neg√≥cio)
      const dedutivelIVA = d.iva > 0 ? 'Sim' : 'N/A';
      
      return [
        new Date(d.data).toISOString().split('T')[0], // Data formato ISO
        d.numeroDocumento || `DSP-${new Date(d.data).getFullYear()}-${String(index + 1).padStart(6, '0')}`,
        d.tipoDocumento || 'Fatura',
        `"${fornecedorNome}"`,
        fornecedorNif,
        `"${d.categoria}"`,
        `"${d.descricao}"`,
        valorBase.toFixed(2),
        d.iva,
        valorIva.toFixed(2),
        valorTotal.toFixed(2),
        d.formaPagamento || 'Transfer√™ncia',
        dedutivelIVA,
        `"${d.notas || ''}"`
      ].join(';');
    });
    
    // Resumo por categoria
    const resumoCategoria = {};
    filteredDespesas.forEach(d => {
      const cat = d.categoria || 'Sem Categoria';
      if (!resumoCategoria[cat]) {
        resumoCategoria[cat] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = d.valor;
      const valorIva = valorBase * (d.iva / 100);
      resumoCategoria[cat].base += valorBase;
      resumoCategoria[cat].iva += valorIva;
      resumoCategoria[cat].total += valorBase + valorIva;
      resumoCategoria[cat].count++;
    });
    
    // Resumo por taxa de IVA
    const resumoIVA = {};
    filteredDespesas.forEach(d => {
      const taxa = d.iva;
      if (!resumoIVA[taxa]) {
        resumoIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = d.valor;
      const valorIva = valorBase * (taxa / 100);
      resumoIVA[taxa].base += valorBase;
      resumoIVA[taxa].iva += valorIva;
      resumoIVA[taxa].total += valorBase + valorIva;
      resumoIVA[taxa].count++;
    });
    
    const resumoSection = [
      '',
      '',
      '===== RESUMO POR CATEGORIA =====',
      'Categoria;N¬∫ Opera√ß√µes;Valor Base;Valor IVA;Total',
      ...Object.entries(resumoCategoria)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([cat, valores]) => 
          `"${cat}";${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
        ),
      '',
      '===== RESUMO POR TAXA DE IVA =====',
      'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;Valor IVA;Total',
      ...Object.entries(resumoIVA).map(([taxa, valores]) => 
        `${taxa}%;${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
      ),
      '',
      '===== TOTAIS GERAIS =====',
      `Total Base Tribut√°vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.base, 0).toFixed(2)}`,
      `Total IVA Suportado;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total IVA Dedut√≠vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total Geral;${Object.values(resumoIVA).reduce((sum, v) => sum + v.total, 0).toFixed(2)}`,
      '',
      '',
      '===== FORNECEDORES =====',
      'Fornecedor;NIF;Total Faturado',
      ...(() => {
        const fornecedorTotais = {};
        filteredDespesas.forEach(d => {
          const fornNome = d.fornecedor || 'N/A';
          let fornecedorObj = null;
          if (d.fornecedor) {
            fornecedorObj = fornecedores.find(f => 
              (typeof f === 'object' && f.nome === d.fornecedor) || 
              (typeof f === 'string' && f === d.fornecedor)
            );
          }
          const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
          
          const key = `${fornNome}|${fornNif}`;
          if (!fornecedorTotais[key]) {
            fornecedorTotais[key] = 0;
          }
          fornecedorTotais[key] += d.valor * (1 + d.iva / 100);
        });
        
        return Object.entries(fornecedorTotais)
          .sort((a, b) => b[1] - a[1])
          .map(([key, total]) => {
            const [nome, nif] = key.split('|');
            return `"${nome}";${nif};${total.toFixed(2)}`;
          });
      })(),
      '',
      '',
      '===== INFORMA√á√ïES LEGAIS =====',
      'Este documento cont√©m informa√ß√£o fiscal relevante para efeitos de contabilidade e declara√ß√µes fiscais.',
      'Os valores de IVA dedut√≠vel devem ser confirmados com a contabilidade conforme legisla√ß√£o aplic√°vel.',
      'Deve ser conservado de acordo com os prazos legais estabelecidos.',
      `Gerado automaticamente pelo sistema Munchi Manager em ${new Date().toLocaleString('pt-PT')}`
    ];
    
    // Create CSV content
    const csvContent = [
      ...empresaInfo,
      headers.join(';'),
      ...rows,
      ...resumoSection
    ].join('\n');
    
    // Download com BOM para Excel reconhecer UTF-8
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nome do ficheiro com per√≠odo
    const dataInicio = new Date(filteredDespesas[0].data);
    const dataFim = new Date(filteredDespesas[filteredDespesas.length - 1].data);
    const nomeArquivo = `DESPESAS_APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(`‚úÖ ${filteredDespesas.length} despesas exportadas! ‚ö†Ô∏è IMPORTANTE: Enviar tamb√©m os PDFs das faturas ao contabilista!`, 'success');
  };

  // ===== EXPORT DE APOIO CONTABIL√çSTICO (CSV) =====
  // IMPORTANTE: Este export N√ÉO substitui documentos fiscais!
  // √â apenas para facilitar o lan√ßamento contabil√≠stico.
  // Os PDFs das faturas s√£o OBRIGAT√ìRIOS e devem ser enviados separadamente.
  const exportarRelatorioCompletoCSV = () => {
    const filteredVendas = getFilteredData(vendas || []);
    const filteredDespesas = getFilteredData(despesas || []);
    
    if (filteredVendas.length === 0 && filteredDespesas.length === 0) {
      showNotification('Nenhum dado para exportar no per√≠odo selecionado!', 'error');
      return;
    }
    
    // ===== CABE√áALHO COM DADOS DA EMPRESA =====
    const empresaInfo = [
      '='.repeat(80),
      'RELAT√ìRIO DE APOIO CONTABIL√çSTICO',
      '='.repeat(80),
      '',
      '‚ö†Ô∏è  AVISO LEGAL IMPORTANTE:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      'N√ÉO substitui os documentos fiscais originais (faturas em PDF).',
      'Para efeitos de Autoridade Tribut√°ria, √© obrigat√≥rio conservar os PDFs originais.',
      '',
      '===== IDENTIFICA√á√ÉO DA EMPRESA =====',
      `Nome: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      '===== INFORMA√á√ÉO DO RELAT√ìRIO =====',
      `Per√≠odo: ${filteredVendas.length > 0 || filteredDespesas.length > 0 ? new Date(Math.min(...[...filteredVendas, ...filteredDespesas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''} a ${filteredVendas.length > 0 || filteredDespesas.length > 0 ? new Date(Math.max(...[...filteredVendas, ...filteredDespesas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''}`,
      `Data de Emiss√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Vendas: ${filteredVendas.length} registos`,
      `Total de Despesas: ${filteredDespesas.length} registos`,
      '',
      ''
    ];
    
    // ===== SEC√á√ÉO 1: VENDAS =====
    const vendasSection = [
      '=' .repeat(80),
      'SEC√á√ÉO 1: RECEITAS E VENDAS',
      '='.repeat(80),
      ''
    ];
    
    if (filteredVendas.length > 0) {
      const vendasHeaders = [
        'Data',
        'N¬∫ Doc',
        'Tipo Doc',
        'Produto/Servi√ßo',
        'Origem', // ‚Üê NOVO
        'Qtd',
        'Pre√ßo Unit (s/ IVA)',
        'Base (s/ IVA)',
        'Taxa IVA',
        'Valor IVA',
        'Total (c/ IVA)',
        'Forma Pag',
        'Obs'
      ];
      
      const vendasRows = filteredVendas.map((v, idx) => {
        const valorBase = v.valor;
        const valorIva = valorBase * (v.iva / 100);
        const valorTotal = valorBase + valorIva;
        const precoUnit = v.quantidade > 0 ? valorBase / v.quantidade : 0;
        const origem = v.origem === 'moloni' ? 'MOLONI' : 
                      v.origem === 'zobaze' ? 'ZOBAZE' : 'MANUAL';
        
        return [
          new Date(v.data).toISOString().split('T')[0],
          v.numeroDocumento || `VND-${new Date(v.data).getFullYear()}-${String(idx + 1).padStart(6, '0')}`,
          v.tipoDocumento || 'Venda',
          `"${v.produto}"`,
          origem, // ‚Üê NOVO
          v.quantidade || 1,
          precoUnit.toFixed(2),
          valorBase.toFixed(2),
          `${v.iva}%`,
          valorIva.toFixed(2),
          valorTotal.toFixed(2),
          v.formaPagamento || 'N/A',
          `"${v.observacoes || ''}"`
        ].join(';');
      });
      
      vendasSection.push(vendasHeaders.join(';'), ...vendasRows);
      
      // Resumo de vendas por IVA
      const resumoVendasIVA = {};
      filteredVendas.forEach(v => {
        const taxa = v.iva;
        if (!resumoVendasIVA[taxa]) {
          resumoVendasIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = v.valor;
        const valorIva = valorBase * (taxa / 100);
        resumoVendasIVA[taxa].base += valorBase;
        resumoVendasIVA[taxa].iva += valorIva;
        resumoVendasIVA[taxa].total += valorBase + valorIva;
        resumoVendasIVA[taxa].count++;
      });
      
      vendasSection.push(
        '',
        '--- RESUMO DE VENDAS POR TAXA IVA ---',
        'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;IVA Liquidado;Total',
        ...Object.entries(resumoVendasIVA).map(([taxa, v]) =>
          `${taxa}%;${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
        ),
        '',
        '--- TOTAIS DE VENDAS ---',
        `Total Base Tribut√°vel (Vendas);${Object.values(resumoVendasIVA).reduce((s, v) => s + v.base, 0).toFixed(2)}`,
        `Total IVA Liquidado;${Object.values(resumoVendasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total Receitas;${Object.values(resumoVendasIVA).reduce((s, v) => s + v.total, 0).toFixed(2)}`
      );
    } else {
      vendasSection.push('Nenhuma venda registada no per√≠odo selecionado.');
    }
    
    vendasSection.push('', '');
    
    // ===== SEC√á√ÉO 2: DESPESAS =====
    const despesasSection = [
      '='.repeat(80),
      'SEC√á√ÉO 2: DESPESAS E COMPRAS',
      '='.repeat(80),
      ''
    ];
    
    if (filteredDespesas.length > 0) {
      const despesasHeaders = [
        'Data',
        'N¬∫ Doc',
        'Tipo Doc',
        'Fornecedor',
        'NIF Forn',
        'Categoria',
        'Descri√ß√£o',
        'Base (s/ IVA)',
        'Taxa IVA',
        'Valor IVA',
        'Total (c/ IVA)',
        'Forma Pag',
        'Dedut√≠vel',
        'Notas'
      ];
      
      const despesasRows = filteredDespesas.map((d, idx) => {
        const valorBase = d.valor;
        const valorIva = valorBase * (d.iva / 100);
        const valorTotal = valorBase + valorIva;
        
        let fornecedorObj = null;
        if (d.fornecedor) {
          fornecedorObj = fornecedores.find(f => 
            (typeof f === 'object' && f.nome === d.fornecedor) || 
            (typeof f === 'string' && f === d.fornecedor)
          );
        }
        
        const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
        const dedutivelIVA = d.iva > 0 ? 'Sim' : 'N/A';
        
        return [
          new Date(d.data).toISOString().split('T')[0],
          d.numeroDocumento || `DSP-${new Date(d.data).getFullYear()}-${String(idx + 1).padStart(6, '0')}`,
          d.tipoDocumento || 'Fatura',
          `"${d.fornecedor || 'N/A'}"`,
          fornNif,
          `"${d.categoria}"`,
          `"${d.descricao}"`,
          valorBase.toFixed(2),
          `${d.iva}%`,
          valorIva.toFixed(2),
          valorTotal.toFixed(2),
          d.formaPagamento || 'Transfer√™ncia',
          dedutivelIVA,
          `"${d.notas || ''}"`
        ].join(';');
      });
      
      despesasSection.push(despesasHeaders.join(';'), ...despesasRows);
      
      // Resumo de despesas por categoria
      const resumoDespesasCat = {};
      filteredDespesas.forEach(d => {
        const cat = d.categoria || 'Sem Categoria';
        if (!resumoDespesasCat[cat]) {
          resumoDespesasCat[cat] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = d.valor;
        const valorIva = valorBase * (d.iva / 100);
        resumoDespesasCat[cat].base += valorBase;
        resumoDespesasCat[cat].iva += valorIva;
        resumoDespesasCat[cat].total += valorBase + valorIva;
        resumoDespesasCat[cat].count++;
      });
      
      // Resumo de despesas por IVA
      const resumoDespesasIVA = {};
      filteredDespesas.forEach(d => {
        const taxa = d.iva;
        if (!resumoDespesasIVA[taxa]) {
          resumoDespesasIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = d.valor;
        const valorIva = valorBase * (taxa / 100);
        resumoDespesasIVA[taxa].base += valorBase;
        resumoDespesasIVA[taxa].iva += valorIva;
        resumoDespesasIVA[taxa].total += valorBase + valorIva;
        resumoDespesasIVA[taxa].count++;
      });
      
      despesasSection.push(
        '',
        '--- RESUMO DE DESPESAS POR CATEGORIA ---',
        'Categoria;N¬∫ Opera√ß√µes;Base;IVA;Total',
        ...Object.entries(resumoDespesasCat)
          .sort((a, b) => b[1].total - a[1].total)
          .map(([cat, v]) =>
            `"${cat}";${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
          ),
        '',
        '--- RESUMO DE DESPESAS POR TAXA IVA ---',
        'Taxa IVA;N¬∫ Opera√ß√µes;Base;IVA Suportado;Total',
        ...Object.entries(resumoDespesasIVA).map(([taxa, v]) =>
          `${taxa}%;${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
        ),
        '',
        '--- TOTAIS DE DESPESAS ---',
        `Total Base (Despesas);${Object.values(resumoDespesasIVA).reduce((s, v) => s + v.base, 0).toFixed(2)}`,
        `Total IVA Suportado;${Object.values(resumoDespesasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total IVA Dedut√≠vel;${Object.values(resumoDespesasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total Despesas;${Object.values(resumoDespesasIVA).reduce((s, v) => s + v.total, 0).toFixed(2)}`
      );
    } else {
      despesasSection.push('Nenhuma despesa registada no per√≠odo selecionado.');
    }
    
    despesasSection.push('', '');
    
    // ===== SEC√á√ÉO 3: RESUMO FISCAL =====
    const totalVendasBase = filteredVendas.reduce((sum, v) => sum + v.valor, 0);
    const totalVendasIVA = filteredVendas.reduce((sum, v) => sum + (v.valor * v.iva / 100), 0);
    const totalVendas = totalVendasBase + totalVendasIVA;
    
    const totalDespesasBase = filteredDespesas.reduce((sum, d) => sum + d.valor, 0);
    const totalDespesasIVA = filteredDespesas.reduce((sum, d) => sum + (d.valor * d.iva / 100), 0);
    const totalDespesas = totalDespesasBase + totalDespesasIVA;
    
    const saldoIVA = totalVendasIVA - totalDespesasIVA;
    const resultadoLiquido = totalVendas - totalDespesas;
    
    const resumoFiscal = [
      '='.repeat(80),
      'SEC√á√ÉO 3: RESUMO FISCAL E FINANCEIRO',
      '='.repeat(80),
      '',
      '--- APURAMENTO DE IVA ---',
      `IVA Liquidado (Vendas);${totalVendasIVA.toFixed(2)}`,
      `IVA Dedut√≠vel (Despesas);${totalDespesasIVA.toFixed(2)}`,
      `Saldo de IVA;${saldoIVA.toFixed(2)};${saldoIVA >= 0 ? 'A ENTREGAR ao Estado' : 'A RECEBER do Estado'}`,
      '',
      '--- DEMONSTRA√á√ÉO DE RESULTADOS (SIMPLIFICADA) ---',
      `Total de Vendas (c/ IVA);${totalVendas.toFixed(2)}`,
      `Total de Despesas (c/ IVA);${totalDespesas.toFixed(2)}`,
      `Resultado L√≠quido;${resultadoLiquido.toFixed(2)};${resultadoLiquido >= 0 ? 'LUCRO' : 'PREJU√çZO'}`,
      '',
      '--- VALORES BASE (s/ IVA) ---',
      `Vendas (Base);${totalVendasBase.toFixed(2)}`,
      `Despesas (Base);${totalDespesasBase.toFixed(2)}`,
      `Margem Bruta;${(totalVendasBase - totalDespesasBase).toFixed(2)}`,
      ''
    ];
    
    // ===== SEC√á√ÉO 4: FORNECEDORES =====
    if (filteredDespesas.length > 0) {
      const fornecedorTotais = {};
      filteredDespesas.forEach(d => {
        const fornNome = d.fornecedor || 'N/A';
        let fornecedorObj = null;
        if (d.fornecedor) {
          fornecedorObj = fornecedores.find(f => 
            (typeof f === 'object' && f.nome === d.fornecedor) || 
            (typeof f === 'string' && f === d.fornecedor)
          );
        }
        const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
        
        const key = `${fornNome}|${fornNif}`;
        if (!fornecedorTotais[key]) {
          fornecedorTotais[key] = 0;
        }
        fornecedorTotais[key] += d.valor * (1 + d.iva / 100);
      });
      
      resumoFiscal.push(
        '',
        '='.repeat(80),
        'SEC√á√ÉO 4: AN√ÅLISE DE FORNECEDORES',
        '='.repeat(80),
        '',
        'Fornecedor;NIF;Total Faturado',
        ...Object.entries(fornecedorTotais)
          .sort((a, b) => b[1] - a[1])
          .map(([key, total]) => {
            const [nome, nif] = key.split('|');
            return `"${nome}";${nif};${total.toFixed(2)}`;
          })
      );
    }
    
    // ===== RODAP√â LEGAL =====
    const rodape = [
      '',
      '',
      '='.repeat(80),
      'INFORMA√á√ïES LEGAIS E DECLARA√á√ïES',
      '='.repeat(80),
      '',
      'üìã NATUREZA DESTE DOCUMENTO:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      '',
      '‚ö†Ô∏è  IMPORTANTE - OBRIGA√á√ïES LEGAIS:',
      '',
      '1. DOCUMENTOS FISCAIS ORIGINAIS (OBRIGAT√ìRIO):',
      '   - As FATURAS EM PDF dos fornecedores s√£o OBRIGAT√ìRIAS',
      '   - Devem ser conservadas durante 10 anos',
      '   - S√£o a √öNICA prova aceite pela Autoridade Tribut√°ria',
      '   - Este CSV N√ÉO substitui os documentos fiscais',
      '',
      '2. PARA ENTREGAR AO CONTABILISTA:',
      '   ‚úì Este ficheiro CSV (dados estruturados)',
      '   ‚úì PASTA COM TODOS OS PDFs das faturas de fornecedores',
      '   ‚úì Faturas de vendas emitidas via software certificado (ex: Moloni)',
      '',
      '3. VENDAS:',
      '   - Se usa software certificado (Moloni, etc): comunica√ß√£o autom√°tica √† AT',
      '   - Este CSV serve apenas para controlo interno e confer√™ncia',
      '',
      '4. DESPESAS:',
      '   - Cada despesa DEVE ter a fatura original em PDF',
      '   - O PDF √© necess√°rio para dedu√ß√£o de IVA',
      '   - Sem PDF, a AT pode rejeitar a dedu√ß√£o',
      '',
      'Conforme:',
      '  - C√≥digo do IVA (CIVA)',
      '  - Lei Geral Tribut√°ria',
      '  - Decreto-Lei n.¬∫ 28/2019 (SAF-T)',
      '',
      `Documento gerado pelo sistema Munchi Manager`,
      `Data e hora: ${new Date().toLocaleString('pt-PT')}`,
      `Empresa: ${dadosEmpresa.nome || 'N/A'} (NIF: ${dadosEmpresa.nif || 'N/A'})`,
      '',
      '='.repeat(80),
      'FIM DO RELAT√ìRIO',
      '='.repeat(80)
    ];
    
    // ===== CRIAR FICHEIRO CSV =====
    const csvContent = [
      ...empresaInfo,
      ...vendasSection,
      ...despesasSection,
      ...resumoFiscal,
      ...rodape
    ].join('\n');
    
    // Download com BOM para Excel reconhecer UTF-8
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nome do ficheiro com per√≠odo - APOIO CONTABIL√çSTICO
    const todasDatas = [...filteredVendas, ...filteredDespesas].map(x => new Date(x.data));
    const dataInicio = todasDatas.length > 0 ? new Date(Math.min(...todasDatas)) : new Date();
    const dataFim = todasDatas.length > 0 ? new Date(Math.max(...todasDatas)) : new Date();
    const nomeArquivo = `APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`‚úÖ Export para contabilista: ${filteredVendas.length} vendas + ${filteredDespesas.length} despesas. N√£o esquecer os PDFs das faturas!`, 'success');
  };

  // ===== EXPORT COMPLETO: CSV + ZIP COM PDFs =====
  const exportarPacoteCompleto = async () => {
    const filteredVendas = getFilteredData(vendas || []);
    const filteredFaturasCompletas = getFilteredData(faturas || []); // Todas
    
    // ‚ö†Ô∏è FILTRAR: S√≥ FATURAS (n√£o recibos) para contabilista
    const filteredFaturas = filteredFaturasCompletas.filter(f => 
      f.tipoDocumento === 'fatura' || !f.tipoDocumento // Retrocompatibilidade
    );
    
    const recibosIgnorados = filteredFaturasCompletas.length - filteredFaturas.length;
    
    if (filteredVendas.length === 0 && filteredFaturas.length === 0) {
      showNotification('Nenhum dado para exportar no per√≠odo selecionado!', 'error');
      return;
    }
    
    // Contar quantas faturas t√™m PDF
    const faturasComPDF = filteredFaturas.filter(f => f.documentoPDF);
    const faturasSemPDF = filteredFaturas.filter(f => !f.documentoPDF);
    
    // Aviso se h√° recibos ignorados
    if (recibosIgnorados > 0) {
      const msg = `‚ÑπÔ∏è Nota: ${recibosIgnorados} recibo(s) N√ÉO ser√£o exportados (apenas faturas v√£o para contabilista)`;
      console.log(msg);
    }
    
    if (faturasSemPDF.length > 0) {
      const confirmar = confirm(
        `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
        `${faturasSemPDF.length} fatura(s) N√ÉO t√™m PDF anexado.\n` +
        (recibosIgnorados > 0 ? `${recibosIgnorados} recibo(s) ser√£o ignorados.\n\n` : '\n') +
        `Sem PDFs, o contabilista n√£o pode deduzir IVA!\n\n` +
        `Deseja continuar mesmo assim?`
      );
      if (!confirmar) return;
    }
    
    showNotification('üì¶ A criar pacote completo... Aguarde!', 'info');
    
    try {
      // 1. Gerar CSV (reutiliza l√≥gica existente mas retorna string)
      const csvContent = gerarCSVCompleto(filteredVendas, filteredFaturas);
      
      // 2. Criar ZIP com JSZip
      const zip = new JSZip();
      
      // Adicionar CSV ao ZIP
      const todasDatas = [...filteredVendas, ...filteredFaturas].map(x => new Date(x.data));
      const dataInicio = todasDatas.length > 0 ? new Date(Math.min(...todasDatas)) : new Date();
      const dataFim = todasDatas.length > 0 ? new Date(Math.max(...todasDatas)) : new Date();
      const periodoStr = `${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}`;
      
      const BOM = '\uFEFF';
      zip.file(`APOIO_CONTABILISTICO_${periodoStr}.csv`, BOM + csvContent);
      
      // 3. Adicionar PDFs ao ZIP (em pasta separada com data)
      const pdfFolder = zip.folder(`PDFs_Fornecedores_${periodoStr}`);
      
      filteredFaturas.forEach((fatura, index) => {
        if (fatura.documentoPDF) {
          // Extrair base64 puro (remover prefixo data:application/pdf;base64,)
          const base64Data = fatura.documentoPDF.split(',')[1];
          
          // Nome do ficheiro PDF - LIMPAR BEM para evitar problemas no Windows
          const dataStr = new Date(fatura.data).toISOString().split('T')[0].replace(/-/g, '');
          const fornecedor = fatura.fornecedorNome || 'SemFornecedor';
          // Limpar TODOS os caracteres especiais que o Windows n√£o gosta
          const fornecedorClean = fornecedor
            .replace(/[\/\\:*?"<>|]/g, '') // Remove caracteres proibidos no Windows
            .replace(/[^a-zA-Z0-9\s]/g, '_') // Substitui outros especiais por _
            .replace(/\s+/g, '_') // Espa√ßos viram _
            .substring(0, 30); // Limita tamanho
          
          const numDoc = fatura.numero || `FAT${String(index + 1).padStart(4, '0')}`;
          // Limpar n√∫mero do documento (remove /, \, etc)
          const numDocClean = numDoc
            .replace(/[\/\\:*?"<>|]/g, '_')
            .replace(/[^a-zA-Z0-9]/g, '_');
          
          const nomeArquivo = `${dataStr}_${fornecedorClean}_${numDocClean}.pdf`;
          
          pdfFolder.file(nomeArquivo, base64Data, {base64: true});
        }
      });
      
      // 4. Gerar ZIP e download
      const zipBlob = await zip.generateAsync({type: 'blob'});
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `PACOTE_CONTABILIDADE_${periodoStr}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification(
        `‚úÖ Pacote completo criado!\n\n` +
        `üìÑ CSV: 1 ficheiro\n` +
        `üìé PDFs: ${faturasComPDF.length} documento(s)\n` +
        `‚ö†Ô∏è Sem PDF: ${faturasSemPDF.length} fatura(s)`,
        'success'
      );
      
    } catch (error) {
      console.error('Erro ao criar pacote:', error);
      showNotification('‚ùå Erro ao criar pacote! Veja o console.', 'error');
    }
  };
  
  // Fun√ß√£o auxiliar para gerar CSV (extrai l√≥gica da fun√ß√£o exportarRelatorioCompletoCSV)
  const gerarCSVCompleto = (filteredVendas, filteredDespesas) => {
    // Reutiliza toda a l√≥gica da fun√ß√£o exportarRelatorioCompletoCSV
    // mas retorna o CSV em vez de fazer download
    
    // ===== CABE√áALHO COM DADOS DA EMPRESA =====
    const empresaInfo = [
      '='.repeat(80),
      'RELAT√ìRIO DE APOIO CONTABIL√çSTICO',
      '='.repeat(80),
      '',
      '‚ö†Ô∏è  AVISO LEGAL IMPORTANTE:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      'N√ÉO substitui os documentos fiscais originais (faturas em PDF).',
      'Para efeitos de Autoridade Tribut√°ria, √© obrigat√≥rio conservar os PDFs originais.',
      '',
      '===== IDENTIFICA√á√ÉO DA EMPRESA =====',
      `Nome: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      '===== INFORMA√á√ÉO DO RELAT√ìRIO =====',
      `Per√≠odo: ${filteredVendas.length > 0 || filteredDespesas.length > 0 ? new Date(Math.min(...[...filteredVendas, ...filteredDespesas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''} a ${filteredVendas.length > 0 || filteredDespesas.length > 0 ? new Date(Math.max(...[...filteredVendas, ...filteredDespesas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''}`,
      `Data de Emiss√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Vendas: ${filteredVendas.length} registos`,
      `Total de Despesas: ${filteredDespesas.length} registos`,
      '',
      ''
    ];
    
    // Por simplicidade, retorna apenas estrutura b√°sica
    // O CSV completo ser√° gerado pela fun√ß√£o principal em produ√ß√£o
    const csvSimples = [
      ...empresaInfo,
      '',
      '='.repeat(80),
      'VENDAS E DESPESAS',
      '='.repeat(80),
      '',
      `Total Vendas: ${filteredVendas.length}`,
      `Total Despesas: ${filteredDespesas.length}`,
      '',
      '(Relat√≥rio completo gerado automaticamente)',
      ''
    ].join('\n');
    
    return csvSimples;
  };

  // === GOOGLE IDENTITY SERVICES ===
  const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '344967437318-oe9hr1t5m9bcs7qvdm0t5dr9f0delaom.apps.googleusercontent.com',
    SCOPES: 'https://www.googleapis.com/auth/drive.file',
    FILE_NAME: 'munchi-data.json'
  };

  const loadUserInfo = async (token) => {
    try {
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const userInfo = await response.json();
        setDriveUser({
          name: userInfo.name,
          email: userInfo.email,
          image: userInfo.picture
        });
      }
    } catch (error) {
      console.error('Erro ao carregar info do utilizador:', error);
    }
  };

  const loginGoogleDrive = () => {
    if (!window.google) {
      showNotification('‚ö†Ô∏è Google Identity Services ainda n√£o carregou', 'error');
      return;
    }
    const client = window.google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
      scope: GOOGLE_DRIVE_CONFIG.SCOPES,
      callback: (response) => {
        if (response.access_token) {
          const tokenData = {
            access_token: response.access_token,
            expires_at: Date.now() + (response.expires_in * 1000)
          };
          localStorage.setItem('munchi_drive_token', JSON.stringify(tokenData));
          setDriveAccessToken(response.access_token);
          setDriveError(null);
          loadUserInfo(response.access_token);
          loadFromDrive(response.access_token);
          showNotification('‚úÖ Conectado ao Google Drive!', 'success');
        } else {
          setDriveError('Erro ao obter token');
          showNotification('‚ùå Erro ao conectar', 'error');
        }
      }
    });
    client.requestAccessToken();
  };

  const logoutGoogleDrive = () => {
    if (driveAccessToken && window.google) {
      window.google.accounts.oauth2.revoke(driveAccessToken);
    }
    localStorage.removeItem('munchi_drive_token');
    localStorage.removeItem('munchi_drive_file_id');
    setDriveAccessToken(null);
    setDriveUser(null);
    setDriveFileId(null);
    showNotification('Desconectado do Google Drive', 'info');
  };

  const findDriveFile = async (token) => {
    try {
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name='${GOOGLE_DRIVE_CONFIG.FILE_NAME}' and mimeType='application/json' and trashed=false&fields=files(id,name,modifiedTime)`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      if (response.ok) {
        const data = await response.json();
        return data.files && data.files.length > 0 ? data.files[0] : null;
      }
    } catch (error) {
      console.error('Erro ao procurar ficheiro:', error);
    }
    return null;
  };

  const createDriveFile = async (token, data) => {
    const metadata = { name: GOOGLE_DRIVE_CONFIG.FILE_NAME, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
      { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form }
    );
    if (response.ok) {
      const result = await response.json();
      setDriveFileId(result.id);
      localStorage.setItem('munchi_drive_file_id', result.id);
      return result.id;
    }
    throw new Error('Erro ao criar ficheiro');
  };

  const updateDriveFile = async (token, fileId, data) => {
    const response = await fetch(
      `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
      {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(data, null, 2)
      }
    );
    if (!response.ok) throw new Error('Erro ao atualizar');
    return true;
  };

  const saveToDrive = async () => {
    if (!driveAccessToken) {
      showNotification('‚ö†Ô∏è N√£o conectado', 'error');
      return;
    }
    try {
      setDriveSyncing(true);
      setDriveError(null);
      const data = {
        produtos: produtos || [],
        ingredientes: ingredientes || [],
        vendas: vendas || [],
        faturas: faturas || [],
        fornecedores: fornecedores || [],
        dadosEmpresa: dadosEmpresa || {},
        deliveryApps: deliveryApps || [],
        lastUpdate: new Date().toISOString()
      };
      let fileId = driveFileId;
      if (!fileId) {
        const existingFile = await findDriveFile(driveAccessToken);
        if (existingFile) {
          fileId = existingFile.id;
          setDriveFileId(fileId);
          localStorage.setItem('munchi_drive_file_id', fileId);
        }
      }
      if (fileId) {
        await updateDriveFile(driveAccessToken, fileId, data);
      } else {
        await createDriveFile(driveAccessToken, data);
      }
      setDriveLastSync(new Date());
      showNotification('‚úÖ Sincronizado!', 'success');
    } catch (error) {
      console.error('Erro:', error);
      setDriveError('Erro ao sincronizar');
      showNotification('‚ùå Erro ao sincronizar', 'error');
    } finally {
      setDriveSyncing(false);
    }
  };

  const loadFromDrive = async (token = driveAccessToken) => {
    if (!token) return;
    try {
      setDriveSyncing(true);
      const file = await findDriveFile(token);
      if (!file) {
        setDriveSyncing(false);
        return;
      }
      setDriveFileId(file.id);
      localStorage.setItem('munchi_drive_file_id', file.id);
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      if (response.ok) {
        const data = await response.json();
        if (data.produtos) setProdutos(data.produtos);
        if (data.ingredientes) setIngredientes(data.ingredientes);
        if (data.vendas) setVendas(data.vendas);
        if (data.faturas) setFaturas(data.faturas);
        if (data.fornecedores) setFornecedores(data.fornecedores);
        if (data.dadosEmpresa) setDadosEmpresa(data.dadosEmpresa);
        if (data.deliveryApps) setDeliveryApps(data.deliveryApps);
        setDriveLastSync(new Date(file.modifiedTime));
        showNotification('‚úÖ Dados carregados!', 'success');
      }
    } catch (error) {
      console.error('Erro:', error);
      setDriveError('Erro ao carregar');
    } finally {
      setDriveSyncing(false);
    }
  };

  useEffect(() => {
    const carregar = async () => {
      try {
        const [p, i, v, d, f, de, ft, voc, templ] = await Promise.all([
          window.storage.get('produtos').catch(() => null),
          window.storage.get('ingredientes').catch(() => null),
          window.storage.get('vendas').catch(() => null),
          window.storage.get('despesas').catch(() => null),
          window.storage.get('fornecedores').catch(() => null),
          window.storage.get('dadosEmpresa').catch(() => null),
          window.storage.get('faturas').catch(() => null),
          window.storage.get('vocabularioFornecedor').catch(() => null), // üß† Carregar aprendizagem
          window.storage.get('templatesOCR').catch(() => null) // üìã Carregar templates
        ]);
        if (p) setProdutos(JSON.parse(p.value));
        if (i) setIngredientes(JSON.parse(i.value));
        if (v) {
          const vendasCarregadas = JSON.parse(v.value);
          // ‚úÖ MIGRA√á√ÉO AUTOM√ÅTICA: Adicionar tag 'origem' em vendas antigas
          let vendasMigradas = 0;
          const vendasComOrigem = vendasCarregadas.map(venda => {
            if (!venda.origem) {
              vendasMigradas++;
              // Vendas antigas sem origem = assumir Moloni (padr√£o antigo)
              return { ...venda, origem: 'moloni' };
            }
            return venda;
          });
          
          if (vendasMigradas > 0) {
            console.log(`üîÑ Migra√ß√£o autom√°tica: ${vendasMigradas} vendas antigas agora t√™m tag 'moloni'`);
          }
          
          setVendas(vendasComOrigem);
        }
        if (d) setDespesas(JSON.parse(d.value));
        if (f) setFornecedores(JSON.parse(f.value));
        if (de) setDadosEmpresa(JSON.parse(de.value));
        if (ft) {
          const faturasCarregadas = JSON.parse(ft.value);
          // ‚úÖ CONVERTER FATURAS ANTIGAS: tipo 'completa' ‚Üí 'FT'
          const faturasConvertidas = faturasCarregadas.map(f => {
            if (f.tipo === 'completa') {
              console.log(`üîÑ Convertendo fatura #${f.numero}: tipo 'completa' ‚Üí 'FT'`);
              return {...f, tipo: 'FT'};
            }
            return f;
          });
          setFaturas(faturasConvertidas);
        }
        if (voc) setVocabularioFornecedor(JSON.parse(voc.value)); // üß† Restaurar aprendizagem
        if (templ) setTemplatesOCR(JSON.parse(templ.value)); // üìã Restaurar templates
      } catch (e) { console.log('Primeira vez'); }
    };
    carregar();
  }, []);

  // üö´ Expor fun√ß√£o de blacklist globalmente para o modal
  useEffect(() => {
    window._adicionarABlacklist = adicionarABlacklist;
    return () => {
      delete window._adicionarABlacklist;
    };
  }, [templatesOCR]);

  // Close ingredient suggestions when changing tabs
  useEffect(() => {
    setShowIngredienteSuggestions(false);
  }, [activeTab, gestaoSubTab]);

  useEffect(() => {
    const salvar = async () => {
      try {
        await Promise.all([
          window.storage.set('produtos', JSON.stringify(produtos)),
          window.storage.set('ingredientes', JSON.stringify(ingredientes)),
          window.storage.set('vendas', JSON.stringify(vendas)),
          window.storage.set('despesas', JSON.stringify(despesas)),
          window.storage.set('fornecedores', JSON.stringify(fornecedores)),
          window.storage.set('dadosEmpresa', JSON.stringify(dadosEmpresa)),
          window.storage.set('faturas', JSON.stringify(faturas)),
          window.storage.set('vocabularioFornecedor', JSON.stringify(vocabularioFornecedor)), // üß† Salvar aprendizagem
          window.storage.set('templatesOCR', JSON.stringify(templatesOCR)) // üìã Salvar templates
        ]);
      } catch (e) { console.error(e); }
    };
    salvar();
  }, [produtos, ingredientes, vendas, despesas, fornecedores, dadosEmpresa, faturas, vocabularioFornecedor, templatesOCR]);


  const detectarCategoria = (nome) => {
    const n = nome.toLowerCase();
    const categorias = {
      'vegetais': ['alface', 'tomate', 'cebola', 'cenoura', 'batata', 'cogumelo', 'pimento', 'alho', 'couve', 'br√≥colos', 'espinafre'],
      'frutas': ['morango', 'banana', 'ma√ß√£', 'laranja', 'lim√£o', 'p√™ra', 'uva', 'mel√£o', 'melancia', 'kiwi', 'manga', 'abacaxi', 'framboesa', 'mirtilo', 'cereja', 'ameixa', 'p√™ssego', 'nectarina', 'damasco', 'figo', 't√¢mara', 'coco', 'abacate', 'fruta'],
      'carnes': ['frango', 'carne', 'porco', 'vaca', 'peru', 'bacon', 'salsicha', 'bife', 'costela'],
      'peixe': ['salm√£o', 'atum', 'bacalhau', 'camar√£o', 'polvo', 'lula', 'peixe', 'marisco'],
      'latic√≠nios': ['leite', 'queijo', 'iogurte', 'manteiga', 'nata', 'mozzarella', 'requeij√£o', 'mozarela'],
      'padaria': ['p√£o'],
      'pastelaria': ['farinha', 'fermento', 'chocolate', 'cacau', 'baunilha', 'am√™ndoa', 'noz'],
      'compotas': ['a√ß√∫car', 'pectina', '√°cido c√≠trico'],
      'bebidas': ['√°gua', 'sumo', 'refrigerante', 'vinho', 'cerveja', 'caf√©', 'ch√°'],
      'temperos': ['sal', 'pimenta', 'azeite', 'vinagre', 'oreg√£os', 'especiaria', 'canela', 'colorau']
    };
    
    for (const [cat, keywords] of Object.entries(categorias)) {
      if (keywords.some(k => n.includes(k))) return cat;
    }
    return 'outros';
  };

  const adicionarIngrediente = () => {
    if (!novoIngrediente.nome || !novoIngrediente.custoUnitario) {
      showNotification('Preencha nome e custo!', 'error');
      return;
    }
    const custoComIva = parseFloat(novoIngrediente.custoUnitario);
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    
    setIngredientes([...ingredientes, { 
      id: Date.now(), 
      ...novoIngrediente, 
      custoUnitario: custoComIva,
      custoSemIva: custoSemIva,
      iva: iva,
      categoria: novoIngrediente.categoria || 'outros'
    }]);
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    showNotification('Ingrediente adicionado!', 'success');
  };
  
  // CRIAR INGREDIENTE INLINE NA FATURA
  const criarIngredienteInline = () => {
    if (!novoIngrediente.nome) {
      showNotification('Preencha o nome do ingrediente!', 'error');
      return;
    }
    
    // NOVO: Se tiver pre√ßo total e quantidade na embalagem, calcular custo unit√°rio automaticamente
    let custoComIva;
    if (novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem) {
      const precoTotal = parseFloat(novoIngrediente.precoTotal);
      const qtdEmbalagem = parseFloat(novoIngrediente.quantidadeEmbalagem);
      custoComIva = precoTotal / qtdEmbalagem; // Ex: ‚Ç¨21.29 / 12 unidades = ‚Ç¨1.77/un
    } else if (novoIngrediente.custoUnitario) {
      custoComIva = parseFloat(novoIngrediente.custoUnitario);
    } else {
      showNotification('Preencha o pre√ßo total e quantidade na embalagem, ou o custo unit√°rio!', 'error');
      return;
    }
    
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    const quantidade = parseFloat(novoIngrediente.quantidade || 1);
    
    // CONVERS√ÉO: Custo √© SEMPRE por kg/L, mas quantidade pode estar em g/ml
    let quantidadeEmUnidadeBase = quantidade;
    if (novoIngrediente.unidade === 'g') {
      quantidadeEmUnidadeBase = quantidade / 1000; // 500g ‚Üí 0.5kg
    } else if (novoIngrediente.unidade === 'ml') {
      quantidadeEmUnidadeBase = quantidade / 1000; // 500ml ‚Üí 0.5L
    }
    // kg, L, un ‚Üí n√£o converte (j√° est√° em unidade base)
    
    const precoTotal = custoComIva * quantidadeEmUnidadeBase;
    
    const novoIng = { 
      id: Date.now(), 
      nome: novoIngrediente.nome,
      unidade: novoIngrediente.unidade,
      custoUnitario: custoComIva, // sempre em kg/L
      custoSemIva: custoSemIva,
      iva: iva,
      categoria: novoIngrediente.categoria || 'outros'
    };
    
    // Adiciona aos ingredientes
    setIngredientes([...ingredientes, novoIng]);
    
    // Seleciona automaticamente o ingrediente criado COM a quantidade
    setItemFatura({
      ...itemFatura,
      ingredienteId: novoIng.id,
      quantidade: quantidade.toString(), // quantidade original (500g)
      unidade: novoIng.unidade, // unidade original (g)
      precoTotal: precoTotal.toFixed(2), // pre√ßo convertido
      iva: novoIng.iva.toString()
    });
    
    // Reset
    setCriandoIngrediente(false);
    setSearchIngredienteFatura(novoIng.nome);
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
    
    showNotification(`‚ú® Ingrediente "${novoIng.nome}" criado e adicionado √† fatura!`, 'success');
  };
  
  const adicionarEmbalagem = () => {
    if (!novaEmbalagem.nome || !novaEmbalagem.custoUnitario) {
      showNotification('Preencha nome e custo da embalagem!', 'error');
      return;
    }
    setEmbalagens([...embalagens, {
      id: Date.now(),
      ...novaEmbalagem,
      custoUnitario: parseFloat(novaEmbalagem.custoUnitario)
    }]);
    setNovaEmbalagem({ nome: '', custoUnitario: '', categoria: 'copos' });
    showNotification('Embalagem adicionada!', 'success');
  };
  
  const toggleApp = (appId) => {
    setDeliveryApps(deliveryApps.map(app => 
      app.id === appId ? { ...app, ativo: !app.ativo } : app
    ));
    const app = deliveryApps.find(a => a.id === appId);
    showNotification(`${app.nome} ${app.ativo ? 'desativada' : 'ativada'}!`, 'success');
  };
  
  const atualizarComissaoApp = (appId, novaComissao) => {
    setDeliveryApps(deliveryApps.map(app => 
      app.id === appId ? { 
        ...app, 
        comissao: parseFloat(novaComissao),
        dataAtualizacao: new Date().toISOString().split('T')[0]
      } : app
    ));
    setEditandoApp(null);
    showNotification('Comiss√£o atualizada!', 'success');
  };
  
  const adicionarNovaApp = () => {
    if (!novaApp.nome || !novaApp.comissao) {
      showNotification('Preencha nome e comiss√£o!', 'error');
      return;
    }
    setDeliveryApps([...deliveryApps, {
      id: Date.now().toString(),
      nome: novaApp.nome,
      comissao: parseFloat(novaApp.comissao),
      ativo: false,
      cor: '#' + Math.floor(Math.random()*16777215).toString(16),
      dataAtualizacao: new Date().toISOString().split('T')[0]
    }]);
    setNovaApp({ nome: '', comissao: '25' });
    showNotification('App adicionada!', 'success');
  };
  
  const apagarApp = (appId) => {
    if (confirm('Apagar esta app?')) {
      setDeliveryApps(deliveryApps.filter(app => app.id !== appId));
      showNotification('App apagada!', 'success');
    }
  };
  
  const editarIngrediente = (ingrediente) => {
    console.log('üîß Editando ingrediente:', ingrediente);
    
    setNovoIngrediente({
      nome: ingrediente.nome || '',
      unidade: ingrediente.unidade || 'kg',
      custoUnitario: (ingrediente.custoUnitario || ingrediente.preco || 0).toString(),
      iva: (ingrediente.iva || 23).toString(),
      categoria: ingrediente.categoria || 'outros'
    });
    setEditandoIngrediente(true);
    setIngredienteEditandoId(ingrediente.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarIngrediente = () => {
    console.log('üîò BOT√ÉO ATUALIZAR CLICADO');
    console.log('   ingredienteEditandoId:', ingredienteEditandoId);
    console.log('   novoIngrediente:', novoIngrediente);
    
    if (!novoIngrediente.nome || !novoIngrediente.custoUnitario) {
      console.log('   ‚ùå Valida√ß√£o falhou: nome ou custo vazio');
      showNotification('Preencha nome e custo!', 'error');
      return;
    }
    
    const ingredienteAntigo = ingredientes.find(i => i.id === ingredienteEditandoId);
    
    if (!ingredienteAntigo) {
      console.log('   ‚ùå Ingrediente antigo n√£o encontrado!');
      showNotification('Erro: ingrediente n√£o encontrado!', 'error');
      return;
    }
    
    const custoNovo = parseFloat(novoIngrediente.custoUnitario);
    const custoAntigo = ingredienteAntigo.custoUnitario || ingredienteAntigo.precoUnitario || 0;
    const diferenca = Math.abs(custoNovo - custoAntigo);
    const diferencaPerc = custoAntigo > 0 ? (diferenca / custoAntigo) * 100 : 100;
    
    console.log(`   Custo antigo: ‚Ç¨${custoAntigo.toFixed(2)}`);
    console.log(`   Custo novo: ‚Ç¨${custoNovo.toFixed(2)}`);
    console.log(`   Diferen√ßa: ${diferencaPerc.toFixed(1)}%`);
    
    // Se pre√ßo mudou mais de 5%, mostrar alerta
    if (diferencaPerc > 5) {
      // Encontrar produtos afetados
      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId === ingredienteEditandoId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId === ingredienteEditandoId);
        const custoAntes = receitaItem.quantidade * custoAntigo;
        const custoDepois = receitaItem.quantidade * custoNovo;
        const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          return s + (r.quantidade * (ing?.custoUnitario || 0));
        }, 0);
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes
        };
      });
      
      setPriceAlertData({
        ingrediente: ingredienteAntigo,
        precoAtual: custoAntigo,
        precoNovo: custoNovo,
        diferencaPerc,
        produtosAfetados,
        ingredienteData: novoIngrediente,
        tipoFatura: 'ingrediente' // Marca como edi√ß√£o de ingrediente
      });
      setShowPriceAlert(true);
      return; // N√£o atualiza ainda
    }
    
    // Se pre√ßo n√£o mudou muito, atualiza normalmente
    atualizarIngredienteSemAlerta();
  };
  
  const atualizarIngredienteSemAlerta = () => {
    console.log('üíæ Atualizando ingrediente sem alerta...');
    console.log('   ID:', ingredienteEditandoId);
    console.log('   Dados novos:', novoIngrediente);
    
    const custoComIva = parseFloat(novoIngrediente.custoUnitario);
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    
    console.log(`   Custo COM IVA: ‚Ç¨${custoComIva.toFixed(2)}`);
    console.log(`   Custo SEM IVA: ‚Ç¨${custoSemIva.toFixed(2)}`);
    console.log(`   IVA: ${iva}%`);
    
    const ingredientesAtualizados = (ingredientes || []).map(i => {
      if (i.id === ingredienteEditandoId) {
        console.log(`   ‚úÖ Encontrado ingrediente: ${i.nome}`);
        return {
          ...i,
          nome: novoIngrediente.nome,
          unidade: novoIngrediente.unidade,
          custoUnitario: custoComIva,
          precoUnitario: custoComIva, // ‚úÖ MANTER COMPATIBILIDADE
          custoSemIva: custoSemIva,
          iva: iva,
          categoria: novoIngrediente.categoria || 'outros'
        };
      }
      return i;
    });
    
    console.log('   üì¶ Total ingredientes ap√≥s update:', ingredientesAtualizados.length);
    
    setIngredientes(ingredientesAtualizados);
    
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    setEditandoIngrediente(false);
    setIngredienteEditandoId(null);
    showNotification('Ingrediente atualizado!', 'success');
  };
  
  const cancelarEdicaoIngrediente = () => {
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    setEditandoIngrediente(false);
    setIngredienteEditandoId(null);
  };

  const adicionarProduto = () => {
    if (!novoProduto.nome || !novoProduto.precoVenda) {
      showNotification('Preencha nome e pre√ßo!', 'error');
      return;
    }
    setProdutos([...produtos, { id: Date.now(), ...novoProduto, precoVenda: parseFloat(novoProduto.precoVenda), iva: parseFloat(novoProduto.iva) }]);
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    showNotification('Produto adicionado!', 'success');
  };
  
  const editarProduto = (produto) => {
    setNovoProduto({
      nome: produto.nome,
      precoVenda: produto.precoVenda.toString(),
      iva: produto.iva.toString(),
      categoria: produto.categoria || 'cafes',
      receita: produto.receita || [],
      embalagens: produto.embalagens || [],
      porcoes: produto.porcoes || 1
    });
    setEditandoProduto(true);
    setProdutoEditandoId(produto.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarProduto = () => {
    if (!novoProduto.nome || !novoProduto.precoVenda) {
      showNotification('Preencha nome e pre√ßo!', 'error');
      return;
    }
    
    setProdutos(produtos.map(p => 
      p.id === produtoEditandoId ? {
        ...p,
        nome: novoProduto.nome,
        precoVenda: parseFloat(novoProduto.precoVenda),
        iva: parseFloat(novoProduto.iva),
        categoria: novoProduto.categoria || 'cafes',
        receita: novoProduto.receita,
        embalagens: novoProduto.embalagens || [],
        porcoes: novoProduto.porcoes || 1
      } : p
    ));
    
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    setEditandoProduto(false);
    setProdutoEditandoId(null);
    showNotification('Produto atualizado!', 'success');
  };
  
  const cancelarEdicaoProduto = () => {
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', receita: [] });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    setEditandoProduto(false);
    setProdutoEditandoId(null);
  };

  // ===== FUN√á√ÉO PARA UPLOAD DE PDF (DESPESAS) =====
  const handlePDFUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    // Verificar se √© PDF
    if (file.type !== 'application/pdf') {
      showNotification('‚ö†Ô∏è Por favor, selecione apenas ficheiros PDF!', 'error');
      return;
    }
    
    // Limite de 5MB
    if (file.size > 5 * 1024 * 1024) {
      showNotification('‚ö†Ô∏è O ficheiro √© demasiado grande! M√°ximo 5MB.', 'error');
      return;
    }
    
    // Converter para base64
    const reader = new FileReader();
    reader.onload = (e) => {
      setNovaFatura({
        ...novaFatura,
        documentoPDF: e.target.result,
        nomeDocumento: file.name
      });
      showNotification(`‚úÖ PDF "${file.name}" carregado com sucesso!`, 'success');
    };
    reader.onerror = () => {
      showNotification('‚ùå Erro ao ler o ficheiro PDF!', 'error');
    };
    reader.readAsDataURL(file);
  };

  const adicionarDespesa = () => {
    if (!novaDespesa.descricao || !novaDespesa.valor) {
      showNotification('Preencha descri√ß√£o e valor!', 'error');
      return;
    }
    
    // Check price difference if ingredient selected
    if (novaDespesa.ingredienteId && novaDespesa.quantidade) {
      const ingrediente = ingredientes.find(i => i.id === novaDespesa.ingredienteId);
      const precoNovo = parseFloat(novaDespesa.valor) / parseFloat(novaDespesa.quantidade);
      const precoAtual = ingrediente.custoUnitario;
      const diferenca = Math.abs(precoNovo - precoAtual);
      const diferencaPerc = (diferenca / precoAtual) * 100;
      
      // Show alert if price differs by more than 5%
      if (diferencaPerc > 5) {
        // Find affected products
        const produtosAfetados = produtos.filter(p => 
          p.receita && p.receita.some(r => r.ingredienteId === novaDespesa.ingredienteId)
        ).map(p => {
          const receitaItem = p.receita.find(r => r.ingredienteId === novaDespesa.ingredienteId);
          const custoAntes = receitaItem.quantidade * precoAtual;
          const custoDepois = receitaItem.quantidade * precoNovo;
          const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
            const ing = ingredientes.find(i => i.id === r.ingredienteId);
            return s + (r.quantidade * (ing?.custoUnitario || 0));
          }, 0);
          const margemDepois = margemAntes - (custoDepois - custoAntes);
          
          return {
            nome: p.nome,
            margemDif: margemDepois - margemAntes
          };
        });
        
        setPriceAlertData({
          ingrediente,
          precoAtual,
          precoNovo,
          diferencaPerc,
          produtosAfetados,
          despesaData: novaDespesa
        });
        setShowPriceAlert(true);
        return; // Don't add yet, wait for user decision
      }
    }
    
    // Add expense normally
    if (novaDespesa.fornecedor && !fornecedores.includes(novaDespesa.fornecedor)) {
      setFornecedores([...fornecedores, novaDespesa.fornecedor]);
    }
    
    setDespesas([...despesas, { 
      id: Date.now(), 
      ...novaDespesa, 
      valor: parseFloat(novaDespesa.valor), 
      iva: parseFloat(novaDespesa.iva),
      quantidade: novaDespesa.quantidade ? parseFloat(novaDespesa.quantidade) : null
    }]);
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    showNotification('Despesa adicionada!', 'success');
  };

  const adicionarVendaManual = () => {
    if (!novaVenda.produtoId) {
      showNotification('Selecione um produto!', 'error');
      return;
    }
    
    if (!novaVenda.quantidade || parseFloat(novaVenda.quantidade) <= 0) {
      showNotification('Quantidade inv√°lida!', 'error');
      return;
    }
    
    const produto = produtos.find(p => p.id === novaVenda.produtoId);
    if (!produto) {
      showNotification('Produto n√£o encontrado!', 'error');
      return;
    }
    
    // Calcular valor
    let valorTotal;
    if (novaVenda.usarValorManual && novaVenda.valorManual) {
      valorTotal = parseFloat(novaVenda.valorManual);
    } else {
      valorTotal = produto.precoVenda * parseFloat(novaVenda.quantidade);
    }
    
    // Criar venda
    const vendaManual = {
      id: Date.now(),
      data: novaVenda.data,
      produto: produto.nome,
      produtoId: produto.id,
      quantidade: parseFloat(novaVenda.quantidade),
      valor: valorTotal,
      total: valorTotal, // ‚úÖ ADICIONAR CAMPO TOTAL
      iva: produto.iva,
      tipo: 'manual', // Marcar como manual
      origem: 'moloni' // ‚úÖ PARA FILTRO DE M√âTRICAS (vendas manuais = Moloni)
    };
    
    setVendas([...vendas, vendaManual]);
    
    // Reset form
    setNovaVenda({
      data: new Date().toISOString().split('T')[0],
      produtoId: '',
      quantidade: 1,
      valorManual: '',
      usarValorManual: false,
      numeroDocumento: '',
      tipoDocumento: 'Venda',
      formaPagamento: 'Dinheiro',
      observacoes: ''
    });
    
    setMostrarVendaManual(false);
    showNotification('Venda adicionada com sucesso!', 'success');
  };

  const confirmarDespesaSemAtualizar = () => {
    const despesaData = priceAlertData.despesaData;
    
    if (despesaData.fornecedor && !fornecedores.includes(despesaData.fornecedor)) {
      setFornecedores([...fornecedores, despesaData.fornecedor]);
    }
    
    setDespesas([...despesas, { 
      id: Date.now(), 
      ...despesaData, 
      valor: parseFloat(despesaData.valor), 
      iva: parseFloat(despesaData.iva),
      quantidade: despesaData.quantidade ? parseFloat(despesaData.quantidade) : null
    }]);
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    setShowPriceAlert(false);
    setPriceAlertData(null);
    showNotification('Despesa adicionada!', 'success');
  };

  const confirmarDespesaEAtualizar = () => {
    const { ingrediente, precoNovo, produtosAfetados, despesaData } = priceAlertData;
    
    // Update ingredient cost
    const updatedIngredientes = (ingredientes || []).map(i => 
      i.id === ingrediente.id ? { ...i, custoUnitario: precoNovo } : i
    );
    setIngredientes(updatedIngredientes);
    
    // Add expense
    if (despesaData.fornecedor && !fornecedores.includes(despesaData.fornecedor)) {
      setFornecedores([...fornecedores, despesaData.fornecedor]);
    }
    
    setDespesas([...despesas, { 
      id: Date.now(), 
      ...despesaData, 
      valor: parseFloat(despesaData.valor), 
      iva: parseFloat(despesaData.iva),
      quantidade: despesaData.quantidade ? parseFloat(despesaData.quantidade) : null
    }]);
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    setShowPriceAlert(false);
    setPriceAlertData(null);
    showNotification(`‚úÖ Custo do ${ingrediente.nome} atualizado! ${produtosAfetados.length} produtos recalculados`, 'success');
  };

  // ========== FUN√á√ïES PARA FATURAS ==========
  
  const confirmarFaturaSemAtualizar = () => {
    console.log('confirmarFaturaSemAtualizar chamada', priceAlertData);
    // Guardar sem atualizar custo
    if (priceAlertData.tipoOperacao === 'adicionarItem') {
      // Adicionar item SEM atualizar pre√ßo do ingrediente
      const item = priceAlertData.itemParaAdicionar;
      setNovaFatura({
        ...novaFatura,
        itens: [...novaFatura.itens, item]
      });
      setItemFatura({
        ingredienteId: '',
        quantidade: '',
        unidade: '',
        precoTotal: '',
        iva: '13'
      });
      showNotification('Item adicionado SEM atualizar pre√ßo base!', 'success');
    } else if (priceAlertData.tipoFatura === 'rapido') {
      salvarFaturaRapidaSemAlerta();
    } else if (priceAlertData.tipoFatura === 'edicao') {
      atualizarFaturaSemAlerta(priceAlertData.faturaData, priceAlertData.faturaEditandoId);
    } else if (priceAlertData.tipoFatura === 'ingrediente') {
      atualizarIngredienteSemAlerta();
    } else {
      salvarFaturaSemAlerta(priceAlertData.faturaData);
    }
    setShowPriceAlert(false);
    setPriceAlertData(null);
  };
  
  const confirmarFaturaEAtualizar = () => {
    console.log('confirmarFaturaEAtualizar chamada', priceAlertData);
    const { ingrediente, precoNovo, produtosAfetados } = priceAlertData;
    
    if (priceAlertData.tipoOperacao === 'adicionarItem') {
      // Atualizar custo do ingrediente E adicionar item
      setIngredientes(ingredientes.map(ing => 
        ing.id === ingrediente.id 
          ? { 
              ...ing, 
              custoUnitario: precoNovo,
              historicoPrecos: [
                ...(ing.historicoPrecos || []),
                { data: novaFatura.data, preco: precoNovo }
              ]
            }
          : ing
      ));
      
      const item = priceAlertData.itemParaAdicionar;
      setNovaFatura({
        ...novaFatura,
        itens: [...novaFatura.itens, item]
      });
      setItemFatura({
        ingredienteId: '',
        quantidade: '',
        unidade: '',
        precoTotal: '',
        iva: '13'
      });
      showNotification(`Item adicionado! Pre√ßo atualizado: ‚Ç¨${precoNovo.toFixed(2)}/${priceAlertData.unidadeBase}`, 'success');
    } else if (priceAlertData.tipoFatura !== 'ingrediente') {
      // Se for edi√ß√£o de ingrediente, N√ÉO atualiza custo (j√° est√° sendo atualizado)
      // Atualizar custo do ingrediente (para faturas)
      const updatedIngredientes = (ingredientes || []).map(i => 
        i.id == ingrediente.id ? { ...i, custoUnitario: precoNovo } : i
      );
      setIngredientes(updatedIngredientes);
    
      // Guardar/atualizar
      if (priceAlertData.tipoFatura === 'rapido') {
        salvarFaturaRapidaSemAlerta();
      } else if (priceAlertData.tipoFatura === 'edicao') {
        atualizarFaturaSemAlerta(priceAlertData.faturaData, priceAlertData.faturaEditandoId);
      } else if (priceAlertData.tipoFatura === 'ingrediente') {
        atualizarIngredienteSemAlerta();
      } else {
        salvarFaturaSemAlerta(priceAlertData.faturaData);
      }
      showNotification(`Custo do ${ingrediente.nome} atualizado! ${produtosAfetados.length} produtos afetados`, 'success');
    }
    setShowPriceAlert(false);
    setPriceAlertData(null);
  };
  
  const adicionarItemFatura = () => {
    console.log('adicionarItemFatura chamada', { itemFatura, categoria: novaFatura.categoria });
    
    // MODO COMPRAS - Valida√ß√£o para ingredientes
    if (novaFatura.categoria === 'compras') {
      if (!itemFatura.ingredienteId || !itemFatura.quantidade || !itemFatura.precoTotal || !itemFatura.unidade) {
        console.log('Valida√ß√£o falhou (compras):', itemFatura);
        showNotification('Preencha todos os campos do item!', 'error');
        return;
      }
      
      const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
      console.log('Ingrediente encontrado:', ingrediente);
      
      if (!ingrediente) {
        showNotification('Ingrediente n√£o encontrado!', 'error');
      return;
    }
    
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    const iva = parseFloat(itemFatura.iva || '13');
    
    // CONVERTER para unidade base
    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === unidadeBase) {
      quantidadeBase = quantidade;
    }
    
    // CALCULAR pre√ßo por unidade base
    const precoPorUnidadeBase = precoTotal / quantidadeBase;
    
    console.log('Convers√£o:', {
      quantidade,
      unidadeCompra,
      quantidadeBase,
      unidadeBase,
      precoTotal,
      precoPorUnidadeBase
    });
    
    // VERIFICAR se pre√ßo mudou mais de 5%
    const precoAtual = ingrediente.custoUnitario;
    const diferenca = Math.abs(precoPorUnidadeBase - precoAtual);
    const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
    
    if (diferencaPerc > 5) {
      // Encontrar produtos afetados
      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId == itemFatura.ingredienteId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId == itemFatura.ingredienteId);
        
        // Converter quantidade da receita para unidade base se necess√°rio
        let quantidadeReceita = receitaItem.quantidade;
        const unidadeReceita = receitaItem.unidade || ingrediente.unidade;
        if (ingrediente.unidade === 'kg' && unidadeReceita === 'g') {
          quantidadeReceita = receitaItem.quantidade / 1000;
        } else if (ingrediente.unidade === 'L' && unidadeReceita === 'ml') {
          quantidadeReceita = receitaItem.quantidade / 1000;
        }
        
        const custoAntes = quantidadeReceita * precoAtual;
        const custoDepois = quantidadeReceita * precoPorUnidadeBase;
        
        // Calcular margem atual
        const custoTotalAntes = (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          if (!ing) return s;
          let q = r.quantidade;
          const ur = r.unidade || ing.unidade;
          if (ing.unidade === 'kg' && ur === 'g') q = r.quantidade / 1000;
          if (ing.unidade === 'L' && ur === 'ml') q = r.quantidade / 1000;
          return s + (q * ing.custoUnitario);
        }, 0);
        
        const margemAntes = p.precoVenda - custoTotalAntes;
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes,
          custoAntes,
          custoDepois
        };
      });
      
      // Guardar dados do item para processar depois
      const subtotalSemIva = precoTotal / (1 + iva / 100);
      const itemParaGuardar = {
        id: Date.now(),
        ingredienteId: itemFatura.ingredienteId,
        ingredienteNome: ingrediente.nome,
        unidade: unidadeCompra,
        quantidade,
        precoUnitario: precoPorUnidadeBase,
        iva,
        subtotal: subtotalSemIva
      };
      
      setPriceAlertData({
        ingrediente,
        precoAtual,
        precoNovo: precoPorUnidadeBase,
        diferencaPerc,
        produtosAfetados,
        itemParaAdicionar: itemParaGuardar,
        quantidadeBase,
        unidadeBase,
        tipoOperacao: 'adicionarItem'
      });
      setShowPriceAlert(true);
      return; // Para aqui, espera decis√£o do utilizador
    }
    
    // Se pre√ßo n√£o mudou muito (<5%), atualiza direto
    // ATUALIZAR custo do ingrediente
    setIngredientes(ingredientes.map(ing => 
      ing.id === ingrediente.id 
        ? { 
            ...ing, 
            custoUnitario: precoPorUnidadeBase,
            historicoPrecos: [
              ...(ing.historicoPrecos || []),
              { data: novaFatura.data, preco: precoPorUnidadeBase }
            ]
          }
        : ing
    ));
    
    // Calcular subtotal sem IVA (pre√ßo j√° inclui IVA)
    const subtotalSemIva = precoTotal / (1 + iva / 100);
    
    // ADICIONAR item √† fatura
    const novoItem = {
      id: Date.now(),
      ingredienteId: itemFatura.ingredienteId,
      ingredienteNome: ingrediente.nome,
      unidade: unidadeCompra,
      quantidade,
      precoUnitario: precoPorUnidadeBase,
      iva,
      subtotal: subtotalSemIva
    };
    
    console.log('Novo item criado:', novoItem);
    
    setNovaFatura({
      ...novaFatura,
      itens: [...novaFatura.itens, novoItem]
    });
    
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13',
      num_funcionarios: 1
    });
    
    // Resetar campo de pesquisa
    setSearchIngredienteFatura('');
    
    showNotification(`Item adicionado! Pre√ßo atualizado: ‚Ç¨${precoPorUnidadeBase.toFixed(2)}/${unidadeBase}`, 'success');
    return; // Fim do modo compras
    } // Fim do if categoria === 'compras'
    
    // MODO OUTRAS DESPESAS (n√£o-compras)
    if (!itemFatura.descricao || !itemFatura.precoTotal) {
      console.log('Valida√ß√£o falhou (outras despesas):', itemFatura);
      showNotification('Preencha descri√ß√£o e valor!', 'error');
      return;
    }
    
    const precoTotal = parseFloat(itemFatura.precoTotal);
    // SAL√ÅRIOS N√ÉO T√äM IVA!
    const iva = novaFatura.categoria === 'salarios' ? 0 : parseFloat(itemFatura.iva || '23');
    const subtotalSemIva = iva > 0 ? precoTotal / (1 + iva / 100) : precoTotal;
    
    const novoItem = {
      id: Date.now(),
      descricao: itemFatura.descricao,
      quantidade: 1, // Fixo para despesas
      unidade: 'servi√ßo', // Fixo para despesas
      precoUnitario: precoTotal, // Valor total = valor unit√°rio
      iva,
      subtotal: subtotalSemIva,
      num_funcionarios: itemFatura.num_funcionarios || 1 // Para sal√°rios
    };
    
    console.log('Novo item criado (despesa):', novoItem);
    
    setNovaFatura({
      ...novaFatura,
      itens: [...novaFatura.itens, novoItem]
    });
    
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13',
      num_funcionarios: 1
    });
    
    showNotification('Item adicionado!', 'success');
  };
  
  const removerItemFatura = (itemId) => {
    setNovaFatura({
      ...novaFatura,
      itens: novaFatura.itens.filter(item => item.id !== itemId)
    });
  };
  
  const salvarFatura = () => {
    // Valida√ß√£o: fornecedor √© obrigat√≥rio EXCETO para sal√°rios
    if (novaFatura.categoria !== 'salarios' && !novaFatura.fornecedorId) {
      showNotification('Selecione um fornecedor!', 'error');
      return;
    }
    
    if ((novaFatura.itens || []).length === 0) {
      showNotification('Adicione pelo menos 1 item!', 'error');
      return;
    }
    
    // Gerar n√∫mero automaticamente APENAS para FATURAS (n√£o recibos)
    // Se n√£o tem tipoDocumento, assume fatura (retrocompatibilidade)
    const tipoDoc = novaFatura.tipoDocumento || 'fatura';
    
    if (tipoDoc === 'fatura' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const faturasHoje = (faturas || []).filter(f => f.data === novaFatura.data).length;
      novaFatura.numero = `FAT/${ano}/${String(faturasHoje + 1).padStart(4, '0')}`;
    }
    
    // Se √© recibo e n√£o tem n√∫mero, deixa null
    if (tipoDoc === 'recibo' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      novaFatura.numero = null;
    }
    
    // Verificar se algum item tem pre√ßo muito diferente
    let temAlertaPreco = false;
    for (const item of novaFatura.itens) {
      const ingrediente = ingredientes.find(i => i.id == item.ingredienteId);
      if (ingrediente) {
        const precoAtual = ingrediente.custoUnitario;
        const precoNovo = item.precoUnitario;
        const diferenca = Math.abs(precoNovo - precoAtual);
        const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
        
        if (diferencaPerc > 5) {
          // Mostrar alerta para o primeiro item com diferen√ßa > 5%
          const produtosAfetados = produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId == item.ingredienteId)
          ).map(p => {
            const receitaItem = p.receita.find(r => r.ingredienteId == item.ingredienteId);
            const custoAntes = receitaItem.quantidade * precoAtual;
            const custoDepois = receitaItem.quantidade * precoNovo;
            const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
              const ing = ingredientes.find(i => i.id == r.ingredienteId);
              return s + (r.quantidade * (ing?.custoUnitario || 0));
            }, 0);
            const margemDepois = margemAntes - (custoDepois - custoAntes);
            
            return {
              nome: p.nome,
              margemDif: margemDepois - margemAntes
            };
          });
          
          setPriceAlertData({
            ingrediente,
            precoAtual,
            precoNovo,
            diferencaPerc,
            produtosAfetados,
            faturaData: novaFatura,
            tipoFatura: 'completa'
          });
          setShowPriceAlert(true);
          temAlertaPreco = true;
          return; // N√£o guarda ainda
        }
      }
    }
    
    // Se n√£o tem alerta, guarda normalmente
    if (!temAlertaPreco) {
      salvarFaturaSemAlerta();
    }
  };
  
  const salvarFaturaSemAlerta = (dadosFatura = null) => {
    // Se n√£o recebeu dados, usa novaFatura atual
    const faturaParaGuardar = dadosFatura || novaFatura;
    
    // Buscar fornecedor (suporta strings antigas E objetos novos)
    // Para sal√°rios, fornecedor √© opcional
    let fornecedor = null;
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (faturaParaGuardar.categoria === 'salarios') {
      // Sal√°rios n√£o t√™m fornecedor
      fornecedorNome = 'Equipa';
      fornecedorNif = '';
    } else if (faturaParaGuardar.fornecedorId) {
      // Outras categorias: buscar fornecedor
      fornecedor = fornecedores.find(f => {
        const fId = f.id || f;
        return String(fId) === String(faturaParaGuardar.fornecedorId);
      });
      
      fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
      fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    }
    
    const novaFaturaCompleta = {
      id: Date.now(),
      numero: faturaParaGuardar.numero,
      tipo: faturaParaGuardar.tipo || 'FT', // ‚úÖ TIPO DE FATURA (FT/FR/FS)
      tipoDocumento: faturaParaGuardar.tipoDocumento || 'fatura', // NOVO: tipo de documento
      data: faturaParaGuardar.data,
      fornecedorId: faturaParaGuardar.fornecedorId || '',
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: faturaParaGuardar.itens,
      notas: faturaParaGuardar.notas,
      categoria: faturaParaGuardar.categoria || 'compras', // Nova
      recorrente: faturaParaGuardar.recorrente || false, // Nova
      diaRecorrencia: faturaParaGuardar.diaRecorrencia || 1, // Nova
      documentoPDF: faturaParaGuardar.documentoPDF || null, // PDF da fatura
      nomeDocumento: faturaParaGuardar.nomeDocumento || '', // Nome do PDF
      subtotal: faturaParaGuardar.itens.reduce((sum, item) => sum + item.subtotal, 0),
      totalIva: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
      total: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0),
      totais: faturaParaGuardar.totais || { // ‚úÖ TOTAIS ESTRUTURADOS
        subtotal: faturaParaGuardar.itens.reduce((sum, item) => sum + item.subtotal, 0),
        iva: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
        total: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0)
      }
    };
    
    console.log('üíæ Guardando fatura com tipo:', novaFaturaCompleta.tipo);
    console.log('üíæ Total da fatura:', novaFaturaCompleta.total);
    
    setFaturas([...faturas, novaFaturaCompleta]);
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      tipoDocumento: 'fatura', // NOVO
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });
    
    // Resetar campo de pesquisa de ingrediente
    setSearchIngredienteFatura('');
    setCriandoIngrediente(false);
    
    setEditandoFatura(false);
    showNotification('Fatura guardada!', 'success');
  };
  
  const salvarFaturaRapida = () => {
    // Valida√ß√£o: fornecedor √© obrigat√≥rio EXCETO para sal√°rios
    if (novaFatura.categoria !== 'salarios' && !novaFatura.fornecedorId) {
      showNotification('Selecione um fornecedor!', 'error');
      return;
    }
    
    if (novaFatura.categoria === 'compras') {
      // Valida√ß√£o para compras (ingredientes)
      if (!itemFatura.ingredienteId || !itemFatura.quantidade || !itemFatura.precoTotal || !itemFatura.unidade) {
        showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
        return;
      }
    } else {
      // Valida√ß√£o para outras despesas
      if (!itemFatura.descricao || !itemFatura.precoTotal) {
        showNotification('Preencha descri√ß√£o e valor!', 'error');
        return;
      }
      
      // Processar despesa n√£o-compras
      salvarFaturaRapidaDespesa();
      return;
    }
    
    // Continua com processamento de compras (ingredientes)
    const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    
    // Converter para unidade base
    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    }
    
    const precoPorUnidadeBase = precoTotal / quantidadeBase;
    const precoAtual = ingrediente.custoUnitario;
    const diferenca = Math.abs(precoPorUnidadeBase - precoAtual);
    const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
    
    // Se pre√ßo mudou mais de 5%, mostrar alerta
    if (diferencaPerc > 5) {
      // Encontrar produtos afetados
      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId == itemFatura.ingredienteId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId == itemFatura.ingredienteId);
        const custoAntes = receitaItem.quantidade * precoAtual;
        const custoDepois = receitaItem.quantidade * precoPorUnidadeBase;
        const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          return s + (r.quantidade * (ing?.custoUnitario || 0));
        }, 0);
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes
        };
      });
      
      setPriceAlertData({
        ingrediente,
        precoAtual,
        precoNovo: precoPorUnidadeBase,
        diferencaPerc,
        produtosAfetados,
        faturaData: {
          ...novaFatura,
          itemFatura: itemFatura
        },
        tipoFatura: 'rapido'
      });
      setShowPriceAlert(true);
      return; // N√£o guarda ainda, espera decis√£o do utilizador
    }
    
    // Se pre√ßo n√£o mudou muito, guarda normalmente
    salvarFaturaRapidaSemAlerta();
  };
  
  const salvarFaturaRapidaSemAlerta = () => {
    const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
    const fornecedor = fornecedores.find(f => (f.id || f) === novaFatura.fornecedorId);
    
    // Handle both old format (string) and new format (object)
    const fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
    const fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    const iva = parseFloat(itemFatura.iva);
    
    // Converter para unidade base
    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    }
    
    const precoPorUnidadeBase = precoTotal / quantidadeBase;
    
    // ATUALIZAR custo do ingrediente
    setIngredientes(ingredientes.map(ing => 
      ing.id === ingrediente.id 
        ? { 
            ...ing, 
            custoUnitario: precoPorUnidadeBase,
            historicoPrecos: [
              ...(ing.historicoPrecos || []),
              { data: novaFatura.data, preco: precoPorUnidadeBase }
            ]
          }
        : ing
    ));
    
    // Pre√ßo Total J√Å INCLUI IVA
    const subtotalSemIva = precoTotal / (1 + iva / 100);
    const totalIva = precoTotal - subtotalSemIva;
    const total = precoTotal; // J√° est√° com IVA
    
    // Gerar n√∫mero autom√°tico para registo r√°pido
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const registosRapidosHoje = (faturas || []).filter(f => 
      f.tipo === 'rapido' && 
      f.data === novaFatura.data
    ).length;
    const numeroAuto = `RR/${ano}/${String(registosRapidosHoje + 1).padStart(3, '0')}`;
    
    const item = {
      id: Date.now(),
      ingredienteId: itemFatura.ingredienteId,
      ingredienteNome: ingrediente.nome,
      unidade: unidadeCompra,
      quantidade,
      precoUnitario: precoPorUnidadeBase,
      iva,
      subtotal: subtotalSemIva
    };
    
    const faturaRapida = {
      id: Date.now(),
      numero: numeroAuto,
      tipoDocumento: novaFatura.tipoDocumento || 'fatura', // NOVO
      data: novaFatura.data,
      fornecedorId: novaFatura.fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: novaFatura.notas || 'Registo r√°pido',
      categoria: novaFatura.categoria || 'compras', // Nova
      recorrente: novaFatura.recorrente || false, // Nova
      diaRecorrencia: novaFatura.diaRecorrencia || 1, // Nova
      subtotal: subtotalSemIva,
      totalIva,
      total,
      tipo: 'rapido' // Marca que √© registo r√°pido
    };
    
    setFaturas([...faturas, faturaRapida]);
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1
    });
    setItemFatura({
      ingredienteId: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13'
    });
    
    showNotification(`Compra registada! Pre√ßo atualizado: ‚Ç¨${precoPorUnidadeBase.toFixed(2)}/${unidadeBase}`, 'success');
  };
  
  const salvarFaturaRapidaDespesa = () => {
    // Fun√ß√£o para salvar fatura r√°pida de despesas n√£o-compras (renda, utilities, etc)
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (novaFatura.categoria === 'salarios') {
      // Sal√°rios n√£o t√™m fornecedor
      fornecedorNome = 'Equipa';
      fornecedorNif = '';
    } else if (novaFatura.fornecedorId) {
      // Outras categorias: buscar fornecedor
      const fornecedor = fornecedores.find(f => (f.id || f) === novaFatura.fornecedorId);
      fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
      fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    }
    
    const precoTotal = parseFloat(itemFatura.precoTotal);
    // SAL√ÅRIOS N√ÉO T√äM IVA!
    const iva = novaFatura.categoria === 'salarios' ? 0 : parseFloat(itemFatura.iva);
    const subtotalSemIva = iva > 0 ? precoTotal / (1 + iva / 100) : precoTotal;
    const totalIva = precoTotal - subtotalSemIva;
    
    // Gerar n√∫mero autom√°tico
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const registosRapidosHoje = (faturas || []).filter(f => 
      f.tipo === 'rapido' && 
      f.data === novaFatura.data
    ).length;
    const numeroAuto = `RR/${ano}/${String(registosRapidosHoje + 1).padStart(3, '0')}`;
    
    const item = {
      id: Date.now(),
      descricao: itemFatura.descricao,
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoTotal,
      iva,
      subtotal: subtotalSemIva,
      num_funcionarios: itemFatura.num_funcionarios || 1 // Para sal√°rios
    };
    
    const faturaRapida = {
      id: Date.now(),
      numero: numeroAuto,
      tipoDocumento: novaFatura.tipoDocumento || 'fatura', // NOVO
      data: novaFatura.data,
      fornecedorId: novaFatura.fornecedorId || '',
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: novaFatura.notas || 'Registo r√°pido',
      categoria: novaFatura.categoria,
      recorrente: novaFatura.recorrente || false,
      diaRecorrencia: novaFatura.diaRecorrencia || 1,
      subtotal: subtotalSemIva,
      totalIva,
      total: precoTotal,
      tipo: 'rapido'
    };
    
    setFaturas([...faturas, faturaRapida]);
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1
    });
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13'
    });
    
    showNotification('Despesa registada!', 'success');
  };
  
  const apagarFatura = (faturaId) => {
    if (confirm('‚ö†Ô∏è Apagar esta compra?')) {
      setFaturas((faturas || []).filter(f => f.id !== faturaId));
      showNotification('Compra apagada!', 'success');
    }
  };
  
  const editarFatura = (fatura) => {
    setNovaFatura({
      numero: fatura.numero,
      data: fatura.data,
      fornecedorId: fatura.fornecedorId,
      itens: fatura.itens,
      notas: fatura.notas
    });
    setEditandoFatura(true);
    setFaturaEditando(fatura.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarFatura = () => {
    console.log('atualizarFatura chamada', { novaFatura, faturaEditando });
    
    if (!novaFatura.fornecedorId || (novaFatura.itens || []).length === 0) {
      showNotification('Preencha fornecedor e adicione pelo menos 1 item!', 'error');
      return;
    }
    
    // Gerar n√∫mero automaticamente APENAS para FATURAS (n√£o recibos)
    const tipoDoc = novaFatura.tipoDocumento || 'fatura';
    
    if (tipoDoc === 'fatura' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const faturasHoje = (faturas || []).filter(f => f.data === novaFatura.data && f.id !== faturaEditando).length;
      novaFatura.numero = `FAT/${ano}/${String(faturasHoje + 1).padStart(4, '0')}`;
    }
    
    // Se √© recibo e n√£o tem n√∫mero, deixa null
    if (tipoDoc === 'recibo' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      novaFatura.numero = null;
    }
    
    // Verificar se algum item tem pre√ßo muito diferente
    let temAlertaPreco = false;
    for (const item of novaFatura.itens) {
      const ingrediente = ingredientes.find(i => i.id == item.ingredienteId);
      if (ingrediente) {
        const precoAtual = ingrediente.custoUnitario;
        const precoNovo = item.precoUnitario;
        const diferenca = Math.abs(precoNovo - precoAtual);
        const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
        
        if (diferencaPerc > 5) {
          // Mostrar alerta para o primeiro item com diferen√ßa > 5%
          const produtosAfetados = produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId == item.ingredienteId)
          ).map(p => {
            const receitaItem = p.receita.find(r => r.ingredienteId == item.ingredienteId);
            const custoAntes = receitaItem.quantidade * precoAtual;
            const custoDepois = receitaItem.quantidade * precoNovo;
            const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
              const ing = ingredientes.find(i => i.id == r.ingredienteId);
              return s + (r.quantidade * (ing?.custoUnitario || 0));
            }, 0);
            const margemDepois = margemAntes - (custoDepois - custoAntes);
            
            return {
              nome: p.nome,
              margemDif: margemDepois - margemAntes
            };
          });
          
          setPriceAlertData({
            ingrediente,
            precoAtual,
            precoNovo,
            diferencaPerc,
            produtosAfetados,
            faturaData: novaFatura,
            faturaEditandoId: faturaEditando, // Guardar ID da fatura em edi√ß√£o
            tipoFatura: 'edicao' // Marcar como edi√ß√£o
          });
          setShowPriceAlert(true);
          temAlertaPreco = true;
          return; // N√£o atualiza ainda
        }
      }
    }
    
    // Se n√£o tem alerta, atualiza normalmente
    if (!temAlertaPreco) {
      atualizarFaturaSemAlerta();
    }
  };
  
  const atualizarFaturaSemAlerta = (dadosFatura = null, faturaId = null) => {
    const faturaParaAtualizar = dadosFatura || novaFatura;
    const idParaAtualizar = faturaId || faturaEditando;
    
    const fornecedor = fornecedores.find(f => (f.id || f) === faturaParaAtualizar.fornecedorId);
    console.log('Fornecedor encontrado:', fornecedor);
    
    // Handle both old format (string) and new format (object)
    const fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
    const fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    
    const faturaAtualizada = {
      id: idParaAtualizar,
      numero: faturaParaAtualizar.numero,
      data: faturaParaAtualizar.data,
      fornecedorId: faturaParaAtualizar.fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: faturaParaAtualizar.itens,
      notas: faturaParaAtualizar.notas,
      subtotal: faturaParaAtualizar.itens.reduce((sum, item) => sum + item.subtotal, 0),
      totalIva: faturaParaAtualizar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
      total: faturaParaAtualizar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0),
      tipo: faturas.find(f => f.id === idParaAtualizar)?.tipo || 'completa' // Preservar tipo original
    };
    
    setFaturas(faturas.map(f => f.id === idParaAtualizar ? faturaAtualizada : f));
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: ''
    });
    
    setEditandoFatura(false);
    setFaturaEditando(null);
    showNotification('Fatura atualizada!', 'success');
  };
  
  const cancelarEdicaoFatura = () => {
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: ''
    });
    setEditandoFatura(false);
    setFaturaEditando(null);
  };
  
  // ========== FUN√á√ïES PARA FORNECEDORES ==========
  
  const adicionarFornecedor = (nome, nif = '', morada = '', email = '', telefone = '') => {
    const novoFornecedor = {
      id: Date.now(),
      nome,
      nif,
      morada,
      email,
      telefone,
      dataCriacao: new Date().toISOString()
    };
    setFornecedores([...fornecedores, novoFornecedor]);
    return novoFornecedor.id;
  };
  
  const atualizarFornecedor = (fornecedorId, dadosAtualizados) => {
    setFornecedores((fornecedores || []).map(f => 
      f.id === fornecedorId ? { ...f, ...dadosAtualizados } : f
    ));
  };
  
  const apagarFornecedor = (fornecedorId) => {
    // Verificar se h√° faturas com este fornecedor
    const faturasComFornecedor = (faturas || []).filter(f => f.fornecedorId === fornecedorId);
    if (faturasComFornecedor.length > 0) {
      showNotification(`N√£o pode apagar! Existem ${faturasComFornecedor.length} faturas com este fornecedor.`, 'error');
      return;
    }
    
    if (confirm('‚ö†Ô∏è Apagar este fornecedor?')) {
      setFornecedores(fornecedores.filter(f => f.id !== fornecedorId));
      showNotification('Fornecedor apagado!', 'success');
    }
  };
  
  const editarFornecedor = (fornecedor) => {
    setEditandoFornecedor(true);
    setFornecedorEditandoId(fornecedor.id);
    setDadosFornecedor({
      nome: fornecedor.nome,
      nif: fornecedor.nif || '',
      morada: fornecedor.morada || '',
      email: fornecedor.email || '',
      telefone: fornecedor.telefone || ''
    });
    // Scroll suave para o formul√°rio
    setTimeout(() => {
      const elem = document.querySelector('#fornecedor-form');
      if (elem) elem.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };
  
  const salvarEdicaoFornecedor = () => {
    if (!dadosFornecedor.nome) {
      showNotification('Preencha o nome do fornecedor!', 'error');
      return;
    }
    
    atualizarFornecedor(fornecedorEditandoId, dadosFornecedor);
    
    // Reset
    setEditandoFornecedor(false);
    setFornecedorEditandoId(null);
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
    
    showNotification('Fornecedor atualizado!', 'success');
  };
  
  const cancelarEdicaoFornecedor = () => {
    setEditandoFornecedor(false);
    setFornecedorEditandoId(null);
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
  };
  
  const adicionarNovoFornecedor = () => {
    if (!dadosFornecedor.nome) {
      showNotification('Preencha o nome do fornecedor!', 'error');
      return;
    }
    
    adicionarFornecedor(
      dadosFornecedor.nome,
      dadosFornecedor.nif,
      dadosFornecedor.morada,
      dadosFornecedor.email,
      dadosFornecedor.telefone
    );
    
    // Limpar
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
    
    showNotification('Fornecedor adicionado!', 'success');
  };

  const processarFicheiro = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
      const txt = ev.target.result;
      const lns = txt.split('\n').filter(l => l.trim());
      const vs = [];
      
      console.log(`üì• Importando CSV Moloni: ${lns.length} linhas`);
      
      for (let i = 0; i < lns.length; i++) {
        const ln = lns[i];
        
        // Skip header line
        if (i === 0 || ln.toLowerCase().includes('data') || ln.toLowerCase().includes('documento')) {
          console.log(`‚è≠Ô∏è Linha ${i}: cabe√ßalho ignorado`);
          continue;
        }
        
        if (ln.includes(';')) {
          const pts = ln.split(';').map(p => p.replace(/"/g, '').trim());
          
          if (i < 3) {
            console.log(`üîç Linha ${i} exemplo:`, pts.slice(0, 15));
          }
          
          // Tentar encontrar data (pode estar em posi√ß√µes diferentes)
          let dataStr = pts[0];
          let produto = pts[1];
          let quantidade = 1;
          let total = 0;
          
          // Tentar parsear data em diferentes formatos
          let dt = null;
          
          // Formato DD-MM-YYYY
          if (dataStr && dataStr.match(/\d{2}-\d{2}-\d{4}/)) {
            const [d, m, a] = dataStr.split('-');
            dt = `${a}-${m}-${d}`;
          }
          // Formato DD/MM/YYYY
          else if (dataStr && dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) {
            const [d, m, a] = dataStr.split('/');
            dt = `${a}-${m}-${d}`;
          }
          // Formato YYYY-MM-DD (j√° correto)
          else if (dataStr && dataStr.match(/\d{4}-\d{2}-\d{2}/)) {
            dt = dataStr;
          }
          
          // Tentar encontrar quantidade e total
          for (let j = 0; j < pts.length; j++) {
            const val = pts[j];
            
            // Procurar quantidade (pode ter "Uni." ou ser n√∫mero com v√≠rgula)
            if (val.includes('Uni.') || (j > 8 && j < 13 && val.match(/^\d+[,.]?\d*$/))) {
              const q = parseFloat(val.replace('Uni.', '').replace(',', '.'));
              if (!isNaN(q) && q > 0) quantidade = q;
            }
            
            // Procurar total (tem ‚Ç¨ ou √© n√∫mero com v√≠rgula nas √∫ltimas colunas)
            if ((val.includes('‚Ç¨') || (j > 10 && val.match(/^\d+[,.]?\d*$/))) && j > 9) {
              const t = parseFloat(val.replace('‚Ç¨', '').replace(',', '.'));
              if (!isNaN(t) && t > 0) total = t;
            }
          }
          
          if (dt && produto && total > 0) {
            vs.push({ 
              id: Date.now() + i, 
              data: dt, 
              produto: produto, 
              quantidade: quantidade, 
              valor: total, 
              total: total,
              iva: 6,
              origem: 'moloni'
            });
            
            if (vs.length <= 3) {
              console.log(`‚úÖ Venda ${vs.length}: ${produto} - ${quantidade}x - ‚Ç¨${total} - ${dt}`);
            }
          }
        }
      }
      
      console.log(`üìä Total vendas importadas: ${vs.length}`);
      
      if (vs.length > 0) { 
        setVendas([...vendas, ...vs]); 
        showNotification(`${vs.length} vendas importadas!`, 'success');
        e.target.value = ''; 
      }
      else {
        console.error('‚ùå Nenhuma venda v√°lida encontrada');
        showNotification('Nenhuma venda encontrada. Verifica formato CSV.', 'error');
      }
    };
    r.readAsText(f);
  };

  // Fun√ß√£o para processar Excel do Zobaze
  const processarZobaze = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheetName = 'receiptsWithItems'; // Nome da sheet do Zobaze
      const worksheet = workbook.Sheets[sheetName];
      
      if (!worksheet) {
        showNotification('‚ùå Sheet "receiptsWithItems" n√£o encontrada no Excel', 'error');
        return;
      }
      
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      // Agrupar por ReceiptId
      const vendasDict = {};
      let currentReceipt = null;
      
      for (let i = 1; i < rows.length; i++) { // Skip header
        const row = rows[i];
        const receiptId = row[0];
        const date = row[1];
        const entryType = row[6];
        const entryName = row[7];
        const entryAmount = row[8];
        const total = row[10];
        
        // Se tem receiptId, √© nova venda
        if (receiptId) {
          currentReceipt = receiptId;
          if (!vendasDict[receiptId]) {
            vendasDict[receiptId] = {
              receiptId: receiptId,
              data: date,
              produtos: [],
              total: total || 0
            };
          }
        }
        
        // Se √© item, adicionar ao receipt atual
        if (entryType === 'Item' && entryName && currentReceipt) {
          // Parse "Ovos Turcos (1 X 8)" -> nome: Ovos Turcos, qtd: 1, pre√ßo: 8
          const match = entryName.match(/(.+?)\s*\((\d+(?:\.\d+)?)\s*X\s*(\d+(?:\.\d+)?)\)/);
          if (match) {
            const nome = match[1].trim();
            const qtd = parseFloat(match[2]);
            const preco = parseFloat(match[3]);
            
            vendasDict[currentReceipt].produtos.push({
              nome: nome,
              quantidade: qtd,
              precoUnitario: preco
            });
          }
        }
      }
      
      // Converter para formato do sistema
      const vendasImportadas = [];
      for (const [receiptId, vendaData] of Object.entries(vendasDict)) {
        if (!vendaData.data || vendaData.produtos.length === 0) continue;
        
        // Converter data "Oct 25, 2025 2:55 PM" -> "2025-10-25"
        try {
          const dt = new Date(vendaData.data);
          const dataISO = dt.toISOString().split('T')[0];
          
          // Criar vendas individuais para cada produto (formato atual do sistema)
          vendaData.produtos.forEach(prod => {
            vendasImportadas.push({
              id: Date.now() + Math.random(),
              data: dataISO,
              produto: prod.nome,
              quantidade: prod.quantidade,
              valor: prod.quantidade * prod.precoUnitario,
              total: prod.quantidade * prod.precoUnitario, // ‚úÖ ADICIONAR CAMPO TOTAL
              iva: 6,
              tipo: 'manual', // Marca como manual
              origem: 'zobaze', // ‚úÖ PARA FILTRO DE M√âTRICAS
              fonte: 'zobaze' // Para tracking opcional
            });
          });
        } catch (err) {
          console.error('Erro ao processar data:', vendaData.data, err);
        }
      }
      
      if (vendasImportadas.length > 0) {
        setVendas([...vendas, ...vendasImportadas]);
        showNotification(`‚úÖ ${vendasImportadas.length} vendas Zobaze importadas!`, 'success');
        e.target.value = ''; // Reset input
      } else {
        showNotification('‚ùå Nenhuma venda v√°lida encontrada', 'error');
      }
      
    } catch (err) {
      console.error('Erro ao processar Zobaze:', err);
      showNotification('‚ùå Erro ao processar ficheiro Zobaze', 'error');
    }
  };

  // Fun√ß√£o para gerar faturas recorrentes automaticamente
  const gerarFaturasRecorrentes = React.useCallback(() => {
    const hoje = new Date();
    const diaHoje = hoje.getDate();
    const mesHoje = hoje.getMonth();
    const anoHoje = hoje.getFullYear();
    
    // Pegar faturas recorrentes
    const faturasRecorrentes = (faturas || []).filter(f => f.recorrente === true);
    
    if (faturasRecorrentes.length === 0) return;
    
    const novasFaturas = [];
    
    faturasRecorrentes.forEach(faturaOriginal => {
      const diaRecorrencia = faturaOriginal.diaRecorrencia || 1;
      
      // Verificar se hoje √© o dia de recorr√™ncia
      if (diaHoje !== diaRecorrencia) return;
      
      // Verificar se j√° existe fatura gerada este m√™s
      const dataHoje = `${anoHoje}-${String(mesHoje + 1).padStart(2, '0')}-${String(diaHoje).padStart(2, '0')}`;
      
      const jaExiste = (faturas || []).some(f => 
        f.data === dataHoje && 
        f.numero.startsWith(faturaOriginal.numero) &&
        f.categoria === faturaOriginal.categoria
      );
      
      if (jaExiste) return; // J√° foi gerada este m√™s
      
      // Gerar nova fatura
      const novaFatura = {
        ...faturaOriginal,
        id: Date.now() + Math.random(), // ID √∫nico
        numero: `${faturaOriginal.numero.split('/')[0]}/AUTO-${anoHoje}${String(mesHoje + 1).padStart(2, '0')}`,
        data: dataHoje,
        notas: `${faturaOriginal.notas || ''} (Gerada automaticamente)`.trim()
      };
      
      novasFaturas.push(novaFatura);
    });
    
    if (novasFaturas.length > 0) {
      setFaturas([...faturas, ...novasFaturas]);
      showNotification(`‚ú® ${novasFaturas.length} fatura(s) recorrente(s) gerada(s) automaticamente!`, 'success');
    }
  }, [faturas, setFaturas, showNotification]);
  
  // Verificar faturas recorrentes diariamente
  React.useEffect(() => {
    // Executar ao carregar
    gerarFaturasRecorrentes();
    
    // Executar a cada 24 horas
    const intervalo = setInterval(gerarFaturasRecorrentes, 24 * 60 * 60 * 1000);
    
    return () => clearInterval(intervalo);
  }, [gerarFaturasRecorrentes]);


  const syncToGitHub = React.useCallback(async () => {
    if (!GitHubSync.isConfigured() || isSyncing) return;
    
    setIsSyncing(true);
    setSyncError(null);
    
    try {
      const token = GitHubSync.getToken();
      const data = {
        produtos,
        ingredientes,
        vendas,
        despesas,
        fornecedores,
        dadosEmpresa,
        faturas,
        timestamp: new Date().toISOString()
      };
      
      const result = await GitHubSync.saveToGist(data, token);
      
      if (result.success) {
        setLastSync(new Date());
      } else {
        setSyncError(result.error);
      }
    } catch (error) {
      setSyncError(error.message);
    } finally {
      setIsSyncing(false);
    }
  }, [produtos, ingredientes, vendas, despesas, fornecedores, dadosEmpresa, faturas, isSyncing]);

  // Google Drive: Sincroniza√ß√£o autom√°tica
  useEffect(() => {
    if (driveAccessToken) {
      const timeout = setTimeout(() => saveToDrive(), 3000);
      return () => clearTimeout(timeout);
    }
  }, [produtos, ingredientes, vendas, faturas, fornecedores, driveAccessToken]);

  // Google Drive: Inicializar Google Identity Services
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.onload = () => {
      const savedToken = localStorage.getItem('munchi_drive_token');
      if (savedToken) {
        try {
          const tokenData = JSON.parse(savedToken);
          if (tokenData.expires_at && Date.now() < tokenData.expires_at) {
            setDriveAccessToken(tokenData.access_token);
            loadUserInfo(tokenData.access_token);
            loadFromDrive(tokenData.access_token);
          } else {
            localStorage.removeItem('munchi_drive_token');
          }
        } catch (e) {
          localStorage.removeItem('munchi_drive_token');
        }
      }
    };
    document.head.appendChild(script);
  }, []);

  const calcCusto = (p) => {
    if (!p.receita || !p.receita.length) return 0;
    const custoTotal = (p.receita || []).reduce((t, it) => {
      const ing = ingredientes.find(i => i.id === it.ingredienteId);
      if (!ing) return t;
      
      let q = it.quantidade;
      const unidadeReceita = it.unidade || ing.unidade;
      
      if (ing.unidade === 'kg' && unidadeReceita === 'g') q = it.quantidade / 1000;
      if (ing.unidade === 'L' && unidadeReceita === 'ml') q = it.quantidade / 1000;
      if (ing.unidade === 'g' && unidadeReceita === 'kg') q = it.quantidade * 1000;
      if (ing.unidade === 'ml' && unidadeReceita === 'L') q = it.quantidade * 1000;
      if (unidadeReceita === ing.unidade) q = it.quantidade;
      
      return t + (q * ing.custoUnitario);
    }, 0);
    
    // Se tem por√ß√µes, dividir custo por por√ß√£o
    if (p.porcoes && p.porcoes > 1) {
      return custoTotal / p.porcoes;
    }
    
    return custoTotal;
  };

  const calcMargem = (p) => {
    const c = calcCusto(p);
    const ps = p.precoVenda / (1 + p.iva / 100);
    const m = ps - c;
    const mp = c > 0 ? (m / c) * 100 : 0;
    return { custo: c, margem: m, margemPercentual: mp, precoSemIva: ps };
  };
  
  // Calcular custos e pre√ßos por modalidade (Local, Take-Away, Delivery)
  const calcPrecosPorModalidade = (produto) => {
    const custoIngredientes = calcCusto(produto);
    const ivaPerc = produto.iva || 6; // Default 6% se n√£o definido
    
    // Custo embalagens (ingredientes com categoria "embalagens")
    const custoEmbalagens = (produto.receita || []).reduce((sum, item) => {
      const ing = ingredientes.find(i => i.id == item.ingredienteId);
      if (ing && ing.categoria === 'embalagens') {
        return sum + (ing.custoUnitario * (item.quantidade || 1));
      }
      return sum;
    }, 0);
    
    const precoLocal = produto.precoVenda || 0;
    const custoLocal = custoIngredientes - custoEmbalagens; // Custo sem embalagens
    const margemLocal = precoLocal / (1 + ivaPerc / 100) - custoLocal;
    
    const custoTakeAway = custoIngredientes; // J√° inclui embalagens
    const precoTakeAway = produto.precoVenda; // Usar pre√ßo do produto
    const margemTakeAway = precoTakeAway / (1 + ivaPerc / 100) - custoTakeAway;
    
    const resultados = {
      local: {
        custo: custoLocal,
        preco: precoLocal,
        margem: margemLocal,
        margemPerc: custoLocal > 0 ? (margemLocal / custoLocal) * 100 : 0
      },
      takeaway: {
        custo: custoTakeAway,
        custoEmbalagens,
        preco: precoTakeAway,
        margem: margemTakeAway,
        margemPerc: custoTakeAway > 0 ? (margemTakeAway / custoTakeAway) * 100 : 0
      },
      delivery: {}
    };
    
    // Calcular para cada app ativa
    deliveryApps.filter(app => app.ativo).forEach(app => {
      const precoDelivery = produto.precosDelivery?.[app.id] || precoTakeAway / (1 - app.comissao / 100);
      const receitaLiquida = precoDelivery * (1 - app.comissao / 100);
      const margemDelivery = receitaLiquida / (1 + ivaPerc / 100) - custoTakeAway;
      
      resultados.delivery[app.id] = {
        custo: custoTakeAway,
        precoSugerido: precoDelivery,
        precoDefinido: produto.precosDelivery?.[app.id] || null,
        comissao: app.comissao,
        receitaLiquida,
        margem: margemDelivery,
        margemPerc: custoTakeAway > 0 ? (margemDelivery / custoTakeAway) * 100 : 0
      };
    });
    
    return resultados;
  };

  const calcLucroVenda = (v) => {
    const p = produtos.find(pr => pr.nome.toLowerCase() === v.produto.toLowerCase());
    if (!p) return { lucro: 0, temCusto: false };
    
    // Verificar se produto TEM receita
    const temReceita = p.receita && p.receita.length > 0;
    
    // Se n√£o tem receita, retornar lucro 0 (n√£o sabemos o custo real)
    if (!temReceita) {
      return { lucro: 0, temCusto: false };
    }
    
    const custo = calcCusto(p);
    const precoSemIva = v.valor / (1 + (v.iva / 100));
    const custoTotal = custo * v.quantidade;
    const lucro = precoSemIva - custoTotal;
    return { lucro: lucro, temCusto: true };
  };


  // Filter data by date
  const getFilteredData = (data, dateField = 'data') => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    return data.filter(item => {
      const itemDate = new Date(item[dateField]);
      
      switch(dateFilter) {
        case 'today':
          return itemDate >= today;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          return itemDate >= weekAgo;
        case 'month':
          const monthAgo = new Date(today);
          monthAgo.setMonth(monthAgo.getMonth() - 1);
          return itemDate >= monthAgo;
        case 'custom':
          if (customStartDate && customEndDate) {
            const start = new Date(customStartDate);
            const end = new Date(customEndDate);
            end.setHours(23, 59, 59);
            return itemDate >= start && itemDate <= end;
          }
          return true;
        default:
          return true;
      }
    });
  };

  // Apply filters to data
  const filteredVendas = getFilteredData(vendas);
  const filteredDespesas = getFilteredData(despesas);
  const filteredFaturas = getFilteredData(faturas);
  
  // ‚úÖ CRIAR ARRAY UNIFICADO: despesas manuais + faturas (convertidas para formato de despesa)
  const faturasComoDespesas = filteredFaturas.map(f => ({
    id: f.id,
    data: f.data,
    descricao: `Fatura ${f.numero || f.id}`,
    valor: f.totais?.total || f.total || 0,
    iva: f.totalIva || 0,
    categoria: 'compras',
    tipo: f.tipo || 'FT', // FT/FR/FS
    fornecedor: f.fornecedorNome || '',
    origem: 'fatura' // Flag para identificar
  }));
  
  // Combinar despesas manuais + faturas
  const todasDespesas = [...filteredDespesas, ...faturasComoDespesas];
  
  console.log(`üí∞ Total despesas combinadas: ${todasDespesas.length} (${filteredDespesas.length} manuais + ${faturasComoDespesas.length} faturas)`);

  // Total de vendas do filtro do utilizador COM FILTRO DE M√âTRICAS POR TAGS
  let totV = 0;
  let vendasFiltradas = filteredVendas;
  
  // Aplicar filtro por tags individuais
  vendasFiltradas = filteredVendas.filter(v => {
    const origem = v.origem || 'manual';
    
    if (origem === 'moloni') return configuracoes.metricas?.incluirMoloni !== false;
    if (origem === 'zobaze') return configuracoes.metricas?.incluirZobaze !== false;
    if (origem === 'manual' || v.tipo === 'manual') return configuracoes.metricas?.incluirManual !== false;
    
    // Default: incluir (caso tenha origem desconhecida)
    return true;
  });
  
  totV = vendasFiltradas.reduce((s, v) => s + (v.total || v.valor || 0), 0);
  
  const tagsAtivas = [];
  if (configuracoes.metricas?.incluirMoloni !== false) tagsAtivas.push('MOLONI');
  if (configuracoes.metricas?.incluirZobaze !== false) tagsAtivas.push('ZOBAZE');
  if (configuracoes.metricas?.incluirManual !== false) tagsAtivas.push('MANUAL');
  
  console.log(`üí∞ VENDAS [${tagsAtivas.join('+')}]: ${vendasFiltradas.length} de ${filteredVendas.length} transa√ß√µes = ‚Ç¨${totV.toFixed(2)}`);
  
  // ‚úÖ TOTAL DESPESAS com filtro de configura√ß√µes aplicado
  let totD = 0;
  
  console.log(`üì¶ Calculando despesas de ${todasDespesas.length} registos:`);
  
  todasDespesas.forEach((despesa, idx) => {
    const valor = despesa.valor || 0;
    const tipo = despesa.tipo; // S√≥ faturas t√™m tipo
    const origem = despesa.origem; // 'fatura' ou undefined (manual)
    
    // Aplicar filtro por tags individuais apenas para faturas
    if (origem === 'fatura') {
      let incluir = false;
      
      if (tipo === 'FT' && configuracoes.metricas?.incluirFT !== false) incluir = true;
      if (tipo === 'FR' && configuracoes.metricas?.incluirFR !== false) incluir = true;
      if (tipo === 'FS' && configuracoes.metricas?.incluirFS !== false) incluir = true;
      
      if (incluir) {
        totD += valor;
        console.log(`  ${idx + 1}. Fatura [${tipo}]: ‚Ç¨${valor.toFixed(2)} ‚úÖ`);
      } else {
        console.log(`  ${idx + 1}. Fatura [${tipo}]: ‚Ç¨${valor.toFixed(2)} ‚ùå Filtrada`);
      }
    } else {
      // Despesas manuais: sempre incluir
      totD += valor;
      if (idx < 3) console.log(`  ${idx + 1}. Despesa manual: ‚Ç¨${valor.toFixed(2)} ‚úÖ`);
    }
  });
  
  const tagsDespesasAtivas = [];
  if (configuracoes.metricas?.incluirFT !== false) tagsDespesasAtivas.push('FT');
  if (configuracoes.metricas?.incluirFR !== false) tagsDespesasAtivas.push('FR');
  if (configuracoes.metricas?.incluirFS !== false) tagsDespesasAtivas.push('FS');
  
  console.log(`üí∞ TOTAL DESPESAS [${tagsDespesasAtivas.join('+')}]: ‚Ç¨${totD.toFixed(2)}`);
  
  // Limite IVA: SEMPRE calcular apenas vendas do ano atual (reset a 1 Janeiro)
  const anoAtual = new Date().getFullYear();
  const vendasAnoAtual = vendas.filter(v => {
    const dataVenda = new Date(v.data);
    return dataVenda.getFullYear() === anoAtual;
  });
  const totalVendasAnoAtual = vendasAnoAtual.reduce((s, v) => s + (v.total || v.valor || 0), 0);
  
  // Filtrar tamb√©m faturas do ano atual para c√°lculo de IVA
  const faturasAnoAtual = faturas.filter(f => {
    const dataFatura = new Date(f.data);
    return dataFatura.getFullYear() === anoAtual;
  });
  
  // IVA Vendas (a receber do estado) - APENAS ANO ATUAL
  const ivaV = vendasAnoAtual.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);
  
  // IVA Compras (das faturas - a deduzir) - APENAS ANO ATUAL
  const ivaComprasFaturas = faturasAnoAtual.reduce((s, f) => s + (f.totalIva || 0), 0);
  
  // IVA Compras (das despesas com categoria "compras") - APENAS ANO ATUAL
  const despesasComprasAnoAtual = despesas.filter(d => {
    const dataDespesa = new Date(d.data);
    return dataDespesa.getFullYear() === anoAtual && d.categoria === 'compras';
  });
  
  const ivaComprasDespesas = despesasComprasAnoAtual
    .reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      const ivaValor = d.valor - valorSemIva;
      return s + ivaValor;
    }, 0);
  
  // Total IVA Compras
  const ivaCompras = ivaComprasFaturas + ivaComprasDespesas;
  
  // IVA a Pagar = IVA Vendas - IVA Compras
  const ivaP = ivaV - ivaCompras;
  
  const ratioDespesaFaturacao = totV > 0 ? (totD / totV) * 100 : 0;

  let lucroReal = 0;
  let vComC = 0;
  vendas.forEach(v => { 
    const { lucro, temCusto } = calcLucroVenda(v); 
    lucroReal += lucro; 
    if (temCusto) vComC++; 
  });

  const vPorDia = {};
  vendas.forEach(v => {
    if (!vPorDia[v.data]) vPorDia[v.data] = { total: 0, lucro: 0, qtd: 0 };
    vPorDia[v.data].total += v.valor;
    vPorDia[v.data].qtd += v.quantidade;
    vPorDia[v.data].lucro += calcLucroVenda(v).lucro;
  });

  const dias = Object.keys(vPorDia).length;
  const medFat = dias > 0 ? totV / dias : 0;
  const medLuc = dias > 0 ? lucroReal / dias : 0;
  
  // ‚úÖ LUCRO L√çQUIDO = Receita - Todas as Despesas - Impostos (IVA a pagar)
  // Nota: ivaP √© calculado mais abaixo baseado no ano atual
  // Para o lucro l√≠quido do per√≠odo filtrado, vamos calcular IVA do per√≠odo
  const ivaVendasPeriodo = vendasFiltradas.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);
  
  // IVA das faturas do per√≠odo
  const ivaFaturasPeriodo = filteredFaturas.reduce((s, f) => s + (f.totalIva || 0), 0);
  
  // IVA das despesas manuais categoria compras do per√≠odo
  const ivaDespesasPeriodo = filteredDespesas
    .filter(d => d.categoria === 'compras')
    .reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      return s + (d.valor - valorSemIva);
    }, 0);
  
  const ivaPagarPeriodo = ivaVendasPeriodo - (ivaFaturasPeriodo + ivaDespesasPeriodo);
  
  const lucroLiquido = totV - totD - ivaPagarPeriodo;
  const margemLiquida = totV > 0 ? (lucroLiquido / totV) * 100 : 0;
  
  console.log(`üí∞ LUCRO L√çQUIDO: ‚Ç¨${lucroLiquido.toFixed(2)} (${margemLiquida.toFixed(1)}%)`);
  console.log(`   Receita: ‚Ç¨${totV.toFixed(2)}`);
  console.log(`   Despesas: ‚Ç¨${totD.toFixed(2)}`);
  console.log(`   IVA a pagar: ‚Ç¨${ivaPagarPeriodo.toFixed(2)}`);

  const dFixas = todasDespesas.filter(d => ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria)).reduce((s, d) => s + d.valor, 0);
  const dFixDia = dFixas / 30;
  
  // Calculate total salaries considering payment frequency (normalize to monthly)
  const totalSalarios = todasDespesas.filter(d => d.categoria === 'salarios').reduce((s, d) => {
    const multiplicador = d.frequencia_pagamento === 'semanal' ? 4 :
                         d.frequencia_pagamento === 'quinzenal' ? 2 : 1;
    return s + (d.valor * multiplicador);
  }, 0);
  const laborCostPercentage = totV > 0 ? (totalSalarios / totV) * 100 : 0;

  // New metrics calculations - ‚úÖ USAR todasDespesas
  const totalFoodCost = todasDespesas.filter(d => d.categoria === 'compras' || d.origem === 'fatura').reduce((s, d) => s + d.valor, 0);
  const foodCostPercentage = totV > 0 ? (totalFoodCost / totV) * 100 : 0;
  const primeCostPercentage = foodCostPercentage + laborCostPercentage;
  const primeCostTotal = totalFoodCost + totalSalarios;
  
  // Break-even calculation: Fixed costs / (1 - (Variable costs / Revenue)) - ‚úÖ USAR todasDespesas
  const fixedCosts = todasDespesas.filter(d => ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria)).reduce((s, d) => s + d.valor, 0);
  const variableCosts = todasDespesas.filter(d => ['compras', 'consumiveis'].includes(d.categoria) || d.origem === 'fatura').reduce((s, d) => s + d.valor, 0);
  const contributionMarginRatio = totV > 0 ? (totV - variableCosts) / totV : 0;
  const breakEvenPoint = contributionMarginRatio > 0 ? fixedCosts / contributionMarginRatio : 0;
  
  // Break-even DI√ÅRIO (26 dias √∫teis)
  const diasUteis = 26;
  const fixedCostsDiarios = fixedCosts / diasUteis;
  const ticketMedio = filteredVendas.length > 0 ? totV / filteredVendas.length : 0;
  const foodCostPorVenda = filteredVendas.length > 0 ? totalFoodCost / filteredVendas.length : 0;
  const margemPorVenda = ticketMedio - foodCostPorVenda;
  const vendasNecessariasPorDia = margemPorVenda > 0 ? fixedCostsDiarios / margemPorVenda : 0;
  const breakEvenDiario = vendasNecessariasPorDia * ticketMedio;
  
  // Efficiency per employee (count unique employees considering frequency) - ‚úÖ USAR todasDespesas
  const numEmployees = todasDespesas
    .filter(d => d.categoria === 'salarios')
    .reduce((sum, d) => sum + (d.num_funcionarios || 1), 0) || 1;
  
  const revenuePerEmployee = numEmployees > 0 ? totV / numEmployees : 0;
  const salesPerEmployee = numEmployees > 0 ? filteredVendas.length / numEmployees : 0;
  
  console.log(`üìä KPIs calculados:`);
  console.log(`   Food Cost: ‚Ç¨${totalFoodCost.toFixed(2)} (${foodCostPercentage.toFixed(1)}%)`);
  console.log(`   Labor Cost: ‚Ç¨${totalSalarios.toFixed(2)} (${laborCostPercentage.toFixed(1)}%)`);
  console.log(`   Prime Cost: ‚Ç¨${primeCostTotal.toFixed(2)} (${primeCostPercentage.toFixed(1)}%)`);
  console.log(`   Break-even: ‚Ç¨${breakEvenPoint.toFixed(2)}`);


  const vPorProd = {};
  vendas.forEach(v => {
    if (!vPorProd[v.produto]) vPorProd[v.produto] = { quantidade: 0, total: 0, lucro: 0 };
    vPorProd[v.produto].quantidade += v.quantidade;
    vPorProd[v.produto].total += v.valor;
    vPorProd[v.produto].lucro += calcLucroVenda(v).lucro;
  });

  const top5Venda = Object.entries(vPorProd).sort((a, b) => b[1].quantidade - a[1].quantidade).slice(0, 5);
  const top5Lucro = Object.entries(vPorProd).sort((a, b) => b[1].lucro - a[1].lucro).slice(0, 5);
  const pior5Venda = Object.entries(vPorProd).sort((a, b) => a[1].quantidade - b[1].quantidade).slice(0, 5);
  const pior5Lucro = Object.entries(vPorProd).sort((a, b) => a[1].lucro - b[1].lucro).slice(0, 5);

  const dadosPorMes = {};
  
  vendas.forEach(v => {
    const mes = v.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    // Arredondar para evitar erros de ponto flutuante
    dadosPorMes[mes].faturacao = Math.round((dadosPorMes[mes].faturacao + v.valor) * 100) / 100;
    dadosPorMes[mes].lucro = Math.round((dadosPorMes[mes].lucro + calcLucroVenda(v).lucro) * 100) / 100;
    dadosPorMes[mes].vendas += 1;
    dadosPorMes[mes].ivaVendas = Math.round((dadosPorMes[mes].ivaVendas + (v.valor * v.iva / (100 + v.iva))) * 100) / 100;
  });

  despesas.forEach(d => {
    const mes = d.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    dadosPorMes[mes].despesas += d.valor;
    if (d.categoria === 'salarios') {
      dadosPorMes[mes].salarios += d.valor;
    }
  });
  
  // IVA Compras das faturas por m√™s
  faturas.forEach(f => {
    const mes = f.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    dadosPorMes[mes].ivaCompras += (f.totalIva || 0);
  });

  Object.keys(dadosPorMes).forEach(mes => {
    const dados = dadosPorMes[mes];
    
    // Calculate actual food costs for this month
    let custoAlimentosMes = 0;
    vendas.filter(v => v.data.startsWith(mes)).forEach(v => {
      const p = produtos.find(pr => pr.nome.toLowerCase() === v.produto.toLowerCase());
      if (p) {
        custoAlimentosMes += calcCusto(p) * v.quantidade;
      }
    });
    
    dados.foodCostPct = dados.faturacao > 0 ? ((custoAlimentosMes / dados.faturacao) * 100) : 0;
    dados.laborCostPct = dados.faturacao > 0 ? ((dados.salarios / dados.faturacao) * 100) : 0;
  });

  const mesesOrdenados = Object.keys(dadosPorMes).sort();
  const ultimos6Meses = mesesOrdenados.slice(-6);

  // ===== FUN√á√ïES OCR =====
  const fuzz = window.fuzzball || window.fuzz;
  
  // Normaliza√ß√£o
  const normalizeForMatching = (text) => {
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  };
  
  // Extra√ß√£o nativa
  const extractNativeText = async (pdfBuffer) => {
    try {
      const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
      let fullText = '';
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      return fullText.trim();
    } catch (error) {
      console.warn('PDF.js falhou:', error.message);
      return '';
    }
  };
  
  // PDF para imagens
  const pdfToImages = async (pdfBuffer) => {
    const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
    const images = [];
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      images.push(canvas.toDataURL('image/png'));
    }
    return images;
  };
  
  // OCR
  const extractWithOCR = async (pdfBuffer) => {
    try {
      const images = await pdfToImages(pdfBuffer);
      console.log(`üñºÔ∏è ${images.length} p√°gina(s)`);
      let fullText = '';
      for (let i = 0; i < images.length; i++) {
        setProgressoOCR(`OCR p√°gina ${i + 1}/${images.length}...`);
        const result = await Tesseract.recognize(images[i], 'por', {
          logger: m => {
            if (m.status === 'recognizing text') {
              setProgressoOCR(`OCR ${Math.round(m.progress * 100)}%`);
            }
          }
        });
        fullText += result.data.text + '\n';
      }
      return fullText.trim();
    } catch (error) {
      throw new Error('OCR falhou: ' + error.message);
    }
  };
  
  // Extra√ß√£o principal - SIMPLIFICADA (sem PDF.js)
  const extractTextFromPdf = async (file) => {
    console.log('üìÑ Processando ficheiro...');
    setProgressoOCR('Preparando OCR...');
    
    try {
      //  Converter PDF para imagem usando FileReader
      const imageData = await convertPdfToImage(file);
      
      console.log('üñºÔ∏è Imagem preparada, iniciando OCR...');
      setProgressoOCR('Aplicando OCR...');
      
      // Fazer OCR direto
      const result = await Tesseract.recognize(imageData, 'por', {
        logger: m => {
          if (m.status === 'recognizing text') {
            setProgressoOCR(`OCR ${Math.round(m.progress * 100)}%`);
          }
        }
      });
      
      console.log('‚úÖ OCR completo:', result.data.text.length, 'caracteres');
      return { text: result.data.text, method: 'ocr' };
      
    } catch (error) {
      throw new Error('Falha OCR: ' + error.message);
    }
  };
  
  // Converter PDF/Imagem para data URL
  const convertPdfToImage = async (file) => {
    // Ler PDF como ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();
    
    // Carregar PDF com PDF.js
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    
    console.log(`üìÑ PDF tem ${pdf.numPages} p√°gina(s)`);
    
    // Converter primeira p√°gina para imagem
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 2.0 }); // Scale 2.0 para melhor qualidade
    
    // Criar canvas
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    // Renderizar p√°gina no canvas
    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;
    
    // Converter canvas para data URL (imagem)
    const imageDataUrl = canvas.toDataURL('image/png');
    
    console.log('‚úÖ PDF convertido para imagem PNG');
    
    return imageDataUrl;
  };
  
  // Ignorar linhas
  const shouldIgnoreLine = (linha) => {
    const lower = linha.toLowerCase();
    
    // Patterns mais abrangentes para ignorar
    const ignorePatterns = [
      // Headers/Footers de fatura
      /^(fatura|factura|invoice|recibo|receipt)/i,
      /^(nif|nipc|vat|cif)[\s:]/i,
      /^(data|date)[\s:]/i,
      /^(vencimento|due date)[\s:]/i,
      
      // Info empresa/cliente
      /^(fornecedor|supplier|vendedor|seller|exmo|cliente|client)/i,
      /(lda|limitada|s\.a\.|unipessoal|ltda)/i,
      /^(rua|avenida|av\.|pra√ßa|largo|estrada)/i,
      /^\d{4}-\d{3}\s/i, // C√≥digo postal
      /(email|e-mail|tel|telefone|phone|fax)[\s:]/i,
      
      // Totais e valores agregados
      /^(total|subtotal|sub-total|iva|vat|tax|imposto)[\s:]/i,
      /^(desconto|discount)[\s:]/i,
      
      // Info pagamento
      /^(m√©todo|metodo|forma|pagamento|payment|transfer√™ncia)/i,
      /(iban|nib|swift|bic)[\s:]/i,
      /^(refer√™ncia|reference|ref)[\s:]/i,
      /prazo\s+(de\s+)?pagamento/i,
      
      // Headers de tabela
      /^(descri√ß√£o|description|artigo|produto|item)/i,
      /^(quantidade|qtd|qty|unidade|un|unit)/i,
      /^(pre√ßo|preco|price|valor|value)/i,
      
      // Informa√ß√£o legal
      /(processado|emitido)\s+por\s+computador/i,
      /(documento|comprovativo)\s+(v√°lido|valido)/i,
      /(conservat√≥ria|registo|matricula|matr√≠cula)/i,
      /(capital social|share capital)/i,
      /sob\s+o\s+n√∫mero/i,
      
      // Linhas s√≥ com n√∫meros/datas
      /^\d{9}$/,  // NIF sozinho
      /^\d+\/\d+\/\d+$/, // Data sozinha
      /^pt\d{2}\s*\d{4}/i, // IBAN
      
      // Linhas muito curtas ou vazias
      /^[\s\-\+\.]+$/, // S√≥ s√≠mbolos
    ];
    
    // Se algum pattern matchar, ignorar
    if (ignorePatterns.some(p => p.test(linha))) {
      return true;
    }
    
    // Ignorar linhas muito curtas (< 5 caracteres)
    if (linha.length < 5) {
      return true;
    }
    
    // Linha DEVE ter pelo menos: quantidade + unidade OU pre√ßo
    // Se n√£o tiver nenhum dos dois, provavelmente n√£o √© produto
    const temQuantidade = /\d+[.,]?\d*\s*(kg|g|l|ml|un|unid)/i.test(linha);
    const temPreco = /\d+[.,]\d{2}\s*‚Ç¨?/i.test(linha);
    
    if (!temQuantidade && !temPreco) {
      return true; // Ignorar se n√£o tiver nem quantidade nem pre√ßo
    }
    
    return false;
  };
  
  // Extrair qtd/unidade - MELHORADO
  const extractQuantidadeUnidade = (texto) => {
    // Patterns mais espec√≠ficos para quantidade + unidade
    const patterns = [
      /(\d+[.,]?\d*)\s*(kg|quilos?|kilos?)/gi,
      /(\d+[.,]?\d*)\s*(g|gramas?)/gi,
      /(\d+[.,]?\d*)\s*l\b/gi,  // l isolado (litros)
      /(\d+[.,]?\d*)\s*(ml|mililitros?)/gi,
      /(\d+[.,]?\d*)\s*(un|unid|unidade|pc|p√ß|pe√ßa|cx|caixa|emb|embalagem|dz|duzia|d√∫zia)/gi,
    ];
    
    for (const pattern of patterns) {
      const match = texto.match(pattern);
      if (match && match[0]) {
        const full = match[0];
        // Extrair n√∫mero
        const numStr = full.match(/\d+[.,]?\d*/);
        if (numStr) {
          const qtd = parseFloat(numStr[0].replace(',', '.'));
          // Extrair unidade
          let unidade = full.replace(/[\d.,\s]/g, '').toLowerCase().trim();
          
          // Normalizar unidades
          const map = {
            'quilos': 'kg', 'quilo': 'kg', 'kilos': 'kg', 'kilo': 'kg',
            'gramas': 'g', 'grama': 'g',
            'litros': 'l', 'litro': 'l',
            'mililitros': 'ml', 'mililitro': 'ml',
            'unid': 'un', 'unidade': 'un', 'pc': 'un', 'p√ß': 'un', 'pe√ßa': 'un',
            'caixa': 'un', 'emb': 'un', 'embalagem': 'un',  // Converter para 'un'
            'duzia': 'un', 'd√∫zia': 'un'  // Converter para 'un'
          };
          
          unidade = map[unidade] || unidade;
          
          return { quantidade: qtd, unidade, match: full };
        }
      }
    }
    
    return { quantidade: null, unidade: null, match: '' };
  };
  
  // Extrair pre√ßo
  const extractPreco = (texto) => {
    const match = texto.match(/‚Ç¨?\s*(\d+[.,]\d{2})\s*‚Ç¨?/g);
    if (match) {
      const last = match[match.length - 1];
      const valor = parseFloat(last.replace(/[^\d.,]/g, '').replace(',', '.'));
      return { valor, match: last };
    }
    return { valor: null, match: '' };
  };
  
  // Parse linha
  const parseLinha = (linha) => {
    const qtdUnidade = extractQuantidadeUnidade(linha);
    const preco = extractPreco(linha);
    let nomeProduto = linha;
    if (qtdUnidade.match) nomeProduto = nomeProduto.replace(qtdUnidade.match, '');
    if (preco.match) nomeProduto = nomeProduto.replace(preco.match, '');
    nomeProduto = nomeProduto.replace(/\s+/g, ' ').trim();
    if (!nomeProduto) nomeProduto = linha;
    return {
      textoOriginal: linha,
      nomeProduto,
      quantidade: qtdUnidade.quantidade,
      unidade: qtdUnidade.unidade,
      preco: preco.valor,
      ingredienteSugerido: null,
      ingredienteConfirmado: null
    };
  };
  
  // Parse produtos
  const parseLinhasProdutos = (texto) => {
    console.log('üîç Parsing...');
    setProgressoOCR('Identificando produtos...');
    const linhas = texto.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const linhasProdutos = [];
    for (const linha of linhas) {
      if (shouldIgnoreLine(linha)) continue;
      const parsed = parseLinha(linha);
      if (parsed && parsed.nomeProduto) linhasProdutos.push(parsed);
    }
    console.log(`‚úÖ ${linhasProdutos.length} produtos`);
    return linhasProdutos;
  };
  
  // Metadata
  const extractFaturaMetadata = (texto) => {
    const linhas = texto.split('\n');
    const metadata = { numeroFatura: null, data: null, nif: null, total: null };
    for (const linha of linhas) {
      if (!metadata.numeroFatura) {
        // Procurar m√∫ltiplos padr√µes de n√∫mero de fatura
        const padroes = [
          /FT[\s\/-]*(\d{4}[\/-]\d+)/gi,                    // FT 2024/123, FT/2024/123
          /FT[\s\/-]*(\d+)/gi,                              // FT 123, FT123
          /(?:fatura|factura)[\s:n¬∫¬∞#]*(\d+\/\d+)/gi,      // Fatura 2024/123
          /(?:fatura|factura)[\s:n¬∫¬∞#]*(\d{4,})/gi,        // Fatura 123456
          /(?:invoice)[\s:#]*(\d+)/gi,                      // Invoice #123
          /N[¬∫¬∞][\s:]*(\d{4,})/gi                          // N¬∫ 123456
        ];
        
        for (const padrao of padroes) {
          const match = linha.match(padrao);
          if (match) {
            // Extrair apenas os n√∫meros/identificador
            const numMatch = match[0].match(/[\d\/\-]+$/);
            if (numMatch) {
              metadata.numeroFatura = numMatch[0];
              break;
            }
          }
        }
      }
      if (!metadata.data) {
        const data = linha.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
        if (data) metadata.data = data[1];
      }
      if (!metadata.nif) {
        const nif = linha.match(/(?:nif|nipc|contribuinte)[:\s]*(\d{9})/i);
        if (nif) metadata.nif = nif[1];
      }
      if (!metadata.total) {
        const total = linha.match(/total[\s:]*‚Ç¨?\s*(\d+[.,]\d{2})/i);
        if (total) metadata.total = parseFloat(total[1].replace(',', '.'));
      }
    }
    console.log('üìã Metadata extra√≠da:', metadata);
    return metadata;
  };
  
  // Matching
  const findBestMatch = (nomeProduto, ingredientes) => {
    const produtoNorm = normalizeForMatching(nomeProduto);
    let bestMatch = null;
    let bestScore = 0;
    for (const ing of ingredientes) {
      const ingNorm = normalizeForMatching(ing.nome);
      let score = fuzz.ratio(produtoNorm, ingNorm);
      if (produtoNorm.includes(ingNorm) || ingNorm.includes(produtoNorm)) {
        score = Math.min(100, score + 10);
      }
      if (score > bestScore) {
        bestScore = score;
        bestMatch = { id: ing.id, nome: ing.nome, confianca: Math.round(score) };
      }
    }
    return bestScore >= 60 ? bestMatch : null;
  };
  
  const matchIngredientes = (linhas, ingredientes) => {
    console.log('üéØ Matching...');
    setProgressoOCR('Relacionando...');
    return linhas.map(linha => ({
      ...linha,
      ingredienteSugerido: findBestMatch(linha.nomeProduto, ingredientes)
    }));
  };
  
  const calculateMatchingStats = (linhas) => {
    const total = linhas.length;
    const comSugestao = linhas.filter(l => l.ingredienteSugerido).length;
    const altaConfianca = linhas.filter(l => l.ingredienteSugerido?.confianca >= 80).length;
    const mediaConfianca = linhas.filter(l => l.ingredienteSugerido?.confianca >= 60 && l.ingredienteSugerido?.confianca < 80).length;
    return {
      total, comSugestao, altaConfianca, mediaConfianca,
      semSugestao: total - comSugestao,
      percentagemAuto: total > 0 ? Math.round((altaConfianca / total) * 100) : 0
    };
  };
  
  const getConfidenceLevel = (score) => {
    if (score >= 80) return { nivel: 'alta', cor: 'green', icone: '‚úì' };
    if (score >= 60) return { nivel: 'media', cor: 'yellow', icone: '‚ö†' };
    return { nivel: 'baixa', cor: 'red', icone: '‚úó' };
  };
  
  // Handler principal
  const handleLerPDFAutomatico = async (event) => {
    const file = event.target.files[0];
    if (!file) {
      showNotification('‚ö†Ô∏è Selecione um ficheiro', 'error');
      return;
    }
    
    // Aceitar PDF ou imagens
    const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      showNotification('‚ö†Ô∏è Selecione um PDF ou imagem (PNG, JPG, WEBP)', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    // Verificar APENAS Tesseract e Fuzzball (PDF.js n√£o √© mais necess√°rio)
    if (typeof Tesseract === 'undefined') {
      showNotification('‚ö†Ô∏è Biblioteca Tesseract ainda n√£o carregou. Aguarde e tente novamente.', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    if (typeof fuzz === 'undefined' && typeof window.fuzzball === 'undefined') {
      showNotification('‚ö†Ô∏è Biblioteca de matching ainda n√£o carregou. Aguarde e tente novamente.', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    let base64 = null;
    
    try {
      setProcessandoOCR(true);
      setProgressoOCR('Carregando...');
      
      // Ler ficheiro e converter para base64 PRIMEIRO
      const arrayBuffer = await file.arrayBuffer();
      base64 = btoa(
        new Uint8Array(arrayBuffer)
          .reduce((data, byte) => data + String.fromCharCode(byte), '')
      );
      
      // Extrair texto (passa file direto agora, n√£o arrayBuffer)
      const { text, method } = await extractTextFromPdf(file);
      console.log(`M√©todo: ${method}`);
      
      // Extrair metadata PRIMEIRO (para ter NIF)
      const metadata = extractFaturaMetadata(text);
      metadata.textoCompleto = text; // Guardar para aprender template
      
      // ==================== PROCESSAR FATURA V2.0 ====================
      // Detectar tipo de fatura e extrair dados estruturados
      const dadosFatura = processarTextoFatura(text);
      console.log('üìã Fatura processada:', dadosFatura);
      
      // Criar URL tempor√°rio do PDF para visualiza√ß√£o
      const pdfBlob = new Blob([await file.arrayBuffer()], { type: 'application/pdf' });
      const pdfUrl = URL.createObjectURL(pdfBlob);
      
      // Mostrar modal de confirma√ß√£o ANTES de continuar
      setModalConfirmacaoFatura({
        mostrar: true,
        dados: {
          ...dadosFatura,
          pdfUrl: pdfUrl
        }
      });
      // ==================== FIM PROCESSAMENTO V2.0 ====================
      
      // üìã Usar template se existir
      const template = buscarTemplateOCR(metadata.nif);
      const linhas = template ? parseComTemplate(text, template) : parseLinhasProdutos(text);
      
      // SEMPRE guardar PDF (independente de ter produtos ou n√£o)
      metadata.pdfBase64 = base64;
      metadata.pdfNome = file.name;
      metadata.precosComIVA = dadosFatura.precosComIVA; // NOVO: passar flag de IVA
      
      // Fazer matching dos ingredientes (pode estar vazio)
      const linhasComMatch = linhas.length > 0 
        ? matchIngredientes(linhas, ingredientes)
        : []; // Lista vazia mas abre modal na mesma
      
      // SEMPRE abrir modal (user pode adicionar ingredientes manualmente)
      setLinhasOCR(linhasComMatch);
      setMetadataOCR(metadata);
      setMostrarModalOCR(true);
      
      if (linhas.length === 0) {
        showNotification('‚ö†Ô∏è Nenhum produto detectado. Adicione manualmente no modal!', 'warning');
      } else {
        showNotification(`‚úÖ ${linhas.length} produtos identificados!`, 'success');
      }
    } catch (error) {
      console.error('Erro:', error);
      
      // MESMO com erro, tenta guardar o PDF se conseguiu converter
      if (base64) {
        setNovaFatura({
          ...novaFatura,
          documentoPDF: base64,
          nomeDocumento: file.name
        });
        showNotification('‚ùå Erro no OCR, mas PDF foi guardado! Adicione dados manualmente.', 'warning');
      } else {
        showNotification('‚ùå Erro ao processar: ' + error.message, 'error');
      }
    } finally {
      setProcessandoOCR(false);
      setProgressoOCR('');
      event.target.value = ''; // ‚úÖ LIMPAR INPUT SEMPRE NO FINAL
    }
  };
  
  // Confirmar
  const handleConfirmarOCR = (linhasValidadas, metadata) => {
    console.log('üìù Auto-preenchendo fatura...');
    
    // üß† FASE 2: RECONHECIMENTO AUTOM√ÅTICO DE INGREDIENTES
    const nifFornecedor = metadata.nif || novaFatura.fornecedorNIF;
    
    if (nifFornecedor) {
      console.log('üß† Iniciando reconhecimento inteligente...');
      
      linhasValidadas = linhasValidadas.map(linha => {
        // Se j√° tem ingrediente confirmado, manter
        if (linha.ingredienteConfirmado) {
          console.log(`‚úÖ "${linha.nomeProduto}" j√° confirmado manualmente`);
          return linha;
        }
        
        // Buscar no vocabul√°rio do fornecedor
        const resultado = buscarNoVocabulario(linha.nomeProduto, nifFornecedor);
        
        if (resultado) {
          const { ingredienteId, confianca, similaridade, confirmacoes, correcoes } = resultado;
          const ingrediente = ingredientes.find(i => i.id === ingredienteId);
          
          if (ingrediente) {
            console.log(`üîµ "${linha.nomeProduto}" ‚Üí ${ingrediente.nome} (${confianca}% confian√ßa, ${confirmacoes} confirma√ß√µes)`);
            
            // Pr√©-preencher com sugest√£o
            return {
              ...linha,
              ingredienteConfirmado: ingredienteId,
              ingredienteSugerido: true, // Flag para UI mostrar que foi sugerido
              confiancaSugestao: confianca,
              similaridadeSugestao: similaridade,
              historicoSugestao: { confirmacoes, correcoes }
            };
          }
        }
        
        console.log(`‚ö™ "${linha.nomeProduto}" ‚Üí sem sugest√£o (desconhecido)`);
        return linha;
      });
      
      const sugeridos = linhasValidadas.filter(l => l.ingredienteSugerido).length;
      const total = linhasValidadas.length;
      
      if (sugeridos > 0) {
        console.log(`üéØ ${sugeridos}/${total} ingredientes reconhecidos automaticamente!`);
      } else {
        console.log(`üìö Nenhum ingrediente reconhecido (primeira vez com este fornecedor)`);
      }
    }
    
    // ATUALIZAR PRE√áOS DOS INGREDIENTES
    const ingredientesAtualizados = [...ingredientes];
    
    // üÜï ADICIONAR NOVOS INGREDIENTES CRIADOS NO MODAL
    if (metadata.novosIngredientes && metadata.novosIngredientes.length > 0) {
      const novosIngs = metadata.novosIngredientes;
      setIngredientes([...ingredientes, ...novosIngs]);
      console.log(`‚ú® ${novosIngs.length} novo(s) ingrediente(s) criado(s):`, novosIngs.map(i => i.nome));
      
      // Atualizar lista local para usar nas pr√≥ximas etapas
      ingredientesAtualizados.push(...novosIngs);
    }
    
    // üÜï ADICIONAR NOVOS FORNECEDORES CRIADOS NO MODAL
    if (window._novosFornecedores && window._novosFornecedores.length > 0) {
      const novosForn = window._novosFornecedores;
      setFornecedores([...fornecedores, ...novosForn]);
      console.log(`‚ú® ${novosForn.length} novo(s) fornecedor(es) criado(s):`, novosForn.map(f => f.nome));
      
      // Limpar cache
      window._novosFornecedores = [];
    }
    
    let ingredientesModificados = 0;
    
    // Detectar se pre√ßos na fatura s√£o COM ou SEM IVA
    const precosComIVA = metadata.precosComIVA !== undefined ? metadata.precosComIVA : true;
    
    console.log('üí∂ Processando pre√ßos da fatura:');
    console.log(`   - Flag precosComIVA: ${precosComIVA}`);
    console.log(`   - Fornecedor: ${metadata.nif || 'N/A'}`);
    console.log(`   - Linhas validadas: ${linhasValidadas.length}`);
    
    linhasValidadas.forEach(l => {
      if (l.ingredienteConfirmado && l.preco && l.quantidade) {
        const index = ingredientesAtualizados.findIndex(i => i.id === l.ingredienteConfirmado);
        
        if (index === -1) {
          console.log(`‚ùå ERRO: Ingrediente ID ${l.ingredienteConfirmado} n√£o encontrado!`);
          return;
        }
        
        const ingrediente = ingredientesAtualizados[index];
        const precoTotal = parseFloat(l.preco);
        const quantidade = parseFloat(l.quantidade);
        const iva = ingrediente.iva || 23;
        
        console.log(`\nüì¶ Item da fatura: ${l.nomeProduto}`);
        console.log(`   Ingrediente associado: ${ingrediente.nome} (ID: ${ingrediente.id})`);
        console.log(`   IVA do ingrediente: ${iva}%`);
        
        let novoPrecoUnitario;
        
        if (precosComIVA) {
          // Pre√ßo J√Å inclui IVA - usar direto
          novoPrecoUnitario = precoTotal / quantidade;
        } else {
          // Pre√ßo SEM IVA - precisa ADICIONAR IVA
          const precoSemIVA = precoTotal / quantidade;
          novoPrecoUnitario = precoSemIVA * (1 + iva / 100);
        }
        
        const precoAnterior = ingredientesAtualizados[index].custoUnitario || 0; // ‚úÖ custoUnitario
        
        // Log detalhado do c√°lculo
        console.log(`\nüîç CALCULANDO: ${ingredientesAtualizados[index].nome}`);
        console.log(`   Pre√ßo anterior: ‚Ç¨${precoAnterior.toFixed(2)}`);
        console.log(`   Pre√ßo total na fatura: ‚Ç¨${precoTotal.toFixed(2)}`);
        console.log(`   Quantidade: ${quantidade}`);
        console.log(`   IVA: ${iva}%`);
        console.log(`   Flag precosComIVA: ${precosComIVA}`);
        
        if (precosComIVA) {
          console.log(`   ‚úÖ Pre√ßo J√Å inclui IVA`);
          console.log(`   C√°lculo: ‚Ç¨${precoTotal.toFixed(2)} / ${quantidade} = ‚Ç¨${novoPrecoUnitario.toFixed(3)} (COM IVA)`);
        } else {
          const precoSemIVA = precoTotal / quantidade;
          console.log(`   ‚úÖ Pre√ßo SEM IVA - adicionando ${iva}%`);
          console.log(`   C√°lculo: (‚Ç¨${precoTotal.toFixed(2)} / ${quantidade}) √ó (1 + ${iva}/100)`);
          console.log(`   Resultado: ‚Ç¨${precoSemIVA.toFixed(3)} √ó ${(1 + iva/100).toFixed(2)} = ‚Ç¨${novoPrecoUnitario.toFixed(3)} (COM IVA)`);
        }
        
        // Atualizar se pre√ßo mudou
        if (Math.abs(novoPrecoUnitario - precoAnterior) > 0.01) {
          console.log(`üí∞ Atualizando ${ingredientesAtualizados[index].nome}: ‚Ç¨${precoAnterior.toFixed(2)} ‚Üí ‚Ç¨${novoPrecoUnitario.toFixed(2)} (${precosComIVA ? 'pre√ßos COM IVA' : 'pre√ßos SEM IVA - adicionado IVA'})`);
          ingredientesAtualizados[index] = {
            ...ingredientesAtualizados[index],
            custoUnitario: novoPrecoUnitario, // ‚úÖ custoUnitario
            precoUnitario: novoPrecoUnitario  // ‚úÖ MANTER AMBOS para compatibilidade
          };
          ingredientesModificados++;
        } else {
          console.log(`   ‚è≠Ô∏è Pre√ßo n√£o mudou significativamente (diferen√ßa: ‚Ç¨${Math.abs(novoPrecoUnitario - precoAnterior).toFixed(3)})`);
        }
      }
    });
    
    // Atualizar ingredientes se houver mudan√ßas
    if (ingredientesModificados > 0) {
      setIngredientes(ingredientesAtualizados);
      console.log(`‚úÖ ${ingredientesModificados} ingrediente(s) atualizado(s)`);
      
      // RECALCULAR FOOD COST DOS PRODUTOS
      const produtosAtualizados = produtos.map(produto => {
        if (!produto.receita || produto.receita.length === 0) return produto;
        
        // Calcular novo custo
        const novoCusto = produto.receita.reduce((total, item) => {
          const ing = ingredientesAtualizados.find(i => i.id === item.ingredienteId);
          if (!ing) return total;
          
          const quantidade = parseFloat(item.quantidade) || 0;
          const precoUnit = parseFloat(ing.precoUnitario) || 0;
          
          return total + (quantidade * precoUnit);
        }, 0);
        
        // Calcular nova margem
        const precoVenda = parseFloat(produto.precoVenda) || 0;
        const novaMargemLucro = precoVenda > 0 ? ((precoVenda - novoCusto) / precoVenda) * 100 : 0;
        
        // S√≥ atualizar se mudou
        if (Math.abs(novoCusto - (produto.custoReceita || 0)) > 0.01) {
          console.log(`üçï Recalculando ${produto.nome}: Custo ‚Ç¨${(produto.custoReceita || 0).toFixed(2)} ‚Üí ‚Ç¨${novoCusto.toFixed(2)}, Margem ${(produto.margemLucro || 0).toFixed(1)}% ‚Üí ${novaMargemLucro.toFixed(1)}%`);
          
          return {
            ...produto,
            custoReceita: novoCusto,
            margemLucro: novaMargemLucro
          };
        }
        
        return produto;
      });
      
      setProdutos(produtosAtualizados);
      showNotification(`üîÑ ${ingredientesModificados} pre√ßo(s) atualizado(s) e food costs recalculados!`, 'success');
    }
    
    // Criar itens da fatura COM ESTRUTURA CORRETA
    const novosItens = linhasValidadas
      .filter(l => l.ingredienteConfirmado)
      .map((l, index) => {
        const ingrediente = ingredientesAtualizados.find(i => i.id === l.ingredienteConfirmado);
        
        // Garantir valores v√°lidos
        const quantidade = parseFloat(l.quantidade) || 1;
        const precoTotal = parseFloat(l.preco) || 0;
        const precoUnitario = precoTotal > 0 ? (precoTotal / quantidade) : 0;
        const iva = parseFloat(ingrediente?.iva || 13);
        const subtotal = precoTotal;
        
        return {
          id: `ocr_${Date.now()}_${index}`, // ID √∫nico
          ingredienteId: l.ingredienteConfirmado,
          ingredienteNome: ingrediente?.nome || l.nomeProduto,
          descricao: ingrediente?.nome || l.nomeProduto,
          quantidade: quantidade,
          unidade: l.unidade || ingrediente?.unidade || 'un',
          precoUnitario: precoUnitario,
          precoTotal: precoTotal,
          subtotal: subtotal,
          iva: iva,
          num_funcionarios: 1
        };
      });
    
    console.log('Itens processados:', novosItens);
    console.log('PDF Base64 length:', metadata.pdfBase64 ? metadata.pdfBase64.length : 'NULL');
    
    // üß† FASE 2: APRENDER COM AS CONFIRMA√á√ïES DO UTILIZADOR
    if (nifFornecedor) {
      linhasValidadas.forEach(linha => {
        if (linha.ingredienteConfirmado && linha.nomeProduto) {
          const textoOCR = linha.nomeProduto;
          const ingredienteId = linha.ingredienteConfirmado;
          
          // Verificar se foi alterado (corre√ß√£o) ou confirmado (sugest√£o aceite)
          const foiAlterado = linha.ingredienteSugerido && 
                             linha.ingredienteConfirmado !== linha.ingredienteSugerido;
          
          // Aprender a associa√ß√£o
          aprenderAssociacao(textoOCR, ingredienteId, nifFornecedor, foiAlterado);
          
          if (foiAlterado) {
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);
            console.log(`üìù Corre√ß√£o aprendida: "${textoOCR}" ‚Üí ${ingrediente?.nome}`);
          } else if (linha.ingredienteSugerido) {
            console.log(`‚úÖ Confirma√ß√£o aprendida: "${textoOCR}"`);
          } else {
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);
            console.log(`üÜï Nova associa√ß√£o: "${textoOCR}" ‚Üí ${ingrediente?.nome}`);
          }
        }
      });
    }
    
    // üìã Aprender template do fornecedor
    if (nifFornecedor && metadata.textoCompleto) {
      aprenderTemplateOCR(nifFornecedor, metadata.textoCompleto, linhasValidadas);
    }
    
    // Preencher dados da fatura (preservando PDF!)
    const novaFaturaAtualizada = {
      ...novaFatura,
      numero: metadata.numeroFatura || novaFatura.numero,
      tipo: metadata.tipoFatura || 'FT', // ‚úÖ TIPO DE FATURA (FT/FR/FS)
      tipoDocumento: metadata.tipoDocumento || 'fatura', // ‚Üê tipo do documento
      data: metadata.data ? convertDataToISO(metadata.data) : novaFatura.data,
      itens: novosItens,
      documentoPDF: metadata.pdfBase64 || novaFatura.documentoPDF || null,
      nomeDocumento: metadata.pdfNome || novaFatura.nomeDocumento || '',
      categoria: 'compras',
      totais: metadata.totais || { subtotal: 0, iva: 0, total: 0 } // ‚úÖ TOTAIS DA FATURA
    };
    
    // Tentar identificar fornecedor pelo NIF (se existir)
    if (metadata.nif) {
      const fornecedor = fornecedores.find(f => f.nif === metadata.nif);
      if (fornecedor) {
        novaFaturaAtualizada.fornecedorId = fornecedor.id;
        novaFaturaAtualizada.fornecedorNome = fornecedor.nome;
        novaFaturaAtualizada.fornecedorNif = metadata.nif;
        console.log('‚úÖ Fornecedor identificado:', fornecedor.nome);
      }
    }
    
    // Se fornecedor foi selecionado manualmente (sem NIF detectado)
    if (metadata.fornecedorManual && !novaFaturaAtualizada.fornecedorId) {
      // Verificar se √© fornecedor tempor√°rio (rec√©m-criado)
      let fornecedorManual = fornecedores.find(f => f.id === metadata.fornecedorManual);
      
      if (!fornecedorManual && window._novosFornecedores) {
        fornecedorManual = window._novosFornecedores.find(f => f.id === metadata.fornecedorManual);
      }
      
      if (fornecedorManual) {
        novaFaturaAtualizada.fornecedorId = fornecedorManual.id;
        novaFaturaAtualizada.fornecedorNome = fornecedorManual.nome;
        novaFaturaAtualizada.fornecedorNif = fornecedorManual.nif;
        console.log('‚úÖ Fornecedor selecionado manualmente:', fornecedorManual.nome);
      }
    }
    
    console.log('PDF na fatura final:', novaFaturaAtualizada.documentoPDF ? 'SIM' : 'N√ÉO');
    console.log('Tipo documento:', novaFaturaAtualizada.tipoDocumento);
    
    setNovaFatura(novaFaturaAtualizada);
    setMostrarModalOCR(false);
    
    const tipoMsg = novaFaturaAtualizada.tipoDocumento === 'fatura' ? 'Fatura' : 'Recibo';
    showNotification(`‚úÖ ${tipoMsg} preenchida com ${novosItens.length} produtos!`, 'success');
  };
  
  // Converter data DD/MM/YYYY para YYYY-MM-DD
  const convertDataToISO = (dataStr) => {
    try {
      // Tentar formatos: DD/MM/YYYY, DD-MM-YYYY, DD/MM/YY
      const patterns = [
        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, // DD/MM/YYYY
        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/   // DD/MM/YY
      ];
      
      for (const pattern of patterns) {
        const match = dataStr.match(pattern);
        if (match) {
          let [_, dia, mes, ano] = match;
          
          // Converter ano de 2 d√≠gitos
          if (ano.length === 2) {
            ano = parseInt(ano) > 50 ? `19${ano}` : `20${ano}`;
          }
          
          // Adicionar zero √† esquerda se necess√°rio
          dia = dia.padStart(2, '0');
          mes = mes.padStart(2, '0');
          
          return `${ano}-${mes}-${dia}`;
        }
      }
      
      // Se falhar, retornar data atual
      return new Date().toISOString().split('T')[0];
    } catch {
      return new Date().toISOString().split('T')[0];
    }
  };

  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
    { id: 'gestao', label: 'Gest√£o', icon: FileText },
    { id: 'definicoes', label: 'Defini√ß√µes', icon: Settings }
  ];

  return (
    <div className={`min-h-screen p-2 transition-colors bg-gray-50`}>
      {/* Notification */}
      {notification && (
        <div className={`fixed top-2 right-2 z-50 flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg text-sm ${
          notification.type === 'success' ? 'bg-green-500 text-white' : 
          notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
        }`}>
          {notification.type === 'success' && <Check size={16} />}
          {notification.type === 'error' && <X size={16} />}
          <span>{notification.message}</span>
        </div>
      )}

      {/* Price Change Alert Modal */}
      {showPriceAlert && priceAlertData && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-md w-full">
            <div className="bg-orange-500 text-white px-4 py-3 rounded-t-lg flex items-center justify-between">
              <h3 className="font-bold text-lg flex items-center gap-2">
                <AlertCircle size={20} />
                Preco Diferente do Registado
              </h3>
              <button
                onClick={() => {
                  console.log('Fechar modal');
                  setShowPriceAlert(false);
                  setPriceAlertData(null);
                }}
                className="hover:bg-orange-600 rounded p-1 transition"
              >
                <X size={20} />
              </button>
            </div>
            
            <div className="p-4 space-y-3">
              <div className="bg-orange-50 border border-orange-200 rounded p-3">
                <p className="text-sm font-bold text-orange-900 mb-2">{priceAlertData.ingrediente.nome}:</p>
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-700">Pre√ßo atual:</span>
                  <span className="font-semibold">‚Ç¨{priceAlertData.precoAtual.toFixed(2)}/{priceAlertData.ingrediente.unidade}</span>
                </div>
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-700">Pre√ßo novo:</span>
                  <span className="font-bold text-orange-600">‚Ç¨{priceAlertData.precoNovo.toFixed(2)}/{priceAlertData.ingrediente.unidade}</span>
                </div>
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-700">Diferen√ßa:</span>
                  <span className={`font-bold ${priceAlertData.precoNovo > priceAlertData.precoAtual ? 'text-red-600' : 'text-green-600'}`}>
                    {priceAlertData.precoNovo > priceAlertData.precoAtual ? '+' : ''}{priceAlertData.diferencaPerc.toFixed(1)}%
                  </span>
                </div>
              </div>
              
              {priceAlertData.produtosAfetados.length > 0 && (
                <div className="bg-blue-50 border border-blue-200 rounded p-3">
                  <p className="text-xs font-semibold text-blue-900 mb-2">
                    üçΩÔ∏è {priceAlertData.produtosAfetados.length} produtos afetados:
                  </p>
                  <div className="space-y-1 max-h-32 overflow-y-auto">
                    {priceAlertData.produtosAfetados.slice(0, 5).map((p, idx) => (
                      <div key={idx} className="flex justify-between items-center text-xs bg-white rounded px-2 py-1">
                        <span className="text-gray-700">{p.nome}</span>
                        <span className={`font-semibold ${p.margemDif < 0 ? 'text-red-600' : 'text-green-600'}`}>
                          margem {p.margemDif < 0 ? '‚Üì' : '‚Üë'} ‚Ç¨{Math.abs(p.margemDif).toFixed(2)}
                        </span>
                      </div>
                    ))}
                    {priceAlertData.produtosAfetados.length > 5 && (
                      <p className="text-xs text-gray-500 text-center">+ {priceAlertData.produtosAfetados.length - 5} mais...</p>
                    )}
                  </div>
                </div>
              )}
              
              <p className="text-xs text-gray-600">
                üí° Atualizar o custo base vai recalcular automaticamente as margens de todos os produtos.
              </p>
            </div>
            
            <div className="flex gap-2 px-4 pb-4">
              <button
                onClick={() => {
                  console.log('Bot√£o Ignorar clicado', priceAlertData);
                  if (priceAlertData.tipoFatura || priceAlertData.tipoOperacao) {
                    confirmarFaturaSemAtualizar();
                  } else {
                    confirmarDespesaSemAtualizar();
                  }
                }}
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded px-4 py-2 text-sm font-semibold transition"
              >
                Ignorar
              </button>
              <button
                onClick={() => {
                  console.log('Bot√£o Atualizar clicado', priceAlertData);
                  // Verificar se √© edi√ß√£o manual de ingrediente
                  if (priceAlertData.tipoFatura === 'ingrediente') {
                    console.log('   ‚Üí Edi√ß√£o manual de ingrediente');
                    atualizarIngredienteSemAlerta();
                    setShowPriceAlert(false);
                  } else if (priceAlertData.tipoFatura || priceAlertData.tipoOperacao) {
                    console.log('   ‚Üí Importa√ß√£o de fatura');
                    confirmarFaturaEAtualizar();
                  } else {
                    console.log('   ‚Üí Despesa manual');
                    confirmarDespesaEAtualizar();
                  }
                }}
                className="flex-1 bg-orange-500 hover:bg-orange-600 text-white rounded px-4 py-2 text-sm font-semibold transition"
              >
                Atualizar Custo Base
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-[1600px] mx-auto">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg shadow p-4 mb-3 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="bg-white/20 rounded-lg p-2 backdrop-blur-sm">
                <span className="text-2xl">üçΩÔ∏è</span>
              </div>
              <div>
                <h1 className="text-2xl font-bold tracking-tight">AI Munchi Manager</h1>
                <p className="text-blue-100 text-sm">Controla custos, margens e rentabilidade do teu restaurante em tempo real</p>
              </div>
            </div>
            
            {/* GitHub Sync Status - Header */}
            <div className="flex items-center gap-3">
              {GitHubSync.isConfigured() ? (
                <>
                  <div className="text-right hidden sm:block">
                    <div className="flex items-center gap-1 text-xs text-green-200">
                      <CloudCheck className="w-3 h-3" />
                      <span>Conectado</span>
                    </div>
                    <div className="text-xs text-blue-100">
                      {(() => {
                        const lastSync = GitHubSync.getLastSync();
                        if (!lastSync) return 'Nunca';
                        const now = new Date();
                        const seconds = Math.floor((now - lastSync) / 1000);
                        if (seconds < 60) return 'Agora';
                        const minutes = Math.floor(seconds / 60);
                        if (minutes < 60) return `H√° ${minutes}m`;
                        const hours = Math.floor(minutes / 60);
                        return `H√° ${hours}h`;
                      })()}
                    </div>
                  </div>
                  <button
                    onClick={async () => {
                      setIsSyncing(true);
                      const token = GitHubSync.getToken();
                      const allData = {
                        produtos,
                        ingredientes,
                        vendas,
                        despesas,
                        faturas,
                        fornecedores,
                        deliveryApps,
                        embalagens,
                        dadosEmpresa,
                        version: '2.0'
                      };
                      const result = await GitHubSync.saveToGist(allData, token);
                      if (result.success) {
                        showNotification('‚úÖ Backup sincronizado!', 'success');
                      } else {
                        showNotification(`‚ùå Erro: ${result.error}`, 'error');
                      }
                      setIsSyncing(false);
                    }}
                    disabled={isSyncing}
                    className="bg-white/20 hover:bg-white/30 disabled:bg-white/10 backdrop-blur-sm text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar backup agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    <span className="hidden sm:inline">{isSyncing ? 'A sincronizar...' : 'Sync'}</span>
                  </button>
                </>
              ) : (
                <button
                  onClick={() => setActiveTab('definicoes')}
                  className="bg-yellow-500/90 hover:bg-yellow-600 backdrop-blur-sm text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm"
                  title="Configurar backup"
                >
                  <AlertCircle className="w-4 h-4" />
                  <span className="hidden sm:inline">Configurar Backup</span>
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Main Tabs */}
        <div className={`rounded-lg shadow mb-3 bg-white`}>
          <div className="flex">
            {tabs.map(t => {
              const Icon = t.icon;
              return (
                <button key={t.id} onClick={() => setActiveTab(t.id)}
                  className={`flex items-center gap-2 px-6 py-3 font-medium border-b-2 transition text-sm ${
                    activeTab === t.id ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-600 hover:bg-gray-50'
                  }`}>
                  <Icon size={16} />{t.label}
                </button>
              );
            })}
          </div>
        </div>

        {activeTab === 'dashboard' && (
          <div className="space-y-3">
            {/* Dashboard Sub-tabs */}
            <div className="bg-white rounded-lg shadow">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'resumo', label: 'Resumo', icon: BarChart3 },
                  { id: 'metricas', label: 'M√©tricas', icon: Target },
                  { id: 'compras', label: 'Compras', icon: TrendingUp },
                  ...(deliveryApps.some(app => app.ativo) ? [{ id: 'delivery', label: 'Delivery', icon: TrendingUp }] : []),
                  { id: 'simuladores', label: 'Simuladores', icon: Calculator }
                ].map(tab => {
                  const Icon = tab.icon;
                  return (
                    <button key={tab.id} onClick={() => setDashboardSubTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 font-medium text-xs transition ${
                        dashboardSubTab === tab.id ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-blue-50'
                      }`}>
                      <Icon size={14} />{tab.label}
                    </button>
                  );
                })}
              </div>
            </div>

            

            {dashboardSubTab === 'resumo' && (
              <>
            {/* Date Filter */}
            <div className="bg-white rounded-lg shadow p-3">
              <div className="flex flex-wrap items-center gap-2">
                <span className="text-xs font-semibold text-gray-700">Per√≠odo:</span>
                <button
                  onClick={() => setDateFilter('all')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  Tudo
                </button>
                <button
                  onClick={() => setDateFilter('today')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'today' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  Hoje
                </button>
                <button
                  onClick={() => setDateFilter('week')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  √öltima Semana
                </button>
                <button
                  onClick={() => setDateFilter('month')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  √öltimo M√™s
                </button>
                <button
                  onClick={() => setDateFilter('custom')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'custom' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  Personalizado
                </button>
                
                {dateFilter === 'custom' && (
                  <div className="flex items-center gap-2 ml-2">
                    <input
                      type="date"
                      value={customStartDate}
                      onChange={(e) => setCustomStartDate(e.target.value)}
                      className="border rounded px-2 py-1 text-xs"
                    />
                    <span className="text-xs text-gray-500">at√©</span>
                    <input
                      type="date"
                      value={customEndDate}
                      onChange={(e) => setCustomEndDate(e.target.value)}
                      className="border rounded px-2 py-1 text-xs"
                    />
                  </div>
                )}
                
                {dateFilter !== 'all' && (
                  <span className="text-xs text-gray-500 ml-2">
                    üìä {filteredVendas.length} vendas ‚Ä¢ {todasDespesas.length} despesas
                  </span>
                )}
              </div>
            </div>

            {/* KPI Cards - 2 filas de 2 */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
              <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg shadow p-3 text-white">
                <p className="text-green-100 text-xs mb-1">Fatura√ß√£o</p>
                <p className="text-xl font-bold">‚Ç¨{totV.toFixed(2)}</p>
                <p className="text-green-100 text-xs">‚Ç¨{medFat.toFixed(2)}/dia</p>
              </div>

              <div className="bg-gradient-to-br from-red-500 to-pink-600 rounded-lg shadow p-3 text-white">
                <p className="text-red-100 text-xs mb-1">Despesas</p>
                <p className="text-xl font-bold">‚Ç¨{totD.toFixed(2)}</p>
                <p className="text-red-100 text-xs">Fixas: ‚Ç¨{dFixas.toFixed(2)}</p>
              </div>

              <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg shadow p-3 text-white">
                <Tooltip text="Lucro L√≠quido = Receita - Todas as Despesas. √â o dinheiro que realmente sobra no final." position="bottom">
                  <p className="text-blue-100 text-xs mb-1 flex items-center gap-1">
                    Lucro L√≠quido
                    <span className="text-blue-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className={`text-xl font-bold ${lucroLiquido >= 0 ? '' : 'text-red-200'}`}>
                  ‚Ç¨{lucroLiquido.toFixed(2)}
                </p>
                <p className="text-blue-100 text-xs">
                  {margemLiquida.toFixed(1)}% margem
                </p>
              </div>

              <div className="bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg shadow p-3 text-white">
                <p className="text-orange-100 text-xs mb-1">IVA {ivaP >= 0 ? 'Pagar' : 'Receber'} {anoAtual}</p>
                <p className="text-xl font-bold">‚Ç¨{Math.abs(ivaP).toFixed(2)}</p>
                <p className="text-orange-100 text-xs">{ivaP >= 0 ? 'Entregar' : 'Cr√©dito'}</p>
              </div>
            </div>



            {/* Todos os produtos e an√°lises em colunas lado a lado */}
            <div className="grid grid-cols-5 gap-2 overflow-x-auto">
              {/* IVA Limit */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-xs font-bold">Limite IVA {anoAtual}</h3>
                  <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${
                    totalVendasAnoAtual >= 15000 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'
                  }`}>
                    {((totalVendasAnoAtual / 15000) * 100).toFixed(0)}%
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 mb-2">
                  <div className={`h-2 rounded-full ${totalVendasAnoAtual >= 15000 ? 'bg-red-500' : 'bg-blue-500'}`} 
                    style={{ width: `${Math.min((totalVendasAnoAtual / 15000) * 100, 100)}%` }}></div>
                </div>
                <p className="text-xs text-gray-600 mb-1">‚Ç¨{totalVendasAnoAtual.toFixed(0)}</p>
                <p className="text-xs text-gray-500">de ‚Ç¨15.000</p>
              </div>

              {/* Top Vendidos */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-blue-600">üèÜ Top Vendidos</h3>
                <div className="space-y-1">
                  {top5Venda.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-blue-600 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-green-600 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {top5Venda.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>
              
              {/* Top Rent√°veis */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-green-600">üíé Top Rent√°veis</h3>
                <div className="space-y-1">
                  {top5Lucro.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-green-600 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-green-700 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {top5Lucro.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>

              {/* Pior Vendidos */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-red-600">üìâ Pior Vendidos</h3>
                <div className="space-y-1">
                  {pior5Venda.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-red-400 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-red-600 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {pior5Venda.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>

              {/* Pior Rent√°veis */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-orange-600">‚ö†Ô∏è Pior Rent√°veis</h3>
                <div className="space-y-1">
                  {pior5Lucro.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-orange-400 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-orange-700 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {pior5Lucro.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>
            </div>

            {/* An√°lise Financeira */}
            {totV > 0 && (
              <div className="bg-white rounded-lg shadow p-3">
                <h3 className="text-sm font-bold mb-2">üí° An√°lise Contabilidade</h3>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-xs font-medium">Despesas vs Fatura√ß√£o</span>
                  <span className="text-lg font-bold text-blue-600">{ratioDespesaFaturacao.toFixed(1)}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3 mb-1">
                  <div className={`h-3 rounded-full ${
                    ratioDespesaFaturacao >= 40 ? 'bg-red-500' : 
                    ratioDespesaFaturacao >= 30 ? 'bg-orange-500' : 
                    ratioDespesaFaturacao >= 20 ? 'bg-yellow-500' : 'bg-green-500'
                  }`} style={{ width: `${Math.min(ratioDespesaFaturacao, 100)}%` }}></div>
                </div>
                <div className="flex justify-between text-xs text-gray-500">
                  <span>0%</span><span>20%</span><span>30%</span><span>40%</span>
                </div>
                <div className={`mt-2 rounded p-2 text-xs ${
                  ratioDespesaFaturacao >= 40 ? 'bg-red-50 text-red-700' :
                  ratioDespesaFaturacao >= 30 ? 'bg-orange-50 text-orange-700' :
                  ratioDespesaFaturacao >= 20 ? 'bg-yellow-50 text-yellow-700' : 'bg-green-50 text-green-700'
                }`}>
                  <p className="font-bold">
                    {ratioDespesaFaturacao >= 40 ? 'üö® Passar Contab. Organizada!' :
                     ratioDespesaFaturacao >= 30 ? '‚ö†Ô∏è Pr√≥ximo limite!' :
                     ratioDespesaFaturacao >= 20 ? '‚ö° Monitorize!' : '‚úÖ Normal'}
                  </p>
                  {ratioDespesaFaturacao >= 30 && <p className="mt-1">IVA recuper√°vel: ‚Ç¨{ivaCompras.toFixed(2)}</p>}
                </div>
              </div>
            )}



              </>
            )}


            {dashboardSubTab === 'metricas' && (
              <>
              {/* Date Filter */}
              <div className="bg-white rounded-lg shadow p-3">
                <div className="flex flex-wrap items-center gap-2">
                  <span className="text-xs font-semibold text-gray-700">Per√≠odo:</span>
                  <button
                    onClick={() => setDateFilter('all')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Tudo
                  </button>
                  <button
                    onClick={() => setDateFilter('today')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'today' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Hoje
                  </button>
                  <button
                    onClick={() => setDateFilter('week')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    √öltima Semana
                  </button>
                  <button
                    onClick={() => setDateFilter('month')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    √öltimo M√™s
                  </button>
                  <button
                    onClick={() => setDateFilter('custom')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'custom' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Personalizado
                  </button>
                  
                  {dateFilter === 'custom' && (
                    <div className="flex items-center gap-2 ml-2">
                      <input
                        type="date"
                        value={customStartDate}
                        onChange={(e) => setCustomStartDate(e.target.value)}
                        className="border rounded px-2 py-1 text-xs"
                      />
                      <span className="text-xs text-gray-500">at√©</span>
                      <input
                        type="date"
                        value={customEndDate}
                        onChange={(e) => setCustomEndDate(e.target.value)}
                        className="border rounded px-2 py-1 text-xs"
                      />
                    </div>
                  )}
                  
                  {dateFilter !== 'all' && (
                    <span className="text-xs text-gray-500 ml-2">
                      ({filteredVendas.length} vendas ‚Ä¢ ‚Ç¨{totV.toFixed(2)})
                    </span>
                  )}
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 1: KPIs PRINCIPAIS */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üìä KPIs Principais
                </h2>
                <p className="text-xs text-gray-600 mb-3">Indicadores chave de performance do restaurante</p>
                
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                  {/* Ticket M√©dio */}
                  <div className="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                    <p className="text-xs text-blue-700 mb-1 font-semibold">üí∂ Ticket M√©dio</p>
                    <p className="text-2xl font-bold text-blue-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (totV / filteredVendas.length).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-blue-600 mt-1">Por venda</p>
                  </div>
                  
                  {/* Food Cost % */}
                  <div className="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                    <p className="text-xs text-purple-700 mb-1 font-semibold">üçΩÔ∏è Food Cost %</p>
                    <p className={`text-2xl font-bold ${
                      foodCostPercentage > 40 ? 'text-red-700' :
                      foodCostPercentage > 35 ? 'text-orange-700' : 'text-purple-900'
                    }`}>
                      {foodCostPercentage.toFixed(1)}%
                    </p>
                    <p className="text-xs text-purple-600 mt-1">Ideal: 25-35%</p>
                  </div>
                  
                  {/* Labor Cost % */}
                  <div className="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                    <p className="text-xs text-orange-700 mb-1 font-semibold">üë• Labor Cost %</p>
                    <p className={`text-2xl font-bold ${
                      laborCostPercentage > 35 ? 'text-red-700' : 
                      laborCostPercentage > 30 ? 'text-orange-700' : 'text-orange-900'
                    }`}>
                      {laborCostPercentage.toFixed(1)}%
                    </p>
                    <p className="text-xs text-orange-600 mt-1">Ideal: 25-30%</p>
                  </div>
                  
                  {/* Prime Cost % - THE KING */}
                  <div className="bg-gradient-to-br from-red-50 to-pink-50 rounded-lg p-4 border-l-4 border-red-500">
                    <p className="text-xs text-red-700 mb-1 font-bold flex items-center gap-1">
                      ‚ö° Prime Cost % <span className="text-[10px] bg-red-200 px-1 rounded">REI</span>
                    </p>
                    <p className={`text-2xl font-bold ${
                      primeCostPercentage > 65 ? 'text-red-700' :
                      primeCostPercentage > 60 ? 'text-orange-700' : 'text-green-700'
                    }`}>
                      {primeCostPercentage.toFixed(1)}%
                    </p>
                    <p className="text-xs text-red-600 mt-1">Ideal: 55-60%</p>
                  </div>
                </div>
                
                {/* Prime Cost Explanation */}
                <div className="mt-3 bg-red-50 border border-red-200 rounded-lg p-3">
                  <p className="text-xs text-red-800">
                    <strong>‚ö° Prime Cost</strong> = Food Cost + Labor Cost = 
                    <strong> ‚Ç¨{primeCostTotal.toFixed(2)}</strong> ({primeCostPercentage.toFixed(1)}%)
                    <br/>
                    √â o indicador MAIS importante! Se &gt;65% = problemas graves. Se &lt;60% = excelente gest√£o! üéØ
                  </p>
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 2: BREAK-EVEN & EFICI√äNCIA */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üí∞ Break-Even & Efici√™ncia
                </h2>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
                  {/* Break-Even Point */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-300">
                    <p className="text-xs text-green-700 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="O Break-Even √© o valor m√≠nimo que precisas de faturar para cobrir todos os custos fixos (renda, sal√°rios, utilities) e vari√°veis (ingredientes). Abaixo deste valor, est√°s a ter preju√≠zo." position="bottom">
                        <span className="flex items-center gap-1">
                          üéØ Break-Even Point
                          <span className="text-green-500 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    <p className="text-3xl font-bold text-green-900 mb-1">
                      {breakEvenPoint > 0 ? `‚Ç¨${breakEvenPoint.toFixed(0)}` : 'N/A'}
                    </p>
                    <p className="text-xs text-green-700 mb-2">
                      {breakEvenPoint > 0 ? 'Mensal - Fatura√ß√£o necess√°ria' : 'Adicione despesas fixas'}
                    </p>
                    
                    <div className="bg-white rounded p-2 text-xs space-y-1 mb-2">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Fatura√ß√£o atual:</span>
                        <span className="font-semibold">‚Ç¨{totV.toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Margem seguran√ßa:</span>
                        <span className={`font-bold ${
                          totV >= breakEvenPoint ? 'text-green-600' : 'text-red-600'
                        }`}>
                          ‚Ç¨{(totV - breakEvenPoint).toFixed(2)}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Status:</span>
                        <span className={`font-bold ${
                          totV >= breakEvenPoint * 1.2 ? 'text-green-600' : 
                          totV >= breakEvenPoint ? 'text-yellow-600' : 'text-red-600'
                        }`}>
                          {totV >= breakEvenPoint * 1.2 ? '‚úÖ Excelente' : 
                           totV >= breakEvenPoint ? '‚ö†Ô∏è No limite' : 'üö® Abaixo'}
                        </span>
                      </div>
                    </div>
                    
                    {/* Break-Even Di√°rio */}
                    <div className="bg-green-100 border border-green-300 rounded p-2 text-xs">
                      <p className="font-bold text-green-900 mb-1">üìÖ Break-Even Di√°rio ({diasUteis} dias):</p>
                      <div className="space-y-0.5">
                        <div className="flex justify-between">
                          <span className="text-green-700">Fatura√ß√£o/dia:</span>
                          <span className="font-bold text-green-900">‚Ç¨{breakEvenDiario.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-green-700">Vendas necess√°rias:</span>
                          <span className="font-bold text-green-900">{Math.ceil(vendasNecessariasPorDia)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-green-700">Margem/venda:</span>
                          <span className="font-bold text-green-900">‚Ç¨{margemPorVenda.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Efficiency per Employee */}
                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-300">
                    <p className="text-xs text-blue-700 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="Mostra quanto cada colaborador gera de receita em m√©dia. Um valor alto indica boa produtividade. Benchmark: ‚Ç¨2000-3000/m√™s por pessoa em caf√©s/restaurantes." position="bottom">
                        <span className="flex items-center gap-1">
                          üë§ Efici√™ncia por Colaborador
                          <span className="text-blue-400 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    <p className="text-3xl font-bold text-blue-900 mb-1">
                      ‚Ç¨{revenuePerEmployee.toFixed(0)}
                    </p>
                    <p className="text-xs text-blue-700 mb-2">Fatura√ß√£o por colaborador</p>
                    
                    <div className="bg-white rounded p-2 text-xs space-y-1">
                      <div className="flex justify-between">
                        <span className="text-gray-600">N¬∫ Colaboradores:</span>
                        <span className="font-semibold">{numEmployees}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Vendas/Pessoa:</span>
                        <span className="font-semibold">{salesPerEmployee.toFixed(1)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Custo/Pessoa:</span>
                        <span className="font-semibold">
                          ‚Ç¨{numEmployees > 0 ? (totalSalarios / numEmployees).toFixed(0) : '0'}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Salary Calculator */}
                  <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-400">
                    <p className="text-xs text-yellow-800 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="Calcula quantos colaboradores podes contratar com o lucro dispon√≠vel. Inclui sal√°rio base + subs√≠dio f√©rias + subs√≠dio natal + TSU (23.75%). Baseado nos escal√µes legais portugueses." position="bottom">
                        <span className="flex items-center gap-1">
                          üí∞ Calculadora de Ordenados
                          <span className="text-yellow-600 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    {(() => {
                      // Calcular lucro dispon√≠vel
                      const lucroDisponivel = lucroReal - fixedCosts;
                      
                      // Fun√ß√£o para calcular custo real de um ordenado
                      const calcularCustoOrdenado = (salarioBase) => {
                        const salarioComSubsidios = salarioBase + salarioBase / 12 * 2; // +F√©rias +Natal
                        return salarioComSubsidios * 1.2375; // +TSU 23.75%
                      };
                      
                      // Escal√µes
                      const partTime = 460;
                      const ordenadoMinimo = 920;
                      
                      const custoPartTime = calcularCustoOrdenado(partTime);
                      const custoMinimo = calcularCustoOrdenado(ordenadoMinimo);
                      
                      // Gerar sugest√µes
                      const sugestoes = [];
                      
                      // Op√ß√£o 1: M√°ximo de part-times
                      const maxPartTimes = Math.floor(lucroDisponivel / custoPartTime);
                      if (maxPartTimes > 0) {
                        sugestoes.push({
                          tipo: `${maxPartTimes}√ó Part-time`,
                          detalhes: `${maxPartTimes}√ó ‚Ç¨${partTime}`,
                          custo: maxPartTimes * custoPartTime,
                          sobra: lucroDisponivel - (maxPartTimes * custoPartTime)
                        });
                      }
                      
                      // Op√ß√£o 2: Mix ordenado m√≠nimo + part-times
                      const maxMinimos = Math.floor(lucroDisponivel / custoMinimo);
                      if (maxMinimos > 0) {
                        const sobraAposMinimos = lucroDisponivel - (maxMinimos * custoMinimo);
                        const partTimesExtras = Math.floor(sobraAposMinimos / custoPartTime);
                        
                        if (partTimesExtras > 0) {
                          sugestoes.push({
                            tipo: `${maxMinimos}√ó M√≠nimo + ${partTimesExtras}√ó Part-time`,
                            detalhes: `${maxMinimos}√ó ‚Ç¨${ordenadoMinimo} + ${partTimesExtras}√ó ‚Ç¨${partTime}`,
                            custo: (maxMinimos * custoMinimo) + (partTimesExtras * custoPartTime),
                            sobra: lucroDisponivel - ((maxMinimos * custoMinimo) + (partTimesExtras * custoPartTime))
                          });
                        } else {
                          sugestoes.push({
                            tipo: `${maxMinimos}√ó Ordenado M√≠nimo`,
                            detalhes: `${maxMinimos}√ó ‚Ç¨${ordenadoMinimo}`,
                            custo: maxMinimos * custoMinimo,
                            sobra: lucroDisponivel - (maxMinimos * custoMinimo)
                          });
                        }
                      }
                      
                      // Op√ß√£o 3: Pr√≥ximo escal√£o (imposs√≠vel)
                      const proximoEscalao = maxMinimos + 1;
                      const custoProximoEscalao = proximoEscalao * custoMinimo;
                      const faltam = custoProximoEscalao - lucroDisponivel;
                      
                      return (
                        <>
                          <p className="text-lg font-bold text-yellow-900 mb-2">
                            Dispon√≠vel: ‚Ç¨{lucroDisponivel.toFixed(0)}
                          </p>
                          <p className="text-xs text-yellow-700 mb-3">
                            Lucro - Custos Fixos = {lucroReal.toFixed(0)} - {fixedCosts.toFixed(0)}
                          </p>
                          
                          <div className="bg-white rounded p-2 text-xs space-y-2">
                            {sugestoes.slice(0, 2).map((s, i) => (
                              <div key={i} className="pb-2 border-b border-yellow-200 last:border-0">
                                <p className="font-bold text-green-700 mb-1">‚úÖ {s.tipo}</p>
                                <div className="flex justify-between text-gray-600">
                                  <span>{s.detalhes}</span>
                                  <span className="font-semibold">‚Ç¨{s.custo.toFixed(0)}</span>
                                </div>
                                <p className="text-green-600 text-[10px] mt-0.5">Sobra: ‚Ç¨{s.sobra.toFixed(0)}</p>
                              </div>
                            ))}
                            
                            {faltam > 0 && (
                              <div className="pt-1">
                                <p className="font-bold text-red-700 mb-1">‚ùå {proximoEscalao}√ó Ordenado M√≠nimo</p>
                                <p className="text-red-600 text-[10px]">Faltam: ‚Ç¨{faltam.toFixed(0)}</p>
                              </div>
                            )}
                          </div>
                          
                          <p className="text-[10px] text-yellow-700 mt-2">
                            üí° Custo inclui: sal√°rio + f√©rias + natal + TSU (23.75%)
                          </p>
                        </>
                      );
                    })()}
                  </div>
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 3: M√âDIA DI√ÅRIA (movido para c√°) */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üìÖ Desempenho Di√°rio
                </h2>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
                  {/* Daily Average */}
                  <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border-2 border-purple-300">
                    <p className="text-xs text-purple-700 mb-2 font-bold flex items-center gap-1">
                      üìä M√©dia Di√°ria
                    </p>
                    <p className="text-3xl font-bold text-purple-900 mb-1">
                      ‚Ç¨{medFat.toFixed(0)}
                    </p>
                    <p className="text-xs text-purple-700 mb-2">Fatura√ß√£o m√©dia por dia</p>
                    
                    <div className="bg-white rounded p-2 text-xs space-y-1">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Dias ativos:</span>
                        <span className="font-semibold">{dias}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Vendas/Dia:</span>
                        <span className="font-semibold">
                          {dias > 0 ? (filteredVendas.length / dias).toFixed(1) : '0'}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Produtos/Dia:</span>
                        <span className="font-semibold">
                          {dias > 0 ? (filteredVendas.reduce((s, v) => s + v.quantidade, 0) / dias).toFixed(1) : '0'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION: AN√ÅLISE MENSAL COMPARATIVA */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üìÖ An√°lise Mensal Comparativa
                </h2>
                
                {(() => {
                  const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                  ];
                  
                  // Fun√ß√£o para calcular m√©tricas de um m√™s
                  const calcularMetricasMes = (mes, ano) => {
                    const vendasMes = vendas.filter(v => {
                      const d = new Date(v.data);
                      return d.getMonth() === mes && d.getFullYear() === ano;
                    });
                    
                    const despesasMes = despesas.filter(d => {
                      const data = new Date(d.data);
                      return data.getMonth() === mes && data.getFullYear() === ano;
                    });
                    
                    const faturacao = vendasMes.reduce((s, v) => s + v.valor, 0);
                    const custosDespesas = despesasMes.reduce((s, d) => s + d.valor, 0);
                    const lucroVendas = vendasMes.reduce((s, v) => s + calcLucroVenda(v).lucro, 0);
                    const lucroTotal = lucroVendas - custosDespesas;
                    
                    // Produto mais vendido
                    const produtosPorQtd = {};
                    vendasMes.forEach(v => {
                      produtosPorQtd[v.produto] = (produtosPorQtd[v.produto] || 0) + v.quantidade;
                    });
                    
                    const entries = Object.entries(produtosPorQtd);
                    const maisVendido = entries.length > 0 
                      ? entries.sort((a, b) => b[1] - a[1])[0]
                      : null;
                    const menosVendido = entries.length > 0
                      ? entries.sort((a, b) => a[1] - b[1])[0]
                      : null;
                    
                    return {
                      faturacao,
                      lucroTotal,
                      totalVendas: vendasMes.length,
                      totalQuantidade: vendasMes.reduce((s, v) => s + v.quantidade, 0),
                      maisVendido: maisVendido ? { nome: maisVendido[0], qtd: maisVendido[1] } : null,
                      menosVendido: menosVendido ? { nome: menosVendido[0], qtd: menosVendido[1] } : null
                    };
                  };
                  
                  const mesAtual = calcularMetricasMes(mesSelecionado, anoSelecionado);
                  
                  // M√™s anterior
                  const mesAnteriorNum = mesSelecionado === 0 ? 11 : mesSelecionado - 1;
                  const anoAnteriorNum = mesSelecionado === 0 ? anoSelecionado - 1 : anoSelecionado;
                  const mesAnterior = calcularMetricasMes(mesAnteriorNum, anoAnteriorNum);
                  
                  // C√°lculo de varia√ß√µes
                  const variacaoFaturacao = mesAnterior.faturacao > 0 
                    ? ((mesAtual.faturacao - mesAnterior.faturacao) / mesAnterior.faturacao) * 100 
                    : 0;
                  const variacaoLucro = mesAnterior.lucroTotal > 0
                    ? ((mesAtual.lucroTotal - mesAnterior.lucroTotal) / mesAnterior.lucroTotal) * 100
                    : 0;
                  const variacaoVendas = mesAnterior.totalVendas > 0
                    ? ((mesAtual.totalVendas - mesAnterior.totalVendas) / mesAnterior.totalVendas) * 100
                    : 0;
                  
                  // Verificar se restaurante estava aberto no ano anterior
                  const dataAbertura = new Date('2025-08-01'); // Agosto 2025
                  const mesAnoAnterior = new Date(anoSelecionado - 1, mesSelecionado);
                  const temDadosAnoAnterior = mesAnoAnterior >= dataAbertura;
                  
                  return (
                    <div>
                      {/* Seletor de M√™s */}
                      <div className="mb-4 flex flex-wrap gap-2">
                        {meses.map((mes, idx) => (
                          <button
                            key={idx}
                            onClick={() => setMesSelecionado(idx)}
                            className={`px-3 py-1 rounded text-sm font-semibold transition ${
                              mesSelecionado === idx
                                ? 'bg-blue-600 text-white shadow-lg'
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                          >
                            {mes.substring(0, 3)}
                          </button>
                        ))}
                      </div>
                      
                      {/* Card do M√™s */}
                      <div className="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-6">
                        <h3 className="text-2xl font-bold text-blue-900 mb-4">
                          üìÖ {meses[mesSelecionado]} {anoSelecionado}
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {/* Fatura√ß√£o */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üí∞ Fatura√ß√£o Total</div>
                            <div className="text-2xl font-bold text-green-600">
                              ‚Ç¨{mesAtual.faturacao.toFixed(2)}
                            </div>
                            {mesAnterior.faturacao > 0 && (
                              <div className={`text-sm mt-1 ${variacaoFaturacao >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                vs {meses[mesAnteriorNum]}: {variacaoFaturacao >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoFaturacao).toFixed(1)}%
                                <span className="text-gray-600 ml-1">
                                  ({variacaoFaturacao >= 0 ? '+' : ''}‚Ç¨{(mesAtual.faturacao - mesAnterior.faturacao).toFixed(2)})
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Lucro */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üèÜ Lucro Total</div>
                            <div className={`text-2xl font-bold ${mesAtual.lucroTotal >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                              ‚Ç¨{mesAtual.lucroTotal.toFixed(2)}
                            </div>
                            {mesAnterior.lucroTotal !== 0 && (
                              <div className={`text-sm mt-1 ${variacaoLucro >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                vs {meses[mesAnteriorNum]}: {variacaoLucro >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoLucro).toFixed(1)}%
                                <span className="text-gray-600 ml-1">
                                  ({variacaoLucro >= 0 ? '+' : ''}‚Ç¨{(mesAtual.lucroTotal - mesAnterior.lucroTotal).toFixed(2)})
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Total Vendas */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üì¶ Total Vendas</div>
                            <div className="text-2xl font-bold text-purple-600">
                              {mesAtual.totalQuantidade} un
                            </div>
                            {mesAnterior.totalVendas > 0 && (
                              <div className={`text-sm mt-1 ${variacaoVendas >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                vs {meses[mesAnteriorNum]}: {variacaoVendas >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoVendas).toFixed(1)}%
                                <span className="text-gray-600 ml-1">
                                  ({variacaoVendas >= 0 ? '+' : ''}{mesAtual.totalVendas - mesAnterior.totalVendas} vendas)
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Produto Mais Vendido */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">ü•á Mais Vendido</div>
                            {mesAtual.maisVendido ? (
                              <>
                                <div className="text-lg font-bold text-amber-600">
                                  {mesAtual.maisVendido.nome}
                                </div>
                                <div className="text-sm text-gray-600">
                                  {mesAtual.maisVendido.qtd}x vendidas
                                </div>
                                {mesAnterior.maisVendido && mesAnterior.maisVendido.nome !== mesAtual.maisVendido.nome && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    {meses[mesAnteriorNum]}: {mesAnterior.maisVendido.nome}
                                  </div>
                                )}
                              </>
                            ) : (
                              <div className="text-gray-400">Sem dados</div>
                            )}
                          </div>
                          
                          {/* Produto Menos Vendido */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üìâ Menos Vendido</div>
                            {mesAtual.menosVendido ? (
                              <>
                                <div className="text-lg font-bold text-gray-600">
                                  {mesAtual.menosVendido.nome}
                                </div>
                                <div className="text-sm text-gray-600">
                                  {mesAtual.menosVendido.qtd}x vendidas
                                </div>
                                {mesAnterior.menosVendido && mesAnterior.menosVendido.nome !== mesAtual.menosVendido.nome && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    {meses[mesAnteriorNum]}: {mesAnterior.menosVendido.nome}
                                  </div>
                                )}
                              </>
                            ) : (
                              <div className="text-gray-400">Sem dados</div>
                            )}
                          </div>
                        </div>
                        
                        {/* Nota sobre ano anterior */}
                        {!temDadosAnoAnterior && (
                          <div className="mt-4 bg-blue-100 border border-blue-300 rounded-lg p-3">
                            <p className="text-sm text-blue-800">
                              ‚ÑπÔ∏è <strong>Compara√ß√£o com {meses[mesSelecionado]} {anoSelecionado - 1}:</strong> Dados n√£o dispon√≠veis
                              <br/>
                              <span className="text-xs">(Restaurante aberto desde Agosto 2025)</span>
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* ============================================ */}
              {/* SECTION: M√âTRICAS POR PRODUTO (GERAL) */}
              {/* ============================================ */}

              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üìä Desempenho por Produto
                </h2>
                
                {/* Filtros de Categoria */}
                <div className="mb-4 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                  <p className="text-xs font-semibold text-gray-700 mb-2">Filtrar por categoria:</p>
                  <div className="flex flex-wrap gap-2">
                    {[
                      { id: 'todos', label: 'üìä Todos', color: 'gray' },
                      { id: 'cafes', label: '‚òï Caf√©s', color: 'amber' },
                      { id: 'bebidas', label: 'ü•§ Bebidas', color: 'blue' },
                      { id: 'pratos', label: 'üç≥ Pratos', color: 'orange' },
                      { id: 'sobremesas', label: 'üç∞ Sobremesas', color: 'pink' },
                      { id: 'takeaway', label: 'üì¶ Take Away', color: 'green' }
                    ].map(cat => (
                      <button
                        key={cat.id}
                        onClick={() => setCategoriaFiltroDesempenho(cat.id)}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm ${
                          categoriaFiltroDesempenho === cat.id
                            ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg scale-105'
                            : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'
                        }`}
                      >
                        {cat.label}
                      </button>
                    ))}
                  </div>
                </div>
                
                <p className="text-xs text-gray-600 mb-3">
                  Ranking de vendas, lucro e margens
                  {categoriaFiltroDesempenho !== 'todos' && (
                    <span className="font-bold text-blue-600"> - {categoriaFiltroDesempenho}</span>
                  )}
                </p>
                
                {(() => {
                  // Calcular vendas por produto
                  const vendasPorProduto = {};
                  
                  filteredVendas.forEach(v => {
                    if (!vendasPorProduto[v.produto]) {
                      vendasPorProduto[v.produto] = {
                        nome: v.produto,
                        quantidade: 0,
                        faturacao: 0,
                        lucro: 0
                      };
                    }
                    
                    // Arredondar TUDO para evitar erros de ponto flutuante
                    vendasPorProduto[v.produto].quantidade = Math.round((vendasPorProduto[v.produto].quantidade + v.quantidade) * 100) / 100;
                    vendasPorProduto[v.produto].faturacao = Math.round((vendasPorProduto[v.produto].faturacao + v.valor) * 100) / 100;
                    vendasPorProduto[v.produto].lucro = Math.round((vendasPorProduto[v.produto].lucro + calcLucroVenda(v).lucro) * 100) / 100;
                  });
                  
                  const produtosArray = Object.values(vendasPorProduto)
                    .sort((a, b) => b.faturacao - a.faturacao);
                  
                  // Aplicar filtro de categoria
                  let produtosFiltrados = produtosArray;
                  if (categoriaFiltroDesempenho !== 'todos') {
                    produtosFiltrados = produtosArray.filter(pVenda => {
                      const produto = produtos.find(p => p.nome === pVenda.nome);
                      return produto && produto.categoria === categoriaFiltroDesempenho;
                    });
                  }
                  
                  if (produtosFiltrados.length === 0) {
                    return (
                      <div className="text-center py-8 bg-gray-50 rounded-lg">
                        <p className="text-gray-600">
                          üì¶ Sem vendas de produtos da categoria "{categoriaFiltroDesempenho}" no per√≠odo selecionado
                        </p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gradient-to-r from-blue-100 to-indigo-100 border-b-2 border-blue-300">
                            <th className="text-left p-2 font-bold text-blue-900">#</th>
                            <th className="text-left p-2 font-bold text-blue-900">Produto</th>
                            <th className="text-right p-2 font-bold text-blue-900">Qtd Vendida</th>
                            <th className="text-right p-2 font-bold text-blue-900">Fatura√ß√£o</th>
                            <th className="text-right p-2 font-bold text-blue-900">Lucro</th>
                            <th className="text-right p-2 font-bold text-blue-900">Margem %</th>
                            <th className="text-right p-2 font-bold text-blue-900">Ticket M√©dio</th>
                          </tr>
                        </thead>
                        <tbody>
                          {produtosFiltrados.map((p, idx) => {
                            const margemPerc = p.faturacao > 0 ? (p.lucro / p.faturacao) * 100 : 0;
                            const ticketMedio = p.quantidade > 0 ? p.faturacao / p.quantidade : 0;
                            
                            // Verificar se produto tem receita
                            const produto = produtos.find(pr => pr.nome === p.nome);
                            const temReceita = produto && produto.receita && produto.receita.length > 0;
                            
                            // DEBUG apenas para primeiro produto
                            if (idx === 0) {
                              console.log('üîç DEBUG Desempenho:');
                              console.log('  Total produtos:', produtos.length);
                              console.log('  Produto #1:', p.nome);
                              console.log('  Encontrado?', !!produto);
                              if (produto) {
                                console.log('  Receita:', produto.receita?.length || 0, 'ingredientes');
                                console.log('  Campos:', Object.keys(produto));
                              }
                            }
                            
                            return (
                              <tr key={p.nome} className="border-b hover:bg-blue-50 transition">
                                <td className="p-2 font-bold text-blue-600">#{idx + 1}</td>
                                <td className="p-2 font-semibold">
                                  {p.nome}
                                  {!temReceita && (
                                    <span className="ml-2 text-xs text-orange-600 font-bold" title="Produto sem receita - margem n√£o calculada">
                                      ‚ö†Ô∏è
                                    </span>
                                  )}
                                </td>
                                <td className="p-2 text-right font-semibold">{p.quantidade}</td>
                                <td className="p-2 text-right font-semibold text-green-700">‚Ç¨{p.faturacao.toFixed(2)}</td>
                                <td className="p-2 text-right font-semibold text-blue-700">‚Ç¨{p.lucro.toFixed(2)}</td>
                                <td className={`p-2 text-right font-bold ${
                                  !temReceita ? 'text-red-600' :
                                  margemPerc > 60 ? 'text-green-600' :
                                  margemPerc > 40 ? 'text-blue-600' : 'text-orange-600'
                                }`}>
                                  {!temReceita && '‚ö†Ô∏è '}
                                  {margemPerc.toFixed(1)}%
                                </td>
                                <td className="p-2 text-right text-gray-700">‚Ç¨{ticketMedio.toFixed(2)}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                        <tfoot>
                          <tr className="bg-gradient-to-r from-gray-100 to-gray-200 border-t-2 border-gray-400 font-bold">
                            <td className="p-2" colspan="2">TOTAL</td>
                            <td className="p-2 text-right text-blue-900">
                              {produtosFiltrados.reduce((s, p) => s + p.quantidade, 0)}
                            </td>
                            <td className="p-2 text-right text-green-700">
                              ‚Ç¨{produtosFiltrados.reduce((s, p) => s + p.faturacao, 0).toFixed(2)}
                            </td>
                            <td className="p-2 text-right text-blue-700">
                              ‚Ç¨{produtosFiltrados.reduce((s, p) => s + p.lucro, 0).toFixed(2)}
                            </td>
                            <td className="p-2 text-right text-gray-700">
                              {(() => {
                                const totalFat = produtosFiltrados.reduce((s, p) => s + p.faturacao, 0);
                                const totalLucro = produtosFiltrados.reduce((s, p) => s + p.lucro, 0);
                                return totalFat > 0 ? ((totalLucro / totalFat) * 100).toFixed(1) : '0.0';
                              })()}%
                            </td>
                            <td className="p-2 text-right text-gray-700">
                              ‚Ç¨{(() => {
                                const totalQtd = produtosFiltrados.reduce((s, p) => s + p.quantidade, 0);
                                const totalFat = produtosFiltrados.reduce((s, p) => s + p.faturacao, 0);
                                return totalQtd > 0 ? (totalFat / totalQtd).toFixed(2) : '0.00';
                              })()}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  );
                })()}
              </div>

              {/* ============================================ */}
              {/* SECTION: M√âTRICAS POR CATEGORIA */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  <Tooltip text="Agrupa as vendas por tipo de produto (Caf√©s, Lanches, Sobremesas, etc). √ötil para identificar quais categorias geram mais receita e t√™m melhores margens." position="right">
                    <span className="flex items-center gap-2">
                      üìä M√©tricas por Categoria de Produto
                      <span className="text-gray-400 text-lg">‚ìò</span>
                    </span>
                  </Tooltip>
                </h2>
                <p className="text-xs text-gray-600 mb-3">Vendas agrupadas por categoria (Caf√©s, Bebidas, Pratos, Sobremesas...)</p>
                
                {(() => {
                  // Agrupar vendas por categoria de produto
                  const vendasPorCategoria = {};
                  
                  filteredVendas.forEach(v => {
                    // Encontrar o produto para pegar a categoria
                    const produto = produtos.find(p => p.nome === v.produto);
                    const categoria = produto?.categoria || 'outros';
                    
                    if (!vendasPorCategoria[categoria]) {
                      vendasPorCategoria[categoria] = {
                        quantidade: 0,
                        faturacao: 0,
                        lucro: 0
                      };
                    }
                    
                    // Arredondar TUDO para evitar erros de ponto flutuante
                    vendasPorCategoria[categoria].quantidade = Math.round((vendasPorCategoria[categoria].quantidade + v.quantidade) * 100) / 100;
                    vendasPorCategoria[categoria].faturacao = Math.round((vendasPorCategoria[categoria].faturacao + v.valor) * 100) / 100;
                    vendasPorCategoria[categoria].lucro = Math.round((vendasPorCategoria[categoria].lucro + calcLucroVenda(v).lucro) * 100) / 100;
                  });
                  
                  const categorias = {
                    'cafes': { nome: '‚òï Caf√©s', cor: 'brown' },
                    'bebidas': { nome: 'ü•§ Bebidas', cor: 'blue' },
                    'pratos': { nome: 'üçΩÔ∏è Pratos', cor: 'orange' },
                    'sobremesas': { nome: 'üç∞ Sobremesas', cor: 'pink' },
                    'lanches': { nome: 'ü•™ Lanches', cor: 'yellow' },
                    'outros': { nome: 'üì¶ Outros', cor: 'gray' }
                  };
                  
                  const categoriasComDados = Object.entries(vendasPorCategoria)
                    .filter(([_, dados]) => dados.quantidade > 0)
                    .sort((a, b) => b[1].faturacao - a[1].faturacao);
                  
                  if (categoriasComDados.length === 0) {
                    return (
                      <div className="text-center py-8 bg-gray-50 rounded-lg">
                        <p className="text-gray-600">üì¶ Sem vendas no per√≠odo selecionado</p>
                        <p className="text-xs text-gray-500 mt-2">Adicione produtos com categorias para ver m√©tricas</p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
                      {categoriasComDados.map(([cat, dados]) => {
                        const info = categorias[cat] || { nome: cat, cor: 'gray' };
                        const margemPerc = dados.faturacao > 0 ? (dados.lucro / dados.faturacao) * 100 : 0;
                        
                        return (
                          <div key={cat} className={`bg-${info.cor}-50 border-2 border-${info.cor}-300 rounded-lg p-3`}>
                            <p className="text-xs font-bold mb-1">{info.nome}</p>
                            <p className="text-2xl font-bold text-gray-900 mb-1">
                              {Math.round(dados.quantidade)}
                            </p>
                            <p className="text-xs text-gray-600 mb-2">unidades vendidas</p>
                            
                            <div className="bg-white rounded p-2 text-xs space-y-1">
                              <div className="flex justify-between">
                                <span className="text-gray-600">Fatura√ß√£o:</span>
                                <span className="font-bold text-green-700">‚Ç¨{dados.faturacao.toFixed(0)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Lucro:</span>
                                <span className="font-bold text-blue-700">‚Ç¨{dados.lucro.toFixed(0)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Margem:</span>
                                <span className={`font-bold ${
                                  margemPerc > 60 ? 'text-green-600' :
                                  margemPerc > 40 ? 'text-blue-600' : 'text-orange-600'
                                }`}>
                                  {margemPerc.toFixed(1)}%
                                </span>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>

              {/* ============================================ */}
              {/* SECTION 3: AN√ÅLISE POR CLIENTE */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3">üë§ An√°lise por Cliente</h2>
                <p className="text-xs text-gray-600 mb-3">Custos e margens por venda individual</p>
                
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
                  <div className="bg-blue-50 rounded p-3 border-l-4 border-blue-500">
                    <p className="text-xs text-blue-700 mb-1">Custo Alimentos</p>
                    <p className="text-lg font-bold text-blue-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (
                        todasDespesas
                          .filter(d => d.categoria === 'compras' || d.origem === 'fatura')
                          .reduce((s, d) => s + d.valor, 0) / filteredVendas.length
                      ).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-blue-600 mt-1">Por venda</p>
                  </div>
                  
                  <div className="bg-purple-50 rounded p-3 border-l-4 border-purple-500">
                    <p className="text-xs text-purple-700 mb-1">Custo Consum√≠veis</p>
                    <p className="text-lg font-bold text-purple-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (
                        todasDespesas
                          .filter(d => d.categoria === 'consumiveis')
                          .reduce((s, d) => s + d.valor, 0) / filteredVendas.length
                      ).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-purple-600 mt-1">Por venda</p>
                  </div>
                  
                  <div className="bg-orange-50 rounded p-3 border-l-4 border-orange-500">
                    <p className="text-xs text-orange-700 mb-1">Pre√ßo M√©dio Venda</p>
                    <p className="text-lg font-bold text-orange-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (totV / filteredVendas.length).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-orange-600 mt-1">Por venda</p>
                  </div>
                  
                  <div className="bg-green-50 rounded p-3 border-l-4 border-green-500">
                    <p className="text-xs text-green-700 mb-1">Margem por Cliente</p>
                    <p className="text-lg font-bold text-green-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (
                        (totV - filteredDespesas.filter(d => d.categoria === 'compras' || d.categoria === 'consumiveis').reduce((s, d) => s + d.valor, 0)) / filteredVendas.length
                      ).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-green-600 mt-1">Por venda</p>
                  </div>
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 4: FISCAL (IVA) */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3">üßÆ An√°lise Fiscal (IVA)</h2>
                
                <div className="grid grid-cols-3 gap-3 mb-3">
                  <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                    <p className="text-xs text-green-700 mb-1 font-semibold">IVA Vendas</p>
                    <p className="text-xl font-bold text-green-900">
                      ‚Ç¨{filteredVendas.reduce((s, v) => {
                        // Vendas podem ter produtoId OU produto (nome)
                        const prod = v.produtoId 
                          ? produtos.find(p => p.id === v.produtoId)
                          : produtos.find(p => p.nome.toLowerCase() === v.produto.toLowerCase());
                        if (!prod) return s;
                        const precoSemIva = prod.precoVenda / (1 + prod.iva / 100);
                        return s + (prod.precoVenda - precoSemIva) * v.quantidade;
                      }, 0).toFixed(2)}
                    </p>
                    <p className="text-xs text-green-600 mt-1">Cobrado aos clientes</p>
                  </div>
                  
                  <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <p className="text-xs text-blue-700 mb-1 font-semibold">IVA Compras</p>
                    <p className="text-xl font-bold text-blue-900">
                      ‚Ç¨{ivaCompras.toFixed(2)}
                    </p>
                    <p className="text-xs text-blue-600 mt-1">Dedut√≠vel (faturas)</p>
                  </div>
                  
                  <div className={`rounded-lg p-4 border ${ivaP >= 0 ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200'}`}>
                    <p className={`text-xs mb-1 font-semibold ${ivaP >= 0 ? 'text-orange-700' : 'text-green-700'}`}>
                      {ivaP >= 0 ? 'IVA a Pagar' : 'IVA a Receber'} {anoAtual}
                    </p>
                    <p className={`text-xl font-bold ${ivaP >= 0 ? 'text-orange-900' : 'text-green-900'}`}>
                      ‚Ç¨{Math.abs(ivaP).toFixed(2)}
                    </p>
                    <p className={`text-xs mt-1 ${ivaP >= 0 ? 'text-orange-600' : 'text-green-600'}`}>
                      {ivaP >= 0 ? 'A entregar ao Estado' : 'Estado deve-te (cr√©dito IVA)'}
                    </p>
                  </div>
                </div>
                
                <div className={`rounded p-2 text-xs mb-3 ${ivaP >= 0 ? 'bg-blue-50 text-blue-800' : 'bg-green-50 text-green-800'}`}>
                  üí° <strong>C√°lculo:</strong> IVA {ivaP >= 0 ? 'a Pagar' : 'a Receber'} = IVA Vendas - IVA Compras
                  {ivaP < 0 && (
                    <><br/>‚úÖ Compraste mais que vendeste. O Estado deve-te este valor!</>
                  )}
                </div>
                
                {/* IVA Breakdown */}
                <div className="border-t pt-3">
                  <h4 className="text-sm font-semibold mb-2 text-gray-700">üìã Breakdown IVA Compras</h4>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="bg-blue-50 rounded p-2 border border-blue-200">
                      <p className="text-xs text-blue-700 mb-1">IVA Compras Alimentos</p>
                      <p className="text-base font-bold text-blue-900">
                        ‚Ç¨{(() => {
                          // IVA das despesas manuais categoria compras
                          const ivaDespesas = filteredDespesas
                            .filter(d => d.categoria === 'compras')
                            .reduce((s, d) => {
                              const valorSemIva = d.valor / (1 + (d.iva || 23) / 100);
                              return s + (d.valor - valorSemIva);
                            }, 0);
                          
                          // IVA das faturas (j√° vem calculado)
                          const ivaFaturas = filteredFaturas.reduce((s, f) => s + (f.totalIva || 0), 0);
                          
                          return (ivaDespesas + ivaFaturas).toFixed(2);
                        })()}
                      </p>
                      <p className="text-xs text-blue-600 mt-1">Recuper√°vel</p>
                    </div>
                    
                    <div className="bg-purple-50 rounded p-2 border border-purple-200">
                      <p className="text-xs text-purple-700 mb-1">IVA Compras Consum√≠veis</p>
                      <p className="text-base font-bold text-purple-900">
                        ‚Ç¨{filteredDespesas
                          .filter(d => d.categoria === 'consumiveis')
                          .reduce((s, d) => {
                            const valorSemIva = d.valor / (1 + (d.iva || 23) / 100);
                            return s + (d.valor - valorSemIva);
                          }, 0).toFixed(2)}
                      </p>
                      <p className="text-xs text-purple-600 mt-1">Recuper√°vel</p>
                    </div>
                  </div>
                </div>
              </div>
              
            </>
            )}
            {dashboardSubTab === 'compras' && (
              <ComprasAnalysis 
                despesas={despesas}
                faturas={faturas}
                ingredientes={ingredientes}
                fornecedores={fornecedores}
              />
            )}
            {dashboardSubTab === 'delivery' && deliveryApps.some(app => app.ativo) && (
              <>
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                  üöó An√°lise de Delivery
                </h2>
                
                <div className="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-lg p-4 mb-4">
                  <p className="text-sm text-gray-700 mb-2">
                    üí° <strong>Compara√ß√£o de Pre√ßos e Margens</strong> - Produtos Take-Away vs Apps Delivery
                  </p>
                  <p className="text-xs text-gray-600">
                    Apps ativas: {deliveryApps.filter(app => app.ativo).map(app => `${app.nome} (${app.comissao}%)`).join(', ')}
                  </p>
                </div>
                
                {/* Barra de Pesquisa de Produtos Take-Away */}
                <div className="mb-4">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar produto take-away..."
                      value={searchTakeAway}
                      onChange={(e) => setSearchTakeAway(e.target.value)}
                      className="w-full px-4 py-2 border-2 border-orange-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50"
                    />
                    {searchTakeAway && (
                      <button
                        onClick={() => setSearchTakeAway('')}
                        className="absolute right-3 top-2.5 text-orange-500 hover:text-orange-700 font-bold text-lg"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  {searchTakeAway && (
                    <p className="text-xs text-gray-600 mt-1 ml-1">
                      A filtrar por: <span className="font-semibold text-orange-600">{searchTakeAway}</span>
                    </p>
                  )}
                </div>
                
                {/* Filtrar produtos com embalagens */}
                {(() => {
                  console.log('=== DEBUG DELIVERY ===');
                  console.log('Produtos total:', (produtos || []).length);
                  console.log('Ingredientes total:', (ingredientes || []).length);
                  
                  // Debug ingredientes embalagens
                  const embalagens = ingredientes.filter(i => i.categoria === 'embalagens');
                  console.log('Ingredientes embalagens:', embalagens);
                  
                  const produtosTakeAway = produtos
                    .filter(p => {
                      if (!p.embalagens || !Array.isArray(p.embalagens) || p.embalagens.length === 0) {
                        console.log('Produto sem embalagens:', p.nome);
                        return false;
                      }
                      
                      const temEmbalagem = p.embalagens.some(e => {
                        const ing = ingredientes.find(i => i.id == e.ingredienteId);
                        if (ing && ing.categoria === 'embalagens') {
                          console.log('Produto', p.nome, 'tem embalagem:', ing.nome);
                          return true;
                        }
                        return false;
                      });
                      
                      return temEmbalagem;
                    })
                    .filter(p => 
                      p.nome.toLowerCase().includes(searchTakeAway.toLowerCase())
                    );
                  
                  console.log('Produtos take-away encontrados:', produtosTakeAway.length);
                  console.log('Produtos take-away:', produtosTakeAway.map(p => p.nome));
                  
                  if (produtosTakeAway.length === 0) {
                    // Verificar se √© porque a pesquisa n√£o encontrou ou porque n√£o h√° produtos take-away
                    const totalTakeAway = produtos.filter(p => {
                      if (!p.embalagens || !Array.isArray(p.embalagens) || p.embalagens.length === 0) {
                        return false;
                      }
                      return p.embalagens.some(e => {
                        const ing = ingredientes.find(i => i.id == e.ingredienteId);
                        return ing && ing.categoria === 'embalagens';
                      });
                    }).length;
                    
                    if (searchTakeAway && totalTakeAway > 0) {
                      // A pesquisa n√£o encontrou nada mas existem produtos take-away
                      return (
                        <div className="text-center py-12 bg-orange-50 rounded-lg border-2 border-orange-200">
                          <p className="text-orange-700 mb-2 font-bold">üîç Nenhum resultado encontrado</p>
                          <p className="text-sm text-orange-600 mb-3">
                            N√£o h√° produtos take-away com o nome "<strong>{searchTakeAway}</strong>"
                          </p>
                          <button
                            onClick={() => setSearchTakeAway('')}
                            className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-semibold"
                          >
                            ‚úï Limpar Pesquisa
                          </button>
                          <p className="text-xs text-gray-600 mt-3">
                            {totalTakeAway} produto{totalTakeAway !== 1 ? 's' : ''} take-away dispon√≠ve{totalTakeAway !== 1 ? 'is' : 'l'}
                          </p>
                        </div>
                      );
                    }
                    
                    // N√£o h√° produtos take-away criados
                    return (
                      <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed">
                        <p className="text-gray-600 mb-2">üì¶ Nenhum produto Take-Away encontrado</p>
                        <p className="text-sm text-gray-500 mb-2">
                          Adicione produtos com embalagens (categoria "Embalagens") para ver an√°lise de delivery
                        </p>
                        <div className="text-xs text-left bg-white p-4 rounded mx-auto max-w-md mt-4">
                          <p className="font-bold mb-2">Debug Info:</p>
                          <p>Total produtos: {(produtos || []).length}</p>
                          <p>Total ingredientes: {(ingredientes || []).length}</p>
                          <p>Ingredientes "embalagens": {embalagens.length}</p>
                          <p className="mt-2 text-gray-600">Categorias encontradas:</p>
                          <p className="text-xs">{[...new Set((ingredientes || []).map(i => i.categoria))].join(', ')}</p>
                        </div>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="space-y-4">
                      {searchTakeAway && (
                        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-sm">
                          <p className="text-blue-700">
                            <span className="font-bold">{produtosTakeAway.length}</span> produto{produtosTakeAway.length !== 1 ? 's' : ''} encontrado{produtosTakeAway.length !== 1 ? 's' : ''} para "<strong>{searchTakeAway}</strong>"
                          </p>
                        </div>
                      )}
                      {produtosTakeAway.map(produto => {
                        const precos = calcPrecosPorModalidade(produto);
                        const appsAtivas = deliveryApps.filter(app => app.ativo);
                        
                        return (
                          <div key={produto.id} className="border-2 border-gray-200 rounded-lg overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-3 border-b-2 border-blue-200">
                              <h3 className="font-bold text-lg">{produto.nome}</h3>
                              <p className="text-xs text-gray-600">
                                Custo ingredientes: ‚Ç¨{precos.takeaway.custo - precos.takeaway.custoEmbalagens || 0} | 
                                Custo embalagens: ‚Ç¨{precos.takeaway.custoEmbalagens.toFixed(2)} | 
                                <strong> Total: ‚Ç¨{precos.takeaway.custo.toFixed(2)}</strong>
                              </p>
                            </div>
                            
                            <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                              {/* Take-Away Direto */}
                              <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-2xl">üõçÔ∏è</span>
                                  <div>
                                    <p className="font-bold text-sm">Take-Away Direto</p>
                                    <p className="text-xs text-gray-600">Sem comiss√µes</p>
                                  </div>
                                </div>
                                <div className="space-y-1">
                                  <div className="flex justify-between text-xs">
                                    <span>Pre√ßo:</span>
                                    <span className="font-bold">‚Ç¨{precos.takeaway.preco.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-xs">
                                    <span>Margem:</span>
                                    <span className="font-bold text-green-700">‚Ç¨{precos.takeaway.margem.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-xs">
                                    <span>Margem %:</span>
                                    <span className="font-bold text-green-700">{precos.takeaway.margemPerc.toFixed(0)}%</span>
                                  </div>
                                </div>
                              </div>
                              
                              {/* Apps de Delivery */}
                              {appsAtivas.map(app => {
                                const dados = precos.delivery[app.id];
                                const diferencaMargem = ((dados.margemPerc - precos.takeaway.margemPerc) / precos.takeaway.margemPerc * 100);
                                
                                return (
                                  <div key={app.id} className="bg-orange-50 border-2 border-orange-300 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-2xl">üöó</span>
                                      <div>
                                        <p className="font-bold text-sm">{app.nome}</p>
                                        <p className="text-xs text-gray-600">Comiss√£o {app.comissao}%</p>
                                      </div>
                                    </div>
                                    <div className="space-y-1">
                                      <div className="flex justify-between text-xs">
                                        <span>Pre√ßo sugerido:</span>
                                        <span className="font-bold">‚Ç¨{dados.precoSugerido.toFixed(2)}</span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Receita l√≠quida:</span>
                                        <span className="font-semibold text-blue-600">‚Ç¨{dados.receitaLiquida.toFixed(2)}</span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Margem:</span>
                                        <span className={`font-bold ${dados.margem > 0 ? 'text-green-700' : 'text-red-700'}`}>
                                          ‚Ç¨{dados.margem.toFixed(2)}
                                        </span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Margem %:</span>
                                        <span className={`font-bold ${dados.margem > 0 ? 'text-green-700' : 'text-red-700'}`}>
                                          {dados.margemPerc.toFixed(0)}%
                                        </span>
                                      </div>
                                      <div className="pt-1 border-t border-orange-200">
                                        <p className={`text-xs font-semibold ${diferencaMargem < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                          {diferencaMargem >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(diferencaMargem).toFixed(0)}% vs direto
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            
                            {/* Recomenda√ß√£o */}
                            <div className="bg-blue-50 p-3 border-t-2 border-blue-200">
                              <p className="text-xs text-blue-900">
                                <strong>üí° Recomenda√ß√£o:</strong> {(() => {
                                  const melhorApp = appsAtivas.reduce((melhor, app) => {
                                    const dados = precos.delivery[app.id];
                                    const melhorDados = precos.delivery[melhor.id];
                                    return dados.margemPerc > melhorDados.margemPerc ? app : melhor;
                                  });
                                  
                                  const melhorDados = precos.delivery[melhorApp.id];
                                  
                                  if (melhorDados.margemPerc < precos.takeaway.margemPerc * 0.7) {
                                    return `‚ö†Ô∏è Todas as apps reduzem margem >30%. Considere aumentar pre√ßos ou venda direta.`;
                                  }
                                  
                                  return `Melhor app: ${melhorApp.nome} (margem ${melhorDados.margemPerc.toFixed(0)}%)`;
                                })()}
                              </p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>
              </>
            )}

            {dashboardSubTab === 'simuladores' && (
              <>
                {/* Simulador de Custos Laborais */}
                <div className="bg-white rounded-lg shadow p-4 mb-3">
                  <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                    üí∞ Simulador de Custos Laborais
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">
                    Calcula o custo real de um funcion√°rio incluindo subs√≠dios obrigat√≥rios e encargos da Seguran√ßa Social
                  </p>
                  
                  {/* Seletor de Modo */}
                  <div className="mb-4 flex gap-2">
                    <button
                      onClick={() => setModoSimulador('fulltime')}
                      className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${
                        modoSimulador === 'fulltime' 
                          ? 'bg-blue-500 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üëî Full-Time (40h/semana)
                    </button>
                    <button
                      onClick={() => setModoSimulador('parttime')}
                      className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${
                        modoSimulador === 'parttime' 
                          ? 'bg-green-500 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ‚è∞ Part-Time
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {/* Input */}
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                      <h3 className="font-semibold text-blue-900 mb-3">üìù Dados do Sal√°rio</h3>
                      
                      <div className="space-y-3">
                        {modoSimulador === 'parttime' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Horas Semanais
                            </label>
                            <div className="relative">
                              <input
                                type="number"
                                value={horasSemanaisPartTime}
                                onChange={(e) => setHorasSemanaisPartTime(parseFloat(e.target.value) || 0)}
                                className="w-full border rounded px-3 py-2 pr-12"
                                placeholder="8"
                                min="1"
                                max="30"
                              />
                              <span className="absolute right-3 top-2.5 text-gray-500 text-sm">h/sem</span>
                            </div>
                            <p className="text-xs text-gray-600 mt-1">
                              = {((horasSemanaisPartTime / 40) * 100).toFixed(0)}% de um full-time
                            </p>
                          </div>
                        )}
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {modoSimulador === 'fulltime' ? 'Sal√°rio Bruto Mensal' : 'Sal√°rio Refer√™ncia Full-Time'}
                          </label>
                          <div className="relative">
                            <input
                              type="number"
                              value={ordenadoDesejado}
                              onChange={(e) => setOrdenadoDesejado(parseFloat(e.target.value) || 0)}
                              className="w-full border rounded px-3 py-2 pr-8"
                              placeholder="920"
                            />
                            <span className="absolute right-3 top-2.5 text-gray-500 font-semibold">‚Ç¨</span>
                          </div>
                          {modoSimulador === 'parttime' && (
                            <p className="text-xs text-green-700 mt-1 font-medium">
                              ‚Üí Part-time: ‚Ç¨{(ordenadoDesejado * horasSemanaisPartTime / 40).toFixed(2)}/m√™s
                            </p>
                          )}
                        </div>
                        
                        {/* Subs√≠dio de Alimenta√ß√£o */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirSubsidioAlimentacao}
                              onChange={(e) => setIncluirSubsidioAlimentacao(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Subs√≠dio de Alimenta√ß√£o</span>
                          </label>
                          
                          {incluirSubsidioAlimentacao && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="0.10"
                                  value={valorSubsidioAlimentacao}
                                  onChange={(e) => setValorSubsidioAlimentacao(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">
                                  ‚Ç¨/dia √ó {modoSimulador === 'parttime' ? Math.ceil(horasSemanaisPartTime / 5) : '22'} dias
                                </span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                {modoSimulador === 'fulltime' ? (
                                  `= ‚Ç¨${(valorSubsidioAlimentacao * 22).toFixed(2)}/m√™s`
                                ) : (
                                  <>
                                    {horasSemanaisPartTime < 25 ? (
                                      `= ‚Ç¨${(valorSubsidioAlimentacao * Math.ceil(horasSemanaisPartTime / 5) * 0.8).toFixed(2)}/m√™s (proporcional <5h/dia)`
                                    ) : (
                                      `= ‚Ç¨${(valorSubsidioAlimentacao * Math.ceil(horasSemanaisPartTime / 5)).toFixed(2)}/m√™s`
                                    )}
                                  </>
                                )}
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° N√£o obrigat√≥rio no setor privado. Refer√™ncia: ‚Ç¨6.00/dia (fun√ß√£o p√∫blica)
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Output */}
                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4">
                      <h3 className="font-semibold text-green-900 mb-3">üíµ Custo Real para a Empresa</h3>
                      
                      {(() => {
                        // Calcular sal√°rio base (proporcional se part-time)
                        const proporcaoPartTime = modoSimulador === 'parttime' ? horasSemanaisPartTime / 40 : 1;
                        const salarioBase = ordenadoDesejado * proporcaoPartTime;
                        
                        // Calcular subs√≠dio alimenta√ß√£o
                        let subsidioAlimentacaoMensal = 0;
                        if (incluirSubsidioAlimentacao) {
                          if (modoSimulador === 'fulltime') {
                            subsidioAlimentacaoMensal = valorSubsidioAlimentacao * 22;
                          } else {
                            const diasTrabalhados = Math.ceil(horasSemanaisPartTime / 5); // aprox dias/semana
                            const valorDiario = horasSemanaisPartTime < 25 ? valorSubsidioAlimentacao * 0.8 : valorSubsidioAlimentacao;
                            subsidioAlimentacaoMensal = valorDiario * diasTrabalhados;
                          }
                        }
                        
                        const salarioComSubsidios = salarioBase + salarioBase / 12 * 2;
                        const tsuBase = salarioComSubsidios * 0.2375;
                        const custoTotal = salarioComSubsidios * 1.2375 + subsidioAlimentacaoMensal;
                        
                        return (
                          <>
                            {modoSimulador === 'parttime' && (
                              <div className="bg-green-100 border border-green-300 rounded p-2 mb-3">
                                <p className="text-xs font-semibold text-green-900">
                                  ‚è∞ Part-Time: {horasSemanaisPartTime}h/semana ({(proporcaoPartTime * 100).toFixed(0)}%)
                                </p>
                              </div>
                            )}
                            
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between items-center pb-2 border-b border-green-200">
                                <span className="text-gray-700">Sal√°rio mensal base:</span>
                                <span className="font-semibold">‚Ç¨{salarioBase.toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-xs text-gray-600">
                                <span>Subs√≠dio de F√©rias (1/12):</span>
                                <span>‚Ç¨{(salarioBase / 12).toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-xs text-gray-600 pb-2 border-b border-green-200">
                                <span>Subs√≠dio de Natal (1/12):</span>
                                <span>‚Ç¨{(salarioBase / 12).toFixed(2)}</span>
                              </div>
                              
                              {incluirSubsidioAlimentacao && (
                                <div className="flex justify-between items-center text-xs text-blue-700 pb-2 border-b border-green-200">
                                  <span>Subs√≠dio de Alimenta√ß√£o:</span>
                                  <span>‚Ç¨{subsidioAlimentacaoMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              <div className="flex justify-between items-center pb-2 border-b border-green-200">
                                <span className="text-gray-700">Subtotal com subs√≠dios:</span>
                                <span className="font-semibold">‚Ç¨{(salarioComSubsidios + subsidioAlimentacaoMensal).toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-orange-700 pb-2 border-b-2 border-green-300">
                                <span className="font-medium">TSU Patronal (23.75%):</span>
                                <span className="font-semibold">‚Ç¨{tsuBase.toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center pt-2">
                                <span className="text-lg font-bold text-green-900">CUSTO TOTAL MENSAL:</span>
                                <span className="text-2xl font-bold text-green-900">
                                  ‚Ç¨{custoTotal.toFixed(2)}
                                </span>
                              </div>
                            </div>
                            
                            <div className="mt-3 pt-3 border-t border-green-300">
                              <div className="text-xs text-green-800 space-y-1">
                                <p>üí° <strong>Custo anual:</strong> ‚Ç¨{(custoTotal * 12).toFixed(2)}</p>
                                <p>üìä <strong>Encargos adicionais:</strong> +{((custoTotal / salarioBase - 1) * 100).toFixed(1)}% sobre sal√°rio base</p>
                              </div>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>
                  
                  {/* Info Box */}
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>‚ÑπÔ∏è O que est√° inclu√≠do:</strong>
                    </p>
                    <ul className="text-xs text-blue-700 mt-2 space-y-1 ml-4">
                      <li>‚Ä¢ <strong>Subs√≠dio de F√©rias</strong>: 1 m√™s de sal√°rio (14¬∫ m√™s) - obrigat√≥rio por lei</li>
                      <li>‚Ä¢ <strong>Subs√≠dio de Natal</strong>: 1 m√™s de sal√°rio (13¬∫ m√™s) - obrigat√≥rio por lei</li>
                      <li>‚Ä¢ <strong>Subs√≠dio de Alimenta√ß√£o</strong>: Opcional (n√£o obrigat√≥rio no setor privado). Isento at√© ‚Ç¨6/dia em dinheiro ou ‚Ç¨10.20/dia em cart√£o</li>
                      <li>‚Ä¢ <strong>TSU Patronal</strong>: 23.75% sobre sal√°rio + subs√≠dios de f√©rias e natal (n√£o incide sobre subs√≠dio alimenta√ß√£o at√© limites isentos)</li>
                      <li>‚Ä¢ <strong>Nota</strong>: Trabalhador tamb√©m desconta 11% (retido do sal√°rio), mas n√£o est√° inclu√≠do aqui</li>
                    </ul>
                  </div>
                </div>

                {/* Simulador de IVA Trimestral */}
                <div className="bg-white rounded-lg shadow p-4">
                  <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                    üßæ Pr√≥xima Entrega de IVA
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">
                    Estimativa do IVA a pagar no pr√≥ximo trimestre (regime trimestral)
                  </p>
                  
                  {(() => {
                    // Calculate current quarter
                    const now = new Date();
                    const currentMonth = now.getMonth() + 1; // 1-12
                    const currentYear = now.getFullYear();
                    
                    // Determine quarter
                    let quarter, quarterStart, quarterEnd, deadlineMonth, deadlineDay;
                    if (currentMonth >= 1 && currentMonth <= 3) {
                      quarter = 1;
                      quarterStart = new Date(currentYear, 0, 1);
                      quarterEnd = new Date(currentYear, 2, 31);
                      deadlineMonth = 5; // May
                      deadlineDay = 20;
                    } else if (currentMonth >= 4 && currentMonth <= 6) {
                      quarter = 2;
                      quarterStart = new Date(currentYear, 3, 1);
                      quarterEnd = new Date(currentYear, 5, 30);
                      deadlineMonth = 8; // August
                      deadlineDay = 20;
                    } else if (currentMonth >= 7 && currentMonth <= 9) {
                      quarter = 3;
                      quarterStart = new Date(currentYear, 6, 1);
                      quarterEnd = new Date(currentYear, 8, 30);
                      deadlineMonth = 11; // November
                      deadlineDay = 20;
                    } else {
                      quarter = 4;
                      quarterStart = new Date(currentYear, 9, 1);
                      quarterEnd = new Date(currentYear, 11, 31);
                      deadlineMonth = 2; // February next year
                      deadlineDay = 20;
                    }
                    
                    // Calculate deadline
                    const deadlineYear = quarter === 4 ? currentYear + 1 : currentYear;
                    const deadline = new Date(deadlineYear, deadlineMonth - 1, deadlineDay);
                    const daysUntil = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    
                    // Filter sales and expenses for current quarter
                    const quarterVendas = vendas.filter(v => {
                      const vDate = new Date(v.data);
                      return vDate >= quarterStart && vDate <= quarterEnd;
                    });
                    
                    const quarterDespesas = despesas.filter(d => {
                      const dDate = new Date(d.data);
                      return dDate >= quarterStart && dDate <= quarterEnd;
                    });
                    
                    // Calculate IVA
                    const ivaVendas = quarterVendas.reduce((s, v) => {
                      const prod = v.produtoId 
                        ? produtos.find(p => p.id === v.produtoId)
                        : produtos.find(p => p.nome.toLowerCase() === v.produto.toLowerCase());
                      if (!prod) return s;
                      const precoSemIva = prod.precoVenda / (1 + prod.iva / 100);
                      return s + (prod.precoVenda - precoSemIva) * v.quantidade;
                    }, 0);
                    
                    // IVA Compras das faturas
                    const quarterFaturas = faturas.filter(f => {
                      const fDate = new Date(f.data);
                      return fDate >= quarterStart && fDate <= quarterEnd;
                    });
                    const ivaComprasFaturas = quarterFaturas.reduce((s, f) => s + (f.totalIva || 0), 0);
                    
                    // IVA Compras das despesas
                    const ivaComprasDespesas = quarterDespesas.reduce((s, d) => {
                      const valorSemIva = d.valor / (1 + d.iva / 100);
                      return s + (d.valor - valorSemIva);
                    }, 0);
                    
                    // Total IVA Compras
                    const ivaCompras = ivaComprasFaturas + ivaComprasDespesas;
                    
                    const ivaPagar = ivaVendas - ivaCompras;
                    
                    return (
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div className="space-y-3">
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p className="text-sm font-semibold text-blue-900 mb-2">
                              {quarter}¬∫ Trimestre {currentYear}
                            </p>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-gray-700">IVA Vendas:</span>
                                <span className="font-semibold text-green-700">‚Ç¨{ivaVendas.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-700">IVA Compras:</span>
                                <span className="font-semibold text-blue-700">-‚Ç¨{ivaCompras.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between pt-2 border-t border-blue-300">
                                <span className="font-bold text-gray-900">A Pagar:</span>
                                <span className={`text-xl font-bold ${ivaPagar >= 0 ? 'text-orange-600' : 'text-green-600'}`}>
                                  ‚Ç¨{ivaPagar.toFixed(2)}
                                </span>
                              </div>
                            </div>
                          </div>
                          
                          <div className={`border-2 rounded-lg p-4 ${
                            daysUntil <= 7 ? 'bg-red-50 border-red-300' :
                            daysUntil <= 30 ? 'bg-orange-50 border-orange-300' :
                            'bg-green-50 border-green-300'
                          }`}>
                            <p className="text-sm font-semibold mb-2">
                              üìÖ Prazo de Entrega
                            </p>
                            <p className="text-2xl font-bold">
                              {deadline.toLocaleDateString('pt-PT', { day: '2-digit', month: 'long', year: 'numeric' })}
                            </p>
                            <p className={`text-sm mt-1 font-semibold ${
                              daysUntil <= 7 ? 'text-red-700' :
                              daysUntil <= 30 ? 'text-orange-700' :
                              'text-green-700'
                            }`}>
                              {daysUntil > 0 ? `Faltam ${daysUntil} dias` : 'PRAZO EXPIRADO!'}
                            </p>
                          </div>
                        </div>
                        
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                          <p className="text-sm font-semibold text-yellow-900 mb-2">
                            üìã Calend√°rio IVA Trimestral
                          </p>
                          <div className="space-y-2 text-xs text-yellow-800">
                            <div className="flex justify-between">
                              <span>1¬∫ Trimestre (Jan-Mar):</span>
                              <span className="font-semibold">20 Maio</span>
                            </div>
                            <div className="flex justify-between">
                              <span>2¬∫ Trimestre (Abr-Jun):</span>
                              <span className="font-semibold">20 Agosto</span>
                            </div>
                            <div className="flex justify-between">
                              <span>3¬∫ Trimestre (Jul-Set):</span>
                              <span className="font-semibold">20 Novembro</span>
                            </div>
                            <div className="flex justify-between">
                              <span>4¬∫ Trimestre (Out-Dez):</span>
                              <span className="font-semibold">20 Fevereiro</span>
                            </div>
                          </div>
                          
                          <div className="mt-3 pt-3 border-t border-yellow-300 text-xs text-yellow-800">
                            <p className="font-semibold mb-1">üí° Dicas:</p>
                            <ul className="space-y-1 ml-4">
                              <li>‚Ä¢ Declara√ß√£o at√© dia 20</li>
                              <li>‚Ä¢ Pagamento at√© dia 25</li>
                              <li>‚Ä¢ Regime para fatura√ß√£o &lt;‚Ç¨650k/ano</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              </>
            )}
          </div>
        )}


        {activeTab === 'gestao' && (
          <div className="space-y-3">
            {/* Gest√£o Sub-tabs */}
            <div className="bg-white rounded-lg shadow">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'ingredientes', label: 'Ingredientes', icon: FileText },
                  { id: 'produtos', label: 'Produtos', icon: Package },
                  { id: 'faturas', label: 'Faturas', icon: FileText },
                  { id: 'vendas', label: 'Vendas', icon: Upload }
                ].map(tab => {
                  const Icon = tab.icon;
                  return (
                    <button key={tab.id} onClick={() => setGestaoSubTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 font-medium text-xs transition ${
                        gestaoSubTab === tab.id ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-blue-50'
                      }`}>
                      <Icon size={14} />{tab.label}
                    </button>
                  );
                })}
              </div>
            </div>
            

            {gestaoSubTab === 'ingredientes' && (
              <div className="bg-white rounded-lg shadow p-3">
                <h2 className="text-lg font-bold mb-3">Ingredientes</h2>
                
                <div className={`rounded p-3 mb-3 border ${editandoIngrediente ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-200'}`}>
                  <h3 className="font-semibold text-xs mb-2">{editandoIngrediente ? 'Editar Ingrediente' : 'Adicionar Ingrediente'}</h3>
                  <div className="grid grid-cols-6 gap-2">
                    <input type="text" placeholder="Nome" value={novoIngrediente.nome}
                      onChange={(e) => {
                        const nome = e.target.value;
                        const catDetectada = detectarCategoria(nome);
                        setNovoIngrediente({ ...novoIngrediente, nome: nome, categoria: catDetectada });
                      }}
                      className="border rounded px-2 py-1.5 text-xs" />
                    <select value={novoIngrediente.categoria || 'outros'}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, categoria: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs"
                      title="Categoria auto-detectada (pode editar)">
                      <option value="vegetais">Vegetais</option>
                      <option value="frutas">Frutas</option>
                      <option value="carnes">Carnes</option>
                      <option value="peixe">Peixe</option>
                      <option value="latic√≠nios">Latic√≠nios</option>
                      <option value="padaria">Padaria</option>
                      <option value="pastelaria">Pastelaria</option>
                      <option value="compotas">Compotas</option>
                      <option value="bebidas">Bebidas</option>
                      <option value="temperos">Temperos</option>
                      <option value="embalagens">Embalagens</option>
                      <option value="limpeza">Limpeza</option>
                      <option value="outros">Outros</option>
                    </select>
                    <select value={novoIngrediente.unidade}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, unidade: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs">
                      <option value="kg">kg</option>
                      <option value="g">g</option>
                      <option value="L">L</option>
                      <option value="ml">ml</option>
                      <option value="un">un</option>
                    </select>
                    <input type="number" step="0.01" placeholder="Custo ‚Ç¨" value={novoIngrediente.custoUnitario}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, custoUnitario: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs" />
                    <select value={novoIngrediente.iva}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, iva: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs">
                      <option value="6">IVA 6%</option>
                      <option value="13">IVA 13%</option>
                      <option value="23">IVA 23%</option>
                    </select>
                    {editandoIngrediente ? (
                      <div className="flex gap-1">
                        <button onClick={atualizarIngrediente}
                          className="flex-1 bg-yellow-600 text-white rounded px-2 py-1.5 text-xs hover:bg-yellow-700 flex items-center justify-center font-semibold">
                          <Save size={14} />
                        </button>
                        <button onClick={cancelarEdicaoIngrediente}
                          className="bg-gray-400 text-white rounded px-2 py-1.5 text-xs hover:bg-gray-500">
                          X
                        </button>
                      </div>
                    ) : (
                      <button onClick={adicionarIngrediente}
                        className="bg-blue-600 text-white rounded px-3 py-1.5 text-xs hover:bg-blue-700 flex items-center justify-center gap-1 font-semibold">
                        <Plus size={14} />Add
                      </button>
                    )}
                  </div>
                </div>

                {/* Search Bar Ingredientes */}
                <div className="mb-3">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar ingrediente..."
                      value={searchIngredienteGlobal}
                      onChange={(e) => setSearchIngredienteGlobal(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {searchIngredienteGlobal && (
                      <button
                        onClick={() => setSearchIngredienteGlobal('')}
                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 font-bold"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                </div>

                <div className="overflow-x-auto rounded border">
                  <table className="w-full text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left font-semibold">Nome</th>
                        <th className="px-2 py-2 text-left font-semibold">Categoria</th>
                        <th className="px-2 py-2 text-left font-semibold">Unid</th>
                        <th className="px-2 py-2 text-right font-semibold">Custo</th>
                        <th className="px-2 py-2 text-center font-semibold">IVA</th>
                        <th className="px-2 py-2 text-center font-semibold">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        const ingredientesFiltrados = (ingredientes || []).filter(ing =>
                          ing.nome.toLowerCase().includes(searchIngredienteGlobal.toLowerCase())
                        );
                        return ingredientesFiltrados.map((ing, idx) => (
                        <tr key={ing.id} className={`border-t ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 py-2 font-medium">{ing.nome}</td>
                          <td className="px-2 py-2">
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded">{ing.categoria || 'outros'}</span>
                          </td>
                          <td className="px-2 py-2">{ing.unidade}</td>
                          <td className="px-2 py-2 text-right">
                            <div className="text-xs">
                              <div className="font-bold text-gray-900">‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}</div>
                              {ing.custoUnitario && ing.iva && (
                                <div className="text-gray-500 text-[10px]">
                                  s/IVA: ‚Ç¨{(ing.custoUnitario / (1 + ing.iva / 100)).toFixed(2)}
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">{ing.iva}%</span>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button onClick={() => editarIngrediente(ing)}
                                className="text-yellow-600 hover:bg-yellow-50 p-1 rounded">
                                <Edit2 size={14} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar?')) {
                                  setIngredientes(ingredientes.filter(i => i.id !== ing.id));
                                  showNotification('Eliminado!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1 rounded">
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ));
                      })()}
                    </tbody>
                  </table>
                </div>
                {!(ingredientes || []).length && <p className="text-center text-gray-400 py-6 text-xs">Nenhum ingrediente</p>}
              </div>
            )}

            {gestaoSubTab === 'produtos' && (
              <div className="bg-white rounded-lg shadow p-3">
                <h2 className="text-lg font-bold mb-3">Produtos & Fichas T√©cnicas</h2>
                
                {/* Add Product Form */}
                <div className={`rounded p-3 mb-3 border ${editandoProduto ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-200'}`}>
                  <h3 className="font-semibold text-sm mb-2">{editandoProduto ? 'Editar Produto' : 'Adicionar Produto'}</h3>
                  <div className="space-y-3">
                    <div className="grid grid-cols-4 gap-2">
                      <input type="text" placeholder="Nome do produto" value={novoProduto.nome}
                        onChange={(e) => setNovoProduto({ ...novoProduto, nome: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm" />
                      <input type="number" step="0.01" placeholder="Pre√ßo ‚Ç¨" value={novoProduto.precoVenda}
                        onChange={(e) => setNovoProduto({ ...novoProduto, precoVenda: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm" />
                      <select value={novoProduto.iva}
                        onChange={(e) => setNovoProduto({ ...novoProduto, iva: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm">
                        <option value="6">IVA 6%</option>
                        <option value="13">IVA 13%</option>
                        <option value="23">IVA 23%</option>
                      </select>
                      <select value={novoProduto.categoria || 'cafes'}
                        onChange={(e) => setNovoProduto({ ...novoProduto, categoria: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm">
                        <option value="cafes">‚òï Caf√©s</option>
                        <option value="bebidas">ü•§ Bebidas</option>
                        <option value="pratos">üçΩÔ∏è Pratos</option>
                        <option value="sobremesas">üç∞ Sobremesas</option>
                        <option value="lanches">ü•™ Lanches</option>
                        <option value="outros">üì¶ Outros</option>
                      </select>
                    </div>
                    
                    {/* Campo Por√ß√µes */}
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">
                        N¬∫ Por√ß√µes (para bolos/sobremesas)
                      </label>
                      <input
                        type="number"
                        min="1"
                        value={novoProduto.porcoes || 1}
                        onChange={(e) => setNovoProduto({...novoProduto, porcoes: parseInt(e.target.value) || 1})}
                        placeholder="1"
                        className="w-full px-2 py-1.5 border rounded text-sm"
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        üí° Ex: Bolo com 12 fatias = 12 por√ß√µes. Deixe 1 para produtos normais.
                      </p>
                    </div>
                    
                    {(ingredientes || []).length > 0 && (
                      <div className="border rounded p-2 bg-white">
                        <p className="font-medium mb-2 text-xs flex items-center gap-1">
                          <FileText size={14} />Receita (Ingredientes):
                        </p>
                        
                        {/* Search bar - SEM √≠cone overlay! */}
                        <div className="relative mb-2">
                          <input 
                            type="text" 
                            placeholder="üîç Procurar ingrediente..." 
                            value={searchIngrediente}
                            onChange={(e) => {
                              setSearchIngrediente(e.target.value);
                              setShowIngredienteSuggestions(e.target.value.length > 0);
                            }}
                            onFocus={() => setShowIngredienteSuggestions(searchIngrediente.length > 0)}
                            className="w-full px-3 py-1.5 border rounded text-sm focus:border-green-500 focus:ring-1 focus:ring-green-200"
                          />
                          
                          {/* Suggestions dropdown */}
                          {showIngredienteSuggestions && searchIngrediente && searchIngrediente.length > 0 && (
                            <div className="absolute z-10 w-full bg-white border rounded shadow-lg mt-1 max-h-40 overflow-y-auto">
                              {ingredientes
                                .filter(ing => 
                                  ing.nome.toLowerCase().includes(searchIngrediente.toLowerCase()) &&
                                  !novoProduto.receita.find(r => r.ingredienteId === ing.id)
                                )
                                .map(ing => (
                                  <button
                                    key={ing.id}
                                    type="button"
                                    onClick={() => {
                                      setNovoProduto({ 
                                        ...novoProduto, 
                                        receita: [...novoProduto.receita, { ingredienteId: ing.id, quantidade: 0, unidade: ing.unidade }] 
                                      });
                                      setSearchIngrediente('');
                                      setShowIngredienteSuggestions(false);
                                    }}
                                    className="w-full text-left px-3 py-2 hover:bg-green-50 flex justify-between items-center text-sm border-b last:border-b-0"
                                  >
                                    <span className="font-medium">{ing.nome}</span>
                                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
                                      ‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}/{ing.unidade}
                                    </span>
                                  </button>
                                ))}
                              {ingredientes.filter(ing => 
                                ing.nome.toLowerCase().includes(searchIngrediente.toLowerCase()) &&
                                !novoProduto.receita.find(r => r.ingredienteId === ing.id)
                              ).length === 0 && (
                                <div className="px-3 py-4 text-gray-400 text-center text-xs">
                                  Nenhum ingrediente encontrado
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* Selected ingredients */}
                        <div className="space-y-1">
                          {(novoProduto.receita || []).map((item, idx) => {
                            const ing = ingredientes.find(i => i.id === item.ingredienteId);
                            if (!ing) return null;
                            
                            return (
                              <div key={idx} className="flex items-center gap-2 bg-green-50 p-1.5 rounded border border-green-200">
                                <span className="text-xs font-medium flex-1">{ing.nome}</span>
                                <input 
                                  type="number" 
                                  step="0.01" 
                                  placeholder="Qtd"
                                  value={item.quantidade || ''}
                                  onChange={(e) => {
                                    const newReceita = [...novoProduto.receita];
                                    newReceita[idx].quantidade = parseFloat(e.target.value) || 0;
                                    setNovoProduto({ ...novoProduto, receita: newReceita });
                                  }}
                                  className="border rounded px-2 py-1 text-xs w-20" 
                                />
                                <select
                                  value={item.unidade || ing.unidade}
                                  onChange={(e) => {
                                    const newReceita = [...novoProduto.receita];
                                    newReceita[idx].unidade = e.target.value;
                                    setNovoProduto({ ...novoProduto, receita: newReceita });
                                  }}
                                  className="border rounded px-1 py-1 text-xs w-14"
                                >
                                  <option value="kg">kg</option>
                                  <option value="g">g</option>
                                  <option value="L">L</option>
                                  <option value="ml">ml</option>
                                  <option value="un">un</option>
                                </select>
                                <button
                                  type="button"
                                  onClick={() => {
                                    setNovoProduto({ 
                                      ...novoProduto, 
                                      receita: novoProduto.receita.filter((_, i) => i !== idx) 
                                    });
                                  }}
                                  className="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            );
                          })}
                          {novoProduto.receita.length === 0 && (
                            <p className="text-center text-gray-400 italic py-2 text-xs">
                              Nenhum ingrediente adicionado. Use a pesquisa acima.
                            </p>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {editandoProduto ? (
                      <div className="flex gap-2">
                        <button onClick={atualizarProduto}
                          className="flex-1 bg-yellow-600 text-white rounded px-4 py-2 text-sm hover:bg-yellow-700 flex items-center justify-center gap-2 font-semibold">
                          <Save size={16} />Atualizar Produto
                        </button>
                        <button onClick={cancelarEdicaoProduto}
                          className="bg-gray-400 text-white rounded px-4 py-2 text-sm hover:bg-gray-500 font-semibold">
                          Cancelar
                        </button>
                      </div>
                    ) : (
                      <button onClick={adicionarProduto}
                        className="w-full bg-green-600 text-white rounded px-4 py-2 text-sm hover:bg-green-700 flex items-center justify-center gap-2 font-semibold">
                        <Plus size={16} />Adicionar Produto
                      </button>
                    )}
                  </div>
                </div>

                {/* Search Bar Produtos */}
                <div className="mb-3">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar produto..."
                      value={searchProdutoGlobal}
                      onChange={(e) => setSearchProdutoGlobal(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                    {searchProdutoGlobal && (
                      <button
                        onClick={() => setSearchProdutoGlobal('')}
                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 font-bold"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                </div>

                {/* Products List */}
                <div className="space-y-2">
                  {produtos.filter(p => 
                    p.nome.toLowerCase().includes(searchProdutoGlobal.toLowerCase())
                  ).map((p) => {
                    const { custo, margem, margemPercentual } = calcMargem(p);
                    const isExpanded = expandedProduct === p.id;
                    
                    return (
                      <div key={p.id} className="border rounded overflow-hidden hover:shadow transition bg-white">
                        <div className="p-3">
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <h3 className="font-bold text-base">{p.nome}</h3>
                              <p className="text-xs text-gray-600">
                                Pre√ßo: <span className="font-semibold text-blue-600">‚Ç¨{p.precoVenda.toFixed(2)}</span>
                                <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                                  IVA {p.iva}%
                                </span>
                                {(() => {
                                  const categoriaInfo = {
                                    'cafes': { emoji: '‚òï', label: 'Caf√©s', cor: 'brown' },
                                    'bebidas': { emoji: 'ü•§', label: 'Bebidas', cor: 'blue' },
                                    'pratos': { emoji: 'üçΩÔ∏è', label: 'Pratos', cor: 'orange' },
                                    'sobremesas': { emoji: 'üç∞', label: 'Sobremesas', cor: 'pink' },
                                    'lanches': { emoji: 'ü•™', label: 'Lanches', cor: 'yellow' },
                                    'outros': { emoji: 'üì¶', label: 'Outros', cor: 'gray' }
                                  };
                                  const cat = categoriaInfo[p.categoria] || categoriaInfo['outros'];
                                  return (
                                    <span className={`ml-2 px-2 py-0.5 bg-${cat.cor}-100 text-${cat.cor}-700 rounded text-xs font-semibold`}>
                                      {cat.emoji} {cat.label}
                                    </span>
                                  );
                                })()}
                                {p.porcoes && p.porcoes > 1 && (
                                  <span className="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-semibold">
                                    üç∞ {p.porcoes} por√ß√µes
                                  </span>
                                )}
                                {p.receita && p.receita.some(r => {
                                  const ing = ingredientes.find(i => i.id == r.ingredienteId);
                                  return ing && ing.categoria === 'embalagens';
                                }) && (
                                  <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold">
                                    üì¶ Take-Away
                                  </span>
                                )}
                              </p>
                            </div>
                            <div className="flex gap-1">
                              {p.receita && p.receita.length > 0 && (
                                <button 
                                  onClick={() => setExpandedProduct(isExpanded ? null : p.id)}
                                  className="text-blue-600 hover:bg-blue-50 p-1.5 rounded transition"
                                  title={isExpanded ? "Ocultar receita" : "Ver receita"}
                                >
                                  {isExpanded ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                                </button>
                              )}
                              <button onClick={() => editarProduto(p)}
                                className="text-yellow-600 hover:bg-yellow-50 p-1.5 rounded transition">
                                <Edit2 size={18} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar este produto?')) {
                                  setProdutos(produtos.filter(x => x.id !== p.id));
                                  showNotification('Produto eliminado!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1.5 rounded transition">
                                <Trash2 size={18} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-3 gap-2">
                            <div className="bg-red-50 rounded p-2 border border-red-200">
                              <p className="text-xs text-red-700 mb-0.5">Custo</p>
                              <p className="font-bold text-sm text-red-800">‚Ç¨{custo.toFixed(2)}</p>
                            </div>
                            <div className="bg-green-50 rounded p-2 border border-green-200">
                              <p className="text-xs text-green-700 mb-0.5">Margem</p>
                              <p className="font-bold text-sm text-green-800">‚Ç¨{margem.toFixed(2)}</p>
                            </div>
                            <div className={`rounded p-2 border ${
                              margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                ? 'bg-green-100 border-green-300'
                                : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                  ? 'bg-yellow-100 border-yellow-300'
                                  : 'bg-red-100 border-red-300'
                            }`}>
                              <p className={`text-xs mb-0.5 ${
                                margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                  ? 'text-green-700'
                                  : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                    ? 'text-yellow-700'
                                    : 'text-red-700'
                              }`}>
                                Margem % {margemPercentual < (configuracoes?.alertas?.margemCritica || 55) ? '‚ö†Ô∏è' : ''}
                              </p>
                              <p className={`font-bold text-sm ${
                                margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                  ? 'text-green-800'
                                  : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                    ? 'text-yellow-800'
                                    : 'text-red-800'
                              }`}>
                                {margemPercentual.toFixed(1)}%
                              </p>
                            </div>
                          </div>
                          
                          {margemPercentual < (configuracoes?.alertas?.margemCritica || 55) && (
                            <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                              <p className="text-xs text-red-700 font-semibold">
                                ‚ö†Ô∏è Margem abaixo de {configuracoes?.alertas?.margemCritica || 55}% - A√ß√£o sugerida: rever pre√ßo ou receita
                              </p>
                            </div>
                          )}
                          
                          {isExpanded && p.receita && p.receita.length > 0 && (
                            <div className="mt-3 pt-3 border-t">
                              <p className="text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                <FileText size={12} />Ingredientes da Receita:
                              </p>
                              <div className="space-y-1">
                                {(p.receita || []).map((item, idx) => {
                                  const ing = ingredientes.find(i => i.id === item.ingredienteId);
                                  if (!ing) return null;
                                  const custoParcial = (() => {
                                    let q = item.quantidade;
                                    const unidadeReceita = item.unidade || ing.unidade;
                                    if (ing.unidade === 'kg' && unidadeReceita === 'g') q = item.quantidade / 1000;
                                    if (ing.unidade === 'L' && unidadeReceita === 'ml') q = item.quantidade / 1000;
                                    if (ing.unidade === 'g' && unidadeReceita === 'kg') q = item.quantidade * 1000;
                                    if (ing.unidade === 'ml' && unidadeReceita === 'L') q = item.quantidade * 1000;
                                    if (unidadeReceita === ing.unidade) q = item.quantidade;
                                    return q * ing.custoUnitario;
                                  })();
                                  
                                  return (
                                    <div key={idx} className="flex justify-between items-center text-xs bg-gray-50 p-2 rounded">
                                      <span className="font-medium text-gray-800">{ing.nome}</span>
                                      <div className="flex items-center gap-3">
                                        <span className="text-gray-600">{item.quantidade} {item.unidade || ing.unidade}</span>
                                        <span className="font-semibold text-blue-600">‚Ç¨{custoParcial.toFixed(2)}</span>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}

                </div>
              </div>
            )}

            {gestaoSubTab === 'faturas' && (
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                  üõí Gest√£o de Compras
                </h2>
                
                {/* Formul√°rio Nova Compra/Editar */}
                <div className={`rounded-lg p-4 mb-4 border-2 ${editandoFatura ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-300'}`}>
                  <div className="mb-3">
                    <h3 className="font-semibold text-sm flex items-center gap-2">
                      {editandoFatura ? '‚úèÔ∏è Editar Fatura' : '‚ûï Nova Fatura'}
                    </h3>
                  </div>
                  
                  {/* Bot√£o Ler PDF/Imagem Automaticamente */}
                  <div className="mb-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìÑ Ler Fatura Automaticamente (OCR)
                    </label>
                    <input
                      type="file"
                      accept=".pdf,image/*"
                      onChange={handleLerPDFAutomatico}
                      className="hidden"
                      id="pdf-ocr-input"
                      disabled={processandoOCR}
                    />
                    <label
                      htmlFor="pdf-ocr-input"
                      className={`block ${
                        processandoOCR 
                          ? 'bg-gray-400 cursor-not-allowed' 
                          : 'bg-purple-600 hover:bg-purple-700 cursor-pointer'
                      } text-white px-4 py-3 rounded-lg font-semibold text-center transition`}
                    >
                      {processandoOCR ? (
                        <span className="flex items-center justify-center gap-2">
                          <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                          </svg>
                          {progressoOCR || 'Processando...'}
                        </span>
                      ) : (
                        'üì∏ Ler Fatura (PDF ou Foto)'
                      )}
                    </label>
                    <p className="text-xs text-gray-500 mt-2 text-center">
                      ‚ú® Carregue PDF ou foto da fatura - extrai produtos, pre√ßos e guarda documento
                    </p>
                  </div>
                  
                  {/* Formul√°rio Fatura */}
                  <>
                      {/* Linha 1: N√∫mero, Data, Fornecedor */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            N√∫mero Fatura *
                          </label>
                          <input
                            type="text"
                            value={novaFatura.numero}
                            onChange={(e) => setNovaFatura({...novaFatura, numero: e.target.value})}
                            placeholder="F/2025/001"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            Data *
                          </label>
                          <input
                            type="date"
                            value={novaFatura.data}
                            onChange={(e) => setNovaFatura({...novaFatura, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Campo Fornecedor - N√ÉO aparece para Sal√°rios */}
                        {novaFatura.categoria !== 'salarios' && (
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Fornecedor *
                            </label>
                            <select
                              value={novaFatura.fornecedorId}
                              onChange={(e) => setNovaFatura({...novaFatura, fornecedorId: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="">Selecionar fornecedor...</option>
                              {(fornecedores || []).map(f => (
                                <option key={f.id || f} value={f.id || f}>
                                  {f.nome || f} {f.nif ? `(NIF: ${f.nif})` : ''}
                                </option>
                              ))}
                            </select>
                          </div>
                        )}
                      </div>
                      
                      {/* Linha 2: Categoria e Recorr√™ncia */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            Categoria *
                          </label>
                          <select
                            value={novaFatura.categoria}
                            onChange={(e) => setNovaFatura({...novaFatura, categoria: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="compras">üõí Compras (Ingredientes)</option>
                            <option value="renda">üè† Renda</option>
                            <option value="eletricidade">üí° Eletricidade</option>
                            <option value="agua">üíß √Ågua</option>
                            <option value="gas">üî• G√°s</option>
                            <option value="internet">üåê Internet/Telefone</option>
                            <option value="salarios">üë• Sal√°rios</option>
                            <option value="marketing">üì¢ Marketing</option>
                            <option value="consumiveis">üßª Consum√≠veis</option>
                            <option value="manutencao">üîß Manuten√ß√£o</option>
                            <option value="outros">üì¶ Outros</option>
                          </select>
                        </div>
                        
                        <div className="md:col-span-2">
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            Despesa Recorrente
                          </label>
                          <div className="flex items-center gap-3">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={novaFatura.recorrente}
                                onChange={(e) => setNovaFatura({...novaFatura, recorrente: e.target.checked})}
                                className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                              />
                              <span className="text-sm text-gray-700">Repetir mensalmente</span>
                            </label>
                            
                            {novaFatura.recorrente && (
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-gray-600">no dia</span>
                                <input
                                  type="number"
                                  min="1"
                                  max="31"
                                  value={novaFatura.diaRecorrencia}
                                  onChange={(e) => setNovaFatura({...novaFatura, diaRecorrencia: parseInt(e.target.value)})}
                                  className="w-16 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                />
                                <span className="text-xs text-gray-600">de cada m√™s</span>
                              </div>
                            )}
                          </div>
                          {novaFatura.recorrente && (
                            <p className="text-xs text-gray-500 mt-1">
                              ‚ú® Sistema vai criar automaticamente esta despesa todo m√™s no dia {novaFatura.diaRecorrencia}
                            </p>
                          )}
                        </div>
                      </div>
                      
                      {/* Items da Fatura */}
                      <div className="border-t border-gray-200 pt-3 mb-3">
                        <h4 className="font-semibold text-sm mb-2">Items da Fatura:</h4>
                        
                        {/* Adicionar Item */}
                        <div className="bg-white rounded-lg border border-gray-300 p-3 mb-3">
                          {/* MODO COMPRAS - Com ingrediente */}
                          {novaFatura.categoria === 'compras' && (
                            <>
                              {/* Campo Ingrediente com Pesquisa e Cria√ß√£o */}
                              <div className="mb-3">
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Ingrediente *
                                </label>
                                
                                {!criandoIngrediente ? (
                                  <div className="flex gap-2">
                                    {/* Input de Pesquisa */}
                                    <div className="flex-1 relative">
                                      <input
                                        type="text"
                                        value={searchIngredienteFatura}
                                        onChange={(e) => {
                                          setSearchIngredienteFatura(e.target.value);
                                          setShowDropdownIngrediente(true);
                                        }}
                                        onFocus={() => setShowDropdownIngrediente(true)}
                                        placeholder="üîç Pesquisar ou criar ingrediente..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                      />
                                      
                                      {/* Dropdown de Resultados */}
                                      {showDropdownIngrediente && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                          {ingredientes
                                            .filter(ing => !searchIngredienteFatura || ing.nome.toLowerCase().includes(searchIngredienteFatura.toLowerCase()))
                                            .map(ing => (
                                              <div
                                                key={ing.id}
                                                onClick={() => {
                                                  setItemFatura({
                                                    ...itemFatura,
                                                    ingredienteId: ing.id,
                                                    quantidade: '1',
                                                    unidade: ing.unidade,
                                                    precoTotal: ing.custoUnitario.toString(),
                                                    iva: ing.iva.toString()
                                                  });
                                                  setSearchIngredienteFatura(ing.nome);
                                                  setShowDropdownIngrediente(false); // FECHA DROPDOWN
                                                }}
                                                className="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                              >
                                                <div className="font-medium text-sm">{ing.nome}</div>
                                                <div className="text-xs text-gray-600">
                                                  ‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}/{ing.unidade} ‚Ä¢ IVA {ing.iva}%
                                                </div>
                                              </div>
                                            ))}
                                          
                                          {/* Nenhum resultado */}
                                          {ingredientes.filter(ing => !searchIngredienteFatura || ing.nome.toLowerCase().includes(searchIngredienteFatura.toLowerCase())).length === 0 && (
                                            <div className="px-3 py-4 text-center text-gray-500 text-sm">
                                              {searchIngredienteFatura ? 'Nenhum ingrediente encontrado' : 'Nenhum ingrediente criado ainda'}
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                    
                                    {/* Bot√£o Criar Novo */}
                                    <button
                                      type="button"
                                      onClick={() => {
                                        // Pr√©-preencher com dados do OCR se dispon√≠veis
                                        setNovoIngrediente({ 
                                          ...novoIngrediente, 
                                          nome: searchIngredienteFatura,
                                          iva: itemFatura.iva || '6',  // IVA da fatura
                                          precoTotal: itemFatura.precoTotal || '',  // Pre√ßo total da linha
                                          quantidade: itemFatura.quantidade || '1'  // Quantidade se dispon√≠vel
                                        });
                                        setCriandoIngrediente(true);
                                      }}
                                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold flex items-center gap-2 whitespace-nowrap"
                                    >
                                      <Plus size={16} /> Criar Novo
                                    </button>
                                  </div>
                                ) : (
                                  /* Form Inline para Criar Ingrediente */
                                  <div className="bg-green-50 border border-green-200 rounded-lg p-3 space-y-2">
                                    <div className="flex items-center justify-between mb-2">
                                      <h5 className="font-semibold text-sm text-green-800">‚ú® Criar Novo Ingrediente</h5>
                                      <button
                                        onClick={() => {
                                          setCriandoIngrediente(false);
                                          setSearchIngredienteFatura('');
                                          setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
                                        }}
                                        className="text-gray-500 hover:text-gray-700"
                                      >
                                        <X size={16} />
                                      </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Nome *</label>
                                        <input
                                          type="text"
                                          value={novoIngrediente.nome}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, nome: e.target.value})}
                                          placeholder="Ex: Pink Punk Party"
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        />
                                      </div>
                                      
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Unidade *</label>
                                        <select
                                          value={novoIngrediente.unidade}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, unidade: e.target.value})}
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        >
                                          <option value="kg">kg</option>
                                          <option value="g">g</option>
                                          <option value="L">L (litro)</option>
                                          <option value="ml">ml</option>
                                          <option value="un">unidade</option>
                                        </select>
                                      </div>
                                      
                                      {/* NOVA SEC√á√ÉO: Pre√ßo Total e Quantidade na Embalagem */}
                                      <div className="col-span-2 bg-blue-50 border-2 border-blue-300 rounded-lg p-3 space-y-2">
                                        <div className="flex items-center gap-2 mb-2">
                                          <h6 className="font-semibold text-sm text-blue-800">üì¶ M√©todo Pr√°tico (Recomendado)</h6>
                                        </div>
                                        <p className="text-xs text-blue-700 mb-2">
                                          Insira o pre√ßo total da embalagem e quantas unidades v√™m dentro. O custo unit√°rio ser√° calculado automaticamente!
                                        </p>
                                        
                                        <div className="grid grid-cols-2 gap-2">
                                          <div>
                                            <label className="block text-xs font-medium text-blue-800 mb-1">Pre√ßo Total da Embalagem (‚Ç¨)</label>
                                            <input
                                              type="number"
                                              step="0.01"
                                              value={novoIngrediente.precoTotal}
                                              onChange={(e) => setNovoIngrediente({...novoIngrediente, precoTotal: e.target.value})}
                                              placeholder="21.29"
                                              className="w-full px-2 py-1.5 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white"
                                            />
                                            <p className="text-xs text-blue-600 mt-0.5">Ex: ‚Ç¨21.29 (total na fatura)</p>
                                          </div>
                                          
                                          <div>
                                            <label className="block text-xs font-medium text-blue-800 mb-1">Qtd. de Unidades na Embalagem</label>
                                            <input
                                              type="number"
                                              step="1"
                                              value={novoIngrediente.quantidadeEmbalagem}
                                              onChange={(e) => setNovoIngrediente({...novoIngrediente, quantidadeEmbalagem: e.target.value})}
                                              placeholder="12"
                                              className="w-full px-2 py-1.5 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white"
                                            />
                                            <p className="text-xs text-blue-600 mt-0.5">Ex: 12 (cervejas na caixa)</p>
                                          </div>
                                        </div>
                                        
                                        {/* Preview do c√°lculo autom√°tico */}
                                        {novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem && (
                                          <div className="bg-white border border-blue-400 rounded p-2 mt-2">
                                            <div className="flex justify-between items-center">
                                              <span className="text-xs font-medium text-gray-600">üí° Custo Unit√°rio Calculado:</span>
                                              <span className="text-sm font-bold text-green-600">
                                                ‚Ç¨{(parseFloat(novoIngrediente.precoTotal) / parseFloat(novoIngrediente.quantidadeEmbalagem)).toFixed(3)}/{novoIngrediente.unidade}
                                              </span>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">
                                              ‚Ç¨{novoIngrediente.precoTotal} √∑ {novoIngrediente.quantidadeEmbalagem} {novoIngrediente.unidade} = ‚Ç¨{(parseFloat(novoIngrediente.precoTotal) / parseFloat(novoIngrediente.quantidadeEmbalagem)).toFixed(3)}/{novoIngrediente.unidade}
                                            </p>
                                          </div>
                                        )}
                                      </div>
                                      
                                      {/* Divisor OU */}
                                      <div className="col-span-2 flex items-center gap-2 my-1">
                                        <div className="flex-1 border-t border-gray-300"></div>
                                        <span className="text-xs text-gray-500 font-medium">OU</span>
                                        <div className="flex-1 border-t border-gray-300"></div>
                                      </div>
                                      
                                      {/* M√âTODO ALTERNATIVO: Custo Unit√°rio Direto */}
                                      <div className="col-span-2 bg-gray-50 border border-gray-300 rounded-lg p-3">
                                        <h6 className="font-semibold text-xs text-gray-700 mb-2">üìä M√©todo Alternativo</h6>
                                        <p className="text-xs text-gray-600 mb-2">Ou insira diretamente o custo unit√°rio se j√° o conhecer:</p>
                                        
                                        <div>
                                          <label className="block text-xs font-medium text-gray-700 mb-1">
                                            Custo Unit√°rio (‚Ç¨/{novoIngrediente.unidade === 'g' ? 'kg' : novoIngrediente.unidade === 'ml' ? 'L' : novoIngrediente.unidade})
                                          </label>
                                          <input
                                            type="number"
                                            step="0.001"
                                            value={novoIngrediente.custoUnitario}
                                            onChange={(e) => setNovoIngrediente({...novoIngrediente, custoUnitario: e.target.value})}
                                            placeholder="1.77"
                                            className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-gray-400"
                                            disabled={novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem}
                                          />
                                          <p className="text-xs text-gray-500 mt-0.5">
                                            {novoIngrediente.unidade === 'g' && '(pre√ßo por kg, mesmo comprando em g)'}
                                            {novoIngrediente.unidade === 'ml' && '(pre√ßo por L, mesmo comprando em ml)'}
                                            {novoIngrediente.unidade === 'kg' && '(pre√ßo por kg)'}
                                            {novoIngrediente.unidade === 'L' && '(pre√ßo por litro)'}
                                            {novoIngrediente.unidade === 'un' && '(pre√ßo por unidade)'}
                                          </p>
                                        </div>
                                      </div>
                                      
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">IVA *</label>
                                        <select
                                          value={novoIngrediente.iva}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, iva: e.target.value})}
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        >
                                          <option value="6">6%</option>
                                          <option value="13">13%</option>
                                          <option value="23">23%</option>
                                        </select>
                                      </div>
                                      
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Categoria *</label>
                                        <select
                                          value={novoIngrediente.categoria}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, categoria: e.target.value})}
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        >
                                          <option value="bebidas">Bebidas</option>
                                          <option value="cafe">Caf√©</option>
                                          <option value="lacteos">Latic√≠nios</option>
                                          <option value="padaria">Padaria</option>
                                          <option value="carnes">Carnes</option>
                                          <option value="vegetais">Vegetais</option>
                                          <option value="embalagens">Embalagens</option>
                                          <option value="consumiveis">Consum√≠veis</option>
                                          <option value="outros">Outros</option>
                                        </select>
                                      </div>
                                      
                                      {/* Quantidade para fatura (opcional) */}
                                      <div className="col-span-2 border-t border-gray-200 pt-2 mt-1">
                                        <label className="block text-xs font-medium text-gray-700 mb-1">
                                          Quantidade Comprada (para esta fatura)
                                        </label>
                                        <input
                                          type="number"
                                          step="0.01"
                                          value={novoIngrediente.quantidade || '1'}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, quantidade: e.target.value})}
                                          placeholder="12"
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        />
                                        <p className="text-xs text-gray-500 mt-0.5">
                                          Quantas {novoIngrediente.unidade === 'un' ? 'unidades' : novoIngrediente.unidade} comprou nesta fatura?
                                        </p>
                                      </div>
                                    </div>
                                    
                                    <button
                                      onClick={criarIngredienteInline}
                                      className="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-semibold"
                                    >
                                      ‚ú® Criar e Adicionar √† Fatura
                                    </button>
                                  </div>
                                )}
                              </div>
                              
                              {/* Resto dos campos (s√≥ mostra se ingrediente selecionado) */}
                              {itemFatura.ingredienteId && (
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Quantidade *
                                </label>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={itemFatura.quantidade}
                                  onChange={(e) => setItemFatura({...itemFatura, quantidade: e.target.value})}
                                  placeholder="300"
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Unidade *
                                </label>
                                <select
                                  value={itemFatura.unidade}
                                  onChange={(e) => setItemFatura({...itemFatura, unidade: e.target.value})}
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                >
                                  <option value="">Selecione</option>
                                  <option value="kg">kg</option>
                                  <option value="g">g</option>
                                  <option value="L">L</option>
                                  <option value="ml">ml</option>
                                  <option value="unidade">unidade</option>
                                </select>
                                <p className="text-xs text-gray-500 mt-0.5">Unidade comprada</p>
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Pre√ßo Total (‚Ç¨) *
                                </label>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={itemFatura.precoTotal}
                                  onChange={(e) => setItemFatura({...itemFatura, precoTotal: e.target.value})}
                                  placeholder="0.24"
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                />
                                <p className="text-xs text-gray-500 mt-0.5">Total pago</p>
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  IVA
                                </label>
                                <select
                                  value={itemFatura.iva}
                                  onChange={(e) => setItemFatura({...itemFatura, iva: e.target.value})}
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                >
                                  <option value="6">6%</option>
                                  <option value="13">13%</option>
                                  <option value="23">23%</option>
                                </select>
                              </div>
                              
                              <div className="flex items-end">
                                <button
                                  onClick={adicionarItemFatura}
                                  className="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-semibold transition flex items-center justify-center gap-1"
                                >
                                  <Plus size={14} /> Adicionar
                                </button>
                              </div>
                            </div>
                              )}
                            </>
                          )}
                          
                          {/* MODO OUTRAS DESPESAS - Com descri√ß√£o */}
                          {novaFatura.categoria !== 'compras' && (
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                              <div className="md:col-span-2">
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Descri√ß√£o *
                                </label>
                                <input
                                  type="text"
                                  value={itemFatura.descricao}
                                  onChange={(e) => setItemFatura({...itemFatura, descricao: e.target.value})}
                                  placeholder="Ex: Renda Janeiro, Conta Luz Dezembro..."
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Valor Total (‚Ç¨) *
                                </label>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={itemFatura.precoTotal}
                                  onChange={(e) => setItemFatura({...itemFatura, precoTotal: e.target.value})}
                                  placeholder="650.00"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              
                              {/* Campo IVA - N√ÉO aparece para Sal√°rios */}
                              {novaFatura.categoria !== 'salarios' && (
                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">
                                    IVA
                                  </label>
                                  <select
                                    value={itemFatura.iva}
                                    onChange={(e) => setItemFatura({...itemFatura, iva: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="6">6%</option>
                                    <option value="13">13%</option>
                                    <option value="23">23%</option>
                                  </select>
                                </div>
                              )}
                              
                              {/* Campo N¬∫ Funcion√°rios - S√ì para Sal√°rios */}
                              {novaFatura.categoria === 'salarios' && (
                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">
                                    N¬∫ Funcion√°rios *
                                  </label>
                                  <input
                                    type="number"
                                    min="1"
                                    value={itemFatura.num_funcionarios || 1}
                                    onChange={(e) => setItemFatura({
                                      ...itemFatura,
                                      num_funcionarios: parseInt(e.target.value) || 1
                                    })}
                                    placeholder="1"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  />
                                  <p className="text-xs text-gray-500 mt-1">
                                    üí° Quantas pessoas recebem este sal√°rio
                                  </p>
                                </div>
                              )}
                              
                              <div className="flex items-end md:col-span-4">
                                <button
                                  onClick={adicionarItemFatura}
                                  className="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2"
                                >
                                  <Plus size={16} /> Adicionar Item
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                    
                    {/* Lista de Items */}
                    {(novaFatura.itens || []).length > 0 ? (
                      <div className="space-y-2">
                        {(novaFatura.itens || []).map(item => (
                          <div key={item.id} className="bg-gray-50 rounded-lg p-3 flex items-center justify-between border border-gray-200">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <span className="font-semibold text-sm">{item.ingredienteNome}</span>
                                <span className="text-xs text-gray-500">({item.unidade})</span>
                              </div>
                              <div className="text-xs text-gray-600 mt-1">
                                {item.quantidade} √ó ‚Ç¨{item.precoUnitario.toFixed(2)} = <strong>‚Ç¨{item.subtotal.toFixed(2)}</strong>
                                <span className="ml-2 text-gray-500">(IVA {item.iva}%)</span>
                              </div>
                            </div>
                            <button
                              onClick={() => removerItemFatura(item.id)}
                              className="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition"
                            >
                              <Trash2 size={16} />
                            </button>
                          </div>
                        ))}
                        
                        {/* Totais */}
                        <div className="bg-blue-50 rounded-lg p-3 border border-blue-200 mt-3">
                          <div className="flex justify-between text-sm mb-1">
                            <span>Subtotal:</span>
                            <span className="font-semibold">‚Ç¨{novaFatura.itens.reduce((s, i) => s + i.subtotal, 0).toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between text-sm mb-1">
                            <span>IVA Total:</span>
                            <span className="font-semibold">‚Ç¨{novaFatura.itens.reduce((s, i) => s + (i.subtotal * i.iva / 100), 0).toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between text-base font-bold border-t border-blue-300 pt-2 mt-1">
                            <span>Total c/ IVA:</span>
                            <span className="text-blue-700">‚Ç¨{novaFatura.itens.reduce((s, i) => s + (i.subtotal * (1 + i.iva / 100)), 0).toFixed(2)}</span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="text-center text-gray-500 text-sm py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        Nenhum item adicionado. Adicione items acima.
                      </div>
                    )}
                  </div>
                  
                  {/* Notas */}
                  <div className="mb-3">
                    <label className="block text-xs font-medium text-gray-700 mb-1">
                      Notas (opcional)
                    </label>
                    <textarea
                      value={novaFatura.notas}
                      onChange={(e) => setNovaFatura({...novaFatura, notas: e.target.value})}
                      placeholder="Observa√ß√µes sobre a fatura..."
                      rows={2}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  
                  {/* Bot√µes */}
                  <div className="flex gap-2">
                    {editandoFatura ? (
                      <>
                        <button
                          onClick={atualizarFatura}
                          className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                        >
                          <Save size={16} /> Atualizar Fatura
                        </button>
                        <button
                          onClick={cancelarEdicaoFatura}
                          className="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition"
                        >
                          Cancelar
                        </button>
                      </>
                    ) : (
                      <button
                        onClick={salvarFatura}
                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                      >
                        <Save size={16} /> Guardar
                      </button>
                    )}
                  </div>
                </>
              )}
              
            </div>
                
                {/* Lista de Faturas */}
                <div>
                  <h3 className="font-semibold text-sm mb-3 flex items-center justify-between">
                    <span>üõí Compras Registadas ({(faturas || []).length})</span>
                    <div className="flex items-center gap-3 text-xs">
                      <span className="flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded font-semibold">
                        <FilePdf size={14} />
                        {(faturas || []).filter(f => f.documentoPDF).length} com PDF
                      </span>
                      <span className="flex items-center gap-1 bg-red-100 text-red-700 px-2 py-1 rounded font-semibold">
                        <AlertCircle size={14} />
                        {(faturas || []).filter(f => !f.documentoPDF).length} sem PDF
                      </span>
                    </div>
                  </h3>
                  
                  {(faturas || []).length === 0 ? (
                    <div className="text-center text-gray-500 text-sm py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                      Nenhuma fatura registada. Crie a primeira fatura acima!
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {(faturas || []).sort((a, b) => new Date(b.data) - new Date(a.data)).map(fatura => (
                        <div key={fatura.id} className="border rounded-lg overflow-hidden hover:shadow-md transition">
                          {/* Cabe√ßalho da Fatura (sempre vis√≠vel) */}
                          <div 
                            onClick={() => setExpandedFatura(expandedFatura === fatura.id ? null : fatura.id)}
                            className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 cursor-pointer hover:from-blue-100 hover:to-purple-100 transition"
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-1">
                                  <span className="font-bold text-blue-700">
                                    {fatura.tipo === 'rapido' ? '‚ö°' : 'üìÑ'} {fatura.numero || 'Recibo'}
                                  </span>
                                  
                                  {/* Badge Fatura/Recibo */}
                                  {fatura.tipoDocumento && (
                                    <span className={`text-xs px-2 py-1 rounded font-bold ${
                                      fatura.tipoDocumento === 'fatura'
                                        ? 'bg-green-100 text-green-700 border border-green-300'
                                        : 'bg-gray-100 text-gray-700 border border-gray-300'
                                    }`}>
                                      {fatura.tipoDocumento === 'fatura' ? 'üßæ FATURA' : 'üìù RECIBO'}
                                    </span>
                                  )}
                                  
                                  {/* Indicador de PDF */}
                                  {fatura.documentoPDF ? (
                                    <span 
                                      className="flex items-center gap-1 text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-semibold"
                                      title="PDF anexado"
                                    >
                                      <FilePdf size={14} />
                                      <Check size={12} />
                                      PDF
                                    </span>
                                  ) : (
                                    <span 
                                      className="flex items-center gap-1 text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-semibold"
                                      title="SEM PDF - Adicione o documento fiscal!"
                                    >
                                      <AlertCircle size={14} />
                                      SEM PDF
                                    </span>
                                  )}
                                  
                                  <span className="text-sm text-gray-600">{fatura.fornecedorNome}</span>
                                  <span className="text-xs text-gray-500">{new Date(fatura.data).toLocaleDateString('pt-PT')}</span>
                                </div>
                                <div className="flex items-center gap-4 text-sm">
                                  <span className="text-gray-600">{(fatura.itens || []).length} {(fatura.itens || []).length === 1 ? 'item' : 'items'}</span>
                                  <span className="font-bold text-blue-700">Total: ‚Ç¨{(fatura.total || 0).toFixed(2)}</span>
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    editarFatura(fatura);
                                  }}
                                  className="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-2 rounded transition"
                                >
                                  <Edit2 size={16} />
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    apagarFatura(fatura.id);
                                  }}
                                  className="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition"
                                >
                                  <Trash2 size={16} />
                                </button>
                                <button className="text-gray-600">
                                  {expandedFatura === fatura.id ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>
                              </div>
                            </div>
                          </div>
                          
                          {/* Detalhes da Fatura (expans√≠vel) */}
                          {expandedFatura === fatura.id && (
                            <div className="bg-white p-4 border-t">
                              <div className="mb-3">
                                <h4 className="font-semibold text-sm mb-2 text-gray-700">Fornecedor:</h4>
                                <div className="bg-gray-50 rounded p-2 text-sm">
                                  <p><strong>{fatura.fornecedorNome}</strong></p>
                                  {fatura.fornecedorNif && <p className="text-gray-600 text-xs">NIF: {fatura.fornecedorNif}</p>}
                                </div>
                              </div>
                              
                              <div className="mb-3">
                                <h4 className="font-semibold text-sm mb-2 text-gray-700">Items:</h4>
                                <div className="space-y-2">
                                  {(fatura.itens || []).map(item => {
                                    const ingredienteNome = item.ingredienteNome || 'N/A';
                                    const quantidade = item.quantidade || 0;
                                    const precoUnitario = item.precoUnitario || 0;
                                    const subtotal = item.subtotal || 0;
                                    const unidade = item.unidade || '';
                                    const iva = item.iva || 6;
                                    
                                    return (
                                    <div key={item.id || Math.random()} className="bg-gray-50 rounded p-3 text-sm">
                                      <div className="flex justify-between items-start mb-1">
                                        <span className="font-medium">{ingredienteNome}</span>
                                        <span className="font-semibold text-blue-700">‚Ç¨{subtotal.toFixed(2)}</span>
                                      </div>
                                      <div className="text-xs text-gray-600">
                                        {quantidade} {unidade} √ó ‚Ç¨{precoUnitario.toFixed(2)}
                                        <span className="ml-2">(IVA {iva}%: +‚Ç¨{(subtotal * iva / 100).toFixed(2)})</span>
                                      </div>
                                    </div>
                                    );
                                  })}
                                </div>
                              </div>
                              
                              <div className="bg-blue-50 rounded p-3 border border-blue-200">
                                <div className="flex justify-between text-sm mb-1">
                                  <span>Subtotal:</span>
                                  <span className="font-semibold">‚Ç¨{(fatura.subtotal || fatura.total || 0).toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between text-sm mb-1">
                                  <span>IVA Total:</span>
                                  <span className="font-semibold">‚Ç¨{(fatura.totalIva || 0).toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between text-base font-bold border-t border-blue-300 pt-2 mt-1">
                                  <span>Total c/ IVA:</span>
                                  <span className="text-blue-700">‚Ç¨{(fatura.total || 0).toFixed(2)}</span>
                                </div>
                              </div>
                              
                              {fatura.notas && (
                                <div className="mt-3 bg-yellow-50 rounded p-2 border border-yellow-200">
                                  <p className="text-xs text-gray-700"><strong>Notas:</strong> {fatura.notas}</p>
                                </div>
                              )}
                              
                              {/* Sec√ß√£o de PDF */}
                              <div className="mt-3">
                                {fatura.documentoPDF ? (
                                  <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center gap-3">
                                        <div>
                                          <p className="text-sm font-semibold text-green-900">
                                            üìÑ {fatura.nomeDocumento || 'Documento.pdf'}
                                          </p>
                                          <p className="text-xs text-green-700">
                                            PDF anexado ‚úÖ
                                          </p>
                                        </div>
                                      </div>
                                      <button
                                        onClick={() => {
                                          try {
                                            // Converter base64 para Blob
                                            const base64Data = fatura.documentoPDF.split(',')[1] || fatura.documentoPDF;
                                            const byteCharacters = atob(base64Data);
                                            const byteNumbers = new Array(byteCharacters.length);
                                            for (let i = 0; i < byteCharacters.length; i++) {
                                              byteNumbers[i] = byteCharacters.charCodeAt(i);
                                            }
                                            const byteArray = new Uint8Array(byteNumbers);
                                            const blob = new Blob([byteArray], { type: 'application/pdf' });
                                            
                                            // Criar URL do blob
                                            const blobUrl = URL.createObjectURL(blob);
                                            
                                            // Abrir em nova janela
                                            window.open(blobUrl, '_blank');
                                          } catch (error) {
                                            console.error('Erro ao abrir PDF:', error);
                                            alert('Erro ao abrir PDF. Verifique a consola para detalhes.');
                                          }
                                        }}
                                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition"
                                      >
                                        <Eye size={18} />
                                        Visualizar PDF
                                      </button>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="bg-red-50 border-2 border-red-300 rounded-lg p-3">
                                    <div className="flex items-center gap-3">
                                      <div className="flex-1">
                                        <p className="text-sm font-semibold text-red-900">
                                          ‚ö†Ô∏è SEM PDF Anexado
                                        </p>
                                        <p className="text-xs text-red-700 mt-1">
                                          Sem o documento fiscal original, a AT pode rejeitar a dedu√ß√£o de IVA!
                                          Edite a fatura e adicione o PDF.
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              

</div>
            )}

            {gestaoSubTab === 'vendas' && (
              <div className="bg-white rounded-lg shadow p-3">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-bold">Gest√£o de Vendas</h2>
                  <button
                    onClick={() => setMostrarVendaManual(true)}
                    className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition flex items-center gap-2 font-semibold shadow"
                  >
                    <Plus size={18} />
                    Adicionar Venda Manual
                  </button>
                </div>
                
                {/* NOVO: Importa√ß√£o com Mapeamento Autom√°tico */}
                <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
                  <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                    <Upload size={20} />
                    üì• Importar Vendas
                  </h3>
                  <p className="text-sm text-gray-600 mb-3">
                    Importe vendas do Moloni (CSV) ou Zobaze (Excel) com mapeamento autom√°tico de produtos.
                  </p>
                  <button
                    onClick={() => setMostrarImportacao(true)}
                    className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition flex items-center gap-2 font-bold shadow-lg w-full justify-center"
                  >
                    <Upload size={18} />
                    üöÄ Importar com Mapeamento Autom√°tico
                  </button>
                </div>

                {/* Sales Table */}
                <div className="overflow-x-auto rounded border">
                  <table className="w-full text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left font-semibold">Data</th>
                        <th className="px-2 py-2 text-left font-semibold">Produto</th>
                        <th className="px-2 py-2 text-right font-semibold">Quantidade</th>
                        <th className="px-2 py-2 text-right font-semibold">Valor</th>
                        <th className="px-2 py-2 text-center font-semibold">IVA</th>
                        <th className="px-2 py-2 text-center font-semibold">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {vendas.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 100).map((v, idx) => (
                        <tr key={v.id} className={`border-t hover:bg-gray-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 py-2">{new Date(v.data).toLocaleDateString('pt-PT')}</td>
                          <td className="px-2 py-2 font-medium">
                            <div className="flex items-center gap-2">
                              {v.produto}
                              {/* Tag de Origem */}
                              {v.origem === 'moloni' && (
                                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-[10px] font-bold" title="Importado do Moloni">
                                  MOLONI
                                </span>
                              )}
                              {v.origem === 'zobaze' && (
                                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-bold" title="Importado do Zobaze">
                                  ZOBAZE
                                </span>
                              )}
                              {!v.origem && v.tipo === 'manual' && (
                                <span className="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-[10px] font-bold" title="Venda manual">
                                  MANUAL
                                </span>
                              )}
                              {!v.produtoId && (
                                <span className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold" title="Produto n√£o emparelhado">
                                  ‚ö†Ô∏è Sem emparelhamento
                                </span>
                              )}
                            </div>
                          </td>
                          <td className="px-2 py-2 text-right">{v.quantidade}</td>
                          <td className="px-2 py-2 text-right font-bold text-green-600">‚Ç¨{v.valor.toFixed(2)}</td>
                          <td className="px-2 py-2 text-center">
                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                              {v.iva}%
                            </span>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button 
                                onClick={() => {
                                  setVendaEditando(v.id);
                                  setNovaVenda({
                                    data: v.data,
                                    produtoId: v.produtoId || '',
                                    produto: v.produto,
                                    quantidade: v.quantidade,
                                    valorManual: v.valor.toString(),
                                    usarValorManual: true
                                  });
                                  setMostrarEditarVenda(true);
                                }}
                                className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                title="Editar venda"
                              >
                                <Edit size={14} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar esta venda?')) {
                                  setVendas(vendas.filter(x => x.id !== v.id));
                                  showNotification('Venda eliminada!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="Eliminar venda"
                              >
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                {(vendas || []).length > 100 && (
                  <p className="text-center text-xs text-gray-500 mt-2">
                    A mostrar as 100 vendas mais recentes de {(vendas || []).length} totais
                  </p>
                )}
                
                {!(vendas || []).length && (
                  <div className="text-center py-12">
                    <p className="text-gray-400 text-sm">Nenhuma venda importada</p>
                    <p className="text-gray-400 text-xs mt-1">Importe um ficheiro CSV do Moloni ou adicione vendas manualmente</p>
                  </div>
                )}
                
                {/* Modal Venda Manual */}
                {mostrarVendaManual && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold">Adicionar Venda Manual</h3>
                        <button
                          onClick={() => setMostrarVendaManual(false)}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <X size={24} />
                        </button>
                      </div>
                      
                      <div className="space-y-4">
                        {/* Data */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Data *
                          </label>
                          <input
                            type="date"
                            value={novaVenda.data}
                            onChange={(e) => setNovaVenda({...novaVenda, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          />
                        </div>
                        
                        {/* Produto */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Produto * {produtos.length === 0 && <span className="text-red-500 text-xs">(Nenhum produto dispon√≠vel)</span>}
                          </label>
                          <select
                            value={novaVenda.produtoId}
                            onChange={(e) => setNovaVenda({...novaVenda, produtoId: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          >
                            <option value="">Selecione um produto</option>
                            {produtos.map(p => (
                              <option key={p.id} value={p.id}>
                                {p.nome} - ‚Ç¨{p.precoVenda.toFixed(2)} (IVA {p.iva}%)
                              </option>
                            ))}
                          </select>
                        </div>
                        
                        {/* Quantidade */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Quantidade *
                          </label>
                          <input
                            type="number"
                            min="1"
                            step="1"
                            value={novaVenda.quantidade}
                            onChange={(e) => setNovaVenda({...novaVenda, quantidade: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          />
                        </div>
                        
                        {/* Informa√ß√£o do produto selecionado */}
                        {novaVenda.produtoId && (() => {
                          const produtoSelecionado = produtos.find(p => p.id === novaVenda.produtoId);
                          if (!produtoSelecionado) return null;
                          
                          const valorCalculado = produtoSelecionado.precoVenda * parseFloat(novaVenda.quantidade || 0);
                          
                          return (
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg space-y-2">
                              <div className="flex justify-between text-sm">
                                <span className="text-gray-600">Pre√ßo unit√°rio:</span>
                                <span className="font-semibold">‚Ç¨{produtoSelecionado.precoVenda.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between text-sm">
                                <span className="text-gray-600">IVA:</span>
                                <span className="font-semibold">{produtoSelecionado.iva}%</span>
                              </div>
                              <div className="flex justify-between text-sm pt-2 border-t border-blue-300">
                                <span className="text-gray-700 font-medium">Valor total:</span>
                                <span className="font-bold text-green-600 text-lg">‚Ç¨{valorCalculado.toFixed(2)}</span>
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* Valor manual (opcional) */}
                        {novaVenda.produtoId && (
                          <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <label className="flex items-center gap-2 cursor-pointer mb-2">
                              <input
                                type="checkbox"
                                checked={novaVenda.usarValorManual}
                                onChange={(e) => setNovaVenda({...novaVenda, usarValorManual: e.target.checked})}
                                className="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                              />
                              <span className="text-sm text-gray-700 font-medium">Sobrescrever valor total</span>
                            </label>
                            
                            {novaVenda.usarValorManual && (
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">Valor personalizado:</label>
                                <input
                                  type="number"
                                  step="0.01"
                                  min="0"
                                  value={novaVenda.valorManual}
                                  onChange={(e) => setNovaVenda({...novaVenda, valorManual: e.target.value})}
                                  placeholder="‚Ç¨0.00"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                  Use isto para descontos ou promo√ß√µes especiais
                                </p>
                              </div>
                            )}
                          </div>
                        )}
                        
                        {/* Campos de Documenta√ß√£o Oficial (Expand√≠vel) */}
                        <details className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                          <summary className="cursor-pointer font-medium text-sm text-gray-700 flex items-center gap-2">
                            üìã Documenta√ß√£o Oficial (Opcional)
                          </summary>
                          <div className="space-y-3 mt-3">
                            {/* N√∫mero do Documento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                N¬∫ Documento
                              </label>
                              <input
                                type="text"
                                value={novaVenda.numeroDocumento}
                                onChange={(e) => setNovaVenda({...novaVenda, numeroDocumento: e.target.value})}
                                placeholder="Ex: VD-2026-0001"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              />
                            </div>
                            
                            {/* Tipo de Documento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Tipo de Documento
                              </label>
                              <select
                                value={novaVenda.tipoDocumento}
                                onChange={(e) => setNovaVenda({...novaVenda, tipoDocumento: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              >
                                <option value="Venda">Venda</option>
                                <option value="Fatura Simplificada">Fatura Simplificada</option>
                                <option value="Fatura">Fatura</option>
                                <option value="Recibo">Recibo</option>
                                <option value="Nota de Cr√©dito">Nota de Cr√©dito</option>
                              </select>
                            </div>
                            
                            {/* Forma de Pagamento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Forma de Pagamento
                              </label>
                              <select
                                value={novaVenda.formaPagamento}
                                onChange={(e) => setNovaVenda({...novaVenda, formaPagamento: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              >
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="MB Way">MB Way</option>
                                <option value="Multibanco">Multibanco</option>
                                <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
                                <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
                                <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                                <option value="Cheque">Cheque</option>
                              </select>
                            </div>
                            
                            {/* Observa√ß√µes */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Observa√ß√µes
                              </label>
                              <textarea
                                value={novaVenda.observacoes}
                                onChange={(e) => setNovaVenda({...novaVenda, observacoes: e.target.value})}
                                placeholder="Informa√ß√µes adicionais..."
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              />
                            </div>
                          </div>
                        </details>
                        
                        {/* Bot√µes */}
                        <div className="flex gap-3 pt-4">
                          <button
                            onClick={() => setMostrarVendaManual(false)}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={adicionarVendaManual}
                            className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                          >
                            Adicionar Venda
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Modal Editar Venda */}
                {mostrarEditarVenda && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold">‚úèÔ∏è Editar Venda</h3>
                        <button
                          onClick={() => {
                            setMostrarEditarVenda(false);
                            setVendaEditando(null);
                          }}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <X size={20} />
                        </button>
                      </div>
                      
                      <div className="space-y-4">
                        {/* Nome do Produto Original */}
                        <div className="bg-gray-50 border rounded-lg p-3">
                          <p className="text-xs text-gray-600 mb-1">Produto importado:</p>
                          <p className="font-bold text-gray-800">{novaVenda.produto}</p>
                        </div>
                        
                        {/* Emparelhar com Produto */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">
                            üîó Emparelhar com Produto:
                          </label>
                          <select
                            value={novaVenda.produtoId}
                            onChange={(e) => {
                              const prodId = e.target.value;
                              const prod = produtos.find(p => p.id === prodId);
                              setNovaVenda({
                                ...novaVenda, 
                                produtoId: prodId,
                                valorManual: prod ? prod.precoVenda.toString() : novaVenda.valorManual
                              });
                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- Sem emparelhamento --</option>
                            {produtos.map(p => (
                              <option key={p.id} value={p.id}>
                                {p.nome} (‚Ç¨{p.precoVenda})
                              </option>
                            ))}
                          </select>
                          <p className="text-xs text-gray-500 mt-1">
                            {novaVenda.produtoId 
                              ? '‚úÖ Produto emparelhado - aparecer√° nas m√©tricas' 
                              : '‚ö†Ô∏è Sem emparelhamento - n√£o afeta m√©tricas de produto'}
                          </p>
                        </div>
                        
                        {/* Data */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Data:</label>
                          <input
                            type="date"
                            value={novaVenda.data}
                            onChange={(e) => setNovaVenda({...novaVenda, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Quantidade */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Quantidade:</label>
                          <input
                            type="number"
                            min="1"
                            value={novaVenda.quantidade}
                            onChange={(e) => setNovaVenda({...novaVenda, quantidade: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Valor */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Valor (‚Ç¨):</label>
                          <input
                            type="number"
                            step="0.01"
                            min="0"
                            value={novaVenda.valorManual}
                            onChange={(e) => setNovaVenda({...novaVenda, valorManual: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Bot√µes */}
                        <div className="flex gap-2 pt-4">
                          <button
                            onClick={() => {
                              setMostrarEditarVenda(false);
                              setVendaEditando(null);
                            }}
                            className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={() => {
                              const vendaAtualizada = {
                                ...vendas.find(v => v.id === vendaEditando),
                                data: novaVenda.data,
                                produtoId: novaVenda.produtoId || null,
                                produto: novaVenda.produtoId 
                                  ? produtos.find(p => p.id === novaVenda.produtoId)?.nome || novaVenda.produto
                                  : novaVenda.produto,
                                quantidade: novaVenda.quantidade,
                                valor: parseFloat(novaVenda.valorManual)
                              };
                              
                              setVendas(vendas.map(v => 
                                v.id === vendaEditando ? vendaAtualizada : v
                              ));
                              
                              setMostrarEditarVenda(false);
                              setVendaEditando(null);
                              showNotification('‚úÖ Venda atualizada!', 'success');
                            }}
                            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                          >
                            üíæ Guardar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* TAB DEFINI√á√ïES */}
        {activeTab === 'definicoes' && (
          <div className="space-y-3">
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-2xl font-bold mb-4">
                ‚öôÔ∏è Defini√ß√µes
              </h2>
              <p className="text-gray-600 mb-6">Configure as prefer√™ncias do Munchi Manager</p>
              
              <div className="space-y-6">
                {/* GEST√ÉO DE BLACKLIST OCR */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-red-50 to-orange-50">
                  <button
                    onClick={() => setBlacklistExpanded(!blacklistExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-red-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üö´ Blacklist OCR
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Gerir linhas ignoradas pelo OCR
                      </p>
                    </div>
                    {blacklistExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {blacklistExpanded && (
                    <div className="p-4 border-t border-red-200 bg-white">
                      <p className="text-sm text-gray-600 mb-4">
                        Estas s√£o linhas que foram adicionadas √† blacklist e nunca aparecer√£o nas sugest√µes do OCR.
                        Se adicionaste algo por engano, podes remover aqui.
                      </p>
                      
                      {(() => {
                        // Agrupar blacklist por fornecedor
                        const blacklistPorFornecedor = {};
                        
                        templatesOCR.forEach(template => {
                          if (template.blacklist && template.blacklist.length > 0) {
                            const fornecedor = fornecedores.find(f => f.nif === template.nifFornecedor);
                            blacklistPorFornecedor[template.nifFornecedor] = {
                              nome: fornecedor?.nome || `NIF ${template.nifFornecedor}`,
                              items: template.blacklist
                            };
                          }
                        });
                        
                        const numFornecedores = Object.keys(blacklistPorFornecedor).length;
                        
                        if (numFornecedores === 0) {
                          return (
                            <div className="text-center py-8 bg-gray-50 rounded-lg">
                              <p className="text-gray-500">
                                ‚úÖ Blacklist vazia<br/>
                                <span className="text-sm">Nenhuma linha foi adicionada √† blacklist ainda.</span>
                              </p>
                            </div>
                          );
                        }
                        
                        return (
                          <div className="space-y-4">
                            <p className="text-sm font-semibold text-gray-700">
                              üìã {numFornecedores} fornecedor(es) com blacklist
                            </p>
                            
                            {Object.entries(blacklistPorFornecedor).map(([nif, dados]) => (
                              <div key={nif} className="border border-gray-200 rounded-lg p-3 bg-gray-50">
                                <h4 className="font-semibold text-sm mb-2 flex items-center gap-2">
                                  üè¢ {dados.nome}
                                  <span className="text-xs text-gray-500">({dados.items.length} items)</span>
                                </h4>
                                
                                <div className="space-y-2">
                                  {dados.items.map((item, idx) => (
                                    <div key={idx} className="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                                      <span className="text-sm font-mono text-gray-700">{item}</span>
                                      <button
                                        onClick={() => {
                                          if (confirm(`Remover "${item}" da blacklist?`)) {
                                            // Remover da blacklist
                                            const template = templatesOCR.find(t => t.nifFornecedor === nif);
                                            if (template) {
                                              const novaBlacklist = template.blacklist.filter(b => b !== item);
                                              const index = templatesOCR.findIndex(t => t.nifFornecedor === nif);
                                              const novos = [...templatesOCR];
                                              novos[index] = { ...template, blacklist: novaBlacklist };
                                              setTemplatesOCR(novos);
                                              showNotification('‚úÖ Removido da blacklist!', 'success');
                                            }
                                          }
                                        }}
                                        className="text-red-600 hover:text-red-800 text-xs font-semibold px-2 py-1 hover:bg-red-50 rounded transition"
                                      >
                                        ‚ùå Remover
                                      </button>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ))}
                          </div>
                        );
                      })()}
                    </div>
                  )}
                </div>
                
                {/* ==================== CONFIGURA√á√ïES V2.0 ==================== */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-green-50 to-blue-50">
                  <button
                    onClick={() => setConfiguracoesExpanded(!configuracoesExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-green-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        ‚öôÔ∏è Configura√ß√µes do Sistema
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Filtros de m√©tricas e alertas de margem
                      </p>
                    </div>
                    {configuracoesExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {configuracoesExpanded && (
                    <div className="p-4 border-t border-green-200 bg-white">
                      <PainelConfiguracoes
                        configuracoes={configuracoes}
                        onSalvar={handleSalvarConfiguracoes}
                        vendas={vendas}
                        setVendas={setVendas}
                        showNotification={showNotification}
                      />
                    </div>
                  )}
                </div>
                {/* ==================== FIM CONFIGURA√á√ïES V2.0 ==================== */}
                
                {/* Dados da Empresa */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-blue-50 to-purple-50">
                  <button
                    onClick={() => setDadosEmpresaExpanded(!dadosEmpresaExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-blue-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üè¢ Dados da Empresa
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Informa√ß√µes fiscais da sua empresa
                      </p>
                    </div>
                    {dadosEmpresaExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {dadosEmpresaExpanded && (
                    <div className="p-4 border-t border-blue-200 bg-white">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        NIF/NIPC *
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).nif}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), nif: e.target.value})}
                        placeholder="123456789"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Nome da Empresa *
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).nome}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), nome: e.target.value})}
                        placeholder="Munchi Restaurant, Lda"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Morada Fiscal
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).morada}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), morada: e.target.value})}
                        placeholder="Rua Example, 123"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        C√≥digo Postal
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).codigoPostal}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), codigoPostal: e.target.value})}
                        placeholder="1000-001"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Cidade
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).cidade}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), cidade: e.target.value})}
                        placeholder="Lisboa"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        CAE (C√≥digo Atividade)
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).cae}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), cae: e.target.value})}
                        placeholder="56101"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Email
                      </label>
                      <input
                        type="email"
                        value={(dadosEmpresa || {}).email}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), email: e.target.value})}
                        placeholder="geral@munchi.pt"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Telefone
                      </label>
                      <input
                        type="tel"
                        value={(dadosEmpresa || {}).telefone}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), telefone: e.target.value})}
                        placeholder="+351 21 123 4567"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                  </div>
                  
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>üí° Dica:</strong> Estes dados ser√£o inclu√≠dos nos exports CSV para o contabilista e em futuros exports certificados (SAF-T).
                    </p>
                  </div>
                  
                  {(dadosEmpresa.nif && dadosEmpresa.nome) && (
                    <div className="mt-3 bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                      <span className="text-green-600">‚úÖ</span>
                      <p className="text-xs text-green-800 font-medium">
                        Dados da empresa configurados!
                      </p>
                    </div>
                  )}
                </div>
              )}
                </div>
                
                {/* Fornecedores */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-purple-50 to-pink-50">
                  <button
                    onClick={() => setFornecedoresExpanded(!fornecedoresExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-purple-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üë• Fornecedores
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Gerir contactos de fornecedores
                      </p>
                    </div>
                    {fornecedoresExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {fornecedoresExpanded && (
                    <div className="p-4 border-t border-purple-200 bg-white">
                      {/* Formul√°rio Novo Fornecedor */}
                      <div id="fornecedor-form" className="bg-purple-50 rounded-lg p-4 mb-4 border-2 border-purple-200">
                        <h4 className="font-semibold text-sm mb-3">
                          {editandoFornecedor ? '‚úèÔ∏è Editar Fornecedor' : '‚ûï Adicionar Fornecedor'}
                        </h4>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Nome do Fornecedor *
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.nome}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, nome: e.target.value})}
                              placeholder="Ex: Mercearia Silva"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              NIF
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.nif}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, nif: e.target.value})}
                              placeholder="123456789"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div className="md:col-span-2">
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Morada
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.morada}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, morada: e.target.value})}
                              placeholder="Rua Example, 123"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Email
                            </label>
                            <input
                              type="email"
                              value={dadosFornecedor.email}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, email: e.target.value})}
                              placeholder="contacto@fornecedor.pt"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Telefone
                            </label>
                            <input
                              type="tel"
                              value={dadosFornecedor.telefone}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, telefone: e.target.value})}
                              placeholder="+351 21 123 4567"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                        </div>
                        
                        {editandoFornecedor ? (
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={salvarEdicaoFornecedor}
                              className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                            >
                              <Save size={16} /> Guardar Altera√ß√µes
                            </button>
                            <button
                              onClick={cancelarEdicaoFornecedor}
                              className="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition"
                            >
                              Cancelar
                            </button>
                          </div>
                        ) : (
                          <button
                            onClick={adicionarNovoFornecedor}
                            className="w-full mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                          >
                            <Plus size={16} /> Adicionar Fornecedor
                          </button>
                        )}
                      </div>
                      
                      {/* Lista de Fornecedores */}
                      <div>
                        <h4 className="font-semibold text-sm mb-3">
                          üìã Fornecedores Registados ({(fornecedores || []).length})
                        </h4>
                        
                        {(fornecedores || []).length === 0 ? (
                          <div className="text-center text-gray-500 text-sm py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                            Nenhum fornecedor registado.
                          </div>
                        ) : (
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {(fornecedores || []).map(fornecedor => {
                              const isOldFormat = typeof fornecedor === 'string';
                              const id = isOldFormat ? fornecedor : fornecedor.id;
                              const nome = isOldFormat ? fornecedor : fornecedor.nome;
                              const nif = isOldFormat ? '' : fornecedor.nif;
                              const morada = isOldFormat ? '' : fornecedor.morada;
                              const email = isOldFormat ? '' : fornecedor.email;
                              const telefone = isOldFormat ? '' : fornecedor.telefone;
                              
                              return (
                                <div key={id} className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-200">
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex-1">
                                      <h5 className="font-bold text-purple-900 text-sm">{nome}</h5>
                                      {nif && <p className="text-xs text-gray-600 mt-1">NIF: {nif}</p>}
                                    </div>
                                    {!isOldFormat && (
                                      <div className="flex gap-1">
                                        <button
                                          onClick={() => editarFornecedor(fornecedor)}
                                          className="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-1 rounded transition"
                                          title="Editar fornecedor"
                                        >
                                          <Edit2 size={14} />
                                        </button>
                                        <button
                                          onClick={() => apagarFornecedor(id)}
                                          className="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded transition"
                                          title="Apagar fornecedor"
                                        >
                                          <Trash2 size={14} />
                                        </button>
                                      </div>
                                    )}
                                  </div>
                                  
                                  {!isOldFormat && (
                                    <div className="text-xs text-gray-600 space-y-1">
                                      {morada && <p>üìç {morada}</p>}
                                      {email && <p>‚úâÔ∏è {email}</p>}
                                      {telefone && <p>üìû {telefone}</p>}
                                    </div>
                                  )}
                                  
                                  <div className="mt-2 pt-2 border-t border-purple-200 flex items-center justify-between text-xs">
                                    <span className="text-gray-600">
                                      Compras: <strong>{(faturas || []).filter(f => f.fornecedorId === id).length}</strong>
                                    </span>
                                    <span className="text-gray-600">
                                      Total: <strong>‚Ç¨{(faturas || []).filter(f => f.fornecedorId === id).reduce((sum, f) => sum + f.total, 0).toFixed(2)}</strong>
                                    </span>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Apps de Delivery */}
                <div className="border rounded-lg overflow-hidden shadow-sm bg-gradient-to-br from-orange-50 to-yellow-50 border-orange-200">
                  <button
                    onClick={() => setDeliveryAppsExpanded(!deliveryAppsExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-orange-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üöó Apps de Delivery
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Configurar Uber Eats, Glovo, Bolt Food, etc
                      </p>
                    </div>
                    {deliveryAppsExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {deliveryAppsExpanded && (
                    <div className="p-4 border-t border-orange-200 bg-white">
                      <p className="text-xs text-gray-600 mb-4">
                        üí° Ative as apps que utiliza para ver simula√ß√µes de pre√ßos e margens no Dashboard
                      </p>
                      
                      {/* Lista de Apps */}
                      <div className="space-y-3 mb-4">
                        {(deliveryApps || []).map(app => (
                          <div key={app.id} className={`border-2 rounded-lg p-3 ${app.ativo ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-3">
                                <button
                                  onClick={() => toggleApp(app.id)}
                                  className={`w-12 h-6 rounded-full transition ${app.ativo ? 'bg-green-500' : 'bg-gray-300'} relative`}
                                >
                                  <div className={`w-5 h-5 rounded-full bg-white absolute top-0.5 transition-all ${app.ativo ? 'left-6' : 'left-0.5'}`}></div>
                                </button>
                                <div>
                                  <h4 className="font-bold text-sm">{app.nome}</h4>
                                  <p className="text-xs text-gray-500">
                                    {app.ativo ? '‚úÖ Ativa' : '‚ùå Inativa'}
                                  </p>
                                </div>
                              </div>
                              
                              <button
                                onClick={() => apagarApp(app.id)}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="Apagar app"
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">Comiss√£o (%)</label>
                                {editandoApp === app.id ? (
                                  <div className="flex gap-1">
                                    <input
                                      type="number"
                                      step="0.1"
                                      defaultValue={app.comissao}
                                      id={`comissao-${app.id}`}
                                      className="w-full px-2 py-1 border rounded text-sm"
                                    />
                                    <button
                                      onClick={() => {
                                        const novaComissao = document.getElementById(`comissao-${app.id}`).value;
                                        atualizarComissaoApp(app.id, novaComissao);
                                      }}
                                      className="bg-green-500 text-white px-2 rounded hover:bg-green-600"
                                    >
                                      ‚úì
                                    </button>
                                  </div>
                                ) : (
                                  <div className="flex items-center gap-2">
                                    <span className="font-bold text-lg">{app.comissao}%</span>
                                    <button
                                      onClick={() => setEditandoApp(app.id)}
                                      className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                    >
                                      <Edit2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                              
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">√öltima atualiza√ß√£o</label>
                                <span className="text-xs text-gray-500">{new Date(app.dataAtualizacao).toLocaleDateString('pt-PT')}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      {/* Adicionar Nova App */}
                      <div className="bg-orange-50 rounded-lg p-3 border-2 border-orange-200">
                        <h4 className="font-semibold text-sm mb-2">‚ûï Adicionar Nova App</h4>
                        <div className="grid grid-cols-2 gap-2">
                          <input
                            type="text"
                            placeholder="Nome (ex: Just Eat)"
                            value={novaApp.nome}
                            onChange={(e) => setNovaApp({...novaApp, nome: e.target.value})}
                            className="px-2 py-1.5 border rounded text-sm"
                          />
                          <div className="flex gap-1">
                            <input
                              type="number"
                              step="0.1"
                              placeholder="Comiss√£o %"
                              value={novaApp.comissao}
                              onChange={(e) => setNovaApp({...novaApp, comissao: e.target.value})}
                              className="flex-1 px-2 py-1.5 border rounded text-sm"
                            />
                            <button
                              onClick={adicionarNovaApp}
                              className="bg-orange-500 text-white px-3 rounded hover:bg-orange-600 font-semibold text-sm"
                            >
                              +
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Backup e Sincroniza√ß√£o */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-gray-50 to-blue-50">
                  <button
                    onClick={() => setBackupExpanded(!backupExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-blue-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üíæ Backup e Sincroniza√ß√£o
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Sincronize automaticamente com a cloud ou fa√ßa backup/restauro manual.
                      </p>
                    </div>
                    {backupExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {backupExpanded && (
                  <div className="border-t border-gray-200 bg-white p-4">
                  
                  {/* Grid: Export/Import + GitHub + Google Drive */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    
                    {/* Coluna Esquerda: Export/Import + GitHub */}
                    <div className="space-y-3">
                      {/* Exportar/Importar Local */}
                      <div className="grid grid-cols-2 gap-3">
                        {/* Exportar */}
                        <div className="bg-white rounded-lg p-3 border-2 border-green-200">
                          <h4 className="font-semibold text-green-800 text-sm mb-2 flex items-center gap-1">
                            <Download size={14} />
                            Exportar
                          </h4>
                          <p className="text-xs text-gray-600 mb-2">
                            Backup local (JSON)
                          </p>
                          <button 
                            onClick={exportarDados}
                            className="w-full bg-green-600 hover:bg-green-700 text-white rounded px-3 py-2 text-xs font-semibold flex items-center justify-center gap-1 transition"
                          >
                            <Download size={12} />
                            Exportar
                          </button>
                        </div>
                        
                        {/* Importar */}
                        <div className="bg-white rounded-lg p-3 border-2 border-blue-200">
                          <h4 className="font-semibold text-blue-800 text-sm mb-2 flex items-center gap-1">
                            <Upload size={14} />
                            Importar
                          </h4>
                          <p className="text-xs text-gray-600 mb-2">
                            Restaurar backup
                          </p>
                          <label className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-2 text-xs font-semibold flex items-center justify-center gap-1 transition cursor-pointer">
                            <Upload size={12} />
                            Importar
                            <input type="file" accept=".json" onChange={importarDados} className="hidden" />
                          </label>
                        </div>
                      </div>
                      
                      {/* GitHub Backup */}
                      <GitHubBackupPanel 
                        onSync={async () => {
                          const token = GitHubSync.getToken();
                          if (!token) {
                            showNotification('Configure o GitHub primeiro!', 'error');
                            return;
                          }
                          
                          const allData = {
                            produtos,
                            ingredientes,
                            vendas,
                            despesas,
                            faturas,
                            fornecedores,
                            deliveryApps,
                            embalagens,
                            dadosEmpresa,
                            version: '2.0'
                          };
                          
                          const result = await GitHubSync.saveToGist(allData, token);
                          if (result.success) {
                            showNotification('‚úÖ Backup sincronizado com GitHub!', 'success');
                          } else {
                            showNotification(`‚ùå Erro: ${result.error}`, 'error');
                          }
                        }}
                      />
                    </div>

                    {/* Coluna Direita: Google Drive */}
                    <div>
                      {!driveAccessToken ? (
                        <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 h-full">
                          <div className="flex items-start gap-3 mb-3">
                            <div className="bg-blue-600 rounded-lg p-2 flex-shrink-0">
                              <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12.945 1.379l-.652.763c-.026-.008-.052-.014-.078-.023L6.364 7.97l3.352 5.796 2.32-4.01a1.158 1.158 0 011.099-.706c.326.006.611.177.78.435l.033.053 8.684 15.07h-6.666L13.185 18h-2.37l-.003.001L6.277 7.965 6.209 8h-.012L1.363 16l3.314 5.735 8.716.002c.276 0 .509-.137.709-.356l9.677-16.91-.002-.002c-.01-.017-.022-.032-.033-.049-.288-.52-.754-.882-1.308-.988L12.945 1.379z"/>
                              </svg>
                            </div>
                            <div className="flex-1">
                              <h4 className="font-bold text-blue-900 mb-1 text-sm">
                                ‚òÅÔ∏è Google Drive
                              </h4>
                              <p className="text-xs text-gray-700 mb-2">
                                Sincroniza√ß√£o autom√°tica entre dispositivos.
                              </p>
                              <ul className="text-xs text-gray-600 space-y-0.5 mb-3">
                                <li>‚úÖ Multi-dispositivo</li>
                                <li>‚úÖ Backup autom√°tico</li>
                                <li>‚úÖ 15GB gr√°tis</li>
                              </ul>
                            </div>
                          </div>
                          
                          <button
                            onClick={loginGoogleDrive}
                            className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 hover:shadow-lg rounded-lg px-3 py-2.5 text-sm font-semibold flex items-center justify-center gap-2 transition"
                          >
                            <svg className="w-4 h-4" viewBox="0 0 24 24">
                              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Conectar
                          </button>
                          
                          <p className="text-xs text-gray-500 mt-2 text-center">
                            üîí Acesso s√≥ aos ficheiros do Munchi
                          </p>
                        </div>
                      ) : (
                        <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 h-full">
                          <div className="flex items-center gap-2 mb-3">
                            {driveUser?.image && (
                              <img 
                                src={driveUser.image} 
                                alt={driveUser.name}
                                className="w-10 h-10 rounded-full border-2 border-green-400"
                              />
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="font-bold text-green-900 text-sm truncate">{driveUser?.name || 'Utilizador'}</p>
                              <p className="text-xs text-green-700 truncate">{driveUser?.email || ''}</p>
                              <p className="text-xs text-gray-600 mt-0.5">
                                {driveSyncing ? (
                                  <span className="flex items-center gap-1">
                                    <svg className="animate-spin h-3 w-3" viewBox="0 0 24 24">
                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                    </svg>
                                    A sincronizar...
                                  </span>
                                ) : driveLastSync ? (
                                  `‚úÖ Sync h√° ${Math.round((new Date() - driveLastSync) / 60000)} min`
                                ) : (
                                  '‚è≥ Aguardando sync'
                                )}
                              </p>
                            </div>
                            <button
                              onClick={logoutGoogleDrive}
                              className="text-xs text-red-600 hover:text-red-800 px-2 py-1 border border-red-300 rounded hover:bg-red-50 transition flex-shrink-0"
                            >
                              Sair
                            </button>
                          </div>
                          
                          {driveError && (
                            <div className="bg-red-100 border border-red-300 rounded p-2 mb-2">
                              <p className="text-xs text-red-800">‚ö†Ô∏è {driveError}</p>
                            </div>
                          )}
                          
                          <div className="grid grid-cols-2 gap-2">
                            <button
                              onClick={saveToDrive}
                              disabled={driveSyncing}
                              className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                            >
                              <Upload size={12} />
                              Sync
                            </button>
                            
                            <button
                              onClick={() => loadFromDrive()}
                              disabled={driveSyncing}
                              className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                            >
                              <Download size={12} />
                              Carregar
                            </button>
                          </div>
                          
                          {driveFileId && (
                            <p className="text-xs text-gray-500 mt-2 text-center">
                              üìÅ {GOOGLE_DRIVE_CONFIG.FILE_NAME}
                            </p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                    <p className="text-xs text-yellow-800">
                      <strong>üí° Dica:</strong> Use GitHub ou Google Drive para backup autom√°tico. Export/Import para backup manual.
                    </p>
                  </div>
                  </div>
                  )}
                </div>
                
                {/* Exportar para Excel/CSV */}
                <div className="border rounded-lg p-4 bg-gradient-to-r from-blue-50 to-green-50">
                  <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                    üìä Exportar para Contabilista
                  </h3>
                  
                  {/* Export Combinado - Apoio Contabil√≠stico */}
                  <div className="bg-gradient-to-br from-white to-blue-50 rounded-lg border-2 border-blue-300">
                    {/* Cabe√ßalho com bot√µes - sempre vis√≠vel */}
                    <div className="p-4">
                      <div className="flex items-center gap-3 mb-3">
                        <h4 className="font-bold text-blue-900 flex-1">
                          üìã Relat√≥rio de Apoio Contabil√≠stico
                        </h4>
                        <button
                          onClick={() => {
                            const section = document.getElementById('export-details');
                            const icon = document.getElementById('export-chevron');
                            if (section.classList.contains('hidden')) {
                              section.classList.remove('hidden');
                              icon.style.transform = 'rotate(180deg)';
                            } else {
                              section.classList.add('hidden');
                              icon.style.transform = 'rotate(0deg)';
                            }
                          }}
                          className="text-blue-600 hover:text-blue-800 transition"
                        >
                          <ChevronDown id="export-chevron" size={20} style={{transition: 'transform 0.3s'}} />
                        </button>
                      </div>
                      
                      {/* Bot√µes de Export - SEMPRE VIS√çVEIS */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button 
                          onClick={exportarRelatorioCompletoCSV}
                          className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-6 py-3 text-base font-bold flex items-center justify-center gap-2 transition shadow-lg"
                        >
                          <FileText size={18} />
                          S√≥ CSV (R√°pido)
                        </button>
                        
                        <button 
                          onClick={exportarPacoteCompleto}
                          className="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white rounded-lg px-6 py-3 text-base font-bold flex items-center justify-center gap-2 transition shadow-lg"
                        >
                          <Download size={18} />
                          Pacote Completo (ZIP)
                        </button>
                      </div>
                    </div>
                    
                    {/* Detalhes - colaps√°vel */}
                    <div id="export-details" className="hidden border-t border-blue-200 p-4">
                      <p className="text-sm text-gray-700 mb-3">
                        Ficheiro CSV estruturado com vendas e despesas para lan√ßamento contabil√≠stico
                      </p>
                      
                      
                      {/* Documentos Fiscais - Movido do Dashboard */}
                      <div className="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded p-3 mb-3">
                        <div className="flex items-center gap-2 mb-3">
                          <h4 className="font-bold text-purple-900">üìÑ Documentos Fiscais</h4>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                          <div className="bg-white rounded-lg p-2 text-center border border-purple-200">
                            <p className="text-xl font-bold text-purple-600">{despesas.length}</p>
                            <p className="text-purple-600 text-xs mt-1">Total Faturas</p>
                          </div>
                          <div className="bg-green-50 rounded-lg p-2 text-center border border-green-200">
                            <p className="text-xl font-bold text-green-600">{despesas.filter(d => d.documentoPDF).length}</p>
                            <p className="text-green-600 text-xs mt-1">‚úÖ Com PDF</p>
                          </div>
                          <div className="bg-red-50 rounded-lg p-2 text-center border border-red-200">
                            <p className="text-xl font-bold text-red-600">{despesas.filter(d => !d.documentoPDF).length}</p>
                            <p className="text-red-600 text-xs mt-1">‚ö†Ô∏è Sem PDF</p>
                          </div>
                        </div>
                        {despesas.filter(d => !d.documentoPDF).length > 0 && (
                          <div className="mt-2 bg-red-50 rounded p-2 border border-red-200">
                            <p className="text-xs flex items-center gap-1 text-red-800">
                              <AlertCircle size={12} />
                              <span>{despesas.filter(d => !d.documentoPDF).length} fatura(s) sem PDF! Adicione os documentos na aba Gest√£o de Compras.</span>
                            </p>
                          </div>
                        )}
                      </div>
                      
                      {/* AVISO LEGAL */}
                      <div className="bg-red-50 border border-red-300 rounded p-2.5 mb-3">
                        <p className="text-xs font-bold text-red-900 mb-1.5">‚ö†Ô∏è AVISO LEGAL</p>
                        <ul className="text-xs text-red-800 space-y-1">
                          <li>‚Ä¢ Este CSV √© APOIO, n√£o substitui documentos fiscais</li>
                          <li>‚Ä¢ Para despesas: PDFs das faturas s√£o OBRIGAT√ìRIOS</li>
                          <li>‚Ä¢ Conservar PDFs 10 anos (Lei Geral Tribut√°ria)</li>
                        </ul>
                      </div>
                      
                      {/* Compara√ß√£o */}
                      <div className="bg-yellow-50 border border-yellow-300 rounded p-2.5">
                        <p className="text-xs font-bold text-yellow-900 mb-2">üì¶ Compara√ß√£o:</p>
                        <div className="grid grid-cols-2 gap-3 text-xs">
                          <div>
                            <p className="font-bold text-blue-700 mb-1">üìÑ S√≥ CSV:</p>
                            <p className="text-gray-700">R√°pido, mas precisas enviar PDFs separadamente</p>
                          </div>
                          <div>
                            <p className="font-bold text-green-700 mb-1">üì¶ ZIP:</p>
                            <p className="text-gray-700">‚úÖ Tudo junto (recomendado)</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>üí° Dica:</strong> Os exports CSV respeitam os filtros de data. Para exportar tudo, selecione "Tudo" no filtro de per√≠odo no Dashboard.
                    </p>
                  </div>
                </div>
                
                {/* Outras sec√ß√µes */}
                <div className="border-b pb-4">
                  <h3 className="font-semibold mb-2">‚öôÔ∏è Configura√ß√µes Gerais</h3>
                  <p className="text-sm text-gray-500">Em breve: Configura√ß√µes personalizadas</p>
                </div>
                
                <div className="border-b pb-4">
                  <h3 className="font-semibold mb-2">üîî Notifica√ß√µes</h3>
                  <p className="text-sm text-gray-500">Em breve: Gest√£o de notifica√ß√µes</p>
                </div>
                
                <div className="border-b pb-4">
                  <h3 className="font-semibold mb-2">üìä Relat√≥rios</h3>
                  <p className="text-sm text-gray-500">Em breve: Configura√ß√£o de relat√≥rios autom√°ticos</p>
                </div>
                
                <div>
                  <h3 className="font-semibold mb-2">‚ÑπÔ∏è Sobre</h3>
                  <p className="text-sm text-gray-600">
                    <strong>Munchi Manager</strong> v1.0<br/>
                    Sistema de gest√£o para restaurantes
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
      
      {/* Modal OCR */}
      {mostrarModalOCR && (
        <ModalConfirmacaoOCR 
          linhas={linhasOCR}
          ingredientes={ingredientes}
          metadata={metadataOCR}
          fornecedores={fornecedores}
          onConfirmar={handleConfirmarOCR}
          onCancelar={() => setMostrarModalOCR(false)}
        />
      )}
      
      {/* ==================== MODAL CONFIRMA√á√ÉO FATURA V2.0 ==================== */}
      {modalConfirmacaoFatura.mostrar && modalConfirmacaoFatura.dados && (
        <ModalConfirmacaoFatura
          dadosFatura={modalConfirmacaoFatura.dados}
          onConfirmar={handleConfirmarFatura}
          onCancelar={handleCancelarFatura}
        />
      )}
      {/* ==================== FIM MODAL V2.0 ==================== */}
      
      {/* Modal de Importa√ß√£o com Mapeamento Autom√°tico */}
      {mostrarImportacao && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 className="text-lg font-bold mb-4">üì¶ Importar Vendas (Autom√°tico)</h3>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Fonte dos Dados:</label>
              <select
                value={fonteImportacao}
                onChange={(e) => setFonteImportacao(e.target.value)}
                className="w-full border rounded p-2"
              >
                <option value="moloni">üè¢ Moloni</option>
                <option value="zobaze">üì± Zobaze</option>
              </select>
            </div>
            
            <div className="bg-purple-50 border border-purple-200 rounded p-3 mb-4">
              <p className="text-xs text-purple-800 mb-2 font-semibold">
                ‚ú® Mapeamento Autom√°tico Ativado!
              </p>
              <p className="text-xs text-purple-700">
                ‚Ä¢ <strong>134 regras</strong> de convers√£o autom√°ticas<br/>
                ‚Ä¢ Nomes corrigidos instantaneamente<br/>
                ‚Ä¢ Ex: "Expresso" ‚Üí "Caf√© Expresso"
              </p>
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Formato CSV esperado:</label>
              <div className="bg-gray-50 border rounded p-2 text-xs font-mono">
                Data,Produto,Valor<br/>
                2026-02-01,Expresso,1.35<br/>
                2026-02-01,Croissant,10.00
              </div>
            </div>
            
            <div className="mb-4">
              <label className="bg-purple-600 text-white rounded px-4 py-2 text-sm hover:bg-purple-700 cursor-pointer inline-flex items-center gap-2 font-semibold shadow hover:shadow-lg transition w-full justify-center">
                <Upload size={16} />
                Escolher Arquivo CSV
                <input
                  type="file"
                  accept=".csv"
                  onChange={importarVendasCSV}
                  className="hidden"
                />
              </label>
            </div>
            
            <div className="flex gap-2">
              <button
                onClick={() => setMostrarImportacao(false)}
                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};


// AUTO-LOAD 2 MONTHS DATA
setTimeout(() => {
  const data = {
    "versao": "1.0",
    "dataExport": new Date().toISOString(),
    "ingredientes": [],
    "produtos": [],
    "fornecedores": [],
    "vendas": [],
    "despesas": []
  };
  
  // Create a custom event to load data
  const loadEvent = new CustomEvent('loadBackupData', { detail: data });
  window.dispatchEvent(loadEvent);
}, 100);

const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<RestauranteGestor />);
    </script>
</body>
</html>
