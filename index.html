<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munchi Manager</title>
    <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script defer src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script defer src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/fuzzball@2.1.2/dist/fuzzball.umd.min.js"></script>
  <script defer src="https://apis.google.com/js/api.js"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script defer src="config.js"></script>
  
  <script>

    const configurePDFJS = () => {
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        return true;
      }
      return false;
    };

    if (!configurePDFJS()) {

      setTimeout(() => {
        if (!configurePDFJS()) {

          setTimeout(() => {
            if (!configurePDFJS()) {

            }
          }, 1000);
        }
      }, 500);
    }
  </script>
</head>
<body style="background: linear-gradient(to bottom right, #eff6ff, #f3e8ff, #fce7f3); min-height: 100vh;">
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useMemo } = React;

const normalizeText = (text) => {
  if (!text) return '';
  return text
    .toLowerCase()
    .normalize('NFD') // Decomp√µe caracteres acentuados
    .replace(/[\u0300-\u036f]/g, '') // Remove diacr√≠ticos (acentos)
    .replace(/√ß/g, 'c') // Cedilha
    .replace(/[^a-z0-9\s]/g, ''); // Remove caracteres especiais, mant√©m espa√ßos
};

const Plus = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
const Trash2 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
const RefreshCw = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
const Upload = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
const Download = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>;
const TrendingUp = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
const DollarSign = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const Package = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>;
const FileText = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
const Calculator = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>;
const BarChart3 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>;
const Target = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
const Check = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;
const X = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
const AlertCircle = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const ChevronDown = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>;
const ChevronUp = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>;
const Search = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
const Settings = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
const Edit2 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
const Edit = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>;
const Save = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>;
const Users = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;
const Paperclip = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>;
const FilePdf = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>;
const Eye = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>;

const db = new Dexie('MunchiManagerDB');

db.version(1).stores({
  movimentacoesStock: '++id, data, tipo, ingredienteId, produtoId',
});

db.version(2).stores({
  movimentacoesStock: '++id, data, tipo, ingredienteId, produtoId',
  vocabulario: 'id, fornecedorNIF, textoNormalizado, ingredienteId',
  ingredientes: 'id, nome, categoria',
  fornecedores: 'id, nif, nome',
  templates: 'nifFornecedor, linhaInicio, linhaFim'
});

db.version(3).stores({
  movimentacoesStock: '++id, data, tipo, ingredienteId, produtoId',
  vocabulario: 'id, fornecedorNIF, textoNormalizado, ingredienteId',
  ingredientes: 'id, nome, categoria',
  fornecedores: 'id, nif, nome',
  templates: 'nifFornecedor, linhaInicio, linhaFim'
}).upgrade(tx => {

  return Promise.all([
    tx.table('movimentacoesStock').clear(),
    tx.table('vocabulario').clear(),
    tx.table('ingredientes').clear(),
    tx.table('fornecedores').clear(),
    tx.table('templates').clear()
  ]).then(() => {

  });
});

db.version(4).stores({
  movimentacoesStock: '++id, data, tipo, ingredienteId, produtoId',
  vocabulario: 'id, fornecedorNIF, textoNormalizado, ingredienteId',
  ingredientes: 'id, nome, categoria',
  fornecedores: 'id, nif, nome',
  templates: 'nifFornecedor, linhaInicio, linhaFim',
  bolosExternos: '++id, data, eventoCalendarId, produtoBase, timestamp'
});

const IndexedDBStorage = {

  async _checkTable(tableName) {
    try {
      const tableExists = db.tables.some(t => t.name === tableName);
      if (!tableExists) {
        console.error(`‚ùå Tabela '${tableName}' n√£o existe no schema!`);

        return false;
      }
      return true;
    } catch (e) {
      console.error(`‚ùå Erro ao verificar tabela '${tableName}':`, e);
      return false;
    }
  },

  async saveMovimentacoes(movimentacoes) {

    return true;
  },

  async loadMovimentacoes() {
    try {
      const movimentacoes = await db.movimentacoesStock.toArray();

      return movimentacoes;
    } catch (error) {
      console.error('‚ùå Erro ao carregar do IndexedDB:', error);
      return [];
    }
  },

  async getStats() {
    try {
      const total = await db.movimentacoesStock.count();
      const entradas = await db.movimentacoesStock.where('tipo').equals('entrada').count();
      const saidas = await db.movimentacoesStock.where('tipo').equals('saida').count();
      const ajustes = await db.movimentacoesStock.where('tipo').equals('ajuste').count();
      
      return { total, entradas, saidas, ajustes };
    } catch (error) {
      console.error('‚ùå Erro ao obter estat√≠sticas:', error);
      return { total: 0, entradas: 0, saidas: 0, ajustes: 0 };
    }
  },

  async saveVocabulario(data) {
    try {
      if (!await this._checkTable('vocabulario')) return false;
      if (!data || !Array.isArray(data) || data.length === 0) return true;

      const validos = data
        .filter(item => item && typeof item === 'object') // Filtrar nulls/undefined
        .map((item, index) => {

          return {
            id: item.id || `vocab_fallback_${Date.now()}_${index}`,
            fornecedorNIF: String(item.fornecedorNIF || ''),
            textoOriginal: String(item.textoOriginal || ''),
            textoNormalizado: String(item.textoNormalizado || ''),
            ingredienteId: String(item.ingredienteId || ''),
            confirmacoes: Number(item.confirmacoes) || 0,
            correcoes: Number(item.correcoes) || 0,
            ultimaConfirmacao: item.ultimaConfirmacao || new Date().toISOString(),
            ultimaQuantidade: item.ultimaQuantidade,
            ultimaUnidade: item.ultimaUnidade,
            ultimoPreco: item.ultimoPreco
          };
        });
      
      if (validos.length === 0) {

        return true;
      }
      
      await db.vocabulario.clear();
      await db.vocabulario.bulkPut(validos);

      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar vocabul√°rio:', e);
      console.error('Stack:', e.stack);

      return false;
    }
  },

  async loadVocabulario() {
    try {
      if (!await this._checkTable('vocabulario')) return [];
      const data = await db.vocabulario.toArray();

      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar vocabul√°rio:', e);
      return [];
    }
  },

  async saveIngredientes(data) {
    try {
      if (!await this._checkTable('ingredientes')) return false;
      if (!data || !Array.isArray(data) || data.length === 0) return true;

      const validos = data
        .filter(item => item && typeof item === 'object' && item.nome) // Filtrar inv√°lidos
        .map((item, index) => {

          return {
            id: item.id || `ing_fallback_${Date.now()}_${index}`,
            nome: String(item.nome),
            categoria: String(item.categoria || 'Outros'),
            unidade: item.unidade || 'un',
            precoMedio: Number(item.precoMedio) || 0,
            fornecedorPrincipal: item.fornecedorPrincipal || null
          };
        });
      
      if (validos.length === 0) {

        return true;
      }
      
      await db.ingredientes.clear();
      await db.ingredientes.bulkPut(validos);

      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar ingredientes:', e);
      console.error('Stack:', e.stack);

      return false;
    }
  },

  async loadIngredientes() {
    try {
      if (!await this._checkTable('ingredientes')) return [];
      const data = await db.ingredientes.toArray();

      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar ingredientes:', e);
      return [];
    }
  },

  async saveFornecedores(data) {
    try {
      if (!await this._checkTable('fornecedores')) return false;
      if (!data || !Array.isArray(data) || data.length === 0) return true;

      const validos = data
        .filter(item => item && typeof item === 'object' && (item.nome || item.nif)) // Filtrar inv√°lidos
        .map((item, index) => {

          return {
            id: item.id || `forn_fallback_${Date.now()}_${index}`,
            nome: String(item.nome || 'Fornecedor'),
            nif: String(item.nif || ''),
            morada: String(item.morada || ''),
            telefone: String(item.telefone || ''),
            email: String(item.email || '')
          };
        });
      
      if (validos.length === 0) {

        return true;
      }
      
      await db.fornecedores.clear();
      await db.fornecedores.bulkPut(validos);

      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar fornecedores:', e);
      console.error('Stack:', e.stack);

      return false;
    }
  },

  async loadFornecedores() {
    try {
      if (!await this._checkTable('fornecedores')) return [];
      const data = await db.fornecedores.toArray();

      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar fornecedores:', e);
      return [];
    }
  },

  async saveTemplates(data) {
    try {
      if (!await this._checkTable('templates')) return false;
      if (!data || !Array.isArray(data) || data.length === 0) return true;

      const validos = data
        .filter(t => t && typeof t === 'object' && t.nifFornecedor) // Filtrar inv√°lidos
        .map(t => {

          return {
            nifFornecedor: String(t.nifFornecedor),
            linhaInicio: Number(t.linhaInicio) || 0,
            linhaFim: Number(t.linhaFim) || 0,
            padroes: t.padroes || {},
            ultimaAtualizacao: t.ultimaAtualizacao || new Date().toISOString()
          };
        });
      
      if (validos.length === 0) {

        return true;
      }
      
      await db.templates.clear();
      await db.templates.bulkPut(validos);

      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar templates:', e);
      console.error('Stack:', e.stack);

      return false;
    }
  },

  async loadTemplates() {
    try {
      if (!await this._checkTable('templates')) return [];
      const data = await db.templates.toArray();

      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar templates:', e);
      return [];
    }
  },

  async clearAll() {
    try {
      await db.movimentacoesStock.clear();
      await db.vocabulario.clear();
      await db.ingredientes.clear();
      await db.fornecedores.clear();
      await db.templates.clear();

      return true;
    } catch (error) {
      console.error('‚ùå Erro ao limpar IndexedDB:', error);
      return false;
    }
  },

  async migrateFromLocalStorage() {
    try {
      const localData = localStorage.getItem('movimentacoesStock');
      if (localData) {
        const movimentacoes = JSON.parse(localData);
        const count = await db.movimentacoesStock.count();

        if (count === 0 && movimentacoes.length > 0) {
          await db.movimentacoesStock.bulkAdd(movimentacoes);

          localStorage.removeItem('movimentacoesStock');
          return true;
        }
      }
      return false;
    } catch (error) {
      console.error('‚ùå Erro na migra√ß√£o:', error);
      return false;
    }
  }
};

const GitHubSync = {
  GIST_ID_KEY: 'munchi_gist_id',
  TOKEN_KEY: 'munchi_github_token',
  LAST_SYNC_KEY: 'munchi_last_sync',
  
  async saveToGist(data, token) {
    try {
      const gistId = localStorage.getItem(this.GIST_ID_KEY);
      const url = gistId 
        ? `https://api.github.com/gists/${gistId}`
        : 'https://api.github.com/gists';
      
      const method = gistId ? 'PATCH' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          description: 'Munchi Manager - Backup Autom√°tico',
          public: false,
          files: {
            'munchi-data.json': {
              content: JSON.stringify(data, null, 2)
            }
          }
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`GitHub API error: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      
      if (!gistId) {
        localStorage.setItem(this.GIST_ID_KEY, result.id);
      }
      
      localStorage.setItem(this.LAST_SYNC_KEY, new Date().toISOString());
      
      return { success: true, gistId: result.id, url: result.html_url };
    } catch (error) {

      return { success: false, error: error.message };
    }
  },
  
  async loadFromGist(token) {
    try {
      const gistId = localStorage.getItem(this.GIST_ID_KEY);
      if (!gistId) {
        return { success: false, error: 'Nenhum backup encontrado' };
      }
      
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: {
          'Authorization': `token ${token}`,
        }
      });
      
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }
      
      const gist = await response.json();
      const content = gist.files['munchi-data.json'].content;
      const data = JSON.parse(content);
      
      return { success: true, data };
    } catch (error) {

      return { success: false, error: error.message };
    }
  },
  
  isConfigured() {
    return !!localStorage.getItem(this.TOKEN_KEY);
  },
  
  getToken() {
    return localStorage.getItem(this.TOKEN_KEY);
  },
  
  setToken(token) {
    localStorage.setItem(this.TOKEN_KEY, token);
  },
  
  clearConfig() {
    localStorage.removeItem(this.TOKEN_KEY);
    localStorage.removeItem(this.GIST_ID_KEY);
    localStorage.removeItem(this.LAST_SYNC_KEY);
  },
  
  getLastSync() {
    const lastSync = localStorage.getItem(this.LAST_SYNC_KEY);
    return lastSync ? new Date(lastSync) : null;
  },
  
  getGistUrl() {
    const gistId = localStorage.getItem(this.GIST_ID_KEY);
    return gistId ? `https://gist.github.com/${gistId}` : null;
  },
  
  getAutoSyncEnabled() {
    const enabled = localStorage.getItem('munchi_auto_sync_enabled');
    return enabled === null ? true : enabled === 'true';
  },
  
  setAutoSyncEnabled(enabled) {
    localStorage.setItem('munchi_auto_sync_enabled', enabled.toString());
  }
};

const Cloud = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>;
const CloudCheck = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;

if (typeof window.storage === 'undefined') {
  window.storage = {
    get: (key) => { 
      return Promise.resolve().then(() => {
        try { 
          const value = localStorage.getItem(key); 
          return value ? { key, value, shared: false } : null; 
        } catch (e) { 
          console.error('Storage get error:', e);
          return null; 
        }
      });
    },
    set: (key, value) => { 

      return Promise.resolve({ key, value, shared: false });
    },
    delete: (key) => { 
      return Promise.resolve().then(() => {
        try { 
          localStorage.removeItem(key); 
          return { key, deleted: true, shared: false }; 
        } catch (e) { 
          console.error('Storage delete error:', e);
          return null; 
        }
      });
    },
    list: () => Promise.resolve({ keys: Object.keys(localStorage), shared: false })
  };
}

const CloudSyncPanel = ({ 
  onSync, 
  isSyncing, 
  lastSync, 
  syncError,
  autoSyncEnabled,
  setAutoSyncEnabled 
}) => {
  const [showConfig, setShowConfig] = React.useState(false);
  const [token, setToken] = React.useState('');
  const [showToken, setShowToken] = React.useState(false);
  
  const isConfigured = GitHubSync.isConfigured();
  const gistUrl = GitHubSync.getGistUrl();
  
  const saveToken = () => {
    if (token.trim()) {
      GitHubSync.setToken(token.trim());
      setShowConfig(false);
      setToken('');
      alert('‚úÖ Token guardado! A sincronizar dados...');
      setTimeout(onSync, 500);
    }
  };
  
  const clearConfig = () => {
    if (confirm('‚ö†Ô∏è Tem a certeza que quer desconectar o GitHub?\n\nOs dados locais N√ÉO ser√£o apagados, mas o backup autom√°tico ser√° desativado.')) {
      GitHubSync.clearConfig();
      setShowConfig(false);
      alert('‚úÖ GitHub desconectado');
    }
  };
  
  const getTimeSince = (date) => {
    if (!date) return 'Nunca';
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Agora mesmo';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `H√° ${minutes} min`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `H√° ${hours}h`;
    const days = Math.floor(hours / 24);
    return `H√° ${days} ${days === 1 ? 'dia' : 'dias'}`;
  };
  
  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Cloud className="w-6 h-6 text-blue-600" />
          <div>
            <h3 className="font-bold text-blue-900">Backup Cloud (GitHub)</h3>
            {isConfigured && !showConfig && (
              <p className="text-xs text-blue-700">Auto-sync: {autoSyncEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</p>
            )}
          </div>
        </div>
        <button
          onClick={() => setShowConfig(!showConfig)}
          className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded transition"
          title="Configura√ß√µes"
        >
          <Settings className="w-5 h-5" />
        </button>
      </div>
      
      {showConfig ? (
        <div className="space-y-3 bg-white rounded-lg p-4 border border-blue-300">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üîë GitHub Personal Access Token
            </label>
            <div className="relative">
              <input
                type={showToken ? "text" : "password"}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                className="w-full px-3 py-2 pr-20 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-semibold"
              >
                {showToken ? 'Ocultar' : 'Mostrar'}
              </button>
            </div>
            
            <div className="mt-2 space-y-1 text-xs text-gray-600">
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">1.</span>
                <span>Crie token em: <a href="https://github.com/settings/tokens/new?scopes=gist&description=Munchi%20Manager%20Backup" target="_blank" className="text-blue-600 underline font-semibold hover:text-blue-800">github.com/settings/tokens</a></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">2.</span>
                <span>Marque apenas: <strong className="text-green-700">‚úì gist</strong></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">3.</span>
                <span>Cole aqui e clique em "Guardar"</span>
              </p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={saveToken}
              disabled={!token.trim()}
              className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
            >
              üíæ Guardar Token
            </button>
            {isConfigured && (
              <button
                onClick={clearConfig}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition"
              >
                üîå Desconectar
              </button>
            )}
          </div>
          
          <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-900">
            <p className="font-semibold mb-1 flex items-center gap-1">
              üîí Seguran√ßa & Privacidade
            </p>
            <ul className="space-y-1 ml-4 text-yellow-800">
              <li>‚Ä¢ Token guardado <strong>localmente</strong> no seu browser</li>
              <li>‚Ä¢ Nunca partilhado com servidores externos</li>
              <li>‚Ä¢ Gist criado como <strong>privado</strong> (s√≥ voc√™ v√™)</li>
              <li>‚Ä¢ Pode revogar token a qualquer momento</li>
            </ul>
          </div>
        </div>
      ) : (
        <>
          {!isConfigured ? (
            <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              <p className="text-sm text-yellow-800 flex items-center gap-2">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <span>Configure o GitHub para ativar backup autom√°tico na cloud</span>
              </p>
              <button
                onClick={() => setShowConfig(true)}
                className="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-semibold transition text-sm"
              >
                ‚öôÔ∏è Configurar Agora
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              {/* Status Card */}
              <div className="bg-white rounded-lg p-3 border-2 border-green-300 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <CloudCheck className="w-5 h-5 text-green-600" />
                    <div>
                      <p className="text-sm font-semibold text-green-900">Conectado ‚úì</p>
                      <p className="text-xs text-green-700">√öltimo backup: {getTimeSince(lastSync)}</p>
                    </div>
                  </div>
                  <button
                    onClick={onSync}
                    disabled={isSyncing}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    {isSyncing ? 'A sincronizar...' : 'Sync'}
                  </button>
                </div>
                
                {gistUrl && (
                  <a
                    href={gistUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1"
                  >
                    üîó Ver backup no GitHub
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
              
              {/* Error Message */}
              {syncError && (
                <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                  <p className="text-sm text-red-800 flex items-start gap-2">
                    <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                    <span><strong>Erro:</strong> {syncError}</span>
                  </p>
                  <button
                    onClick={() => setShowConfig(true)}
                    className="mt-2 text-xs text-red-700 hover:text-red-900 underline font-semibold"
                  >
                    ‚Üí Reconfigurar token
                  </button>
                </div>
              )}
              
              {/* Auto-sync Toggle */}
              <div className="flex items-center justify-between bg-white rounded p-2 border border-gray-200">
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="autoSyncToggle"
                    checked={autoSyncEnabled}
                    onChange={(e) => setAutoSyncEnabled(e.target.checked)}
                    className="w-4 h-4 rounded text-blue-600 focus:ring-2 focus:ring-blue-500"
                  />
                  <label htmlFor="autoSyncToggle" className="text-sm text-gray-700 cursor-pointer">
                    üîÑ Auto-sync a cada 5 minutos
                  </label>
                </div>
                <span className={`text-xs font-semibold px-2 py-1 rounded ${autoSyncEnabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                  {autoSyncEnabled ? 'ON' : 'OFF'}
                </span>
              </div>
              
              {/* Info Box */}
              <div className="bg-blue-50 border border-blue-200 rounded p-2 text-xs text-blue-800">
                <p className="font-semibold mb-1">üí° Como funciona:</p>
                <ul className="space-y-0.5 ml-3">
                  <li>‚Ä¢ Dados guardados automaticamente no GitHub</li>
                  <li>‚Ä¢ Aceda de qualquer dispositivo com o mesmo token</li>
                  <li>‚Ä¢ Hist√≥rico completo no seu Gist privado</li>
                </ul>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

const MetricasGraficos = ({ filteredVendas, filteredFaturasComConfig, todasDespesas, dateFilter }) => {
  const chartRefs = React.useRef({});
  const chartsInstances = React.useRef({});

  React.useEffect(() => {
    if (typeof Chart === 'undefined') {
      console.error('‚ùå Chart.js n√£o est√° carregado!');
      return;
    }

    Object.keys(chartsInstances.current).forEach(key => {
      if (chartsInstances.current[key]) {
        chartsInstances.current[key].destroy();
      }
    });
    chartsInstances.current = {};

    const vendasPorDia = {};
    filteredVendas.forEach(venda => {
      const data = new Date(venda.data).toLocaleDateString('pt-PT');
      if (!vendasPorDia[data]) vendasPorDia[data] = 0;
      vendasPorDia[data] += venda.total || venda.valor || 0;
    });

    const dadosVendasPorDia = Object.entries(vendasPorDia)
      .map(([data, total]) => ({ data, total: parseFloat(total.toFixed(2)) }))
      .sort((a, b) => {
        const [diaA, mesA, anoA] = a.data.split('/');
        const [diaB, mesB, anoB] = b.data.split('/');
        return new Date(anoA, mesA - 1, diaA) - new Date(anoB, mesB - 1, diaB);
      });

    const dadosVendasFinal = dateFilter === 'all' ? dadosVendasPorDia.slice(-30) : dadosVendasPorDia;

    const ctx1 = chartRefs.current.vendasDia;
    if (ctx1 && dadosVendasFinal.length > 0) {

      const lineGradient = ctx1.getContext('2d').createLinearGradient(0, 0, ctx1.width, 0);
      lineGradient.addColorStop(0, 'rgb(59, 130, 246)');    // Azul
      lineGradient.addColorStop(0.5, 'rgb(139, 92, 246)');  // Roxo
      lineGradient.addColorStop(1, 'rgb(236, 72, 153)');    // Rosa

      const areaGradient = ctx1.getContext('2d').createLinearGradient(0, 0, 0, ctx1.height);
      areaGradient.addColorStop(0, 'rgba(139, 92, 246, 0.3)');
      areaGradient.addColorStop(1, 'rgba(139, 92, 246, 0.01)');

      chartsInstances.current.vendasDia = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: dadosVendasFinal.map(d => d.data),
          datasets: [{
            label: 'Vendas',
            data: dadosVendasFinal.map(d => d.total),
            borderColor: lineGradient,
            backgroundColor: areaGradient,
            borderWidth: 4,
            fill: true,
            tension: 0.4,
            pointRadius: 6,
            pointHoverRadius: 9,
            pointBackgroundColor: 'white',
            pointBorderColor: 'rgb(139, 92, 246)',
            pointBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { 
              backgroundColor: 'rgba(139, 92, 246, 0.95)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              callbacks: { 
                label: (context) => `‚Ç¨${context.parsed.y.toFixed(2)}` 
              } 
            }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              grid: { color: 'rgba(0, 0, 0, 0.05)' },
              ticks: { 
                callback: (value) => `‚Ç¨${value}`, 
                font: { size: 10 } 
              } 
            },
            x: { 
              grid: { display: false },
              ticks: { font: { size: 9 } } 
            }
          }
        }
      });
    }

    const despesasPorDia = {};
    filteredFaturasComConfig.forEach(fatura => {
      const data = new Date(fatura.data).toLocaleDateString('pt-PT');
      despesasPorDia[data] = (despesasPorDia[data] || 0) + (fatura.total || fatura.valor || 0);
    });

    const todasDatas = new Set([...Object.keys(vendasPorDia), ...Object.keys(despesasPorDia)]);

    const dadosComparacao = Array.from(todasDatas)
      .map(data => ({
        data,
        vendas: parseFloat((vendasPorDia[data] || 0).toFixed(2)),
        despesas: parseFloat((despesasPorDia[data] || 0).toFixed(2))
      }))
      .sort((a, b) => {
        const [diaA, mesA, anoA] = a.data.split('/');
        const [diaB, mesB, anoB] = b.data.split('/');
        return new Date(anoA, mesA - 1, diaA) - new Date(anoB, mesB - 1, diaB);
      });

    const dadosComparacaoFinal = dateFilter === 'all' ? dadosComparacao.slice(-20) : dadosComparacao;

    const ctx2 = chartRefs.current.vendasVsDespesas;
    if (ctx2 && dadosComparacaoFinal.length > 0) {
      chartsInstances.current.vendasVsDespesas = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: dadosComparacaoFinal.map(d => d.data),
          datasets: [
            {
              label: 'Vendas',
              data: dadosComparacaoFinal.map(d => d.vendas),
              backgroundColor: 'rgba(16, 185, 129, 0.8)',
              borderColor: 'rgb(16, 185, 129)',
              borderWidth: 1
            },
            {
              label: 'Despesas',
              data: dadosComparacaoFinal.map(d => d.despesas),
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderColor: 'rgb(239, 68, 68)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top', labels: { font: { size: 10 } } },
            tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ‚Ç¨${context.parsed.y.toFixed(2)}` } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (value) => `‚Ç¨${value}`, font: { size: 10 } } },
            x: { ticks: { font: { size: 9 } } }
          }
        }
      });
    }

    const despesasPorCategoria = {};
    const categoriasMap = {
      'compras': 'Compras', 'salarios': 'Sal√°rios', 'renda': 'Renda',
      'eletricidade': 'Eletricidade', 'agua': '√Ågua', 'gas': 'G√°s',
      'internet': 'Internet', 'consumiveis': 'Consum√≠veis', 'marketing': 'Marketing',
      'manutencao': 'Manuten√ß√£o', 'seguros': 'Seguros', 'outros': 'Outros'
    };

    todasDespesas.forEach(despesa => {
      const categoria = despesa.categoria || 'outros';
      const nomeCategoria = categoriasMap[categoria] || categoria;
      despesasPorCategoria[nomeCategoria] = (despesasPorCategoria[nomeCategoria] || 0) + (despesa.valor || 0);
    });

    const dadosDespesas = Object.entries(despesasPorCategoria)
      .map(([categoria, valor]) => ({ categoria, valor }))
      .sort((a, b) => b.valor - a.valor)
      .slice(0, 6);

    const ctx3 = chartRefs.current.despesasCategoria;
    if (ctx3 && dadosDespesas.length > 0) {
      chartsInstances.current.despesasCategoria = new Chart(ctx3, {
        type: 'doughnut',
        data: {
          labels: dadosDespesas.map(d => d.categoria),
          datasets: [{
            data: dadosDespesas.map(d => d.valor),
            backgroundColor: [
              'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)',
              'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)'
            ],
            borderColor: [
              'rgb(239, 68, 68)', 'rgb(245, 158, 11)', 'rgb(16, 185, 129)',
              'rgb(59, 130, 246)', 'rgb(139, 92, 246)', 'rgb(236, 72, 153)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { font: { size: 9 }, padding: 8 } },
            tooltip: { callbacks: { label: (context) => `${context.label}: ‚Ç¨${context.parsed.toFixed(2)}` } }
          }
        }
      });
    }

  }, [filteredVendas, filteredFaturasComConfig, todasDespesas, dateFilter]);

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
        üìà An√°lise Visual
      </h2>
      
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        {/* VENDAS COM DROPDOWN DE AN√ÅLISE DE PRODUTOS */}
        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-gray-800">üìä Evolu√ß√£o de Vendas</h3>
            <button
              onClick={() => window.toggleProdutosAnalise && window.toggleProdutosAnalise()}
              className="text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded p-1 transition"
              title="Ver an√°lise detalhada de produtos"
            >
              <ChevronDown size={16} />
            </button>
          </div>
          <div style={{position: 'relative', height: '220px'}}>
            <canvas ref={el => chartRefs.current.vendasDia = el}></canvas>
          </div>
        </div>
        
        <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-gray-800">üí∞ Vendas vs Despesas</h3>
            <button
              onClick={() => window.toggleMensalAnalise && window.toggleMensalAnalise()}
              className="text-green-600 hover:text-green-800 hover:bg-green-100 rounded p-1 transition"
              title="Ver an√°lise mensal comparativa"
            >
              <ChevronDown size={16} />
            </button>
          </div>
          <div style={{position: 'relative', height: '220px'}}>
            <canvas ref={el => chartRefs.current.vendasVsDespesas = el}></canvas>
          </div>
        </div>
        
        <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg p-4 border border-orange-200">
          <h3 className="text-sm font-semibold text-gray-800 mb-3">üí∏ Despesas por Categoria</h3>
          <div style={{position: 'relative', height: '220px'}}>
            <canvas ref={el => chartRefs.current.despesasCategoria = el}></canvas>
          </div>
        </div>
      </div>
    </div>
  );
};

const ComprasAnalysis = ({ despesas, faturas = [], ingredientes, fornecedores, setActiveTab, setExpandedFatura, setGestaoSubTab }) => {
  const [searchCompra, setSearchCompra] = React.useState('');
  const [expandedIngrediente, setExpandedIngrediente] = React.useState(null); // Ingrediente expandido na an√°lise
  const [categoriaCompra, setCategoriaCompra] = React.useState('all');
  const [hoveredPoints, setHoveredPoints] = React.useState({}); // Para controlar hover nos gr√°ficos {ingredienteId: pointIndex}

  const normalizarUnidade = (quantidade, unidadeOrigem, unidadeDestino) => {
    if (!quantidade || !unidadeOrigem || !unidadeDestino) return quantidade;

    const origem = unidadeOrigem.toLowerCase().trim();
    const destino = unidadeDestino.toLowerCase().trim();

    if (origem === destino) return quantidade;

    const conversoes = {

      'ml': { 'l': 0.001, 'ml': 1 },
      'l': { 'ml': 1000, 'l': 1 },

      'g': { 'kg': 0.001, 'g': 1 },
      'kg': { 'g': 1000, 'kg': 1 },

      'un': { 'un': 1, 'und': 1, 'unidade': 1 },
      'und': { 'un': 1, 'und': 1, 'unidade': 1 },
      'unidade': { 'un': 1, 'und': 1, 'unidade': 1 }
    };

    if (conversoes[origem] && conversoes[origem][destino]) {
      return quantidade * conversoes[origem][destino];
    }

    console.warn(`‚ö†Ô∏è Convers√£o n√£o dispon√≠vel: ${origem} -> ${destino}`);
    return quantidade;
  };

  const todasCompras = React.useMemo(() => {
    const compras = [];

    despesas.forEach(d => {
      if (d.ingredienteId && d.quantidade && d.quantidade > 0) {
        const ing = ingredientes.find(i => i.id == d.ingredienteId);
        const unidadeBase = ing?.unidade || 'un';

        const quantidadeNormalizada = normalizarUnidade(d.quantidade, d.unidade || unidadeBase, unidadeBase);
        
        compras.push({
          ingredienteId: d.ingredienteId,
          quantidade: quantidadeNormalizada,
          unidadeOriginal: d.unidade,
          fornecedor: d.fornecedor,
          precoUnitario: d.valor / quantidadeNormalizada, // Pre√ßo j√° normalizado
          data: d.data
        });
      }
    });

    faturas.forEach(f => {
      if (f.itens && Array.isArray(f.itens)) {
        f.itens.forEach((item, itemIndex) => {
          const ing = ingredientes.find(i => i.id == (item.ingredienteId || item.ingrediente));
          const unidadeBase = ing?.unidade || 'un';

          const quantidadeNormalizada = normalizarUnidade(item.quantidade, item.unidade || unidadeBase, unidadeBase);
          
          compras.push({
            ingredienteId: item.ingredienteId || item.ingrediente,
            quantidade: quantidadeNormalizada,
            unidadeOriginal: item.unidade,
            fornecedor: f.fornecedor || f.fornecedorNome,
            precoUnitario: item.precoUnitario ? (item.precoTotal || (item.precoUnitario * item.quantidade)) / quantidadeNormalizada : 0,
            data: f.data,
            faturaId: f.id, // üîß Para navega√ß√£o direta
            itemIndex: itemIndex // üîß √çndice do item na fatura
          });
        });
      }
    });
    
    return compras;
  }, [despesas, faturas, ingredientes]);

  const categorias = {
    'vegetais': ['alface', 'tomate', 'cebola', 'cenoura', 'batata', 'cogumelo', 'pimento', 'alho', 'couve', 'br√≥colos', 'espinafre'],
    'carnes': ['frango', 'carne', 'porco', 'vaca', 'peru', 'bacon', 'salsicha', 'bife', 'costela'],
    'peixe': ['salm√£o', 'atum', 'bacalhau', 'camar√£o', 'polvo', 'lula', 'peixe', 'marisco'],
    'latic√≠nios': ['leite', 'queijo', 'iogurte', 'manteiga', 'nata', 'mozzarella', 'requeij√£o', 'mozarela'],
    'padaria': ['p√£o'],
    'pastelaria': ['farinha', 'fermento', 'chocolate', 'cacau', 'baunilha', 'am√™ndoa', 'noz'],
    'compotas': ['a√ß√∫car', 'pectina', '√°cido c√≠trico'],
    'bebidas': ['√°gua', 'sumo', 'refrigerante', 'vinho', 'cerveja', 'caf√©', 'ch√°'],
    'temperos': ['sal', 'pimenta', 'azeite', 'vinagre', 'oreg√£os', 'especiaria', 'canela', 'colorau']
  };
  
  const getCategoria = (ingrediente) => {
    return ingrediente.categoria || 'outros';
  };

  const comprasPorIngrediente = React.useMemo(() => {
    const result = {};
    todasCompras.forEach(compra => {
      const ing = ingredientes.find(i => i.id == compra.ingredienteId);
      if (!ing) return;
      
      if (!result[compra.ingredienteId]) {
        result[compra.ingredienteId] = {
          nome: ing.nome,
          unidade: ing.unidade,
          categoria: getCategoria(ing),
          compras: []
        };
      }
      
      result[compra.ingredienteId].compras.push({
        fornecedor: compra.fornecedor,
        precoUnitario: compra.precoUnitario,
        data: compra.data,
        quantidade: compra.quantidade,
        faturaId: compra.faturaId, // üîß Para navega√ß√£o
        itemIndex: compra.itemIndex // üîß √çndice do item
      });
    });
    return result;
  }, [todasCompras, ingredientes]);

  const ingredientesFiltrados = React.useMemo(() => {
    let filtered = Object.values(comprasPorIngrediente).filter(ing => ing.compras.length > 0);
    
    if (categoriaCompra !== 'all') {
      filtered = filtered.filter(ing => ing.categoria === categoriaCompra);
    }
    
    if (searchCompra) {
      filtered = filtered.filter(ing => 
        normalizeText(ing.nome).includes(normalizeText(searchCompra))
      );
    }
    
    return filtered.slice(0, 50);
  }, [comprasPorIngrediente, categoriaCompra, searchCompra]);

  const countByCategoria = React.useMemo(() => {
    const counts = {};
    Object.values(comprasPorIngrediente).forEach(ing => {
      counts[ing.categoria] = (counts[ing.categoria] || 0) + 1;
    });
    return counts;
  }, [comprasPorIngrediente]);
  
  const allCount = Object.values(comprasPorIngrediente).filter(ing => ing.compras.length > 0).length;
  
  return (
    <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
      <h2 className="text-base font-bold mb-3">üìä An√°lise de Compras</h2>
      
      {/* Summary Cards */}
<div className="grid grid-cols-3 gap-2 mb-3">
        <div className="bg-blue-50 rounded p-3 border border-blue-200">
          <p className="text-xs text-blue-700 mb-1">Total Compras</p>
          <p className="text-xl font-bold text-blue-900">
            ‚Ç¨{(() => {

              const totalFaturas = faturas
                .filter(f => f.categoria === 'compras')
                .reduce((sum, f) => sum + (f.totais?.total || f.total || 0), 0);

              const totalDespesas = despesas
                .filter(d => d.ingredienteId)
                .reduce((sum, d) => sum + (d.valor || 0), 0);
              
              return (totalFaturas + totalDespesas).toFixed(2);
            })()}
          </p>
        </div>
        <div className="bg-green-50 rounded p-3 border border-green-200">
          <p className="text-xs text-green-700 mb-1">N¬∫ Fornecedores</p>
          <p className="text-xl font-bold text-green-900">{(fornecedores || []).length}</p>
        </div>
        <div className="bg-purple-50 rounded p-3 border border-purple-200">
          <p className="text-xs text-purple-700 mb-1">Ingredientes</p>
          <p className="text-xl font-bold text-purple-900">{(ingredientes || []).length}</p>
        </div>
      </div>

      {/* Price Comparison */}
      <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded border border-blue-200 p-3">
        <h3 className="text-sm font-bold mb-3 text-blue-900">üí∞ Compara√ß√£o de Pre√ßos</h3>
        
        {/* Category Tabs */}
        <div className="flex gap-1 mb-3 overflow-x-auto bg-white p-1 rounded">
          {[
            {id: 'all', emoji: 'üì¶', label: 'Todos', count: allCount},
            {id: 'vegetais', emoji: 'ü•¨', label: 'Vegetais', count: countByCategoria['vegetais'] || 0},
            {id: 'carnes', emoji: 'ü•©', label: 'Carnes', count: countByCategoria['carnes'] || 0},
            {id: 'peixe', emoji: 'üêü', label: 'Peixe', count: countByCategoria['peixe'] || 0},
            {id: 'latic√≠nios', emoji: 'üßÄ', label: 'Latic√≠nios', count: countByCategoria['latic√≠nios'] || 0},
            {id: 'padaria', emoji: 'ü•ñ', label: 'Padaria', count: countByCategoria['padaria'] || 0},
            {id: 'pastelaria', emoji: 'üç∞', label: 'Pastelaria', count: countByCategoria['pastelaria'] || 0},
            {id: 'compotas', emoji: 'üçØ', label: 'Compotas', count: countByCategoria['compotas'] || 0},
            {id: 'bebidas', emoji: 'ü•§', label: 'Bebidas', count: countByCategoria['bebidas'] || 0},
            {id: 'temperos', emoji: 'üßÇ', label: 'Temperos', count: countByCategoria['temperos'] || 0},
            {id: 'embalagens', emoji: 'üì¶', label: 'Embalagens', count: countByCategoria['embalagens'] || 0},
            {id: 'consumiveis', emoji: 'üß¥', label: 'Consum√≠veis', count: countByCategoria['consumiveis'] || 0},
            {id: 'limpeza', emoji: 'üßπ', label: 'Limpeza', count: countByCategoria['limpeza'] || 0},
            {id: 'operacionais', emoji: 'üîß', label: 'Operacionais', count: countByCategoria['operacionais'] || 0},
            {id: 'outros', emoji: 'üìã', label: 'Outros', count: countByCategoria['outros'] || 0}
          ].map(cat => (
            <button
              key={cat.id}
              onClick={() => setCategoriaCompra(cat.id)}
              className={`px-3 py-1.5 rounded text-xs font-semibold whitespace-nowrap transition-colors ${
                categoriaCompra === cat.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {cat.emoji} {cat.label} ({cat.count})
            </button>
          ))}
        </div>
        
        {/* Search Bar */}
        <div className="mb-3">
          <input
            type="text"
            placeholder="üîç Procurar ingrediente..."
            value={searchCompra}
            onChange={(e) => setSearchCompra(e.target.value)}
            className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
          />
        </div>
        
        {/* Results */}
        {ingredientesFiltrados.length === 0 ? (
          <div className="text-center py-8 bg-white rounded border">
            <p className="text-sm text-gray-600">
              {searchCompra ? `Nenhum ingrediente encontrado com "${searchCompra}"` : 'Nenhum ingrediente nesta categoria'}
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
            {ingredientesFiltrados.map(ing => {
              const precoMedio = ing.compras.reduce((s, c) => s + c.precoUnitario, 0) / ing.compras.length;
              const precoMin = Math.min(...ing.compras.map(c => c.precoUnitario));
              const precoMax = Math.max(...ing.compras.map(c => c.precoUnitario));
              const melhorCompra = ing.compras.reduce((best, curr) => 
                curr.precoUnitario < best.precoUnitario ? curr : best
              );
              
              const isExpanded = expandedIngrediente === ing.nome;
              
              return (
                <div key={ing.nome} className={`bg-white rounded border hover:shadow-md transition-shadow ${isExpanded ? 'md:col-span-2 lg:col-span-3' : ''}`}>
                  {/* HEADER - Sempre vis√≠vel e clic√°vel */}
                  <div 
                    onClick={() => setExpandedIngrediente(isExpanded ? null : ing.nome)}
                    className="p-2 cursor-pointer hover:bg-gray-50 transition-colors"
                  >
                    <div className="flex justify-between items-start mb-1">
                      <div className="flex items-center gap-2">
                        <span className="text-gray-500">
                          {isExpanded ? '‚ñº' : '‚ñ∂'}
                        </span>
                        <span className="font-bold text-sm text-gray-800">{ing.nome}</span>
                      </div>
                      <div className="text-right">
                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded block">
                          {ing.compras.length} compra{ing.compras.length > 1 ? 's' : ''}
                        </span>
                        {(() => {

                          if (ing.compras.length === 0) return null;
                          
                          const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                          const firstDate = new Date(sortedCompras[0].data);
                          const lastDate = new Date(sortedCompras[sortedCompras.length - 1].data);

                          const monthsDiff = (lastDate.getFullYear() - firstDate.getFullYear()) * 12 + 
                                            (lastDate.getMonth() - firstDate.getMonth()) + 1; // +1 to include both months
                          
                          const comprasPorMes = ing.compras.length / monthsDiff;
                          const qtdTotal = ing.compras.reduce((sum, c) => sum + c.quantidade, 0);
                          const qtdPorMes = qtdTotal / monthsDiff;
                          const gastoTotal = ing.compras.reduce((sum, c) => sum + (c.precoUnitario * c.quantidade), 0);
                          const gastoPorMes = gastoTotal / monthsDiff;
                          
                          return (
                            <div className="mt-1 text-[10px] text-gray-600 space-y-0.5">
                              <div className="bg-purple-50 px-1.5 py-0.5 rounded">
                                üìä {comprasPorMes.toFixed(1)}x/m√™s
                              </div>
                              <div className="bg-green-50 px-1.5 py-0.5 rounded">
                                üì¶ {qtdPorMes.toFixed(1)}{ing.unidade}/m√™s
                              </div>
                              <div className="bg-orange-50 px-1.5 py-0.5 rounded">
                                üí∞ ‚Ç¨{gastoPorMes.toFixed(2)}/m√™s
                              </div>
                              <div className="bg-blue-50 px-1.5 py-0.5 rounded border-t border-blue-200 mt-1 pt-1 font-semibold">
                                üìä Total: {qtdTotal.toFixed(1)}{ing.unidade} ‚Ä¢ ‚Ç¨{gastoTotal.toFixed(2)}
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-xs">
                      <div>
                        <span className="text-gray-600">M√©dio:</span>
                        <span className="font-semibold ml-1">‚Ç¨{precoMedio.toFixed(2)}/{ing.unidade}</span>
                      </div>
                      <div>
                        <span className="text-green-600">Min:</span>
                        <span className="font-semibold ml-1 text-green-700">‚Ç¨{precoMin.toFixed(2)}</span>
                      </div>
                      <div>
                        <span className="text-red-600">Max:</span>
                        <span className="font-semibold ml-1 text-red-700">‚Ç¨{precoMax.toFixed(2)}</span>
                      </div>
                    </div>
                    {melhorCompra.fornecedor && (
                      <p className="text-xs text-gray-600 mt-1">
                        üí° Melhor: <span className="font-semibold">{melhorCompra.fornecedor}</span> - ‚Ç¨{melhorCompra.precoUnitario.toFixed(2)}/{ing.unidade}
                      </p>
                    )}
                  </div>
                  
                  {/* CONTE√öDO EXPAND√çVEL - S√≥ vis√≠vel quando expandido */}
                  {isExpanded && (
                    <div className="px-2 pb-2 pt-2 border-t border-gray-200 bg-gray-50">
                  
                  {/* Hist√≥rico de Compras - √öltimas 3 */}
                  {ing.compras.length > 1 && (
                    <div className="mb-3 bg-gray-50 rounded p-2">
                      <p className="text-xs font-semibold text-gray-700 mb-1">üìÖ √öltimas Compras:</p>
                      <div className="space-y-0.5">
                        {ing.compras
                          .sort((a, b) => new Date(b.data) - new Date(a.data))
                          .slice(0, 3) // S√≥ mostrar as 3 mais recentes
                          .map((compra, idx) => {
                            const isMelhor = compra.precoUnitario === precoMin;
                            return (
                              <div key={idx} className={`text-xs flex justify-between items-center ${isMelhor ? 'font-semibold text-green-700' : 'text-gray-600'}`}>
                                <span>
                                  {new Date(compra.data).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' })} 
                                  {' ‚Ä¢ '}
                                  {compra.fornecedor}
                                </span>
                                <span>
                                  ‚Ç¨{compra.precoUnitario.toFixed(2)}/{ing.unidade}
                                  {isMelhor && ' ‚≠ê'}
                                </span>
                              </div>
                            );
                          })}
                      </div>
                    </div>
                  )}
                  
                  {/* Price Evolution Chart */}
                  {ing.compras.length > 2 && (
                    <div className="mt-2 bg-blue-50 rounded p-2 border border-blue-200">
                      <p className="text-xs font-semibold text-blue-900 mb-2">üìà Evolu√ß√£o de Pre√ßos</p>
                      <div className="relative h-40 bg-white rounded p-3">
                        {(() => {
                          const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                          const precos = sortedCompras.map(c => c.precoUnitario);
                          const minPreco = Math.min(...precos);
                          const maxPreco = Math.max(...precos);
                          const range = maxPreco - minPreco || 1;
                          const hoveredPoint = hoveredPoints[ing.id];
                          const setHoveredPoint = (pointIndex) => {
                            setHoveredPoints(prev => ({...prev, [ing.id]: pointIndex}));
                          };
                          
                          return (
                            <>
                              {/* Grid lines with labels */}
                              <div className="absolute inset-0 p-2 pointer-events-none">
                                {[0, 0.25, 0.5, 0.75, 1].map((percent, idx) => {
                                  const price = minPreco + (maxPreco - minPreco) * (1 - percent);
                                  const yPos = `${percent * 100}%`;
                                  return (
                                    <div key={idx} className="absolute w-full" style={{top: yPos}}>
                                      <div className={`border-t ${idx === 0 || idx === 4 ? 'border-gray-400' : 'border-gray-200'} border-dashed`}></div>
                                      <span className="absolute left-0 -top-2 text-[9px] font-semibold text-gray-700 bg-white/90 px-1">
                                        ‚Ç¨{price.toFixed(2)}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {/* Price line */}
                              <svg className="absolute inset-0 w-full h-full p-2" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                                <polyline
                                  points={sortedCompras.map((c, i) => {
                                    const x = (i / (sortedCompras.length - 1)) * 100;
                                    const y = 90 - ((c.precoUnitario - minPreco) / range) * 80;
                                    return `${x},${y}`;
                                  }).join(' ')}
                                  fill="none"
                                  stroke="#3b82f6"
                                  strokeWidth="0.8"
                                  vectorEffect="non-scaling-stroke"
                                />
                                {/* Points with hover - PRIMEIRO renderizar TODOS os pontos */}
                                {sortedCompras.map((c, i) => {
                                  const x = (i / (sortedCompras.length - 1)) * 100;
                                  const y = 90 - ((c.precoUnitario - minPreco) / range) * 80;
                                  const isMelhor = c.precoUnitario === minPreco;
                                  const isHovered = hoveredPoint === i;
                                  
                                  return (
                                    <g key={`point-${i}`}>
                                      {/* Invisible larger circle for easier hover */}
                                      <circle
                                        cx={x}
                                        cy={y}
                                        r="5"
                                        fill="transparent"
                                        style={{cursor: 'pointer'}}
                                        onMouseEnter={() => setHoveredPoint(i)}
                                        onMouseLeave={() => setHoveredPoint(null)}
                                        onClick={() => {

                                          if (c.faturaId && setActiveTab && setExpandedFatura && setGestaoSubTab) {

                                            setActiveTab('gestao');

                                            setGestaoSubTab('faturas');

                                            setTimeout(() => {
                                              setExpandedFatura(c.faturaId);

                                              const faturaElement = document.getElementById(`fatura-${c.faturaId}`);
                                              if (faturaElement) {
                                                faturaElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                                                faturaElement.style.boxShadow = '0 0 20px 5px rgba(59, 130, 246, 0.5)';
                                                setTimeout(() => {
                                                  faturaElement.style.boxShadow = '';
                                                }, 2000);
                                              }
                                            }, 100);
                                          }
                                        }}
                                      />
                                      {/* Visible point */}
                                      <circle
                                        cx={x}
                                        cy={y}
                                        r={isHovered ? "3" : "2"}
                                        fill={isMelhor ? '#10b981' : '#3b82f6'}
                                        stroke="white"
                                        strokeWidth={isHovered ? "0.5" : "0.3"}
                                        style={{pointerEvents: 'none', transition: 'all 0.2s'}}
                                      />
                                    </g>
                                  );
                                })}
                                
                                {/* Tooltips - DEPOIS renderizar os tooltips por cima */}
                                {sortedCompras.map((c, i) => {
                                  const x = (i / (sortedCompras.length - 1)) * 100;
                                  const y = 90 - ((c.precoUnitario - minPreco) / range) * 80;
                                  const isHovered = hoveredPoint === i;
                                  
                                  if (!isHovered) return null;
                                  
                                  return (
                                    <g key={`tooltip-${i}`} style={{pointerEvents: 'none'}}>
                                      {(() => {

                                        const showBelow = y < 30;
                                        const tooltipHeight = c.fornecedor ? 46 : 38; // Aumentado para incluir quantidade
                                        const tooltipY = showBelow ? y + 4 : y - tooltipHeight - 2;
                                        const textY1 = showBelow ? y + 14 : y - tooltipHeight + 10;
                                        const textY2 = showBelow ? y + 24 : y - tooltipHeight + 20;
                                        const textY3 = showBelow ? y + 32 : y - tooltipHeight + 28;
                                        const textY4 = showBelow ? y + 40 : y - tooltipHeight + 36;
                                        const textY5 = showBelow ? y + 48 : y - tooltipHeight + 44;
                                        
                                        return (
                                          <>
                                            <rect
                                              x={x > 50 ? x - 45 : x + 3}
                                              y={tooltipY}
                                              width="42"
                                              height={tooltipHeight}
                                              fill="rgba(0, 0, 0, 0.95)"
                                              rx="2"
                                              stroke="#3b82f6"
                                              strokeWidth="0.5"
                                            />
                                            <text
                                              x={x > 50 ? x - 24 : x + 24}
                                              y={textY1}
                                              fontSize="8"
                                              fontWeight="700"
                                              fill="white"
                                              textAnchor="middle"
                                            >
                                              ‚Ç¨{c.precoUnitario.toFixed(2)}
                                            </text>
                                            {/* üì¶ Quantidade + Unidade */}
                                            <text
                                              x={x > 50 ? x - 24 : x + 24}
                                              y={textY2}
                                              fontSize="6.5"
                                              fontWeight="600"
                                              fill="#86efac"
                                              textAnchor="middle"
                                            >
                                              üì¶ {c.quantidade} {c.unidade || ing.unidade}
                                            </text>
                                            <text
                                              x={x > 50 ? x - 24 : x + 24}
                                              y={textY3}
                                              fontSize="6.5"
                                              fontWeight="600"
                                              fill="#93c5fd"
                                              textAnchor="middle"
                                            >
                                              {new Date(c.data).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: '2-digit' })}
                                            </text>
                                            {c.fornecedor && (
                                              <text
                                                x={x > 50 ? x - 24 : x + 24}
                                                y={textY4}
                                                fontSize="6"
                                                fontWeight="600"
                                                fill="#fbbf24"
                                                textAnchor="middle"
                                              >
                                                {c.fornecedor.substring(0, 12)}
                                              </text>
                                            )}
                                            {/* üîß √çcone de clique se tem faturaId */}
                                            {c.faturaId && setActiveTab && setExpandedFatura && setGestaoSubTab && (
                                              <text
                                                x={x > 50 ? x - 24 : x + 24}
                                                y={textY5}
                                                fontSize="7"
                                                fontWeight="600"
                                                fill="#10b981"
                                                textAnchor="middle"
                                              >
                                                üîß Clique p/ editar
                                              </text>
                                            )}
                                          </>
                                        );
                                      })()}
                                    </g>
                                  );
                                })}
                              </svg>
                              

                              {/* Date labels - Smart spacing */}
                              <div className="absolute bottom-0 left-0 right-0 flex justify-between px-2 text-[9px] font-semibold text-blue-700">
                                {(() => {

                                  const numLabels = Math.min(6, sortedCompras.length);
                                  const step = Math.max(1, Math.floor(sortedCompras.length / (numLabels - 1)));
                                  const labels = [];
                                  
                                  for (let i = 0; i < sortedCompras.length; i += step) {
                                    if (labels.length >= numLabels - 1) break;
                                    labels.push(i);
                                  }

                                  if (labels[labels.length - 1] !== sortedCompras.length - 1) {
                                    labels.push(sortedCompras.length - 1);
                                  }
                                  
                                  return labels.map((idx, i) => (
                                    <span key={i} className="bg-blue-50/90 px-1 py-0.5 rounded">
                                      {new Date(sortedCompras[idx].data).toLocaleDateString('pt-PT', { day: 'numeric', month: 'short' })}
                                    </span>
                                  ));
                                })()}
                              </div>
                            </>
                          );
                        })()}
                      </div>
                      
                      {/* Trend indicator */}
                      {(() => {
                        const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                        const primeiroPreco = sortedCompras[0].precoUnitario;
                        const ultimoPreco = sortedCompras[sortedCompras.length - 1].precoUnitario;
                        const variacao = ((ultimoPreco - primeiroPreco) / primeiroPreco) * 100;
                        const isSubiu = variacao > 0;
                        
                        return (
                          <div className={`mt-1 text-xs flex items-center gap-1 ${isSubiu ? 'text-red-600' : variacao < 0 ? 'text-green-600' : 'text-gray-600'}`}>
                            {isSubiu ? 'üìà' : variacao < 0 ? 'üìâ' : '‚û°Ô∏è'}
                            <span className="font-semibold">
                              {isSubiu ? '+' : ''}{variacao.toFixed(1)}%
                            </span>
                            <span>desde {new Date(sortedCompras[0].data).toLocaleDateString('pt-PT', { month: 'short' })}</span>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                  
                  {/* Price Alerts */}
                  {ing.compras.length > 1 && (() => {
                    const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                    const precos = sortedCompras.map(c => c.precoUnitario);
                    const minPreco = Math.min(...precos);
                    const maxPreco = Math.max(...precos);
                    const variacao = ((maxPreco - minPreco) / minPreco) * 100;

                    const hoje = new Date();
                    const trinta_dias = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
                    const comprasRecentes = sortedCompras.filter(c => new Date(c.data) >= trinta_dias);

                    let trendAlert = null;
                    if (comprasRecentes.length >= 2) {
                      const primeiraRecente = comprasRecentes[0].precoUnitario;
                      const ultimaRecente = comprasRecentes[comprasRecentes.length - 1].precoUnitario;
                      const variacaoMes = ((ultimaRecente - primeiraRecente) / primeiraRecente) * 100;
                      
                      if (variacaoMes > 5) {
                        trendAlert = { type: 'warning', message: `Pre√ßo subiu ${variacaoMes.toFixed(1)}% este m√™s`, icon: '‚ö†Ô∏è' };
                      } else if (variacaoMes < -5) {
                        trendAlert = { type: 'success', message: `Pre√ßo desceu ${Math.abs(variacaoMes).toFixed(1)}% este m√™s`, icon: '‚úÖ' };
                      }
                    }

                    const melhorCompraRecente = sortedCompras.find(c => c.precoUnitario === minPreco);
                    const diasDesdeRecorde = melhorCompraRecente ? Math.floor((hoje - new Date(melhorCompraRecente.data)) / (24 * 60 * 60 * 1000)) : 999;
                    const recordeRecente = diasDesdeRecorde <= 30;

                    const altaVariacao = variacao > 10;
                    
                    const alerts = [];
                    if (trendAlert) alerts.push(trendAlert);
                    if (recordeRecente) alerts.push({ 
                      type: 'info', 
                      message: `Melhor pre√ßo nos √∫ltimos 30 dias (${melhorCompraRecente.fornecedor})`,
                      icon: 'üéØ'
                    });
                    if (altaVariacao) alerts.push({
                      type: 'warning',
                      message: `Varia√ß√£o de ${variacao.toFixed(1)}% entre fornecedores`,
                      icon: 'üìä'
                    });
                    
                    return alerts.length > 0 ? (
                      <div className="mt-2 space-y-1">
                        {alerts.map((alert, idx) => (
                          <div 
                            key={idx}
                            className={`text-xs px-2 py-1 rounded flex items-start gap-1 ${
                              alert.type === 'warning' ? 'bg-orange-50 text-orange-800 border border-orange-200' :
                              alert.type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
                              'bg-blue-50 text-blue-800 border border-blue-200'
                            }`}
                          >
                            <span>{alert.icon}</span>
                            <span className="flex-1">{alert.message}</span>
                          </div>
                        ))}
                      </div>
                    ) : null;
                  })()}
                    </div>
                  )}
                </div>
              );
            })}
            {ingredientesFiltrados.length === 50 && (
              <p className="text-xs text-center text-gray-500 py-2">
                A mostrar 50 ingredientes. Refine a pesquisa para ver mais resultados espec√≠ficos.
              </p>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

const GitHubBackupPanel = ({ onSync }) => {
  const [token, setToken] = React.useState('');
  const [showToken, setShowToken] = React.useState(false);
  const [showConfig, setShowConfig] = React.useState(false);
  const [isSyncing, setIsSyncing] = React.useState(false);
  const [passwordInput, setPasswordInput] = React.useState('');
  const [showSavedToken, setShowSavedToken] = React.useState(false);
  
  const isConfigured = GitHubSync.isConfigured();
  const gistUrl = GitHubSync.getGistUrl();
  const lastSync = GitHubSync.getLastSync();
  const autoSyncEnabled = GitHubSync.getAutoSyncEnabled();

  const saveToken = () => {
    if (token.trim()) {
      GitHubSync.setToken(token.trim());
      setShowConfig(false);
      setToken('');
      alert('‚úÖ Token guardado! A sincronizar dados...');
      handleSync();
    }
  };

  const clearConfig = () => {
    if (confirm('‚ö†Ô∏è Tem a certeza que quer desconectar o GitHub?\\n\\nOs dados locais N√ÉO ser√£o apagados, mas o backup autom√°tico ser√° desativado.')) {
      GitHubSync.clearConfig();
      setShowConfig(false);
      alert('‚úÖ GitHub desconectado');
    }
  };

  const handleSync = async () => {
    setIsSyncing(true);
    try {
      await onSync();
    } finally {
      setIsSyncing(false);
    }
  };

  const getTimeSince = (dateString) => {
    if (!dateString) return 'Nunca';
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'Agora mesmo';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `H√° ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `H√° ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
    const days = Math.floor(hours / 24);
    return `H√° ${days} ${days === 1 ? 'dia' : 'dias'}`;
  };
  
  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Cloud className="w-6 h-6 text-blue-600" />
          <div>
            <h3 className="font-bold text-blue-900">Backup Cloud (GitHub)</h3>
            {isConfigured && !showConfig && (
              <p className="text-xs text-blue-700">Auto-sync: {autoSyncEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</p>
            )}
          </div>
        </div>
        <button
          onClick={() => setShowConfig(!showConfig)}
          className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded transition"
          title="Configura√ß√µes"
        >
          <Settings className="w-5 h-5" />
        </button>
      </div>
      
      {showConfig ? (
        <div className="space-y-3 bg-white rounded-lg p-4 border border-blue-300">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üîë GitHub Personal Access Token
            </label>
            <div className="relative">
              <input
                type={showToken ? "text" : "password"}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                className="w-full px-3 py-2 pr-20 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-semibold"
              >
                {showToken ? 'Ocultar' : 'Mostrar'}
              </button>
            </div>
            
            <div className="mt-2 space-y-1 text-xs text-gray-600">
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">1.</span>
                <span>Crie token em: <a href="https://github.com/settings/tokens/new?scopes=gist&description=Munchi%20Manager%20Backup" target="_blank" className="text-blue-600 underline font-semibold hover:text-blue-800">github.com/settings/tokens</a></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">2.</span>
                <span>Marque apenas: <strong className="text-green-700">‚úì gist</strong></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">3.</span>
                <span>Cole aqui e clique em "Guardar"</span>
              </p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={saveToken}
              disabled={!token.trim()}
              className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
            >
              üíæ Guardar Token
            </button>
            {isConfigured && (
              <button
                onClick={clearConfig}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition"
              >
                üîå Desconectar
              </button>
            )}
          </div>
          
          <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-900">
            <p className="font-semibold mb-1 flex items-center gap-1">
              üîí Seguran√ßa & Privacidade
            </p>
            <ul className="space-y-1 ml-4 text-yellow-800">
              <li>‚Ä¢ Token guardado <strong>localmente</strong> no seu browser</li>
              <li>‚Ä¢ Nunca partilhado com servidores externos</li>
              <li>‚Ä¢ Gist criado como <strong>privado</strong> (s√≥ voc√™ v√™)</li>
              <li>‚Ä¢ Pode revogar token a qualquer momento</li>
            </ul>
          </div>
        </div>
      ) : (
        <>
          {!isConfigured ? (
            <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              <p className="text-sm text-yellow-800 flex items-center gap-2">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <span>Configure o GitHub para ativar backup autom√°tico na cloud</span>
              </p>
              <button
                onClick={() => setShowConfig(true)}
                className="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-semibold transition text-sm"
              >
                ‚öôÔ∏è Configurar Agora
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="bg-white rounded-lg p-3 border-2 border-green-300 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <CloudCheck className="w-5 h-5 text-green-600" />
                    <div>
                      <p className="text-sm font-semibold text-green-900">Conectado ‚úì</p>
                      <p className="text-xs text-green-700">√öltimo backup: {getTimeSince(lastSync)}</p>
                    </div>
                  </div>
                  <button
                    onClick={handleSync}
                    disabled={isSyncing}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    {isSyncing ? 'A sincronizar...' : 'Sync'}
                  </button>
                </div>
                
                {gistUrl && (
                  <a
                    href={gistUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1"
                  >
                    üîó Ver backup no GitHub
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
              
              {/* Ver Token Protegido por Password */}
              <div className="bg-white rounded-lg p-3 border border-gray-300">
                <div className="space-y-2">
                  <p className="text-sm font-semibold text-gray-900 flex items-center gap-2">
                    üîê Ver Token
                    <span className="text-xs font-normal text-gray-500">(para copiar noutro dispositivo)</span>
                  </p>
                  
                  {!showSavedToken ? (
                    <div className="space-y-2">
                      <div className="flex gap-2">
                        <input
                          type="password"
                          value={passwordInput}
                          onChange={(e) => setPasswordInput(e.target.value)}
                          placeholder="Password de prote√ß√£o"
                          className="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              const savedPwd = localStorage.getItem('munchi_token_password');
                              
                              if (!savedPwd) {

                                localStorage.setItem('munchi_token_password', passwordInput);
                                setShowSavedToken(true);
                                setPasswordInput('');
                                alert('‚úÖ Password definida! Use esta password para ver o token no futuro.');
                              } else if (passwordInput === savedPwd) {

                                setShowSavedToken(true);
                                setPasswordInput('');
                              } else {

                                alert('‚ùå Password incorreta!');
                                setPasswordInput('');
                              }
                            }
                          }}
                        />
                        <button
                          onClick={() => {
                            const savedPwd = localStorage.getItem('munchi_token_password');
                            
                            if (!savedPwd) {
                              localStorage.setItem('munchi_token_password', passwordInput);
                              setShowSavedToken(true);
                              setPasswordInput('');
                              alert('‚úÖ Password definida! Use esta password para ver o token no futuro.');
                            } else if (passwordInput === savedPwd) {
                              setShowSavedToken(true);
                              setPasswordInput('');
                            } else {
                              alert('‚ùå Password incorreta!');
                              setPasswordInput('');
                            }
                          }}
                          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition text-sm whitespace-nowrap"
                        >
                          üëÅÔ∏è Ver
                        </button>
                      </div>
                      <p className="text-xs text-gray-500">
                        {localStorage.getItem('munchi_token_password') 
                          ? 'üí° Introduce a tua password para ver o token' 
                          : 'üí° Define uma password para proteger o acesso ao token'}
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="relative">
                        <input
                          type="text"
                          value={GitHubSync.getToken()}
                          readOnly
                          className="w-full px-3 py-2 pr-24 border border-gray-300 rounded text-xs bg-gray-50 font-mono"
                        />
                        <button
                          onClick={() => {
                            navigator.clipboard.writeText(GitHubSync.getToken());
                            alert('‚úÖ Token copiado para a √°rea de transfer√™ncia!');
                          }}
                          className="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold"
                        >
                          üìã Copiar
                        </button>
                      </div>
                      <button
                        onClick={() => {
                          setShowSavedToken(false);
                          setPasswordInput('');
                        }}
                        className="text-xs text-blue-600 hover:text-blue-800 font-semibold"
                      >
                        üîí Ocultar
                      </button>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="bg-white rounded-lg p-3 border border-gray-300">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-semibold text-gray-900">Sincroniza√ß√£o Autom√°tica</p>
                    <p className="text-xs text-gray-600">Backup a cada 5 minutos</p>
                  </div>
                  <button
                    onClick={() => {
                      GitHubSync.setAutoSyncEnabled(!autoSyncEnabled);
                      window.location.reload();
                    }}
                    className={`w-12 h-6 rounded-full transition ${autoSyncEnabled ? 'bg-green-500' : 'bg-gray-300'} relative`}
                  >
                    <div className={`w-5 h-5 rounded-full bg-white absolute top-0.5 transition-all ${autoSyncEnabled ? 'left-6' : 'left-0.5'}`}></div>
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

const Tooltip = ({ children, text, position = 'top' }) => {
  const [show, setShow] = React.useState(false);
  
  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2'
  };
  
  return (
    <div className="relative inline-block">
      <div
        onMouseEnter={() => setShow(true)}
        onMouseLeave={() => setShow(false)}
        className="cursor-help"
      >
        {children}
      </div>
      {show && (
        <div className={`absolute ${positionClasses[position]} z-50 w-64 pointer-events-none`}>
          <div className="bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg">
            {text}
            <div className={`absolute w-2 h-2 bg-gray-900 transform rotate-45 ${
              position === 'top' ? 'bottom-[-4px] left-1/2 -translate-x-1/2' :
              position === 'bottom' ? 'top-[-4px] left-1/2 -translate-x-1/2' :
              position === 'left' ? 'right-[-4px] top-1/2 -translate-y-1/2' :
              'left-[-4px] top-1/2 -translate-y-1/2'
            }`}></div>
          </div>
        </div>
      )}
    </div>
  );
};

const ModalConfirmacaoOCR = ({ linhas, ingredientes, metadata, onConfirmar, onCancelar, fornecedores, showNotification, setFornecedores }) => {
  const [linhasEditadas, setLinhasEditadas] = useState(linhas);
  const [stats, setStats] = useState(null);
  const [ingredientesLocais, setIngredientesLocais] = useState(ingredientes); // Lista local que pode crescer
  const [mostrarModalCriarIng, setMostrarModalCriarIng] = useState(false);
  const [novoIngrediente, setNovoIngrediente] = useState({
    nome: '',
    categoria: 'outros',
    unidade: 'kg',
    custo: '',
    iva: '13'
  });
  const [linhaIndexCriando, setLinhaIndexCriando] = useState(null);

  const [mostrarModalLimparPalavras, setMostrarModalLimparPalavras] = useState(false);
  const [linhaParaLimpar, setLinhaParaLimpar] = useState(null);
  const [palavrasSelecionadas, setPalavrasSelecionadas] = useState([]);
  const [sempreRemover, setSempreRemover] = useState(true);

  const [searchIngredienteOCR, setSearchIngredienteOCR] = useState(() => {

    const initial = {};

    linhas.forEach((linha, index) => {

      const linhaId = `${linha.nomeProduto}_${index}`;
      linha._id = linhaId; // Adicionar ID √† linha

      if (linha.ingredienteConfirmado) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteConfirmado);
        if (ing) {
          initial[linhaId] = ing.nome;

        }
      } 

      else if (linha.ingredienteSugerido && linha.confiancaSugestao >= 80) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteSugerido.id);
        if (ing) {
          initial[linhaId] = ing.nome;

        } else {

        }
      }
    });

    return initial;
  });
  const [showDropdownOCR, setShowDropdownOCR] = useState({});

  useEffect(() => {
    const novoSearch = { ...searchIngredienteOCR };
    let houveMudancas = false;
    
    linhasEditadas.forEach((linha, index) => {

      if (!linha._id) {
        linha._id = `${linha.nomeProduto}_${index}`;
      }
      const linhaId = linha._id;

      if (searchIngredienteOCR[linhaId]) return;

      if (linha.ingredienteConfirmado) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteConfirmado);
        if (ing && !searchIngredienteOCR[linhaId]) {
          novoSearch[linhaId] = ing.nome;
          houveMudancas = true;
        }
      }

      else if (linha.ingredienteSugerido && linha.confiancaSugestao >= 80) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteSugerido.id);
        if (ing && !searchIngredienteOCR[linhaId]) {
          novoSearch[linhaId] = ing.nome;
          houveMudancas = true;
        }
      }
    });
    
    if (houveMudancas) {
      setSearchIngredienteOCR(novoSearch);
    }
  }, [linhasEditadas]); // Reagir quando linhas mudarem

  useEffect(() => {
    const novasLinhas = linhasEditadas.map(linha => {

      if (linha.ingredienteConfirmado) return linha;

      if (linha.ingredienteSugerido && linha.confiancaSugestao >= 80) {
        return {
          ...linha,
          ingredienteConfirmado: linha.ingredienteSugerido.id
        };
      }
      
      return linha;
    });

    const houveMudancas = novasLinhas.some((linha, idx) => 
      linha.ingredienteConfirmado !== linhasEditadas[idx].ingredienteConfirmado
    );
    
    if (houveMudancas) {
      setLinhasEditadas(novasLinhas);
    }
  }, []); // Executar apenas uma vez ao montar o componente

  const [numeroFaturaManual, setNumeroFaturaManual] = useState(metadata?.numeroFatura || '');
  const [fornecedorManual, setFornecedorManual] = useState('');
  const [fornecedoresLocais, setFornecedoresLocais] = useState(fornecedores); // Lista local
  const [mostrarModalNovoFornecedor, setMostrarModalNovoFornecedor] = useState(false);
  const [novoFornecedor, setNovoFornecedor] = useState({
    nome: '',
    nif: metadata?.nif || '',
    contacto: '',
    email: ''
  });

  const criarNovoFornecedor = () => {
    if (!novoFornecedor.nome.trim()) {
      alert('Nome √© obrigat√≥rio!');
      return;
    }

    const novoFornTemp = {
      id: Date.now(),
      nome: novoFornecedor.nome.trim(),
      nif: novoFornecedor.nif.trim(),
      telefone: novoFornecedor.contacto.trim(),
      email: novoFornecedor.email.trim(),
      morada: '',
      dataCriacao: new Date().toISOString()
    };

    if (setFornecedores && typeof setFornecedores === 'function') {
      setFornecedores(prev => [...prev, novoFornTemp]);
    }

    setFornecedoresLocais(prev => [...prev, novoFornTemp]);

    if (!window._novosFornecedores) window._novosFornecedores = [];
    window._novosFornecedores.push(novoFornTemp);

    setFornecedorManual(novoFornTemp.id);

    if (showNotification && typeof showNotification === 'function') {
      showNotification('‚úÖ Fornecedor criado com sucesso!', 'success');
    }

    setMostrarModalNovoFornecedor(false);
    setNovoFornecedor({ nome: '', nif: metadata.nif || '', contacto: '', email: '' });
  };

  useEffect(() => {
    const calculateStats = (linhas) => {
      const total = linhas.length;
      const comSugestao = linhas.filter(l => l.ingredienteSugerido).length;
      const altaConfianca = linhas.filter(l => l.confiancaSugestao >= 80).length;
      const mediaConfianca = linhas.filter(l => l.confiancaSugestao >= 60 && l.confiancaSugestao < 80).length;
      return {
        total, comSugestao, altaConfianca, mediaConfianca,
        semSugestao: total - comSugestao,
        percentagemAuto: total > 0 ? Math.round((altaConfianca / total) * 100) : 0
      };
    };
    setStats(calculateStats(linhasEditadas));
  }, [linhasEditadas]);

  const handleIngredienteChange = (index, ingredienteId) => {
    const novas = [...linhasEditadas];
    novas[index].ingredienteConfirmado = ingredienteId;
    setLinhasEditadas(novas);
  };

  const handleQuantidadeChange = (index, quantidade) => {
    const novas = [...linhasEditadas];
    novas[index].quantidade = parseFloat(quantidade) || null;
    setLinhasEditadas(novas);
  };

  const handleUnidadeChange = (index, unidade) => {
    const novas = [...linhasEditadas];
    novas[index].unidade = unidade;
    setLinhasEditadas(novas);
  };

  const handlePrecoChange = (index, preco) => {
    const novas = [...linhasEditadas];
    novas[index].preco = parseFloat(preco) || null;
    setLinhasEditadas(novas);
  };

  const handleLimparPalavrasLinha = (index) => {
    const linha = linhasEditadas[index];

    let nifFornecedor = metadata?.nif;
    
    if (!nifFornecedor && fornecedorManual) {
      const fornecedorObj = fornecedoresLocais.find(f => f.id === fornecedorManual);
      if (fornecedorObj && fornecedorObj.nif) {
        nifFornecedor = fornecedorObj.nif;
      }
    }
    
    if (!nifFornecedor) {
      alert('‚ö†Ô∏è NIF do fornecedor n√£o detectado. N√£o √© poss√≠vel adicionar palavras para limpar.');
      return;
    }

    setLinhaParaLimpar({ ...linha, index, nifFornecedor });
    setPalavrasSelecionadas([]);
    setSempreRemover(true);
    setMostrarModalLimparPalavras(true);
  };
  
  const confirmarLimpezaPalavras = () => {
    if (!linhaParaLimpar || palavrasSelecionadas.length === 0) {
      alert('Selecione pelo menos uma palavra para limpar!');
      return;
    }

    if (sempreRemover && window._adicionarAPalavrasLimpar) {
      palavrasSelecionadas.forEach(palavra => {
        window._adicionarAPalavrasLimpar(linhaParaLimpar.nifFornecedor, palavra);
      });
    }

    setLinhasEditadas(linhasEditadas.filter((_, i) => i !== linhaParaLimpar.index));

    setMostrarModalLimparPalavras(false);
    setLinhaParaLimpar(null);
    setPalavrasSelecionadas([]);
  };

  const handleRemoverLinha = (index) => {
    setLinhasEditadas(linhasEditadas.filter((_, i) => i !== index));
  };

  const handleBlacklistLinha = (index) => {
    const linha = linhasEditadas[index];

    let nifFornecedor = metadata?.nif;
    
    if (!nifFornecedor && fornecedorManual) {

      const fornecedorObj = fornecedoresLocais.find(f => f.id === fornecedorManual);
      if (fornecedorObj && fornecedorObj.nif) {
        nifFornecedor = fornecedorObj.nif;
      }
    }
    
    if (!nifFornecedor) {
      alert('‚ö†Ô∏è NIF do fornecedor n√£o detectado ou fornecedor n√£o tem NIF cadastrado. N√£o √© poss√≠vel adicionar √† blacklist.');
      return;
    }

    if (confirm(`üö´ Adicionar √† blacklist permanente?\n\nLinha: "${linha.textoOriginal.substring(0, 60)}..."\n\nEsta linha nunca mais aparecer√° em faturas deste fornecedor (NIF: ${nifFornecedor}).`)) {

      if (window._adicionarABlacklist) {
        window._adicionarABlacklist(nifFornecedor, linha.textoOriginal);
      }

      setLinhasEditadas(linhasEditadas.filter((_, i) => i !== index));
    }
  };

  const handleCriarIngrediente = () => {

    if (!novoIngrediente.nome || !novoIngrediente.custo) {
      alert('‚ùå Preencha nome e custo!');
      return;
    }

    const novoIng = {
      id: `ing_${Date.now()}`,
      nome: novoIngrediente.nome,
      categoria: novoIngrediente.categoria,
      unidade: novoIngrediente.unidade,
      custoUnitario: parseFloat(novoIngrediente.custo),
      precoUnitario: parseFloat(novoIngrediente.custo),
      iva: parseFloat(novoIngrediente.iva)
    };

    setIngredientesLocais([...ingredientesLocais, novoIng]);

    if (!window._novosIngredientes) window._novosIngredientes = [];
    window._novosIngredientes.push(novoIng);

    if (linhaIndexCriando !== null) {
      handleIngredienteChange(linhaIndexCriando, novoIng.id);
    }

    setMostrarModalCriarIng(false);
    setNovoIngrediente({ nome: '', categoria: 'outros', unidade: 'kg', custo: '', iva: '13' });
  };

  const handleConfirmar = () => {
    const linhasSemIngrediente = linhasEditadas.filter(
      l => !l.ingredienteConfirmado && !l.ingredienteSugerido
    );
    if (linhasSemIngrediente.length > 0) {
      if (!confirm(`${linhasSemIngrediente.length} linha(s) sem ingrediente. Continuar?`)) return;
    }

    const linhasComIngrediente = linhasEditadas.filter(l => l.ingredienteConfirmado || l.ingredienteSugerido);
    const linhasComPreco = linhasComIngrediente.filter(l => l.preco && parseFloat(l.preco) > 0);
    const linhasSemPreco = linhasComIngrediente.filter(l => !l.preco || parseFloat(l.preco) <= 0);

    if (linhasSemPreco.length > 0) {
      const ingredientesIgnorados = linhasSemPreco.map(l => {
        const ingrediente = ingredientes.find(i => i.id === (l.ingredienteConfirmado || l.ingredienteSugerido?.id));
        return ingrediente?.nome || 'Desconhecido';
      }).join(', ');
      
      const mensagem = `‚ö†Ô∏è ATEN√á√ÉO:\n\n` +
        `‚úÖ Ser√£o guardados ${linhasComPreco.length} ingrediente(s) com pre√ßo\n` +
        `‚ùå Ser√£o IGNORADOS ${linhasSemPreco.length} ingrediente(s) sem pre√ßo:\n\n` +
        `${ingredientesIgnorados}\n\n` +
        `Apenas ingredientes com pre√ßo > 0 s√£o guardados na fatura.\n\n` +
        `Continuar?`;
      
      if (!confirm(mensagem)) return;
    }
    
    const linhasFinais = linhasEditadas.map(linha => ({
      ...linha,
      ingredienteConfirmado: linha.ingredienteConfirmado || linha.ingredienteSugerido?.id
    }));

    const novosIngs = window._novosIngredientes || [];

    const numeroFinal = numeroFaturaManual || metadata?.numeroFatura || null;

    let numeroComPrefixo = numeroFinal;
    if (numeroFinal && !numeroFinal.toUpperCase().startsWith('FT')) {
      numeroComPrefixo = 'FT ' + numeroFinal;
    }
    
    const metadataCompleta = { 
      ...(metadata || {}),
      numeroFatura: numeroComPrefixo,
      tipoDocumento: numeroComPrefixo ? 'fatura' : 'recibo', // Auto-detecta tipo
      fornecedorManual: fornecedorManual, // ID do fornecedor selecionado manualmente
      novosIngredientes: novosIngs 
    };

    window._novosIngredientes = [];
    
    onConfirmar(linhasFinais, metadataCompleta);
  };

  const getConfidenceClass = (confianca) => {
    if (confianca >= 80) return 'text-green-600 bg-green-50';
    if (confianca >= 60) return 'text-yellow-600 bg-yellow-50';
    return 'text-red-600 bg-red-50';
  };

  const getConfidenceIcon = (confianca) => {
    if (confianca >= 80) return '‚úì';
    if (confianca >= 60) return '‚ö†';
    return '‚úó';
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
      <div className="bg-white rounded-lg shadow-xl max-w-[95vw] w-full max-h-[95vh] flex flex-col">
        <div className="p-4 border-b flex-shrink-0">
          <h2 className="text-xl font-bold mb-2">üìÑ Confirmar Produtos Extra√≠dos</h2>
          
          {/* Info do Documento - COMPACTO */}
          <div className="mb-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded">
            <div className="grid grid-cols-3 gap-3 text-sm">
              {/* N√∫mero Fatura */}
              <div>
                <label className="text-xs font-semibold text-gray-600 block mb-1">üìã N√∫mero</label>
                {metadata?.numeroFatura ? (
                  <div className="px-2 py-1 bg-white border border-green-300 rounded font-bold text-green-700 text-sm">
                    {metadata.numeroFatura}
                  </div>
                ) : (
                  <div className="flex items-center gap-1">
                    <span className="px-2 py-1 bg-gray-100 border rounded text-sm font-semibold text-gray-600">FT</span>
                    <input
                      type="text"
                      value={numeroFaturaManual}
                      onChange={(e) => setNumeroFaturaManual(e.target.value)}
                      placeholder="2025/156"
                      className="flex-1 px-2 py-1 border rounded text-sm"
                    />
                  </div>
                )}
              </div>
              
              {/* Fornecedor */}
              <div>
                <label className="text-xs font-semibold text-gray-600 block mb-1">üè¢ Fornecedor</label>
                {(() => {
                  const fornecedorDetectado = metadata?.nif 
                    ? fornecedores.find(f => f.nif === metadata.nif)
                    : null;
                  
                  if (fornecedorDetectado) {
                    return (
                      <div className="px-2 py-1 bg-white border border-blue-300 rounded text-sm">
                        <span className="font-bold text-blue-700">{fornecedorDetectado.nome}</span>
                      </div>
                    );
                  } else {
                    return (
                      <select
                        value={fornecedorManual}
                        onChange={(e) => {
                          if (e.target.value === 'novo') {
                            setMostrarModalNovoFornecedor(true);
                          } else {
                            setFornecedorManual(e.target.value);
                          }
                        }}
                        className="w-full px-2 py-1 border rounded text-sm"
                      >
                        <option value="">Escolher...</option>
                        {fornecedoresLocais.map(f => (
                          <option key={f.id} value={f.id}>
                            {f.nome}
                          </option>
                        ))}
                        <option value="novo" className="font-bold">‚ûï Criar Novo</option>
                      </select>
                    );
                  }
                })()}
              </div>
              
              {/* Badge Tipo */}
              <div className="flex items-end">
                <span className={`px-3 py-1 rounded text-xs font-bold ${
                  metadata?.numeroFatura || numeroFaturaManual
                    ? 'bg-green-100 text-green-700' 
                    : 'bg-gray-100 text-gray-700'
                }`}>
                  {metadata?.numeroFatura || numeroFaturaManual ? 'üßæ FATURA' : 'üìù RECIBO'}
                </span>
              </div>
            </div>
          </div>
          
          {/* Stats de Aprendizagem - MELHORADO */}
          {stats && (
            <div className="mb-2">
              <div className="flex gap-2 text-xs mb-2">
                <div className="bg-blue-100 border border-blue-300 px-3 py-1.5 rounded font-semibold text-blue-900">
                  üì¶ <strong>{stats.total}</strong> produtos
                </div>
                <div className="bg-green-100 border border-green-300 px-3 py-1.5 rounded font-semibold text-green-900">
                  ‚úì <strong>{stats.altaConfianca}</strong> auto-preenchidos
                </div>
                <div className="bg-yellow-100 border border-yellow-300 px-3 py-1.5 rounded font-semibold text-yellow-900">
                  ‚ö† <strong>{stats.mediaConfianca}</strong> para verificar
                </div>
                <div className="bg-gray-100 border border-gray-300 px-3 py-1.5 rounded font-semibold text-gray-700">
                  ‚ùì <strong>{stats.semSugestao}</strong> manual
                </div>
              </div>
              
              {/* Barra de progresso removida - n√£o √© necess√°ria */}
            </div>
          )}
        </div>
        <div className="flex-1 overflow-auto p-6">
          
          <table className="w-full border-collapse">
            <thead className="sticky top-0 bg-gray-100">
              <tr>
                <th className="border p-2 text-left text-sm font-semibold">Texto PDF</th>
                {/* üÜï S√≥ mostrar colunas de Ingrediente se categoria = compras */}
                {metadata?.categoria === 'compras' && (
                  <>
                    <th className="border p-2 text-left text-sm font-semibold">Ingrediente</th>
                    <th className="border p-2 text-center text-sm font-semibold w-20">Conf.</th>
                  </>
                )}
                <th className="border p-2 text-center text-sm font-semibold w-24">Qtd</th>
                <th className="border p-2 text-center text-sm font-semibold w-20">Un</th>
                <th className="border p-2 text-center text-sm font-semibold w-24">Pre√ßo</th>
                <th className="border p-2 text-center text-sm font-semibold w-16">A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              {linhasEditadas.map((linha, index) => {
                const ingredienteSugerido = linha.ingredienteSugerido || null;
                const confianca = linha.confiancaSugestao || 0;
                const historico = linha.historicoSugestao;
                
                return (
                  <tr key={index} className="hover:bg-gray-50">
                    <td className="border p-2 text-sm">
                      <div className="font-mono text-xs text-gray-600 mb-1">{linha.textoOriginal}</div>
                      <div className="text-sm font-semibold">{linha.nomeProduto}</div>
                    </td>
                    
                    {/* üÜï S√≥ mostrar colunas de ingrediente se categoria = compras */}
                    {metadata?.categoria === 'compras' && (
                      <>
                        <td className="border p-2">
                          <div className="flex gap-1">
                            {/* Search + Dropdown de ingredientes */}
                            <div className="flex-1 relative">
                              <div className="relative">
                                <input
                                  type="text"
                                  value={searchIngredienteOCR[linha._id] || ''}
                                  onChange={(e) => {
                                    const valor = e.target.value;
                                    setSearchIngredienteOCR({...searchIngredienteOCR, [linha._id]: valor});
                                    setShowDropdownOCR({...showDropdownOCR, [index]: valor.length >= 2});
                                  }}
                                  onFocus={() => {
                                    if ((searchIngredienteOCR[linha._id] || '').length >= 2) {
                                      setShowDropdownOCR({...showDropdownOCR, [index]: true});
                                    }
                                  }}
                                  onBlur={() => {

                                    setTimeout(() => {
                                      setShowDropdownOCR({...showDropdownOCR, [index]: false});
                                    }, 200);
                                  }}
                                  placeholder="Digite para buscar..."
                                  className={`w-full px-2 py-1 text-sm border-2 rounded ${
                                    confianca >= 80 ? 'border-green-400 bg-green-50' :
                                    confianca >= 60 ? 'border-yellow-400 bg-yellow-50' :
                                    confianca > 0 ? 'border-orange-300 bg-orange-50' :
                                    'border-gray-300'
                                  }`}
                                />
                                {/* Badge de confian√ßa */}
                                {confianca > 0 && (
                                  <div className="relative group">
                                    <div className={`absolute -top-2 -right-2 px-1.5 py-0.5 rounded-full text-xs font-bold cursor-help ${
                                      confianca >= 80 ? 'bg-green-500 text-white' :
                                      confianca >= 60 ? 'bg-yellow-500 text-white' :
                                      'bg-orange-500 text-white'
                                    }`}>
                                      {confianca}%
                                    </div>
                                    
                                    {/* üÜï Tooltip com breakdown da confian√ßa */}
                                    {historico && (
                                      <div className="absolute right-0 top-6 mt-1 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 w-64">
                                        <div className="font-semibold mb-2 border-b border-gray-600 pb-1">
                                          {confianca >= 80 ? '‚úÖ Auto-Insert Ativo' : 'üìä Progresso de Aprendizagem'}
                                        </div>
                                        
                                        <div className="space-y-1 mb-2">
                                          <div className="flex justify-between">
                                            <span className="text-gray-400">Confirma√ß√µes:</span>
                                            <span className="font-bold text-green-300">{historico.confirmacoes || 0}</span>
                                          </div>
                                          {historico.correcoes > 0 && (
                                            <div className="flex justify-between">
                                              <span className="text-gray-400">Corre√ß√µes:</span>
                                              <span className="font-bold text-red-300">{historico.correcoes}</span>
                                            </div>
                                          )}
                                          <div className="flex justify-between">
                                            <span className="text-gray-400">Similaridade:</span>
                                            <span className="font-bold">{linha.similaridadeSugestao || 0}%</span>
                                          </div>
                                        </div>
                                        
                                        {confianca < 80 ? (
                                          <div className="border-t border-gray-600 pt-2 mt-2">
                                            <div className="text-yellow-300 font-semibold mb-1">
                                              ‚ö° Para atingir 80%:
                                            </div>
                                            <div className="text-xs">
                                              {historico.confirmacoes === 0 ? (
                                                '‚Ä¢ Confirme este ingrediente 2x'
                                              ) : historico.confirmacoes === 1 ? (
                                                '‚Ä¢ Confirme mais 1x (total: 2)'
                                              ) : (
                                                '‚Ä¢ Melhore a similaridade do texto'
                                              )}
                                            </div>
                                            {(historico.confirmacoes || 0) < 2 && (
                                              <div className="mt-2 bg-blue-900 rounded p-1.5">
                                                <div className="text-xs">
                                                  Pr√≥xima confirma√ß√£o ‚Üí <strong className="text-green-300">{historico.confirmacoes === 0 ? '76.5%' : '85.5%'}</strong>
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        ) : (
                                          <div className="border-t border-green-600 pt-2 mt-2 text-green-300">
                                            ‚úÖ Ingrediente ser√° inserido automaticamente!
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                              
                              {/* Dropdown de sugest√µes */}
                              {showDropdownOCR[index] && (
                                (() => {
                                  const search = normalizeText(searchIngredienteOCR[linha._id] || '');
                                  const sugestoes = ingredientesLocais
                                    .filter(ing => normalizeText(ing.nome).includes(search))
                                    .slice(0, 10);
                                  
                                  if (sugestoes.length === 0) return null;
                                  
                                  return (
                                    <div className="absolute top-full left-0 right-0 bg-white border shadow-lg z-50 max-h-60 overflow-y-auto mt-1 rounded">
                                      {sugestoes.map(ing => (
                                        <div
                                          key={ing.id}
                                          onMouseDown={(e) => {
                                            e.preventDefault();
                                            handleIngredienteChange(index, ing.id);
                                            setSearchIngredienteOCR({...searchIngredienteOCR, [linha._id]: ing.nome});
                                            setShowDropdownOCR({...showDropdownOCR, [index]: false});
                                          }}
                                          className="p-2 hover:bg-blue-50 cursor-pointer border-b"
                                        >
                                          <div className="font-semibold text-sm">{ing.nome}</div>
                                          <div className="text-xs text-gray-600">
                                            ‚Ç¨{ing.custoUnitario.toFixed(2)}/{ing.unidade} ¬∑ {ing.categoria}
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  );
                                })()
                              )}
                              
                              {/* Mostrar ingrediente selecionado */}
                              {linha.ingredienteConfirmado && !searchIngredienteOCR[linha._id] && (
                                (() => {
                                  const ingSelecionado = ingredientesLocais.find(i => i.id === linha.ingredienteConfirmado);
                                  if (ingSelecionado) {
                                    return (
                                      <div className="mt-1 text-xs text-blue-600 font-semibold">
                                        ‚úì {ingSelecionado.nome}
                                      </div>
                                    );
                                  }
                                  return null;
                                })()
                              )}
                            </div>
                            
                            <button
                              onClick={() => {
                                setNovoIngrediente({
                                  nome: linha.nomeProduto || '',
                                  categoria: 'outros',
                                  unidade: linha.unidade || 'kg',
                                  custo: linha.preco ? linha.preco.toString() : '',
                                  iva: linha.iva ? linha.iva.toString() : (metadata?.iva ? metadata.iva.toString() : '13')
                                });
                                setLinhaIndexCriando(index);
                                setMostrarModalCriarIng(true);
                              }}
                              className="ml-1 px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                              title="Criar novo ingrediente"
                            >
                              +
                            </button>
                          </div>

                        </td>
                        <td className={`border p-2 text-center ${getConfidenceClass(confianca)}`}>
                          <div className="text-sm font-bold">{linha.ingredienteSugerido ? `${confianca}%` : '--'}</div>
                          <div className="text-xs">{getConfidenceIcon(confianca)}</div>
                        </td>
                      </>
                    )}
                    <td className="border p-2">
                      <input
                        type="number"
                        step="0.01"
                        value={linha.quantidade || ''}
                        onChange={(e) => handleQuantidadeChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded text-center"
                        placeholder="--"
                      />
                    </td>
                    <td className="border p-2">
                      <select
                        value={linha.unidade || ''}
                        onChange={(e) => handleUnidadeChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded"
                      >
                        <option value="">--</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="l">l</option>
                        <option value="ml">ml</option>
                        <option value="un">un</option>
                      </select>
                    </td>
                    <td className="border p-2">
                      <input
                        type="number"
                        step="0.01"
                        value={linha.preco || ''}
                        onChange={(e) => handlePrecoChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded text-right"
                        placeholder="--"
                      />

                      {/* ‚ú® PREVIEW DO PRE√áO UNIT√ÅRIO CALCULADO */}
                      {linha.preco && linha.quantidade && linha.ingredienteConfirmado && (() => {
                        const ing = ingredientesLocais.find(i => i.id === linha.ingredienteConfirmado);
                        if (!ing) return null;
                        
                        const precoTotal = parseFloat(linha.preco);
                        const quantidade = parseFloat(linha.quantidade);
                        const unidadeCompra = linha.unidade || ing.unidade;
                        const unidadeBase = ing.unidade;

                        let quantidadeBase = quantidade;
                        if (unidadeCompra === 'g' && unidadeBase === 'kg') {
                          quantidadeBase = quantidade / 1000;
                        } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
                          quantidadeBase = quantidade / 1000;
                        } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
                          quantidadeBase = quantidade * 1000;
                        } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
                          quantidadeBase = quantidade * 1000;
                        }
                        
                        const precoUnitario = precoTotal / quantidadeBase;
                        
                        return (
                          <div className="text-xs mt-1 text-green-600 font-semibold">
                            = ‚Ç¨{precoUnitario.toFixed(2)}/{unidadeBase}
                          </div>
                        );
                      })()}
                    </td>
                    <td className="border p-2 text-center">
                      <button
                        onClick={() => handleLimparPalavrasLinha(index)}
                        className="text-blue-600 hover:text-blue-800 text-sm mr-1"
                        title="Limpar palavras (remove do nome)"
                      >
                        üßπ
                      </button>
                      <button
                        onClick={() => handleBlacklistLinha(index)}
                        className="text-gray-700 hover:text-black text-sm"
                        title="Blacklist (bloqueia linha inteira)"
                      >
                        üö´
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {linhasEditadas.length === 0 && (
            <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
              <p className="text-gray-600 mb-3">‚ö†Ô∏è Nenhum produto detectado no OCR</p>
              <p className="text-sm text-gray-500 mb-4">Adicione produtos manualmente clicando no bot√£o abaixo</p>
              <button
                onClick={() => {
                  const novaLinha = {
                    nomeProduto: '',
                    quantidade: '',
                    preco: '',
                    ingredienteConfirmado: null
                  };
                  setLinhasEditadas([novaLinha]);
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ûï Adicionar Primeira Linha
              </button>
            </div>
          )}
        </div>
        <div className="p-6 border-t bg-gray-50">
          <div className="flex justify-end items-center">
            <div className="flex gap-3">
            <button
              onClick={onCancelar}
              className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold"
            >
              Cancelar
            </button>
            <button
              onClick={handleConfirmar}
              disabled={linhasEditadas.length === 0}
              className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-semibold"
            >
              Confirmar {linhasEditadas.length > 0 && `(${linhasEditadas.length})`}
            </button>
          </div>
          </div>
        </div>
      </div>

      {/* Modal Criar Ingrediente */}
      {mostrarModalCriarIng && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 my-8">
            <h3 className="text-xl font-bold mb-4 text-gray-800">‚ú® Criar Novo Ingrediente</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoIngrediente.nome}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, nome: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: Tomate Cherry"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Categoria *</label>
                <select
                  value={novoIngrediente.categoria}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, categoria: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="vegetais">ü•¨ Vegetais</option>
                  <option value="frutas">üçé Frutas</option>
                  <option value="carnes">ü•© Carnes</option>
                  <option value="peixe">üêü Peixe/Marisco</option>
                  <option value="latic√≠nios">ü•õ Latic√≠nios</option>
                  <option value="√≥leos">ü´í √ìleos/Gorduras</option>
                  <option value="cereais">üåæ Cereais/Massas</option>
                  <option value="especiarias">üå∂Ô∏è Especiarias</option>
                  <option value="bebidas">üç∫ Bebidas</option>
                  <option value="embalagens">üì¶ Embalagens</option>
                  <option value="consumiveis">üß¥ Consum√≠veis</option>
                  <option value="limpeza">üßπ Limpeza</option>
                  <option value="operacionais">üîß Operacionais</option>
                  <option value="compotas">üçØ Compotas/Doces</option>
                  <option value="outros">üìã Outros</option>
                </select>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Unidade *</label>
                  <select
                    value={novoIngrediente.unidade}
                    onChange={(e) => setNovoIngrediente({...novoIngrediente, unidade: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="l">l</option>
                    <option value="ml">ml</option>
                    <option value="un">un</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Custo (‚Ç¨) *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={novoIngrediente.custo}
                    onChange={(e) => setNovoIngrediente({...novoIngrediente, custo: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">IVA (%) *</label>
                <select
                  value={novoIngrediente.iva}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, iva: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="6">6% (Essencial)</option>
                  <option value="13">13% (Reduzido)</option>
                  <option value="23">23% (Normal)</option>
                </select>
              </div>
            </div>
            
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => {
                  setMostrarModalCriarIng(false);
                  setNovoIngrediente({ nome: '', categoria: 'outros', unidade: 'kg', custo: '', iva: '13' });
                }}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold text-gray-700"
              >
                Cancelar
              </button>
              <button
                onClick={handleCriarIngrediente}
                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
              >
                ‚ú® Criar Ingrediente
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Modal Criar Fornecedor */}
      {mostrarModalNovoFornecedor && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
            <h3 className="text-xl font-bold mb-4">‚ûï Criar Novo Fornecedor</h3>
            
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-semibold mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoFornecedor.nome}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nome: e.target.value})}
                  placeholder="Ex: Pingo Doce"
                  className="w-full px-3 py-2 border rounded"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">NIF</label>
                <input
                  type="text"
                  value={novoFornecedor.nif}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nif: e.target.value})}
                  placeholder="9 d√≠gitos"
                  maxLength="9"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Contacto</label>
                <input
                  type="text"
                  value={novoFornecedor.contacto}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, contacto: e.target.value})}
                  placeholder="Telefone"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Email</label>
                <input
                  type="email"
                  value={novoFornecedor.email}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, email: e.target.value})}
                  placeholder="email@exemplo.com"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            
            <div className="flex gap-2 mt-6">
              <button
                onClick={() => {
                  setMostrarModalNovoFornecedor(false);
                  setNovoFornecedor({ nome: '', nif: metadata.nif || '', contacto: '', email: '' });
                }}
                className="flex-1 px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              >
                Cancelar
              </button>
              <button
                onClick={criarNovoFornecedor}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ú® Criar
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üßπ Modal Limpar Palavras */}
      {mostrarModalLimparPalavras && linhaParaLimpar && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex items-center justify-between sticky top-0">
              <h3 className="text-xl font-bold text-white">üßπ Limpar Palavras do Nome</h3>
              <button onClick={() => { setMostrarModalLimparPalavras(false); setLinhaParaLimpar(null); setPalavrasSelecionadas([]); }} className="text-white hover:bg-white/20 rounded-full p-2 transition">‚úï</button>
            </div>
            <div className="p-6 space-y-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Texto Original:</label>
                <div className="bg-gray-100 border border-gray-300 rounded-lg p-3">
                  <p className="font-mono text-sm text-gray-800">{linhaParaLimpar.textoOriginal}</p>
                </div>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">Selecione as palavras a remover:</label>
                <div className="grid grid-cols-2 gap-2">
                  {linhaParaLimpar.textoOriginal.split(/\s+/).filter(p => p.length > 1).map((palavra, idx) => {
                    const isSelected = palavrasSelecionadas.includes(palavra);
                    return (<button key={idx} onClick={() => { if (isSelected) { setPalavrasSelecionadas(palavrasSelecionadas.filter(p => p !== palavra)); } else { setPalavrasSelecionadas([...palavrasSelecionadas, palavra]); } }} className={`px-4 py-2 rounded-lg border-2 font-mono text-sm transition ${isSelected ? 'bg-blue-100 border-blue-500 text-blue-900 font-semibold' : 'bg-white border-gray-300 text-gray-700 hover:border-blue-300'}`}>{isSelected && '‚úì '}{palavra}</button>);
                  })}
                </div>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Resultado (preview):</label>
                <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                  <p className="font-mono text-sm text-green-900 font-semibold">{(() => { let resultado = linhaParaLimpar.textoOriginal; palavrasSelecionadas.forEach(palavra => { const regex = new RegExp(`\\b${palavra}\\b`, 'gi'); resultado = resultado.replace(regex, '').replace(/\s+/g, ' ').trim(); }); return resultado || '(vazio)'; })()}</p>
                </div>
                {palavrasSelecionadas.length > 0 && (<p className="text-xs text-gray-500 mt-2">Palavras removidas: <span className="font-semibold text-blue-600">{palavrasSelecionadas.join(', ')}</span></p>)}
              </div>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <label className="flex items-start gap-3 cursor-pointer">
                  <input type="checkbox" checked={sempreRemover} onChange={(e) => setSempreRemover(e.target.checked)} className="w-5 h-5 rounded text-blue-600 focus:ring-2 focus:ring-blue-500 mt-0.5" />
                  <div>
                    <p className="font-semibold text-sm text-gray-800">‚úÖ Sempre remover estas palavras deste fornecedor</p>
                    <p className="text-xs text-gray-600 mt-1">As palavras selecionadas ser√£o automaticamente removidas em futuras faturas deste fornecedor (NIF: {linhaParaLimpar.nifFornecedor})</p>
                  </div>
                </label>
              </div>
            </div>
            <div className="border-t border-gray-200 px-6 py-4 flex gap-3 justify-end bg-gray-50 sticky bottom-0">
              <button onClick={() => { setMostrarModalLimparPalavras(false); setLinhaParaLimpar(null); setPalavrasSelecionadas([]); }} className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold text-gray-700 transition">Cancelar</button>
              <button onClick={confirmarLimpezaPalavras} disabled={palavrasSelecionadas.length === 0} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition flex items-center gap-2">üßπ Limpar {palavrasSelecionadas.length > 0 && `(${palavrasSelecionadas.length})`}</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * üÜï MODAL SIMPLES PARA DESPESAS FIXAS (renda, luz, √°gua, etc)
 * S√≥ pede pre√ßo e IVA, sem ingredientes
 */
const ModalDespesaSimples = ({ dadosDespesa, onConfirmar, onCancelar }) => {
  const { categoria, fornecedor, valorDetectado, metadata } = dadosDespesa;
  
  const [precoTotal, setPrecoTotal] = React.useState(() => {

    return valorDetectado ? parseFloat(valorDetectado).toFixed(2) : '';
  });
  const [ivaPercentagem, setIvaPercentagem] = React.useState(() => {

    if (categoria === 'salarios') return '0';
    if (categoria === 'agua') return '6';
    return '23'; // Padr√£o para renda, eletricidade, gas, internet, etc
  });

  const labelsCategorias = {
    'compras': 'üõí Compras',
    'compras_alimentares': 'üçΩÔ∏è Compras Alimentares',
    'materiais_operacionais': 'üßπ Materiais Operacionais',
    'embalagens_consumiveis': 'üì¶ Embalagens/Consum√≠veis',
    'renda': 'üè† Renda',
    'eletricidade': '‚ö° Eletricidade',
    'agua': 'üíß √Ågua',
    'gas': 'üî• G√°s',
    'internet': 'üåê Internet',
    'salarios': 'üë• Sal√°rios',
    'marketing': 'üì¢ Marketing',
    'consumiveis': 'üì¶ Consum√≠veis',
    'manutencao': 'üîß Manuten√ß√£o',
    'outros': 'üìã Outros'
  };
  
  const handleConfirmar = () => {
    const precoFinal = parseFloat(precoTotal);
    const iva = parseFloat(ivaPercentagem);
    
    if (!precoFinal || precoFinal <= 0) {
      alert('Por favor, insira um pre√ßo v√°lido');
      return;
    }
    
    onConfirmar({
      precoTotal: precoFinal,
      iva: iva,
      categoria: categoria,
      fornecedor: fornecedor,
      metadata: metadata
    });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
      <div className="bg-white rounded-lg shadow-2xl max-w-md w-full">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-lg">
          <h2 className="text-xl font-bold flex items-center gap-2">
            {labelsCategorias[categoria] || 'üìã Despesa'}
          </h2>
          <p className="text-blue-100 text-sm mt-1">Confirme os valores da despesa</p>
        </div>
        
        {/* Body */}
        <div className="p-6 space-y-4">
          {/* Fornecedor */}
          <div className="bg-gray-50 p-3 rounded border">
            <label className="text-xs font-semibold text-gray-600 block mb-1">
              üè¢ Fornecedor
            </label>
            <p className="font-bold text-gray-800">
              {fornecedor?.nome || 'N√£o especificado'}
            </p>
            {fornecedor?.nif && (
              <p className="text-xs text-gray-500">NIF: {fornecedor.nif}</p>
            )}
          </div>
          
          {/* Pre√ßo Total */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üí∞ Pre√ßo Total (com IVA)
            </label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">
                ‚Ç¨
              </span>
              <input
                type="number"
                step="0.01"
                value={precoTotal}
                onChange={(e) => setPrecoTotal(e.target.value)}
                className="w-full pl-8 pr-3 py-3 border-2 border-gray-300 rounded-lg text-lg font-bold focus:border-blue-500 focus:outline-none"
                placeholder="0.00"
                autoFocus
              />
            </div>
            {valorDetectado && (
              <p className="text-xs text-blue-600 mt-1">
                üí° Valor detectado pelo OCR: ‚Ç¨{parseFloat(valorDetectado).toFixed(2)}
              </p>
            )}
          </div>
          
          {/* IVA */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üìä Taxa de IVA
            </label>
            <select
              value={ivaPercentagem}
              onChange={(e) => setIvaPercentagem(e.target.value)}
              className="w-full px-3 py-3 border-2 border-gray-300 rounded-lg font-semibold focus:border-blue-500 focus:outline-none"
            >
              <option value="0">0% (Isento)</option>
              <option value="6">6% (Taxa reduzida)</option>
              <option value="13">13% (Taxa interm√©dia)</option>
              <option value="23">23% (Taxa normal)</option>
            </select>
            <p className="text-xs text-gray-500 mt-1">
              {categoria === 'salarios' && 'üí° Sal√°rios normalmente isentos de IVA'}
              {categoria === 'agua' && 'üí° √Ågua normalmente tem IVA de 6%'}
              {categoria === 'renda' && 'üí° Renda normalmente tem IVA de 23%'}
            </p>
          </div>
          
          {/* Preview c√°lculo */}
          {precoTotal && (
            <div className="bg-blue-50 p-3 rounded border border-blue-200">
              <div className="flex justify-between text-sm">
                <span className="text-gray-700">Base tribut√°vel:</span>
                <span className="font-semibold">
                  ‚Ç¨{(parseFloat(precoTotal) / (1 + parseFloat(ivaPercentagem) / 100)).toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-700">IVA ({ivaPercentagem}%):</span>
                <span className="font-semibold">
                  ‚Ç¨{(parseFloat(precoTotal) - (parseFloat(precoTotal) / (1 + parseFloat(ivaPercentagem) / 100))).toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between text-sm font-bold text-blue-700 mt-2 pt-2 border-t border-blue-300">
                <span>Total com IVA:</span>
                <span>‚Ç¨{parseFloat(precoTotal).toFixed(2)}</span>
              </div>
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className="bg-gray-50 px-6 py-4 rounded-b-lg flex gap-3">
          <button
            onClick={onCancelar}
            className="flex-1 px-4 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold transition"
          >
            Cancelar
          </button>
          <button
            onClick={handleConfirmar}
            className="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 font-semibold transition shadow-lg"
          >
            ‚úÖ Confirmar e Guardar
          </button>
        </div>
      </div>
    </div>
  );
};

/**
 * Modal para confirmar tipo de fatura detectado
 */
const ModalConfirmacaoFatura = ({ dadosFatura, onConfirmar, onCancelar, fornecedores = [], showNotification, setFornecedores }) => {
  const [tipoSelecionado, setTipoSelecionado] = React.useState(dadosFatura.tipo);
  const [categoriaSelecionada, setCategoriaSelecionada] = React.useState(dadosFatura.categoria || 'compras'); // üÜï CATEGORIA
  const [dataCorrigida, setDataCorrigida] = React.useState(dadosFatura.data || '');
  const [temNifCliente, setTemNifCliente] = React.useState(dadosFatura.temNifCliente || false); // üÜï NIF CLIENTE
  const [mostrarModalNovoFornecedor, setMostrarModalNovoFornecedor] = React.useState(false);
  const [fornecedoresLocais, setFornecedoresLocais] = React.useState(fornecedores);
  const [novoFornecedor, setNovoFornecedor] = React.useState({
    nome: '',
    nif: dadosFatura.fornecedor?.nif || '',
    contacto: '',
    email: ''
  });

  const criarNovoFornecedor = () => {
    if (!novoFornecedor.nome.trim()) {
      alert('Nome √© obrigat√≥rio!');
      return;
    }

    const novoFornTemp = {
      id: Date.now(),
      nome: novoFornecedor.nome.trim(),
      nif: novoFornecedor.nif.trim(),
      telefone: novoFornecedor.contacto.trim(),
      email: novoFornecedor.email.trim(),
      morada: '',
      dataCriacao: new Date().toISOString()
    };

    if (setFornecedores && typeof setFornecedores === 'function') {
      setFornecedores(prev => [...prev, novoFornTemp]);
    }

    setFornecedoresLocais(prev => [...prev, novoFornTemp]);

    if (!window._novosFornecedores) window._novosFornecedores = [];
    window._novosFornecedores.push(novoFornTemp);

    setFornecedorSelecionado(novoFornTemp);

    if (showNotification && typeof showNotification === 'function') {
      showNotification('‚úÖ Fornecedor criado com sucesso!', 'success');
    }

    setMostrarModalNovoFornecedor(false);
    setNovoFornecedor({ nome: '', nif: dadosFatura.fornecedor?.nif || '', contacto: '', email: '' });
  };

  const [fornecedorSelecionado, setFornecedorSelecionado] = React.useState(() => {

    if (dadosFatura.fornecedor?.nif) {

      const porNif = fornecedores.find(f => f.nif === dadosFatura.fornecedor.nif);
      if (porNif) {

        return porNif;
      }
    }

    if (dadosFatura.fornecedor?.nome) {
      const nomeDetectado = dadosFatura.fornecedor.nome.toLowerCase().trim();

      const porNome = fornecedores.find(f => {
        if (!f.nome) return false;
        const nomeCadastrado = f.nome.toLowerCase().trim();

        if (nomeDetectado === nomeCadastrado) {

          return true;
        }

        const minChars = Math.min(nomeDetectado.length, nomeCadastrado.length) * 0.5;
        if ((nomeCadastrado.includes(nomeDetectado) || nomeDetectado.includes(nomeCadastrado)) && 
            (nomeDetectado.length >= minChars || nomeCadastrado.length >= minChars)) {

          return true;
        }

        const palavrasDetectadas = nomeDetectado.split(/\s+/).filter(p => p.length >= 4);
        const palavrasCadastradas = nomeCadastrado.split(/\s+/).filter(p => p.length >= 4);

        let palavrasEmComum = 0;
        let temPalavraEspecifica = false;
        
        for (const pd of palavrasDetectadas) {
          for (const pc of palavrasCadastradas) {

            if (pd === pc) {
              palavrasEmComum++;
              if (pd.length >= 8) temPalavraEspecifica = true;
            }

            else if (pd.length >= 5 && pc.length >= 5 && (pc.includes(pd) || pd.includes(pc))) {
              palavrasEmComum += 0.5; // Conta como meio match
              if (pd.length >= 8 || pc.length >= 8) temPalavraEspecifica = true;
            }
          }
        }

        const temMatch = palavrasEmComum >= 2 || (palavrasEmComum >= 1 && temPalavraEspecifica);
        
        if (temMatch) {

        }
        
        return temMatch;
      });
      
      if (porNome) {

        return porNome;
      }
    }

    return null;
  });
  
  const [numeroFatura, setNumeroFatura] = React.useState(dadosFatura.numero || '');
  
  const handleConfirmar = () => {
    onConfirmar({
      ...dadosFatura,
      tipo: tipoSelecionado,
      categoria: categoriaSelecionada, // üÜï PASSAR CATEGORIA
      numero: numeroFatura || dadosFatura.numero,
      data: dataCorrigida || dadosFatura.data, // üÜï PASSAR DATA CORRIGIDA
      temNifCliente: temNifCliente, // üÜï PASSAR NIF CLIENTE do state
      fornecedor: fornecedorSelecionado ? {
        nome: fornecedorSelecionado.nome,
        nif: fornecedorSelecionado.nif,
        id: fornecedorSelecionado.id
      } : dadosFatura.fornecedor
    });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
      <div className="bg-white rounded-lg p-6 max-w-4xl w-full shadow-xl max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold">Confirmar Tipo de Fatura</h3>
          {dadosFatura.pdfUrl && (
            <button
              onClick={() => window.open(dadosFatura.pdfUrl, '_blank')}
              className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
              title="Visualizar PDF original"
            >
              <FileText className="w-4 h-4" />
              Ver PDF
            </button>
          )}
        </div>
        
        {/* Layout em 2 colunas */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          {/* COLUNA ESQUERDA: Info detectada */}
          <div>
            <div className="mb-4 p-4 bg-blue-50 rounded-lg">
              <h4 className="font-semibold mb-2">Dados Detectados:</h4>
              <p className="text-sm text-gray-700">
                <strong>Tipo:</strong> {INVOICE_TYPES[dadosFatura.tipo]?.label || dadosFatura.tipo}
              </p>
              {dadosFatura.numero !== 'N/A' && (
                <p className="text-sm text-gray-700 mt-1">
                  <strong>N√∫mero:</strong> {dadosFatura.numero}
                </p>
              )}
              <p className="text-sm text-gray-700 mt-1">
                <strong>Fornecedor:</strong> {dadosFatura.fornecedor.nome}
              </p>
              {dadosFatura.fornecedor.nif && (
                <p className="text-sm text-gray-700 mt-1">
                  <strong>NIF:</strong> {dadosFatura.fornecedor.nif}
                </p>
              )}
              <p className="text-sm text-gray-700 mt-1">
                <strong>Data:</strong> {dadosFatura.data}
              </p>
              {dadosFatura.totais.total > 0 && (
                <p className="text-sm text-gray-700 mt-1">
                  <strong>Total:</strong> {dadosFatura.totais.total.toFixed(2)}‚Ç¨
                </p>
              )}
            </div>
            
            {/* Dropdown Fornecedor */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                Selecionar Fornecedor:
                {(!fornecedorSelecionado || fornecedorSelecionado.nome === 'Desconhecido' || dadosFatura.fornecedor.nome === 'Desconhecido') && (
                  <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-bold">
                    ‚ö†Ô∏è N√ÉO DETETADO
                  </span>
                )}
              </label>
              <select
                value={fornecedorSelecionado?.id || ''}
                onChange={(e) => {
                  const idSelecionado = e.target.value;

                  if (idSelecionado === 'novo') {
                    setMostrarModalNovoFornecedor(true);
                  } else {

                    const forn = fornecedoresLocais.find(f => String(f.id) === String(idSelecionado));

                    setFornecedorSelecionado(forn || null);
                  }
                }}
                className={`w-full p-2 border-2 rounded-lg transition-colors ${
                  !fornecedorSelecionado || fornecedorSelecionado.nome === 'Desconhecido' || dadosFatura.fornecedor.nome === 'Desconhecido'
                    ? 'bg-red-50 border-red-400 text-red-900 font-semibold'
                    : 'border-gray-300'
                }`}
              >
                <option value="">Desconhecido</option>
                {fornecedoresLocais.map(f => (
                  <option key={f.id} value={f.id}>
                    {f.nome} {f.nif ? `(NIF: ${f.nif})` : ''}
                  </option>
                ))}
                <option value="novo" className="font-bold">‚ûï Criar Novo</option>
              </select>
            </div>
            
            {/* üÜï Data e Categoria lado a lado */}
            <div className="grid grid-cols-2 gap-4 mb-4">
              {/* Campo Data */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                  Data da Fatura:
                  {(!dadosFatura.data || dadosFatura.data === 'N/A' || dadosFatura.data === '') && (
                    <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-bold">
                      ‚ö†Ô∏è N√ÉO DETETADA
                    </span>
                  )}
                </label>
                <input
                  type="date"
                  value={dataCorrigida}
                  onChange={(e) => setDataCorrigida(e.target.value)}
                  className={`w-full p-2 border-2 rounded-lg transition-colors ${
                    !dadosFatura.data || dadosFatura.data === 'N/A' || dadosFatura.data === ''
                      ? 'bg-red-50 border-red-400'
                      : 'border-gray-300'
                  }`}
                />
                <p className="text-xs text-gray-500 mt-1">
                  üí° Detectada: {dadosFatura.data}
                </p>
              </div>
              
              {/* üÜï Sele√ß√£o de Categoria */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  üìÇ Categoria da Despesa:
                </label>
                <select
                  value={categoriaSelecionada}
                  onChange={(e) => setCategoriaSelecionada(e.target.value)}
                  className="w-full p-2 border rounded-lg"
                >
                  <option value="compras">üõí Compras</option>
                  <option value="renda">üè† Renda</option>
                  <option value="eletricidade">üí° Eletricidade</option>
                  <option value="agua">üíß √Ågua</option>
                  <option value="gas">üî• G√°s</option>
                  <option value="internet">üåê Internet/Telefone</option>
                  <option value="salarios">üë• Sal√°rios</option>
                  <option value="marketing">üì¢ Marketing</option>
                  <option value="consumiveis">üßª Consum√≠veis</option>
                  <option value="manutencao">üîß Manuten√ß√£o</option>
                  <option value="outros">üì¶ Outros</option>
                </select>
              </div>
            </div>
            
            {/* Campo N√∫mero Fatura */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                N√∫mero da Fatura:
                {(!dadosFatura.numero || dadosFatura.numero === 'N/A' || dadosFatura.numero === '') && (
                  <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-bold">
                    ‚ö†Ô∏è N√ÉO DETETADO
                  </span>
                )}
              </label>
              <input
                type="text"
                value={numeroFatura}
                onChange={(e) => setNumeroFatura(e.target.value)}
                placeholder="Ex: FT 2024/001"
                className={`w-full p-2 border-2 rounded-lg transition-colors ${
                  !dadosFatura.numero || dadosFatura.numero === 'N/A' || dadosFatura.numero === ''
                    ? 'bg-red-50 border-red-400'
                    : 'border-gray-300'
                }`}
              />
            </div>
          </div>
          
          {/* COLUNA DIREITA: Sele√ß√£o de tipo */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Tipo de Fatura:
            </label>
            
            <div className="space-y-2">
              {Object.entries(INVOICE_TYPES).map(([tipo, config]) => (
                <label
                  key={tipo}
                  className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${
                    tipoSelecionado === tipo
                      ? 'border-green-500 bg-green-50'
                      : 'border-gray-200 hover:border-green-300 hover:bg-gray-50'
                  }`}
                >
                  <div className="flex items-center">
                    <input
                      type="radio"
                      name="tipoFatura"
                      value={tipo}
                      checked={tipoSelecionado === tipo}
                      onChange={(e) => setTipoSelecionado(e.target.value)}
                      className="mr-3 h-4 w-4 text-green-600"
                    />
                    <div>
                      <div className="font-semibold">{config.label}</div>
                      <div className="text-sm text-gray-600">{config.description}</div>
                    </div>
                  </div>
                </label>
              ))}
            </div>
            
            {/* üÜï CAMPO NIF DO CLIENTE (s√≥ para FS) */}
            {tipoSelecionado === 'FS' && (
              <div className={`mt-3 p-3 rounded-lg border-2 ${
                temNifCliente
                  ? 'bg-green-50 border-green-500' 
                  : 'bg-red-50 border-red-500'
              }`}>
                <label className="flex items-start gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={temNifCliente}
                    onChange={(e) => setTemNifCliente(e.target.checked)}
                    className="w-5 h-5 mt-1 cursor-pointer"
                  />
                  <div className="flex-1">
                    <div className="font-semibold text-sm flex items-center flex-wrap gap-2">
                      <span>Esta fatura cont√©m o meu NIF (255274513)</span>
                      {temNifCliente && (
                        <span className="px-2 py-1 bg-green-600 text-white text-xs rounded whitespace-nowrap">
                          ‚úÖ DETETADO
                        </span>
                      )}
                      {!temNifCliente && (
                        <span className="px-2 py-1 bg-orange-600 text-white text-xs rounded whitespace-nowrap">
                          ‚ö†Ô∏è ADICIONAR MANUALMENTE
                        </span>
                      )}
                    </div>
                    <div className={`text-xs mt-1 ${
                      temNifCliente ? 'text-green-700' : 'text-red-700'
                    }`}>
                      {temNifCliente ? (
                        <>
                          ‚ÑπÔ∏è O sistema encontrou o teu NIF nesta fatura. Pode ser inclu√≠da na partilha para o contabilista.
                        </>
                      ) : (
                        <>
                          ‚ö†Ô∏è O sistema n√£o encontrou o teu NIF. Se esta fatura tiver o teu NIF, marca esta op√ß√£o para poder deduzir.
                        </>
                      )}
                    </div>
                  </div>
                </label>
              </div>
            )}
          </div>
        </div>
        
        {/* Buttons */}
        <div className="flex gap-3 mt-6">
          <button
            onClick={handleConfirmar}
            className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors"
          >
            Confirmar
          </button>
          <button
            onClick={onCancelar}
            className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
        </div>
      </div>
      
      {/* Modal Criar Fornecedor */}
      {mostrarModalNovoFornecedor && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
            <h3 className="text-xl font-bold mb-4">‚ûï Criar Novo Fornecedor</h3>
            
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-semibold mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoFornecedor.nome}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nome: e.target.value})}
                  placeholder="Ex: Pingo Doce"
                  className="w-full px-3 py-2 border rounded"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">NIF</label>
                <input
                  type="text"
                  value={novoFornecedor.nif}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nif: e.target.value})}
                  placeholder="9 d√≠gitos"
                  maxLength="9"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Contacto</label>
                <input
                  type="text"
                  value={novoFornecedor.contacto}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, contacto: e.target.value})}
                  placeholder="Telefone"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Email</label>
                <input
                  type="email"
                  value={novoFornecedor.email}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, email: e.target.value})}
                  placeholder="email@exemplo.com"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            
            <div className="flex gap-2 mt-6">
              <button
                onClick={() => {
                  setMostrarModalNovoFornecedor(false);
                  setNovoFornecedor({ nome: '', nif: dadosFatura.fornecedor?.nif || '', contacto: '', email: '' });
                }}
                className="flex-1 px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              >
                Cancelar
              </button>
              <button
                onClick={criarNovoFornecedor}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ú® Criar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * Painel de Configura√ß√µes
 */
const PainelConfiguracoes = ({ configuracoes, onSalvar, vendas, setVendas, showNotification, ordenadoObjetivo, setOrdenadoObjetivo }) => {
  const [config, setConfig] = React.useState(configuracoes);
  const [mostrarSucesso, setMostrarSucesso] = React.useState(false);
  const [alertasExpanded, setAlertasExpanded] = React.useState(false);
  
  const handleSalvar = () => {
    onSalvar(config);
    setMostrarSucesso(true);
    setTimeout(() => setMostrarSucesso(false), 3000);
  };
  
  const atualizarConfig = (secao, campo, valor) => {
    const novoConfig = {
      ...config,
      [secao]: {
        ...config[secao],
        [campo]: valor
      }
    };
    setConfig(novoConfig);

    if (secao === 'metricas') {

      onSalvar(novoConfig);
    }
  };
  
  return (
    <div className="space-y-4">
      {/* Filtro de M√©tricas com Tags Individuais */}
      <div className="bg-gray-50 rounded-lg p-4">
        <h4 className="font-semibold mb-3 text-gray-700">üè∑Ô∏è Filtro de M√©tricas por Tags</h4>
        <p className="text-xs text-gray-600 mb-3">Seleciona quais origens incluir nas m√©tricas do dashboard</p>
        
        {/* Vendas */}
        <div className="mb-4">
          <p className="text-sm font-semibold text-gray-700 mb-2">üìä Vendas</p>
          <div className="space-y-2">
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirMoloni !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirMoloni', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">MOLONI</span>
                Vendas importadas do Moloni
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-blue-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirZobaze !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirZobaze', e.target.checked)}
                className="mr-2 h-4 w-4 text-blue-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-bold mr-2">ZOBAZE</span>
                Vendas importadas do Zobaze
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-gray-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirManual !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirManual', e.target.checked)}
                className="mr-2 h-4 w-4 text-gray-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-xs font-bold mr-2">MANUAL</span>
                Vendas adicionadas manualmente
              </span>
            </label>
          </div>
        </div>
        
        {/* Faturas/Despesas */}
        <div>
          <p className="text-sm font-semibold text-gray-700 mb-2">üìÑ Faturas de Compras</p>
          <div className="space-y-2">
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFT !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFT', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">FT</span>
                Faturas (oficial para contabilista)
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFR !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFR', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">FR</span>
                Faturas-Recibo (oficial para contabilista)
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-orange-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFS !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFS', e.target.checked)}
                className="mr-2 h-4 w-4 text-orange-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-bold mr-2">FS</span>
                Faturas Simplificadas (n√£o oficial)
              </span>
            </label>
          </div>
        </div>
        
        {/* Atalhos R√°pidos */}
        <div className="mt-4 pt-4 border-t border-gray-300">
          <p className="text-xs font-semibold text-gray-600 mb-2">‚ö° Atalhos</p>
          <div className="flex gap-2">
            <button
              onClick={() => {
                const novoConfig = {
                  ...config,
                  metricas: {
                    ...config.metricas,
                    incluirMoloni: true,
                    incluirZobaze: false,
                    incluirManual: true,
                    incluirFT: true,
                    incluirFR: true,
                    incluirFS: false
                  }
                };
                setConfig(novoConfig);
                onSalvar(novoConfig);
              }}
              className="flex-1 bg-green-600 text-white px-3 py-1.5 rounded text-xs hover:bg-green-700 transition font-semibold"
            >
              üìä S√≥ Oficial
            </button>
            <button
              onClick={() => {
                const novoConfig = {
                  ...config,
                  metricas: {
                    ...config.metricas,
                    incluirMoloni: true,
                    incluirZobaze: true,
                    incluirManual: true,
                    incluirFT: true,
                    incluirFR: true,
                    incluirFS: true
                  }
                };
                setConfig(novoConfig);
                onSalvar(novoConfig);
              }}
              className="flex-1 bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 transition font-semibold"
            >
              üìà Tudo
            </button>
          </div>
        </div>
      </div>
      
      {/* Objetivo de Ordenados */}
      <div className="border border-gray-300 rounded-lg overflow-hidden">
        <div className="p-4 bg-gray-50">
          <div className="text-left">
            <h4 className="font-semibold text-gray-700">üéØ Objetivo de Ordenados</h4>
            <p className="text-sm text-gray-600">
              Ordenado mensal total desejado (incluindo c√¥njuge)
            </p>
          </div>
        </div>
        
        <div className="p-4 bg-white border-t">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            üí∞ Ordenado Mensal Total (‚Ç¨):
          </label>
          <div className="flex items-center gap-2">
            <input
              type="number"
              step="100"
              min="0"
              value={ordenadoObjetivo}
              onChange={(e) => {
                const valor = parseFloat(e.target.value) || 0;
                setOrdenadoObjetivo(valor);
                localStorage.setItem('munchi_ordenado_objetivo', valor.toString());
              }}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              placeholder="Ex: 2000"
            />
            <span className="text-sm text-gray-600">‚Ç¨</span>
          </div>
          <p className="text-xs text-gray-500 mt-2">
            A barra no cabe√ßalho mostra se est√° a atingir o objetivo para cobrir: despesas fixas + food cost + IVA + este ordenado.
          </p>
        </div>
      </div>
      
      {/* Alertas de Margem */}
      <div className="border rounded-lg overflow-hidden">
        <button
          onClick={() => setAlertasExpanded(!alertasExpanded)}
          className="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition"
        >
          <div className="text-left">
            <h4 className="font-semibold text-gray-700">Alertas de Margem</h4>
            <p className="text-sm text-gray-600">
              Configurar limites de margem baixa e cr√≠tica
            </p>
          </div>
          {alertasExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
        </button>
        
        {alertasExpanded && (
          <div className="p-4 bg-white border-t space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Margem baixa (alerta amarelo):
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={config.alertas.margemBaixa}
                  onChange={(e) => atualizarConfig('alertas', 'margemBaixa', parseFloat(e.target.value))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg"
                />
                <span>%</span>
                <span className="text-sm text-gray-600">(default: 70%)</span>
              </div>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Margem cr√≠tica (alerta vermelho):
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={config.alertas.margemCritica}
                  onChange={(e) => atualizarConfig('alertas', 'margemCritica', parseFloat(e.target.value))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg"
                />
                <span>%</span>
                <span className="text-sm text-gray-600">(default: 55%)</span>
              </div>
            </div>
          </div>
        )}
      </div>
      
      <button
        onClick={handleSalvar}
        className="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
      >
        <Save className="w-5 h-5" />
        Guardar Defini√ß√µes
      </button>
      
      {/* Bot√£o Apagar Vendas */}
      <div className="border border-gray-300 rounded-lg p-4 bg-gray-50">
        <p className="text-sm font-semibold text-gray-700 mb-2">
          üóëÔ∏è Limpar Dados
        </p>
        <p className="text-xs text-gray-600 mb-3">
          Apaga todas as vendas. √ötil para importar dados novos.
        </p>
        <button
          onClick={() => {
            if (window.confirm(`Apagar ${vendas.length} vendas?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
              setVendas([]);
              showNotification('Vendas apagadas!', 'success');
            }
          }}
          className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition"
        >
          Apagar Todas as Vendas ({vendas.length})
        </button>
      </div>
      
      {mostrarSucesso && (
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg flex items-center gap-2">
          <Check className="w-5 h-5" />
          <span>Defini√ß√µes guardadas com sucesso!</span>
        </div>
      )}
    </div>
  );
};

/**
 * Componente para mostrar margens de produto com c√≥digo de cores
 */
const DisplayMargem = ({ produto, configuracoes }) => {
  const margens = calcularMargensProduto(produto, configuracoes);
  
  if (!margens) {
    return <span className="text-gray-400">N/A</span>;
  }
  
  const corClasses = {
    green: 'bg-green-100 border-green-500 text-green-800',
    yellow: 'bg-yellow-100 border-yellow-500 text-yellow-800',
    red: 'bg-red-100 border-red-500 text-red-800'
  };
  
  const corClass = corClasses[margens.status.cor] || corClasses.green;
  
  return (
    <div className={`p-3 rounded-lg border-l-4 ${corClass}`}>
      <div className="flex items-center justify-between">
        <span className="font-semibold">Margem Bruta:</span>
        <span className="text-lg font-bold">{margens.margemBruta.toFixed(1)}%</span>
      </div>
      
      {margens.status.status === 'critical' && (
        <div className="mt-2 pt-2 border-t border-red-300 text-sm">
          <div className="flex items-start gap-2">
            <AlertCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
            <div>
              <div className="font-semibold">Margem abaixo de {configuracoes?.alertas?.margemCritica || 55}%</div>
              <div>A√ß√£o sugerida: rever pre√ßo ou receita</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const CONFIGURACOES_DEFAULT = {
  metricas: {

    incluirMoloni: true,
    incluirZobaze: true,
    incluirManual: true,
    incluirFT: true,
    incluirFR: true,
    incluirFS: true,

    apenasOficial: false,

    nifEmpresa: '255274513' // C√°tia Santos
  },
  alertas: {
    margemBaixa: 70,
    margemCritica: 55
  }
};

const carregarConfiguracoes = () => {
  try {
    const guardado = localStorage.getItem('munchi_configuracoes');
    return guardado ? JSON.parse(guardado) : CONFIGURACOES_DEFAULT;
  } catch (e) {

    return CONFIGURACOES_DEFAULT;
  }
};

const guardarConfiguracoes = (configuracoes) => {
  try {
    localStorage.setItem('munchi_configuracoes', JSON.stringify(configuracoes));

    return true;
  } catch (e) {

    return false;
  }
};

const INVOICE_TYPES = {
  FT: {
    label: 'Fatura (FT)',
    description: 'Vai para contabilista',
    patterns: [
      /Fatura\s+N[.¬∫¬∞]\s*FT\s+\d{4}\/\d+/i,
      /FT\s+\d{4}\/\d+/,
      /^Fatura$/i
    ],
    numberPatterns: [

      /(?:FT|Fatura)\s*N?[.¬∫¬∞:]*\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /N[.¬∫¬∞:]\s*FT\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /FT\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,

      /Fatura.*?N[.¬∫¬∞:]\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,

      /Fatura\s+N[.¬∫¬∞]\s*(FT\s*\d{4}\/\d+)/i,
      /N[.¬∫¬∞]\s*(FT[_\s-]?\d{4}[\/\s-]?\d+)/i,
      /(FT\s*\d{4}\/\d+)/,
      /PP\s+(\d+)/
    ]
  },
  FR: {
    label: 'Fatura-Recibo (FR)',
    description: 'Vai para contabilista',
    patterns: [
      /Fatura[_\s\/-]Recibo/i,
      /\d{2}\/Fatura\/Recibo/,
      /FR\s+\d{4}\/\d+/,
      /04\/Fatura/,
      /\bFR\b/i,  // ‚úÖ NOVO: Detectar "FR" sozinho
      /Fatura.*Recibo/i,  // ‚úÖ NOVO: Fatura...Recibo (com texto no meio)
      /Recibo.*Fatura/i   // ‚úÖ NOVO: Recibo...Fatura
    ],
    numberPatterns: [

      /(?:FR|Fatura[_\s-]?Recibo)\s*N?[.¬∫¬∞:]*\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /N[.¬∫¬∞:]\s*FR\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /FR\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,

      /Fatura.*?Recibo.*?N[.¬∫¬∞:]\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,

      /Fatura[_\s-]Recibo.*?(\d{4}[-_\/]\d{2}[-_\/]\d{2})/,

      /04\/Fatura\/Recibo\s+(\d{4}[-_]\d{2}[-_]\d{2})/,
      /(FR\s*\d{4}\/\d+)/,
      /PP\s+(\d+)/
    ]
  },
  FS: {
    label: 'Fatura Simplificada (FS)',
    description: 'Vai para contabilista SE tiver NIF',
    patterns: [
      /Fatura\s+Simplificada/i,
      /FS\s+[MN]\/\d+/i, // FS M/68601
      /FS\s+\d{4}\/\d+/,
      /Recibo\s+N[.¬∫¬∞]\s*\d+/,
      /Simplificada/i,
      /\bFS\b/i,  // ‚úÖ NOVO: Detectar "FS" sozinho
      /Fatura.*Simplificada/i,  // ‚úÖ NOVO: Fatura...Simplificada
      /Simplif/i  // ‚úÖ NOVO: OCR pode cortar palavra
    ],
    numberPatterns: [

      /(?:FS|Fatura\s+Simplificada|Simplificada)\s*N?[.¬∫¬∞:]*\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /N[.¬∫¬∞:]\s*FS\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /FS\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,

      /Simplificada\s+FS\s+([MN]\/[A-Z0-9]+)/i,
      /FS\s+([MN]\/[A-Z0-9]+)/i,

      /Simplificada.*?N[.¬∫¬∞:]\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,

      /(FS\s*\d{4}\/\d+)/,
      /Recibo\s+N[.¬∫¬∞]\s*(\d+)/,
      /Simplificada\s+(\d+)/
    ]
  }
};

const FORNECEDORES_CONHECIDOS = {
  recheio: {
    nome: 'Recheio Cash & Carry',
    patterns: [
      /Recheio\s+Cash\s+&\s+Carry/i,
      /PT\s+HF\s+9568126/i,
      /NIF[:\s]*500145415/i
    ],
    nif: '500145415'
  },
  mania: {
    nome: 'MANIA CERVEJEIRA',
    patterns: [
      /MANIA\s+CERVEJEIRA/i,
      /Stefan\s+Hunold/i
    ],
    nif: '278240160'
  },
  pingoDoce: {
    nome: 'Pingo Doce',
    patterns: [
      /Pingo\s*Doce/i,
      /JERONIMO\s+MARTINS/i,
      /JMR\s*-/i,
      /NIF[:\s]*500829993/i
    ],
    nif: '500829993'
  },
  continente: {
    nome: 'Continente',
    patterns: [
      /MODELO\s+CONTINENTE/i,
      /CONTINENTE\s+HIPERMERCADOS/i,
      /SONAE\s+MC/i,
      /NIF[:\s]*502011475/i
    ],
    nif: '502011475'
  },
  lidl: {
    nome: 'Lidl',
    patterns: [
      /LIDL\s+&\s+CIA/i,
      /LIDL\s+PORTUGAL/i,
      /NIF[:\s]*500871029/i
    ],
    nif: '500871029'
  },
  auchan: {
    nome: 'Auchan',
    patterns: [
      /AUCHAN\s+PORTUGAL/i,
      /JUMBO/i,
      /NIF[:\s]*500038191/i
    ],
    nif: '500038191'
  },
  makro: {
    nome: 'Makro',
    patterns: [
      /MAKRO\s+CASH/i,
      /MAKRO\s+PORTUGAL/i,
      /NIF[:\s]*500576602/i
    ],
    nif: '500576602'
  }
};

const RestauranteGestor = () => {
  const [activeTab, setActiveTab] = useState('dashboard');

  const mudarParaAba = (aba) => {
    setActiveTab(aba);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const [isSyncing, setIsSyncing] = React.useState(false);
  const [lastSync, setLastSync] = React.useState(GitHubSync.getLastSync());
  const [syncError, setSyncError] = React.useState(null);
  const [autoSyncEnabled, setAutoSyncEnabled] = React.useState(true);

  const [driveAccessToken, setDriveAccessToken] = useState(null);
  const [driveUser, setDriveUser] = useState(null);
  const [driveSyncing, setDriveSyncing] = useState(false);
  const [driveFileId, setDriveFileId] = useState(localStorage.getItem('munchi_drive_file_id'));
  const [driveLastSync, setDriveLastSync] = useState(null);
  const [driveError, setDriveError] = useState(null);

  const [driveTokenValid, setDriveTokenValid] = useState(false);
  const [driveTokenTimeLeft, setDriveTokenTimeLeft] = useState(0);
  const tokenCheckIntervalRef = React.useRef(null);

  const pendingSyncRef = React.useRef(0); // üî• CONTADOR de altera√ß√µes pendentes (n√£o boolean!)
  const syncTimeoutRef = React.useRef(null);
  const lastSyncDataRef = React.useRef(null);

  const [dashboardSubTab, setDashboardSubTab] = useState('resumo');
  const [dateFilter, setDateFilter] = useState('all'); // all, today, week, month, custom
  const [showBreakEvenDetails, setShowBreakEvenDetails] = useState(false); // Estado para dropdown do break-even
  const [showEficienciaDetails, setShowEficienciaDetails] = useState(false); // Efici√™ncia Operacional
  const [showMensalDetails, setShowMensalDetails] = useState(false); // An√°lise Mensal
  const [showProdutosDetails, setShowProdutosDetails] = useState(false); // Performance Produtos
  const [showClienteDetails, setShowClienteDetails] = useState(false); // An√°lise por Cliente

  React.useEffect(() => {
    window.toggleProdutosAnalise = () => {
      setShowProdutosDetails(prev => !prev);
    };
    window.toggleMensalAnalise = () => {
      setShowMensalDetails(prev => !prev);
    };
    return () => {
      delete window.toggleProdutosAnalise;
      delete window.toggleMensalAnalise;
    };
  }, []);
  const [showIVADetails, setShowIVADetails] = useState(false); // An√°lise Fiscal
  const [showDespesasDetails, setShowDespesasDetails] = useState(false); // Estado para dropdown de despesas
  const [mostrarBolosExternos, setMostrarBolosExternos] = useState(false); // Estado para dropdown dos bolos externos
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [gestaoSubTab, setGestaoSubTab] = useState('ingredientes');
  const [produtos, setProdutos] = useState([]);
  const [ingredientes, setIngredientes] = useState([]);
  const [vendas, setVendas] = useState([]);
  const [filtroVendas, setFiltroVendas] = useState(''); // Filtro de pesquisa para vendas
  const [despesas, setDespesas] = useState([]);
  const [fornecedores, setFornecedores] = useState([]);
  const [configuracaoWaste, setConfiguracaoWaste] = useState({
    percentagemGlobal: 8,
    percentagensPorCategoria: {
      'vegetais': 15, 'frutas': 14, 'peixe': 12, 'carnes': 10,
      'lacteos': 9, 'latic√≠nios': 9, 'compotas': 8, 'consumiveis': 7,
      'temperos': 6, 'padaria': 5, 'cafe': 4, 'cereais': 4,
      'especiarias': 3, 'oleos': 3, 'bebidas': 4, 'pastelaria': 5,
      'limpeza': 0, 'operacionais': 0, 'outros': 2, 'default': 8
    },
    usarCategorias: true
  });
  
  const [contagens, setContagens] = useState([]);
  const [vocabularioFornecedor, setVocabularioFornecedor] = useState([]); // üß† Sistema de aprendizagem
  const [templatesOCR, setTemplatesOCR] = useState([]); // üìã Templates por fornecedor

  const [bolosExternos, setBolosExternos] = useState([]);
  const [bolosAgendados, setBolosAgendados] = useState([]);
  const [mostrarNotificacaoBolo, setMostrarNotificacaoBolo] = useState(false);
  const [boloAtualNotificacao, setBoloAtualNotificacao] = useState(null);
  const [calendarConfig, setCalendarConfig] = useState({
    calendarId: 'primary',
    autoCheck: true,
    intervalo: 30, // minutos entre verifica√ß√µes
    diasPassados: 14, // quantos dias atr√°s buscar (2 semanas)
    diasFuturos: 7,  // quantos dias √† frente buscar (1 semana)
    ultimaVerificacao: null
  });
  
  const [novoProduto, setNovoProduto] = useState({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
  const [editandoProduto, setEditandoProduto] = useState(false);
  const [produtoEditandoId, setProdutoEditandoId] = useState(null);

  const [mostrarVendaManual, setMostrarVendaManual] = useState(false);
  const [vendaEditando, setVendaEditando] = useState(null); // ID da venda sendo editada
  const [produtoOriginalVenda, setProdutoOriginalVenda] = useState(''); // üÜï Nome original do produto antes de editar
  const [mostrarEditarVenda, setMostrarEditarVenda] = useState(false);
  const [novaVenda, setNovaVenda] = useState({
    data: new Date().toISOString().split('T')[0],
    produtoId: '',
    quantidade: 1,
    valorManual: '',
    usarValorManual: false,

    numeroDocumento: '',
    tipoDocumento: 'Venda',
    formaPagamento: 'Dinheiro',
    observacoes: ''
  });

  const [deliveryApps, setDeliveryApps] = useState([
    { 
      id: 'uber', 
      nome: 'Uber Eats', 
      comissao: 25, 
      ativo: false, 
      cor: '#06c167',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    },
    { 
      id: 'glovo', 
      nome: 'Glovo', 
      comissao: 28, 
      ativo: false, 
      cor: '#ffc244',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    },
    { 
      id: 'bolt', 
      nome: 'Bolt Food', 
      comissao: 27, 
      ativo: false, 
      cor: '#34d186',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    }
  ]);
  const [editandoApp, setEditandoApp] = useState(null);
  const [novaApp, setNovaApp] = useState({ nome: '', comissao: '25' });
  const [embalagens, setEmbalagens] = useState([]);
  const [novaEmbalagem, setNovaEmbalagem] = useState({ nome: '', custoUnitario: '', categoria: 'copos' });
  const [searchIngrediente, setSearchIngrediente] = useState('');
  const [searchIngredienteGlobal, setSearchIngredienteGlobal] = useState('');
  const [categoriaFiltro, setCategoriaFiltro] = useState('todas');
  const [searchProdutoGlobal, setSearchProdutoGlobal] = useState('');
  const [filterCategoriaGlobal, setFilterCategoriaGlobal] = useState('');

  const [movimentacoesStock, setMovimentacoesStock] = useState([]);
  const [stockRastreamentoAtivo, setStockRastreamentoAtivo] = useState(true);
  const [alertasStock, setAlertasStock] = useState([]);
  const [mostrarModalMovimentacoes, setMostrarModalMovimentacoes] = useState(false);

  const [inventarioAtivo, setInventarioAtivo] = useState(null); // Sess√£o de contagem em progresso
  const [indiceAtualInventario, setIndiceAtualInventario] = useState(0); // √çndice do ingrediente atual
  const [contagensHistorico, setContagensHistorico] = useState([]); // Hist√≥rico de todas as contagens
  const [mostrarModalInventario, setMostrarModalInventario] = useState(false); // Modal de contagem
  const [mostrarHistoricoInventarios, setMostrarHistoricoInventarios] = useState(false); // Modal de hist√≥rico
  const [inputStockReal, setInputStockReal] = useState(''); // Input tempor√°rio

  const [showIngredienteSuggestions, setShowIngredienteSuggestions] = useState(false);
  const [searchIngredienteFatura, setSearchIngredienteFatura] = useState('');
  const [showIngredienteSuggestionsFatura, setShowIngredienteSuggestionsFatura] = useState(false);

  const [modalConfirmacaoFatura, setModalConfirmacaoFatura] = useState({ mostrar: false, dados: null });
  const [modalDespesaSimples, setModalDespesaSimples] = useState({ mostrar: false, dados: null }); // üÜï MODAL SIMPLES
  const [blacklist, setBlacklist] = useState([]);
  const [configuracoes, setConfiguracoes] = useState(carregarConfiguracoes());
  const [novoIngrediente, setNovoIngrediente] = useState({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
  const [editandoIngrediente, setEditandoIngrediente] = useState(false);
  const [modalContagem, setModalContagem] = useState(false);
  const [ingredienteContagem, setIngredienteContagem] = useState(null);
  const [valorContagem, setValorContagem] = useState(0);
  const [ingredienteEditandoMin, setIngredienteEditandoMin] = useState(null);
  const [valorMinEdicao, setValorMinEdicao] = useState(0);
  const [ingredienteEditandoId, setIngredienteEditandoId] = useState(null);
  const [novaDespesa, setNovaDespesa] = useState({ 
    descricao: '', 
    valor: '', 
    iva: '23', 
    data: new Date().toISOString().split('T')[0], 
    categoria: 'compras',
    fornecedor: '',
    ingredienteId: null,
    quantidade: '',
    num_funcionarios: 1,
    frequencia_pagamento: 'mensal',

    numeroDocumento: '',
    tipoDocumento: 'Fatura',
    formaPagamento: 'Transfer√™ncia',
    notas: '',

    documentoPDF: null, // Armazena o ficheiro PDF como base64
    nomeDocumento: '' // Nome original do ficheiro
  });
  const [searchDespesaIngrediente, setSearchDespesaIngrediente] = useState('');
  const [showDespesaSuggestions, setShowDespesaSuggestions] = useState(false);
  const [showPriceHistory, setShowPriceHistory] = useState(false);
  const [showPriceAlert, setShowPriceAlert] = useState(false);
  const [priceAlertData, setPriceAlertData] = useState(null);
  const [ordenadoDesejado, setOrdenadoDesejado] = useState(920);
  const [ordenadoObjetivo, setOrdenadoObjetivo] = useState(() => {
    const saved = localStorage.getItem('munchi_ordenado_objetivo');
    return saved ? parseFloat(saved) : 2000;
  });
  const [incluirSubsidioAlimentacao, setIncluirSubsidioAlimentacao] = useState(false);
  const [valorSubsidioAlimentacao, setValorSubsidioAlimentacao] = useState(6.00);
  const [incluirMedicinaTrabalho, setIncluirMedicinaTrabalho] = useState(false);
  const [valorMedicinaTrabalho, setValorMedicinaTrabalho] = useState(100); // ‚Ç¨100/ano (m√©dia)
  const [incluirSeguroAcidentes, setIncluirSeguroAcidentes] = useState(false);
  const [valorSeguroAcidentes, setValorSeguroAcidentes] = useState(150); // ‚Ç¨150/ano (m√©dia restaura√ß√£o)
  const [modoSimulador, setModoSimulador] = useState('fulltime'); // 'fulltime' ou 'parttime'
  const [horasSemanaisPartTime, setHorasSemanaisPartTime] = useState(8);
  const [horasSemanais, setHorasSemanais] = useState(20);
  const [valorHora, setValorHora] = useState(10);
  const [simuladorAberto, setSimuladorAberto] = useState(false);
  const [notification, setNotification] = useState(null);
  const [expandedProduct, setExpandedProduct] = useState(null);
  const [desempenhoProdutoExpanded, setDesempenhoProdutoExpanded] = useState(false);
  const [searchTakeAway, setSearchTakeAway] = useState('');

  const [produtosAnaliseTab, setProdutosAnaliseTab] = useState('categorias'); // 'categorias', 'ranking', 'individual'
  const [produtoDetalheExpandido, setProdutoDetalheExpandido] = useState(null); // nome do produto expandido
  const [buscaProdutoIndividual, setBuscaProdutoIndividual] = useState(''); // busca no tab individual
  const [ordenarPor, setOrdenarPor] = useState('faturacao'); // 'faturacao', 'quantidade', 'lucro', 'margem'
  const [categoriaExpandida, setCategoriaExpandida] = useState(null); // categoria expandida para ver detalhes dos produtos

  const [faturaEditando, setFaturaEditando] = useState(null);
  const [searchIngredienteCompra, setSearchIngredienteCompra] = useState('');
  const [showDropdownIngredienteCompra, setShowDropdownIngredienteCompra] = useState(false);
  const [showDropdownEditItem, setShowDropdownEditItem] = useState(false); // Para dropdown ao editar item

  const arredondar = (numero, casasDecimais = 4) => {
    return Math.round(numero * Math.pow(10, casasDecimais)) / Math.pow(10, casasDecimais);
  };

  // üßπ Fun√ß√£o para limpar ingredientes √≥rf√£os das receitas dos produtos
  // Quando um ingrediente √© apagado mas ainda est√° referenciado numa receita
  const limparIngredientesOrfaos = (listaProdutos, listaIngredientes) => {
    const idsIngredientes = new Set(listaIngredientes.map(i => i.id));
    let orfaosRemovidos = 0;
    const produtosLimpos = listaProdutos.map(p => {
      if (!p.receita || p.receita.length === 0) return p;
      const receitaLimpa = p.receita.filter(r => {
        if (idsIngredientes.has(r.ingredienteId)) return true;
        orfaosRemovidos++;
        console.warn(`üßπ Removido ingrediente √≥rf√£o ${r.ingredienteId} da receita de "${p.nome}"`);
        return false;
      });
      if (receitaLimpa.length !== p.receita.length) {
        return { ...p, receita: receitaLimpa };
      }
      return p;
    });
    if (orfaosRemovidos > 0) {
      console.info(`üßπ Limpeza autom√°tica: ${orfaosRemovidos} refer√™ncias √≥rf√£s removidas das receitas.`);
    }
    return { produtosLimpos, orfaosRemovidos };
  };

  // üßπ Fun√ß√£o para limpar ingredientes √≥rf√£os dos itens das faturas
  const limparFaturasOrfas = (listaFaturas, listaIngredientes) => {
    const idsIngredientes = new Set(listaIngredientes.map(i => i.id));
    let orfaosRemovidos = 0;
    const faturasLimpas = listaFaturas.map(f => {
      if (!f.itens || f.itens.length === 0) return f;
      const itensLimpos = f.itens.map(item => {
        if (!item.ingredienteId || idsIngredientes.has(item.ingredienteId)) return item;
        orfaosRemovidos++;
        console.warn(`üßπ Removido ingrediente √≥rf√£o ${item.ingredienteId} do item "${item.descricao || item.nome || 'N/A'}" na fatura #${f.numeroDocumento || f.numero || 'N/A'} (${f.data || 'N/A'})`);
        // Remove apenas a liga√ß√£o ao ingrediente, mant√©m o item na fatura
        const { ingredienteId, ...itemSemIngrediente } = item;
        return itemSemIngrediente;
      });
      return { ...f, itens: itensLimpos };
    });
    if (orfaosRemovidos > 0) {
      console.info(`üßπ Limpeza autom√°tica: ${orfaosRemovidos} refer√™ncias √≥rf√£s removidas das faturas.`);
    }
    return { faturasLimpas, orfaosRemovidos };
  };

  const converterParaUnidadeBase = (quantidade, unidadeOrigem, unidadeDestino) => {
    const origem = unidadeOrigem?.toLowerCase() || '';
    const destino = unidadeDestino?.toLowerCase() || '';
    
    if (origem === destino) return arredondar(quantidade);
    
    if (origem === 'kg' && destino === 'g') return arredondar(quantidade * 1000);
    if (origem === 'g' && destino === 'kg') return arredondar(quantidade / 1000);
    if (origem === 'l' && destino === 'ml') return arredondar(quantidade * 1000);
    if (origem === 'ml' && destino === 'l') return arredondar(quantidade / 1000);
    
    return arredondar(quantidade);
  };

  const unidadesSaoCompativeis = (unidade1, unidade2) => {
    const u1 = unidade1?.toLowerCase() || '';
    const u2 = unidade2?.toLowerCase() || '';
    
    const unidadesPeso = ['kg', 'g'];
    const unidadesVolume = ['l', 'ml'];
    const unidadesContagem = ['un', 'unidade', 'unidades'];
    
    if (unidadesPeso.includes(u1) && unidadesPeso.includes(u2)) return true;
    if (unidadesVolume.includes(u1) && unidadesVolume.includes(u2)) return true;
    if (unidadesContagem.includes(u1) && unidadesContagem.includes(u2)) return true;
    if (u1 === u2) return true;
    
    return false;
  };

  const registrarEntradaStock = (compraData) => {
    const { ingredienteId, quantidade, unidade, precoTotal, data, fornecedor, numeroDocumento } = compraData;
    
    const ingredienteIndex = ingredientes.findIndex(ing => ing.id === ingredienteId);
    if (ingredienteIndex === -1) return;
    
    const ingrediente = ingredientes[ingredienteIndex];
    const quantidadeConvertida = converterParaUnidadeBase(quantidade, unidade, ingrediente.unidade);
    
    if (!unidadesSaoCompativeis(unidade, ingrediente.unidade)) {
      console.warn(`Unidades incompat√≠veis: ${unidade} vs ${ingrediente.unidade}`);
      return;
    }
    
    const stockAnterior = arredondar(ingrediente.stockAtual || 0);
    const novoStock = arredondar(stockAnterior + quantidadeConvertida);
    const novosIngredientes = [...ingredientes];
    novosIngredientes[ingredienteIndex] = {
      ...ingrediente,
      stockAtual: novoStock
    };
    
    setIngredientes(novosIngredientes);
    
    const movimentacao = {
      id: Date.now() + Math.random(),
      data: data || new Date().toISOString().split('T')[0],
      tipo: 'entrada',
      ingredienteId: ingredienteId,
      ingredienteNome: ingrediente.nome,
      quantidade: quantidadeConvertida,
      unidade: ingrediente.unidade,
      precoUnitario: precoTotal / quantidade,
      precoTotal: precoTotal,
      stockAnterior: stockAnterior,
      stockNovo: novoStock,
      fornecedor: fornecedor || 'N/A',
      numeroDocumento: numeroDocumento || 'N/A',
      observacao: `Compra: +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
    };
    
    setMovimentacoesStock(prev => [...prev, movimentacao]);
  };

  const registrarSaidaStock = (vendaData) => {
    const { produtoId, quantidade, data } = vendaData;
    
    const produto = produtos.find(p => p.id === produtoId);
    if (!produto || !produto.receita || produto.receita.length === 0) return;
    
    const novosIngredientes = [...ingredientes];
    const novasMovimentacoes = [];
    
    produto.receita.forEach(receitaItem => {
      const ingredienteIndex = novosIngredientes.findIndex(ing => ing.id === receitaItem.ingredienteId);
      if (ingredienteIndex === -1) return;
      
      const ingrediente = novosIngredientes[ingredienteIndex];

      const quantidadeReceitaConvertida = converterParaUnidadeBase(
        receitaItem.quantidade,
        receitaItem.unidade || ingrediente.unidade,
        ingrediente.unidade
      );
      
      const quantidadeUsada = arredondar(quantidadeReceitaConvertida * quantidade);
      const stockAnterior = arredondar(ingrediente.stockAtual || 0);
      const novoStock = arredondar(Math.max(0, stockAnterior - quantidadeUsada));
      
      novosIngredientes[ingredienteIndex] = {
        ...ingrediente,
        stockAtual: novoStock
      };
      
      const movimentacao = {
        id: Date.now() + Math.random(),
        data: data || new Date().toISOString().split('T')[0],
        tipo: 'saida',
        ingredienteId: ingrediente.id,
        ingredienteNome: ingrediente.nome,
        quantidade: quantidadeUsada,
        unidade: ingrediente.unidade,
        stockAnterior: stockAnterior,
        stockNovo: novoStock,
        produtoId: produto.id,
        produtoNome: produto.nome,
        quantidadeProdutos: quantidade,
        observacao: `Venda: -${quantidadeUsada.toFixed(2)} ${ingrediente.unidade} (${quantidade}x ${produto.nome})`
      };
      
      novasMovimentacoes.push(movimentacao);
    });
    
    setIngredientes(novosIngredientes);
    setMovimentacoesStock(prev => [...prev, ...novasMovimentacoes]);
  };

  const recalcularMovimentacoes = () => {

    if (!window.confirm('‚ö†Ô∏è Isso ir√° recalcular todas as movimenta√ß√µes baseado nos dados atuais.\n\n‚úÖ Ser√£o recalculadas:\n- Entradas de compras\n- Sa√≠das de vendas\n\n‚ùå Ser√£o removidos:\n- Todos os ajustes manuais\n\nDeseja continuar?')) {

      return;
    }

    const novasMovimentacoes = [];

    faturas.forEach(fatura => {
      fatura.itens.forEach(item => {
        const ingrediente = ingredientes.find(ing => ing.id === item.ingredienteId);
        if (!ingrediente) return;

        const quantidadeConvertida = converterParaUnidadeBase(
          item.quantidade,
          item.unidade || ingrediente.unidade,
          ingrediente.unidade
        );
        
        const movimentacao = {
          id: Date.now() + Math.random(),
          data: fatura.data || new Date().toISOString().split('T')[0],
          tipo: 'entrada',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          quantidade: quantidadeConvertida,
          unidade: ingrediente.unidade,
          precoUnitario: item.precoTotal / item.quantidade,
          precoTotal: item.precoTotal,
          stockAnterior: 0, // Ser√° recalculado na ordena√ß√£o
          stockNovo: 0,     // Ser√° recalculado na ordena√ß√£o
          fornecedor: fatura.fornecedor || 'N/A',
          numeroDocumento: fatura.numeroDocumento || 'N/A',
          observacao: `Compra: +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
        };
        
        novasMovimentacoes.push(movimentacao);
      });
    });

    vendas.forEach(venda => {
      const produto = produtos.find(p => p.id === venda.produtoId);
      if (!produto || !produto.receita || produto.receita.length === 0) return;
      
      produto.receita.forEach(receitaItem => {
        const ingrediente = ingredientes.find(ing => ing.id === receitaItem.ingredienteId);
        if (!ingrediente) return;

        const quantidadeReceitaConvertida = converterParaUnidadeBase(
          receitaItem.quantidade,
          receitaItem.unidade || ingrediente.unidade,
          ingrediente.unidade
        );
        
        const quantidadeUsada = arredondar(quantidadeReceitaConvertida * venda.quantidade);
        
        const movimentacao = {
          id: Date.now() + Math.random(),
          data: venda.data || new Date().toISOString().split('T')[0],
          tipo: 'saida',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          quantidade: quantidadeUsada,
          unidade: ingrediente.unidade,
          stockAnterior: 0, // Ser√° recalculado na ordena√ß√£o
          stockNovo: 0,     // Ser√° recalculado na ordena√ß√£o
          produtoId: produto.id,
          produtoNome: produto.nome,
          quantidadeProdutos: venda.quantidade,
          observacao: `Venda: -${quantidadeUsada.toFixed(2)} ${ingrediente.unidade} (${venda.quantidade}x ${produto.nome})`
        };
        
        novasMovimentacoes.push(movimentacao);
      });
    });

    novasMovimentacoes.sort((a, b) => new Date(a.data) - new Date(b.data));
    
    const stocksPorIngrediente = {};
    
    novasMovimentacoes.forEach(mov => {
      if (!stocksPorIngrediente[mov.ingredienteId]) {
        stocksPorIngrediente[mov.ingredienteId] = 0;
      }
      
      mov.stockAnterior = stocksPorIngrediente[mov.ingredienteId];
      
      if (mov.tipo === 'entrada') {
        stocksPorIngrediente[mov.ingredienteId] += mov.quantidade;
      } else if (mov.tipo === 'saida') {
        stocksPorIngrediente[mov.ingredienteId] -= mov.quantidade; // ‚úÖ Permite negativos!
      }
      
      mov.stockNovo = stocksPorIngrediente[mov.ingredienteId];
    });

    const novosIngredientes = ingredientes.map(ing => ({
      ...ing,
      stockAtual: stocksPorIngrediente[ing.id] || 0
    }));

    setIngredientes(novosIngredientes);
    setMovimentacoesStock(novasMovimentacoes);

    alert(`‚úÖ Hist√≥rico recalculado com sucesso!\n\nüìä Total de movimenta√ß√µes: ${novasMovimentacoes.length}\n‚Üë Entradas: ${novasMovimentacoes.filter(m => m.tipo === 'entrada').length}\n‚Üì Sa√≠das: ${novasMovimentacoes.filter(m => m.tipo === 'saida').length}`);
  };

  const recalcularCustosProdutos = () => {

    if (!window.confirm('üí∞ Recalcular custos dos produtos?\n\n‚úÖ Isso vai:\n- Recalcular o custo de receita de todos os produtos\n- Atualizar as margens de lucro\n- Baseado nos custos ATUAIS dos ingredientes\n\nDeseja continuar?')) {

      return;
    }
    
    let atualizados = 0;
    let semReceita = 0;
    
    const novoProdutos = produtos.map(produto => {
      if (!produto.receita || produto.receita.length === 0) {
        semReceita++;
        return produto;
      }

      const custoTotal = produto.receita.reduce((total, item) => {
        const ing = ingredientes.find(i => i.id === item.ingredienteId);
        if (!ing) return total;
        
        let quantidade = parseFloat(item.quantidade) || 0;
        const precoUnit = parseFloat(ing.custoUnitario) || 0;

        const unidadeReceita = item.unidade || ing.unidade;
        if (ing.unidade === 'kg' && unidadeReceita === 'g') quantidade = quantidade / 1000;
        if (ing.unidade === 'L' && unidadeReceita === 'ml') quantidade = quantidade / 1000;
        if (ing.unidade === 'g' && unidadeReceita === 'kg') quantidade = quantidade * 1000;
        if (ing.unidade === 'ml' && unidadeReceita === 'L') quantidade = quantidade * 1000;
        
        return total + (quantidade * precoUnit);
      }, 0);

      const custoFinal = (produto.porcoes && produto.porcoes > 1) 
        ? custoTotal / produto.porcoes 
        : custoTotal;
      
      const custoAntigo = produto.custoReceita || 0;
      
      if (Math.abs(custoFinal - custoAntigo) > 0.01) {

        atualizados++;
      }
      
      return {
        ...produto,
        custoReceita: custoFinal,
        margemLucro: produto.precoVenda > 0 ? ((produto.precoVenda - custoFinal) / produto.precoVenda) * 100 : 0
      };
    });

    setProdutos(novoProdutos);
    
    showNotification(
      `‚úÖ Custos recalculados!\n\n${atualizados} produtos atualizados\n${semReceita} produtos sem receita`,
      'success'
    );

  };
  
  const removerMovimentacao = (movimentacaoId) => {
    const mov = movimentacoesStock.find(m => m.id === movimentacaoId);
    if (!mov) return;
    
    if (mov.tipo !== 'ajuste') {
      alert('‚ùå S√≥ √© poss√≠vel remover ajustes manuais.\n\nEntradas e sa√≠das s√£o geradas automaticamente das compras e vendas.');
      return;
    }
    
    if (!window.confirm(`üóëÔ∏è Remover ajuste manual?\n\nIngrediente: ${mov.ingredienteNome}\nQuantidade: ${mov.quantidade > 0 ? '+' : ''}${mov.quantidade.toFixed(2)} ${mov.unidade}\nData: ${new Date(mov.data).toLocaleDateString('pt-PT')}`)) {
      return;
    }

    const novasMovimentacoes = movimentacoesStock.filter(m => m.id !== movimentacaoId);

    const ingrediente = ingredientes.find(ing => ing.id === mov.ingredienteId);
    if (ingrediente) {
      const novosIngredientes = ingredientes.map(ing => {
        if (ing.id === mov.ingredienteId) {
          return {
            ...ing,
            stockAtual: arredondar((ing.stockAtual || 0) - mov.quantidade)
          };
        }
        return ing;
      });
      setIngredientes(novosIngredientes);
    }
    
    setMovimentacoesStock(novasMovimentacoes);
    alert('‚úÖ Ajuste manual removido com sucesso!');
  };

  
  /**
   * Iniciar nova sess√£o de invent√°rio f√≠sico
   * Ordena ingredientes por categoria e nome
   * Exclui categorias operacionais (limpeza, operacionais)
   */
  const iniciarInventario = () => {

    const ingredientesOrdenados = [...ingredientes]
      .filter(ing => !['limpeza', 'operacionais', 'embalagens'].includes(ing.categoria))
      .sort((a, b) => {

        if (a.categoria !== b.categoria) {
          return a.categoria.localeCompare(b.categoria);
        }
        return a.nome.localeCompare(b.nome);
      });
    
    if (ingredientesOrdenados.length === 0) {
      showNotification('‚ùå Nenhum ingrediente dispon√≠vel para invent√°rio!', 'error');
      return;
    }

    const sessao = {
      id: Date.now(),
      dataInicio: new Date().toISOString(),
      status: 'em_progresso',
      utilizador: dadosEmpresa.nome || 'Luis',
      ingredientes: ingredientesOrdenados.map(ing => {

        const movimentacoes = movimentacoesStock.filter(m => m.ingredienteId === ing.id);
        const ultimaCompra = movimentacoes
          .filter(m => m.tipo === 'entrada')
          .sort((a, b) => new Date(b.data) - new Date(a.data))[0];
        const ultimaVenda = movimentacoes
          .filter(m => m.tipo === 'saida')
          .sort((a, b) => new Date(b.data) - new Date(a.data))[0];
        
        return {
          ingredienteId: ing.id,
          ingredienteNome: ing.nome,
          categoria: ing.categoria,
          unidade: ing.unidade,
          custoUnitario: ing.custoUnitario || 0,
          stockTeorico: ing.stockAtual || 0,
          stockReal: null, // A preencher pelo utilizador
          variacao: null,
          variacaoPerc: null,
          variacaoEuros: null,
          timestamp: null,
          ultimaCompra: ultimaCompra ? {
            data: ultimaCompra.data,
            quantidade: ultimaCompra.quantidade,
            fornecedor: ultimaCompra.fornecedor
          } : null,
          ultimaVenda: ultimaVenda ? {
            data: ultimaVenda.data,
            quantidade: ultimaVenda.quantidade
          } : null
        };
      })
    };

    setInventarioAtivo(sessao);
    setIndiceAtualInventario(0);
    setInputStockReal('');
    setMostrarModalInventario(true);
    
    showNotification(
      `üìã Invent√°rio iniciado!\n\n${sessao.ingredientes.length} ingredientes para contar`,
      'success'
    );
  };
  
  /**
   * Registar stock real contado para o ingrediente atual
   * Calcula varia√ß√£o automaticamente
   */
  const registarStockReal = (stockReal) => {
    if (stockReal === null || stockReal === '') return;
    
    const stockRealNum = parseFloat(stockReal);
    if (isNaN(stockRealNum) || stockRealNum < 0) {
      showNotification('‚ö†Ô∏è Quantidade inv√°lida!', 'error');
      return;
    }
    
    const ingredienteAtual = inventarioAtivo.ingredientes[indiceAtualInventario];
    const variacao = arredondar(stockRealNum - ingredienteAtual.stockTeorico);
    const variacaoPerc = ingredienteAtual.stockTeorico > 0 
      ? ((variacao / ingredienteAtual.stockTeorico) * 100) 
      : 0;
    const variacaoEuros = variacao * ingredienteAtual.custoUnitario;
    
    const ingredienteAtualizado = {
      ...ingredienteAtual,
      stockReal: stockRealNum,
      variacao,
      variacaoPerc: arredondar(variacaoPerc),
      variacaoEuros: arredondar(variacaoEuros),
      timestamp: new Date().toISOString()
    };

    const novaSessao = { ...inventarioAtivo };
    novaSessao.ingredientes[indiceAtualInventario] = ingredienteAtualizado;
    setInventarioAtivo(novaSessao);

  };
  
  /**
   * Avan√ßar para pr√≥ximo ingrediente
   * Se for o √∫ltimo, finaliza o invent√°rio
   */
  const proximoIngredienteInventario = () => {

    if (inputStockReal !== '') {
      registarStockReal(inputStockReal);
    }
    
    setInputStockReal(''); // Limpar input
    
    if (indiceAtualInventario < inventarioAtivo.ingredientes.length - 1) {
      setIndiceAtualInventario(indiceAtualInventario + 1);
    } else {

      finalizarInventario();
    }
  };
  
  /**
   * Voltar para ingrediente anterior
   */
  const ingredienteAnteriorInventario = () => {
    if (indiceAtualInventario > 0) {
      setIndiceAtualInventario(indiceAtualInventario - 1);

      const ingAnterior = inventarioAtivo.ingredientes[indiceAtualInventario - 1];
      setInputStockReal(ingAnterior.stockReal !== null ? ingAnterior.stockReal.toString() : '');
    }
  };
  
  /**
   * Pular ingrediente atual sem contar
   */
  const pularIngredienteInventario = () => {
    setInputStockReal('');
    
    if (indiceAtualInventario < inventarioAtivo.ingredientes.length - 1) {
      setIndiceAtualInventario(indiceAtualInventario + 1);
    } else {
      finalizarInventario();
    }
  };
  
  /**
   * Finalizar invent√°rio e aplicar ajustes de stock
   * Cria movimenta√ß√µes tipo "ajuste" para cada varia√ß√£o
   */
  const finalizarInventario = () => {
    if (!inventarioAtivo) return;

    const sessaoConcluida = {
      ...inventarioAtivo,
      dataFim: new Date().toISOString(),
      status: 'concluida'
    };

    const ingredientesContados = sessaoConcluida.ingredientes.filter(i => i.stockReal !== null);
    
    if (ingredientesContados.length === 0) {
      if (!window.confirm('‚ö†Ô∏è Nenhum ingrediente foi contado.\n\nDeseja cancelar o invent√°rio?')) {
        return;
      }
      
      setMostrarModalInventario(false);
      setInventarioAtivo(null);
      setIndiceAtualInventario(0);
      setInputStockReal('');
      showNotification('‚ùå Invent√°rio cancelado', 'error');
      return;
    }

    const resumo = {
      totalIngredientes: sessaoConcluida.ingredientes.length,
      ingredientesContados: ingredientesContados.length,
      ingredientesPulados: sessaoConcluida.ingredientes.length - ingredientesContados.length,
      variacaoTotalKg: 0,
      variacaoTotalEuros: 0,
      excessoKg: 0,
      faltaKg: 0,
      excessoEuros: 0,
      faltaEuros: 0,
      categorias: {}
    };

    const novosIngredientes = [...ingredientes];
    const novasMovimentacoes = [];
    
    ingredientesContados.forEach(item => {

      resumo.variacaoTotalKg += item.variacao;
      resumo.variacaoTotalEuros += item.variacaoEuros;
      
      if (item.variacao > 0) {
        resumo.excessoKg += item.variacao;
        resumo.excessoEuros += item.variacaoEuros;
      } else {
        resumo.faltaKg += Math.abs(item.variacao);
        resumo.faltaEuros += Math.abs(item.variacaoEuros);
      }

      if (!resumo.categorias[item.categoria]) {
        resumo.categorias[item.categoria] = {
          total: 0,
          contados: 0,
          variacaoKg: 0,
          variacaoEuros: 0
        };
      }
      resumo.categorias[item.categoria].total++;
      resumo.categorias[item.categoria].contados++;
      resumo.categorias[item.categoria].variacaoKg += item.variacao;
      resumo.categorias[item.categoria].variacaoEuros += item.variacaoEuros;

      const index = novosIngredientes.findIndex(i => i.id === item.ingredienteId);
      if (index !== -1) {
        novosIngredientes[index] = {
          ...novosIngredientes[index],
          stockAtual: item.stockReal
        };
      }

      if (Math.abs(item.variacao) > 0.01) { // Ignorar varia√ß√µes < 0.01
        const ajuste = {
          id: Date.now() + Math.random(),
          data: new Date().toISOString(),
          tipo: 'ajuste',
          ingredienteId: item.ingredienteId,
          ingredienteNome: item.ingredienteNome,
          quantidade: item.variacao,
          unidade: item.unidade,
          stockAnterior: item.stockTeorico,
          stockNovo: item.stockReal,
          observacao: `Invent√°rio #${sessaoConcluida.id} - ${item.variacao > 0 ? 'Excedente' : 'Falta'}: ${Math.abs(item.variacao).toFixed(2)} ${item.unidade} (‚Ç¨${Math.abs(item.variacaoEuros).toFixed(2)})`
        };
        
        novasMovimentacoes.push(ajuste);
      }
    });

    resumo.variacaoTotalKg = arredondar(resumo.variacaoTotalKg);
    resumo.variacaoTotalEuros = arredondar(resumo.variacaoTotalEuros);
    resumo.excessoKg = arredondar(resumo.excessoKg);
    resumo.faltaKg = arredondar(resumo.faltaKg);
    resumo.excessoEuros = arredondar(resumo.excessoEuros);
    resumo.faltaEuros = arredondar(resumo.faltaEuros);
    
    Object.keys(resumo.categorias).forEach(cat => {
      resumo.categorias[cat].variacaoKg = arredondar(resumo.categorias[cat].variacaoKg);
      resumo.categorias[cat].variacaoEuros = arredondar(resumo.categorias[cat].variacaoEuros);
    });
    
    sessaoConcluida.resumo = resumo;

    setIngredientes(novosIngredientes);
    setMovimentacoesStock(prev => [...prev, ...novasMovimentacoes]);
    setContagensHistorico(prev => [...prev, sessaoConcluida]);

    setMostrarModalInventario(false);
    setInventarioAtivo(null);
    setIndiceAtualInventario(0);
    setInputStockReal('');

    const variacaoTexto = resumo.variacaoTotalEuros >= 0 
      ? `+‚Ç¨${resumo.variacaoTotalEuros.toFixed(2)} (excedente)`
      : `-‚Ç¨${Math.abs(resumo.variacaoTotalEuros).toFixed(2)} (falta)`;
    
    showNotification(
      `‚úÖ Invent√°rio conclu√≠do!\n\n` +
      `üìä ${ingredientesContados.length}/${resumo.totalIngredientes} ingredientes contados\n` +
      `üí∞ Varia√ß√£o total: ${variacaoTexto}\n` +
      `üìà Excesso: ‚Ç¨${resumo.excessoEuros.toFixed(2)}\n` +
      `üìâ Falta: ‚Ç¨${resumo.faltaEuros.toFixed(2)}`,
      'success'
    );
  };
  
  /**
   * Cancelar invent√°rio em progresso
   */
  const cancelarInventario = () => {
    if (!window.confirm(
      '‚ö†Ô∏è Tem certeza que deseja cancelar o invent√°rio?\n\n' +
      'Todo o progresso ser√° perdido.'
    )) {
      return;
    }
    
    setMostrarModalInventario(false);
    setInventarioAtivo(null);
    setIndiceAtualInventario(0);
    setInputStockReal('');
    
    showNotification('‚ùå Invent√°rio cancelado', 'error');
  };
  
  /**
   * Exportar relat√≥rio de invent√°rio para texto
   */
  const exportarRelatorioInventario = (contagem) => {
    const ingredientesContados = contagem.ingredientes.filter(i => i.stockReal !== null);
    const ingredientesComVariacao = ingredientesContados.filter(i => Math.abs(i.variacao) > 0.01);
    const discrepanciasCriticas = ingredientesComVariacao.filter(i => Math.abs(i.variacaoPerc) > 10);
    
    let relatorio = '';
    relatorio += '‚ïê'.repeat(70) + '\n';
    relatorio += '         RELAT√ìRIO DE INVENT√ÅRIO F√çSICO\n';
    relatorio += '‚ïê'.repeat(70) + '\n\n';

    relatorio += `üìÖ Data: ${new Date(contagem.dataInicio).toLocaleString('pt-PT')}\n`;
    if (contagem.dataFim) {
      const duracao = new Date(contagem.dataFim) - new Date(contagem.dataInicio);
      const minutos = Math.floor(duracao / 60000);
      relatorio += `‚è±Ô∏è Dura√ß√£o: ${minutos} minutos\n`;
    }
    relatorio += `üë§ Respons√°vel: ${contagem.utilizador}\n`;
    relatorio += `üÜî ID: #${contagem.id}\n\n`;

    relatorio += '‚îÄ'.repeat(70) + '\n';
    relatorio += 'RESUMO GERAL\n';
    relatorio += '‚îÄ'.repeat(70) + '\n';
    relatorio += `Total de Ingredientes: ${contagem.resumo.totalIngredientes}\n`;
    relatorio += `Ingredientes Contados: ${contagem.resumo.ingredientesContados}\n`;
    relatorio += `Ingredientes Pulados: ${contagem.resumo.ingredientesPulados}\n`;
    relatorio += `Varia√ß√£o Total: ‚Ç¨${contagem.resumo.variacaoTotalEuros.toFixed(2)} ${contagem.resumo.variacaoTotalEuros >= 0 ? '(excedente)' : '(falta)'}\n`;
    relatorio += `  ‚îú‚îÄ Excesso: ‚Ç¨${contagem.resumo.excessoEuros.toFixed(2)}\n`;
    relatorio += `  ‚îî‚îÄ Falta: ‚Ç¨${contagem.resumo.faltaEuros.toFixed(2)}\n\n`;

    relatorio += '‚îÄ'.repeat(70) + '\n';
    relatorio += 'VARIA√á√ïES POR CATEGORIA\n';
    relatorio += '‚îÄ'.repeat(70) + '\n';
    
    Object.entries(contagem.resumo.categorias)
      .sort((a, b) => Math.abs(b[1].variacaoEuros) - Math.abs(a[1].variacaoEuros))
      .forEach(([cat, dados]) => {
        if (Math.abs(dados.variacaoEuros) > 0.01) {
          relatorio += `\n${cat.toUpperCase()}:\n`;
          relatorio += `  Contados: ${dados.contados}/${dados.total}\n`;
          relatorio += `  Varia√ß√£o: ${dados.variacaoKg >= 0 ? '+' : ''}${dados.variacaoKg.toFixed(2)} kg\n`;
          relatorio += `  Valor: ${dados.variacaoEuros >= 0 ? '+' : ''}‚Ç¨${dados.variacaoEuros.toFixed(2)}\n`;
        }
      });

    if (discrepanciasCriticas.length > 0) {
      relatorio += '\n' + '‚îÄ'.repeat(70) + '\n';
      relatorio += 'DISCREP√ÇNCIAS CR√çTICAS (>10%)\n';
      relatorio += '‚îÄ'.repeat(70) + '\n';
      relatorio += 'Ingrediente'.padEnd(25) + 'Te√≥rico'.padEnd(12) + 'Real'.padEnd(12) + 'Varia√ß√£o'.padEnd(12) + 'Valor\n';
      relatorio += '‚îÄ'.repeat(70) + '\n';
      
      discrepanciasCriticas
        .sort((a, b) => Math.abs(b.variacaoPerc) - Math.abs(a.variacaoPerc))
        .forEach(item => {
          const nome = item.ingredienteNome.length > 23 ? item.ingredienteNome.substring(0, 20) + '...' : item.ingredienteNome;
          relatorio += nome.padEnd(25);
          relatorio += `${item.stockTeorico.toFixed(1)} ${item.unidade}`.padEnd(12);
          relatorio += `${item.stockReal.toFixed(1)} ${item.unidade}`.padEnd(12);
          relatorio += `${item.variacaoPerc >= 0 ? '+' : ''}${item.variacaoPerc.toFixed(0)}%`.padEnd(12);
          relatorio += `‚Ç¨${item.variacaoEuros.toFixed(2)}\n`;
        });
    }

    if (ingredientesComVariacao.length > 0) {
      relatorio += '\n' + '‚îÄ'.repeat(70) + '\n';
      relatorio += 'DETALHES COMPLETOS - INGREDIENTES COM VARIA√á√ÉO\n';
      relatorio += '‚îÄ'.repeat(70) + '\n';
      relatorio += 'Ingrediente'.padEnd(25) + 'Te√≥rico'.padEnd(12) + 'Real'.padEnd(12) + 'Varia√ß√£o'.padEnd(12) + 'Valor\n';
      relatorio += '‚îÄ'.repeat(70) + '\n';
      
      ingredientesComVariacao
        .sort((a, b) => a.categoria.localeCompare(b.categoria) || a.ingredienteNome.localeCompare(b.ingredienteNome))
        .forEach(item => {
          const nome = item.ingredienteNome.length > 23 ? item.ingredienteNome.substring(0, 20) + '...' : item.ingredienteNome;
          relatorio += nome.padEnd(25);
          relatorio += `${item.stockTeorico.toFixed(2)} ${item.unidade}`.padEnd(12);
          relatorio += `${item.stockReal.toFixed(2)} ${item.unidade}`.padEnd(12);
          relatorio += `${item.variacao >= 0 ? '+' : ''}${item.variacao.toFixed(2)} ${item.unidade}`.padEnd(12);
          relatorio += `‚Ç¨${item.variacaoEuros.toFixed(2)}\n`;
        });
    }
    
    relatorio += '\n' + '‚ïê'.repeat(70) + '\n';
    relatorio += 'FIM DO RELAT√ìRIO\n';
    relatorio += '‚ïê'.repeat(70) + '\n';

    const blob = new Blob([relatorio], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Inventario_${contagem.id}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('üìÑ Relat√≥rio exportado com sucesso!', 'success');
  };

  const calcularDesperdicio = (ingrediente) => {
    if (!ingrediente.id) return null;

    if (['limpeza', 'operacionais', 'embalagens'].includes(ingrediente.categoria)) {
      return {
        stockTeorico: ingrediente.stockAtual || 0,
        stockReal: ingrediente.stockAtual || 0,
        desperdicio: 0,
        percentualDesperdicio: 0,
        temDados: false,
        isOperacional: true // Flag para identificar
      };
    }
    
    const movimentacoesIngrediente = movimentacoesStock.filter(m => m.ingredienteId === ingrediente.id);
    
    if (movimentacoesIngrediente.length === 0) {
      return {
        stockTeorico: ingrediente.stockAtual || 0,
        stockReal: ingrediente.stockAtual || 0,
        desperdicio: 0,
        percentualDesperdicio: 0,
        temDados: false
      };
    }
    
    let stockTeorico = 0;
    movimentacoesIngrediente.forEach(mov => {
      if (mov.tipo === 'entrada') {
        stockTeorico += mov.quantidade;
      } else if (mov.tipo === 'saida') {
        stockTeorico -= mov.quantidade;
      } else if (mov.tipo === 'ajuste') {
        stockTeorico += mov.quantidade; // ajuste pode ser + ou -
      }
    });
    
    const stockReal = ingrediente.stockAtual || 0;
    const desperdicio = Math.max(0, stockTeorico - stockReal);
    const percentualDesperdicio = stockTeorico > 0 ? (desperdicio / stockTeorico) * 100 : 0;
    
    return {
      stockTeorico,
      stockReal,
      desperdicio,
      percentualDesperdicio: parseFloat(percentualDesperdicio.toFixed(2)),
      temDados: true
    };
  };

  const calcularConsumoMedio = (ingrediente) => {
    if (!ingrediente.id) return null;

    if (!['limpeza', 'operacionais'].includes(ingrediente.categoria)) {
      return null;
    }

    const compras = movimentacoesStock
      .filter(m => m.ingredienteId === ingrediente.id && m.tipo === 'entrada')
      .sort((a, b) => new Date(b.data) - new Date(a.data)); // Mais recente primeiro
    
    if (compras.length < 2) {
      return {
        consumoDiario: 0,
        diasParaAcabar: 0,
        proximaCompraPrevista: null,
        temDados: false
      };
    }

    const intervalos = [];
    for (let i = 0; i < compras.length - 1; i++) {
      const dataAtual = new Date(compras[i].data);
      const dataAnterior = new Date(compras[i + 1].data);
      const diffTime = Math.abs(dataAtual - dataAnterior);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > 0 && diffDays < 365) { // Valida√ß√£o: entre 1 dia e 1 ano
        intervalos.push({
          dias: diffDays,
          quantidade: compras[i + 1].quantidade // Quantidade que durou esse per√≠odo
        });
      }
    }
    
    if (intervalos.length === 0) {
      return {
        consumoDiario: 0,
        diasParaAcabar: 0,
        proximaCompraPrevista: null,
        temDados: false
      };
    }

    const consumoTotal = intervalos.reduce((sum, int) => sum + int.quantidade, 0);
    const diasTotal = intervalos.reduce((sum, int) => sum + int.dias, 0);
    const consumoDiario = consumoTotal / diasTotal;

    const stockAtual = ingrediente.stockAtual || 0;
    const diasParaAcabar = consumoDiario > 0 ? Math.floor(stockAtual / consumoDiario) : 0;
    
    const hoje = new Date();
    const proximaCompraPrevista = new Date(hoje.getTime() + (diasParaAcabar * 24 * 60 * 60 * 1000));
    
    return {
      consumoDiario: parseFloat(consumoDiario.toFixed(3)),
      diasParaAcabar,
      proximaCompraPrevista: proximaCompraPrevista.toISOString().split('T')[0],
      temDados: true,
      ultimasCompras: compras.slice(0, 3).map(c => ({
        data: c.data,
        quantidade: c.quantidade
      }))
    };
  };

  const gerarAlertasCriticos = () => {
    const alertas = [];
    
    ingredientes.forEach(ingrediente => {
      const stockAtual = ingrediente.stockAtual || 0;
      const stockMinimo = ingrediente.stockMinimo || 0;
      
      if (stockAtual === 0 && stockMinimo > 0) {
        alertas.push({
          id: `critical-${ingrediente.id}`,
          tipo: 'sem_stock',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          mensagem: `‚ùå SEM STOCK: ${ingrediente.nome}`,
          stockAtual: 0,
          unidade: ingrediente.unidade
        });
      } else if (stockAtual <= stockMinimo * 0.5 && stockMinimo > 0) {
        alertas.push({
          id: `low-${ingrediente.id}`,
          tipo: 'stock_critico',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          mensagem: `‚ö†Ô∏è Stock cr√≠tico: ${ingrediente.nome} (${stockAtual.toFixed(2)} ${ingrediente.unidade})`,
          stockAtual: stockAtual,
          stockMinimo: stockMinimo,
          unidade: ingrediente.unidade
        });
      }
    });
    
    return alertas;
  };

  useEffect(() => {
    if (stockRastreamentoAtivo) {
      const alertasCriticos = gerarAlertasCriticos();
      setAlertasStock(alertasCriticos);
    }
  }, [ingredientes, stockRastreamentoAtivo]);

  const [dadosEmpresa, setDadosEmpresa] = useState({
    nif: '',
    nome: '',
    morada: '',
    codigoPostal: '',
    cidade: '',
    cae: '',
    email: '',
    telefone: ''
  });

  const [faturas, setFaturas] = useState([]);

  const MAPEAMENTO_PRODUTOS = {"Expresso":"Caf√© Expresso","Bica/Expresso":"Caf√© Expresso","Expresso Take Away":"Caf√© Expresso Take Away","Expresso TG":"Caf√© Expresso Take Away","Bica/Take Away":"Caf√© Expresso Take Away","Meia De Leite":"Meia de Leite","Meia Leite":"Meia de Leite","Meia de Leite/White Coffee":"Meia de Leite","Meia de Leite Take Away":"Meia de Leite Take Away","Meia de Leite/White Coffee Take Away":"Meia de Leite Take Away","Capuccino":"Cappuccino","Cappuccino Take Away":"Cappuccino Take Away","Americano Take Away":"Americano Take Away","Americano/Black Coffee":"Americano","Descafeinado/Decaf":"Descafeinado","Matcha com Leite/Matcha Latte":"Matcha Latte","Matcha com Leite/Matcha Latte Take Away":"Matcha Latte Take Away","Matcha":"Matcha Latte","Matcha TG":"Matcha Latte Take Away","Cha/Tea":"Ch√°","Sumo de Laranja":"Sumo Laranja","Sumo de Laranja/Orange Juice":"Sumo Laranja","Sumo de Laranja Take Away":"Sumo Laranja Take Away","Sumo de Laranja/Take Away":"Sumo Laranja Take Away","Sumo Laranja TG":"Sumo Laranja Take Away","Sumo Caseiro Take Away":"Sumo Caseiro Take Away","Sumo Caseiro/Home made juice Take Away":"Sumo Caseiro Take Away","Sumo Caseiro TG":"Sumo Caseiro Take Away","Mojito Picante/Spicy Mojito":"Spicy Mojito","Mojito Spicy":"Spicy Mojito","Mojito S/ Alcool":"Mojito Sem √Ålcool","Agua 1.5l":"√Ågua 1.5L","Agua Penacova 1.5L":"√Ågua 1.5L","Agua/Water 0.33l":"√Ågua 50cl","Aguas Penacova 33":"√Ågua 50cl","Aguas Penacova 50cl":"√Ågua 50cl","√Ågua Com G√°s":"√Ågua com G√°s","Agua com Gas Castello 25cl":"√Ågua com G√°s","Agua com Gas/Sparkling Water 0.33l":"√Ågua com G√°s","√Ågua com G√°s 33cl":"√Ågua com G√°s","√Ågua com G√°s 25cl":"√Ågua com G√°s","Cerveja Super Bock/Beer Super Bock 33l":"Cerveja Super Bock","Super Bock":"Cerveja Super Bock","Super Bock 33cl":"Cerveja Super Bock","Super Bock Stout":"Cerveja Super Bock Stout","Cerveja Preta/Stout":"Cerveja Super Bock Stout","Cerveja Artesanal 33l":"Cerveja Artesanal Mania","Cerveja Artesanal/Craft Beer 33l":"Cerveja Artesanal Mania","Castelo Rodrigo (branco) Garrafa":"Castelo Rodrigo Branco Garrafa","Castelo Rogrido Branco Copo":"Castelo Rodrigo Branco Copo","Castelo Rodrigo Branco Copo":"Castelo Rodrigo Branco Copo","Castelo Rodrigo 100% Touriga Nacional Tinto (Beira Interior)":"Castelo Rodrigo Tinto Copo","Castelo Rodrigo Tinto Garrafa":"Castelo Rodrigo Tinto Garrafa","Castelo Rodrigo Tinto Copo":"Castelo Rodrigo Tinto Copo","Convento Aguiar Reserva Branco (Beira Interior)":"Convento Aguiar Branco Copo","Convento Aguiar Branco Garrafa":"Convento Aguiar Branco Garrafa","Convento Aguiar Branco Copo":"Convento Aguiar Branco Copo","Ladeira Santa Branco (Garrafa)":"Ladeira Santa Branco Garrafa","Ladeira da Santa Colheita Branco (Dao)":"Ladeira Santa Branco Copo","Ladeira Santa Branco Copo":"Ladeira Santa Branco Copo","Ladeira da Santa 2023 Tinto (Dao)":"Ladeira Santa Tinto Copo","Ladeira da Santa Encruzado 2023 Tinto (Dao)":"Ladeira Santa Tinto Copo","Ladeira Santa Tinto Garrafa":"Ladeira Santa Tinto Garrafa","Ladeira Santa Tinto Copo":"Ladeira Santa Tinto Copo","Ladeira Santa Rose Copo":"Ladeira Santa Ros√© Copo","Ladeira da Santa Rose (Dao)":"Ladeira Santa Ros√© Copo","Ladeira Santa Ros√© Copo":"Ladeira Santa Ros√© Copo","Ladeira Santa Ros√© Garrafa":"Ladeira Santa Ros√© Garrafa","Falat√≥rio Bastardo Tinto (Lisboa)":"Falat√≥rio Bastardo Tinto Copo","Falat√≥rio Bastardo Tinto Garrafa":"Falat√≥rio Bastardo Tinto Garrafa","Falat√≥rio Bastardo Tinto Copo":"Falat√≥rio Bastardo Tinto Copo","Aromas 4u Verde Copo":"Aromas4U Sentido Verde Copo","Aromas4U Sentido (Verde)":"Aromas4U Sentido Verde Copo","Aromas4U Sentido Verde Garrafa":"Aromas4U Sentido Verde Garrafa","Aromas4U Sentido Verde Copo":"Aromas4U Sentido Verde Copo","Ovos Turcos / Turkish Eggs":"Ovos Turcos","Ovos Turcos / Turkish Eggs s/picante":"Ovos Turcos","Croissant":"Olh'√≥ Croissant","Extra Croissant":"Olh'√≥ Croissant","Croque Monsieur":"Croque Monsieur Munchi","Croque Monsiur":"Croque Monsieur Munchi","Tosta de Abacate":"Tosta Abacate","Tosta Aberta de Abacate":"Tosta Abacate","Tosta de Requeij√£o":"Tosta Requeij√£o","Tosta Aberta de Requeij√£o":"Tosta Requeij√£o","Tosta Amendoim":"Tosta Manteiga Amendoim","Tosta Aberta de Manteiga de Amendoim":"Tosta Manteiga Amendoim","Wrap":"Wrap Ovo","Burrito":"Wrap Ovo","Rolos Crocantes picantes":"Rolos Crocantes Picante","Rolos Crocantes Picante":"Rolos Crocantes Picante","Rolos Crocantes":"Rolos Crocantes","Queijo Chevre":"Queijo Ch√®vre Flambeado","Queijo Chevre Flambeado":"Queijo Ch√®vre Flambeado","Sandes Polvo":"Sandes de Polvo","Sandes de Presunto, Brie e Mel":"Sandes Presunto TA","Sandes de Salm√£o Fumado e Salada de Ovo":"Sandes Salm√£o TA","Salada de Queijo Burrata com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata e P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada Burrata":"Salada P√™ssegos Grelhados","Salada Burrata C/Presunto":"Salada P√™ssegos Grelhados","Salada de Burrata e P√™ssego Grelhado C/ Presunto":"Salada P√™ssegos Grelhados","Salada de Queijo Feta com P√™ssego":"Salada P√™ssegos Grelhados","Salada Feta":"Salada P√™ssegos Grelhados","Salada de Queijo com P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada Extra":"Salada P√™ssegos Grelhados","Bolo de Lim√£o/Lemon Cake":"Bolo de Lim√£o com Mirtilos","Bolo Lim√£o":"Bolo de Lim√£o com Mirtilos","Bolo Chocolate":"Bolo de Chocolate com Caramelo Salgado","Red Velvet":"Bolo Red Velvet com Frutos Vermelhos","Bolo Banana":"Bolo de Banana","Bolo Bolacha":"Bolo de Bolacha","Cheesecake Frutos Vermelhos":"Cheesecake de Frutos Vermelhos","Cheesecake Frutos Tropicais":"Cheesecake de Frutos Tropicais","Cheesecake frutos tropicais":"Cheesecake de Frutos Tropicais","Cheesecake Matcha":"Cheesecake de Matcha","Cheesecake Matcha Manga e Maracuja":"Cheesecake de Matcha","Cheesecake Merengue queimado":"Cheesecake Merengue Queimado","Pavlova":"Mini Pavlova de Frutos Vermelhos","Pudim Chia Frutos Vermelhos":"Pudim Chia","Pudim Chia com Matcha":"Pudim Chia Matcha","Pudin Chia Vegan":"Pudim Chia","Cebola 100":"Chutney Cebola 100ml","Cebola 100 ml":"Chutney Cebola 100ml","Cebola 250":"Chutney Cebola 250ml","Cebola 250 ml":"Chutney Cebola 250ml","Chipotle 100":"Chutney Chipotle 100ml","Chipotle 100 ml":"Chutney Chipotle 100ml","Chipotle 250":"Chutney Chipotle 250ml","Chipotle 250 ml":"Chutney Chipotle 250ml","Jalape√±os Verdes 100":"Chutney Jalape√±os Verde 100ml","Jalapenos Verde 100 ml":"Chutney Jalape√±os Verde 100ml","Jalape√±os Verdes 250":"Chutney Jalape√±os Verde 250ml","Jalapenos Verde 250 ml":"Chutney Jalape√±os Verde 250ml","Jalape√±os Vermelhos 100":"Chutney Jalape√±os Vermelho 100ml","Jalapenos Vermelhos 100 ml":"Chutney Jalape√±os Vermelho 100ml","Jalape√±os Vermelho 250":"Chutney Jalape√±os Vermelho 250ml","Jalapenos Vermelhos 250 ml":"Chutney Jalape√±os Vermelho 250ml","Pimentos Vermelhos 100":"Chutney Pimentos 100ml","Pimentos Vermelhos 100ml":"Chutney Pimentos 100ml","Pimentos Vermelhos 250ml":"Chutney Pimentos 250ml","Ab√≥bora 100":"Compota Ab√≥bora 100ml","Abobora 100 ml":"Compota Ab√≥bora 100ml","Ab√≥bora 250":"Compota Ab√≥bora 250ml","Abobora 250 ml":"Compota Ab√≥bora 250ml","Figo 100":"Compota Figo 100ml","Figo 250":"Compota Figo 250ml","Tomate 100":"Compota Tomate 100ml","Tomate 100 ml":"Compota Tomate 100ml","Tomate 250":"Compota Tomate 250ml","Tomate 250 ml":"Compota Tomate 250ml","Laranja 100":"Compota Laranja 100ml","Laranja 100 ml":"Compota Laranja 100ml","Laranja 250":"Compota Laranja 250ml","Laranja 250 ml":"Compota Laranja 250ml","Piri Piri":"Piri Piri Medronho","Piri Piri Medronho":"Piri Piri Medronho"};
  
  const mapearNomeProduto = (nome) => MAPEAMENTO_PRODUTOS[nome] || nome;

  const findBestMatchProduto = (nomeProduto, produtos) => {
    if (!nomeProduto || !produtos || produtos.length === 0) return null;
    
    const normalize = (str) => {
      return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
    };
    
    const nomeNorm = normalize(nomeProduto);
    
    for (const prod of produtos) {
      if (normalize(prod.nome) === nomeNorm) {
        return { id: prod.id, nome: prod.nome, confianca: 100, metodo: 'exato' };
      }
    }
    
    const fuzz = window.fuzzball || window.fuzz;
    if (!fuzz) return null;
    
    let bestMatch = null;
    let bestScore = 0;
    
    for (const prod of produtos) {
      const prodNorm = normalize(prod.nome);
      let score = fuzz.ratio(nomeNorm, prodNorm);
      
      if (nomeNorm.includes(prodNorm) || prodNorm.includes(nomeNorm)) {
        score = Math.min(100, score + 10);
      }
      
      if (nomeNorm.length >= 4 && prodNorm.length >= 4 && nomeNorm.substring(0, 4) === prodNorm.substring(0, 4)) {
        score = Math.min(100, score + 5);
      }
      
      if (score > bestScore) {
        bestScore = score;
        bestMatch = { id: prod.id, nome: prod.nome, confianca: Math.round(score), metodo: 'fuzzy' };
      }
    }
    
    return bestScore >= 70 ? bestMatch : null;
  };
  
  const [mostrarImportacao, setMostrarImportacao] = useState(false);
  const [fonteImportacao, setFonteImportacao] = useState('moloni');
  const [ultimaImportacaoMoloni, setUltimaImportacaoMoloni] = useState(null);
  const [ultimaImportacaoZobaze, setUltimaImportacaoZobaze] = useState(null);
  const [fornecedoresExpandidos, setFornecedoresExpandidos] = useState({});
  const [mostrarBreakdownFinanceiro, setMostrarBreakdownFinanceiro] = useState(false);

  const importarVendasCSV = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const texto = e.target.result;
        const linhas = texto.split('\n');
        const vendasImportadas = [];
        let statsDicionario = 0, statsFuzzy = 0, statsExato = 0, statsSemMatch = 0;

        let startLine = 0;
        for (let i = 0; i < linhas.length; i++) {
          if (linhas[i].includes('"Data"') && linhas[i].includes('"Artigo"') && linhas[i].includes('"Tipo de Documento"')) {
            startLine = i + 1;

            break;
          }
        }
        
        if (startLine === 0) {
          alert('‚ùå CSV n√£o reconhecido!\n\nUsa: Moloni ‚Üí An√°lise por Artigo ‚Üí Marca "Mostrar detalhes" ‚Üí Exporta CSV');
          return;
        }

        for (let i = startLine; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;

          if (linha.includes('"Resumo Artigo"') || linha.includes('"Detalhes"') || linha.includes('"Qtd. Docs."')) {
            continue;
          }
          
          const campos = linha.split(';').map(c => c.replace(/"/g, '').trim());
          if (campos.length < 12) continue; // Precisa ter pelo menos 12 campos
          
          const data = campos[0];
          const nomeProduto = campos[1];

          if (!data || !nomeProduto || !data.match(/\d{2}-\d{2}-\d{4}/)) continue;

          let quantidadeStr = campos[10] || '';
          let quantidade = 1;
          if (quantidadeStr) {
            quantidadeStr = quantidadeStr.replace(/Uni\.|kg|l|ml/gi, '').replace(',', '.').trim();
            const qtd = parseFloat(quantidadeStr);
            if (!isNaN(qtd) && qtd > 0) {
              quantidade = qtd;
            }
          }

          const valorStr = (campos[11] || '').replace(',', '.').replace('‚Ç¨', '').replace('\\x80', '').trim();
          const valor = parseFloat(valorStr);
          
          if (isNaN(valor) || valor <= 0) continue;

          let produto = null, confianca = 0, metodoMatch = 'nenhum';

          if (vendasImportadas.length < 5) {

          }

          const nomeCorrigido = mapearNomeProduto(nomeProduto);
          if (nomeCorrigido !== nomeProduto) {
            if (vendasImportadas.length < 5) {

            }

            const normalize = (str) => str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
            produto = produtos.find(p => normalize(p.nome) === normalize(nomeCorrigido));
            if (produto) {
              confianca = 100;
              metodoMatch = 'dicionario';
              statsDicionario++;
              if (vendasImportadas.length < 5) {

              }
            } else {
              if (vendasImportadas.length < 5) {

              }
            }
          }

          if (!produto) {
            const match = findBestMatchProduto(nomeProduto, produtos);
            if (match) {
              produto = produtos.find(p => p.id === match.id);
              confianca = match.confianca;
              metodoMatch = match.metodo;
              if (match.metodo === 'exato') {
                statsExato++;
              } else {
                statsFuzzy++;
              }
              if (vendasImportadas.length < 5) {

              }
            } else {
              statsSemMatch++;
              if (vendasImportadas.length < 5) {

              }
            }
          }

          let dataFormatada = data;
          if (data.match(/\d{2}-\d{2}-\d{4}/)) {
            const parts = data.split('-');
            dataFormatada = parts[2] + '-' + parts[1] + '-' + parts[0];
          }

          vendasImportadas.push({
            id: Date.now() + Math.random(),
            data: dataFormatada,
            produto: produto?.nome || nomeProduto,
            produtoId: produto?.id || null,
            quantidade: quantidade,
            valor: valor,
            iva: produto?.iva || 6,
            origem: fonteImportacao,
            confiancaMatch: confianca,
            metodoMatch: metodoMatch,
            nomeOriginalCSV: nomeProduto
          });
        }
        
        if (vendasImportadas.length > 0) {

          const datasMaisRecentes = vendasImportadas
            .map(v => v.data)
            .filter(d => d)
            .sort((a, b) => new Date(b) - new Date(a));
          
          if (datasMaisRecentes.length > 0) {
            setUltimaImportacaoMoloni(datasMaisRecentes[0]);
          }
          
          setVendas([...vendas, ...vendasImportadas]);
          setMostrarImportacao(false);
          
          const total = statsDicionario + statsExato + statsFuzzy;
          const pct = total > 0 ? Math.round(total/vendasImportadas.length*100) : 0;
          
          showNotification(
            '‚úÖ ' + vendasImportadas.length + ' vendas importadas!\n' +
            '‚úì ' + total + ' emparelhadas (' + pct + '%)\n' +
            '  ‚Ä¢ ' + statsDicionario + ' dicion√°rio\n' +
            '  ‚Ä¢ ' + statsExato + ' exato\n' +
            '  ‚Ä¢ ' + statsFuzzy + ' fuzzy\n' +
            (statsSemMatch > 0 ? '‚ö†Ô∏è ' + statsSemMatch + ' sem match' : ''),
            total === vendasImportadas.length ? 'success' : 'warning'
          );

          if (statsSemMatch > 0) {

          }
        } else {
          alert('‚ùå Nenhuma venda v√°lida encontrada no CSV');
        }
      } catch (error) {
        console.error('‚ùå Erro ao importar:', error);
        alert('‚ùå Erro ao importar: ' + error.message);
      }
    };
    reader.readAsText(file, 'ISO-8859-1');
  };
  const [novaFatura, setNovaFatura] = useState({
    numero: '',
    tipoDocumento: 'FT', // FT, FR, FS, etc.
    data: new Date().toISOString().split('T')[0],
    fornecedorId: '',
    itens: [],
    notas: '',
    categoria: 'compras', // compras, renda, eletricidade, agua, gas, internet, salarios, marketing, consumiveis, manutencao, outros
    recorrente: false, // se repete mensalmente
    diaRecorrencia: 1, // dia do m√™s para repetir (1-31)
    documentoPDF: null, // PDF da fatura em base64
    nomeDocumento: '' // Nome original do ficheiro PDF
  });
  const [itemFatura, setItemFatura] = useState({
    ingredienteId: '',
    descricao: '', // Para despesas n√£o-compras
    quantidade: '',
    unidade: '',
    precoTotal: '',
    iva: '13',
    num_funcionarios: 1 // Para sal√°rios
  });
  const [criandoIngrediente, setCriandoIngrediente] = useState(false); // Modo cria√ß√£o inline
  const [showDropdownIngrediente, setShowDropdownIngrediente] = useState(false); // Controla dropdown
  const [expandedFatura, setExpandedFatura] = useState(null);
  const [categoriaFaturaFiltro, setCategoriaFaturaFiltro] = useState(null); // üÜï Filtro por categoria de despesa
  const [searchFatura, setSearchFatura] = useState(''); // ‚úÖ SEARCH BOX FATURAS
  const [editandoFatura, setEditandoFatura] = useState(false);
  const [editandoItemId, setEditandoItemId] = useState(null); // ID do item sendo editado
  const [itemEditTemp, setItemEditTemp] = useState(null); // Dados tempor√°rios do item em edi√ß√£o
  const [modoFormulario, setModoFormulario] = useState('completo'); // 'completo' ou 'rapido'
  const [dadosEmpresaExpanded, setDadosEmpresaExpanded] = useState(false);
  const [configuracoesExpanded, setConfiguracoesExpanded] = useState(false);
  const [categoriaFiltroDesempenho, setCategoriaFiltroDesempenho] = useState('todos');
  const [mesSelecionado, setMesSelecionado] = useState(new Date().getMonth());
  const [anoSelecionado, setAnoSelecionado] = useState(new Date().getFullYear());
  
  const [backupExpanded, setBackupExpanded] = useState(false);
  const [driveBackups, setDriveBackups] = useState([]); // üÜï Lista de backups dispon√≠veis
  const [showBackupRecovery, setShowBackupRecovery] = useState(false); // üÜï Modal de recovery
  const [loadingBackups, setLoadingBackups] = useState(false); // üÜï Loading ao listar backups
  const [exportarExpanded, setExportarExpanded] = useState(false);
  const [exportDateStart, setExportDateStart] = useState('');
  const [exportDateEnd, setExportDateEnd] = useState('');

  const [anoFaturaSelecionado, setAnoFaturaSelecionado] = useState(new Date().getFullYear());
  const [mesFaturaSelecionado, setMesFaturaSelecionado] = useState(null);
  const [fornecedorFiltro, setFornecedorFiltro] = useState('');

  const [ultimaFaturaInserida, setUltimaFaturaInserida] = useState(null);

  React.useEffect(() => {
    if (faturas.length === 0) return;

    const anosDisponiveis = [...new Set(
      faturas
        .filter(f => f.data)
        .map(f => new Date(f.data).getFullYear())
        .filter(ano => !isNaN(ano))
    )].sort((a, b) => b - a);

    if (anosDisponiveis.length > 0 && !anosDisponiveis.includes(anoFaturaSelecionado)) {

      setAnoFaturaSelecionado(anosDisponiveis[0]); // Ano mais recente
    }
  }, [faturas.length, faturas]); // Trigger quando faturas mudarem

  const [mostrarModalOCR, setMostrarModalOCR] = useState(false);
  const [linhasOCR, setLinhasOCR] = useState([]);
  const [metadataOCR, setMetadataOCR] = useState(null);
  const [processandoOCR, setProcessandoOCR] = useState(false);
  const [progressoOCR, setProgressoOCR] = useState('');

  useEffect(() => {
    const savedConfig = localStorage.getItem('configuracaoWaste');
    if (savedConfig) {
      try {
        setConfiguracaoWaste(JSON.parse(savedConfig));
      } catch (e) {
        console.error('Erro ao carregar configura√ß√£o waste:', e);
      }
    }
    
    const savedContagens = localStorage.getItem('contagens');
    if (savedContagens) {
      try {
        setContagens(JSON.parse(savedContagens));
      } catch (e) {
        console.error('Erro ao carregar contagens:', e);
      }
    }
  }, []);

  useEffect(() => {

  }, []);

  useEffect(() => {

    const precisaInicializar = ingredientes.some(ing => ing.modoWaste === undefined);
    
    if (precisaInicializar && ingredientes.length > 0) {

      const ingredientesInicializados = ingredientes.map(inicializarIngrediente);
      setIngredientes(ingredientesInicializados);
    }
  }, [ingredientes.length]); // Apenas quando o n√∫mero de ingredientes mudar
;
  
  useEffect(() => {
    let attempts = 0;
    const maxAttempts = 5;
    
    const checkLibraries = () => {
      const pdfjs = typeof pdfjsLib !== 'undefined';
      const tesseract = typeof Tesseract !== 'undefined';
      const fuzzball = typeof window.fuzzball !== 'undefined';
      
      if (pdfjs && tesseract && fuzzball) {

        showNotification('‚úÖ Sistema OCR completo pronto!', 'success');
        return true;
      }

      return false;
    };

    const checkInterval = setInterval(() => {
      attempts++;
      
      if (checkLibraries()) {
        clearInterval(checkInterval);
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);

        showNotification('‚ö†Ô∏è OCR pode n√£o funcionar. Tente recarregar a p√°gina.', 'warning');
      }
    }, 1000); // Verificar a cada 1 segundo
    
    
  

  return () => clearInterval(checkInterval);
  }, []);

  useEffect(() => {
    const blacklistGuardada = localStorage.getItem('munchi_blacklist');
    if (blacklistGuardada) {
      try {
        setBlacklist(JSON.parse(blacklistGuardada));

      } catch (e) {

      }
    }
  }, []);

  useEffect(() => {
    if (driveAccessToken && calendarConfig.autoCheck) {

      buscarBolosAgendados();

      const intervaloMs = calendarConfig.intervalo * 60 * 1000;
      const intervalId = setInterval(() => {
        buscarBolosAgendados();
      }, intervaloMs);
      
      return () => clearInterval(intervalId);
    }
  }, [driveAccessToken, calendarConfig.autoCheck, calendarConfig.intervalo]);

  useEffect(() => {
    window.DEBUG_MUNCHI = {
      produtos,
      ingredientes,
      vendas,
      despesas,
      fornecedores,
      faturas,
      movimentacoesStock, // üÜï Adicionar movimenta√ß√µes de stock
      bolosExternos, // üéÇ Adicionar bolos externos
      bolosAgendados, // üéÇ Bolos do calendar
      buscarBolosAgendados, // üéÇ Fun√ß√£o para verificar
      diagnosticarPDFs: () => {

        const faturasComPDF = faturas.filter(f => f.documentoPDF);
        const faturasSemPDF = faturas.filter(f => !f.documentoPDF);

        if (faturasComPDF.length > 0) {

          const analise = faturasComPDF.map(f => {
            const pdfData = f.documentoPDF || '';
            const hasPrefix = pdfData.includes('data:application/pdf;base64,');
            const base64 = hasPrefix ? pdfData.split(',')[1] : pdfData;
            const size = base64.length;
            const isValid = size > 100; // PDFs v√°lidos t√™m pelo menos 100 chars
            
            return {
              numero: f.numero || f.id,
              fornecedor: f.fornecedorNome || 'N/A',
              data: f.data,
              temPrefixo: hasPrefix ? '‚úÖ' : '‚ùå',
              tamanhoBase64: size,
              valido: isValid ? '‚úÖ' : '‚ùå VAZIO',
              tipo: f.tipo || 'FT'
            };
          });
          
          console.table(analise);
          
          const pdfsInvalidos = analise.filter(a => a.valido === '‚ùå VAZIO');
          if (pdfsInvalidos.length > 0) {

          }
        }
        
        if (faturasSemPDF.length > 0) {

          console.table(faturasSemPDF.map(f => ({
            numero: f.numero || f.id,
            fornecedor: f.fornecedorNome || 'N/A',
            data: f.data,
            tipo: f.tipo || 'FT',
            valor: (f.totais?.total || f.total || 0).toFixed(2) + '‚Ç¨'
          })));

        }

      },
      testarPDF: (numeroFatura) => {

        const fatura = faturas.find(f => f.numero === numeroFatura || f.id == numeroFatura);
        
        if (!fatura) {
          console.error('‚ùå Fatura n√£o encontrada:', numeroFatura);

          return;
        }
        
        if (!fatura.documentoPDF) {
          console.error('‚ùå Esta fatura n√£o tem PDF anexado');
          return;
        }

        try {
          let base64Data = fatura.documentoPDF;

          if (base64Data.includes(',')) {
            const parts = base64Data.split(',');

            base64Data = parts[1];
          }

          const original = base64Data.length;
          base64Data = base64Data.trim().replace(/\s/g, '');

          const base64Regex = /^[A-Za-z0-9+/]+=*$/;
          const formatoValido = base64Regex.test(base64Data);

          const inicioPDF = base64Data.startsWith('JVBERi0');

          if (!formatoValido || !inicioPDF) {
            console.error('‚ùå PDF corrompido ou inv√°lido!');
            return;
          }

          const byteCharacters = atob(base64Data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'application/pdf' });

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `TESTE_${fatura.numero.replace(/[\/\\:*?"<>|]/g, '_')}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

        } catch (error) {
          console.error('‚ùå Erro ao processar PDF:', error);
        }

      },
      diagnosticar: () => {

        const produtosAltos = produtos.filter(p => p.custoReceita > 50);
        if (produtosAltos.length > 0) {

          console.table(produtosAltos.map(p => ({
            nome: p.nome,
            custoReceita: p.custoReceita,
            precoVenda: p.precoVenda,
            margem: p.precoVenda - p.custoReceita
          })));
        } else {

        }

        const vendasAltas = vendas.filter(v => v.quantidade > 1000);
        if (vendasAltas.length > 0) {

          console.table(vendasAltas.slice(0, 10).map(v => ({
            data: v.data,
            produto: v.produto || v.produtoId,
            quantidade: v.quantidade,
            valor: v.valor || v.total
          })));
        } else {

        }

        const categorias = {};
        faturas.forEach(f => {
          const cat = f.categoria || 'SEM_CATEGORIA';
          categorias[cat] = (categorias[cat] || 0) + 1;
        });

        console.table(categorias);

        const semCategoria = faturas.filter(f => !f.categoria);
        if (semCategoria.length > 0) {

          console.table(semCategoria.map(f => ({
            numero: f.numero || f.id,
            fornecedor: f.fornecedorNome,
            valor: (f.totais?.total || f.total || 0).toFixed(2),
            data: f.data
          })));

        } else {

        }

        if (produtosAltos.length > 0) {

        }
      },
      corrigirCustos: () => {

        let corrigidos = 0;
        const novoProdutos = produtos.map(p => {
          if (p.custoReceita > 50) {
            const custoAntigo = p.custoReceita;
            const custoNovo = p.custoReceita / 100;

            corrigidos++;
            return { ...p, custoReceita: custoNovo };
          }
          return p;
        });

        setProdutos(novoProdutos);
        
        setTimeout(() => {

        }, 500);
      },
      recalcularTudo: () => {

        const novoProdutos = produtos.map(produto => {
          if (!produto.receita || produto.receita.length === 0) {

            return produto;
          }

          const custoTotal = produto.receita.reduce((total, item) => {
            const ing = ingredientes.find(i => i.id === item.ingredienteId);
            if (!ing) return total;
            
            let quantidade = parseFloat(item.quantidade) || 0;
            const precoUnit = parseFloat(ing.custoUnitario) || 0;

            const unidadeReceita = item.unidade || ing.unidade;
            if (ing.unidade === 'kg' && unidadeReceita === 'g') quantidade = quantidade / 1000;
            if (ing.unidade === 'L' && unidadeReceita === 'ml') quantidade = quantidade / 1000;
            if (ing.unidade === 'g' && unidadeReceita === 'kg') quantidade = quantidade * 1000;
            if (ing.unidade === 'ml' && unidadeReceita === 'L') quantidade = quantidade * 1000;
            
            return total + (quantidade * precoUnit);
          }, 0);

          const custoFinal = (produto.porcoes && produto.porcoes > 1) 
            ? custoTotal / produto.porcoes 
            : custoTotal;
          
          const custoAntigo = produto.custoReceita || 0;
          
          if (Math.abs(custoFinal - custoAntigo) > 0.01) {

          }
          
          return {
            ...produto,
            custoReceita: custoFinal,
            margemLucro: produto.precoVenda > 0 ? ((produto.precoVenda - custoFinal) / produto.precoVenda) * 100 : 0
          };
        });

        setProdutos(novoProdutos);
        
        setTimeout(() => {

        }, 500);
      },
      corrigirIngredientes: () => {

        let corrigidos = 0;
        const novosIngredientes = ingredientes.map(ing => {
          if (ing.custoUnitario > 5) {
            const custoAntigo = ing.custoUnitario;
            const custoNovo = ing.custoUnitario / 100;

            corrigidos++;
            return { ...ing, custoUnitario: custoNovo };
          }
          return ing;
        });

        setIngredientes(novosIngredientes);
        
        setTimeout(() => {

        }, 500);
      },
      diagnosticarGuardanapos: () => {

        const produtoPratos = produtos.find(p => p.nome === 'Pratos' || p.nome.toLowerCase().includes('prato'));

        if (produtoPratos) {

          if (produtoPratos.receita?.length > 0) {

          }
        }

        const guardanapos = ingredientes.find(i => i.nome.toLowerCase().includes('guardanapo'));

        if (guardanapos) {

        }

        const vendasPratos = vendas.filter(v => 
          v.produto === 'Pratos' || 
          v.produto?.toLowerCase().includes('prato') ||
          (produtoPratos && v.produtoId === produtoPratos.id)
        );

        const comProdutoId = vendasPratos.filter(v => v.produtoId);
        const semProdutoId = vendasPratos.filter(v => !v.produtoId);

        if (comProdutoId.length > 0) {

        }
        if (semProdutoId.length > 0) {

        }

        const movimentacoesGuardanapos = movimentacoesStock.filter(m => 
          guardanapos && m.ingredienteId === guardanapos.id
        );

        const totalEntradas = movimentacoesGuardanapos
          .filter(m => m.tipo === 'entrada')
          .reduce((s, m) => s + m.quantidade, 0);
        const totalSaidas = movimentacoesGuardanapos
          .filter(m => m.tipo === 'saida')
          .reduce((s, m) => s + m.quantidade, 0);
        const totalAjustes = movimentacoesGuardanapos
          .filter(m => m.tipo === 'ajuste')
          .reduce((s, m) => s + m.quantidade, 0);

        const vendasComId = comProdutoId.length;
        const vendasSemId = semProdutoId.length;
        const saidasRegistadas = movimentacoesGuardanapos.filter(m => m.tipo === 'saida').length;
        
        if (saidasRegistadas === 0) {

        } else if (saidasRegistadas < vendasPratos.length) {

          if (vendasSemId > 0) {

          }
        } else {

        }

      },
      diagnosticarStockCompleto: () => {

        const guardanapos = ingredientes.find(i => i.nome.toLowerCase().includes('guardanapo'));
        if (!guardanapos) {

          return;
        }

        const movs = movimentacoesStock.filter(m => m.ingredienteId === guardanapos.id);

        const movsOrdenadas = [...movs].sort((a, b) => new Date(a.data) - new Date(b.data));
        
        let stockCalculado = 0;
        let primeiraMovimentacao = true;

        movsOrdenadas.slice(0, 20).forEach((m, i) => {
          const antes = stockCalculado;
          
          if (m.tipo === 'entrada') {
            stockCalculado += m.quantidade;
          } else if (m.tipo === 'saida') {
            stockCalculado -= m.quantidade;
          } else if (m.tipo === 'ajuste') {
            stockCalculado += m.quantidade;
          }

          if (primeiraMovimentacao) {

            primeiraMovimentacao = false;
          }
        });

        const totalEntradas = movs.filter(m => m.tipo === 'entrada').reduce((s, m) => s + m.quantidade, 0);
        const totalSaidas = movs.filter(m => m.tipo === 'saida').reduce((s, m) => s + m.quantidade, 0);
        const totalAjustes = movs.filter(m => m.tipo === 'ajuste').reduce((s, m) => s + m.quantidade, 0);

        if (movsOrdenadas.length > 0) {
          const primeiraMov = movsOrdenadas[0];

        }

      },
      verEntradasGuardanapos: () => {

        const guardanapos = ingredientes.find(i => i.nome.toLowerCase().includes('guardanapo'));
        if (!guardanapos) {

          return;
        }
        
        const entradas = movimentacoesStock
          .filter(m => m.ingredienteId === guardanapos.id && m.tipo === 'entrada')
          .sort((a, b) => new Date(a.data) - new Date(b.data));

        entradas.slice(0, 20).forEach((m, i) => {

        });
        
        if (entradas.length > 20) {

        }

        return entradas;
      },
      diagnosticarIngrediente: (nomeIngrediente) => {

        const ingrediente = ingredientes.find(i => i.nome.toLowerCase().includes(nomeIngrediente.toLowerCase()));
        if (!ingrediente) {

          return;
        }

        const movs = movimentacoesStock.filter(m => m.ingredienteId === ingrediente.id);

        const entradas = movs.filter(m => m.tipo === 'entrada');
        const saidas = movs.filter(m => m.tipo === 'saida');
        const ajustes = movs.filter(m => m.tipo === 'ajuste');

        const totalEntradas = entradas.reduce((s, m) => s + m.quantidade, 0);
        const totalSaidas = saidas.reduce((s, m) => s + m.quantidade, 0);
        const totalAjustes = ajustes.reduce((s, m) => s + m.quantidade, 0);

        const movsOrdenadas = [...movs].sort((a, b) => new Date(a.data) - new Date(b.data));

        if (movsOrdenadas.length > 0) {
          const primeira = movsOrdenadas[0];
          const ultima = movsOrdenadas[movsOrdenadas.length - 1];

        }

        entradas.slice(0, 10).forEach((m, i) => {

        });

        saidas.slice(0, 10).forEach((m, i) => {

        });

        const produtosQueUsam = produtos.filter(p => 
          p.receita?.some(r => r.ingredienteId === ingrediente.id)
        );

        produtosQueUsam.forEach(p => {
          const receitaItem = p.receita.find(r => r.ingredienteId === ingrediente.id);

        });

        const vendasDeProdutosComIngrediente = vendas.filter(v => {
          const prod = produtos.find(p => p.id === v.produtoId);
          return prod?.receita?.some(r => r.ingredienteId === ingrediente.id);
        });

        if (ingrediente.stockAtual < 0) {

        }

        return {
          ingrediente,
          movimentacoes: movs,
          entradas,
          saidas,
          ajustes,
          totalEntradas,
          totalSaidas,
          totalAjustes,
          stockCalculado: totalEntradas - totalSaidas + totalAjustes,
          produtosQueUsam
        };
      }
    };

  }, [produtos, vendas, despesas, faturas, ingredientes, fornecedores]);
  
  const [fornecedoresExpanded, setFornecedoresExpanded] = useState(false);
  const [deliveryAppsExpanded, setDeliveryAppsExpanded] = useState(false);
  const [editandoFornecedor, setEditandoFornecedor] = useState(false);
  const [fornecedorEditandoId, setFornecedorEditandoId] = useState(null);
  const [dadosFornecedor, setDadosFornecedor] = useState({
    nome: '',
    nif: '',
    morada: '',
    email: '',
    telefone: ''
  });

  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const getPercentagemDesperdicio = (ingrediente) => {
    if (!ingrediente) return 8;

    if (ingrediente.categoria === 'limpeza' || ingrediente.categoria === 'operacionais') {
      return 0; // Zero desperd√≠cio para produtos operacionais
    }

    if (ingrediente.modoWaste === 'manual' && ingrediente.historicoContagens?.length > 0) {
      const ultimas3 = ingrediente.historicoContagens.slice(-3);
      const mediaReal = ultimas3.reduce((sum, c) => sum + c.percentagem, 0) / ultimas3.length;
      return mediaReal;
    }

    if (ingrediente.modoWaste === 'manual') {
      return configuracaoWaste.percentagensPorCategoria[ingrediente.categoria] || 8;
    }

    if (configuracaoWaste.usarCategorias) {
      return configuracaoWaste.percentagensPorCategoria[ingrediente.categoria] || 
             configuracaoWaste.percentagemGlobal;
    }
    
    return configuracaoWaste.percentagemGlobal;
  };

  const inicializarIngrediente = (ing) => {

    if (ing.modoWaste !== undefined && ing.stockAtual !== undefined) {
      return ing;
    }

    const categoria = ing.categoria || 'default';
    const percentagemDesperdicio = configuracaoWaste.percentagensPorCategoria[categoria] || 8;

    const stocksPorCategoria = {
      'vegetais': [2, 5], 'frutas': [2, 5], 'peixe': [0.5, 2], 'carnes': [1, 3],
      'lacteos': [3, 10], 'latic√≠nios': [1, 3], 'padaria': [10, 30], 'cafe': [2, 5],
      'cereais': [1, 3], 'especiarias': [0.1, 0.5], 'oleos': [2, 5], 'bebidas': [24, 100],
      'compotas': [1, 3], 'consumiveis': [1, 3], 'temperos': [0.1, 0.3],
      'pastelaria': [0.1, 0.5], 'limpeza': [5, 20], 'operacionais': [5, 20], 'outros': [100, 500],
      'default': [5, 15]
    };
    
    const [stockMinimo, stockIdeal] = stocksPorCategoria[categoria] || stocksPorCategoria['default'];
    
    return {
      ...ing,
      modoWaste: ing.modoWaste || 'automatico',
      percentagemDesperdicio: ing.percentagemDesperdicio || percentagemDesperdicio,
      stockAtual: ing.stockAtual !== undefined ? ing.stockAtual : 0,
      stockMinimo: ing.stockMinimo || stockMinimo,
      stockIdeal: ing.stockIdeal || stockIdeal,
      ultimaContagem: ing.ultimaContagem || null,
      historicoContagens: ing.historicoContagens || [],
      ultimaCompra: ing.ultimaCompra || null
    };
  };

  const getStockStatus = (ingrediente) => {
    const stock = ingrediente.stockAtual || 0;
    const minimo = ingrediente.stockMinimo || 0;
    const ideal = ingrediente.stockIdeal || 0;
    
    if (stock <= 0) {
      return {
        status: 'CRITICO',
        cor: 'red',
        icone: 'üî¥',
        mensagem: 'ESGOTADO',
        prioridade: 1
      };
    }
    
    if (stock < minimo) {
      return {
        status: 'BAIXO',
        cor: 'orange',
        icone: 'üü†',
        mensagem: 'Abaixo do m√≠nimo',
        prioridade: 2
      };
    }
    
    if (stock < ideal * 0.5) {
      return {
        status: 'ATENCAO',
        cor: 'yellow',
        icone: 'üü°',
        mensagem: 'Requer aten√ß√£o',
        prioridade: 3
      };
    }
    
    return {
      status: 'OK',
      cor: 'green',
      icone: 'üü¢',
      mensagem: 'Adequado',
      prioridade: 4
    };
  };

  const toggleModoWaste = (ingredienteId) => {
    setIngredientes(ingredientes.map(ing => {
      if (ing.id !== ingredienteId) return ing;
      
      const novoModo = ing.modoWaste === 'automatico' ? 'manual' : 'automatico';
      
      showNotification(
        `${ing.nome}: Modo ${novoModo === 'automatico' ? 'ü§ñ Autom√°tico' : 'üë§ Manual'}`,
        'success'
      );
      
      return {
        ...ing,
        modoWaste: novoModo
      };
    }));
  };

  const calcularFoodCostComDesperdicio = (produto) => {
    if (!produto.receita || produto.receita.length === 0) return 0;
    
    const custoIngredientes = produto.receita.reduce((total, item) => {
      const ingrediente = ingredientes.find(i => i.id === item.ingredienteId);
      if (!ingrediente) return total;
      
      let qtd = parseFloat(item.quantidade);
      if (item.unidade === 'g' && ingrediente.unidade === 'kg') qtd /= 1000;
      if (item.unidade === 'ml' && ingrediente.unidade === 'L') qtd /= 1000;

      const custoBase = ingrediente.custoUnitario;
      const percentagemDesperdicio = getPercentagemDesperdicio(ingrediente);
      const custoAjustado = custoBase * (1 + percentagemDesperdicio / 100);
      
      return total + (qtd * custoAjustado);
    }, 0);
    
    const custoEmbalagens = (produto.embalagens || []).reduce((total, item) => {
      const embalagem = embalagens.find(e => e.id === item.embalagemId);
      return total + (embalagem ? embalagem.custoUnitario * (item.quantidade || 1) : 0);
    }, 0);
    
    return custoIngredientes + custoEmbalagens;
  };

  const handleAdicionarBlacklist = (item) => {
    const novaBlacklist = [...blacklist, item];
    setBlacklist(novaBlacklist);

    showNotification(`‚úÖ "${item}" adicionado √† blacklist. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
  };

  const handleRemoverBlacklist = (item) => {
    const novaBlacklist = blacklist.filter(i => i !== item);
    setBlacklist(novaBlacklist);

    showNotification(`‚úÖ "${item}" removido da blacklist. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
  };

  const handleSalvarConfiguracoes = (novasConfiguracoes) => {
    setConfiguracoes(novasConfiguracoes);
    guardarConfiguracoes(novasConfiguracoes);

    const novasMetricas = recalcularMetricas(faturas, vendas, novasConfiguracoes); // ‚úÖ USAR FATURAS

    
    showNotification('‚úÖ Configura√ß√µes guardadas!', 'success');
  };

  const handleConfirmarFatura = (dadosConfirmados) => {

    const categoriaFatura = dadosConfirmados.categoria || 'compras';

    setModalConfirmacaoFatura({ mostrar: false, dados: null });

    if (categoriaFatura !== 'compras') {

      setMostrarModalOCR(false);
      setLinhasOCR([]);

      const valorDetectado = metadataOCR?.totais?.total || 
                            (linhasOCR && linhasOCR.length > 0 ? 
                              linhasOCR.reduce((sum, l) => sum + (parseFloat(l.preco) || 0), 0) : 0);

      setModalDespesaSimples({
        mostrar: true,
        dados: {
          categoria: categoriaFatura,
          fornecedor: {
            id: dadosConfirmados.fornecedor.id,
            nome: dadosConfirmados.fornecedor.nome,
            nif: dadosConfirmados.fornecedor.nif
          },
          valorDetectado: valorDetectado,
          metadata: {
            ...metadataOCR,
            tipo: dadosConfirmados.tipo,
            numero: dadosConfirmados.numero,
            data: dadosConfirmados.data,
            atcud: dadosConfirmados.atcud,
            totais: dadosConfirmados.totais,
            categoria: categoriaFatura,
            temNifCliente: dadosConfirmados.temNifCliente || false // üÜï PASSAR NIF CLIENTE
          }
        }
      });
      
      showNotification(`Confirme os valores da ${categoriaFatura}`, 'info');
      return; // üö´ PARA AQUI - N√ÉO continua para processamento de ingredientes
    }

    if (metadataOCR && metadataOCR.textoCompleto && dadosConfirmados.fornecedor.nif) {

      const nifConfirmado = dadosConfirmados.fornecedor.nif;
      const template = buscarTemplateOCR(nifConfirmado);
      
      if (template && template.blacklist && template.blacklist.length > 0) {

      }

      const linhasReparsed = template 
        ? parseComTemplate(metadataOCR.textoCompleto, template)
        : parseLinhasProdutos(metadataOCR.textoCompleto, nifConfirmado);

      const linhasComMatch = linhasReparsed.length > 0 
        ? matchIngredientes(linhasReparsed, ingredientes)
        : [];

      const linhasComAprendizagem = linhasComMatch.map(linha => {

        const resultado = buscarNoVocabulario(linha.nomeProduto, nifConfirmado);
        
        if (resultado) {
          const { ingredienteId, confianca, similaridade, confirmacoes, correcoes } = resultado;
          const ingrediente = ingredientes.find(i => i.id === ingredienteId);
          
          if (ingrediente) {

            const ing = ingredientes.find(i => i.id === ingredienteId);
            const ingredienteSugeridoObj = ing ? {
              id: ing.id,
              nome: ing.nome,
              confianca: confianca,
              metodo: 'VOCABULARIO'
            } : null;

            if (confianca >= 80) {

              const linhaBase = {
                ...linha,
                ingredienteConfirmado: ingredienteId,
                ingredienteSugerido: ingredienteSugeridoObj,
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes }
              };

              return aplicarHistoricoAoMatch(linhaBase, ingredienteId, nifConfirmado);
            } else {

              const linhaSugestao = {
                ...linha,
                ingredienteSugerido: ingredienteSugeridoObj,
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes }
              };

              return aplicarHistoricoAoMatch(linhaSugestao, ingredienteId, nifConfirmado);
            }
          }
        }
        
        return linha;
      });

      setLinhasOCR(linhasComAprendizagem);
    }

    setMetadataOCR(prev => ({
      ...prev,
      tipoFatura: dadosConfirmados.tipo,
      numeroFatura: dadosConfirmados.numero,
      fornecedor: dadosConfirmados.fornecedor.nome,
      fornecedorId: dadosConfirmados.fornecedor.id,
      nif: dadosConfirmados.fornecedor.nif,
      dataFatura: dadosConfirmados.data,
      atcud: dadosConfirmados.atcud,
      totais: dadosConfirmados.totais,
      precosComIVA: dadosConfirmados.precosComIVA,
      categoria: dadosConfirmados.categoria || 'compras', // üÜï GUARDAR CATEGORIA
      temNifCliente: dadosConfirmados.temNifCliente || prev?.temNifCliente || false // üÜï NIF CLIENTE
    }));

    if (linhasOCR && linhasOCR.length >= 0 && metadataOCR) {

      setMostrarModalOCR(true);
    }
    
    showNotification(`Fatura de compras confirmada!`, 'success');
  };

  const handleCancelarFatura = () => {
    setModalConfirmacaoFatura({ mostrar: false, dados: null });
  };

  /**
   * üÜï CONFIRMAR DESPESA SIMPLES (MODAL SIMPLES)
   * Salva fatura de renda/luz/√°gua sem ingredientes
   */
  const handleConfirmarDespesaSimples = (dadosDespesa) => {

    const { precoTotal, iva, categoria, fornecedor, metadata } = dadosDespesa;

    const precoComIVA = precoTotal;
    const precoSemIVA = iva > 0 ? precoComIVA / (1 + iva / 100) : precoComIVA;
    const valorIVA = precoComIVA - precoSemIVA;

    const item = {
      id: `despesa_${Date.now()}`,
      descricao: categoria.charAt(0).toUpperCase() + categoria.slice(1),
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoSemIVA,
      precoTotal: precoComIVA,
      subtotal: precoSemIVA,
      iva: iva,
      num_funcionarios: categoria === 'salarios' ? 1 : undefined
    };

    const novaFaturaCompleta = {
      id: Date.now(),
      criadoEm: new Date().toISOString(), // üÜï Timestamp de cria√ß√£o
      numero: metadata?.numero || metadata?.numeroFatura || '',
      tipo: metadata?.tipo || metadata?.tipoFatura || 'FT',
      tipoDocumento: 'FT',
      data: metadata?.data || metadata?.dataFatura || new Date().toISOString().split('T')[0],
      fornecedorId: fornecedor?.id || '',
      fornecedorNome: fornecedor?.nome || '',
      fornecedorNif: fornecedor?.nif || '',
      itens: [item],
      notas: '',
      categoria: categoria,
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: metadata?.pdfBase64 || null,
      nomeDocumento: metadata?.pdfNome || '',
      subtotal: precoSemIVA,
      totalIva: valorIVA,
      total: precoComIVA,
      totais: {
        subtotal: precoSemIVA,
        iva: valorIVA,
        total: precoComIVA
      },

      temNifCliente: metadata?.temNifCliente || false,
      nifCliente: metadata?.nifClienteDetetado || configuracoes.metricas.nifEmpresa || null,
      paraContabilista: (() => {
        const tipo = metadata?.tipo || metadata?.tipoFatura;
        const temNif = metadata?.temNifCliente;

        if (tipo === 'FT' || tipo === 'FR') return true;

        if (tipo === 'FS') return temNif === true;
        return false;
      })()
    };

    setFaturas(prev => [...prev, novaFaturaCompleta]);
    setUltimaFaturaInserida(novaFaturaCompleta.id); // üÜï Marcar como √∫ltima inserida

    setModalDespesaSimples({ mostrar: false, dados: null });

    setMostrarModalOCR(false);

    setLinhasOCR([]);
    setMetadataOCR(null);
    setProcessandoOCR(false);
    setProgressoOCR('');

    setNovaFatura({
      numero: '',
      tipo: 'FT',
      tipoDocumento: 'FT',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });
    
    const labelsCategorias = {
      'compras': 'Compras',
      'compras_alimentares': 'Compras Alimentares',
      'materiais_operacionais': 'Materiais Operacionais',
      'embalagens_consumiveis': 'Embalagens/Consum√≠veis',
      'renda': 'Renda',
      'eletricidade': 'Eletricidade',
      'agua': '√Ågua',
      'gas': 'G√°s',
      'internet': 'Internet',
      'salarios': 'Sal√°rios',
      'marketing': 'Marketing',
      'consumiveis': 'Consum√≠veis',
      'manutencao': 'Manuten√ß√£o',
      'outros': 'Outros'
    };
    
    showNotification(`‚úÖ ${labelsCategorias[categoria] || 'Despesa'} guardada com sucesso!`, 'success');
  };

  const handleCancelarDespesaSimples = () => {
    setModalDespesaSimples({ mostrar: false, dados: null });

    setMostrarModalOCR(false);

    setLinhasOCR([]);
    setMetadataOCR(null);
    setProcessandoOCR(false);
    setProgressoOCR('');
  };

  /**
   * üö´ FUN√á√ÉO ANTIGA - N√ÉO √â MAIS USADA (v1.1.3+)
   * Agora usamos ModalDespesaSimples em vez de salvar direto
   * 
   * üÜï SALVAR FATURA DE DESPESA DIRETA (SEM INGREDIENTES)
   * Para categorias: renda, eletricidade, agua, gas, internet, salarios, etc.
   */
  /*
  const salvarFaturaDespesaDireta = (dadosConfirmados, metadataOCR) => {

    const categoria = dadosConfirmados.categoria || metadataOCR?.categoria || 'outros';

    const totalFatura = metadataOCR?.totais?.total || 
                       dadosConfirmados.totais?.total || 
                       (linhasOCR && linhasOCR.length > 0 ? 
                         linhasOCR.reduce((sum, l) => sum + (parseFloat(l.preco) || 0), 0) : 0);

    let iva = 23; // Padr√£o
    if (categoria === 'salarios') iva = 0; // Sal√°rios sem IVA
    if (categoria === 'renda') iva = 23;
    if (categoria === 'eletricidade') iva = 23;
    if (categoria === 'agua') iva = 6;
    if (categoria === 'gas') iva = 23;
    if (categoria === 'internet') iva = 23;
    
    const precoComIVA = totalFatura;
    const precoSemIVA = iva > 0 ? precoComIVA / (1 + iva / 100) : precoComIVA;
    const valorIVA = precoComIVA - precoSemIVA;
    
    const item = {
      id: `despesa_${Date.now()}`,
      descricao: categoria.charAt(0).toUpperCase() + categoria.slice(1), // Renda, Eletricidade, etc
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoSemIVA,
      precoTotal: precoComIVA,
      subtotal: precoSemIVA,
      iva: iva,
      num_funcionarios: categoria === 'salarios' ? 1 : undefined
    };

    let fornecedorId = '';
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (dadosConfirmados.fornecedor) {
      fornecedorId = dadosConfirmados.fornecedor.id || '';
      fornecedorNome = dadosConfirmados.fornecedor.nome || '';
      fornecedorNif = dadosConfirmados.fornecedor.nif || '';
    } else if (metadataOCR?.fornecedorId) {
      const fornecedor = fornecedores.find(f => f.id === metadataOCR.fornecedorId);
      if (fornecedor) {
        fornecedorId = fornecedor.id;
        fornecedorNome = fornecedor.nome;
        fornecedorNif = fornecedor.nif || '';
      }
    }

    const novaFaturaCompleta = {
      id: Date.now(),
      numero: dadosConfirmados.numero || metadataOCR?.numeroFatura || '',
      tipo: dadosConfirmados.tipo || metadataOCR?.tipoFatura || 'FT',
      tipoDocumento: 'FT',
      data: dadosConfirmados.data || metadataOCR?.dataFatura || new Date().toISOString().split('T')[0],
      fornecedorId: fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: '',
      categoria: categoria,
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: metadataOCR?.pdfBase64 || null,
      nomeDocumento: metadataOCR?.pdfNome || '',
      subtotal: precoSemIVA,
      totalIva: valorIVA,
      total: precoComIVA,
      totais: {
        subtotal: precoSemIVA,
        iva: valorIVA,
        total: precoComIVA
      },
      paraContabilista: (dadosConfirmados.tipo !== 'FS') // FS n√£o vai, FT e FR v√£o
    };

    setFaturas([...faturas, novaFaturaCompleta]);

    setLinhasOCR([]);
    setMetadataOCR(null);
    setProcessandoOCR(false);
    setProgressoOCR('');

    setNovaFatura({
      numero: '',
      tipo: 'FT',
      tipoDocumento: 'FT',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });
    
    showNotification(`‚úÖ Fatura de ${categoria} guardada com sucesso!`, 'success');
  };
  */

  
  /**
   * Normaliza texto OCR para compara√ß√£o
   * Remove acentos, pontua√ß√£o, unidades, n√∫meros
   */
  const normalizarTexto = (texto) => {
    if (!texto) return '';
    
    return texto
      .toUpperCase()

      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')

      .replace(/\b(KG|GR|G|LT|L|ML|CX|UN|UND|UNID|PCT|PC|EMB)\b/gi, '')

      .replace(/\b\d+\b/g, '')

      .replace(/[^\w\s]/g, ' ')

      .replace(/\s+/g, ' ')
      .trim();
  };

  /**
   * Calcula similaridade entre dois textos normalizados (0-100)
   * Usa algoritmo de Levenshtein via fuzzball
   */
  const calcularSimilaridade = (texto1, texto2) => {
    if (!texto1 || !texto2) return 0;
    if (typeof window.fuzzball === 'undefined') return 0;
    
    const norm1 = normalizarTexto(texto1);
    const norm2 = normalizarTexto(texto2);
    
    if (norm1 === norm2) return 100;
    
    try {
      return window.fuzzball.ratio(norm1, norm2);
    } catch (e) {

      return 0;
    }
  };

  /**
   * Busca ingrediente no vocabul√°rio do fornecedor
   * Retorna: { ingredienteId, confianca, historico } ou null
   */

/**
 * Detecta o tipo de fatura (FT, FR ou FS)
 */
const detectarTipoFatura = (texto) => {
  if (!texto) return 'FT';

  const ordemVerificacao = ['FR', 'FS', 'FT'];
  
  for (const tipo of ordemVerificacao) {
    const config = INVOICE_TYPES[tipo];
    for (const pattern of config.patterns) {
      if (pattern.test(texto)) {

        return tipo;
      }
    }
  }

  return 'FT';
};

/**
 * Extrai o n√∫mero da fatura baseado no tipo
 */
const extrairNumeroFatura = (texto, tipoFatura) => {
  if (!texto) return null;
  
  const config = INVOICE_TYPES[tipoFatura];
  if (!config) return null;

  const textoLimpo = texto
    .replace(/\s+/g, ' ')           // Normalizar espa√ßos m√∫ltiplos
    .replace(/\s*\/\s*/g, '/')      // Remover espa√ßos ao redor de /
    .replace(/\s*-\s*/g, '-')       // Remover espa√ßos ao redor de -
    .trim();
  
  for (const pattern of config.numberPatterns) {
    const match = textoLimpo.match(pattern);
    if (match && match[1]) {
      let numero = match[1].trim();

      numero = numero
        .replace(/\s+/g, ' ')                    // Normalizar espa√ßos
        .replace(/\s*([\/\-])\s*/g, '$1')       // Remover espa√ßos ao redor de separadores
        .replace(/^(FT|FR|FS|NC|VD)\s*/i, '')   // Remover prefixo duplicado
        .replace(/\s+$/, '')                     // Remover espa√ßos finais
        .toUpperCase();

      const temConteudo = /[A-Z0-9]/.test(numero);
      const tamanhoOK = numero.length >= 3;
      
      if (temConteudo && tamanhoOK) {

        return numero;
      }
    }
  }

  return null;
};

/**
 * Detecta fornecedor conhecido
 */
const detectarFornecedor = (texto, fornecedoresList = []) => {
  if (!texto) return { nome: 'Fornecedor Desconhecido', nif: '' };

  for (const [chave, fornecedor] of Object.entries(FORNECEDORES_CONHECIDOS)) {
    for (const pattern of fornecedor.patterns) {
      if (pattern.test(texto)) {

        const fornecedorNaLista = fornecedoresList.find(f => 
          f.nif === fornecedor.nif || f.nome.toLowerCase().includes(fornecedor.nome.toLowerCase())
        );
        
        if (fornecedorNaLista) {
          return {
            id: fornecedorNaLista.id,
            nome: fornecedorNaLista.nome,
            nif: fornecedorNaLista.nif
          };
        }
        
        return {
          chave: chave,
          nome: fornecedor.nome,
          nif: fornecedor.nif
        };
      }
    }
  }

  const padroesNIF = [
    /(?:NIF|N\.?I\.?F\.?)[:\s]*(\d{9})/i,
    /(?:Contribuinte)[:\s]*(\d{9})/i,
    /(?:NIPC)[:\s]*(\d{9})/i,
    /(?:N[¬∞¬∫]?\s*Contribuinte)[:\s]*(\d{9})/i,
    /PT\s*(\d{9})/,  // Formato PT 500829993
    /(\d{9})(?=\s*PT)/  // Formato 500829993 PT
  ];
  
  let nifEncontrado = null;
  for (const padrao of padroesNIF) {
    const match = texto.match(padrao);
    if (match) {
      nifEncontrado = match[1];

      break;
    }
  }
  
  if (nifEncontrado) {

    const fornecedorEncontrado = fornecedoresList.find(f => f.nif === nifEncontrado);
    
    if (fornecedorEncontrado) {

      return {
        id: fornecedorEncontrado.id,
        nome: fornecedorEncontrado.nome,
        nif: fornecedorEncontrado.nif
      };
    }

    for (const [chave, fornecedor] of Object.entries(FORNECEDORES_CONHECIDOS)) {
      if (fornecedor.nif === nifEncontrado) {

        return {
          chave: chave,
          nome: fornecedor.nome,
          nif: fornecedor.nif
        };
      }
    }

    return {
      chave: 'desconhecido',
      nome: 'Fornecedor Desconhecido',
      nif: nifEncontrado
    };
  }

  for (const fornecedor of fornecedoresList) {
    if (!fornecedor.nome) continue;

    const nomeNormalizado = fornecedor.nome
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, ''); // Remove pontua√ß√£o
    
    const textoNormalizado = texto
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, '');

    const palavrasNome = nomeNormalizado.split(/\s+/).filter(p => p.length >= 3);
    
    if (palavrasNome.length === 0) continue;

    let palavrasEncontradas = 0;
    for (const palavra of palavrasNome) {
      if (textoNormalizado.includes(palavra)) {
        palavrasEncontradas++;
      }
    }

    const limiar = palavrasNome.length === 1 ? 1 : 2;
    
    if (palavrasEncontradas >= limiar) {

      return {
        id: fornecedor.id,
        nome: fornecedor.nome,
        nif: fornecedor.nif || ''
      };
    }
  }

  return { nome: 'Fornecedor Desconhecido', nif: '' };
};

/**
 * Extrai ATCUD da fatura
 */
const extrairATCUD = (texto) => {
  if (!texto) return null;
  
  const patterns = [
    /ATCUD:\s*([A-Z0-9-]+)/,
    /ATCUD:([A-Z0-9-]+)/
  ];
  
  for (const pattern of patterns) {
    const match = texto.match(pattern);
    if (match) {

      return match[1].trim();
    }
  }
  
  return null;
};

/**
 * Extrai data da fatura
 */
const extrairDataFatura = (texto) => {
  if (!texto) return new Date().toISOString().split('T')[0];

  const patterns = [
    /Data\s+de\s+Emiss√£o:\s*(\d{2})[-\/](\d{2})[-\/](\d{4})/i,
    /Data:\s*(\d{2})[-\/](\d{2})[-\/](\d{4})/i,
    /(\d{2})[-\/](\d{2})[-\/](\d{4})/,
    /(\d{4})[-\/](\d{2})[-\/](\d{2})/
  ];
  
  for (const pattern of patterns) {
    const match = texto.match(pattern);
    if (match) {
      let year, month, day;

      if (match[1].length === 4) {

        year = match[1];
        month = match[2];
        day = match[3];
      } else {

        day = match[1];
        month = match[2];
        year = match[3];
      }

      const anoAtual = new Date().getFullYear();
      const monthNum = parseInt(month);
      const dayNum = parseInt(day);
      const yearNum = parseInt(year);

      if (yearNum < 2020 || yearNum > anoAtual + 1) {
        continue; // Data inv√°lida (ano fora do range razo√°vel)
      }
      
      if (monthNum < 1 || monthNum > 12 || dayNum < 1 || dayNum > 31) {
        continue; // Data inv√°lida (m√™s/dia imposs√≠vel)
      }

      if (monthNum > 12 && dayNum <= 12) {

        const temp = month;
        month = day;
        day = temp;
      }

      const dataFormatada = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

      return dataFormatada;
    }
  }

  return new Date().toISOString().split('T')[0];
};

/**
 * Extrai totais da fatura (subtotal, IVA, total)
 */
const extrairTotaisFatura = (texto) => {
  if (!texto) return { subtotal: 0, iva: 0, total: 0 };
  
  const result = { subtotal: 0, iva: 0, total: 0 };

  const subtotalPatterns = [
    /Total\s+Il√≠q[:\.\s]+([\d,\.]+)‚Ç¨?/i,
    /Subtotal[:\s]+([\d,\.]+)/i,
    /Total\s+s\/\s*imp[:\s]+([\d,\.]+)/i
  ];

  const ivaPatterns = [
    /IVA\s+Normal[:\s]+([\d,\.]+)‚Ç¨?/i,
    /IVA[:\s]+([\d,\.]+)‚Ç¨?/i,
    /Total\s+IVA[:\s]+([\d,\.]+)/i
  ];

  const totalPatterns = [
    /Total\s+a\s+pagar[:\s]+([\d,\.]+)‚Ç¨?/i,
    /Total[:\s]+([\d,\.]+)‚Ç¨?\s*$/im,
    /TOTAL[:\s]+([\d,\.]+)/i
  ];

  for (const pattern of subtotalPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.subtotal = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }

  for (const pattern of ivaPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.iva = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }

  for (const pattern of totalPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.total = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }

  return result;
};

/**
 * Processa texto OCR e extrai todos os dados da fatura
 */
const processarTextoFatura = (texto, fornecedoresList = []) => {

  const tipoFatura = detectarTipoFatura(texto);
  const numeroFatura = extrairNumeroFatura(texto, tipoFatura);
  const fornecedor = detectarFornecedor(texto, fornecedoresList); // ‚úÖ PASSAR LISTA
  const data = extrairDataFatura(texto);
  const atcud = extrairATCUD(texto);
  const totais = extrairTotaisFatura(texto);

  let precosComIVA = true; // Default: pre√ßos COM IVA

  if (fornecedor.nif === '278240160' || fornecedor.nome.includes('MANIA')) {
    precosComIVA = false;
  }

  if (fornecedor.nif === '9568126' || fornecedor.nome.includes('Recheio')) {
    precosComIVA = true;
  }
  
  const resultado = {
    tipo: tipoFatura,
    numero: numeroFatura || 'N/A',
    fornecedor: fornecedor,
    data: data,
    atcud: atcud,
    totais: totais,
    precosComIVA: precosComIVA, // NOVO: flag para saber se pre√ßos incluem IVA
    textoCompleto: texto
  };

  return resultado;
};

/**
 * Calcula breakdown de pre√ßo com IVA
 * @param {number} totalComIVA - Pre√ßo total com IVA
 * @param {number} quantidade - Quantidade de unidades
 * @param {number} taxaIVA - Taxa de IVA (ex: 23)
 * @returns {object} - { precoSemIVA, taxaIVA, valorIVA, precoComIVA }
 */
const calcularBreakdownPreco = (totalComIVA, quantidade, taxaIVA) => {
  const precoPorUnidadeComIVA = totalComIVA / quantidade;
  const precoPorUnidadeSemIVA = precoPorUnidadeComIVA / (1 + taxaIVA / 100);
  const valorIVAPorUnidade = precoPorUnidadeComIVA - precoPorUnidadeSemIVA;
  
  return {
    precoSemIVA: precoPorUnidadeSemIVA,
    taxaIVA: taxaIVA,
    valorIVA: valorIVAPorUnidade,
    precoComIVA: precoPorUnidadeComIVA,
    precoTotal: totalComIVA
  };
};

/**
 * Atualiza pre√ßo de ingrediente a partir de item da fatura
 * IMPORTANTE: Guarda o pre√ßo COM IVA!
 */
const atualizarPrecoIngrediente = (ingredienteId, dadosFatura, ingredientes) => {
  const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
  if (!ingrediente) {

    return ingredientes;
  }

  const breakdown = calcularBreakdownPreco(
    dadosFatura.precoTotal,
    dadosFatura.quantidade,
    dadosFatura.taxaIVA
  );

  ingrediente.custoUnitario = breakdown.precoComIVA;
  ingrediente.taxaIVA = breakdown.taxaIVA;
  ingrediente.ultimaAtualizacao = new Date().toISOString();

  ingrediente.infoDisplay = {
    comIVA: breakdown.precoComIVA,
    semIVA: breakdown.precoSemIVA,
    valorIVA: breakdown.valorIVA
  };

  return [...ingredientes];
};

/**
 * Calcula margens de produto (markup E margem bruta)
 * @param {object} produto - Produto com precoVenda e custoReceita
 * @param {object} configuracoes - Configura√ß√µes de alertas
 * @returns {object} - Margens calculadas com status
 */
const calcularMargensProduto = (produto, configuracoes = null) => {
  const precoVenda = produto.precoVenda || 0;
  const custo = produto.custoReceita || 0;
  
  if (precoVenda === 0) return null;
  
  const lucro = precoVenda - custo;
  const markup = custo > 0 ? (lucro / custo) * 100 : 0;
  const margemBruta = (lucro / precoVenda) * 100;

  let status = 'good';
  let cor = 'green';
  
  const limiarBaixo = configuracoes?.alertas?.margemBaixa || 70;
  const limiarCritico = configuracoes?.alertas?.margemCritica || 55;
  
  if (margemBruta < limiarCritico) {
    status = 'critical';
    cor = 'red';
  } else if (margemBruta < limiarBaixo) {
    status = 'warning';
    cor = 'yellow';
  }
  
  return {
    custo: custo,
    precoVenda: precoVenda,
    lucro: lucro,
    markup: markup,
    margemBruta: margemBruta,
    status: {
      status: status,
      cor: cor
    }
  };
};

/**
 * Recalcula todas as m√©tricas ap√≥s mudan√ßas
 * Deve ser chamado ap√≥s: adicionar fatura, venda, ou mudar configura√ß√µes
 */
const recalcularMetricas = (faturas, vendas, configuracoes) => {

  const config = configuracoes || carregarConfiguracoes();

  const despesas = {
    FT: 0,
    FR: 0,
    FS: 0,
    total: 0
  };
  
  faturas.forEach(fatura => {
    const total = fatura.totais?.total || fatura.total || 0;
    const tipo = fatura.tipo || 'FT';

    if (tipo === 'FT') despesas.FT += total;
    else if (tipo === 'FR') despesas.FR += total;
    else if (tipo === 'FS') despesas.FS += total;
  });

  if (config.metricas.apenasOficial) {

    despesas.total = despesas.FT + despesas.FR;
  } else {

    despesas.total = despesas.FT + despesas.FR + despesas.FS;
  }

  let receita = 0;
  let vendasMoloni = 0;
  let vendasZobaze = 0;
  
  vendas.forEach(venda => {

    const eZobaze = venda.origem === 'zobaze';
    const eMoloni = venda.origem === 'moloni' || !venda.origem; // Default √© Moloni
    const total = venda.total || 0;

    if (eZobaze) vendasZobaze += total;
    if (eMoloni) vendasMoloni += total;
    
    if (config.metricas.apenasOficial) {

      if (eMoloni) {
        receita += total;
      }
    } else {

      receita += total;
    }
  });

  const cogs = 0; // TODO: implementar c√°lculo real

  const margemBruta = receita - cogs;
  const margemBrutaPercent = receita > 0 ? (margemBruta / receita) * 100 : 0;

  const lucroLiquido = margemBruta - despesas.total;
  
  const resultado = {
    receita: receita,
    despesas: despesas,
    cogs: cogs,
    margemBruta: margemBruta,
    margemBrutaPercent: margemBrutaPercent,
    lucroLiquido: lucroLiquido,
    timestamp: new Date().toISOString()
  };

  return resultado;
};

/**
 * Calcula √≠ndice de desperd√≠cio
 * F√≥rmula: (Compras - Vendas convertidas em custo) / Compras * 100
 */
const calcularIndiceDesperdicio = (comprasPeriodo, vendasPeriodo, produtos) => {

  const totalCompras = comprasPeriodo.reduce((sum, compra) => {
    return sum + (compra.totais?.total || compra.total || 0);
  }, 0);

  let custoVendas = 0;
  vendasPeriodo.forEach(venda => {

    
    if (venda.itens && venda.itens.length > 0) {

      venda.itens.forEach(item => {
        const produto = produtos.find(p => p.id === item.produtoId);
        if (produto && produto.custoReceita && produto.custoReceita > 0) {

          const custo = produto.custoReceita;
          const qtd = item.quantidade || 1;

          if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
            const custoItem = custo * qtd;
            if (custoItem < 5000) {
              custoVendas += custoItem;
            }
          }
        }
      });
    } else if (venda.produtoId) {

      const produto = produtos.find(p => p.id === venda.produtoId);
      if (produto && produto.custoReceita && produto.custoReceita > 0) {

        const custo = produto.custoReceita;
        const qtd = venda.quantidade || 1;

        if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
          const custoItem = custo * qtd;
          if (custoItem < 5000) {
            custoVendas += custoItem;
          }
        }
      }
    }
  });

  const desperdicio = totalCompras - custoVendas;
  const desperdicioPercent = totalCompras > 0 ? (desperdicio / totalCompras) * 100 : 0;
  
  return {
    compras: totalCompras,
    custoVendas: custoVendas,
    desperdicio: desperdicio,
    desperdicioPercent: desperdicioPercent,
    status: desperdicioPercent > 10 ? 'alto' : 'normal'
  };
};

  
  const buscarNoVocabulario = (textoOCR, nifFornecedor) => {
    if (!textoOCR || !nifFornecedor) return null;
    
    const textoNorm = normalizarTexto(textoOCR);

    const vocabFornecedor = vocabularioFornecedor.filter(
      v => v.fornecedorNIF === nifFornecedor
    );

    if (vocabFornecedor.length === 0) {

      return null;
    }

    let melhorMatch = null;
    let melhorSimilaridade = 0;
    
    vocabFornecedor.forEach(vocab => {
      const similaridade = calcularSimilaridade(textoNorm, vocab.textoNormalizado);

      if (similaridade > melhorSimilaridade && similaridade >= 60) {

        const confirmacoes = vocab.confirmacoes || 0;
        const correcoes = vocab.correcoes || 0;

        let fatorHistorico;
        if (confirmacoes === 1 && correcoes === 0) {
          fatorHistorico = 0.85; // 1¬™ confirma√ß√£o = 85% do potencial
        } else if (confirmacoes === 2 && correcoes === 0) {
          fatorHistorico = 0.95; // 2¬™ confirma√ß√£o = 95% (ATINGE 80% facilmente!)
        } else if (confirmacoes >= 3 && correcoes === 0) {
          fatorHistorico = 1.00; // 3+ confirma√ß√µes = 100% (certeza absoluta)
        } else {

          fatorHistorico = Math.max(0.60, confirmacoes / (confirmacoes + correcoes * 1.5 + 1));
        }

        let boostInicial = 1.0;
        if (confirmacoes === 1 && similaridade >= 90) {
          boostInicial = 1.05; // +5% boost para matches perfeitos na primeira vez
        }
        
        const confianca = (similaridade / 100) * fatorHistorico * boostInicial * 100;

        melhorMatch = {
          ingredienteId: vocab.ingredienteId,
          confianca: Math.round(confianca),
          similaridade: Math.round(similaridade),
          confirmacoes,
          correcoes,
          textoOriginal: vocab.textoOriginal
        };
        melhorSimilaridade = similaridade;
      }
    });
    
    return melhorMatch;
  };

  /**
   * Adiciona ou atualiza entrada no vocabul√°rio
   */
  const aprenderAssociacao = (textoOCR, ingredienteId, nifFornecedor, foiCorrecao = false, dadosLinha = {}) => {
    if (!textoOCR || !ingredienteId || !nifFornecedor) {

      return;
    }
    
    const textoNorm = normalizarTexto(textoOCR);

    const indexExistente = vocabularioFornecedor.findIndex(
      v => v.fornecedorNIF === nifFornecedor && 
           v.textoNormalizado === textoNorm &&
           v.ingredienteId === ingredienteId
    );
    
    if (indexExistente >= 0) {

      setVocabularioFornecedor(prev => {
        const atualizado = [...prev];
        if (foiCorrecao) {
          atualizado[indexExistente].correcoes = (atualizado[indexExistente].correcoes || 0) + 1;

        } else {
          atualizado[indexExistente].confirmacoes = (atualizado[indexExistente].confirmacoes || 0) + 1;

        }
        atualizado[indexExistente].ultimaConfirmacao = new Date().toISOString();

        if (dadosLinha.quantidade !== undefined) {
          atualizado[indexExistente].ultimaQuantidade = dadosLinha.quantidade;
        }
        if (dadosLinha.unidade) {
          atualizado[indexExistente].ultimaUnidade = dadosLinha.unidade;
        }
        if (dadosLinha.preco !== undefined) {
          atualizado[indexExistente].ultimoPreco = dadosLinha.preco;
        }

        return atualizado;
      });

    } else {

      const novo = {
        id: `vocab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        fornecedorNIF: nifFornecedor,
        textoOriginal: textoOCR,
        textoNormalizado: textoNorm,
        ingredienteId: ingredienteId,
        confirmacoes: foiCorrecao ? 0 : 1,
        correcoes: foiCorrecao ? 1 : 0,
        ultimaConfirmacao: new Date().toISOString(),

        ultimaQuantidade: dadosLinha.quantidade,
        ultimaUnidade: dadosLinha.unidade,
        ultimoPreco: dadosLinha.preco
      };
      
      setVocabularioFornecedor(prev => {
        const novoArray = [...prev, novo];

        return novoArray;
      });

    }
  };

  
  const detectarLayoutFatura = (texto) => {
    const linhas = texto.split('\n').map(l => l.trim());
    const marcadoresInicio = [
      /ref.*artigo.*designa/i,
      /produto.*quantidade.*pre/i,
      /designa√ß√£o.*qtd.*pre√ßo/i
    ];
    const marcadoresFim = [
      /resumo.*impost/i,
      /total.*pagar/i,
      /informa.*banc√°ria/i
    ];
    
    let linhaInicio = -1;
    let linhaFim = linhas.length;
    
    for (let i = 0; i < linhas.length; i++) {
      if (marcadoresInicio.some(m => m.test(linhas[i]))) {
        linhaInicio = i + 1;
        break;
      }
    }
    
    for (let i = linhaInicio + 1; i < linhas.length; i++) {
      if (marcadoresFim.some(m => m.test(linhas[i]))) {
        linhaFim = i;
        break;
      }
    }
    
    return { linhaInicio: Math.max(0, linhaInicio), linhaFim };
  };
  
  const buscarTemplateOCR = (nifFornecedor) => {
    if (!nifFornecedor) return null;
    return templatesOCR.find(t => t.nifFornecedor === nifFornecedor);
  };

  const adicionarABlacklist = (nifFornecedor, linha) => {

    if (!nifFornecedor) {

      showNotification('‚ùå NIF n√£o detectado! Imposs√≠vel adicionar √† blacklist.', 'error');
      return;
    }

    const linhaNormalizada = linha.toLowerCase().trim();

    setTemplatesOCR(prevTemplates => {
      let template = prevTemplates.find(t => t.nifFornecedor === nifFornecedor);

      if (!template) {

        template = {
          nifFornecedor: nifFornecedor,
          linhaInicio: 0,
          linhaFim: 999,
          blacklist: [],
          palavrasLimpar: [], // üßπ Nova propriedade
          numProdutosEsperado: 0,
          vezeUsado: 0
        };
      }
      
      const blacklistAtual = template.blacklist || [];

      if (blacklistAtual.includes(linhaNormalizada)) {
        showNotification(`‚ö†Ô∏è "${linha}" j√° est√° na blacklist!`, 'warning');
        return prevTemplates; // Retornar sem mudan√ßas
      }
      
      const novaBlacklist = [...blacklistAtual, linhaNormalizada];

      const novoTemplate = {
        ...template,
        blacklist: novaBlacklist
      };
      
      const index = prevTemplates.findIndex(t => t.nifFornecedor === nifFornecedor);
      const novos = index === -1 
        ? [...prevTemplates, novoTemplate]  // Adicionar novo
        : prevTemplates.map((t, i) => i === index ? novoTemplate : t);  // Atualizar existente

      showNotification(`üö´ "${linha}" adicionado √† blacklist. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
      
      return novos;
    });
  };

  const adicionarAPalavrasLimpar = (nifFornecedor, palavra) => {

    if (!nifFornecedor) {
      showNotification('‚ùå NIF n√£o detectado! Imposs√≠vel adicionar √† lista de limpeza.', 'error');
      return;
    }

    const palavraNormalizada = palavra.toLowerCase().trim();

    setTemplatesOCR(prevTemplates => {
      let template = prevTemplates.find(t => t.nifFornecedor === nifFornecedor);

      if (!template) {
        template = {
          nifFornecedor: nifFornecedor,
          linhaInicio: 0,
          linhaFim: 999,
          blacklist: [],
          palavrasLimpar: [],
          numProdutosEsperado: 0,
          vezeUsado: 0
        };
      }
      
      const palavrasAtual = template.palavrasLimpar || [];

      if (palavrasAtual.includes(palavraNormalizada)) {
        showNotification(`‚ö†Ô∏è "${palavra}" j√° est√° na lista de limpeza!`, 'warning');
        return prevTemplates; // Retornar sem mudan√ßas
      }
      
      const novasPalavras = [...palavrasAtual, palavraNormalizada];
      
      const novoTemplate = {
        ...template,
        palavrasLimpar: novasPalavras
      };
      
      const index = prevTemplates.findIndex(t => t.nifFornecedor === nifFornecedor);
      const novos = index === -1 
        ? [...prevTemplates, novoTemplate]
        : prevTemplates.map((t, i) => i === index ? novoTemplate : t);
      
      showNotification(`üßπ "${palavra}" adicionado √† lista de limpeza. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
      
      return novos;
    });
  };
  
  /**
   * üÜï BUSCA HIST√ìRICO DE COMPRAS DE UM INGREDIENTE
   * Retorna dados da √∫ltima compra para auto-preencher quantidade, unidade e pre√ßo
   */
  const buscarHistoricoIngrediente = (ingredienteId, nifFornecedor = null) => {
    if (!ingredienteId) return null;

    const comprasHistoricas = [];
    
    faturas.forEach(fatura => {

      if (nifFornecedor && fatura.fornecedorNif !== nifFornecedor) return;

      if (fatura.itens && Array.isArray(fatura.itens)) {
        fatura.itens.forEach(item => {
          if (item.ingredienteId === ingredienteId) {
            comprasHistoricas.push({
              quantidade: item.quantidade,
              unidade: item.unidade,
              precoUnitario: item.precoUnitario,
              precoTotal: item.precoTotal,
              data: fatura.data,
              fornecedorNif: fatura.fornecedorNif,
              fornecedorNome: fatura.fornecedorNome
            });
          }
        });
      }
    });

    if (comprasHistoricas.length === 0) return null;

    comprasHistoricas.sort((a, b) => new Date(b.data) - new Date(a.data));

    const maisRecente = comprasHistoricas[0];
    
    return {
      quantidade: maisRecente.quantidade,
      unidade: maisRecente.unidade,
      precoUnitario: maisRecente.precoUnitario,
      precoTotal: maisRecente.precoTotal,
      dataUltimaCompra: maisRecente.data,
      fornecedorNif: maisRecente.fornecedorNif,
      fornecedorNome: maisRecente.fornecedorNome,
      historicoCompleto: comprasHistoricas // Para an√°lise de tend√™ncias
    };
  };

  /**
   * üÜï CALCULA ESTAT√çSTICAS DO HIST√ìRICO
   * Para mostrar varia√ß√£o de pre√ßos ao usu√°rio
   */
  const calcularEstatisticasHistorico = (ingredienteId, nifFornecedor = null) => {
    const historico = buscarHistoricoIngrediente(ingredienteId, nifFornecedor);
    
    if (!historico || !historico.historicoCompleto || historico.historicoCompleto.length === 0) {
      return null;
    }
    
    const precos = historico.historicoCompleto.map(h => h.precoUnitario);
    const precoMedio = precos.reduce((a, b) => a + b, 0) / precos.length;
    const precoMinimo = Math.min(...precos);
    const precoMaximo = Math.max(...precos);
    const variacaoPreco = precoMaximo - precoMinimo;
    const variacaoPercentual = precoMinimo > 0 ? ((variacaoPreco / precoMinimo) * 100) : 0;
    
    return {
      precoMedio,
      precoMinimo,
      precoMaximo,
      variacaoPreco,
      variacaoPercentual,
      numeroCompras: precos.length
    };
  };

  /**
   * üÜï APLICAR HIST√ìRICO AO MATCH
   * Preenche automaticamente quantidade, unidade e sugere pre√ßo baseado em compras anteriores
   */
  const aplicarHistoricoAoMatch = (linha, ingredienteId, nifFornecedor) => {

    const vocabEntry = vocabularioFornecedor.find(
      v => v.fornecedorNIF === nifFornecedor && 
           v.ingredienteId === ingredienteId &&
           v.confirmacoes >= 2 // S√≥ usar se j√° confirmado 2+ vezes
    );
    
    if (vocabEntry) {

      return {
        ...linha,

        quantidade: linha.quantidade || vocabEntry.ultimaQuantidade,
        unidade: linha.unidade || vocabEntry.ultimaUnidade,
        preco: linha.preco || vocabEntry.ultimoPreco,

        precoSugerido: vocabEntry.ultimoPreco,

        preenchidoComVocabulario: true
      };
    }

    const historico = buscarHistoricoIngrediente(ingredienteId, nifFornecedor);
    
    if (historico) {

      const estatisticas = calcularEstatisticasHistorico(ingredienteId, nifFornecedor);

      return {
        ...linha,

        quantidade: linha.quantidade || historico.quantidade,

        unidade: linha.unidade || historico.unidade,

        precoSugerido: historico.precoUnitario,
        precoTotalSugerido: historico.precoTotal,
        dataUltimaCompra: historico.dataUltimaCompra,

        preco: linha.preco || historico.precoTotal,

        estatisticasHistorico: estatisticas,

        preenchidoComHistorico: true
      };
    }
    
    return linha;
  };

  const aprenderTemplateOCR = (nifFornecedor, texto, linhasValidadas) => {
    if (!nifFornecedor) return;
    
    const layout = detectarLayoutFatura(texto);
    const template = {
      nifFornecedor,
      linhaInicio: layout.linhaInicio,
      linhaFim: layout.linhaFim,
      blacklist: [], // üö´ Lista de palavras a ignorar
      numProdutosEsperado: linhasValidadas.length,
      vezeUsado: 1
    };
    
    setTemplatesOCR(prevTemplates => {
      const index = prevTemplates.findIndex(t => t.nifFornecedor === nifFornecedor);
      
      if (index !== -1) {
        const atual = prevTemplates[index];
        const novoTemplate = {
          ...atual,
          linhaInicio: Math.round((atual.linhaInicio + layout.linhaInicio) / 2),
          linhaFim: Math.round((atual.linhaFim + layout.linhaFim) / 2),
          blacklist: atual.blacklist || [], // Preservar blacklist
          vezeUsado: atual.vezeUsado + 1
        };
        const novos = [...prevTemplates];
        novos[index] = novoTemplate;

        return novos;
      } else {

        return [...prevTemplates, template];
      }
    });
  };
  
  const parseComTemplate = (texto, template) => {
    if (!template) return parseLinhasProdutos(texto, template?.nifFornecedor);

    let linhas = texto.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    const linhasSeparadas = [];
    for (const linha of linhas) {
      const produtos = separarProdutosColados(linha);
      linhasSeparadas.push(...produtos);
    }
    linhas = linhasSeparadas;

    const blacklist = template.blacklist || [];
    const palavrasLimpar = template.palavrasLimpar || []; // üßπ Palavras a limpar

    const linhasProdutos = [];
    let linhasIgnoradasBlacklist = 0;
    let linhasIgnoradasFiltro = 0;
    
    for (let i = 0; i < linhas.length; i++) {
      const linha = linhas[i];
      if (!linha) continue;

      const linhaLower = linha.toLowerCase();

      const palavrasBloqueadoras = blacklist.filter(palavra => linhaLower.includes(palavra.toLowerCase()));
      
      if (palavrasBloqueadoras.length > 0) {

        const mensagemBlacklist = `Bloqueada por: ${palavrasBloqueadoras.map(p => `"${p}"`).join(', ')}`;

        linhasIgnoradasBlacklist++;
        continue;
      }

      if (shouldIgnoreLine(linha)) {
        linhasIgnoradasFiltro++;
        continue;
      }

      const parsed = parseLinha(linha, palavrasLimpar);
      if (parsed && parsed.nomeProduto) {
        linhasProdutos.push(parsed);
      }
    }

    return linhasProdutos;
  };

  const exportarDados = () => {

    
    const dados = {
      versao: '2.0',
      dataExport: new Date().toISOString(),
      fonte: 'Estados React (mesmos dados do Google Drive)',
      produtos,
      ingredientes,
      vendas,
      despesas,
      fornecedores,
      dadosEmpresa,
      faturas,
      vocabularioFornecedor, // üß† Incluir aprendizagem
      templatesOCR, // üìã Incluir templates
      configuracaoWaste, // üÜï Waste tracking config
      contagens, // üÜï Hist√≥rico de contagens
      movimentacoesStock // üÜï STOCK INTELIGENTE
    };
    
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `munchi-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification('‚úÖ Backup exportado! (Dados do Google Drive)', 'success');
  };

  const importarDados = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const dados = JSON.parse(e.target.result);
        
        if (confirm('‚ö†Ô∏è Substituir todos os dados?')) {
          // üßπ Limpar ingredientes √≥rf√£os antes de definir o state
          if (dados.produtos && dados.ingredientes) {
            const { produtosLimpos, orfaosRemovidos } = limparIngredientesOrfaos(dados.produtos, dados.ingredientes);
            setProdutos(orfaosRemovidos > 0 ? produtosLimpos : dados.produtos);
          } else if (dados.produtos) {
            setProdutos(dados.produtos);
          }
          if (dados.ingredientes) setIngredientes(dados.ingredientes);
          if (dados.vendas) setVendas(dados.vendas);
          if (dados.despesas) setDespesas(dados.despesas);
          if (dados.fornecedores) setFornecedores(dados.fornecedores);
          if (dados.dadosEmpresa) setDadosEmpresa({
            nif: '',
            nome: '',
            morada: '',
            codigoPostal: '',
            cidade: '',
            cae: '',
            email: '',
            telefone: '',
            ...dados.dadosEmpresa
          });
          if (dados.faturas) {

            const faturasConvertidas = dados.faturas.map(f => {
              if (f.tipo === 'completa') {

                return {...f, tipo: 'FT'};
              }
              return f;
            });
            // üßπ Limpar ingredientes √≥rf√£os das faturas
            if (dados.ingredientes) {
              const { faturasLimpas, orfaosRemovidos: orfaosFaturas } = limparFaturasOrfas(faturasConvertidas, dados.ingredientes);
              setFaturas(orfaosFaturas > 0 ? faturasLimpas : faturasConvertidas);
            } else {
              setFaturas(faturasConvertidas);
            }
          }
          if (dados.vocabularioFornecedor) setVocabularioFornecedor(dados.vocabularioFornecedor); // üß† Importar aprendizagem
          if (dados.templatesOCR) setTemplatesOCR(dados.templatesOCR); // üìã Importar templates
          if (dados.configuracaoWaste) setConfiguracaoWaste(dados.configuracaoWaste); // üÜï Waste tracking config
          if (dados.contagens) setContagens(dados.contagens); // üÜï Contagens de invent√°rio
          if (dados.movimentacoesStock) setMovimentacoesStock(dados.movimentacoesStock); // üÜï STOCK INTELIGENTE

          setTimeout(() => {
            const novasMovimentacoes = [];
            let stocksAtualizados = {};

            // üßπ Usar dados limpos para recalcular
            let produtosParaCalculo = dados.produtos || [];
            let faturasParaCalculo = dados.faturas || [];
            if (dados.ingredientes) {
              const idsIng = new Set(dados.ingredientes.map(i => i.id));
              if (dados.produtos) {
                produtosParaCalculo = dados.produtos.map(p => {
                  if (!p.receita) return p;
                  const receitaLimpa = p.receita.filter(r => idsIng.has(r.ingredienteId));
                  return receitaLimpa.length !== p.receita.length ? { ...p, receita: receitaLimpa } : p;
                });
              }
              if (dados.faturas) {
                faturasParaCalculo = dados.faturas.map(f => {
                  if (!f.itens) return f;
                  const itensLimpos = f.itens.map(item => {
                    if (!item.ingredienteId || idsIng.has(item.ingredienteId)) return item;
                    const { ingredienteId, ...rest } = item;
                    return rest;
                  });
                  return { ...f, itens: itensLimpos };
                });
              }
            }

            if (dados.ingredientes) {
              dados.ingredientes.forEach(ing => {
                stocksAtualizados[ing.id] = ing.stockAtual || 0;
              });
            }

            if (dados.despesas && dados.ingredientes) {
              const compras = dados.despesas.filter(d => d.categoria === 'compras' && d.ingredienteId);

              compras
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .forEach(despesa => {
                  const ingrediente = dados.ingredientes.find(i => i.id === despesa.ingredienteId);
                  if (!ingrediente) {
                    console.warn(`‚ö†Ô∏è Ingrediente ${despesa.ingredienteId} n√£o encontrado na despesa`);
                    return;
                  }
                  
                  const quantidadeConvertida = converterParaUnidadeBase(
                    parseFloat(despesa.quantidade || 0),
                    despesa.unidade || ingrediente.unidade,
                    ingrediente.unidade
                  );
                  
                  const stockAnterior = stocksAtualizados[ingrediente.id] || 0;
                  const stockNovo = stockAnterior + quantidadeConvertida;
                  stocksAtualizados[ingrediente.id] = stockNovo;
                  
                  novasMovimentacoes.push({
                    id: Date.now() + Math.random(),
                    data: despesa.data,
                    tipo: 'entrada',
                    ingredienteId: ingrediente.id,
                    ingredienteNome: ingrediente.nome,
                    quantidade: quantidadeConvertida,
                    unidade: ingrediente.unidade,
                    stockAnterior: stockAnterior,
                    stockNovo: stockNovo,
                    fornecedor: despesa.fornecedor || 'N/A',
                    numeroDocumento: despesa.numeroDocumento || 'N/A',
                    precoTotal: parseFloat(despesa.valor || 0),
                    precoUnitario: parseFloat(despesa.valor || 0) / parseFloat(despesa.quantidade || 1),
                    observacao: `Compra: +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
                  });
                });
            }

            if (faturasParaCalculo.length > 0 && dados.ingredientes) {

              faturasParaCalculo
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .forEach(fatura => {
                  if (!fatura.itens || fatura.itens.length === 0) return;
                  
                  fatura.itens.forEach(item => {
                    if (!item.ingredienteId) return;
                    
                    const ingrediente = dados.ingredientes.find(i => i.id === item.ingredienteId);
                    if (!ingrediente) {
                      console.warn(`‚ö†Ô∏è Ingrediente ${item.ingredienteId} n√£o encontrado na fatura #${fatura.numeroDocumento || fatura.numero || 'N/A'} de ${fatura.fornecedor || 'N/A'} (data: ${fatura.data || 'N/A'}, item: "${item.descricao || item.nome || 'N/A'}")`);
                      return;
                    }
                    
                    const quantidadeConvertida = converterParaUnidadeBase(
                      parseFloat(item.quantidade || 0),
                      item.unidade || ingrediente.unidade,
                      ingrediente.unidade
                    );
                    
                    const stockAnterior = stocksAtualizados[ingrediente.id] || 0;
                    const stockNovo = stockAnterior + quantidadeConvertida;
                    stocksAtualizados[ingrediente.id] = stockNovo;
                    
                    novasMovimentacoes.push({
                      id: Date.now() + Math.random(),
                      data: fatura.data,
                      tipo: 'entrada',
                      ingredienteId: ingrediente.id,
                      ingredienteNome: ingrediente.nome,
                      quantidade: quantidadeConvertida,
                      unidade: ingrediente.unidade,
                      stockAnterior: stockAnterior,
                      stockNovo: stockNovo,
                      fornecedor: fatura.fornecedor || 'N/A',
                      numeroDocumento: fatura.numeroDocumento || fatura.numero || 'N/A',
                      precoTotal: parseFloat(item.total || 0),
                      precoUnitario: parseFloat(item.precoUnitario || 0),
                      observacao: `Compra (Fatura): +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
                    });
                  });
                });
            }

            if (dados.vendas && produtosParaCalculo.length > 0 && dados.ingredientes) {

              let vendasProcessadas = 0;
              let vendasSemReceita = 0;
              // Rastrear ingredientes em falta para avisar apenas uma vez por combina√ß√£o
              const ingredientesEmFalta = {};
              
              dados.vendas
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .forEach(venda => {
                  const produto = produtosParaCalculo.find(p => p.id === venda.produtoId);
                  if (!produto) {
                    console.warn(`‚ö†Ô∏è Produto ${venda.produtoId} n√£o encontrado`);
                    return;
                  }
                  
                  if (!produto.receita || produto.receita.length === 0) {
                    vendasSemReceita++;
                    return;
                  }
                  
                  vendasProcessadas++;
                  produto.receita.forEach(receitaItem => {
                    const ingrediente = dados.ingredientes.find(i => i.id === receitaItem.ingredienteId);
                    if (!ingrediente) {
                      // Registar ingrediente em falta sem spammar a consola
                      const chave = `${receitaItem.ingredienteId}|${produto.nome}`;
                      if (!ingredientesEmFalta[chave]) {
                        ingredientesEmFalta[chave] = { ingId: receitaItem.ingredienteId, produto: produto.nome, count: 0 };
                      }
                      ingredientesEmFalta[chave].count++;
                      return;
                    }

                    const quantidadeReceitaConvertida = converterParaUnidadeBase(
                      receitaItem.quantidade,
                      receitaItem.unidade || ingrediente.unidade,
                      ingrediente.unidade
                    );
                    
                    const quantidadeUsada = arredondar(quantidadeReceitaConvertida * parseFloat(venda.quantidade || 1));
                    const stockAnterior = arredondar(stocksAtualizados[ingrediente.id] || 0);
                    const stockNovo = arredondar(Math.max(0, stockAnterior - quantidadeUsada));
                    stocksAtualizados[ingrediente.id] = stockNovo;
                    
                    novasMovimentacoes.push({
                      id: Date.now() + Math.random(),
                      data: venda.data,
                      tipo: 'saida',
                      ingredienteId: ingrediente.id,
                      ingredienteNome: ingrediente.nome,
                      quantidade: quantidadeUsada,
                      unidade: ingrediente.unidade,
                      stockAnterior: stockAnterior,
                      stockNovo: stockNovo,
                      produtoId: produto.id,
                      produtoNome: produto.nome,
                      quantidadeProdutos: parseFloat(venda.quantidade || 1),
                      observacao: `Venda: -${quantidadeUsada.toFixed(2)} ${ingrediente.unidade} (${venda.quantidade}x ${produto.nome})`
                    });
                  });
                });

              // Resumo de ingredientes em falta (um aviso por combina√ß√£o)
              const chavesEmFalta = Object.keys(ingredientesEmFalta);
              if (chavesEmFalta.length > 0) {
                console.warn(`‚ö†Ô∏è Ingredientes em falta nas receitas (${chavesEmFalta.length} combina√ß√µes):`);
                chavesEmFalta.forEach(chave => {
                  const info = ingredientesEmFalta[chave];
                  console.warn(`   - "${info.produto}": ingrediente ${info.ingId} n√£o encontrado (${info.count} vendas afetadas)`);
                });
                console.warn(`üí° Dica: Verifique se estes ingredientes foram apagados ou se os IDs nas receitas est√£o corretos.`);
              }

            }

            let movimentacoesFinais;
            let stocksFinais = {};
            
            if (dados.movimentacoesStock && dados.movimentacoesStock.length > 0) {

              movimentacoesFinais = dados.movimentacoesStock;

              const movsOrdenadas = [...dados.movimentacoesStock].sort((a, b) => new Date(a.data) - new Date(b.data));
              
              movsOrdenadas.forEach(mov => {
                if (!stocksFinais[mov.ingredienteId]) {
                  stocksFinais[mov.ingredienteId] = 0;
                }
                
                if (mov.tipo === 'entrada') {
                  stocksFinais[mov.ingredienteId] += mov.quantidade;
                } else if (mov.tipo === 'saida') {
                  stocksFinais[mov.ingredienteId] -= mov.quantidade; // ‚úÖ Permite negativos!
                } else if (mov.tipo === 'ajuste') {
                  stocksFinais[mov.ingredienteId] += mov.quantidade; // ajuste pode ser + ou -
                }
              });
            } else {

              movimentacoesFinais = novasMovimentacoes;
              stocksFinais = stocksAtualizados;
            }
            
            setMovimentacoesStock(movimentacoesFinais);

            if (dados.ingredientes) {
              const ingredientesAtualizados = dados.ingredientes.map(ing => ({
                ...ing,
                stockAtual: stocksFinais[ing.id] !== undefined ? stocksFinais[ing.id] : (ing.stockAtual || 0)
              }));
              setIngredientes(ingredientesAtualizados);
            }
            
            const entradas = novasMovimentacoes.filter(m => m.tipo === 'entrada').length;
            const saidas = novasMovimentacoes.filter(m => m.tipo === 'saida').length;

          }, 500);
          
          showNotification('Dados importados com sucesso!', 'success');

          setActiveTab('dashboard');
          setDashboardSubTab('resumo');
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }, 100);
          event.target.value = '';
        }
      } catch (error) {
        showNotification('Erro ao importar!', 'error');
      }
    };
    reader.readAsText(file);
  };

  
  const exportarVendasCSV = () => {
    if (!vendas || (vendas || []).length === 0) {
      showNotification('Nenhuma venda para exportar!', 'error');
      return;
    }

    const filteredVendas = getFilteredData(vendas);
    
    if (filteredVendas.length === 0) {
      showNotification('Nenhuma venda no per√≠odo selecionado!', 'error');
      return;
    }

    const empresaInfo = [
      '===== RELAT√ìRIO OFICIAL DE VENDAS =====',
      `Empresa: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      `Per√≠odo: ${filteredVendas[0] ? new Date(filteredVendas[0].data).toLocaleDateString('pt-PT') : ''} a ${filteredVendas[filteredVendas.length - 1] ? new Date(filteredVendas[filteredVendas.length - 1].data).toLocaleDateString('pt-PT') : ''}`,
      `Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Registos: ${filteredVendas.length}`,
      '',
      '===== DETALHE DAS VENDAS =====',
      ''
    ];

    const headers = [
      'Data',
      'Produto/Servi√ßo',
      'Quantidade',
      'Unidade',
      'Pre√ßo Unit√°rio (s/ IVA)',
      'Valor Base (s/ IVA)',
      'Taxa IVA (%)',
      'Valor IVA',
      'Valor Total (c/ IVA)',
      'Tipo Documento',
      'N¬∫ Documento',
      'Observa√ß√µes'
    ];

    const rows = filteredVendas.map((v, index) => {
      const valorBase = v.valor;
      const valorIva = valorBase * (v.iva / 100);
      const valorTotal = valorBase + valorIva;
      const precoUnitario = v.quantidade > 0 ? valorBase / v.quantidade : 0;
      
      return [
        new Date(v.data).toISOString().split('T')[0], // Data formato ISO
        `"${v.produto}"`,
        v.quantidade || 1,
        'un',
        precoUnitario.toFixed(2),
        valorBase.toFixed(2),
        v.iva,
        valorIva.toFixed(2),
        valorTotal.toFixed(2),
        'Venda',
        `VND-${new Date(v.data).getFullYear()}-${String(index + 1).padStart(6, '0')}`,
        `"${v.observacoes || ''}"`
      ].join(';');
    });

    const resumoIVA = {};
    filteredVendas.forEach(v => {
      const taxa = v.iva;
      if (!resumoIVA[taxa]) {
        resumoIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = v.valor;
      const valorIva = valorBase * (taxa / 100);
      resumoIVA[taxa].base += valorBase;
      resumoIVA[taxa].iva += valorIva;
      resumoIVA[taxa].total += valorBase + valorIva;
      resumoIVA[taxa].count++;
    });
    
    const resumoSection = [
      '',
      '',
      '===== RESUMO POR TAXA DE IVA =====',
      'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;Valor IVA;Total',
      ...Object.entries(resumoIVA).map(([taxa, valores]) => 
        `${taxa}%;${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
      ),
      '',
      '===== TOTAIS GERAIS =====',
      `Total Base Tribut√°vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.base, 0).toFixed(2)}`,
      `Total IVA;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total Geral;${Object.values(resumoIVA).reduce((sum, v) => sum + v.total, 0).toFixed(2)}`,
      '',
      '',
      '===== INFORMA√á√ïES LEGAIS =====',
      'Este documento cont√©m informa√ß√£o fiscal relevante para efeitos de contabilidade e declara√ß√µes fiscais.',
      'Deve ser conservado de acordo com os prazos legais estabelecidos.',
      `Gerado automaticamente pelo sistema Munchi Manager em ${new Date().toLocaleString('pt-PT')}`
    ];

    const csvContent = [
      ...empresaInfo,
      headers.join(';'),
      ...rows,
      ...resumoSection
    ].join('\n');

    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const dataInicio = new Date(filteredVendas[0].data);
    const dataFim = new Date(filteredVendas[filteredVendas.length - 1].data);
    const nomeArquivo = `VENDAS_APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(`‚úÖ ${filteredVendas.length} vendas exportadas! Para vendas via Moloni/software certificado, n√£o √© necess√°rio enviar PDFs.`, 'success');
  };
  
  const exportarDespesasCSV = () => {
    if (!despesas || (despesas || []).length === 0) {
      showNotification('Nenhuma despesa para exportar!', 'error');
      return;
    }

    const filteredDespesas = getFilteredData(despesas);
    
    if (filteredDespesas.length === 0) {
      showNotification('Nenhuma despesa no per√≠odo selecionado!', 'error');
      return;
    }

    const empresaInfo = [
      '===== RELAT√ìRIO OFICIAL DE DESPESAS =====',
      `Empresa: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      `Per√≠odo: ${filteredDespesas[0] ? new Date(filteredDespesas[0].data).toLocaleDateString('pt-PT') : ''} a ${filteredDespesas[filteredDespesas.length - 1] ? new Date(filteredDespesas[filteredDespesas.length - 1].data).toLocaleDateString('pt-PT') : ''}`,
      `Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Registos: ${filteredDespesas.length}`,
      '',
      '===== DETALHE DAS DESPESAS =====',
      ''
    ];

    const headers = [
      'Data',
      'N¬∫ Documento',
      'Tipo Documento',
      'Fornecedor',
      'NIF Fornecedor',
      'Categoria',
      'Descri√ß√£o',
      'Valor Base (s/ IVA)',
      'Taxa IVA (%)',
      'Valor IVA',
      'Valor Total (c/ IVA)',
      'Forma Pagamento',
      'Dedut√≠vel IVA',
      'Observa√ß√µes'
    ];

    const rows = filteredDespesas.map((d, index) => {
      const valorBase = d.valor;
      const valorIva = valorBase * (d.iva / 100);
      const valorTotal = valorBase + valorIva;

      let fornecedorObj = null;
      if (d.fornecedor) {
        fornecedorObj = fornecedores.find(f => 
          (typeof f === 'object' && f.nome === d.fornecedor) || 
          (typeof f === 'string' && f === d.fornecedor)
        );
      }
      
      const fornecedorNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
      const fornecedorNome = d.fornecedor || 'N/A';

      const dedutivelIVA = d.iva > 0 ? 'Sim' : 'N/A';
      
      return [
        new Date(d.data).toISOString().split('T')[0], // Data formato ISO
        d.numeroDocumento || `DSP-${new Date(d.data).getFullYear()}-${String(index + 1).padStart(6, '0')}`,
        d.tipoDocumento || 'Fatura',
        `"${fornecedorNome}"`,
        fornecedorNif,
        `"${d.categoria}"`,
        `"${d.descricao}"`,
        valorBase.toFixed(2),
        d.iva,
        valorIva.toFixed(2),
        valorTotal.toFixed(2),
        d.formaPagamento || 'Transfer√™ncia',
        dedutivelIVA,
        `"${d.notas || ''}"`
      ].join(';');
    });

    const resumoCategoria = {};
    filteredDespesas.forEach(d => {
      const cat = d.categoria || 'Sem Categoria';
      if (!resumoCategoria[cat]) {
        resumoCategoria[cat] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = d.valor;
      const valorIva = valorBase * (d.iva / 100);
      resumoCategoria[cat].base += valorBase;
      resumoCategoria[cat].iva += valorIva;
      resumoCategoria[cat].total += valorBase + valorIva;
      resumoCategoria[cat].count++;
    });

    const resumoIVA = {};
    filteredDespesas.forEach(d => {
      const taxa = d.iva;
      if (!resumoIVA[taxa]) {
        resumoIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = d.valor;
      const valorIva = valorBase * (taxa / 100);
      resumoIVA[taxa].base += valorBase;
      resumoIVA[taxa].iva += valorIva;
      resumoIVA[taxa].total += valorBase + valorIva;
      resumoIVA[taxa].count++;
    });
    
    const resumoSection = [
      '',
      '',
      '===== RESUMO POR CATEGORIA =====',
      'Categoria;N¬∫ Opera√ß√µes;Valor Base;Valor IVA;Total',
      ...Object.entries(resumoCategoria)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([cat, valores]) => 
          `"${cat}";${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
        ),
      '',
      '===== RESUMO POR TAXA DE IVA =====',
      'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;Valor IVA;Total',
      ...Object.entries(resumoIVA).map(([taxa, valores]) => 
        `${taxa}%;${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
      ),
      '',
      '===== TOTAIS GERAIS =====',
      `Total Base Tribut√°vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.base, 0).toFixed(2)}`,
      `Total IVA Suportado;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total IVA Dedut√≠vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total Geral;${Object.values(resumoIVA).reduce((sum, v) => sum + v.total, 0).toFixed(2)}`,
      '',
      '',
      '===== FORNECEDORES =====',
      'Fornecedor;NIF;Total Faturado',
      ...(() => {
        const fornecedorTotais = {};
        filteredDespesas.forEach(d => {
          const fornNome = d.fornecedor || 'N/A';
          let fornecedorObj = null;
          if (d.fornecedor) {
            fornecedorObj = fornecedores.find(f => 
              (typeof f === 'object' && f.nome === d.fornecedor) || 
              (typeof f === 'string' && f === d.fornecedor)
            );
          }
          const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
          
          const key = `${fornNome}|${fornNif}`;
          if (!fornecedorTotais[key]) {
            fornecedorTotais[key] = 0;
          }
          fornecedorTotais[key] += d.valor * (1 + d.iva / 100);
        });
        
        return Object.entries(fornecedorTotais)
          .sort((a, b) => b[1] - a[1])
          .map(([key, total]) => {
            const [nome, nif] = key.split('|');
            return `"${nome}";${nif};${total.toFixed(2)}`;
          });
      })(),
      '',
      '',
      '===== INFORMA√á√ïES LEGAIS =====',
      'Este documento cont√©m informa√ß√£o fiscal relevante para efeitos de contabilidade e declara√ß√µes fiscais.',
      'Os valores de IVA dedut√≠vel devem ser confirmados com a contabilidade conforme legisla√ß√£o aplic√°vel.',
      'Deve ser conservado de acordo com os prazos legais estabelecidos.',
      `Gerado automaticamente pelo sistema Munchi Manager em ${new Date().toLocaleString('pt-PT')}`
    ];

    const csvContent = [
      ...empresaInfo,
      headers.join(';'),
      ...rows,
      ...resumoSection
    ].join('\n');

    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const dataInicio = new Date(filteredDespesas[0].data);
    const dataFim = new Date(filteredDespesas[filteredDespesas.length - 1].data);
    const nomeArquivo = `DESPESAS_APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(`‚úÖ ${filteredDespesas.length} despesas exportadas! ‚ö†Ô∏è IMPORTANTE: Enviar tamb√©m os PDFs das faturas ao contabilista!`, 'success');
  };

  const exportarRelatorioCompletoCSV = () => {
    const filteredVendas = getExportFilteredData(vendas || []);

    const filteredFaturasTemp = getExportFilteredData(faturas || []);

    const filteredFaturasSemRecibos = filteredFaturasTemp.filter(f => 
      f.tipoDocumento === 'fatura' || !f.tipoDocumento
    );

    const filteredFaturas = filteredFaturasSemRecibos.filter(f => {

      if (f.tipo !== 'FS') return true;

      return f.temNifCliente === true;
    });
    
    const recibosIgnorados = filteredFaturasTemp.length - filteredFaturasSemRecibos.length;
    const fsComNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente === true
    ).length;
    const fsSemNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente !== true
    ).length;
    
    if (recibosIgnorados > 0 || fsComNif > 0 || fsSemNif > 0) {
      let msg = '‚ÑπÔ∏è Faturas: ';
      const partes = [];
      if (recibosIgnorados > 0) partes.push(`${recibosIgnorados} recibo(s) exclu√≠dos`);
      if (fsComNif > 0) partes.push(`${fsComNif} FS com NIF (inclu√≠das)`);
      if (fsSemNif > 0) partes.push(`${fsSemNif} FS sem NIF (exclu√≠das)`);
      msg += partes.join(' | ');

    }
    
    if (filteredVendas.length === 0 && filteredFaturas.length === 0) {
      showNotification('Nenhum dado para exportar no per√≠odo selecionado!', 'error');
      return;
    }

    const empresaInfo = [
      '='.repeat(80),
      'RELAT√ìRIO DE APOIO CONTABIL√çSTICO',
      '='.repeat(80),
      '',
      '‚ö†Ô∏è  AVISO LEGAL IMPORTANTE:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      'N√ÉO substitui os documentos fiscais originais (faturas em PDF).',
      'Para efeitos de Autoridade Tribut√°ria, √© obrigat√≥rio conservar os PDFs originais.',
      '',
      '===== IDENTIFICA√á√ÉO DA EMPRESA =====',
      `Nome: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      '===== INFORMA√á√ÉO DO RELAT√ìRIO =====',
      `Per√≠odo: ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.min(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''} a ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.max(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''}`,
      `Data de Emiss√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Vendas: ${filteredVendas.length} registos`,
      `Total de Faturas: ${filteredFaturas.length} registos`,
      '',
      ''
    ];

    const vendasSection = [
      '=' .repeat(80),
      'SEC√á√ÉO 1: RECEITAS E VENDAS',
      '='.repeat(80),
      ''
    ];
    
    if (filteredVendas.length > 0) {
      const vendasHeaders = [
        'Data',
        'N¬∫ Doc',
        'Tipo Doc',
        'Produto/Servi√ßo',
        'Origem', // ‚Üê NOVO
        'Qtd',
        'Pre√ßo Unit (s/ IVA)',
        'Base (s/ IVA)',
        'Taxa IVA',
        'Valor IVA',
        'Total (c/ IVA)',
        'Forma Pag',
        'Obs'
      ];
      
      const vendasRows = filteredVendas.map((v, idx) => {
        const valorBase = v.valor;
        const valorIva = valorBase * (v.iva / 100);
        const valorTotal = valorBase + valorIva;
        const precoUnit = v.quantidade > 0 ? valorBase / v.quantidade : 0;
        const origem = v.origem === 'moloni' ? 'MOLONI' : 
                      v.origem === 'zobaze' ? 'ZOBAZE' : 'MANUAL';
        
        return [
          new Date(v.data).toISOString().split('T')[0],
          v.numeroDocumento || `VND-${new Date(v.data).getFullYear()}-${String(idx + 1).padStart(6, '0')}`,
          v.tipoDocumento || 'Venda',
          `"${v.produto}"`,
          origem, // ‚Üê NOVO
          v.quantidade || 1,
          precoUnit.toFixed(2),
          valorBase.toFixed(2),
          `${v.iva}%`,
          valorIva.toFixed(2),
          valorTotal.toFixed(2),
          v.formaPagamento || 'N/A',
          `"${v.observacoes || ''}"`
        ].join(';');
      });
      
      vendasSection.push(vendasHeaders.join(';'), ...vendasRows);

      const resumoVendasIVA = {};
      filteredVendas.forEach(v => {
        const taxa = v.iva;
        if (!resumoVendasIVA[taxa]) {
          resumoVendasIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = v.valor;
        const valorIva = valorBase * (taxa / 100);
        resumoVendasIVA[taxa].base += valorBase;
        resumoVendasIVA[taxa].iva += valorIva;
        resumoVendasIVA[taxa].total += valorBase + valorIva;
        resumoVendasIVA[taxa].count++;
      });
      
      vendasSection.push(
        '',
        '--- RESUMO DE VENDAS POR TAXA IVA ---',
        'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;IVA Liquidado;Total',
        ...Object.entries(resumoVendasIVA).map(([taxa, v]) =>
          `${taxa}%;${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
        ),
        '',
        '--- TOTAIS DE VENDAS ---',
        `Total Base Tribut√°vel (Vendas);${Object.values(resumoVendasIVA).reduce((s, v) => s + v.base, 0).toFixed(2)}`,
        `Total IVA Liquidado;${Object.values(resumoVendasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total Receitas;${Object.values(resumoVendasIVA).reduce((s, v) => s + v.total, 0).toFixed(2)}`
      );
    } else {
      vendasSection.push('Nenhuma venda registada no per√≠odo selecionado.');
    }
    
    vendasSection.push('', '');

    const faturasSection = [
      '='.repeat(80),
      'SEC√á√ÉO 2: FATURAS DE FORNECEDORES',
      '='.repeat(80),
      ''
    ];
    
    if (filteredFaturas.length > 0) {
      const faturasHeaders = [
        'Data',
        'N¬∫ Doc',
        'Tipo',
        'Fornecedor',
        'NIF Forn',
        'Categoria',
        'Base (s/ IVA)',
        'Taxa IVA',
        'Valor IVA',
        'Total (c/ IVA)',
        'Tem PDF',
        'Notas'
      ];
      
      const faturasRows = filteredFaturas.map((f, idx) => {

        const valorBase = f.totais?.subtotal || f.subtotal || 0;
        const valorIva = f.totais?.iva || f.totalIva || 0;
        const valorTotal = f.totais?.total || f.total || 0;

        const taxaIva = valorBase > 0 ? ((valorIva / valorBase) * 100).toFixed(0) : 0;
        
        return [
          new Date(f.data).toISOString().split('T')[0],
          f.numero || `FAT-${new Date(f.data).getFullYear()}-${String(idx + 1).padStart(6, '0')}`,
          f.tipo || 'FT',
          `"${f.fornecedorNome || 'N/A'}"`,
          f.fornecedorNif || '',
          `"${f.categoria || 'compras'}"`,
          valorBase.toFixed(2),
          `${taxaIva}%`,
          valorIva.toFixed(2),
          valorTotal.toFixed(2),
          f.documentoPDF ? 'Sim' : 'N√£o',
          `"${f.notas || ''}"`
        ].join(';');
      });
      
      faturasSection.push(faturasHeaders.join(';'), ...faturasRows);

      const resumoFaturasCat = {};
      filteredFaturas.forEach(f => {
        const cat = f.categoria || 'compras';
        if (!resumoFaturasCat[cat]) {
          resumoFaturasCat[cat] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = f.totais?.subtotal || f.subtotal || 0;
        const valorIva = f.totais?.iva || f.totalIva || 0;
        resumoFaturasCat[cat].base += valorBase;
        resumoFaturasCat[cat].iva += valorIva;
        resumoFaturasCat[cat].total += valorBase + valorIva;
        resumoFaturasCat[cat].count++;
      });

      const resumoFaturasIVA = {};
      filteredFaturas.forEach(f => {
        const valorBase = f.totais?.subtotal || f.subtotal || 0;
        const valorIva = f.totais?.iva || f.totalIva || 0;

        const taxa = valorBase > 0 ? Math.round((valorIva / valorBase) * 100) : 0;
        
        if (!resumoFaturasIVA[taxa]) {
          resumoFaturasIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        resumoFaturasIVA[taxa].base += valorBase;
        resumoFaturasIVA[taxa].iva += valorIva;
        resumoFaturasIVA[taxa].total += valorBase + valorIva;
        resumoFaturasIVA[taxa].count++;
      });
      
      faturasSection.push(
        '',
        '--- RESUMO DE FATURAS POR CATEGORIA ---',
        'Categoria;N¬∫ Opera√ß√µes;Base;IVA;Total',
        ...Object.entries(resumoFaturasCat)
          .sort((a, b) => b[1].total - a[1].total)
          .map(([cat, v]) =>
            `"${cat}";${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
          ),
        '',
        '--- RESUMO DE FATURAS POR TAXA IVA ---',
        'Taxa IVA;N¬∫ Opera√ß√µes;Base;IVA Suportado;Total',
        ...Object.entries(resumoFaturasIVA).map(([taxa, v]) =>
          `${taxa}%;${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
        ),
        '',
        '--- TOTAIS DE FATURAS ---',
        `Total Base (Faturas);${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.base, 0).toFixed(2)}`,
        `Total IVA Suportado;${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total IVA Dedut√≠vel;${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total Faturas;${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.total, 0).toFixed(2)}`
      );
    } else {
      faturasSection.push('Nenhuma fatura registada no per√≠odo selecionado.');
    }
    
    faturasSection.push('', '');

    const totalVendasBase = filteredVendas.reduce((sum, v) => sum + v.valor, 0);
    const totalVendasIVA = filteredVendas.reduce((sum, v) => sum + (v.valor * v.iva / 100), 0);
    const totalVendas = totalVendasBase + totalVendasIVA;
    
    const totalFaturasBase = filteredFaturas.reduce((sum, f) => sum + (f.totais?.subtotal || f.subtotal || 0), 0);
    const totalFaturasIVA = filteredFaturas.reduce((sum, f) => sum + (f.totais?.iva || f.totalIva || 0), 0);
    const totalFaturas = totalFaturasBase + totalFaturasIVA;
    
    const saldoIVA = totalVendasIVA - totalFaturasIVA;
    const resultadoLiquido = totalVendas - totalFaturas;
    
    const resumoFiscal = [
      '='.repeat(80),
      'SEC√á√ÉO 3: RESUMO FISCAL E FINANCEIRO',
      '='.repeat(80),
      '',
      '--- APURAMENTO DE IVA ---',
      `IVA Liquidado (Vendas);${totalVendasIVA.toFixed(2)}`,
      `IVA Dedut√≠vel (Faturas);${totalFaturasIVA.toFixed(2)}`,
      `Saldo de IVA;${saldoIVA.toFixed(2)};${saldoIVA >= 0 ? 'A ENTREGAR ao Estado' : 'A RECEBER do Estado'}`,
      '',
      '--- DEMONSTRA√á√ÉO DE RESULTADOS (SIMPLIFICADA) ---',
      `Total de Vendas (c/ IVA);${totalVendas.toFixed(2)}`,
      `Total de Faturas (c/ IVA);${totalFaturas.toFixed(2)}`,
      `Resultado L√≠quido;${resultadoLiquido.toFixed(2)};${resultadoLiquido >= 0 ? 'LUCRO' : 'PREJU√çZO'}`,
      '',
      '--- VALORES BASE (s/ IVA) ---',
      `Vendas (Base);${totalVendasBase.toFixed(2)}`,
      `Faturas (Base);${totalFaturasBase.toFixed(2)}`,
      `Margem Bruta;${(totalVendasBase - totalFaturasBase).toFixed(2)}`,
      ''
    ];

    if (filteredDespesas.length > 0) {
      const fornecedorTotais = {};
      filteredDespesas.forEach(d => {
        const fornNome = d.fornecedor || 'N/A';
        let fornecedorObj = null;
        if (d.fornecedor) {
          fornecedorObj = fornecedores.find(f => 
            (typeof f === 'object' && f.nome === d.fornecedor) || 
            (typeof f === 'string' && f === d.fornecedor)
          );
        }
        const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
        
        const key = `${fornNome}|${fornNif}`;
        if (!fornecedorTotais[key]) {
          fornecedorTotais[key] = 0;
        }
        fornecedorTotais[key] += d.valor * (1 + d.iva / 100);
      });
      
      resumoFiscal.push(
        '',
        '='.repeat(80),
        'SEC√á√ÉO 4: AN√ÅLISE DE FORNECEDORES',
        '='.repeat(80),
        '',
        'Fornecedor;NIF;Total Faturado',
        ...Object.entries(fornecedorTotais)
          .sort((a, b) => b[1] - a[1])
          .map(([key, total]) => {
            const [nome, nif] = key.split('|');
            return `"${nome}";${nif};${total.toFixed(2)}`;
          })
      );
    }

    const rodape = [
      '',
      '',
      '='.repeat(80),
      'INFORMA√á√ïES LEGAIS E DECLARA√á√ïES',
      '='.repeat(80),
      '',
      'üìã NATUREZA DESTE DOCUMENTO:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      '',
      '‚ö†Ô∏è  IMPORTANTE - OBRIGA√á√ïES LEGAIS:',
      '',
      '1. DOCUMENTOS FISCAIS ORIGINAIS (OBRIGAT√ìRIO):',
      '   - As FATURAS EM PDF dos fornecedores s√£o OBRIGAT√ìRIAS',
      '   - Devem ser conservadas durante 10 anos',
      '   - S√£o a √öNICA prova aceite pela Autoridade Tribut√°ria',
      '   - Este CSV N√ÉO substitui os documentos fiscais',
      '',
      '2. PARA ENTREGAR AO CONTABILISTA:',
      '   ‚úì Este ficheiro CSV (dados estruturados)',
      '   ‚úì PASTA COM TODOS OS PDFs das faturas de fornecedores',
      '   ‚úì Faturas de vendas emitidas via software certificado (ex: Moloni)',
      '',
      '3. VENDAS:',
      '   - Se usa software certificado (Moloni, etc): comunica√ß√£o autom√°tica √† AT',
      '   - Este CSV serve apenas para controlo interno e confer√™ncia',
      '',
      '4. DESPESAS:',
      '   - Cada despesa DEVE ter a fatura original em PDF',
      '   - O PDF √© necess√°rio para dedu√ß√£o de IVA',
      '   - Sem PDF, a AT pode rejeitar a dedu√ß√£o',
      '',
      'Conforme:',
      '  - C√≥digo do IVA (CIVA)',
      '  - Lei Geral Tribut√°ria',
      '  - Decreto-Lei n.¬∫ 28/2019 (SAF-T)',
      '',
      `Documento gerado pelo sistema Munchi Manager`,
      `Data e hora: ${new Date().toLocaleString('pt-PT')}`,
      `Empresa: ${dadosEmpresa.nome || 'N/A'} (NIF: ${dadosEmpresa.nif || 'N/A'})`,
      '',
      '='.repeat(80),
      'FIM DO RELAT√ìRIO',
      '='.repeat(80)
    ];

    const csvContent = [
      ...empresaInfo,
      ...vendasSection,
      ...faturasSection,
      ...resumoFiscal,
      ...rodape
    ].join('\n');

    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const todasDatas = [...filteredVendas, ...filteredFaturas].map(x => new Date(x.data));
    const dataInicio = todasDatas.length > 0 ? new Date(Math.min(...todasDatas)) : new Date();
    const dataFim = todasDatas.length > 0 ? new Date(Math.max(...todasDatas)) : new Date();
    const nomeArquivo = `APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    let msg = `‚úÖ Export para contabilista: ${filteredVendas.length} vendas + ${filteredFaturas.length} faturas`;
    if (recibosIgnorados > 0 || fsIgnoradas > 0) {
      msg += `\n\n‚ö†Ô∏è Exclu√≠dos: `;
      if (recibosIgnorados > 0) msg += `${recibosIgnorados} recibo(s) `;
      if (fsIgnoradas > 0) msg += `${fsIgnoradas} FS `;
    }
    msg += '\n\nüìé N√£o esquecer os PDFs das faturas!';
    
    showNotification(msg, 'success');
  };

  const exportarPacoteCompleto = async () => {
    const filteredVendas = getExportFilteredData(vendas || []);
    const filteredFaturasCompletas = getExportFilteredData(faturas || []); // Todas

    const filteredFaturasSemRecibos = filteredFaturasCompletas.filter(f => 
      f.tipoDocumento === 'fatura' || !f.tipoDocumento // Retrocompatibilidade
    );

    const filteredFaturas = filteredFaturasSemRecibos.filter(f => {

      if (f.tipo !== 'FS') return true;

      return f.temNifCliente === true;
    });
    
    const recibosIgnorados = filteredFaturasCompletas.length - filteredFaturasSemRecibos.length;
    const fsComNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente === true
    ).length;
    const fsSemNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente !== true
    ).length;
    
    if (filteredVendas.length === 0 && filteredFaturas.length === 0) {
      showNotification('Nenhum dado para exportar no per√≠odo selecionado!', 'error');
      return;
    }

    const faturasComPDF = filteredFaturas.filter(f => f.documentoPDF);
    const faturasSemPDF = filteredFaturas.filter(f => !f.documentoPDF);

    let avisos = [];
    if (recibosIgnorados > 0) {
      avisos.push(`${recibosIgnorados} recibo(s)`);
    }
    if (fsComNif > 0) {
      avisos.push(`${fsComNif} FS com NIF (inclu√≠das ‚úÖ)`);
    }
    if (fsSemNif > 0) {
      avisos.push(`${fsSemNif} FS sem NIF (exclu√≠das)`);
    }
    if (avisos.length > 0) {
      const msg = `‚ÑπÔ∏è Nota: ${avisos.join(' | ')}`;

    }
    
    if (faturasSemPDF.length > 0) {
      let mensagemAviso = `‚ö†Ô∏è ATEN√á√ÉO!\n\n${faturasSemPDF.length} fatura(s) N√ÉO t√™m PDF anexado.\n`;
      
      if (recibosIgnorados > 0 || fsComNif > 0 || fsSemNif > 0) {
        mensagemAviso += `\nInforma√ß√£o sobre documentos:\n`;
        if (recibosIgnorados > 0) mensagemAviso += `‚Ä¢ ${recibosIgnorados} recibo(s) - exclu√≠dos\n`;
        if (fsComNif > 0) mensagemAviso += `‚Ä¢ ${fsComNif} FS com NIF - inclu√≠das ‚úÖ\n`;
        if (fsSemNif > 0) mensagemAviso += `‚Ä¢ ${fsSemNif} FS sem NIF - exclu√≠das\n`;
        mensagemAviso += `\n`;
      }
      
      mensagemAviso += `Sem PDFs, o contabilista n√£o pode deduzir IVA!\n\nDeseja continuar mesmo assim?`;
      
      const confirmar = confirm(mensagemAviso);
      if (!confirmar) return;
    }
    
    showNotification('üì¶ A criar pacote completo... Aguarde!', 'info');
    
    try {

      const csvContent = gerarCSVCompleto(filteredVendas, filteredFaturas);

      const zip = new JSZip();

      const todasDatas = [...filteredVendas, ...filteredFaturas].map(x => new Date(x.data));
      const dataInicio = todasDatas.length > 0 ? new Date(Math.min(...todasDatas)) : new Date();
      const dataFim = todasDatas.length > 0 ? new Date(Math.max(...todasDatas)) : new Date();
      const periodoStr = `${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}`;
      
      const BOM = '\uFEFF';
      zip.file(`APOIO_CONTABILISTICO_${periodoStr}.csv`, BOM + csvContent);

      const pdfFolder = zip.folder(`PDFs_Fornecedores_${periodoStr}`);
      
      let pdfsAdicionados = 0;
      let pdfsComErro = 0;
      
      filteredFaturas.forEach((fatura, index) => {
        if (fatura.documentoPDF) {
          try {

            let base64Data = fatura.documentoPDF;

            if (base64Data.includes(',')) {
              base64Data = base64Data.split(',')[1];
            }

            base64Data = base64Data.trim().replace(/\s/g, '');

            if (!base64Data || base64Data.length < 100) {

              pdfsComErro++;
              return; // Skip este PDF
            }

            const base64Regex = /^[A-Za-z0-9+/]+=*$/;
            if (!base64Regex.test(base64Data)) {

              pdfsComErro++;
              return; // Skip este PDF
            }

            if (!base64Data.startsWith('JVBERi0')) {

              pdfsComErro++;
              return; // Skip este PDF
            }

            const dataStr = new Date(fatura.data).toISOString().split('T')[0].replace(/-/g, '');
            const fornecedor = fatura.fornecedorNome || 'SemFornecedor';

            const fornecedorClean = fornecedor
              .replace(/[\/\\:*?"<>|]/g, '') // Remove caracteres proibidos no Windows
              .replace(/[^a-zA-Z0-9\s]/g, '_') // Substitui outros especiais por _
              .replace(/\s+/g, '_') // Espa√ßos viram _
              .substring(0, 30); // Limita tamanho
            
            const numDoc = fatura.numero || `FAT${String(index + 1).padStart(4, '0')}`;

            const numDocClean = numDoc
              .replace(/[\/\\:*?"<>|]/g, '_')
              .replace(/[^a-zA-Z0-9]/g, '_');
            
            const nomeArquivo = `${dataStr}_${fornecedorClean}_${numDocClean}.pdf`;
            
            pdfFolder.file(nomeArquivo, base64Data, {base64: true});
            pdfsAdicionados++;
            
          } catch (error) {

            pdfsComErro++;
          }
        }
      });

      const zipBlob = await zip.generateAsync({type: 'blob'});
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `PACOTE_CONTABILIDADE_${periodoStr}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      let mensagemFinal = `‚úÖ Pacote completo criado!\n\nüìÑ CSV: 1 ficheiro\nüìé PDFs: ${pdfsAdicionados} documento(s)`;
      
      if (pdfsComErro > 0) {
        mensagemFinal += `\n‚ö†Ô∏è PDFs com erro: ${pdfsComErro} (vazios ou corrompidos)`;
      }
      
      if (faturasSemPDF.length > 0) {
        mensagemFinal += `\n‚ö†Ô∏è Sem PDF: ${faturasSemPDF.length} fatura(s)`;
      }
      
      showNotification(mensagemFinal, pdfsComErro > 0 ? 'warning' : 'success');
      
    } catch (error) {

      showNotification('‚ùå Erro ao criar pacote! Veja o console (F12).', 'error');
    }
  };

  const gerarCSVCompleto = (filteredVendas, filteredFaturas) => {

    const empresaInfo = [
      '='.repeat(80),
      'RELAT√ìRIO DE APOIO CONTABIL√çSTICO',
      '='.repeat(80),
      '',
      '‚ö†Ô∏è  AVISO LEGAL IMPORTANTE:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      'N√ÉO substitui os documentos fiscais originais (faturas em PDF).',
      'Para efeitos de Autoridade Tribut√°ria, √© obrigat√≥rio conservar os PDFs originais.',
      '',
      '===== IDENTIFICA√á√ÉO DA EMPRESA =====',
      `Nome: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      '===== INFORMA√á√ÉO DO RELAT√ìRIO =====',
      `Per√≠odo: ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.min(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''} a ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.max(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''}`,
      `Data de Emiss√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Vendas: ${filteredVendas.length} registos`,
      `Total de Faturas: ${filteredFaturas.length} registos`,
      '',
      ''
    ];

    const csvSimples = [
      ...empresaInfo,
      '',
      '='.repeat(80),
      'VENDAS E FATURAS',
      '='.repeat(80),
      '',
      `Total Vendas: ${filteredVendas.length}`,
      `Total Faturas: ${filteredFaturas.length}`,
      '',
      '(Relat√≥rio completo gerado automaticamente)',
      ''
    ].join('\n');
    
    return csvSimples;
  };

  const GoogleDriveTokenManager = {
    TOKEN_KEY: 'munchi_drive_token',
    CHECK_INTERVAL: 60000, // Verificar a cada 1 minuto
    RENEWAL_BUFFER: 5 * 60 * 1000, // Renovar 5 min antes de expirar
    
    /**
     * Verifica se o token ainda √© v√°lido
     */
    isTokenValid() {
      const tokenData = this.getTokenData();
      if (!tokenData || !tokenData.expires_at) return false;
      
      const now = Date.now();
      const expiresAt = tokenData.expires_at;
      const timeUntilExpiry = expiresAt - now;

      return timeUntilExpiry > this.RENEWAL_BUFFER;
    },
    
    /**
     * Obt√©m dados do token guardado
     */
    getTokenData() {
      try {
        const saved = localStorage.getItem(this.TOKEN_KEY);
        if (!saved) return null;
        return JSON.parse(saved);
      } catch (e) {
        console.error('Erro ao ler token:', e);
        return null;
      }
    },
    
    /**
     * Guarda token com timestamp de expira√ß√£o
     */
    saveToken(accessToken, expiresIn = 3600) {
      const tokenData = {
        access_token: accessToken,
        expires_at: Date.now() + (expiresIn * 1000),
        saved_at: Date.now()
      };
      localStorage.setItem(this.TOKEN_KEY, JSON.stringify(tokenData));
      return tokenData;
    },
    
    /**
     * Remove token
     */
    clearToken() {
      localStorage.removeItem(this.TOKEN_KEY);
    },
    
    /**
     * Obt√©m tempo restante at√© expira√ß√£o (em minutos)
     */
    getTimeUntilExpiry() {
      const tokenData = this.getTokenData();
      if (!tokenData || !tokenData.expires_at) return 0;
      
      const timeLeft = tokenData.expires_at - Date.now();
      return Math.max(0, Math.floor(timeLeft / 60000)); // minutos
    }
  };

  const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '344967437318-oe9hr1t5m9bcs7qvdm0t5dr9f0delaom.apps.googleusercontent.com',
    API_KEY: window.GOOGLE_API_KEY || '', // Carregada do config.js
    SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/documents.readonly https://www.googleapis.com/auth/calendar.readonly',
    FILE_NAME: 'munchi-data.json',
    BACKUP_PREFIX: 'munchi-backup-', // üÜï Prefixo para backups versionados
    MAX_BACKUPS: 10 // üÜï Manter √∫ltimos 10 backups
  };

  const loadUserInfo = async (token) => {
    try {
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const userInfo = await response.json();
        setDriveUser({
          name: userInfo.name,
          email: userInfo.email,
          image: userInfo.picture
        });
      }
    } catch (error) {

    }
  };

  const loginGoogleDrive = () => {
    if (!window.google) {
      showNotification('‚ö†Ô∏è Google Identity Services ainda n√£o carregou', 'error');
      return;
    }
    const client = window.google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
      scope: GOOGLE_DRIVE_CONFIG.SCOPES,
      callback: (response) => {
        if (response.access_token) {

          GoogleDriveTokenManager.saveToken(response.access_token, response.expires_in || 3600);
          setDriveAccessToken(response.access_token);
          setDriveError(null);
          loadUserInfo(response.access_token);
          loadFromDrive(response.access_token);
          showNotification('‚úÖ Conectado ao Google Drive!', 'success');

          setActiveTab('dashboard');
          setDashboardSubTab('resumo');
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }, 100);
        } else {
          setDriveError('Erro ao obter token');
          showNotification('‚ùå Erro ao conectar', 'error');
        }
      }
    });
    client.requestAccessToken();
  };

  const logoutGoogleDrive = () => {
    if (driveAccessToken && window.google) {
      window.google.accounts.oauth2.revoke(driveAccessToken);
    }

    GoogleDriveTokenManager.clearToken();
    localStorage.removeItem('munchi_drive_file_id');
    setDriveAccessToken(null);
    setDriveUser(null);
    setDriveFileId(null);
    showNotification('Desconectado do Google Drive', 'info');
  };

  const findDriveFile = async (token) => {
    try {
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name='${GOOGLE_DRIVE_CONFIG.FILE_NAME}' and mimeType='application/json' and trashed=false&fields=files(id,name,modifiedTime)`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      if (response.ok) {
        const data = await response.json();
        return data.files && data.files.length > 0 ? data.files[0] : null;
      }
    } catch (error) {

    }
    return null;
  };

  const createDriveFile = async (token, data) => {
    const metadata = { name: GOOGLE_DRIVE_CONFIG.FILE_NAME, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
      { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form }
    );
    if (response.ok) {
      const result = await response.json();
      setDriveFileId(result.id);
      localStorage.setItem('munchi_drive_file_id', result.id);
      return result.id;
    }

    throw new Error(`Erro ao criar ficheiro (${response.status})`);
  };

  const updateDriveFile = async (token, fileId, data) => {
    const response = await fetch(
      `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
      {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(data, null, 2)
      }
    );
    if (!response.ok) {

      throw new Error(`Erro ao atualizar (${response.status})`);
    }
    return true;
  };

  const createVersionedBackup = async (token, data) => {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const fileName = `${GOOGLE_DRIVE_CONFIG.BACKUP_PREFIX}${timestamp}.json`;
    
    const metadata = { name: fileName, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
    
    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,modifiedTime',
      { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form }
    );
    
    if (!response.ok) {
      throw new Error(`Erro ao criar backup (${response.status})`);
    }
    
    return await response.json();
  };

  const listDriveBackups = async (token) => {
    try {
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name contains '${GOOGLE_DRIVE_CONFIG.BACKUP_PREFIX}' and mimeType='application/json' and trashed=false&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      
      if (response.ok) {
        const data = await response.json();
        return data.files || [];
      }
    } catch (error) {
      console.error('Erro ao listar backups:', error);
    }
    return [];
  };

  const loadSpecificBackup = async (token, fileId) => {
    try {
      setDriveSyncing(true);
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      
      if (response.ok) {
        const data = await response.json();

        const totalRecords = (data.produtos?.length || 0) + (data.ingredientes?.length || 0) + (data.vendas?.length || 0);
        
        if (totalRecords === 0) {
          showNotification('‚ö†Ô∏è Backup vazio! N√£o foi carregado.', 'warning');
          return false;
        }

        // üßπ Limpar ingredientes √≥rf√£os das receitas ANTES de definir o state
        if (data.produtos && data.ingredientes) {
          const { produtosLimpos, orfaosRemovidos } = limparIngredientesOrfaos(data.produtos, data.ingredientes);
          setProdutos(orfaosRemovidos > 0 ? produtosLimpos : data.produtos);
        } else if (data.produtos) {
          setProdutos(data.produtos);
        }
        if (data.ingredientes) setIngredientes(data.ingredientes);
        if (data.vendas) setVendas(data.vendas);
        // üßπ Limpar ingredientes √≥rf√£os das faturas
        if (data.faturas && data.ingredientes) {
          const { faturasLimpas, orfaosRemovidos: orfaosFaturas } = limparFaturasOrfas(data.faturas, data.ingredientes);
          setFaturas(orfaosFaturas > 0 ? faturasLimpas : data.faturas);
        } else if (data.faturas) {
          setFaturas(data.faturas);
        }
        if (data.fornecedores) setFornecedores(data.fornecedores);
        if (data.dadosEmpresa) setDadosEmpresa(data.dadosEmpresa);
        if (data.deliveryApps) setDeliveryApps(data.deliveryApps);
        if (data.blacklist) setBlacklist(data.blacklist);
        if (data.templatesOCR) setTemplatesOCR(data.templatesOCR);
        if (data.vocabularioFornecedor) setVocabularioFornecedor(data.vocabularioFornecedor);
        if (data.configuracaoWaste) setConfiguracaoWaste(data.configuracaoWaste);
        if (data.contagens) setContagens(data.contagens);
        if (data.movimentacoesStock) setMovimentacoesStock(data.movimentacoesStock);
        if (data.contagensHistorico) setContagensHistorico(data.contagensHistorico);
        if (data.ultimaFaturaInserida !== undefined) setUltimaFaturaInserida(data.ultimaFaturaInserida);
        
        showNotification('‚úÖ Backup restaurado com sucesso!', 'success');
        return true;
      }
    } catch (error) {
      console.error('Erro ao carregar backup:', error);
      showNotification('‚ùå Erro ao carregar backup', 'error');
    } finally {
      setDriveSyncing(false);
    }
    return false;
  };

  const cleanOldBackups = async (token) => {
    try {
      const backups = await listDriveBackups(token);
      
      if (backups.length <= GOOGLE_DRIVE_CONFIG.MAX_BACKUPS) {
        return; // Nada a limpar
      }

      const toDelete = backups.slice(GOOGLE_DRIVE_CONFIG.MAX_BACKUPS);
      
      for (const backup of toDelete) {
        await fetch(
          `https://www.googleapis.com/drive/v3/files/${backup.id}`,
          { 
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          }
        );
      }

    } catch (error) {
      console.error('Erro ao limpar backups antigos:', error);
    }
  };

  const saveToDrive = async (forceSync = false) => {
    if (!driveAccessToken) {
      showNotification('‚ö†Ô∏è N√£o conectado', 'error');
      return;
    }

    const timeLeft = GoogleDriveTokenManager.getTimeUntilExpiry();
    if (timeLeft === 0) {
      showNotification('üîí Token expirado. Clique no indicador do Drive para renovar.', 'error');
      return;
    }

    if (timeLeft > 0 && timeLeft <= 5) {
      showNotification(`‚ö†Ô∏è Token expira em ${timeLeft} min. Renove ap√≥s o sync!`, 'warning');
    }
    
    try {
      setDriveSyncing(true);
      setDriveError(null);

      const getCurrentData = () => ({
        produtos: produtos || [],
        ingredientes: ingredientes || [],
        vendas: vendas || [],
        faturas: faturas || [],
        fornecedores: fornecedores || [],
        dadosEmpresa: dadosEmpresa || {},
        deliveryApps: deliveryApps || [],
        blacklist: blacklist || [],
        templatesOCR: templatesOCR || [],
        vocabularioFornecedor: vocabularioFornecedor || [],
        configuracaoWaste: configuracaoWaste || {},
        contagens: contagens || [],
        movimentacoesStock: movimentacoesStock || [],
        contagensHistorico: contagensHistorico || [],
        ultimaFaturaInserida: ultimaFaturaInserida || null,
        lastUpdate: new Date().toISOString()
      });
      
      const data = getCurrentData();

      const dataString = JSON.stringify(data);
      const hasPendingChanges = pendingSyncRef.current > 0;
      
      if (!forceSync && !hasPendingChanges && lastSyncDataRef.current === dataString) {

        setDriveSyncing(false);
        return;
      }
      
      if (hasPendingChanges) {

      }

      const totalRecords = (data.produtos?.length || 0) + (data.ingredientes?.length || 0) + (data.vendas?.length || 0);
      
      if (totalRecords < 5 && !forceSync) {
        const confirmSave = confirm(
          `‚ö†Ô∏è AVISO DE SEGURAN√áA\n\n` +
          `Os dados parecem suspeitos:\n` +
          `‚Ä¢ Produtos: ${data.produtos?.length || 0}\n` +
          `‚Ä¢ Ingredientes: ${data.ingredientes?.length || 0}\n` +
          `‚Ä¢ Vendas: ${data.vendas?.length || 0}\n\n` +
          `Isto pode indicar que os dados n√£o carregaram corretamente.\n\n` +
          `Confirma que quer SOBRESCREVER o backup no Drive?`
        );
        
        if (!confirmSave) {
          showNotification('‚ùå Sincroniza√ß√£o cancelada por seguran√ßa', 'warning');
          setDriveSyncing(false);
          return;
        }
      }

      const shouldCreateBackup = forceSync || (Math.random() < 0.1); // 10% de chance
      
      if (shouldCreateBackup) {

        await createVersionedBackup(driveAccessToken, data);

        await cleanOldBackups(driveAccessToken);
      } else {

      }

      let fileId = driveFileId;
      if (!fileId) {
        const existingFile = await findDriveFile(driveAccessToken);
        if (existingFile) {
          fileId = existingFile.id;
          setDriveFileId(fileId);
          localStorage.setItem('munchi_drive_file_id', fileId);
        }
      }
      
      if (fileId) {
        await updateDriveFile(driveAccessToken, fileId, data);
      } else {
        await createDriveFile(driveAccessToken, data);
      }

      lastSyncDataRef.current = dataString;
      
      setDriveLastSync(new Date());
      if (shouldCreateBackup) {
        showNotification('‚úÖ Sincronizado com backup!', 'success');
      } else {
        showNotification('‚úÖ Sincronizado (r√°pido)', 'success');
      }

      if (pendingSyncRef.current > 0) {
        const numPendentes = pendingSyncRef.current;

        pendingSyncRef.current = 0; // Reset contador

        setTimeout(() => {

          saveToDrive(false);
        }, 500);
      }
      
    } catch (error) {
      console.error('Erro ao sincronizar:', error);

      const errorMessage = error.message || String(error);
      if (errorMessage.includes('401') || errorMessage.includes('403') || errorMessage.includes('Unauthorized')) {
        showNotification('üîí Token inv√°lido. A solicitar nova autentica√ß√£o...', 'error');
        logoutGoogleDrive();
        return;
      }
      
      setDriveError('Erro ao sincronizar');
      showNotification('‚ùå Erro ao sincronizar', 'error');
    } finally {
      setDriveSyncing(false);
    }
  };

  const scheduleSync = () => {

    if (syncTimeoutRef.current) {
      clearTimeout(syncTimeoutRef.current);
    }

    if (driveSyncing) {
      pendingSyncRef.current++;

      return;
    }

    syncTimeoutRef.current = setTimeout(() => {

      saveToDrive(false);
    }, 2000);
  };

  /**
   * Converte PDF para Google Doc usando OCR do Google
   * Retorna texto extra√≠do com alta qualidade
   */
  const convertPDFToGoogleDocOCR = async (pdfFile, token = driveAccessToken) => {
    if (!token) {
      throw new Error('Token Google Drive n√£o dispon√≠vel');
    }

    try {

      const metadata = {
        name: `ocr_temp_${Date.now()}.pdf`,
        mimeType: 'application/pdf'
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', pdfFile);

      const uploadResponse = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
        {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: form
        }
      );

      if (!uploadResponse.ok) {
        throw new Error('Falha ao fazer upload do PDF');
      }

      const uploadResult = await uploadResponse.json();
      const pdfFileId = uploadResult.id;

      const copyResponse = await fetch(
        `https://www.googleapis.com/drive/v3/files/${pdfFileId}/copy`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: `ocr_doc_${Date.now()}`,
            mimeType: 'application/vnd.google-apps.document'
          })
        }
      );

      if (!copyResponse.ok) {
        const errorText = await copyResponse.text();

        throw new Error('Falha ao converter PDF para Google Doc');
      }

      const docResult = await copyResponse.json();
      const docFileId = docResult.id;

      const exportResponse = await fetch(
        `https://www.googleapis.com/drive/v3/files/${docFileId}/export?mimeType=text/plain`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (!exportResponse.ok) {
        throw new Error('Falha ao exportar texto');
      }

      const textContent = await exportResponse.text();

      await fetch(
        `https://www.googleapis.com/drive/v3/files/${pdfFileId}`,
        {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );
      await fetch(
        `https://www.googleapis.com/drive/v3/files/${docFileId}`,
        {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      return textContent;
    } catch (error) {

      throw error;
    }
  };

  /**
   * Deteta se o texto OCR cont√©m o NIF configurado
   * Procura por padr√µes como:
   * - "Contribuinte: 123456789"
   * - "NIF: 123456789"
   * - "NIPC: 123456789"
   * - "Contribuinte N.¬∫ 123456789"
   */
  const detetarNifCliente = (textoOCR, nifProcurado) => {
    if (!textoOCR || !nifProcurado) return false;

    const nifLimpo = nifProcurado.replace(/\D/g, '');
    
    if (nifLimpo.length !== 9) return false;

    const padroes = [

      new RegExp(`Contribuinte[:\\s]+${nifLimpo}`, 'i'),

      new RegExp(`NIF[:\\s]+${nifLimpo}`, 'i'),

      new RegExp(`NIPC[:\\s]+${nifLimpo}`, 'i'),

      new RegExp(`Contribuinte\\s+N[.¬∫¬∞]+\\s*${nifLimpo}`, 'i'),

      new RegExp(`NIF\\s+N[.¬∫¬∞]+\\s*${nifLimpo}`, 'i'),

      new RegExp(nifLimpo.replace(/(\d{3})(\d{3})(\d{3})/, '$1\\s*$2\\s*$3')),

      new RegExp(
        nifLimpo
          .split('')
          .map(d => {

            const confusoes = {
              '0': '[0OoQD]',
              '1': '[1IlL]',
              '2': '[2Z]',
              '3': '[3]',
              '4': '[4]',
              '5': '[5S]',
              '6': '[6G]',
              '7': '[7]',
              '8': '[8B]',
              '9': '[9gq]'
            };
            return confusoes[d] || d;
          })
          .join('\\s*'),
        'i'
      )
    ];

    for (const padrao of padroes) {
      if (padrao.test(textoOCR)) {

        return true;
      }
    }

    return false;
  };

  /**
   * Handler para importar fatura do Google Drive com OCR
   * Usa Google Picker para escolher ficheiro do Drive
   */
  const handleImportarDriveComOCR = async () => {
    if (!driveAccessToken) {
      showNotification('‚ö†Ô∏è Fa√ßa login no Google Drive primeiro', 'error');
      return;
    }

    if (!window.gapi) {
      showNotification('‚ö†Ô∏è Google API ainda n√£o carregou. Aguarde...', 'error');
      return;
    }

    try {

      await new Promise((resolve) => {
        window.gapi.load('picker', resolve);
      });

      const picker = new window.google.picker.PickerBuilder()
        .addView(
          new window.google.picker.DocsView(window.google.picker.ViewId.DOCS)
            .setMimeTypes('application/pdf')
            .setIncludeFolders(true) // ‚úÖ Permite ver pastas
        )
        .setOAuthToken(driveAccessToken)
        .setDeveloperKey(GOOGLE_DRIVE_CONFIG.API_KEY)
        .setCallback(async (data) => {
          if (data.action === window.google.picker.Action.PICKED) {
            const file = data.docs[0];
            const fileId = file.id;
            const fileName = file.name;

            try {
              setProcessandoOCR(true);
              setProgressoOCR('Baixando PDF do Drive...');

              const downloadResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                {
                  headers: { 'Authorization': `Bearer ${driveAccessToken}` }
                }
              );

              if (!downloadResponse.ok) {
                throw new Error('Falha ao baixar PDF do Drive');
              }

              const pdfBlob = await downloadResponse.blob();
              const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

              setProgressoOCR('Convertendo com Google OCR...');

              const textoExtraido = await convertPDFToGoogleDocOCR(pdfFile, driveAccessToken);
              
              if (!textoExtraido || textoExtraido.length < 50) {
                throw new Error('Texto extra√≠do est√° vazio ou muito curto');
              }

              setProgressoOCR('Processando fatura...');

              const dadosFatura = processarTextoFatura(textoExtraido, fornecedores); // ‚úÖ PASSAR FORNECEDORES

              const template = buscarTemplateOCR(dadosFatura.fornecedor.nif);
              const linhas = template 
                ? parseComTemplate(textoExtraido, template) 
                : parseLinhasProdutos(textoExtraido, dadosFatura.fornecedor.nif); // üö´ CORRIGIDO: Passar NIF para usar blacklist

              if (linhas.length > 0) {

              }

              const reader = new FileReader();
              const base64Promise = new Promise((resolve) => {
                reader.onloadend = () => {
                  const base64 = reader.result.split(',')[1];
                  resolve(base64);
                };
                reader.readAsDataURL(pdfBlob);
              });
              
              const pdfBase64 = await base64Promise;

              const metadata = {
                numeroFatura: dadosFatura.numero,
                data: dadosFatura.data,
                nif: dadosFatura.fornecedor.nif,
                fornecedor: dadosFatura.fornecedor.nome,
                total: dadosFatura.totais.total,
                pdfBase64: pdfBase64,
                pdfNome: fileName,
                textoCompleto: textoExtraido,
                precosComIVA: dadosFatura.precosComIVA,
                metodoOCR: 'Google Drive OCR'
              };

              const nifEmpresa = configuracoes.metricas.nifEmpresa;
              if (nifEmpresa) {
                const temNifCliente = detetarNifCliente(textoExtraido, nifEmpresa);
                metadata.temNifCliente = temNifCliente;
                metadata.nifClienteDetetado = temNifCliente ? nifEmpresa : null;

              } else {
                metadata.temNifCliente = false;
                metadata.nifClienteDetetado = null;
              }

              const pdfUrl = URL.createObjectURL(pdfBlob);

              setModalConfirmacaoFatura({
                mostrar: true,
                dados: {
                  ...dadosFatura,
                  pdfUrl: pdfUrl,
                  metodoOCR: 'Google Drive OCR'
                }
              });

              const linhasComMatch = linhas.length > 0 
                ? matchIngredientes(linhas, ingredientes)
                : [];

              setLinhasOCR(linhasComMatch);
              setMetadataOCR(metadata);

              if (linhas.length === 0) {
                showNotification('‚úÖ Fatura processada! Nenhum produto detectado.', 'warning');
              } else {
                showNotification(`‚úÖ OCR conclu√≠do! ${linhas.length} produtos identificados.`, 'success');
              }
            } catch (error) {

              showNotification(`‚ùå Erro: ${error.message}. Tente com OCR local.`, 'error');
            } finally {
              setProcessandoOCR(false);
              setProgressoOCR('');
            }
          }
        })
        .build();

      picker.setVisible(true);
    } catch (error) {

      showNotification('‚ùå Erro ao abrir seletor do Drive', 'error');
    }
  };

  const loadFromDrive = async (token = driveAccessToken) => {
    if (!token) return;
    try {
      setDriveSyncing(true);
      const file = await findDriveFile(token);
      if (!file) {
        setDriveSyncing(false);
        return;
      }
      setDriveFileId(file.id);
      localStorage.setItem('munchi_drive_file_id', file.id);
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      if (response.ok) {
        const data = await response.json();
        // üßπ Limpar ingredientes √≥rf√£os das receitas ANTES de definir o state
        if (data.produtos && data.ingredientes) {
          const { produtosLimpos, orfaosRemovidos } = limparIngredientesOrfaos(data.produtos, data.ingredientes);
          setProdutos(orfaosRemovidos > 0 ? produtosLimpos : data.produtos);
        } else if (data.produtos) {
          setProdutos(data.produtos);
        }
        if (data.ingredientes) setIngredientes(data.ingredientes);
        if (data.vendas) setVendas(data.vendas);
        // üßπ Limpar ingredientes √≥rf√£os das faturas
        if (data.faturas && data.ingredientes) {
          const { faturasLimpas, orfaosRemovidos: orfaosFaturas } = limparFaturasOrfas(data.faturas, data.ingredientes);
          setFaturas(orfaosFaturas > 0 ? faturasLimpas : data.faturas);
        } else if (data.faturas) {
          setFaturas(data.faturas);
        }
        if (data.fornecedores) setFornecedores(data.fornecedores);
        if (data.dadosEmpresa) setDadosEmpresa(data.dadosEmpresa);
        if (data.deliveryApps) setDeliveryApps(data.deliveryApps);

        if (data.blacklist && data.blacklist.length > 0) {
          setBlacklist(data.blacklist);
        } else {
          const localBlacklist = localStorage.getItem('munchi_blacklist');
          if (localBlacklist) {

          }
        }

        if (data.templatesOCR && data.templatesOCR.length > 0) {

          const templateMap = new Map();

          templatesOCR.forEach(t => {
            if (t && t.nifFornecedor) {
              templateMap.set(t.nifFornecedor, {
                ...t,
                blacklist: t.blacklist || [],
                palavrasLimpar: t.palavrasLimpar || []
              });
            }
          });

          data.templatesOCR.forEach(t => {
            if (t && t.nifFornecedor) {
              const existing = templateMap.get(t.nifFornecedor);
              
              if (existing) {

                const blacklistSet = new Set([
                  ...(existing.blacklist || []),
                  ...(t.blacklist || [])
                ]);
                const palavrasLimparSet = new Set([
                  ...(existing.palavrasLimpar || []),
                  ...(t.palavrasLimpar || [])
                ]);

                const merged = {
                  ...existing, // Dados locais (prioridade)
                  blacklist: Array.from(blacklistSet), // ‚úÖ COMBINADAS!
                  palavrasLimpar: Array.from(palavrasLimparSet), // ‚úÖ COMBINADAS!
                  vezeUsado: Math.max(existing.vezeUsado || 0, t.vezeUsado || 0)
                };
                
                templateMap.set(t.nifFornecedor, merged);
              } else {

                templateMap.set(t.nifFornecedor, {
                  ...t,
                  blacklist: t.blacklist || [],
                  palavrasLimpar: t.palavrasLimpar || []
                });
              }
            }
          });

          const merged = Array.from(templateMap.values());

          setTemplatesOCR(merged);

          await IndexedDBStorage.saveTemplates(merged);
        }

        if (data.vocabularioFornecedor && data.vocabularioFornecedor.length > 0) {

          const vocabMap = new Map();

          vocabularioFornecedor.forEach(v => {
            if (v && v.id) vocabMap.set(v.id, v);
          });

          data.vocabularioFornecedor.forEach(v => {
            if (v && v.id && !vocabMap.has(v.id)) {
              vocabMap.set(v.id, v);
            }
          });

          const merged = Array.from(vocabMap.values())
            .sort((a, b) => {
              const dateA = new Date(a.ultimaConfirmacao || 0);
              const dateB = new Date(b.ultimaConfirmacao || 0);
              return dateB - dateA; // Mais recentes primeiro
            });

          setVocabularioFornecedor(merged);

          await IndexedDBStorage.saveVocabulario(merged);
        }

        if (data.ingredientes && data.ingredientes.length > 0) {
          await IndexedDBStorage.saveIngredientes(data.ingredientes);
        }
        if (data.fornecedores && data.fornecedores.length > 0) {
          await IndexedDBStorage.saveFornecedores(data.fornecedores);
        }

        if (data.configuracaoWaste) {
          setConfiguracaoWaste(data.configuracaoWaste);

        }
        if (data.contagens) {
          setContagens(data.contagens);

        }

        if (data.movimentacoesStock) {
          setMovimentacoesStock(data.movimentacoesStock);

        }

        if (data.ultimaFaturaInserida !== undefined) {
          setUltimaFaturaInserida(data.ultimaFaturaInserida);

        }
        
        setDriveLastSync(new Date(file.modifiedTime));
        showNotification('‚úÖ Dados carregados!', 'success');
      }
    } catch (error) {

      setDriveError('Erro ao carregar');
    } finally {
      setDriveSyncing(false);
    }
  };

  useEffect(() => {
    const carregar = async () => {

      try {

        
        const [vocab, ings, forns, temps] = await Promise.all([
          IndexedDBStorage.loadVocabulario(),
          IndexedDBStorage.loadIngredientes(),
          IndexedDBStorage.loadFornecedores(),
          IndexedDBStorage.loadTemplates()
        ]);

        if (vocab.length > 0) setVocabularioFornecedor(vocab);
        if (ings.length > 0) setIngredientes(ings);
        if (forns.length > 0) setFornecedores(forns);
        if (temps.length > 0) setTemplatesOCR(temps);

        
        const precisaMigrar = vocab.length === 0 || ings.length === 0 || forns.length === 0;
        
        if (precisaMigrar) {

          const [vocLS, ingsLS, fornsLS, tempsLS] = await Promise.all([
            window.storage.get('vocabularioFornecedor').catch(() => null),
            window.storage.get('ingredientes').catch(() => null),
            window.storage.get('fornecedores').catch(() => null),
            window.storage.get('templatesOCR').catch(() => null)
          ]);

          if (vocLS && vocab.length === 0) {
            const data = JSON.parse(vocLS.value);
            await IndexedDBStorage.saveVocabulario(data);
            setVocabularioFornecedor(data);
          }
          
          if (ingsLS && ings.length === 0) {
            const data = JSON.parse(ingsLS.value);
            await IndexedDBStorage.saveIngredientes(data);
            setIngredientes(data);
          }
          
          if (fornsLS && forns.length === 0) {
            const data = JSON.parse(fornsLS.value);
            await IndexedDBStorage.saveFornecedores(data);
            setFornecedores(data);
          }
          
          if (tempsLS && temps.length === 0) {
            const data = JSON.parse(tempsLS.value);
            await IndexedDBStorage.saveTemplates(data);
            setTemplatesOCR(data);
          }

        }

        
        const keysParaLimpar = [
          'produtos',              // Carrega do Drive
          'vendas',                // Carrega do Drive
          'faturas',               // Carrega do Drive
          'despesas',              // Carrega do Drive
          'movimentacoesStock',    // 3.6 MB! Vai pro IndexedDB separado
          'ingredientes',          // Agora no IndexedDB
          'fornecedores',          // Agora no IndexedDB
          'vocabularioFornecedor', // Agora no IndexedDB
          'templatesOCR'           // Agora no IndexedDB
        ];
        
        let espacoLiberado = 0;
        keysParaLimpar.forEach(key => {
          const item = localStorage.getItem(key);
          if (item) {
            espacoLiberado += item.length;
            localStorage.removeItem(key);
          }
        });
        
        if (espacoLiberado > 0) {

        }

        
        try {
          let totalSize = 0;
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              totalSize += localStorage[key].length + key.length;
            }
          }
          const sizeInKB = (totalSize / 1024).toFixed(1);

        } catch (e) {

        }

      } catch (e) {
        console.error('‚ùå Erro ao carregar dados:', e);
      }
    };
    carregar();
  }, []);

  useEffect(() => {
    window._adicionarABlacklist = adicionarABlacklist;
    window._adicionarAPalavrasLimpar = adicionarAPalavrasLimpar;
    return () => {
      delete window._adicionarABlacklist;
      delete window._adicionarAPalavrasLimpar;
    };
  }, [templatesOCR]);

  useEffect(() => {

    if (driveAccessToken && vocabularioFornecedor !== undefined) {

      const shouldLoad = sessionStorage.getItem('drive_initial_load');
      if (!shouldLoad) {
        sessionStorage.setItem('drive_initial_load', 'done');

        loadFromDrive(driveAccessToken);
      }
    }
  }, [driveAccessToken, vocabularioFornecedor]);

  useEffect(() => {
    setShowIngredienteSuggestions(false);
  }, [activeTab, gestaoSubTab]);

  useEffect(() => {

  }, [produtos, ingredientes, vendas, despesas, fornecedores, dadosEmpresa, faturas, vocabularioFornecedor, templatesOCR]);

  const detectarCategoria = (nome) => {
    const n = nome.toLowerCase();
    const categorias = {
      'vegetais': ['alface', 'tomate', 'cebola', 'cenoura', 'batata', 'cogumelo', 'pimento', 'alho', 'couve', 'br√≥colos', 'espinafre'],
      'frutas': ['morango', 'banana', 'ma√ß√£', 'laranja', 'lim√£o', 'p√™ra', 'uva', 'mel√£o', 'melancia', 'kiwi', 'manga', 'abacaxi', 'framboesa', 'mirtilo', 'cereja', 'ameixa', 'p√™ssego', 'nectarina', 'damasco', 'figo', 't√¢mara', 'coco', 'abacate', 'fruta'],
      'carnes': ['frango', 'carne', 'porco', 'vaca', 'peru', 'bacon', 'salsicha', 'bife', 'costela'],
      'peixe': ['salm√£o', 'atum', 'bacalhau', 'camar√£o', 'polvo', 'lula', 'peixe', 'marisco'],
      'latic√≠nios': ['leite', 'queijo', 'iogurte', 'manteiga', 'nata', 'mozzarella', 'requeij√£o', 'mozarela'],
      'padaria': ['p√£o'],
      'pastelaria': ['farinha', 'fermento', 'chocolate', 'cacau', 'baunilha', 'am√™ndoa', 'noz'],
      'compotas': ['a√ß√∫car', 'pectina', '√°cido c√≠trico'],
      'bebidas': ['√°gua', 'sumo', 'refrigerante', 'vinho', 'cerveja', 'caf√©', 'ch√°'],
      'temperos': ['sal', 'pimenta', 'azeite', 'vinagre', 'oreg√£os', 'especiaria', 'canela', 'colorau']
    };
    
    for (const [cat, keywords] of Object.entries(categorias)) {
      if (keywords.some(k => n.includes(k))) return cat;
    }
    return 'outros';
  };

  const adicionarIngrediente = () => {
    if (!novoIngrediente.nome || !novoIngrediente.custoUnitario) {
      showNotification('Preencha nome e custo!', 'error');
      return;
    }
    const custoComIva = parseFloat(novoIngrediente.custoUnitario);
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    
    setIngredientes(prev => [...prev, { 
      id: Date.now(), 
      ...novoIngrediente, 
      custoUnitario: custoComIva,
      custoSemIva: custoSemIva,
      iva: iva,
      categoria: novoIngrediente.categoria || 'outros'
    }]);
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    showNotification('Ingrediente adicionado!', 'success');
  };

  const criarIngredienteInline = () => {
    if (!novoIngrediente.nome) {
      showNotification('Preencha o nome do ingrediente!', 'error');
      return;
    }

    let custoComIva;
    if (novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem) {
      const precoTotal = parseFloat(novoIngrediente.precoTotal);
      const qtdEmbalagem = parseFloat(novoIngrediente.quantidadeEmbalagem);
      custoComIva = precoTotal / qtdEmbalagem; // Ex: ‚Ç¨21.29 / 12 unidades = ‚Ç¨1.77/un
    } else if (novoIngrediente.custoUnitario) {
      custoComIva = parseFloat(novoIngrediente.custoUnitario);
    } else {
      showNotification('Preencha o pre√ßo total e quantidade na embalagem, ou o custo unit√°rio!', 'error');
      return;
    }
    
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    const quantidade = parseFloat(novoIngrediente.quantidade || 1);

    let quantidadeEmUnidadeBase = quantidade;
    if (novoIngrediente.unidade === 'g') {
      quantidadeEmUnidadeBase = quantidade / 1000; // 500g ‚Üí 0.5kg
    } else if (novoIngrediente.unidade === 'ml') {
      quantidadeEmUnidadeBase = quantidade / 1000; // 500ml ‚Üí 0.5L
    }

    
    const precoTotal = custoComIva * quantidadeEmUnidadeBase;
    
    const novoIng = { 
      id: Date.now(), 
      nome: novoIngrediente.nome,
      unidade: novoIngrediente.unidade,
      custoUnitario: custoComIva, // sempre em kg/L
      custoSemIva: custoSemIva,
      iva: iva,
      categoria: novoIngrediente.categoria || 'outros'
    };

    setIngredientes(prev => [...prev, novoIng]);

    setItemFatura({
      ...itemFatura,
      ingredienteId: novoIng.id,
      quantidade: quantidade.toString(), // quantidade original (500g)
      unidade: novoIng.unidade, // unidade original (g)
      precoTotal: precoTotal.toFixed(2), // pre√ßo convertido
      iva: novoIng.iva.toString()
    });

    setCriandoIngrediente(false);
    setSearchIngredienteFatura(novoIng.nome);
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
    
    showNotification(`‚ú® Ingrediente "${novoIng.nome}" criado e adicionado √† fatura!`, 'success');
  };
  
  const adicionarEmbalagem = () => {
    if (!novaEmbalagem.nome || !novaEmbalagem.custoUnitario) {
      showNotification('Preencha nome e custo da embalagem!', 'error');
      return;
    }
    setEmbalagens([...embalagens, {
      id: Date.now(),
      ...novaEmbalagem,
      custoUnitario: parseFloat(novaEmbalagem.custoUnitario)
    }]);
    setNovaEmbalagem({ nome: '', custoUnitario: '', categoria: 'copos' });
    showNotification('Embalagem adicionada!', 'success');
  };
  
  const toggleApp = (appId) => {
    setDeliveryApps(deliveryApps.map(app => 
      app.id === appId ? { ...app, ativo: !app.ativo } : app
    ));
    const app = deliveryApps.find(a => a.id === appId);
    showNotification(`${app.nome} ${app.ativo ? 'desativada' : 'ativada'}!`, 'success');
  };
  
  const atualizarComissaoApp = (appId, novaComissao) => {
    setDeliveryApps(deliveryApps.map(app => 
      app.id === appId ? { 
        ...app, 
        comissao: parseFloat(novaComissao),
        dataAtualizacao: new Date().toISOString().split('T')[0]
      } : app
    ));
    setEditandoApp(null);
    showNotification('Comiss√£o atualizada!', 'success');
  };
  
  const adicionarNovaApp = () => {
    if (!novaApp.nome || !novaApp.comissao) {
      showNotification('Preencha nome e comiss√£o!', 'error');
      return;
    }
    setDeliveryApps([...deliveryApps, {
      id: Date.now().toString(),
      nome: novaApp.nome,
      comissao: parseFloat(novaApp.comissao),
      ativo: false,
      cor: '#' + Math.floor(Math.random()*16777215).toString(16),
      dataAtualizacao: new Date().toISOString().split('T')[0]
    }]);
    setNovaApp({ nome: '', comissao: '25' });
    showNotification('App adicionada!', 'success');
  };
  
  const apagarApp = (appId) => {
    if (confirm('Apagar esta app?')) {
      setDeliveryApps(deliveryApps.filter(app => app.id !== appId));
      showNotification('App apagada!', 'success');
    }
  };
  
  const editarIngrediente = (ingrediente) => {

    setNovoIngrediente({
      nome: ingrediente.nome || '',
      unidade: ingrediente.unidade || 'kg',
      custoUnitario: (ingrediente.custoUnitario || ingrediente.preco || 0).toString(),
      iva: (ingrediente.iva || 23).toString(),
      categoria: ingrediente.categoria || 'outros'
    });
    setEditandoIngrediente(true);
    setIngredienteEditandoId(ingrediente.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarIngrediente = () => {

    if (!novoIngrediente.nome || !novoIngrediente.custoUnitario) {

      showNotification('Preencha nome e custo!', 'error');
      return;
    }
    
    const ingredienteAntigo = ingredientes.find(i => i.id === ingredienteEditandoId);
    
    if (!ingredienteAntigo) {

      showNotification('Erro: ingrediente n√£o encontrado!', 'error');
      return;
    }
    
    const custoNovo = parseFloat(novoIngrediente.custoUnitario);
    const custoAntigo = ingredienteAntigo.custoUnitario || ingredienteAntigo.precoUnitario || 0;
    const diferenca = Math.abs(custoNovo - custoAntigo);
    const diferencaPerc = custoAntigo > 0 ? (diferenca / custoAntigo) * 100 : 100;

    if (diferencaPerc > 5) {

      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId === ingredienteEditandoId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId === ingredienteEditandoId);
        const custoAntes = receitaItem.quantidade * custoAntigo;
        const custoDepois = receitaItem.quantidade * custoNovo;
        const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          return s + (r.quantidade * (ing?.custoUnitario || 0));
        }, 0);
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes
        };
      });
      
      setPriceAlertData({
        ingrediente: ingredienteAntigo,
        precoAtual: custoAntigo,
        precoNovo: custoNovo,
        diferencaPerc,
        produtosAfetados,
        ingredienteData: novoIngrediente,
        tipoFatura: 'ingrediente' // Marca como edi√ß√£o de ingrediente
      });
      setShowPriceAlert(true);
      return; // N√£o atualiza ainda
    }

    atualizarIngredienteSemAlerta();
  };
  
  const atualizarIngredienteSemAlerta = () => {

    const custoComIva = parseFloat(novoIngrediente.custoUnitario);
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);

    const ingredientesAtualizados = (ingredientes || []).map(i => {
      if (i.id === ingredienteEditandoId) {

        return {
          ...i,
          nome: novoIngrediente.nome,
          unidade: novoIngrediente.unidade,
          custoUnitario: custoComIva,
          precoUnitario: custoComIva, // ‚úÖ MANTER COMPATIBILIDADE
          custoSemIva: custoSemIva,
          iva: iva,
          categoria: novoIngrediente.categoria || 'outros'
        };
      }
      return i;
    });

    setIngredientes(ingredientesAtualizados);
    
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    setEditandoIngrediente(false);
    setIngredienteEditandoId(null);
    showNotification('Ingrediente atualizado!', 'success');
  };
  
  const cancelarEdicaoIngrediente = () => {
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    setEditandoIngrediente(false);
    setIngredienteEditandoId(null);
  };

  const abrirContagem = (ingrediente) => {
    setIngredienteContagem(ingrediente);
    setValorContagem(ingrediente.stockAtual || 0);
    setModalContagem(true);
  };
  
  const salvarContagem = () => {
    if (!ingredienteContagem) return;
    
    const novoStock = parseFloat(valorContagem) || 0;
    const ingrediente = ingredientes.find(ing => ing.id === ingredienteContagem.id);
    if (!ingrediente) return;

    const movimentacoesIngrediente = movimentacoesStock.filter(m => m.ingredienteId === ingrediente.id);
    let stockTeorico = 0;
    
    movimentacoesIngrediente.forEach(mov => {
      if (mov.tipo === 'entrada') {
        stockTeorico += mov.quantidade;
      } else if (mov.tipo === 'saida') {
        stockTeorico -= mov.quantidade;
      } else if (mov.tipo === 'ajuste') {
        stockTeorico += mov.quantidade; // ajuste pode ser + ou -
      }
    });

    if (movimentacoesIngrediente.length === 0) {
      stockTeorico = ingrediente.stockAtual || 0;
    }

    const ajuste = novoStock - stockTeorico;
    const desperdicio = Math.max(0, stockTeorico - novoStock);
    const percentagem = stockTeorico > 0 ? (desperdicio / stockTeorico) * 100 : 0;

    if (Math.abs(ajuste) > 0.001) { // Toler√¢ncia para erros de arredondamento
      const tipoAjuste = ajuste < 0 ? 'desperd√≠cio' : 'excesso';
      const movimentacaoAjuste = {
        id: Date.now() + Math.random(),
        data: new Date().toISOString().split('T')[0],
        tipo: 'ajuste',
        subTipo: tipoAjuste,
        ingredienteId: ingrediente.id,
        ingredienteNome: ingrediente.nome,
        quantidade: ajuste,
        unidade: ingrediente.unidade,
        stockAnterior: stockTeorico,
        stockNovo: novoStock,
        observacao: ajuste < 0 
          ? `Ajuste invent√°rio: ${Math.abs(ajuste).toFixed(2)} ${ingrediente.unidade} de desperd√≠cio (${percentagem.toFixed(1)}%)`
          : `Ajuste invent√°rio: +${ajuste.toFixed(2)} ${ingrediente.unidade} excesso detectado`
      };
      
      setMovimentacoesStock(prev => [...prev, movimentacaoAjuste]);
    }

    setIngredientes(ingredientes.map(ing => {
      if (ing.id !== ingredienteContagem.id) return ing;

      const novaContagem = {
        id: Date.now(),
        data: new Date().toISOString(),
        stockTeorico: stockTeorico,
        stockReal: novoStock,
        desperdicio: desperdicio,
        percentagem: percentagem,
        ajuste: ajuste,
        observacoes: ''
      };

      setContagens(prev => [...prev, {
        ...novaContagem,
        ingredienteId: ing.id,
        ingredienteNome: ing.nome,
        unidade: ing.unidade
      }]);
      
      return {
        ...ing,
        stockAtual: novoStock,
        ultimaContagem: new Date().toISOString(),
        historicoContagens: [...(ing.historicoContagens || []), novaContagem]
      };
    }));

    if (Math.abs(ajuste) > 0.001) {
      if (ajuste < 0) {
        showNotification(
          `Stock atualizado: ${novoStock} ${ingrediente.unidade} | Desperd√≠cio: ${Math.abs(ajuste).toFixed(2)} ${ingrediente.unidade} (${percentagem.toFixed(1)}%)`,
          'warning'
        );
      } else {
        showNotification(
          `Stock atualizado: ${novoStock} ${ingrediente.unidade} | Excesso: +${ajuste.toFixed(2)} ${ingrediente.unidade}`,
          'success'
        );
      }
    } else {
      showNotification(`Stock confirmado: ${novoStock} ${ingrediente.unidade} ‚úì`, 'success');
    }
    
    setModalContagem(false);
    setIngredienteContagem(null);
    setValorContagem(0);
  };

  const adicionarProduto = () => {
    if (!novoProduto.nome || !novoProduto.precoVenda) {
      showNotification('Preencha nome e pre√ßo!', 'error');
      return;
    }
    setProdutos([...produtos, { id: Date.now(), ...novoProduto, precoVenda: parseFloat(novoProduto.precoVenda), iva: parseFloat(novoProduto.iva) }]);
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    showNotification('Produto adicionado!', 'success');
  };
  
  const editarProduto = (produto) => {
    setNovoProduto({
      nome: produto.nome,
      precoVenda: produto.precoVenda.toString(),
      iva: produto.iva.toString(),
      categoria: produto.categoria || 'cafes',
      receita: produto.receita || [],
      embalagens: produto.embalagens || [],
      porcoes: produto.porcoes || 1
    });
    setEditandoProduto(true);
    setProdutoEditandoId(produto.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarProduto = () => {
    if (!novoProduto.nome || !novoProduto.precoVenda) {
      showNotification('Preencha nome e pre√ßo!', 'error');
      return;
    }

    const produtoAntigo = produtos.find(p => p.id === produtoEditandoId);
    if (produtoAntigo && produtoAntigo.nome !== novoProduto.nome) {

      setVendas(vendas.map(v => 
        v.produtoId === produtoEditandoId ? {
          ...v,
          produto: novoProduto.nome  // ‚Üê Atualiza o nome nas vendas
        } : v
      ));
    }
    
    setProdutos(produtos.map(p => 
      p.id === produtoEditandoId ? {
        ...p,
        nome: novoProduto.nome,
        precoVenda: parseFloat(novoProduto.precoVenda),
        iva: parseFloat(novoProduto.iva),
        categoria: novoProduto.categoria || 'cafes',
        receita: novoProduto.receita,
        embalagens: novoProduto.embalagens || [],
        porcoes: novoProduto.porcoes || 1
      } : p
    ));
    
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    setEditandoProduto(false);
    setProdutoEditandoId(null);
    showNotification('Produto atualizado!', 'success');
  };
  
  const cancelarEdicaoProduto = () => {
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', receita: [] });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    setEditandoProduto(false);
    setProdutoEditandoId(null);
  };

  const handlePDFUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    if (file.type !== 'application/pdf') {
      showNotification('‚ö†Ô∏è Por favor, selecione apenas ficheiros PDF!', 'error');
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      showNotification('‚ö†Ô∏è O ficheiro √© demasiado grande! M√°ximo 5MB.', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      setNovaFatura({
        ...novaFatura,
        documentoPDF: e.target.result,
        nomeDocumento: file.name
      });
      showNotification(`‚úÖ PDF "${file.name}" carregado com sucesso!`, 'success');
    };
    reader.onerror = () => {
      showNotification('‚ùå Erro ao ler o ficheiro PDF!', 'error');
    };
    reader.readAsDataURL(file);
  };

  const adicionarDespesa = () => {
    if (!novaDespesa.descricao || !novaDespesa.valor) {
      showNotification('Preencha descri√ß√£o e valor!', 'error');
      return;
    }

    if (novaDespesa.ingredienteId && novaDespesa.quantidade) {
      const ingrediente = ingredientes.find(i => i.id === novaDespesa.ingredienteId);
      const precoNovo = parseFloat(novaDespesa.valor) / parseFloat(novaDespesa.quantidade);
      const precoAtual = ingrediente.custoUnitario;
      const diferenca = Math.abs(precoNovo - precoAtual);
      const diferencaPerc = (diferenca / precoAtual) * 100;

      if (diferencaPerc > 5) {

        const produtosAfetados = produtos.filter(p => 
          p.receita && p.receita.some(r => r.ingredienteId === novaDespesa.ingredienteId)
        ).map(p => {
          const receitaItem = p.receita.find(r => r.ingredienteId === novaDespesa.ingredienteId);
          const custoAntes = receitaItem.quantidade * precoAtual;
          const custoDepois = receitaItem.quantidade * precoNovo;
          const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
            const ing = ingredientes.find(i => i.id === r.ingredienteId);
            return s + (r.quantidade * (ing?.custoUnitario || 0));
          }, 0);
          const margemDepois = margemAntes - (custoDepois - custoAntes);
          
          return {
            nome: p.nome,
            margemDif: margemDepois - margemAntes
          };
        });
        
        setPriceAlertData({
          ingrediente,
          precoAtual,
          precoNovo,
          diferencaPerc,
          produtosAfetados,
          despesaData: novaDespesa
        });
        setShowPriceAlert(true);
        return; // Don't add yet, wait for user decision
      }
    }

    if (novaDespesa.fornecedor && !fornecedores.includes(novaDespesa.fornecedor)) {
      setFornecedores(prev => [...prev, novaDespesa.fornecedor]);
    }
    
    setDespesas(prev => [...prev, { 
      id: Date.now(), 
      ...novaDespesa, 
      valor: parseFloat(novaDespesa.valor), 
      iva: parseFloat(novaDespesa.iva),
      quantidade: novaDespesa.quantidade ? parseFloat(novaDespesa.quantidade) : null
    }]);

    if (novaDespesa.categoria === 'compras' && novaDespesa.ingredienteId && stockRastreamentoAtivo) {
      registrarEntradaStock({
        ingredienteId: novaDespesa.ingredienteId,
        quantidade: parseFloat(novaDespesa.quantidade || 0),
        unidade: novaDespesa.unidade || 'kg',
        precoTotal: parseFloat(novaDespesa.valor || 0),
        data: novaDespesa.data,
        fornecedor: novaDespesa.fornecedor,
        numeroDocumento: novaDespesa.numeroDocumento
      });
    }
    
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    showNotification('Despesa adicionada!', 'success');
  };

  const adicionarVendaManual = () => {

    if (!novaVenda.produtoId || novaVenda.produtoId === '' || isNaN(novaVenda.produtoId)) {
      showNotification('‚ö†Ô∏è Selecione um produto!', 'error');
      return;
    }
    
    if (!novaVenda.quantidade || parseFloat(novaVenda.quantidade) <= 0) {
      showNotification('‚ö†Ô∏è Quantidade inv√°lida!', 'error');
      return;
    }
    
    const produto = produtos.find(p => p.id === parseInt(novaVenda.produtoId));
    if (!produto) {
      showNotification('‚ùå Produto n√£o encontrado!', 'error');
      return;
    }

    let valorTotal;
    if (novaVenda.usarValorManual && novaVenda.valorManual) {
      valorTotal = parseFloat(novaVenda.valorManual);
    } else {
      valorTotal = produto.precoVenda * parseFloat(novaVenda.quantidade);
    }

    const vendaManual = {
      id: Date.now(),
      data: novaVenda.data,
      produto: produto.nome,
      produtoId: produto.id,
      quantidade: parseFloat(novaVenda.quantidade),
      valor: valorTotal,
      total: valorTotal, // ‚úÖ ADICIONAR CAMPO TOTAL
      iva: produto.iva,
      tipo: 'manual', // Marcar como manual
      origem: 'moloni' // ‚úÖ PARA FILTRO DE M√âTRICAS (vendas manuais = Moloni)
    };

    if (stockRastreamentoAtivo && produto.receita && produto.receita.length > 0) {
      registrarSaidaStock({
        produtoId: produto.id,
        quantidade: parseFloat(novaVenda.quantidade),
        data: novaVenda.data
      });
    }
    
    setVendas([...vendas, vendaManual]);

    setNovaVenda({
      data: new Date().toISOString().split('T')[0],
      produtoId: '',
      quantidade: 1,
      valorManual: '',
      usarValorManual: false,
      numeroDocumento: '',
      tipoDocumento: 'Venda',
      formaPagamento: 'Dinheiro',
      observacoes: ''
    });
    
    setMostrarVendaManual(false);
    showNotification('‚úÖ Venda adicionada com sucesso!', 'success');
  };

  const confirmarDespesaSemAtualizar = () => {
    const despesaData = priceAlertData.despesaData;
    
    if (despesaData.fornecedor && !fornecedores.includes(despesaData.fornecedor)) {
      setFornecedores(prev => [...prev, despesaData.fornecedor]);
    }
    
    setDespesas(prev => [...prev, { 
      id: Date.now(), 
      ...despesaData, 
      valor: parseFloat(despesaData.valor), 
      iva: parseFloat(despesaData.iva),
      quantidade: despesaData.quantidade ? parseFloat(despesaData.quantidade) : null
    }]);

    if (despesaData.categoria === 'compras' && despesaData.ingredienteId && stockRastreamentoAtivo) {
      registrarEntradaStock({
        ingredienteId: despesaData.ingredienteId,
        quantidade: parseFloat(despesaData.quantidade || 0),
        unidade: despesaData.unidade || 'kg',
        precoTotal: parseFloat(despesaData.valor || 0),
        data: despesaData.data,
        fornecedor: despesaData.fornecedor,
        numeroDocumento: despesaData.numeroDocumento
      });
    }
    
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    setShowPriceAlert(false);
    setPriceAlertData(null);
    showNotification('Despesa adicionada!', 'success');
  };

  const confirmarDespesaEAtualizar = () => {
    const { ingrediente, precoNovo, produtosAfetados, despesaData } = priceAlertData;

    const updatedIngredientes = (ingredientes || []).map(i => 
      i.id === ingrediente.id ? { ...i, custoUnitario: precoNovo } : i
    );
    setIngredientes(updatedIngredientes);

    if (despesaData.fornecedor && !fornecedores.includes(despesaData.fornecedor)) {
      setFornecedores(prev => [...prev, despesaData.fornecedor]);
    }
    
    setDespesas(prev => [...prev, { 
      id: Date.now(), 
      ...despesaData, 
      valor: parseFloat(despesaData.valor), 
      iva: parseFloat(despesaData.iva),
      quantidade: despesaData.quantidade ? parseFloat(despesaData.quantidade) : null
    }]);

    if (despesaData.categoria === 'compras' && despesaData.ingredienteId && stockRastreamentoAtivo) {
      registrarEntradaStock({
        ingredienteId: despesaData.ingredienteId,
        quantidade: parseFloat(despesaData.quantidade || 0),
        unidade: despesaData.unidade || 'kg',
        precoTotal: parseFloat(despesaData.valor || 0),
        data: despesaData.data,
        fornecedor: despesaData.fornecedor,
        numeroDocumento: despesaData.numeroDocumento
      });
    }
    
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    setShowPriceAlert(false);
    setPriceAlertData(null);
    showNotification(`‚úÖ Custo do ${ingrediente.nome} atualizado! ${produtosAfetados.length} produtos recalculados`, 'success');
  };

  
  const confirmarFaturaSemAtualizar = () => {

    if (priceAlertData.tipoOperacao === 'ocrPriceUpdate') {
      const ctx = window._ocrContext;
      if (!ctx) {

        setShowPriceAlert(false);
        return;
      }

      ctx.indiceAtual++;
      
      if (ctx.indiceAtual < ctx.mudancasPreco.length) {

        const proximaMudanca = ctx.mudancasPreco[ctx.indiceAtual];
        const proximoIngrediente = ctx.ingredientesAtualizados.find(i => i.id === proximaMudanca.ingredienteId);
        
        setPriceAlertData({
          tipoOperacao: 'ocrPriceUpdate',
          ingrediente: proximoIngrediente,
          precoAtual: proximaMudanca.precoAnterior,
          precoNovo: proximaMudanca.precoNovo,
          unidadeBase: proximoIngrediente.unidade,
          produtosAfetados: produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId === proximoIngrediente.id)
          ),
          totalMudancas: ctx.mudancasPreco.length,
          mudancaAtual: ctx.indiceAtual + 1
        });

        return; // Mant√©m modal aberto para pr√≥xima mudan√ßa
      } else {

        setShowPriceAlert(false);
        setPriceAlertData(null);
        finalizarFaturaOCR(ctx.ingredientesAtualizados, ctx.linhasValidadas, ctx.metadata);
        window._ocrContext = null;
        return;
      }
    }

    if (priceAlertData.tipoOperacao === 'adicionarItem') {

      const item = priceAlertData.itemParaAdicionar;
      setNovaFatura({
        ...novaFatura,
        itens: [...novaFatura.itens, item]
      });
      setItemFatura({
        ingredienteId: '',
        quantidade: '',
        unidade: '',
        precoTotal: '',
        iva: '13'
      });
      showNotification('Item adicionado SEM atualizar pre√ßo base!', 'success');
    } else if (priceAlertData.tipoFatura === 'rapido') {
      salvarFaturaRapidaSemAlerta();
    } else if (priceAlertData.tipoFatura === 'edicao') {
      atualizarFaturaSemAlerta(priceAlertData.faturaData, priceAlertData.faturaEditandoId);
    } else if (priceAlertData.tipoFatura === 'ingrediente') {
      atualizarIngredienteSemAlerta();
    } else {
      salvarFaturaSemAlerta(priceAlertData.faturaData);
    }
    setShowPriceAlert(false);
    setPriceAlertData(null);
  };
  
  const confirmarFaturaEAtualizar = () => {

    const { ingrediente, precoNovo, produtosAfetados } = priceAlertData;

    if (priceAlertData.tipoOperacao === 'ocrPriceUpdate') {
      const ctx = window._ocrContext;
      if (!ctx) {

        setShowPriceAlert(false);
        return;
      }

      const mudancaAtual = ctx.mudancasPreco[ctx.indiceAtual];
      ctx.ingredientesAtualizados[mudancaAtual.ingredienteIndex] = {
        ...ctx.ingredientesAtualizados[mudancaAtual.ingredienteIndex],
        custoUnitario: mudancaAtual.precoNovo,
        precoUnitario: mudancaAtual.precoNovo
      };

      ctx.indiceAtual++;
      
      if (ctx.indiceAtual < ctx.mudancasPreco.length) {

        const proximaMudanca = ctx.mudancasPreco[ctx.indiceAtual];
        const proximoIngrediente = ctx.ingredientesAtualizados.find(i => i.id === proximaMudanca.ingredienteId);
        
        setPriceAlertData({
          tipoOperacao: 'ocrPriceUpdate',
          ingrediente: proximoIngrediente,
          precoAtual: proximaMudanca.precoAnterior,
          precoNovo: proximaMudanca.precoNovo,
          unidadeBase: proximoIngrediente.unidade,
          produtosAfetados: produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId === proximoIngrediente.id)
          ),
          totalMudancas: ctx.mudancasPreco.length,
          mudancaAtual: ctx.indiceAtual + 1
        });

        return; // Mant√©m modal aberto para pr√≥xima mudan√ßa
      } else {

        setShowPriceAlert(false);
        setPriceAlertData(null);
        finalizarFaturaOCR(ctx.ingredientesAtualizados, ctx.linhasValidadas, ctx.metadata);
        window._ocrContext = null;
        return;
      }
    }

    if (priceAlertData.tipoOperacao === 'adicionarItem') {

      setIngredientes(ingredientes.map(ing => 
        ing.id === ingrediente.id 
          ? { 
              ...ing, 
              custoUnitario: precoNovo,
              historicoPrecos: [
                ...(ing.historicoPrecos || []),
                { data: novaFatura.data, preco: precoNovo }
              ]
            }
          : ing
      ));
      
      const item = priceAlertData.itemParaAdicionar;
      setNovaFatura({
        ...novaFatura,
        itens: [...novaFatura.itens, item]
      });
      setItemFatura({
        ingredienteId: '',
        quantidade: '',
        unidade: '',
        precoTotal: '',
        iva: '13'
      });
      showNotification(`Item adicionado! Pre√ßo atualizado: ‚Ç¨${precoNovo.toFixed(2)}/${priceAlertData.unidadeBase}`, 'success');
    } else if (priceAlertData.tipoFatura !== 'ingrediente') {

      const updatedIngredientes = (ingredientes || []).map(i => 
        i.id == ingrediente.id ? { ...i, custoUnitario: precoNovo } : i
      );
      setIngredientes(updatedIngredientes);

      if (priceAlertData.tipoFatura === 'rapido') {
        salvarFaturaRapidaSemAlerta();
      } else if (priceAlertData.tipoFatura === 'edicao') {
        atualizarFaturaSemAlerta(priceAlertData.faturaData, priceAlertData.faturaEditandoId);
      } else if (priceAlertData.tipoFatura === 'ingrediente') {
        atualizarIngredienteSemAlerta();
      } else {
        salvarFaturaSemAlerta(priceAlertData.faturaData);
      }
      showNotification(`Custo do ${ingrediente.nome} atualizado! ${produtosAfetados.length} produtos afetados`, 'success');
    }
    setShowPriceAlert(false);
    setPriceAlertData(null);
  };
  
  const adicionarItemFatura = () => {

    if (novaFatura.categoria === 'compras') {
      if (!itemFatura.ingredienteId || !itemFatura.quantidade || !itemFatura.precoTotal || !itemFatura.unidade) {

        showNotification('Preencha todos os campos do item!', 'error');
        return;
      }
      
      const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);

      if (!ingrediente) {
        showNotification('Ingrediente n√£o encontrado!', 'error');
      return;
    }
    
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    const iva = parseFloat(itemFatura.iva || '13');

    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === unidadeBase) {
      quantidadeBase = quantidade;
    }

    const subtotalSemIva = precoTotal / (1 + iva / 100);
    const precoPorUnidadeBase = subtotalSemIva / quantidadeBase;

    const precoAtual = ingrediente.custoUnitario;
    const diferenca = Math.abs(precoPorUnidadeBase - precoAtual);
    const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
    
    if (diferencaPerc > 5) {

      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId == itemFatura.ingredienteId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId == itemFatura.ingredienteId);

        let quantidadeReceita = receitaItem.quantidade;
        const unidadeReceita = receitaItem.unidade || ingrediente.unidade;
        if (ingrediente.unidade === 'kg' && unidadeReceita === 'g') {
          quantidadeReceita = receitaItem.quantidade / 1000;
        } else if (ingrediente.unidade === 'L' && unidadeReceita === 'ml') {
          quantidadeReceita = receitaItem.quantidade / 1000;
        }
        
        const custoAntes = quantidadeReceita * precoAtual;
        const custoDepois = quantidadeReceita * precoPorUnidadeBase;

        const custoTotalAntes = (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          if (!ing) return s;
          let q = r.quantidade;
          const ur = r.unidade || ing.unidade;
          if (ing.unidade === 'kg' && ur === 'g') q = r.quantidade / 1000;
          if (ing.unidade === 'L' && ur === 'ml') q = r.quantidade / 1000;
          return s + (q * ing.custoUnitario);
        }, 0);
        
        const margemAntes = p.precoVenda - custoTotalAntes;
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes,
          custoAntes,
          custoDepois
        };
      });

      const subtotalSemIva = precoTotal / (1 + iva / 100);
      const itemParaGuardar = {
        id: Date.now(),
        ingredienteId: itemFatura.ingredienteId,
        ingredienteNome: ingrediente.nome,
        unidade: unidadeCompra,
        quantidade,
        precoUnitario: precoPorUnidadeBase,
        iva,
        subtotal: subtotalSemIva
      };
      
      setPriceAlertData({
        ingrediente,
        precoAtual,
        precoNovo: precoPorUnidadeBase,
        diferencaPerc,
        produtosAfetados,
        itemParaAdicionar: itemParaGuardar,
        quantidadeBase,
        unidadeBase,
        tipoOperacao: 'adicionarItem'
      });
      setShowPriceAlert(true);
      return; // Para aqui, espera decis√£o do utilizador
    }

    setIngredientes(ingredientes.map(ing => 
      ing.id === ingrediente.id 
        ? { 
            ...ing, 
            custoUnitario: precoPorUnidadeBase,
            historicoPrecos: [
              ...(ing.historicoPrecos || []),
              { data: novaFatura.data, preco: precoPorUnidadeBase }
            ]
          }
        : ing
    ));

    const novoItem = {
      id: Date.now(),
      ingredienteId: itemFatura.ingredienteId,
      ingredienteNome: ingrediente.nome,
      unidade: unidadeCompra,
      quantidade,
      precoUnitario: precoPorUnidadeBase,
      iva,
      subtotal: subtotalSemIva
    };

    setNovaFatura({
      ...novaFatura,
      itens: [...novaFatura.itens, novoItem]
    });
    
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13',
      num_funcionarios: 1
    });

    setSearchIngredienteFatura('');
    
    showNotification(`Item adicionado! Pre√ßo atualizado: ‚Ç¨${precoPorUnidadeBase.toFixed(2)}/${unidadeBase}`, 'success');
    return; // Fim do modo compras
    } // Fim do if categoria === 'compras'

    if (!itemFatura.descricao || !itemFatura.precoTotal) {

      showNotification('Preencha descri√ß√£o e valor!', 'error');
      return;
    }
    
    const precoTotal = parseFloat(itemFatura.precoTotal);

    const iva = novaFatura.categoria === 'salarios' ? 0 : parseFloat(itemFatura.iva || '23');
    const subtotalSemIva = iva > 0 ? precoTotal / (1 + iva / 100) : precoTotal;
    
    const novoItem = {
      id: Date.now(),
      descricao: itemFatura.descricao,
      quantidade: 1, // Fixo para despesas
      unidade: 'servi√ßo', // Fixo para despesas
      precoUnitario: precoTotal, // Valor total = valor unit√°rio
      iva,
      subtotal: subtotalSemIva,
      num_funcionarios: itemFatura.num_funcionarios || 1 // Para sal√°rios
    };

    setNovaFatura({
      ...novaFatura,
      itens: [...novaFatura.itens, novoItem]
    });
    
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13',
      num_funcionarios: 1
    });
    
    showNotification('Item adicionado!', 'success');
  };
  
  const removerItemFatura = (itemId) => {
    setNovaFatura({
      ...novaFatura,
      itens: novaFatura.itens.filter(item => item.id !== itemId)
    });
  };
  
  const salvarFatura = () => {

    if (novaFatura.categoria !== 'salarios' && !novaFatura.fornecedorId) {
      showNotification('Selecione um fornecedor!', 'error');
      return;
    }
    
    if ((novaFatura.itens || []).length === 0) {
      showNotification('Adicione pelo menos 1 item!', 'error');
      return;
    }

    const tipoDoc = novaFatura.tipoDocumento || 'fatura';
    
    if (tipoDoc === 'fatura' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const faturasHoje = (faturas || []).filter(f => f.data === novaFatura.data).length;
      novaFatura.numero = `FAT/${ano}/${String(faturasHoje + 1).padStart(4, '0')}`;
    }

    if (tipoDoc === 'recibo' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      novaFatura.numero = null;
    }

    if (novaFatura.fromOCR) {

      salvarFaturaSemAlerta();
      return;
    }

    let temAlertaPreco = false;
    for (const item of novaFatura.itens) {
      const ingrediente = ingredientes.find(i => i.id == item.ingredienteId);
      if (ingrediente) {
        const precoAtual = ingrediente.custoUnitario;
        const precoNovo = item.precoUnitario;
        const diferenca = Math.abs(precoNovo - precoAtual);
        const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
        
        if (diferencaPerc > 5) {

          const produtosAfetados = produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId == item.ingredienteId)
          ).map(p => {
            const receitaItem = p.receita.find(r => r.ingredienteId == item.ingredienteId);
            const custoAntes = receitaItem.quantidade * precoAtual;
            const custoDepois = receitaItem.quantidade * precoNovo;
            const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
              const ing = ingredientes.find(i => i.id == r.ingredienteId);
              return s + (r.quantidade * (ing?.custoUnitario || 0));
            }, 0);
            const margemDepois = margemAntes - (custoDepois - custoAntes);
            
            return {
              nome: p.nome,
              margemDif: margemDepois - margemAntes
            };
          });
          
          setPriceAlertData({
            ingrediente,
            precoAtual,
            precoNovo,
            diferencaPerc,
            produtosAfetados,
            faturaData: novaFatura,
            tipoFatura: 'completa'
          });
          setShowPriceAlert(true);
          temAlertaPreco = true;
          return; // N√£o guarda ainda
        }
      }
    }

    if (!temAlertaPreco) {
      salvarFaturaSemAlerta();
    }
  };
  
  const salvarFaturaSemAlerta = (dadosFatura = null) => {

    const faturaParaGuardar = dadosFatura || novaFatura;

    let fornecedor = null;
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (faturaParaGuardar.categoria === 'salarios') {

      fornecedorNome = 'Equipa';
      fornecedorNif = '';
    } else if (faturaParaGuardar.fornecedorId) {

      fornecedor = fornecedores.find(f => {
        const fId = f.id || f;
        return String(fId) === String(faturaParaGuardar.fornecedorId);
      });
      
      fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
      fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    }
    
    const novaFaturaCompleta = {
      id: Date.now(),
      criadoEm: new Date().toISOString(), // üÜï Timestamp de cria√ß√£o
      numero: faturaParaGuardar.numero,
      tipo: faturaParaGuardar.tipo || 'FT', // ‚úÖ TIPO DE FATURA (FT/FR/FS)
      tipoDocumento: faturaParaGuardar.tipoDocumento || 'fatura', // NOVO: tipo de documento
      data: faturaParaGuardar.data,
      fornecedorId: faturaParaGuardar.fornecedorId || '',
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: faturaParaGuardar.itens,
      notas: faturaParaGuardar.notas,
      categoria: faturaParaGuardar.categoria || 'compras', // Nova
      recorrente: faturaParaGuardar.recorrente || false, // Nova
      diaRecorrencia: faturaParaGuardar.diaRecorrencia || 1, // Nova
      documentoPDF: faturaParaGuardar.documentoPDF || null, // PDF da fatura
      nomeDocumento: faturaParaGuardar.nomeDocumento || '', // Nome do PDF

      temNifCliente: faturaParaGuardar.temNifCliente || false,
      nifCliente: faturaParaGuardar.nifCliente || null,
      paraContabilista: (() => {
        const tipo = faturaParaGuardar.tipo || 'FT';
        const temNif = faturaParaGuardar.temNifCliente;

        if (tipo === 'FT' || tipo === 'FR') return true;

        if (tipo === 'FS') return temNif === true;
        return false;
      })(),
      subtotal: faturaParaGuardar.itens.reduce((sum, item) => sum + item.subtotal, 0),
      totalIva: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
      total: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0),
      totais: faturaParaGuardar.totais || { // ‚úÖ TOTAIS ESTRUTURADOS
        subtotal: faturaParaGuardar.itens.reduce((sum, item) => sum + item.subtotal, 0),
        iva: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
        total: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0)
      }
    };

    setFaturas([...faturas, novaFaturaCompleta]);
    setUltimaFaturaInserida(novaFaturaCompleta.id); // üÜï Marcar como √∫ltima inserida

    setNovaFatura({
      numero: '',
      tipoDocumento: 'FT', // NOVO
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });

    setSearchIngredienteFatura('');
    setCriandoIngrediente(false);
    
    setEditandoFatura(false);
    showNotification('Fatura guardada!', 'success');
  };
  
  const salvarFaturaRapida = () => {

    if (novaFatura.categoria !== 'salarios' && !novaFatura.fornecedorId) {
      showNotification('Selecione um fornecedor!', 'error');
      return;
    }
    
    if (novaFatura.categoria === 'compras') {

      if (!itemFatura.ingredienteId || !itemFatura.quantidade || !itemFatura.precoTotal || !itemFatura.unidade) {
        showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
        return;
      }
    } else {

      if (!itemFatura.descricao || !itemFatura.precoTotal) {
        showNotification('Preencha descri√ß√£o e valor!', 'error');
        return;
      }

      salvarFaturaRapidaDespesa();
      return;
    }

    const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;

    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    }
    
    const precoPorUnidadeBase = precoTotal / quantidadeBase;
    const precoAtual = ingrediente.custoUnitario;
    const diferenca = Math.abs(precoPorUnidadeBase - precoAtual);
    const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;

    if (diferencaPerc > 5) {

      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId == itemFatura.ingredienteId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId == itemFatura.ingredienteId);
        const custoAntes = receitaItem.quantidade * precoAtual;
        const custoDepois = receitaItem.quantidade * precoPorUnidadeBase;
        const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          return s + (r.quantidade * (ing?.custoUnitario || 0));
        }, 0);
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes
        };
      });
      
      setPriceAlertData({
        ingrediente,
        precoAtual,
        precoNovo: precoPorUnidadeBase,
        diferencaPerc,
        produtosAfetados,
        faturaData: {
          ...novaFatura,
          itemFatura: itemFatura
        },
        tipoFatura: 'rapido'
      });
      setShowPriceAlert(true);
      return; // N√£o guarda ainda, espera decis√£o do utilizador
    }

    salvarFaturaRapidaSemAlerta();
  };
  
  const salvarFaturaRapidaSemAlerta = () => {
    const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
    const fornecedor = fornecedores.find(f => (f.id || f) === novaFatura.fornecedorId);

    const fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
    const fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    const iva = parseFloat(itemFatura.iva);

    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    }
    
    const precoPorUnidadeBase = precoTotal / quantidadeBase;

    setIngredientes(ingredientes.map(ing => 
      ing.id === ingrediente.id 
        ? { 
            ...ing, 
            custoUnitario: precoPorUnidadeBase,
            historicoPrecos: [
              ...(ing.historicoPrecos || []),
              { data: novaFatura.data, preco: precoPorUnidadeBase }
            ]
          }
        : ing
    ));

    const subtotalSemIva = precoTotal / (1 + iva / 100);
    const totalIva = precoTotal - subtotalSemIva;
    const total = precoTotal; // J√° est√° com IVA

    const hoje = new Date();
    const ano = hoje.getFullYear();
    const registosRapidosHoje = (faturas || []).filter(f => 
      f.tipo === 'rapido' && 
      f.data === novaFatura.data
    ).length;
    const numeroAuto = `RR/${ano}/${String(registosRapidosHoje + 1).padStart(3, '0')}`;
    
    const item = {
      id: Date.now(),
      ingredienteId: itemFatura.ingredienteId,
      ingredienteNome: ingrediente.nome,
      unidade: unidadeCompra,
      quantidade,
      precoUnitario: precoPorUnidadeBase,
      iva,
      subtotal: subtotalSemIva
    };
    
    const faturaRapida = {
      id: Date.now(),
      numero: numeroAuto,
      tipoDocumento: novaFatura.tipoDocumento || 'fatura', // NOVO
      data: novaFatura.data,
      fornecedorId: novaFatura.fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: novaFatura.notas || 'Registo r√°pido',
      categoria: novaFatura.categoria || 'compras', // Nova
      recorrente: novaFatura.recorrente || false, // Nova
      diaRecorrencia: novaFatura.diaRecorrencia || 1, // Nova
      subtotal: subtotalSemIva,
      totalIva,
      total,
      tipo: 'rapido' // Marca que √© registo r√°pido
    };
    
    setFaturas([...faturas, faturaRapida]);

    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1
    });
    setItemFatura({
      ingredienteId: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13'
    });
    
    showNotification(`Compra registada! Pre√ßo atualizado: ‚Ç¨${precoPorUnidadeBase.toFixed(2)}/${unidadeBase}`, 'success');
  };
  
  const salvarFaturaRapidaDespesa = () => {

    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (novaFatura.categoria === 'salarios') {

      fornecedorNome = 'Equipa';
      fornecedorNif = '';
    } else if (novaFatura.fornecedorId) {

      const fornecedor = fornecedores.find(f => (f.id || f) === novaFatura.fornecedorId);
      fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
      fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    }
    
    const precoTotal = parseFloat(itemFatura.precoTotal);

    const iva = novaFatura.categoria === 'salarios' ? 0 : parseFloat(itemFatura.iva);
    const subtotalSemIva = iva > 0 ? precoTotal / (1 + iva / 100) : precoTotal;
    const totalIva = precoTotal - subtotalSemIva;

    const hoje = new Date();
    const ano = hoje.getFullYear();
    const registosRapidosHoje = (faturas || []).filter(f => 
      f.tipo === 'rapido' && 
      f.data === novaFatura.data
    ).length;
    const numeroAuto = `RR/${ano}/${String(registosRapidosHoje + 1).padStart(3, '0')}`;
    
    const item = {
      id: Date.now(),
      descricao: itemFatura.descricao,
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoTotal,
      iva,
      subtotal: subtotalSemIva,
      num_funcionarios: itemFatura.num_funcionarios || 1 // Para sal√°rios
    };
    
    const faturaRapida = {
      id: Date.now(),
      numero: numeroAuto,
      tipoDocumento: novaFatura.tipoDocumento || 'fatura', // NOVO
      data: novaFatura.data,
      fornecedorId: novaFatura.fornecedorId || '',
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: novaFatura.notas || 'Registo r√°pido',
      categoria: novaFatura.categoria,
      recorrente: novaFatura.recorrente || false,
      diaRecorrencia: novaFatura.diaRecorrencia || 1,
      subtotal: subtotalSemIva,
      totalIva,
      total: precoTotal,
      tipo: 'rapido'
    };
    
    setFaturas([...faturas, faturaRapida]);

    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1
    });
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13'
    });
    
    showNotification('Despesa registada!', 'success');
  };
  
  const apagarFatura = (faturaId) => {
    if (confirm('‚ö†Ô∏è Apagar esta compra?')) {
      setFaturas((faturas || []).filter(f => f.id !== faturaId));
      showNotification('Compra apagada!', 'success');
    }
  };
  
  const editarFatura = (fatura) => {
    setNovaFatura({
      id: fatura.id,
      numero: fatura.numero,
      data: fatura.data,
      fornecedorId: fatura.fornecedorId,
      fornecedorNome: fatura.fornecedorNome,
      fornecedorNif: fatura.fornecedorNif,
      itens: fatura.itens,
      notas: fatura.notas,
      categoria: fatura.categoria || 'compras',
      tipoDocumento: fatura.tipo || 'FT', // ‚úÖ USAR fatura.tipo (FT/FR/FS)
      tipo: fatura.tipo || 'FT',
      recorrente: fatura.recorrente || false,
      diaRecorrencia: fatura.diaRecorrencia || 1,
      documentoPDF: fatura.documentoPDF || null,
      nomeDocumento: fatura.nomeDocumento || '',
      totais: fatura.totais || null,
      total: fatura.total || 0,
      subtotal: fatura.subtotal || 0,
      totalIva: fatura.totalIva || 0
    });
    setEditandoFatura(true);
    setFaturaEditando(fatura.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarFatura = () => {

    if (!novaFatura.fornecedorId || (novaFatura.itens || []).length === 0) {
      showNotification('Preencha fornecedor e adicione pelo menos 1 item!', 'error');
      return;
    }

    const tipoDoc = novaFatura.tipoDocumento || 'fatura';
    
    if (tipoDoc === 'fatura' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const faturasHoje = (faturas || []).filter(f => f.data === novaFatura.data && f.id !== faturaEditando).length;
      novaFatura.numero = `FAT/${ano}/${String(faturasHoje + 1).padStart(4, '0')}`;
    }

    if (tipoDoc === 'recibo' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      novaFatura.numero = null;
    }

    const faturaOriginal = faturas.find(f => f.id === faturaEditando);
    
    let temAlertaPreco = false;
    for (const item of novaFatura.itens) {
      const ingrediente = ingredientes.find(i => i.id == item.ingredienteId);
      if (ingrediente) {

        const itemOriginal = faturaOriginal?.itens.find(i => i.ingredienteId === item.ingredienteId);

        const precoMudou = !itemOriginal || Math.abs(item.precoUnitario - itemOriginal.precoUnitario) > 0.001;
        
        if (precoMudou) {
          const precoAtual = ingrediente.custoUnitario;
          const precoNovo = item.precoUnitario;
          const diferenca = Math.abs(precoNovo - precoAtual);
          const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
          
          if (diferencaPerc > 5) {

            const produtosAfetados = produtos.filter(p => 
              p.receita && p.receita.some(r => r.ingredienteId == item.ingredienteId)
            ).map(p => {
              const receitaItem = p.receita.find(r => r.ingredienteId == item.ingredienteId);
              const custoAntes = receitaItem.quantidade * precoAtual;
              const custoDepois = receitaItem.quantidade * precoNovo;
              const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
                const ing = ingredientes.find(i => i.id == r.ingredienteId);
                return s + (r.quantidade * (ing?.custoUnitario || 0));
              }, 0);
              const margemDepois = margemAntes - (custoDepois - custoAntes);
              
              return {
                nome: p.nome,
                margemDif: margemDepois - margemAntes
              };
            });
            
            setPriceAlertData({
              ingrediente,
              precoAtual,
              precoNovo,
              diferencaPerc,
              produtosAfetados,
              faturaData: novaFatura,
              faturaEditandoId: faturaEditando, // Guardar ID da fatura em edi√ß√£o
              tipoFatura: 'edicao' // Marcar como edi√ß√£o
            });
            setShowPriceAlert(true);
            temAlertaPreco = true;
            return; // N√£o atualiza ainda
          }
        }
      }
    }

    if (!temAlertaPreco) {
      atualizarFaturaSemAlerta();
    }
  };
  
  const atualizarFaturaSemAlerta = (dadosFatura = null, faturaId = null) => {
    const faturaParaAtualizar = dadosFatura || novaFatura;
    const idParaAtualizar = faturaId || faturaEditando;
    
    const fornecedor = fornecedores.find(f => (f.id || f) === faturaParaAtualizar.fornecedorId);

    const fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
    const fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    
    const faturaOriginal = faturas.find(f => f.id === idParaAtualizar);
    
    const faturaAtualizada = {
      ...faturaOriginal, // ‚úÖ PRESERVAR TUDO DA FATURA ORIGINAL
      id: idParaAtualizar,
      numero: faturaParaAtualizar.numero,
      data: faturaParaAtualizar.data,
      fornecedorId: faturaParaAtualizar.fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: faturaParaAtualizar.itens,
      notas: faturaParaAtualizar.notas,
      subtotal: faturaParaAtualizar.itens.reduce((sum, item) => sum + item.subtotal, 0),
      totalIva: faturaParaAtualizar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
      total: faturaParaAtualizar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0)

    };
    
    setFaturas(faturas.map(f => f.id === idParaAtualizar ? faturaAtualizada : f));

    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: ''
    });
    
    setEditandoFatura(false);
    setFaturaEditando(null);
    showNotification('Fatura atualizada!', 'success');
  };
  
  const cancelarEdicaoFatura = () => {
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: ''
    });
    setEditandoFatura(false);
    setFaturaEditando(null);
  };

  
  const adicionarFornecedor = (nome, nif = '', morada = '', email = '', telefone = '') => {
    const novoFornecedor = {
      id: Date.now(),
      nome,
      nif,
      morada,
      email,
      telefone,
      dataCriacao: new Date().toISOString()
    };
    setFornecedores(prev => [...prev, novoFornecedor]);
    return novoFornecedor.id;
  };
  
  const atualizarFornecedor = (fornecedorId, dadosAtualizados) => {
    setFornecedores((fornecedores || []).map(f => 
      f.id === fornecedorId ? { ...f, ...dadosAtualizados } : f
    ));
  };
  
  const apagarFornecedor = (fornecedorId) => {

    const faturasComFornecedor = (faturas || []).filter(f => f.fornecedorId === fornecedorId);
    if (faturasComFornecedor.length > 0) {
      showNotification(`N√£o pode apagar! Existem ${faturasComFornecedor.length} faturas com este fornecedor.`, 'error');
      return;
    }
    
    if (confirm('‚ö†Ô∏è Apagar este fornecedor?')) {
      setFornecedores(fornecedores.filter(f => f.id !== fornecedorId));
      showNotification('Fornecedor apagado!', 'success');
    }
  };
  
  const editarFornecedor = (fornecedor) => {
    setEditandoFornecedor(true);
    setFornecedorEditandoId(fornecedor.id);
    setDadosFornecedor({
      nome: fornecedor.nome,
      nif: fornecedor.nif || '',
      morada: fornecedor.morada || '',
      email: fornecedor.email || '',
      telefone: fornecedor.telefone || ''
    });

    setTimeout(() => {
      const elem = document.querySelector('#fornecedor-form');
      if (elem) elem.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };
  
  const salvarEdicaoFornecedor = () => {
    if (!dadosFornecedor.nome) {
      showNotification('Preencha o nome do fornecedor!', 'error');
      return;
    }
    
    atualizarFornecedor(fornecedorEditandoId, dadosFornecedor);

    setEditandoFornecedor(false);
    setFornecedorEditandoId(null);
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
    
    showNotification('Fornecedor atualizado!', 'success');
  };
  
  const cancelarEdicaoFornecedor = () => {
    setEditandoFornecedor(false);
    setFornecedorEditandoId(null);
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
  };
  
  const adicionarNovoFornecedor = () => {
    if (!dadosFornecedor.nome) {
      showNotification('Preencha o nome do fornecedor!', 'error');
      return;
    }
    
    adicionarFornecedor(
      dadosFornecedor.nome,
      dadosFornecedor.nif,
      dadosFornecedor.morada,
      dadosFornecedor.email,
      dadosFornecedor.telefone
    );

    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
    
    showNotification('Fornecedor adicionado!', 'success');
  };

  const processarFicheiro = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
      const txt = ev.target.result;
      const lns = txt.split('\n').filter(l => l.trim());
      const vs = [];

      for (let i = 0; i < lns.length; i++) {
        const ln = lns[i];

        if (i === 0 || ln.toLowerCase().includes('data') || ln.toLowerCase().includes('documento')) {

          continue;
        }
        
        if (ln.includes(';')) {
          const pts = ln.split(';').map(p => p.replace(/"/g, '').trim());
          
          if (i < 3) {

          }

          let dataStr = pts[0];
          let produto = pts[1];
          let quantidade = 1;
          let total = 0;

          let dt = null;

          if (dataStr && dataStr.match(/\d{2}-\d{2}-\d{4}/)) {
            const [d, m, a] = dataStr.split('-');
            dt = `${a}-${m}-${d}`;
          }

          else if (dataStr && dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) {
            const [d, m, a] = dataStr.split('/');
            dt = `${a}-${m}-${d}`;
          }

          else if (dataStr && dataStr.match(/\d{4}-\d{2}-\d{2}/)) {
            dt = dataStr;
          }

          for (let j = 0; j < pts.length; j++) {
            const val = pts[j];

            if (val.includes('Uni.') || (j > 8 && j < 13 && val.match(/^\d+[,.]?\d*$/))) {
              const q = parseFloat(val.replace('Uni.', '').replace(',', '.'));
              if (!isNaN(q) && q > 0) quantidade = q;
            }

            if ((val.includes('‚Ç¨') || (j > 10 && val.match(/^\d+[,.]?\d*$/))) && j > 9) {
              const t = parseFloat(val.replace('‚Ç¨', '').replace(',', '.'));
              if (!isNaN(t) && t > 0) total = t;
            }
          }
          
          if (dt && produto && total > 0) {
            vs.push({ 
              id: Date.now() + i, 
              data: dt, 
              produto: produto, 
              quantidade: quantidade, 
              valor: total, 
              total: total,
              iva: 6,
              origem: 'moloni'
            });
            
            if (vs.length <= 3) {

            }
          }
        }
      }

      if (vs.length > 0) { 
        setVendas([...vendas, ...vs]); 
        showNotification(`${vs.length} vendas importadas!`, 'success');
        e.target.value = ''; 
      }
      else {

        showNotification('Nenhuma venda encontrada. Verifica formato CSV.', 'error');
      }
    };
    r.readAsText(f);
  };

  const processarZobaze = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const worksheet = workbook.Sheets['receiptsWithItems'];
      
      if (!worksheet) {
        showNotification('‚ùå Sheet "receiptsWithItems" n√£o encontrada', 'error');
        return;
      }
      
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const vendasImportadas = [];
      let statsDicionario = 0, statsFuzzy = 0, statsExato = 0, statsSemMatch = 0;
      
      let currentDate = '';
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        if (row[1]) {
          currentDate = row[1];
        }

        if (row[6] !== 'Item' || !row[7] || !row[8]) continue;
        
        const match = String(row[7]).match(/(.+?)\s*\((\d+(?:\.\d+)?)\s*X\s*([\d.]+)\)/);
        const nomeProduto = match ? match[1].trim() : String(row[7]).trim();
        const quantidade = match ? parseFloat(match[2]) : 1;
        const precoUnitario = match ? parseFloat(match[3]) : parseFloat(row[8]) || 0;
        const valor = parseFloat(row[8]) || 0;
        
        if (!nomeProduto || valor === 0) continue;
        
        let produto = null, confianca = 0, metodoMatch = 'nenhum';
        
        const nomeCorrigido = mapearNomeProduto(nomeProduto);
        if (nomeCorrigido !== nomeProduto) {

          const normalize = (str) => str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
          produto = produtos.find(p => normalize(p.nome) === normalize(nomeCorrigido));
          if (produto) { confianca = 100; metodoMatch = 'dicionario'; statsDicionario++; }
        }
        
        if (!produto) {
          const matchResult = findBestMatchProduto(nomeProduto, produtos);
          if (matchResult) {
            produto = produtos.find(p => p.id === matchResult.id);
            confianca = matchResult.confianca;
            metodoMatch = matchResult.metodo;
            if (matchResult.metodo === 'exato') statsExato++; else statsFuzzy++;
          } else {
            statsSemMatch++;
          }
        }

        let dataFormatada = '';
        if (currentDate) {
          try {
            const dt = new Date(currentDate);
            dataFormatada = !isNaN(dt.getTime()) ? dt.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
          } catch (err) {
            dataFormatada = new Date().toISOString().split('T')[0];
          }
        } else {
          dataFormatada = new Date().toISOString().split('T')[0];
        }
        
        vendasImportadas.push({
          id: Date.now() + Math.random(),
          data: dataFormatada,
          produto: produto?.nome || nomeProduto,
          produtoId: produto?.id || null,
          quantidade: quantidade,
          valor: valor,
          iva: produto?.iva || 6,
          origem: 'zobaze',
          confiancaMatch: confianca,
          metodoMatch: metodoMatch,
          nomeOriginalCSV: nomeProduto
        });
      }
      
      if (vendasImportadas.length > 0) {

        const datasMaisRecentes = vendasImportadas
          .map(v => v.data)
          .filter(d => d)
          .sort((a, b) => new Date(b) - new Date(a));
        
        if (datasMaisRecentes.length > 0) {
          setUltimaImportacaoZobaze(datasMaisRecentes[0]);
        }
        
        setVendas([...vendas, ...vendasImportadas]);
        setMostrarImportacao(false);
        
        const total = statsDicionario + statsExato + statsFuzzy;
        const pct = Math.round(total/vendasImportadas.length*100);
        
        showNotification(
          '‚úÖ ' + vendasImportadas.length + ' vendas Zobaze!\n' +
          '‚úì ' + total + ' emparelhadas (' + pct + '%)\n' +
          '  ‚Ä¢ ' + statsDicionario + ' dicion√°rio\n' +
          '  ‚Ä¢ ' + statsExato + ' exato\n' +
          '  ‚Ä¢ ' + statsFuzzy + ' fuzzy\n' +
          (statsSemMatch > 0 ? '‚ö† ' + statsSemMatch + ' sem match' : ''),
          total === vendasImportadas.length ? 'success' : 'warning'
        );

        
        
        e.target.value = '';
      } else {
        showNotification('‚ùå Nenhuma venda v√°lida encontrada', 'error');
      }
    } catch (err) {
      console.error('Erro Zobaze:', err);
      showNotification('‚ùå Erro: ' + err.message, 'error');
    }
  };

  const gerarFaturasRecorrentes = React.useCallback(() => {
    const hoje = new Date();
    const diaHoje = hoje.getDate();
    const mesHoje = hoje.getMonth();
    const anoHoje = hoje.getFullYear();

    const faturasRecorrentes = (faturas || []).filter(f => f.recorrente === true);
    
    if (faturasRecorrentes.length === 0) return;
    
    const novasFaturas = [];
    
    faturasRecorrentes.forEach(faturaOriginal => {
      const diaRecorrencia = faturaOriginal.diaRecorrencia || 1;

      if (diaHoje !== diaRecorrencia) return;

      const dataHoje = `${anoHoje}-${String(mesHoje + 1).padStart(2, '0')}-${String(diaHoje).padStart(2, '0')}`;
      
      const jaExiste = (faturas || []).some(f => 
        f.data === dataHoje && 
        f.numero.startsWith(faturaOriginal.numero) &&
        f.categoria === faturaOriginal.categoria
      );
      
      if (jaExiste) return; // J√° foi gerada este m√™s

      const novaFatura = {
        ...faturaOriginal,
        id: Date.now() + Math.random(), // ID √∫nico
        numero: `${faturaOriginal.numero.split('/')[0]}/AUTO-${anoHoje}${String(mesHoje + 1).padStart(2, '0')}`,
        data: dataHoje,
        notas: `${faturaOriginal.notas || ''} (Gerada automaticamente)`.trim()
      };
      
      novasFaturas.push(novaFatura);
    });
    
    if (novasFaturas.length > 0) {
      setFaturas([...faturas, ...novasFaturas]);
      showNotification(`‚ú® ${novasFaturas.length} fatura(s) recorrente(s) gerada(s) automaticamente!`, 'success');
    }
  }, [faturas, setFaturas, showNotification]);

  React.useEffect(() => {

    gerarFaturasRecorrentes();

    const intervalo = setInterval(gerarFaturasRecorrentes, 24 * 60 * 60 * 1000);
    
    return () => clearInterval(intervalo);
  }, [gerarFaturasRecorrentes]);

  const syncToGitHub = React.useCallback(async () => {
    if (!GitHubSync.isConfigured() || isSyncing) return;
    
    setIsSyncing(true);
    setSyncError(null);
    
    try {
      const token = GitHubSync.getToken();
      const data = {
        produtos,
        ingredientes,
        vendas,
        despesas,
        fornecedores,
        dadosEmpresa,
        faturas,
        movimentacoesStock, // üÜï STOCK INTELIGENTE
        timestamp: new Date().toISOString()
      };
      
      const result = await GitHubSync.saveToGist(data, token);
      
      if (result.success) {
        setLastSync(new Date());
      } else {
        setSyncError(result.error);
      }
    } catch (error) {
      setSyncError(error.message);
    } finally {
      setIsSyncing(false);
    }
  }, [produtos, ingredientes, vendas, despesas, fornecedores, dadosEmpresa, faturas, isSyncing]);

  useEffect(() => {
    if (vocabularioFornecedor && vocabularioFornecedor.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveVocabulario(vocabularioFornecedor);
      };
      const timeout = setTimeout(save, 1000);
      return () => clearTimeout(timeout);
    }
  }, [vocabularioFornecedor]);

  useEffect(() => {
    if (ingredientes && ingredientes.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveIngredientes(ingredientes);
      };
      const timeout = setTimeout(save, 2000);
      return () => clearTimeout(timeout);
    }
  }, [ingredientes]);

  useEffect(() => {
    if (fornecedores && fornecedores.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveFornecedores(fornecedores);
      };
      const timeout = setTimeout(save, 2000);
      return () => clearTimeout(timeout);
    }
  }, [fornecedores]);

  useEffect(() => {
    if (templatesOCR && templatesOCR.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveTemplates(templatesOCR);
      };
      const timeout = setTimeout(save, 2000);
      return () => clearTimeout(timeout);
    }
  }, [templatesOCR]);

  useEffect(() => {
    if (driveAccessToken) {

      scheduleSync();
    }

    return () => {
      if (syncTimeoutRef.current) {
        clearTimeout(syncTimeoutRef.current);
      }
    };
  }, [
    produtos, 
    ingredientes, 
    vendas, 
    faturas, 
    fornecedores, 
    vocabularioFornecedor, 
    templatesOCR, 
    blacklist,              // ‚úÖ ADICIONADO! Agora blacklist sincroniza
    dadosEmpresa,
    deliveryApps,
    configuracaoWaste,
    contagens,
    movimentacoesStock,
    ultimaFaturaInserida,
    driveAccessToken
  ]);

  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.onload = () => {

      const tokenData = GoogleDriveTokenManager.getTokenData();
      
      if (tokenData && GoogleDriveTokenManager.isTokenValid()) {
        setDriveAccessToken(tokenData.access_token);
        loadUserInfo(tokenData.access_token);

        showNotification('‚úÖ Reconectado automaticamente ao Google Drive', 'success');
      } else if (tokenData) {

        GoogleDriveTokenManager.clearToken();
        showNotification('üîí Sess√£o Google Drive expirou. Fa√ßa login novamente.', 'info');
      }
    };
    document.head.appendChild(script);
  }, []);

  useEffect(() => {
    if (!driveAccessToken) {

      if (tokenCheckIntervalRef.current) {
        clearInterval(tokenCheckIntervalRef.current);
        tokenCheckIntervalRef.current = null;
      }
      return;
    }
    
    const checkToken = () => {
      const valid = GoogleDriveTokenManager.isTokenValid();
      const timeLeft = GoogleDriveTokenManager.getTimeUntilExpiry();
      
      setDriveTokenValid(valid);
      setDriveTokenTimeLeft(timeLeft);

      if (!valid && timeLeft > 0 && timeLeft <= 10) {
        showNotification(
          `‚ö†Ô∏è Token expira em ${timeLeft} minutos. Clique no bot√£o "üîë Renovar Token" para manter a liga√ß√£o.`,
          'warning'
        );
      }

      if (timeLeft === 0) {
        showNotification('üîí Sess√£o Google Drive expirou. Fa√ßa login novamente.', 'error');
        logoutGoogleDrive();
      }
    };

    checkToken();

    tokenCheckIntervalRef.current = setInterval(checkToken, GoogleDriveTokenManager.CHECK_INTERVAL);
    
    return () => {
      if (tokenCheckIntervalRef.current) {
        clearInterval(tokenCheckIntervalRef.current);
        tokenCheckIntervalRef.current = null;
      }
    };
  }, [driveAccessToken]);

  const calcCusto = (p) => {
    if (!p.receita || !p.receita.length) return 0;
    const custoTotal = (p.receita || []).reduce((t, it) => {
      const ing = ingredientes.find(i => i.id === it.ingredienteId);
      if (!ing) return t;
      
      let q = it.quantidade;
      const unidadeReceita = it.unidade || ing.unidade;
      
      if (ing.unidade === 'kg' && unidadeReceita === 'g') q = it.quantidade / 1000;
      if (ing.unidade === 'L' && unidadeReceita === 'ml') q = it.quantidade / 1000;
      if (ing.unidade === 'g' && unidadeReceita === 'kg') q = it.quantidade * 1000;
      if (ing.unidade === 'ml' && unidadeReceita === 'L') q = it.quantidade * 1000;
      if (unidadeReceita === ing.unidade) q = it.quantidade;

      const custoBase = ing.custoUnitario;
      const percentagemDesperdicio = getPercentagemDesperdicio(ing);
      const custoComDesperdicio = custoBase * (1 + percentagemDesperdicio / 100);
      
      return t + (q * custoComDesperdicio);
    }, 0);

    if (p.porcoes && p.porcoes > 1) {
      return custoTotal / p.porcoes;
    }
    
    return custoTotal;
  };

  const calcMargem = (p) => {
    const c = calcCusto(p);
    const ps = p.precoVenda / (1 + p.iva / 100);
    const m = ps - c;
    const mp = ps > 0 ? (m / ps) * 100 : 0;  // ‚úÖ MARGEM BRUTA (margem / pre√ßo)
    return { custo: c, margem: m, margemPercentual: mp, precoSemIva: ps };
  };

  const calcPrecoSugerido = (produto) => {
    const custo = calcCusto(produto);
    if (custo === 0 || !produto.receita || produto.receita.length === 0) return null;

    const vendasProduto = vendas.filter(v => v.produtoId === produto.id || v.produto === produto.nome);

    let margemMediaPraticada = null;
    const treintaDiasAtras = new Date();
    treintaDiasAtras.setDate(treintaDiasAtras.getDate() - 30);
    
    const vendasRecentes = vendasProduto.filter(v => new Date(v.data) >= treintaDiasAtras);
    
    if (vendasRecentes.length >= 5) { // M√≠nimo de 5 vendas para considerar hist√≥rico
      const margensHistoricas = vendasRecentes.map(v => {
        const precoVenda = v.valor / v.quantidade;
        const precoSemIva = precoVenda / (1 + produto.iva / 100);
        const margemPerc = ((precoSemIva - custo) / precoSemIva) * 100;
        return margemPerc;
      }).filter(m => m > 0 && m < 100); // Filtrar valores v√°lidos
      
      if (margensHistoricas.length > 0) {
        margemMediaPraticada = margensHistoricas.reduce((a, b) => a + b, 0) / margensHistoricas.length;
      }
    }

    let margemAlvo;
    const margemMinima = configuracoes?.alertas?.margemCritica || 55;
    const margemBoa = configuracoes?.alertas?.margemBaixa || 70;
    
    if (margemMediaPraticada !== null && margemMediaPraticada >= margemMinima) {

      margemAlvo = margemMediaPraticada;
    } else {

      switch(produto.categoria) {
        case 'cafes':
          margemAlvo = 85; // Caf√©s t√™m margem alta
          break;
        case 'bebidas':
          margemAlvo = 75; // Bebidas t√™m boa margem
          break;
        case 'sobremesas':
          margemAlvo = 70; // Sobremesas margem razo√°vel
          break;
        case 'pratos':
          margemAlvo = 65; // Pratos margem mais baixa (mais custo)
          break;
        case 'takeaway':
          margemAlvo = 60; // Take-away com custos de embalagem
          break;
        default:
          margemAlvo = margemBoa; // Margem padr√£o configurada
      }
    }

    const precoSemIvaSugerido = custo / (1 - margemAlvo / 100);
    const precoComIvaSugerido = precoSemIvaSugerido * (1 + produto.iva / 100);

    const precoArredondado = Math.ceil(precoComIvaSugerido * 2) / 2;

    const precoFinalSemIva = precoArredondado / (1 + produto.iva / 100);
    const margemFinal = ((precoFinalSemIva - custo) / precoFinalSemIva) * 100;

    const diferencaPercentual = ((precoArredondado - produto.precoVenda) / produto.precoVenda) * 100;
    const diferenciSignificativa = Math.abs(diferencaPercentual) > 5;
    
    return {
      precoSugerido: precoArredondado,
      margemAlvo: margemAlvo,
      margemReal: margemFinal,
      precoAtual: produto.precoVenda,
      diferencaPreco: precoArredondado - produto.precoVenda,
      diferencaPercentual: diferencaPercentual,
      baseadoEmHistorico: margemMediaPraticada !== null,
      numeroVendas: vendasRecentes.length,
      diferenciSignificativa: diferenciSignificativa
    };
  };

  const calcPrecosPorModalidade = (produto) => {
    const custoIngredientes = calcCusto(produto);
    const ivaPerc = produto.iva || 6; // Default 6% se n√£o definido

    const custoEmbalagens = (produto.receita || []).reduce((sum, item) => {
      const ing = ingredientes.find(i => i.id == item.ingredienteId);
      if (ing && ing.categoria === 'embalagens') {
        return sum + (ing.custoUnitario * (item.quantidade || 1));
      }
      return sum;
    }, 0);
    
    const precoLocal = produto.precoVenda || 0;
    const custoLocal = custoIngredientes - custoEmbalagens; // Custo sem embalagens
    const margemLocal = precoLocal / (1 + ivaPerc / 100) - custoLocal;
    
    const custoTakeAway = custoIngredientes; // J√° inclui embalagens
    const precoTakeAway = produto.precoVenda; // Usar pre√ßo do produto
    const margemTakeAway = precoTakeAway / (1 + ivaPerc / 100) - custoTakeAway;
    
    const resultados = {
      local: {
        custo: custoLocal,
        preco: precoLocal,
        margem: margemLocal,
        margemPerc: custoLocal > 0 ? (margemLocal / custoLocal) * 100 : 0
      },
      takeaway: {
        custo: custoTakeAway,
        custoEmbalagens,
        preco: precoTakeAway,
        margem: margemTakeAway,
        margemPerc: custoTakeAway > 0 ? (margemTakeAway / custoTakeAway) * 100 : 0
      },
      delivery: {}
    };

    deliveryApps.filter(app => app.ativo).forEach(app => {
      const precoDelivery = produto.precosDelivery?.[app.id] || precoTakeAway / (1 - app.comissao / 100);
      const receitaLiquida = precoDelivery * (1 - app.comissao / 100);
      const margemDelivery = receitaLiquida / (1 + ivaPerc / 100) - custoTakeAway;
      
      resultados.delivery[app.id] = {
        custo: custoTakeAway,
        precoSugerido: precoDelivery,
        precoDefinido: produto.precosDelivery?.[app.id] || null,
        comissao: app.comissao,
        receitaLiquida,
        margem: margemDelivery,
        margemPerc: custoTakeAway > 0 ? (margemDelivery / custoTakeAway) * 100 : 0
      };
    });
    
    return resultados;
  };

  const calcLucroVenda = (v) => {

    const p = produtos.find(pr => pr.id === v.produtoId) || produtos.find(pr => pr.nome.toLowerCase() === v.produto.toLowerCase());
    if (!p) return { lucro: 0, temCusto: false };

    const temReceita = p.receita && p.receita.length > 0;

    if (!temReceita) {
      return { lucro: 0, temCusto: false };
    }
    
    const custo = calcCusto(p);
    const precoSemIva = v.valor / (1 + (v.iva / 100)); // v.valor j√° √© total (pre√ßo √ó quantidade)
    const custoTotal = custo * v.quantidade;
    const lucro = precoSemIva - custoTotal;
    return { lucro: lucro, temCusto: true };
  };

  const calcularBoloExterno = (produtoBase, peso) => {

    if (!produtoBase || !produtoBase.receita || !peso) {

      return null;
    }
    
    const receitaBase = produtoBase.receita;
    const servingsBase = produtoBase.servings || 12; // 12 fatias = 1 bolo

    const pesoBaseBolo = servingsBase * 0.166; // kg

    const escala = peso / pesoBaseBolo;

    const ingredientesEscalados = receitaBase.map(item => {

      const ingredienteId = item.ingredienteId || item.ingrediente;
      const ing = ingredientes.find(i => i.id === ingredienteId);

      const quantidadeReceita = item.quantidade; // em g ou ml (da receita)
      const unidadeReceita = item.unidade || 'g'; // unidade da receita
      const quantidade = quantidadeReceita * escala; // quantidade escalada (ainda em g/ml)

      const unidadeIngrediente = ing ? ing.unidade : 'kg';
      const custoUnitario = ing ? (ing.custoUnitario || ing.precoPorUnidade || 0) : 0;

      return {
        ingrediente: ing ? ing.nome : ingredienteId,
        ingredienteId: ingredienteId,
        quantidade: quantidade, // quantidade escalada (em g/ml da receita)
        unidadeReceita: unidadeReceita, // unidade da receita (g/ml)
        unidadeIngrediente: unidadeIngrediente, // unidade do custo (kg/L)
        precoPorUnidade: custoUnitario
      };
    });

    const custoTotal = ingredientesEscalados.reduce((sum, item) => {

      let quantidadeFinal = item.quantidade;
      let unidadeFinal = item.unidadeIngrediente;

      if (item.unidadeReceita === 'g' && item.unidadeIngrediente === 'kg') {
        quantidadeFinal = quantidadeFinal / 1000; // g ‚Üí kg

      } else if (item.unidadeReceita === 'ml' && item.unidadeIngrediente === 'L') {
        quantidadeFinal = quantidadeFinal / 1000; // ml ‚Üí L

      } else if (item.unidadeReceita === 'kg' && item.unidadeIngrediente === 'kg') {

      } else if (item.unidadeReceita === 'L' && item.unidadeIngrediente === 'L') {

      } else if (item.unidadeReceita === 'un' && item.unidadeIngrediente === 'un') {

      } else {

        console.warn('‚ö†Ô∏è Unidades incompat√≠veis:', item.ingrediente, '-', item.unidadeReceita, 'vs', item.unidadeIngrediente);
      }
      
      const custoItem = quantidadeFinal * (item.precoPorUnidade || 0);

      return sum + custoItem;
    }, 0);

    return {
      escala: escala,
      ingredientes: ingredientesEscalados,
      custoTotal: custoTotal
    };
  };

  const lerEventosCalendar = async (calendarId = 'primary') => {
    if (!driveAccessToken) {

      return [];
    }
    
    try {
      const now = new Date();
      const diasAtras = calendarConfig.diasPassados || 7;
      const diasFuturo = calendarConfig.diasFuturos || 2;
      
      const dataInicio = new Date(now.getTime() - diasAtras * 24 * 60 * 60 * 1000);
      const dataFim = new Date(now.getTime() + diasFuturo * 24 * 60 * 60 * 1000);

      const response = await fetch(
        `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?` +
        `timeMin=${dataInicio.toISOString()}&` +
        `timeMax=${dataFim.toISOString()}&` +
        `singleEvents=true&` +
        `orderBy=startTime`,
        {
          headers: {
            'Authorization': `Bearer ${driveAccessToken}`
          }
        }
      );
      
      if (!response.ok) {
        throw new Error(`Erro ao ler calendar: ${response.status}`);
      }
      
      const data = await response.json();

      return data.items || [];
    } catch (error) {
      console.error('‚ùå ERRO ao ler calendar:', error);
      console.error('‚ùå Mensagem:', error.message);
      return [];
    }
  };

  const parseEventoBolo = (evento) => {

    const titulo = evento.summary || '';
    const descricao = evento.description || '';
    const textoCompleto = `${titulo} ${descricao}`.toLowerCase();

    const bolosDisponiveis = produtos.filter(p => 
      p.categoria && p.categoria.toLowerCase() === 'sobremesas'

    );

    let tipoBolo = null;
    let melhorScore = 0;
    
    for (const bolo of bolosDisponiveis) {
      const nomeBolo = bolo.nome.toLowerCase();

      const palavrasChave = nomeBolo.split(' ').filter(p => p.length > 3);

      let score = 0;
      const matchedWords = [];
      for (const palavra of palavrasChave) {
        if (textoCompleto.includes(palavra.toLowerCase())) {
          score++;
          matchedWords.push(palavra);
        }
      }

      if (score > melhorScore) {
        melhorScore = score;
        tipoBolo = bolo;

      }
    }
    
    if (!tipoBolo) {

    } else {

    }

    const regexPeso = /(\d+\.?\d*)\s*k(?:g)?/i;
    const matchPeso = textoCompleto.match(regexPeso);
    const peso = matchPeso ? parseFloat(matchPeso[1]) : null;

    const regexPreco = /(?:‚Ç¨|euros?|eur)\s*(\d+(?:[.,]\d{1,2})?)|(\d+(?:[.,]\d{1,2})?)\s*(?:‚Ç¨|euros?|eur)/i;
    const matchPreco = textoCompleto.match(regexPreco);
    const preco = matchPreco ? parseFloat((matchPreco[1] || matchPreco[2]).replace(',', '.')) : null;

    const regexCliente = /(?:-|para)\s*([A-Za-z√Ä-√ø\s]+?)(?:\s*‚Ç¨|\s*\d+kg|$)/i;
    const matchCliente = titulo.match(regexCliente);
    const cliente = matchCliente ? matchCliente[1].trim() : '';

    const dataEntrega = evento.start?.dateTime || evento.start?.date || '';

    const resultado = {
      eventoId: evento.id,
      tipoBolo: tipoBolo,
      peso: peso,
      preco: preco,
      cliente: cliente,
      dataEntrega: dataEntrega,
      titulo: titulo,
      descricao: descricao,
      parseOk: !!(tipoBolo && peso), // precisa pelo menos tipo e peso
      avisoReceita: tipoBolo && (!tipoBolo.receita || tipoBolo.receita.length === 0) ? '‚ö†Ô∏è Produto sem receita - n√£o ser√° poss√≠vel calcular custo' : null
    };

    if (resultado.avisoReceita) {
      console.warn(resultado.avisoReceita);
    }
    return resultado;
  };

  const buscarBolosAgendados = async () => {

    try {
      const eventos = await lerEventosCalendar(calendarConfig.calendarId);

      const bolosRegistados = await db.bolosExternos.toArray();

      const eventosJaRegistados = new Set(
        bolosRegistados
          .filter(b => b.eventoCalendarId)
          .map(b => b.eventoCalendarId)
      );

      const bolosParsed = eventos
        .map(ev => {
          const parsed = parseEventoBolo(ev);

          return parsed;
        })
        .filter(b => {
          const temBolo = !!b.tipoBolo;
          
          return temBolo;
        })
        .filter(b => {
          const jaRegistado = eventosJaRegistados.has(b.eventoId);
          
          return !jaRegistado;
        })
        .map(b => ({
          ...b,
          processado: eventosJaRegistados.has(b.eventoId)
        }));

      setBolosAgendados(bolosParsed);
      setCalendarConfig({...calendarConfig, ultimaVerificacao: new Date()});

      if (bolosParsed.length > 0 && !mostrarNotificacaoBolo) {
        const pendente = bolosParsed.find(b => !b.processado);
        if (pendente) {

          setBoloAtualNotificacao(pendente);
          setMostrarNotificacaoBolo(true);
        }
      }

      return bolosParsed;
    } catch (error) {
      console.error('‚ùå Erro ao buscar bolos:', error);
      return [];
    }
  };

  const CATEGORIAS_PRODUTOS = {
    'cafes': { nome: '‚òï Caf√©s', cor: 'amber', emoji: '‚òï' },
    'bebidas': { nome: 'ü•§ Bebidas', cor: 'blue', emoji: 'ü•§' },
    'pratos': { nome: 'üçΩÔ∏è Pratos', cor: 'orange', emoji: 'üçΩÔ∏è' },
    'sobremesas': { nome: 'üç∞ Sobremesas', cor: 'pink', emoji: 'üç∞' },
    'takeaway': { nome: 'üì¶ Take Away', cor: 'purple', emoji: 'üì¶' },
    'outros': { nome: 'üìã Outros', cor: 'gray', emoji: 'üìã' }
  };

  const getFilteredData = (data, dateField = 'data') => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    return data.filter(item => {
      const itemDate = new Date(item[dateField]);
      
      switch(dateFilter) {
        case 'today':
          return itemDate >= today;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          return itemDate >= weekAgo;
        case 'month':
          const monthAgo = new Date(today);
          monthAgo.setMonth(monthAgo.getMonth() - 1);
          return itemDate >= monthAgo;
        case 'year':

          const yearStart = new Date(now.getFullYear(), 0, 1);
          return itemDate >= yearStart;
        case 'lastYear':

          const lastYearStart = new Date(now.getFullYear() - 1, 0, 1);
          const lastYearEnd = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59);
          return itemDate >= lastYearStart && itemDate <= lastYearEnd;
        case 'custom':
          if (customStartDate && customEndDate) {
            const start = new Date(customStartDate);
            const end = new Date(customEndDate);
            end.setHours(23, 59, 59);
            return itemDate >= start && itemDate <= end;
          }
          return true;
        default:
          return true;
      }
    });
  };

  const getExportFilteredData = (data, dateField = 'data') => {
    if (!exportDateStart && !exportDateEnd) {
      return data;
    }
    
    return data.filter(item => {
      const itemDate = item[dateField];
      if (!itemDate) return false;
      
      if (exportDateStart && itemDate < exportDateStart) return false;
      if (exportDateEnd && itemDate > exportDateEnd) return false;
      
      return true;
    });
  };

  const filteredVendas = getFilteredData(vendas);
  const filteredDespesas = getFilteredData(despesas);
  const filteredFaturas = getFilteredData(faturas);

  const filteredFaturasComConfig = filteredFaturas.filter(f => {
    const tipo = f.tipo;
    if (tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
    if (tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
    if (tipo === 'FS') return configuracoes.metricas?.incluirFS !== false;
    return true; // Incluir tipos desconhecidos por seguran√ßa
  });

  const faturasComoDespesas = filteredFaturasComConfig.flatMap(f => {

    if (f.categoria === 'compras' && f.itens && f.itens.length > 0) {

      return f.itens.map(item => {
        const ingrediente = item.ingredienteId ? ingredientes.find(i => i.id === item.ingredienteId) : null;

        let categoriaDespesa = 'compras_alimentares'; // default
        
        if (ingrediente) {
          if (['limpeza', 'operacionais'].includes(ingrediente.categoria)) {
            categoriaDespesa = 'materiais_operacionais';
          } else if (ingrediente.categoria === 'embalagens') {
            categoriaDespesa = 'embalagens_consumiveis';
          }
        }

        const valorItem = item.subtotal * (1 + item.iva / 100);
        
        return {
          id: `${f.id}_${item.id}`,
          data: f.data,
          descricao: item.descricao || item.ingredienteNome || `Item ${item.id}`,
          valor: valorItem,
          iva: item.subtotal * item.iva / 100,
          ivaPercentagem: item.iva,
          categoria: categoriaDespesa,
          tipo: f.tipo || 'FT',
          fornecedor: f.fornecedorNome || '',
          ingredienteId: item.ingredienteId || null,
          origem: 'fatura',
          paraContabilista: f.paraContabilista
        };
      });
    }

    return [{
      id: f.id,
      data: f.data,
      descricao: `Fatura ${f.numero || f.id}`,
      valor: f.totais?.total || f.total || 0,
      iva: f.totalIva || 0,
      ivaPercentagem: f.itens?.[0]?.iva || 23,
      categoria: f.categoria || 'outros',
      tipo: f.tipo || 'FT',
      fornecedor: f.fornecedorNome || '',
      origem: 'fatura',
      paraContabilista: f.paraContabilista
    }];
  });

  const todasDespesas = [...filteredDespesas, ...faturasComoDespesas];

  let totV = 0;
  let vendasFiltradas = filteredVendas;

  vendasFiltradas = filteredVendas.filter(v => {
    const origem = v.origem || 'manual';
    
    if (origem === 'moloni') return configuracoes.metricas?.incluirMoloni !== false;
    if (origem === 'zobaze') return configuracoes.metricas?.incluirZobaze !== false;
    if (origem === 'manual' || v.tipo === 'manual') return configuracoes.metricas?.incluirManual !== false;

    return true;
  });
  
  totV = vendasFiltradas.reduce((s, v) => s + (v.total || v.valor || 0), 0);
  
  const tagsAtivas = [];
  if (configuracoes.metricas?.incluirMoloni !== false) tagsAtivas.push('MOLONI');
  if (configuracoes.metricas?.incluirZobaze !== false) tagsAtivas.push('ZOBAZE');
  if (configuracoes.metricas?.incluirManual !== false) tagsAtivas.push('MANUAL');

  let totD = 0;

  let faturasExcluidas = [];
  
  todasDespesas.forEach((despesa, idx) => {
    const valor = despesa.valor || 0;
    const tipo = despesa.tipo; // S√≥ faturas t√™m tipo
    const origem = despesa.origem; // 'fatura' ou undefined (manual)

    if (origem === 'fatura') {
      let incluir = false;
      
      if (tipo === 'FT' && configuracoes.metricas?.incluirFT !== false) incluir = true;
      if (tipo === 'FR' && configuracoes.metricas?.incluirFR !== false) incluir = true;
      if (tipo === 'FS' && configuracoes.metricas?.incluirFS !== false) incluir = true;

      if (!tipo || (tipo !== 'FT' && tipo !== 'FR' && tipo !== 'FS')) {
        incluir = true;
      }
      
      if (incluir) {
        totD += valor;

      } else {
        faturasExcluidas.push({
          id: despesa.id,
          descricao: despesa.descricao,
          valor: valor,
          tipo: tipo || 'SEM_TIPO',
          categoria: despesa.categoria
        });

      }
    } else {

      totD += valor;

    }
  });
  
  const tagsDespesasAtivas = [];
  if (configuracoes.metricas?.incluirFT !== false) tagsDespesasAtivas.push('FT');
  if (configuracoes.metricas?.incluirFR !== false) tagsDespesasAtivas.push('FR');
  if (configuracoes.metricas?.incluirFS !== false) tagsDespesasAtivas.push('FS');

  if (faturasExcluidas.length > 0) {
    console.warn('‚ö†Ô∏è FATURAS EXCLU√çDAS:', faturasExcluidas.length);
    console.table(faturasExcluidas);
    const totalExcluido = faturasExcluidas.reduce((s, f) => s + f.valor, 0);

  }
  
  const totalTodasDespesas = todasDespesas.reduce((s, d) => s + d.valor, 0);

  const comprasPeriodo = filteredFaturasComConfig.filter(f => {
    const cat = f.categoria;

    return cat === 'compras';
  });

  if (filteredFaturasComConfig.length > 0) {
    const categoriasFaturas = {};
    const faturaSemCategoria = [];
    filteredFaturasComConfig.forEach(f => {
      const cat = f.categoria || 'SEM_CATEGORIA';
      categoriasFaturas[cat] = (categoriasFaturas[cat] || 0) + 1;
      if (!f.categoria) {
        faturaSemCategoria.push({
          numero: f.numero || f.id,
          fornecedor: f.fornecedorNome,
          valor: f.totais?.total || f.total || 0
        });
      }
    });

    if (faturaSemCategoria.length > 0) {
      console.warn('‚ö†Ô∏è ATEN√á√ÉO: ' + faturaSemCategoria.length + ' faturas SEM CATEGORIA (sendo ignoradas no Food Cost)');
      console.table(faturaSemCategoria);

    }
  }

  const indiceDesperdicio = calcularIndiceDesperdicio(comprasPeriodo, vendasFiltradas, produtos);

  const anoAtual = new Date().getFullYear();

  const now = new Date();
  const currentMonth = now.getMonth() + 1; // 1-12
  const currentYear = now.getFullYear();
  
  let quarter, quarterStart, quarterEnd;
  if (currentMonth >= 1 && currentMonth <= 3) {
    quarter = 1;
    quarterStart = new Date(currentYear, 0, 1);
    quarterEnd = new Date(currentYear, 2, 31);
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    quarter = 2;
    quarterStart = new Date(currentYear, 3, 1);
    quarterEnd = new Date(currentYear, 5, 30);
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    quarter = 3;
    quarterStart = new Date(currentYear, 6, 1);
    quarterEnd = new Date(currentYear, 8, 30);
  } else {
    quarter = 4;
    quarterStart = new Date(currentYear, 9, 1);
    quarterEnd = new Date(currentYear, 11, 31);
  }

  const vendasAnoAtual = vendas.filter(v => {
    const dataVenda = new Date(v.data);
    return dataVenda >= quarterStart && dataVenda <= quarterEnd;
  });
  const totalVendasAnoAtual = vendasAnoAtual.reduce((s, v) => s + (v.total || v.valor || 0), 0);

  const faturasAnoAtual = faturas.filter(f => {
    const dataFatura = new Date(f.data);
    return dataFatura >= quarterStart && dataFatura <= quarterEnd;
  });

  const vendasAnoFiltradas = vendasAnoAtual.filter(v => {
    const origem = v.origem || 'manual';
    if (origem === 'moloni') return configuracoes.metricas?.incluirMoloni !== false;
    if (origem === 'zobaze') return configuracoes.metricas?.incluirZobaze !== false;
    if (origem === 'manual' || v.tipo === 'manual') return configuracoes.metricas?.incluirManual !== false;
    return true;
  });
  const ivaV = vendasAnoFiltradas.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);

  const ivaComprasFaturas = faturasAnoAtual
    .filter(f => {

      if (f.tipo === 'FS') return false;

      if (f.tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
      if (f.tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
      return true; // Incluir tipos desconhecidos por seguran√ßa
    })
    .reduce((s, f) => s + (f.totalIva || 0), 0);

  const despesasComIvaAnoAtual = despesas.filter(d => {
    const dataDespesa = new Date(d.data);
    return dataDespesa >= quarterStart && dataDespesa <= quarterEnd && d.iva && d.iva > 0;
  });
  
  const ivaComprasDespesas = despesasComIvaAnoAtual
    .reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      const ivaValor = d.valor - valorSemIva;
      return s + ivaValor;
    }, 0);

  const ivaCompras = ivaComprasFaturas + ivaComprasDespesas;

  const ivaP = ivaV - ivaCompras;

  const calcularIVATrimestre = (ano, trimestre) => {
    let qStart, qEnd;
    if (trimestre === 1) {
      qStart = new Date(ano, 0, 1);
      qEnd = new Date(ano, 2, 31);
    } else if (trimestre === 2) {
      qStart = new Date(ano, 3, 1);
      qEnd = new Date(ano, 5, 30);
    } else if (trimestre === 3) {
      qStart = new Date(ano, 6, 1);
      qEnd = new Date(ano, 8, 30);
    } else {
      qStart = new Date(ano, 9, 1);
      qEnd = new Date(ano, 11, 31);
    }

    const vendasQ = vendas.filter(v => {
      const dataVenda = new Date(v.data);
      return dataVenda >= qStart && dataVenda <= qEnd;
    }).filter(v => {
      const origem = v.origem || 'manual';
      if (origem === 'moloni') return configuracoes.metricas?.incluirMoloni !== false;
      if (origem === 'zobaze') return configuracoes.metricas?.incluirZobaze !== false;
      if (origem === 'manual' || v.tipo === 'manual') return configuracoes.metricas?.incluirManual !== false;
      return true;
    });
    
    const ivaVendasQ = vendasQ.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);

    const faturasQ = faturas.filter(f => {
      const dataFatura = new Date(f.data);
      return dataFatura >= qStart && dataFatura <= qEnd;
    }).filter(f => {
      if (f.tipo === 'FS') return false;
      if (f.tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
      if (f.tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
      return true;
    });
    
    const ivaFaturasQ = faturasQ.reduce((s, f) => s + (f.totalIva || 0), 0);

    const despesasQ = despesas.filter(d => {
      const dataDespesa = new Date(d.data);
      return dataDespesa >= qStart && dataDespesa <= qEnd && d.iva && d.iva > 0;
    });
    
    const ivaDespesasQ = despesasQ.reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      const ivaValor = d.valor - valorSemIva;
      return s + ivaValor;
    }, 0);
    
    const ivaComprasQ = ivaFaturasQ + ivaDespesasQ;
    const ivaPagarQ = ivaVendasQ - ivaComprasQ;
    
    return {
      trimestre,
      ano,
      ivaVendas: ivaVendasQ,
      ivaCompras: ivaComprasQ,
      ivaPagar: ivaPagarQ,
      tipo: ivaPagarQ >= 0 ? 'pagar' : 'receber'
    };
  };

  const anoAnterior = currentYear - 1;
  const historicoAnoAnterior = [1, 2, 3, 4].map(q => calcularIVATrimestre(anoAnterior, q));
  
  const ratioDespesaFaturacao = totV > 0 ? (totD / totV) * 100 : 0;

  let lucroReal = 0;
  let vComC = 0;
  vendasFiltradas.forEach(v => { 
    const { lucro, temCusto } = calcLucroVenda(v); 
    lucroReal += lucro; 
    if (temCusto) vComC++; 
  });

  const vPorDia = {};
  vendasFiltradas.forEach(v => {
    if (!vPorDia[v.data]) vPorDia[v.data] = { total: 0, lucro: 0, qtd: 0 };
    vPorDia[v.data].total += v.valor;
    vPorDia[v.data].qtd += v.quantidade;
    vPorDia[v.data].lucro += calcLucroVenda(v).lucro;
  });

  const dias = Object.keys(vPorDia).length;
  const medFat = dias > 0 ? totV / dias : 0;
  const medLuc = dias > 0 ? lucroReal / dias : 0;

  const ivaVendasPeriodo = vendasFiltradas.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);

  const ivaFaturasPeriodo = filteredFaturasComConfig
    .filter(f => {

      if (f.tipo === 'FS') return false;

      if (f.tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
      if (f.tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
      return true; // Incluir tipos desconhecidos por seguran√ßa
    })
    .reduce((s, f) => s + (f.totalIva || 0), 0);

  const ivaDespesasPeriodo = filteredDespesas
    .filter(d => d.iva && d.iva > 0) // Incluir todas as despesas com IVA > 0
    .reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      const valorIva = d.valor - valorSemIva;
      return s + valorIva;
    }, 0);
  
  const ivaPagarPeriodo = ivaVendasPeriodo - (ivaFaturasPeriodo + ivaDespesasPeriodo);

  const dFixas = todasDespesas
    .filter(d => ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria))
    .filter(d => {

      if (d.origem === 'fatura') {
        const tipo = d.tipo;
        if (tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
        if (tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
        if (tipo === 'FS') return configuracoes.metricas?.incluirFS !== false;
        return true;
      }
      return true; // Despesas manuais sempre incluir
    })
    .reduce((s, d) => s + d.valor, 0);
  const dFixDia = dFixas / 30;

  const totalSalarios = todasDespesas.filter(d => d.categoria === 'salarios').reduce((s, d) => {
    const multiplicador = d.frequencia_pagamento === 'semanal' ? 4 :
                         d.frequencia_pagamento === 'quinzenal' ? 2 : 1;
    return s + (d.valor * multiplicador);
  }, 0);
  const laborCostPercentage = totV > 0 ? (totalSalarios / totV) * 100 : 0;

  let custoRealVendas = 0;
  vendasFiltradas.forEach(venda => {

    if (venda.itens && venda.itens.length > 0) {
      venda.itens.forEach(item => {
        const produto = produtos.find(p => p.id === item.produtoId);
        if (produto && produto.custoReceita && produto.custoReceita > 0) {

          const custo = produto.custoReceita;
          const qtd = item.quantidade || 1;

          if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
            const custoItem = custo * qtd;

            if (custoItem < 5000) {
              custoRealVendas += custoItem;
            }
          }
        }
      });
    } else if (venda.produtoId) {
      const produto = produtos.find(p => p.id === venda.produtoId);
      if (produto && produto.custoReceita && produto.custoReceita > 0) {

        const custo = produto.custoReceita;
        const qtd = venda.quantidade || 1;

        if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
          const custoItem = custo * qtd;

          if (custoItem < 5000) {
            custoRealVendas += custoItem;
          }
        }
      }
    }
  });
  
  const foodCostPercentage = totV > 0 ? (custoRealVendas / totV) * 100 : 0;
  const primeCostPercentage = foodCostPercentage + laborCostPercentage;
  const primeCostTotal = custoRealVendas + totalSalarios;

  const faturacaoSemIva = totV - ivaVendasPeriodo;

  const margemBruta = faturacaoSemIva - custoRealVendas;
  const margemBrutaPercentage = totV > 0 ? (margemBruta / totV) * 100 : 0;

  const ivaTotalDespesas = ivaFaturasPeriodo + ivaDespesasPeriodo;
  const despesasSemIva = totD - ivaTotalDespesas;

  const lucroLiquido = margemBruta - despesasSemIva;
  const margemLiquida = totV > 0 ? (lucroLiquido / totV) * 100 : 0;

  if (foodCostPercentage > 100 || foodCostPercentage < 0) {
    console.error('üö® FOOD COST ANORMAL DETECTADO!');
    console.table({
      'Food Cost %': foodCostPercentage.toFixed(2) + '%',
      'Custo Real Vendas': '‚Ç¨' + custoRealVendas.toFixed(2),
      'Total Vendas': '‚Ç¨' + totV.toFixed(2),
      'Vendas Analisadas': vendasFiltradas.length
    });

  }

  let diasReaisPeriodo = 26; // default
  if (vendasFiltradas.length > 0) {
    const datas = vendasFiltradas.map(v => new Date(v.data));
    const dataMin = new Date(Math.min(...datas));
    const dataMax = new Date(Math.max(...datas));
    const diffTime = Math.abs(dataMax - dataMin);
    diasReaisPeriodo = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
  }

  const fixedCosts = todasDespesas.filter(d => 
    ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria)
  ).reduce((s, d) => s + d.valor, 0);

  const variableCosts = todasDespesas.filter(d => 
    ['compras', 'consumiveis'].includes(d.categoria)
  ).reduce((s, d) => s + d.valor, 0);

  const foodCostComDesperdicio = custoRealVendas * 1.08; // +8% m√©dia de desperd√≠cio

  const custoTotalPeriodo = fixedCosts + variableCosts + foodCostComDesperdicio;

  const diasUteis = 26;

  const fixedCostsProjetados = (fixedCosts / diasReaisPeriodo) * diasUteis;
  const variableCostsProjetados = (variableCosts / diasReaisPeriodo) * diasUteis;
  const foodCostProjetado = (foodCostComDesperdicio / diasReaisPeriodo) * diasUteis;

  const contributionMarginRatio = totV > 0 ? (totV - variableCosts - foodCostComDesperdicio) / totV : 0;
  const breakEvenPoint = contributionMarginRatio > 0 ? fixedCosts / contributionMarginRatio : 0;

  const custoTotalDiario = (fixedCostsProjetados + variableCostsProjetados + foodCostProjetado) / diasUteis;
  const fixedCostsDiarios = fixedCostsProjetados / diasUteis;
  const variableCostsDiarios = variableCostsProjetados / diasUteis;
  const foodCostDiario = foodCostProjetado / diasUteis;

  const ticketMedio = filteredVendas.length > 0 ? totV / filteredVendas.length : 0;
  const foodCostPorVenda = filteredVendas.length > 0 ? custoRealVendas / filteredVendas.length : 0;
  const margemPorVenda = ticketMedio - foodCostPorVenda;
  const vendasNecessariasPorDia = margemPorVenda > 0 ? custoTotalDiario / margemPorVenda : 0;
  const breakEvenDiario = vendasNecessariasPorDia * ticketMedio;

  const faturacaoNecessariaDiaria = custoTotalDiario / (contributionMarginRatio > 0 ? contributionMarginRatio : 0.5);

  const numEmployees = todasDespesas
    .filter(d => d.categoria === 'salarios')
    .reduce((sum, d) => sum + (d.num_funcionarios || 1), 0) || 1;
  
  const revenuePerEmployee = numEmployees > 0 ? totV / numEmployees : 0;
  const salesPerEmployee = numEmployees > 0 ? filteredVendas.length / numEmployees : 0;

  const vPorProd = {};
  filteredVendas.forEach(v => {
    if (!vPorProd[v.produto]) vPorProd[v.produto] = { quantidade: 0, total: 0, lucro: 0 };
    vPorProd[v.produto].quantidade += v.quantidade;
    vPorProd[v.produto].total += v.valor;
    vPorProd[v.produto].lucro += calcLucroVenda(v).lucro;
  });

  const top5Venda = Object.entries(vPorProd).sort((a, b) => b[1].quantidade - a[1].quantidade).slice(0, 5);
  const top5Lucro = Object.entries(vPorProd).sort((a, b) => b[1].lucro - a[1].lucro).slice(0, 5);
  const pior5Venda = Object.entries(vPorProd).sort((a, b) => a[1].quantidade - b[1].quantidade).slice(0, 5);
  const pior5Lucro = Object.entries(vPorProd).sort((a, b) => a[1].lucro - b[1].lucro).slice(0, 5);

  const dadosPorMes = {};
  
  vendas.forEach(v => {
    const mes = v.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }

    dadosPorMes[mes].faturacao = Math.round((dadosPorMes[mes].faturacao + v.valor) * 100) / 100;
    dadosPorMes[mes].lucro = Math.round((dadosPorMes[mes].lucro + calcLucroVenda(v).lucro) * 100) / 100;
    dadosPorMes[mes].vendas += 1;
    dadosPorMes[mes].ivaVendas = Math.round((dadosPorMes[mes].ivaVendas + (v.valor * v.iva / (100 + v.iva))) * 100) / 100;
  });

  despesas.forEach(d => {
    const mes = d.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    dadosPorMes[mes].despesas += d.valor;
    if (d.categoria === 'salarios') {
      dadosPorMes[mes].salarios += d.valor;
    }
  });

  faturas.forEach(f => {
    const mes = f.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    dadosPorMes[mes].ivaCompras += (f.totalIva || 0);
  });

  Object.keys(dadosPorMes).forEach(mes => {
    const dados = dadosPorMes[mes];

    let custoAlimentosMes = 0;
    vendas.filter(v => v.data.startsWith(mes)).forEach(v => {

      const p = produtos.find(pr => pr.id === v.produtoId) || produtos.find(pr => pr.nome.toLowerCase() === v.produto.toLowerCase());
      if (p) {
        custoAlimentosMes += calcCusto(p) * v.quantidade;
      }
    });
    
    dados.foodCostPct = dados.faturacao > 0 ? ((custoAlimentosMes / dados.faturacao) * 100) : 0;
    dados.laborCostPct = dados.faturacao > 0 ? ((dados.salarios / dados.faturacao) * 100) : 0;
  });

  const mesesOrdenados = Object.keys(dadosPorMes).sort();
  const ultimos6Meses = mesesOrdenados.slice(-6);

  const fuzz = window.fuzzball || window.fuzz;

  const OCR_DEBUG = {
    enabled: false,
    logs: [],
    
    log(etapa, mensagem, dados = null) {
      if (!this.enabled) return;
      
      const logEntry = {
        timestamp: new Date().toISOString(),
        etapa,
        mensagem,
        dados
      };
      
      this.logs.push(logEntry);

    },
    
    clear() {
      this.logs = [];
    },
    
    exportLogs() {
      return JSON.stringify(this.logs, null, 2);
    },
    
    showSummary() {

      const etapas = {};
      
      this.logs.forEach(log => {
        if (!etapas[log.etapa]) {
          etapas[log.etapa] = [];
        }
        etapas[log.etapa].push(log);
      });
      
      Object.keys(etapas).forEach(etapa => {

        etapas[etapa].slice(0, 3).forEach(log => {

        });
      });
    }
  };
  
  window.OCR_DEBUG = OCR_DEBUG;

  const normalizeForMatching = (text) => {
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  };
  
  /**
   * Corrige erros t√≠picos de OCR (caracteres confundidos)
   * Aplica ANTES do fuzzy matching
   */
  const corrigirErrosOCR = (texto) => {
    if (!texto) return '';
    
    let corrigido = texto;

    const correcoes = {

      '0': ['O', 'o'],  // 0 confundido com O
      'O': ['0'],       // O confundido com 0
      '1': ['I', 'l'],  // 1 confundido com I ou l
      'I': ['1'],       // I confundido com 1
      '5': ['S'],       // 5 confundido com S
      'S': ['5'],       // S confundido com 5
      '8': ['B'],       // 8 confundido com B
      'B': ['8'],       // B confundido com 8

      'VATAS': ['NATAS'],           // V ‚Üí N (caso espec√≠fico)
      'ANENDOTH': ['AMENDOIM'],     // Erro comum
      'ANENDOIM': ['AMENDOIM'],
      'ANENDOIN': ['AMENDOIM'],
      'ANENDOM': ['AMENDOIM'],
      'QUEUO': ['QUEIJO'],
      'QUEJO': ['QUEIJO'],
      'LARANJA': ['LARANJA'],       // Manter correto
      'LARAN1A': ['LARANJA'],       // 1 ‚Üí J
      'LARANUA': ['LARANJA'],       // U ‚Üí J

      'CERV': ['CERVEJA'],          // Abrevia√ß√£o comum
      'CERVE1A': ['CERVEJA'],       // 1 ‚Üí J
      'CERVE]A': ['CERVEJA'],       // ] ‚Üí J
      'C/ALC': ['COM ALCOOL'],      // Expandir abrevia√ß√£o
      'S/ALC': ['SEM ALCOOL'],
      'BOCK': ['BOCK'],             // Manter
      'B0CK': ['BOCK'],             // 0 ‚Üí O
      'SUPER': ['SUPER'],           // Manter
      'SUP3R': ['SUPER'],           // 3 ‚Üí E
    };

    for (const [errado, corretos] of Object.entries(correcoes)) {
      if (errado.length > 2) { // Palavras (n√£o letras individuais)
        for (const correto of corretos) {
          const regex = new RegExp(`\\b${errado}\\b`, 'gi');
          corrigido = corrigido.replace(regex, correto);
        }
      }
    }

    corrigido = corrigido

      .replace(/\b[A-Z]{2}\d{4}:\d\b/g, '')

      .replace(/\bNo[A-Z]{2,}\b/g, '')

      .replace(/[;:]+/g, ' ')

      .replace(/\b0708\b/g, 'OVOS')
      .replace(/\b07O8\b/gi, 'OVOS')

      .replace(/\s+/g, ' ')
      .trim();
    
    return corrigido;
  };
  
  /**
   * Limpa lixo comum do OCR ANTES de processar
   * Remove caracteres repetidos, espa√ßos extras, padr√µes sem sentido
   * IMPORTANTE: S√≥ limpar padr√µes espec√≠ficos, n√£o remover linhas de produtos!
   */
  const cleanOCRText = (text) => {
    if (!text) return '';
    
    OCR_DEBUG.log('LIMPEZA', 'Texto original', { tamanho: text.length });
    
    let cleaned = text;

    const atcudRemovidos = (cleaned.match(/ATCUD:[A-Z0-9-]+/gi) || []).length;
    cleaned = cleaned.replace(/ATCUD:[A-Z0-9-]+/gi, '');
    if (atcudRemovidos > 0) {
      OCR_DEBUG.log('LIMPEZA', `${atcudRemovidos} ATCUDs removidos`);
    }

    cleaned = cleaned.replace(/\*\s*CARRO\s+No\.\s*\d*/gi, '');

    cleaned = cleaned.replace(/^Produto proveniente de.*$/gm, '');
    cleaned = cleaned.replace(/^No\. de registo.*$/gm, '');
    cleaned = cleaned.replace(/^Valido como recibo.*$/gm, '');
    cleaned = cleaned.replace(/^eGGF-Processado por programa.*$/gm, '');
    cleaned = cleaned.replace(/^GMM-Processado por programa.*$/gm, '');
    cleaned = cleaned.replace(/^AS MERCADORIAS VIAJAM.*$/gm, '');
    cleaned = cleaned.replace(/^IVA\s+Incid√™ncias.*$/gm, '');
    cleaned = cleaned.replace(/^Total Volumes.*$/gm, '');

    cleaned = cleaned.replace(/(\b\w{1,2}\b)(\s+\1){3,}/gi, '$1');

    cleaned = cleaned.replace(/ {2,}/g, ' ');  // 2+ espa√ßos ‚Üí 1 espa√ßo (S√ì espa√ßos, n√£o \n)

    cleaned = cleaned.replace(/\n\s*\n\s*\n+/g, '\n\n');
    
    OCR_DEBUG.log('LIMPEZA', 'Texto limpo', { 
      tamanho: cleaned.length,
      reduzido: text.length - cleaned.length
    });
    
    return cleaned.trim();
  };
  
  /**
   * NOVA FUN√á√ÉO: Separar produtos que est√£o colados na mesma linha
   * Mesmo SEM c√≥digos de produto, tenta separar por padr√µes
   */
  const separarProdutosColados = (linha) => {

    if (!linha || linha.length < 15) {
      OCR_DEBUG.log('SEPARACAO', 'Linha muito curta', { linha });
      return [linha];
    }

    const padraoIVA = /\([A-Z]\)\s+/g;
    const matchesIVA = [...linha.matchAll(padraoIVA)];
    
    if (matchesIVA.length >= 2) {

      OCR_DEBUG.log('SEPARACAO', `${matchesIVA.length} c√≥digos IVA detectados - SEPARANDO`, { 
        posicoes: matchesIVA.map(m => m.index),
        linha: linha.substring(0, 80) 
      });
      
      const produtos = [];
      
      for (let i = 0; i < matchesIVA.length; i++) {
        const matchAtual = matchesIVA[i];
        const proximoMatch = matchesIVA[i + 1];
        
        if (proximoMatch) {

          const fragmento = linha.substring(matchAtual.index, proximoMatch.index).trim();
          if (fragmento.length > 5) {
            produtos.push(fragmento);

          }
        } else {

          const fragmento = linha.substring(matchAtual.index).trim();
          if (fragmento.length > 5) {
            produtos.push(fragmento);

          }
        }
      }
      
      if (produtos.length > 1) {

        OCR_DEBUG.log('SEPARACAO', `Separados em ${produtos.length} produtos (IVA)`, { produtos });
        return produtos;
      }
    }

    const codigos = linha.match(/\d{6}\.\d+/g);

    if (codigos && codigos.length > 1) {

      OCR_DEBUG.log('SEPARACAO', `${codigos.length} c√≥digos detectados - SEPARANDO`, { codigos, linha: linha.substring(0, 80) });
      
      const produtos = [];
      let textoRestante = linha;
      
      for (let i = 0; i < codigos.length; i++) {
        const codigoAtual = codigos[i];
        const proximoCodigo = codigos[i + 1];
        
        const posAtual = textoRestante.indexOf(codigoAtual);
        if (posAtual === -1) {

          continue;
        }
        
        if (proximoCodigo) {

          const posProximo = textoRestante.indexOf(proximoCodigo);
          if (posProximo > posAtual) {
            const fragmento = textoRestante.substring(posAtual, posProximo).trim();
            if (fragmento.length > 5) {
              produtos.push(fragmento);

            }
            textoRestante = textoRestante.substring(posProximo);
          }
        } else {

          const fragmento = textoRestante.substring(posAtual).trim();
          if (fragmento.length > 5) {
            produtos.push(fragmento);

          }
        }
      }

      OCR_DEBUG.log('SEPARACAO', `Separados em ${produtos.length} produtos`, { produtos: produtos.map(p => p.substring(0, 40)) });
      
      return produtos.length > 0 ? produtos : [linha];
    }

    const padraoQtdNovoProduto = /(\d+(?:,\d+)?(?:ML|GR|G|KG|L|CL|UN|U|DZ))\s+([A-Z])/gi;

    let matches = [];
    let match;
    const regexGlobal = /(\d+(?:,\d+)?(?:ML|GR|G|KG|L|CL|UN|U|DZ))\s+([A-Z])/gi;
    
    while ((match = regexGlobal.exec(linha)) !== null) {
      matches.push({
        index: match.index,
        fullMatch: match[0],
        quantidade: match[1],
        letraSeguinte: match[2],
        posicaoCorte: match.index + match[1].length // Cortar DEPOIS da quantidade
      });
    }
    
    if (matches.length > 0) {

      const produtos = [];
      let ultimoCorte = 0;
      
      for (const m of matches) {

        const posicaoFimQuantidade = m.index + m.quantidade.length;
        const fragmento = linha.substring(ultimoCorte, posicaoFimQuantidade).trim();
        
        if (fragmento.length > 3) {
          produtos.push(fragmento);

        }

        ultimoCorte = posicaoFimQuantidade;

        while (ultimoCorte < linha.length && linha[ultimoCorte] === ' ') {
          ultimoCorte++;
        }
      }

      const ultimoFragmento = linha.substring(ultimoCorte).trim();
      if (ultimoFragmento.length > 3) {
        produtos.push(ultimoFragmento);

      }
      
      if (produtos.length > 1) {

        OCR_DEBUG.log('SEPARACAO', `Separados em ${produtos.length} produtos (qtd+letra)`, { produtos });
        return produtos;
      }
    }

    const padraoItem = /([A-Z][A-Z\s]+?)(\d+(?:G|ML|L|KG|UN|CL))\s*‚Ç¨?\s*(\d+[.,]\d{2})/gi;
    const matchesPreco = [...linha.matchAll(padraoItem)];
    
    if (matchesPreco && matchesPreco.length > 1) {

      OCR_DEBUG.log('SEPARACAO', `${matchesPreco.length} produtos por padr√£o qtd+pre√ßo`, { matches: matchesPreco.map(m => m[0]) });
      return matchesPreco.map(m => m[0]);
    }

    OCR_DEBUG.log('SEPARACAO', 'Nenhuma separa√ß√£o necess√°ria', { codigos: codigos ? codigos.length : 0 });
    return [linha];
  };

  const extractNativeText = async (pdfBuffer) => {
    try {
      const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
      let fullText = '';
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      return fullText.trim();
    } catch (error) {

      return '';
    }
  };

  const pdfToImages = async (pdfBuffer) => {
    const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
    const images = [];
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      images.push(canvas.toDataURL('image/png'));
    }
    return images;
  };

  const extractWithOCR = async (pdfBuffer) => {
    try {
      const images = await pdfToImages(pdfBuffer);

      let fullText = '';
      for (let i = 0; i < images.length; i++) {
        setProgressoOCR(`OCR p√°gina ${i + 1}/${images.length}...`);
        const result = await Tesseract.recognize(images[i], 'por', {
          logger: m => {
            if (m.status === 'recognizing text') {
              setProgressoOCR(`OCR ${Math.round(m.progress * 100)}%`);
            }
          }
        });
        fullText += result.data.text + '\n';
      }
      return fullText.trim();
    } catch (error) {
      throw new Error('OCR falhou: ' + error.message);
    }
  };

  const extractTextFromPdf = async (file) => {

    setProgressoOCR('Preparando OCR...');
    
    try {

      const imageData = await convertPdfToImage(file);

      setProgressoOCR('Aplicando OCR...');

      const result = await Tesseract.recognize(imageData, 'por', {
        logger: m => {
          if (m.status === 'recognizing text') {
            setProgressoOCR(`OCR ${Math.round(m.progress * 100)}%`);
          }
        }
      });

      return { text: result.data.text, method: 'ocr' };
      
    } catch (error) {
      throw new Error('Falha OCR: ' + error.message);
    }
  };

  const convertPdfToImage = async (file) => {

    const arrayBuffer = await file.arrayBuffer();

    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;

    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 2.0 }); // Scale 2.0 para melhor qualidade

    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;

    const imageDataUrl = canvas.toDataURL('image/png');
    
    return imageDataUrl;
  };

  const shouldIgnoreLine = (linha) => {

    
    const linhaLower = linha.toLowerCase().trim();

    if (linha.length < 3) {
      OCR_DEBUG.log('FILTRO', 'Linha muito curta', { linha });
      return true;
    }

    if (!/[a-zA-Z√Ä-√ø]/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Sem letras', { linha });
      return true;
    }

    if (/@/.test(linha) && /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Email detectado', { linha });
      return true;
    }

    if (/www\.|\.pt\b|\.com\b|http/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'URL detectado', { linha });
      return true;
    }

    if (/atcud\s*:/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'ATCUD detectado', { linha });
      return true;
    }

    if (/processado por programa certificado|certificado n[¬∫¬∞.\s]*\d+\/at/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Certifica√ß√£o software', { linha });
      return true;
    }

    if (/\b(nif|nipc)\s*[:.]?\s*\d/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'NIF/NIPC detectado', { linha });
      return true;
    }

    if (/\b\d{4}-\d{3}\b/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'C√≥digo postal detectado', { linha });
      return true;
    }

    if (/\b(tel|telefone|tlm|telem√≥vel)\s*[:.]?\s*[\d\s+()-]{8,}/i.test(linha) || /\b\d{3}\s?\d{3}\s?\d{3}\b/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Telefone detectado', { linha });
      return true;
    }

    if (/^(fatura\s*(simplificada|original)|factura\s*)/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Tipo de fatura', { linha });
      return true;
    }

    if (/registad[ao]|c\.?\s*r\.?\s*c\.|capital social|sede\s*:|matr[i√≠]cula/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Texto legal empresa', { linha });
      return true;
    }

    if (/(rua|r\.|avenida|av\.|pra√ßa|largo|travessa|tv\.).*\d{4}-\d{3}/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Morada completa', { linha });
      return true;
    }

    if (/^(recheio|continente|pingo\s*doce|lidl|aldi|intermarche|model[lo])/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Nome empresa (cabe√ßalho)', { linha });
      return true;
    }

    if (/^(operador|terminal|contribuinte|original|emitido por|fornecedor\s*:|produtor\s*:)/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Metadado de fatura', { linha });
      return true;
    }

    if (/^(total|subtotal|resumo|valor|poupan[√ßc]a|desconto|troco|pagamento[s]?|multibanco|num[e√©]rario)\s*[:.]?$/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Linha de total/resumo isolada', { linha });
      return true;
    }

    if (/^(volte sempre|obrigad[oa]|bom dia|boa tarde|at[√©e] breve|bem.vind[oa]|saiba mais)/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Sauda√ß√£o/fecho', { linha });
      return true;
    }

    const cabecalhosComuns = [
      'descri√ß√£o', 'descricao', 'artigo', 'artigos', 'codigo', 'c√≥digos internos', 'codigos internos',
      'quantidade', 'qtd', 'qt.total', 'qt', 'quant', 'pre√ßo', 'preco', 'pre√ßo uni', 'preco uni',
      'valor', 'total', 'totais', 'subtotal', 'iva', '%iva', 'taxa', 'incid√™ncias', 'incidencias',
      'data', 'hora', 'pag', 'obs', 'observa√ß√µes', 'observacoes', 'assinatura',
      'volume', 'volumes', 'peso total', 'carga', 'descarga', 'zona', 'cliente',
      'operador', 'oper', 'vendedor', 'vended', 'documento', 'locals', 'local',
      'contribuinte', 'v/n¬∞ contribuinte', 'transporte', 'boost', 'venema',
      'cash & carry', 'unidade', 'uni', 'vol'
    ];
    
    if (cabecalhosComuns.some(cab => linhaLower === cab || linhaLower === cab + ':' || linhaLower === cab + '.')) {
      OCR_DEBUG.log('FILTRO', 'Cabe√ßalho de tabela comum', { linha });
      return true;
    }

    if (/\bcarro\s*(no\.|n[¬∫¬∞]|number)?\s*\d+/i.test(linha) || /^\*\s*carro/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'C√≥digo de transporte/carro', { linha });
      return true;
    }

    if (/^[A-Z]\s+\d{4}\s+[A-Z]{2}$/i.test(linha) || /^atco[d]\s*:/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'C√≥digo alfanum√©rico', { linha });
      return true;
    }

    if (/^\d+\s*-\s*(cliente|operador|vended|zona|carga|descarga)/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Padr√£o n√∫mero-campo', { linha });
      return true;
    }

    if (/^(zona|oper|cliente|data|n√∫mero|numero|carga|descarga|v\/n¬∞|loja|telefone)\s*[:]/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Campo com dois pontos', { linha });
      return true;
    }

    if (/caixa\s+postal|horta\s+do\s+vale/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Nome de cliente/morada', { linha });
      return true;
    }

    if (linha.length > 60 && /mercadorias|viajam|risco|conta|comprador|disposi√ß√£o|colocadas/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Instru√ß√£o/aviso longo', { linha });
      return true;
    }

    const palavrasMetadados = ['mercadoria', 'imposto', 'incid√™ncia', 'valor', 'pre√ßo', 'iva'];
    const palavrasNaLinha = linha.toLowerCase().split(/\s+/);
    const countMetadados = palavrasNaLinha.filter(p => palavrasMetadados.includes(p)).length;
    if (countMetadados >= 2) {
      OCR_DEBUG.log('FILTRO', 'Frase com m√∫ltiplos metadados', { linha });
      return true;
    }

    if (/\b(fs|fr|ft|nc|nd)\s*\d{8}\/\d{10}/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'N√∫mero de fatura detectado', { linha });
      return true;
    }

    if (/\b\d{4}[-\/]\d{2}[-\/]\d{2}\b/.test(linha) || /\b\d{2}[-\/]\d{2}[-\/]\d{4}\b/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Data detectada', { linha });
      return true;
    }

    if (/\b\d{2}:\d{2}(:\d{2})?\b/.test(linha) && !/\d+[.,]\d+/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Hora detectada', { linha });
      return true;
    }

    if (/\b\d+[a¬™]\.?\s*via\b/i.test(linha) || /\b(original|duplicado|triplicado|c√≥pia|copia)\b/i.test(linhaLower)) {
      OCR_DEBUG.log('FILTRO', 'Via de documento', { linha });
      return true;
    }

    if (/\d{4}\s*\*\s*\d{4}-\d{2}-\d{2}\s*\*\s*\d{2}:\d{2}\s*\*\s*(fs|fr|ft)/i.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Cabe√ßalho de fatura com asteriscos', { linha });
      return true;
    }

    if (/^\d{4}\s*\*/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'C√≥digo inicial com asterisco', { linha });
      return true;
    }

    OCR_DEBUG.log('FILTRO', '‚úì Linha aceite', { linha });
    return false;
  };

  const extractQuantidadeUnidade = (texto) => {
    OCR_DEBUG.log('EXTRACAO', 'Extraindo qtd/unidade', { texto });

    const patterns = [

      /(\d+)\s+(\d+)\s+(\d+[.,]\d{3})/g,  // Ex: "1 1 1,000" ‚Üí quantidade=1000

      /(\d+[.,]?\d*)\s*(kg|quilos?|kilos?)/gi,
      /(\d+[.,]?\d*)\s*(g|gramas?)/gi,
      /(\d+[.,]?\d*)\s*l\b/gi,  // l isolado (litros)
      /(\d+[.,]?\d*)\s*(ml|mililitros?)/gi,
      /(\d+[.,]?\d*)\s*(cl|centilitros?)/gi,  // Centilitros (cerveja, etc)
      /(\d+[.,]?\d*)\s*(un|unid|unidade|pc|p√ß|pe√ßa|cx|caixa|emb|embalagem|dz|duzia|d√∫zia)/gi,

      /(\d+[.,]\d{3})\b/g,  // 3 d√≠gitos ap√≥s v√≠rgula/ponto
    ];
    
    for (const pattern of patterns) {
      const match = texto.match(pattern);
      if (match && match[0]) {
        const full = match[0];

        const recheioMatch = full.match(/(\d+)\s+(\d+)\s+(\d+[.,]\d{3})/);
        if (recheioMatch) {
          const qtd = parseFloat(recheioMatch[3].replace(',', '.'));

          let unidade = 'un';  // Default
          if (/kg/i.test(texto)) unidade = 'kg';
          else if (/\bg\b/i.test(texto)) unidade = 'g';
          else if (/ml/i.test(texto)) unidade = 'ml';
          else if (/\bl\b/i.test(texto)) unidade = 'L';
          
          OCR_DEBUG.log('EXTRACAO', 'Qtd/Un extra√≠da (recheio)', { qtd, unidade, match: full });
          return { quantidade: qtd, unidade, match: full };
        }

        const numStr = full.match(/\d+[.,]?\d*/);
        if (numStr) {
          const qtd = parseFloat(numStr[0].replace(',', '.'));

          let unidade = full.replace(/[\d.,\s]/g, '').toLowerCase().trim();

          if (!unidade && qtd > 10 && qtd < 10000) {
            unidade = 'g';
          }

          const map = {
            'quilos': 'kg', 'quilo': 'kg', 'kilos': 'kg', 'kilo': 'kg',
            'gramas': 'g', 'grama': 'g',
            'litros': 'L', 'litro': 'L',
            'mililitros': 'ml', 'mililitro': 'ml',
            'centilitros': 'cl', 'centilitro': 'cl',
            'unid': 'un', 'unidade': 'un', 'pc': 'un', 'p√ß': 'un', 'pe√ßa': 'un',
            'caixa': 'un', 'emb': 'un', 'embalagem': 'un',
            'duzia': 'un', 'd√∫zia': 'un'
          };
          
          unidade = map[unidade] || unidade;

          if (!unidade) unidade = 'un';
          
          OCR_DEBUG.log('EXTRACAO', 'Qtd/Un extra√≠da', { qtd, unidade, match: full });
          return { quantidade: qtd, unidade, match: full };
        }
      }
    }
    
    OCR_DEBUG.log('EXTRACAO', 'Nenhuma qtd/un encontrada', null);
    return { quantidade: null, unidade: null, match: '' };
  };

  const extractPreco = (texto) => {
    const match = texto.match(/‚Ç¨?\s*(\d+[.,]\d{2})\s*‚Ç¨?/g);
    if (match) {
      const last = match[match.length - 1];
      const valor = parseFloat(last.replace(/[^\d.,]/g, '').replace(',', '.'));
      OCR_DEBUG.log('EXTRACAO', 'Pre√ßo extra√≠do', { valor, match: last });
      return { valor, match: last };
    }
    OCR_DEBUG.log('EXTRACAO', 'Nenhum pre√ßo encontrado', null);
    return { valor: null, match: '' };
  };

  const parseLinha = (linha, palavrasLimpar = []) => {
    OCR_DEBUG.log('PARSE', '>>> Iniciando parse', { linha });

    let linhaCorrigida = corrigirErrosOCR(linha);
    OCR_DEBUG.log('PARSE', 'Ap√≥s corre√ß√£o OCR', { linhaCorrigida });

    let linhaLimpa = linhaCorrigida.trim();

    const codigoMatch = linhaLimpa.match(/^\d{6}\.\d+/);
    if (codigoMatch) {
      OCR_DEBUG.log('PARSE', 'C√≥digo produto removido', { codigo: codigoMatch[0] });
      linhaLimpa = linhaLimpa.replace(/^\d{6}\.\d+\s+/, '');
    }

    const qtdUnidade = extractQuantidadeUnidade(linhaLimpa);
    const preco = extractPreco(linhaLimpa);

    let nomeProduto = linhaLimpa;
    if (qtdUnidade.match) nomeProduto = nomeProduto.replace(qtdUnidade.match, '');
    if (preco.match) nomeProduto = nomeProduto.replace(preco.match, '');

    nomeProduto = nomeProduto
      .replace(/\s+/g, ' ')  // Espa√ßos m√∫ltiplos
      .replace(/^[\d\s,\.]+/, '')  // N√∫meros/s√≠mbolos no in√≠cio
      .replace(/[*]+/g, '')  // Asteriscos
      .replace(/\s+[Ajl]\s*$/, '')  // Remove A, j, l no final
      .replace(/\s+(TN|PA|UN|UNI|EMB|CX)\s*$/i, '')  // Remove siglas no final
      .replace(/[\d\s,\.‚Ç¨]+$/, '')  // Remove n√∫meros/pre√ßos no final
      .trim();

    if (palavrasLimpar && palavrasLimpar.length > 0) {
      palavrasLimpar.forEach(palavra => {
        const regex = new RegExp(`\\b${palavra}\\b`, 'gi'); // Match palavra completa
        nomeProduto = nomeProduto.replace(regex, '').replace(/\s+/g, ' ').trim();
      });
      OCR_DEBUG.log('PARSE', 'Ap√≥s limpeza de palavras', { nomeProduto, palavrasRemovidas: palavrasLimpar });
    }
    
    OCR_DEBUG.log('PARSE', 'Nome produto extra√≠do', { nomeProduto });

    const temLetras = /[a-zA-Z√Ä-√ø]{2,}/.test(nomeProduto);
    
    if (!nomeProduto || nomeProduto.length < 2 || !temLetras) {
      OCR_DEBUG.log('PARSE', '‚úó INV√ÅLIDO - nome muito curto ou sem letras', { nomeProduto });
      return {
        textoOriginal: linha,
        nomeProduto: null, // INV√ÅLIDO
        quantidade: qtdUnidade.quantidade,
        unidade: qtdUnidade.unidade,
        preco: preco.valor,
        invalido: true
      };
    }
    
    OCR_DEBUG.log('PARSE', '‚úì Parse completo', {
      nome: nomeProduto,
      qtd: qtdUnidade.quantidade,
      unidade: qtdUnidade.unidade,
      preco: preco.valor
    });
    
    return {
      textoOriginal: linha,
      textoCorrigido: linhaCorrigida,
      textoLimpo: linhaLimpa,
      nomeProduto,
      quantidade: qtdUnidade.quantidade,
      unidade: qtdUnidade.unidade,
      preco: preco.valor,
      ingredienteSugerido: null,
      ingredienteConfirmado: null
    };
  };

  const parseLinhasProdutos = (texto, nifFornecedor = null) => {
    OCR_DEBUG.clear(); // Limpar logs anteriores
    OCR_DEBUG.log('INICIO', '=== INICIANDO PROCESSAMENTO OCR ===', {
      tamanhoTexto: texto.length,
      nifFornecedor
    });

    let blacklist = [];
    if (nifFornecedor) {
      const template = buscarTemplateOCR(nifFornecedor);
      if (template && template.blacklist) {
        blacklist = template.blacklist;

        blacklist.forEach((palavra, index) => {

        });

        OCR_DEBUG.log('BLACKLIST', `${blacklist.length} palavras carregadas`, { blacklist });
      }
    }

    const textoLimpo = cleanOCRText(texto);
    OCR_DEBUG.log('LIMPEZA', 'Texto limpo completo', {
      linhasOriginais: texto.split('\n').length,
      linhasLimpas: textoLimpo.split('\n').length
    });

    let linhas = textoLimpo.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    OCR_DEBUG.log('SPLIT', `${linhas.length} linhas ap√≥s split`, null);

    linhas.forEach((l, i) => {
      const codigos = l.match(/\d{6}\.\d+/g);
      if (codigos && codigos.length > 0) {

      }
    });

    const linhasSeparadas = [];
    for (const linha of linhas) {
      const produtos = separarProdutosColados(linha);
      linhasSeparadas.push(...produtos);
    }
    
    linhas = linhasSeparadas;

    OCR_DEBUG.log('SEPARACAO', `${linhas.length} linhas ap√≥s separa√ß√£o`, null);

    const linhasProdutos = [];
    const stats = {
      total: linhas.length,
      ignoradas: 0,
      semNome: 0,
      blacklist: 0,
      validas: 0
    };
    
    for (const linha of linhas) {

      if (blacklist.length > 0) {
        const linhaLower = linha.toLowerCase();

        const palavrasBloqueadoras = blacklist.filter(palavra => linhaLower.includes(palavra));
        
        if (palavrasBloqueadoras.length > 0) {

          const mensagemBlacklist = `Bloqueada por: ${palavrasBloqueadoras.map(p => `"${p}"`).join(', ')}`;

          OCR_DEBUG.log('BLACKLIST', mensagemBlacklist, { 
            linha, 
            palavrasBloqueadoras,
            linhaCompleta: linha
          });
          
          stats.blacklist++;
          continue;
        }
      }
      
      if (shouldIgnoreLine(linha)) {
        stats.ignoradas++;
        continue;
      }
      
      const parsed = parseLinha(linha);
      
      if (parsed && parsed.nomeProduto) {
        linhasProdutos.push(parsed);
        stats.validas++;
      } else {
        stats.semNome++;
        OCR_DEBUG.log('PARSE', 'Linha sem nome v√°lido', { linha, parsed });
      }
    }

    OCR_DEBUG.log('RESUMO', '=== PROCESSAMENTO CONCLU√çDO ===', {
      stats,
      produtosDetectados: linhasProdutos.length
    });

    if (stats.blacklist > 0) {

    }
    
    OCR_DEBUG.showSummary();

    window.lastOCRLogs = OCR_DEBUG.logs;
    window.lastOCRText = texto;

    if (linhasProdutos.length === 0) {

    }
    
    return linhasProdutos;
  };

  const extractFaturaMetadata = (texto) => {
    const linhas = texto.split('\n');
    const metadata = { numeroFatura: null, data: null, nif: null, total: null };
    for (const linha of linhas) {
      if (!metadata.numeroFatura) {

        const padroes = [
          /FT[\s\/-]*(\d{4}[\/-]\d+)/gi,                    // FT 2024/123, FT/2024/123
          /FT[\s\/-]*(\d+)/gi,                              // FT 123, FT123
          /(?:fatura|factura)[\s:n¬∫¬∞#]*(\d+\/\d+)/gi,      // Fatura 2024/123
          /(?:fatura|factura)[\s:n¬∫¬∞#]*(\d{4,})/gi,        // Fatura 123456
          /(?:invoice)[\s:#]*(\d+)/gi,                      // Invoice #123
          /N[¬∫¬∞][\s:]*(\d{4,})/gi                          // N¬∫ 123456
        ];
        
        for (const padrao of padroes) {
          const match = linha.match(padrao);
          if (match) {

            const numMatch = match[0].match(/[\d\/\-]+$/);
            if (numMatch) {
              metadata.numeroFatura = numMatch[0];
              break;
            }
          }
        }
      }
      if (!metadata.data) {
        const data = linha.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
        if (data) metadata.data = data[1];
      }
      if (!metadata.nif) {
        const nif = linha.match(/(?:nif|nipc|contribuinte)[:\s]*(\d{9})/i);
        if (nif) metadata.nif = nif[1];
      }
      if (!metadata.total) {
        const total = linha.match(/total[\s:]*‚Ç¨?\s*(\d+[.,]\d{2})/i);
        if (total) metadata.total = parseFloat(total[1].replace(',', '.'));
      }
    }

    return metadata;
  };

  /**
   * üÜï Extrai palavras-chave principais do nome do produto
   * Remove ru√≠do comum (marcas, quantidades, c√≥digos, etc.)
   */
  const extrairPalavrasChave = (texto) => {
    if (!texto) return [];

    let limpo = texto
      .toUpperCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, ''); // Remove acentos

    limpo = limpo

      .replace(/\d+\s*(G|GR|GRAMA|GRAMAS|KG|KILO|QUILOGRAMA|ML|L|LITRO|LITROS|CL|DL|UN|UNI|UNIDADE|UNIDADES|PCT|PACOTE|EMBALAGEM|EMBALGEM|SCO|SACO)\b/gi, '')

      .replace(/\b\d{5,}\.\d+\b/g, '')

      .replace(/\b(MCHEF|M CHEF|AMANH|AMANH√É|PRIMOR|CHEF|MASTER|ROYAL|FERBAR|SCHOCO|VAHINE|PANTAGRUEL|NIDO)\b/gi, '')

      .replace(/\b(FAT|FT|VIDRO|LATA|PACOTE|PCT|EMBALAGEM|EMBALGEM|SC|SCO|SACO|CAL|RAMA|SECOS|SECA|SECO|SERR|BCO|PAP|GORDO|CULINARIA)\b/gi, '')

      .replace(/\b\d+\b/g, '')

      .replace(/[^\w\s]/g, ' ')

      .replace(/\s+/g, ' ')
      .trim();

    const palavras = limpo
      .split(' ')
      .filter(p => p.length >= 3) // Palavras com 3+ letras
      .filter(p => !/^\d+$/.test(p)); // Remover n√∫meros puros
    
    return palavras;
  };

  const findBestMatch = (nomeProduto, ingredientes) => {
    if (!nomeProduto || !ingredientes || ingredientes.length === 0) {
      return null;
    }

    const palavrasProduto = extrairPalavrasChave(nomeProduto);
    
    if (palavrasProduto.length === 0) {
      return null;
    }
    
    let bestMatch = null;
    let bestScore = 0;
    let bestMethod = '';
    
    for (const ing of ingredientes) {
      const palavrasIng = extrairPalavrasChave(ing.nome);
      let score = 0;
      let method = '';

      if (palavrasIng.length > 0) {
        const todasPalavrasPresentes = palavrasIng.every(pIng => 
          palavrasProduto.some(pProd => pProd === pIng)
        );
        
        if (todasPalavrasPresentes) {
          score = 95;
          method = 'MATCH_EXATO_COMPLETO';
        }
      }

      if (score === 0 && palavrasIng.length > 0 && palavrasProduto.length > 0) {
        const palavrasComuns = palavrasProduto.filter(pProd =>
          palavrasIng.some(pIng => pIng === pProd)
        );
        
        if (palavrasComuns.length > 0) {

          const overlapProduto = palavrasComuns.length / palavrasProduto.length;
          const overlapIngrediente = palavrasComuns.length / palavrasIng.length;
          const overlapMedio = (overlapProduto + overlapIngrediente) / 2;
          
          score = Math.round(overlapMedio * 85); // Max 85 pontos
          method = `MATCH_PARCIAL (${palavrasComuns.length}/${palavrasProduto.length} palavras)`;
        }
      }

      if (score === 0) {
        const produtoNorm = palavrasProduto.join(' ');
        const ingNorm = palavrasIng.join(' ');
        
        if (produtoNorm && ingNorm && typeof fuzz !== 'undefined') {
          const fuzzyScore = fuzz.ratio(produtoNorm, ingNorm);
          score = Math.round(fuzzyScore * 0.75); // Limitar a 75%
          method = 'FUZZY_MATCH';
        }
      }

      if (score > bestScore) {
        bestScore = score;
        bestMatch = {
          id: ing.id,
          nome: ing.nome,
          confianca: score,
          metodo: method,
          textoOCR: nomeProduto,
          palavrasChave: palavrasProduto.join(', ')
        };
      }
    }

    return bestScore >= 40 ? bestMatch : null;
  };
  
  const matchIngredientes = (linhas, ingredientes) => {

    setProgressoOCR('Relacionando...');
    return linhas.map(linha => ({
      ...linha,
      ingredienteSugerido: findBestMatch(linha.nomeProduto, ingredientes)
    }));
  };
  
  const calculateMatchingStats = (linhas) => {
    const total = linhas.length;
    const comSugestao = linhas.filter(l => l.ingredienteSugerido).length;
    const altaConfianca = linhas.filter(l => l.ingredienteSugerido?.confianca >= 80).length;
    const mediaConfianca = linhas.filter(l => l.ingredienteSugerido?.confianca >= 60 && l.ingredienteSugerido?.confianca < 80).length;
    return {
      total, comSugestao, altaConfianca, mediaConfianca,
      semSugestao: total - comSugestao,
      percentagemAuto: total > 0 ? Math.round((altaConfianca / total) * 100) : 0
    };
  };
  
  const getConfidenceLevel = (score) => {
    if (score >= 80) return { nivel: 'alta', cor: 'green', icone: '‚úì' };
    if (score >= 60) return { nivel: 'media', cor: 'yellow', icone: '‚ö†' };
    return { nivel: 'baixa', cor: 'red', icone: '‚úó' };
  };

  const handleLerPDFAutomatico = async (event) => {
    const file = event.target.files[0];
    if (!file) {
      showNotification('‚ö†Ô∏è Selecione um ficheiro', 'error');
      return;
    }

    const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      showNotification('‚ö†Ô∏è Selecione um PDF ou imagem (PNG, JPG, WEBP)', 'error');
      event.target.value = ''; // Limpar input
      return;
    }

    if (typeof Tesseract === 'undefined') {
      showNotification('‚ö†Ô∏è Biblioteca Tesseract ainda n√£o carregou. Aguarde e tente novamente.', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    if (typeof fuzz === 'undefined' && typeof window.fuzzball === 'undefined') {
      showNotification('‚ö†Ô∏è Biblioteca de matching ainda n√£o carregou. Aguarde e tente novamente.', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    let base64 = null;
    
    try {
      setProcessandoOCR(true);
      setProgressoOCR('Carregando...');

      const arrayBuffer = await file.arrayBuffer();
      base64 = btoa(
        new Uint8Array(arrayBuffer)
          .reduce((data, byte) => data + String.fromCharCode(byte), '')
      );

      const { text, method } = await extractTextFromPdf(file);

      const metadata = extractFaturaMetadata(text);
      metadata.textoCompleto = text; // Guardar para aprender template

      const nifEmpresa = configuracoes.metricas.nifEmpresa;
      if (nifEmpresa) {
        const temNifCliente = detetarNifCliente(text, nifEmpresa);
        metadata.temNifCliente = temNifCliente;
        metadata.nifClienteDetetado = temNifCliente ? nifEmpresa : null;

      } else {
        metadata.temNifCliente = false;
        metadata.nifClienteDetetado = null;

      }

      const dadosFatura = processarTextoFatura(text, fornecedores); // ‚úÖ PASSAR FORNECEDORES

      const pdfBlob = new Blob([await file.arrayBuffer()], { type: 'application/pdf' });
      const pdfUrl = URL.createObjectURL(pdfBlob);

      setModalConfirmacaoFatura({
        mostrar: true,
        dados: {
          ...dadosFatura,
          pdfUrl: pdfUrl
        }
      });

      const template = buscarTemplateOCR(metadata.nif);
      const linhas = template 
        ? parseComTemplate(text, template) 
        : parseLinhasProdutos(text, metadata.nif); // üö´ CORRIGIDO: Passar NIF para usar blacklist

      metadata.pdfBase64 = base64;
      metadata.pdfNome = file.name;
      metadata.precosComIVA = dadosFatura.precosComIVA; // NOVO: passar flag de IVA

      const linhasComMatch = linhas.length > 0 
        ? matchIngredientes(linhas, ingredientes)
        : []; // Lista vazia mas abre modal na mesma

      setLinhasOCR(linhasComMatch);
      setMetadataOCR(metadata);

      
      if (linhas.length === 0) {
         
      } else {

      }
    } catch (error) {

      if (base64) {
        setNovaFatura({
          ...novaFatura,
          documentoPDF: base64,
          nomeDocumento: file.name
        });
        showNotification('‚ùå Erro no OCR, mas PDF foi guardado! Adicione dados manualmente.', 'warning');
      } else {
        showNotification('‚ùå Erro ao processar: ' + error.message, 'error');
      }
    } finally {
      setProcessandoOCR(false);
      setProgressoOCR('');
      event.target.value = ''; // ‚úÖ LIMPAR INPUT SEMPRE NO FINAL
    }
  };

  const handleConfirmarOCR = (linhasValidadas, metadata) => {

    setMostrarModalOCR(false);

    const categoriaFatura = metadata.categoria || 'compras';
    if (categoriaFatura !== 'compras') {

      showNotification('‚ö†Ô∏è Esta fatura n√£o √© de compras. N√£o √© necess√°rio processar ingredientes.', 'warning');
      return;
    }

    const nifFornecedor = metadata.nif || novaFatura.fornecedorNIF;
    
    if (nifFornecedor) {

      linhasValidadas = linhasValidadas.map(linha => {

        if (linha.ingredienteConfirmado) {

          return linha;
        }

        const resultado = buscarNoVocabulario(linha.nomeProduto, nifFornecedor);
        
        if (resultado) {
          const { ingredienteId, confianca, similaridade, confirmacoes, correcoes } = resultado;
          const ingrediente = ingredientes.find(i => i.id === ingredienteId);
          
          if (ingrediente) {

            if (confianca >= 80) {

              const ingrediente = ingredientes.find(i => i.id === ingredienteId);

              const ingredienteSugeridoObj = ingrediente ? {
                id: ingrediente.id,
                nome: ingrediente.nome,
                confianca: confianca,
                metodo: 'VOCABULARIO'
              } : null;

              const historico = buscarHistoricoIngrediente(ingredienteId, nifFornecedor);
              const unidadeUltimaVez = historico?.unidade || ingrediente?.unidade || 'kg';

              return {
                ...linha,
                ingredienteConfirmado: ingredienteId, // Auto-preencher nome
                ingredienteSugerido: ingredienteSugeridoObj,   // Guardar objeto completo
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes },

                precoSugerido: ingrediente?.custoUnitario || null,

                unidade: linha.unidade || unidadeUltimaVez,

                quantidade: linha.quantidade || null
              };
            } else {

              const ingrediente = ingredientes.find(i => i.id === ingredienteId);
              const ingredienteSugeridoObj = ingrediente ? {
                id: ingrediente.id,
                nome: ingrediente.nome,
                confianca: confianca,
                metodo: 'VOCABULARIO'
              } : null;

              return {
                ...linha,
                ingredienteSugerido: ingredienteSugeridoObj, // Objeto completo
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes }

              };
            }
          }
        }

        const fuzzyMatch = findBestMatch(linha.nomeProduto, ingredientes);
        
        if (fuzzyMatch && fuzzyMatch.confianca >= 60) {

          return {
            ...linha,
            ingredienteSugerido: fuzzyMatch, // Objeto completo
            confiancaSugestao: fuzzyMatch.confianca,
            similaridadeSugestao: fuzzyMatch.confianca,
            historicoSugestao: { confirmacoes: 0, correcoes: 0 }
          };
        }

        return linha;
      });
      
      const sugeridos = linhasValidadas.filter(l => l.ingredienteSugerido).length;
      const total = linhasValidadas.length;
      
      if (sugeridos > 0) {

      } else {

      }
    }

    const ingredientesAtualizados = [...ingredientes];

    if (metadata.novosIngredientes && metadata.novosIngredientes.length > 0) {
      const novosIngs = metadata.novosIngredientes;
      setIngredientes(prev => [...prev, ...novosIngs]);

      ingredientesAtualizados.push(...novosIngs);
    }

    if (window._novosFornecedores && window._novosFornecedores.length > 0) {
      const novosForn = window._novosFornecedores;
      setFornecedores(prev => [...prev, ...novosForn]);

      window._novosFornecedores = [];
    }
    
    let ingredientesModificados = 0;
    const mudancasPreco = []; // NOVO: Coletar mudan√ßas em vez de aplicar

    linhasValidadas.forEach(l => {
      if (l.ingredienteConfirmado && l.preco && l.quantidade) {
        const index = ingredientesAtualizados.findIndex(i => i.id === l.ingredienteConfirmado);
        
        if (index === -1) {

          return;
        }
        
        const ingrediente = ingredientesAtualizados[index];
        const precoTotal = parseFloat(l.preco);
        const quantidade = parseFloat(l.quantidade);
        const unidadeCompra = l.unidade || ingrediente.unidade; // Unidade da compra
        const unidadeBase = ingrediente.unidade; // Unidade base do ingrediente
        const iva = ingrediente.iva || 23;

        let quantidadeBase = quantidade;
        if (unidadeCompra === 'g' && unidadeBase === 'kg') {
          quantidadeBase = quantidade / 1000;

        } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
          quantidadeBase = quantidade / 1000;

        } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
          quantidadeBase = quantidade * 1000;

        } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
          quantidadeBase = quantidade * 1000;

        } else if (unidadeCompra === unidadeBase) {
          quantidadeBase = quantidade;

        }
        
        let novoPrecoUnitario;

        const precoComIVA = precoTotal / quantidadeBase; // Dividir pela quantidade BASE
        novoPrecoUnitario = precoComIVA; // Guardar COM IVA conforme requisitado
        
        const precoAnterior = ingredientesAtualizados[index].custoUnitario || 0;

        if (Math.abs(novoPrecoUnitario - precoAnterior) > 0.01) {

          mudancasPreco.push({
            ingredienteId: ingrediente.id,
            ingredienteNome: ingrediente.nome,
            ingredienteIndex: index,
            precoAnterior,
            precoNovo: novoPrecoUnitario
          });
          
          ingredientesModificados++;
        } else {

        }
      }
    });

    if (mudancasPreco.length > 0) {

      window._ocrContext = {
        ingredientesAtualizados,
        linhasValidadas,
        metadata,
        mudancasPreco,
        indiceAtual: 0
      };

      const primeiraMudanca = mudancasPreco[0];
      const ingrediente = ingredientesAtualizados.find(i => i.id === primeiraMudanca.ingredienteId);
      
      setPriceAlertData({
        tipoOperacao: 'ocrPriceUpdate',
        ingrediente: ingrediente,
        precoAtual: primeiraMudanca.precoAnterior,
        precoNovo: primeiraMudanca.precoNovo,
        unidadeBase: ingrediente.unidade,
        produtosAfetados: produtos.filter(p => 
          p.receita && p.receita.some(r => r.ingredienteId === ingrediente.id)
        ),
        totalMudancas: mudancasPreco.length,
        mudancaAtual: 1
      });
      
      setShowPriceAlert(true);
      
      return; // PARA AQUI - modal vai continuar o processo
    }

    finalizarFaturaOCR(ingredientesAtualizados, linhasValidadas, metadata);
  };

  const finalizarFaturaOCR = (ingredientesAtualizados, linhasValidadas, metadata) => {

    setIngredientes(ingredientesAtualizados);

    const produtosAtualizados = produtos.map(produto => {
      if (!produto.receita || produto.receita.length === 0) return produto;

      const novoCusto = produto.receita.reduce((total, item) => {
        const ing = ingredientesAtualizados.find(i => i.id === item.ingredienteId);
        if (!ing) return total;
        
        let quantidade = parseFloat(item.quantidade) || 0;
        const precoUnit = parseFloat(ing.custoUnitario) || 0;

        const unidadeReceita = item.unidade || ing.unidade;
        if (ing.unidade === 'kg' && unidadeReceita === 'g') quantidade = quantidade / 1000;
        if (ing.unidade === 'L' && unidadeReceita === 'ml') quantidade = quantidade / 1000;
        if (ing.unidade === 'g' && unidadeReceita === 'kg') quantidade = quantidade * 1000;
        if (ing.unidade === 'ml' && unidadeReceita === 'L') quantidade = quantidade * 1000;

        const percentagemDesperdicio = getPercentagemDesperdicio(ing);
        const custoComDesperdicio = precoUnit * (1 + percentagemDesperdicio / 100);
        
        return total + (quantidade * custoComDesperdicio);
      }, 0);

      const custoFinal = (produto.porcoes && produto.porcoes > 1) 
        ? novoCusto / produto.porcoes 
        : novoCusto;

      const precoVenda = parseFloat(produto.precoVenda) || 0;
      const novaMargemLucro = precoVenda > 0 ? ((precoVenda - custoFinal) / precoVenda) * 100 : 0;

      if (Math.abs(custoFinal - (produto.custoReceita || 0)) > 0.01) {

        return {
          ...produto,
          custoReceita: custoFinal,
          margemLucro: novaMargemLucro
        };
      }
      
      return produto;
    });
    
    setProdutos(produtosAtualizados);

    const categoria = metadata.categoria || 'compras';
    const novosItens = linhasValidadas
      .filter(l => {

        if (categoria === 'compras') {
          return l.ingredienteConfirmado && l.preco && parseFloat(l.preco) > 0;
        }

        return l.preco && parseFloat(l.preco) > 0;
      })
      .map((l, index) => {
        const quantidade = parseFloat(l.quantidade) || 1;
        const precoTotal = parseFloat(l.preco) || 0; // COM IVA

        if (categoria === 'compras' && l.ingredienteConfirmado) {
          const ingrediente = ingredientesAtualizados.find(i => i.id === l.ingredienteConfirmado);
          const iva = parseFloat(ingrediente?.iva || 13);

          const precoComIVA = precoTotal / quantidade;
          const precoUnitario = precoComIVA / (1 + iva / 100); // SEM IVA
          const subtotal = precoUnitario * quantidade; // SEM IVA

          return {
            id: `ocr_${Date.now()}_${index}`,
            ingredienteId: l.ingredienteConfirmado,
            ingredienteNome: ingrediente?.nome || l.nomeProduto,
            descricao: ingrediente?.nome || l.nomeProduto,
            quantidade: quantidade,
            unidade: l.unidade || ingrediente?.unidade || 'un',
            precoUnitario: precoUnitario,
            precoTotal: precoTotal,
            subtotal: subtotal,
            iva: iva,
            num_funcionarios: 1
          };
        }

        const iva = categoria === 'salarios' ? 0 : 23; // Sal√°rios sem IVA, resto 23%
        const precoComIVA = precoTotal / quantidade;
        const precoUnitario = iva > 0 ? precoComIVA / (1 + iva / 100) : precoComIVA;
        const subtotal = precoUnitario * quantidade;

        return {
          id: `ocr_${Date.now()}_${index}`,
          descricao: l.nomeProduto || `Item ${index + 1}`,
          quantidade: 1, // Fixo para despesas fixas
          unidade: 'servi√ßo',
          precoUnitario: precoTotal,
          precoTotal: precoTotal,
          subtotal: subtotal,
          iva: iva,
          num_funcionarios: 1
        };
      });

    const nifFornecedor = metadata.nif || novaFatura.fornecedorNIF;

    if (nifFornecedor) {

      linhasValidadas.forEach((linha, idx) => {

        if (linha.ingredienteConfirmado && linha.nomeProduto) {
          const textoOCR = linha.nomeProduto;
          const ingredienteId = linha.ingredienteConfirmado;

          const foiAlterado = linha.ingredienteSugerido && 
                             linha.ingredienteConfirmado !== linha.ingredienteSugerido.id;

          const dadosLinha = {
            quantidade: linha.quantidade,
            unidade: linha.unidade,
            preco: linha.preco
          };

          aprenderAssociacao(textoOCR, ingredienteId, nifFornecedor, foiAlterado, dadosLinha);
          
          if (foiAlterado) {
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);

          } else if (linha.ingredienteSugerido) {

          } else {
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);

          }
        }
      });
    }

    if (nifFornecedor && metadata.textoCompleto) {
      aprenderTemplateOCR(nifFornecedor, metadata.textoCompleto, linhasValidadas);
    }

    const tipoFatura = metadata.tipoFatura || 'FT';
    const novaFaturaAtualizada = {
      ...novaFatura,
      numero: metadata.numeroFatura || novaFatura.numero,
      tipo: tipoFatura, // ‚úÖ TIPO DE FATURA (FT/FR/FS)

      temNifCliente: metadata.temNifCliente || false,
      nifCliente: metadata.nifClienteDetetado || configuracoes.metricas.nifEmpresa || null,
      paraContabilista: (() => {
        const temNif = metadata.temNifCliente;

        if (tipoFatura === 'FT' || tipoFatura === 'FR') return true;

        if (tipoFatura === 'FS') return temNif === true;
        return false;
      })(),
      tipoDocumento: metadata.tipoDocumento || 'fatura', // ‚Üê tipo do documento
      data: metadata.data ? convertDataToISO(metadata.data) : novaFatura.data,
      itens: novosItens,
      documentoPDF: metadata.pdfBase64 || novaFatura.documentoPDF || null,
      nomeDocumento: metadata.pdfNome || novaFatura.nomeDocumento || '',
      categoria: metadata.categoria || 'compras', // üÜï USAR CATEGORIA DO METADATA
      totais: metadata.totais || { subtotal: 0, iva: 0, total: 0 } // ‚úÖ TOTAIS DA FATURA
    };

    if (metadata.fornecedorId) {
      const fornecedor = fornecedores.find(f => f.id === metadata.fornecedorId);
      if (fornecedor) {
        novaFaturaAtualizada.fornecedorId = fornecedor.id;
        novaFaturaAtualizada.fornecedorNome = fornecedor.nome;
        novaFaturaAtualizada.fornecedorNif = fornecedor.nif || metadata.nif || '';

      }
    }

    else if (metadata.nif) {
      const fornecedor = fornecedores.find(f => f.nif === metadata.nif);
      if (fornecedor) {
        novaFaturaAtualizada.fornecedorId = fornecedor.id;
        novaFaturaAtualizada.fornecedorNome = fornecedor.nome;
        novaFaturaAtualizada.fornecedorNif = metadata.nif;

      }
    }

    if (metadata.fornecedorManual && !novaFaturaAtualizada.fornecedorId) {

      let fornecedorManual = fornecedores.find(f => f.id === metadata.fornecedorManual);
      
      if (!fornecedorManual && window._novosFornecedores) {
        fornecedorManual = window._novosFornecedores.find(f => f.id === metadata.fornecedorManual);
      }
      
      if (fornecedorManual) {
        novaFaturaAtualizada.fornecedorId = fornecedorManual.id;
        novaFaturaAtualizada.fornecedorNome = fornecedorManual.nome;
        novaFaturaAtualizada.fornecedorNif = fornecedorManual.nif;

      }
    }

    novaFaturaAtualizada.fromOCR = true;
    
    setNovaFatura(novaFaturaAtualizada);

    setTimeout(() => {
      salvarFaturaSemAlerta(novaFaturaAtualizada);

      setNovaFatura({
        numero: '',
        tipo: 'FT',
        tipoDocumento: 'FT',
        data: new Date().toISOString().split('T')[0],
        fornecedorId: '',
        fornecedorNome: '',
        fornecedorNif: '',
        itens: [],
        notas: '',
        categoria: 'compras',
        recorrente: false,
        documentoPDF: null,
        nomeDocumento: ''
      });
      
      const tipoMsg = novaFaturaAtualizada.tipoDocumento === 'fatura' ? 'Fatura' : 'Recibo';
      showNotification(`‚úÖ ${tipoMsg} guardada com ${novosItens.length} produtos!`, 'success');
    }, 100);

  };

  const convertDataToISO = (dataStr) => {
    if (!dataStr) return new Date().toISOString().split('T')[0];
    
    try {

      if (/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) {
        return dataStr;
      }

      const patterns = [
        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, // DD/MM/YYYY
        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/   // DD/MM/YY
      ];
      
      for (const pattern of patterns) {
        const match = dataStr.match(pattern);
        if (match) {
          let [_, dia, mes, ano] = match;

          if (ano.length === 2) {
            ano = parseInt(ano) > 50 ? `19${ano}` : `20${ano}`;
          }

          dia = dia.padStart(2, '0');
          mes = mes.padStart(2, '0');

          const mesNum = parseInt(mes);
          const diaNum = parseInt(dia);
          
          if (mesNum < 1 || mesNum > 12 || diaNum < 1 || diaNum > 31) {
            console.error('Data inv√°lida detectada:', dataStr, '‚Üí Dia:', dia, 'M√™s:', mes);
            return new Date().toISOString().split('T')[0];
          }
          
          return `${ano}-${mes}-${dia}`;
        }
      }

      console.warn('Formato de data n√£o reconhecido:', dataStr);
      return new Date().toISOString().split('T')[0];
    } catch (e) {
      console.error('Erro ao converter data:', dataStr, e);
      return new Date().toISOString().split('T')[0];
    }
  };

  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
    { id: 'gestao', label: 'Gest√£o', icon: FileText },
    { id: 'definicoes', label: 'Defini√ß√µes', icon: Settings }
  ];

  return (
    <div className={`min-h-screen p-2 transition-colors bg-gray-50`}>
      {/* Notification */}
      {notification && (
        <div className={`fixed top-2 right-2 z-50 flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg text-sm ${
          notification.type === 'success' ? 'bg-green-500 text-white' : 
          notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
        }`}>
          {notification.type === 'success' && <Check size={16} />}
          {notification.type === 'error' && <X size={16} />}
          <span>{notification.message}</span>
        </div>
      )}

      {/* Price Change Alert Modal */}
      {showPriceAlert && priceAlertData && (
        <div className="fixed inset-0 bg-black/50 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-2xl max-w-md w-full my-8">
            <div className="bg-orange-500 text-white px-4 py-3 rounded-t-lg flex items-center justify-between">
              <h3 className="font-bold text-lg flex items-center gap-2">
                <AlertCircle size={20} />
                Preco Diferente do Registado
                {priceAlertData.tipoOperacao === 'ocrPriceUpdate' && priceAlertData.totalMudancas > 1 && (
                  <span className="text-sm font-normal opacity-90">
                    ({priceAlertData.mudancaAtual}/{priceAlertData.totalMudancas})
                  </span>
                )}
              </h3>
              <button
                onClick={() => {

                  setShowPriceAlert(false);
                  setPriceAlertData(null);
                }}
                className="hover:bg-orange-600 rounded p-1 transition"
              >
                <X size={20} />
              </button>
            </div>
            
            <div className="p-4 space-y-3">
              <div className="bg-orange-50 border border-orange-200 rounded p-3">
                <p className="text-sm font-bold text-orange-900 mb-2">{priceAlertData.ingrediente.nome}:</p>
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-700">Pre√ßo atual:</span>
                  <span className="font-semibold">‚Ç¨{priceAlertData.precoAtual.toFixed(2)}/{priceAlertData.ingrediente.unidade}</span>
                </div>
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-700">Pre√ßo novo:</span>
                  <span className="font-bold text-orange-600">‚Ç¨{priceAlertData.precoNovo.toFixed(2)}/{priceAlertData.ingrediente.unidade}</span>
                </div>
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-700">Diferen√ßa:</span>
                  <span className={`font-bold ${priceAlertData.precoNovo > priceAlertData.precoAtual ? 'text-red-600' : 'text-green-600'}`}>
                    {priceAlertData.precoNovo > priceAlertData.precoAtual ? '+' : ''}{(((priceAlertData.precoNovo - priceAlertData.precoAtual) / priceAlertData.precoAtual) * 100).toFixed(1)}%
                  </span>
                </div>
              </div>
              
              {priceAlertData.produtosAfetados.length > 0 && (
                <div className="bg-blue-50 border border-blue-200 rounded p-3">
                  <p className="text-xs font-semibold text-blue-900 mb-2">
                    üçΩÔ∏è {priceAlertData.produtosAfetados.length} produtos afetados:
                  </p>
                  <div className="space-y-1 max-h-32 overflow-y-auto">
                    {priceAlertData.produtosAfetados.slice(0, 5).map((p, idx) => (
                      <div key={idx} className="flex justify-between items-center text-xs bg-white rounded px-2 py-1">
                        <span className="text-gray-700">{p.nome}</span>
                        <span className={`font-semibold ${p.margemDif < 0 ? 'text-red-600' : 'text-green-600'}`}>
                          margem {p.margemDif < 0 ? '‚Üì' : '‚Üë'} ‚Ç¨{Math.abs(p.margemDif).toFixed(2)}
                        </span>
                      </div>
                    ))}
                    {priceAlertData.produtosAfetados.length > 5 && (
                      <p className="text-xs text-gray-500 text-center">+ {priceAlertData.produtosAfetados.length - 5} mais...</p>
                    )}
                  </div>
                </div>
              )}
              
              <p className="text-xs text-gray-600">
                üí° Atualizar o custo base vai recalcular automaticamente as margens de todos os produtos.
              </p>
            </div>
            
            <div className="flex gap-2 px-4 pb-4">
              <button
                onClick={() => {

                  if (priceAlertData.tipoFatura || priceAlertData.tipoOperacao) {
                    confirmarFaturaSemAtualizar();
                  } else {
                    confirmarDespesaSemAtualizar();
                  }
                }}
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded px-4 py-2 text-sm font-semibold transition"
              >
                Ignorar
              </button>
              <button
                onClick={() => {

                  if (priceAlertData.tipoFatura === 'ingrediente') {

                    atualizarIngredienteSemAlerta();
                    setShowPriceAlert(false);
                  } else if (priceAlertData.tipoFatura || priceAlertData.tipoOperacao) {

                    confirmarFaturaEAtualizar();
                  } else {

                    confirmarDespesaEAtualizar();
                  }
                }}
                className="flex-1 bg-orange-500 hover:bg-orange-600 text-white rounded px-4 py-2 text-sm font-semibold transition"
              >
                Atualizar Custo Base
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-[1600px] mx-auto">
        {/* Header */}
        <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 rounded-3xl shadow-2xl p-6 mb-4 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="bg-white/20 rounded-lg p-2 backdrop-blur-sm">
                <span className="text-2xl">üçΩÔ∏è</span>
              </div>
              <div>
                <h1 className="text-2xl font-bold tracking-tight">AI Munchi Manager</h1>
              </div>
            </div>
            
            {/* Barra de Objetivo */}
            <div className="flex-1 mx-6 max-w-md group relative">
              <div className="flex justify-between items-center mb-1.5">
                <span className="text-sm font-bold text-white">
                  ‚Ç¨{(() => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    return vendas
                      .filter(v => {
                        const dataVenda = new Date(v.data);
                        return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                      })
                      .reduce((total, v) => total + (v.total || v.valor || 0), 0)
                      .toFixed(0);
                  })()}
                </span>
                <span className="text-xs text-white">
                  / ‚Ç¨{(() => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const calcDespFixas = () => [...despesas, ...faturas]
                      .filter(item => {
                        const data = new Date(item.data);
                        return data.getMonth() === mesAtual && 
                               data.getFullYear() === anoAtual && 
                               ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(item.categoria);
                      })
                      .reduce((t, i) => t + (i.valor || i.total || 0), 0);
                    
                    const vendasMes = vendas.filter(v => {
                      const dataVenda = new Date(v.data);
                      return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                    });
                    
                    let foodCostMes = 0;
                    vendasMes.forEach(venda => {
                      const produto = produtos.find(p => p.id === venda.produtoId);
                      if (produto && produto.custoReceita) {
                        foodCostMes += produto.custoReceita * venda.quantidade;
                      }
                    });
                    
                    return (calcDespFixas() + foodCostMes + Math.abs(ivaP) + ordenadoObjetivo).toFixed(0);
                  })()}
                </span>
              </div>
              
              <div className="w-full rounded-full h-2.5">
                <div
                  className={`h-full transition-all duration-500 rounded-full border-2 border-white/70 animate-pulse ${(() => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const faturacaoMes = vendas
                      .filter(v => {
                        const dataVenda = new Date(v.data);
                        return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                      })
                      .reduce((total, v) => total + (v.total || v.valor || 0), 0);
                    
                    const calcDespFixas = () => [...despesas, ...faturas]
                      .filter(item => {
                        const data = new Date(item.data);
                        return data.getMonth() === mesAtual && 
                               data.getFullYear() === anoAtual && 
                               ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(item.categoria);
                      })
                      .reduce((t, i) => t + (i.valor || i.total || 0), 0);
                    
                    const vendasMes = vendas.filter(v => {
                      const dataVenda = new Date(v.data);
                      return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                    });
                    
                    let foodCostMes = 0;
                    vendasMes.forEach(venda => {
                      const produto = produtos.find(p => p.id === venda.produtoId);
                      if (produto && produto.custoReceita) {
                        foodCostMes += produto.custoReceita * venda.quantidade;
                      }
                    });
                    
                    const objetivo = calcDespFixas() + foodCostMes + Math.abs(ivaP) + ordenadoObjetivo;
                    const percentagem = objetivo > 0 ? (faturacaoMes / objetivo) * 100 : 0;
                    
                    if (percentagem >= 100) return 'bg-green-500';
                    if (percentagem >= 75) return 'bg-yellow-400';
                    return 'bg-red-500';
                  })()}`}
                  style={{ width: `${(() => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const faturacaoMes = vendas
                      .filter(v => {
                        const dataVenda = new Date(v.data);
                        return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                      })
                      .reduce((total, v) => total + (v.total || v.valor || 0), 0);
                    
                    const calcDespFixas = () => [...despesas, ...faturas]
                      .filter(item => {
                        const data = new Date(item.data);
                        return data.getMonth() === mesAtual && 
                               data.getFullYear() === anoAtual && 
                               ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(item.categoria);
                      })
                      .reduce((t, i) => t + (i.valor || i.total || 0), 0);
                    
                    const vendasMes = vendas.filter(v => {
                      const dataVenda = new Date(v.data);
                      return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                    });
                    
                    let foodCostMes = 0;
                    vendasMes.forEach(venda => {
                      const produto = produtos.find(p => p.id === venda.produtoId);
                      if (produto && produto.custoReceita) {
                        foodCostMes += produto.custoReceita * venda.quantidade;
                      }
                    });
                    
                    const objetivo = calcDespFixas() + foodCostMes + Math.abs(ivaP) + ordenadoObjetivo;
                    const percentagem = objetivo > 0 ? Math.min((faturacaoMes / objetivo) * 100, 100) : 0;
                    return percentagem;
                  })()}%` }}>
                </div>
              </div>
              
              <div className="flex justify-between items-center mt-1.5">
                <span className="text-xs text-white">
                  {(() => {
                    const hoje = new Date();
                    const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    const diasRestantes = ultimoDia.getDate() - hoje.getDate();
                    return `${diasRestantes} ${diasRestantes === 1 ? 'dia' : 'dias'}`;
                  })()}
                </span>
                <span className="text-xs font-semibold text-white">
                  {(() => {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const faturacaoMes = vendas
                      .filter(v => {
                        const dataVenda = new Date(v.data);
                        return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                      })
                      .reduce((total, v) => total + (v.total || v.valor || 0), 0);
                    
                    const calcDespFixas = () => [...despesas, ...faturas]
                      .filter(item => {
                        const data = new Date(item.data);
                        return data.getMonth() === mesAtual && 
                               data.getFullYear() === anoAtual && 
                               ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(item.categoria);
                      })
                      .reduce((t, i) => t + (i.valor || i.total || 0), 0);
                    
                    const vendasMes = vendas.filter(v => {
                      const dataVenda = new Date(v.data);
                      return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                    });
                    
                    let foodCostMes = 0;
                    vendasMes.forEach(venda => {
                      const produto = produtos.find(p => p.id === venda.produtoId);
                      if (produto && produto.custoReceita) {
                        foodCostMes += produto.custoReceita * venda.quantidade;
                      }
                    });
                    
                    const objetivo = calcDespFixas() + foodCostMes + Math.abs(ivaP) + ordenadoObjetivo;
                    const percentagem = objetivo > 0 ? (faturacaoMes / objetivo) * 100 : 0;
                    
                    if (percentagem >= 100) return '‚úÖ Atingido';
                    if (percentagem >= 75) return '‚ö†Ô∏è Quase';
                    return 'üéØ ' + percentagem.toFixed(0) + '%';
                  })()}
                </span>
              </div>
              
              <div className="absolute top-full left-0 right-0 mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                <div className="bg-white rounded-lg shadow-xl p-4 border border-gray-200">
                  <h4 className="text-xs font-bold text-gray-800 mb-2">üìä Composi√ß√£o do Objetivo Mensal</h4>
                  <div className="space-y-1.5 text-xs">
                    <div className="flex justify-between">
                      <span className="text-gray-600">üí∞ Ordenados:</span>
                      <span className="font-semibold text-gray-900">‚Ç¨{ordenadoObjetivo.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">üè† Despesas Fixas:</span>
                      <span className="font-semibold text-gray-900">
                        ‚Ç¨{(() => {
                          const hoje = new Date();
                          const mesAtual = hoje.getMonth();
                          const anoAtual = hoje.getFullYear();
                          return [...despesas, ...faturas]
                            .filter(item => {
                              const data = new Date(item.data);
                              return data.getMonth() === mesAtual && 
                                     data.getFullYear() === anoAtual && 
                                     ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(item.categoria);
                            })
                            .reduce((t, i) => t + (i.valor || i.total || 0), 0)
                            .toFixed(2);
                        })()}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">üçΩÔ∏è Food Cost:</span>
                      <span className="font-semibold text-gray-900">
                        ‚Ç¨{(() => {
                          const hoje = new Date();
                          const mesAtual = hoje.getMonth();
                          const anoAtual = hoje.getFullYear();
                          const vendasMes = vendas.filter(v => {
                            const dataVenda = new Date(v.data);
                            return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                          });
                          let foodCostMes = 0;
                          vendasMes.forEach(venda => {
                            const produto = produtos.find(p => p.id === venda.produtoId);
                            if (produto && produto.custoReceita) {
                              foodCostMes += produto.custoReceita * venda.quantidade;
                            }
                          });
                          return foodCostMes.toFixed(2);
                        })()}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">üßæ IVA Trimestre:</span>
                      <span className="font-semibold text-gray-900">‚Ç¨{Math.abs(ivaP).toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between pt-2 mt-2 border-t border-gray-200">
                      <span className="font-bold text-gray-800">Total Objetivo:</span>
                      <span className="font-bold text-purple-600">
                        ‚Ç¨{(() => {
                          const hoje = new Date();
                          const mesAtual = hoje.getMonth();
                          const anoAtual = hoje.getFullYear();
                          
                          const despFixas = [...despesas, ...faturas]
                            .filter(item => {
                              const data = new Date(item.data);
                              return data.getMonth() === mesAtual && 
                                     data.getFullYear() === anoAtual && 
                                     ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(item.categoria);
                            })
                            .reduce((t, i) => t + (i.valor || i.total || 0), 0);
                          
                          const vendasMes = vendas.filter(v => {
                            const dataVenda = new Date(v.data);
                            return dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual;
                          });
                          
                          let foodCostMes = 0;
                          vendasMes.forEach(venda => {
                            const produto = produtos.find(p => p.id === venda.produtoId);
                            if (produto && produto.custoReceita) {
                              foodCostMes += produto.custoReceita * venda.quantidade;
                            }
                          });
                          
                          return (despFixas + foodCostMes + Math.abs(ivaP) + ordenadoObjetivo).toFixed(2);
                        })()}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Google Drive Sync - Header */}
            <div className="flex items-center gap-3">
              {driveAccessToken ? (
                <>
                  {/* üÜï Indicador de Status do Drive - CLIC√ÅVEL para renovar */}
                  <button
                    onClick={loginGoogleDrive}
                    className={`backdrop-blur-sm rounded-lg px-3 py-2 border-2 flex items-center gap-2 transition hover:scale-105 ${
                      driveTokenValid 
                        ? 'bg-green-500/20 border-green-300 hover:bg-green-500/30' 
                        : driveTokenTimeLeft > 0 
                          ? 'bg-yellow-500/20 border-yellow-300 hover:bg-yellow-500/30' 
                          : 'bg-red-500/20 border-red-300 hover:bg-red-500/30'
                    }`}
                    title={driveTokenValid 
                      ? 'Clique para renovar token (mesmo que ainda v√°lido)' 
                      : driveTokenTimeLeft > 0 
                        ? `Token expira em ${driveTokenTimeLeft}min - Clique para renovar agora!` 
                        : 'Token expirado - Clique para renovar'}
                  >
                    <div className={`w-2 h-2 rounded-full ${
                      driveTokenValid 
                        ? 'bg-green-400' 
                        : driveTokenTimeLeft > 0 
                          ? 'bg-yellow-400 animate-pulse' 
                          : 'bg-red-400'
                    }`}></div>
                    <div className="text-xs font-semibold text-white">
                      {driveTokenValid 
                        ? 'üîì Drive OK' 
                        : driveTokenTimeLeft > 0 
                          ? `‚ö†Ô∏è ${driveTokenTimeLeft}min` 
                          : 'üîí Expirado'}
                    </div>
                  </button>
                  
                  <button
                    onClick={() => saveToDrive(true)}
                    disabled={driveSyncing || driveTokenTimeLeft === 0}
                    className="bg-white/20 hover:bg-white/30 disabled:bg-white/10 backdrop-blur-sm text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm"
                    title={driveTokenTimeLeft === 0 
                      ? 'Token expirado - Clique no indicador verde/amarelo para renovar' 
                      : 'Sincronizar manualmente com Google Drive (com backup completo)'}
                  >
                    <RefreshCw className={`w-4 h-4 ${driveSyncing ? 'animate-spin' : ''}`} />
                    <span className="hidden sm:inline">{driveSyncing ? 'A sincronizar...' : 'Sync Manual'}</span>
                  </button>
                </>
              ) : (
                <button
                  onClick={() => {
                    setActiveTab('definicoes');
                    setBackupExpanded(true); // ‚úÖ ABRIR DROPDOWN AUTOMATICAMENTE

                    setTimeout(() => {
                      const driveSection = document.getElementById('google-drive-section');
                      if (driveSection) {
                        driveSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                      }
                    }, 100);
                  }}
                  className="bg-yellow-500/90 hover:bg-yellow-600 backdrop-blur-sm text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm"
                  title="Conectar Google Drive"
                >
                  <AlertCircle className="w-4 h-4" />
                  <span className="hidden sm:inline">Conectar Drive</span>
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Storage indicator removido - n√£o √© necess√°rio */}

        {/* Main Tabs */}
        <div className={`rounded-lg shadow mb-3 bg-white`}>
          <div className="flex">
            {tabs.map(t => {
              const Icon = t.icon;
              return (
                <button key={t.id} onClick={() => setActiveTab(t.id)}
                  className={`flex items-center gap-2 px-5 py-3 rounded-xl font-semibold transition-all duration-300 text-sm ${
                    activeTab === t.id ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' : 'text-gray-600 hover:bg-white/80'
                  }`}>
                  <Icon size={16} />{t.label}
                </button>
              );
            })}
          </div>
        </div>

        {activeTab === 'dashboard' && (
          <div className="space-y-3">
            {/* Dashboard Sub-tabs */}
            <div className="backdrop-blur-lg bg-white/60 border border-white/40 rounded-xl shadow-lg">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'resumo', label: 'Resumo', icon: BarChart3 },
                  { id: 'metricas', label: 'M√©tricas', icon: Target },
                  { id: 'compras', label: 'Compras', icon: TrendingUp },
                  ...(deliveryApps.some(app => app.ativo) ? [{ id: 'delivery', label: 'Delivery', icon: TrendingUp }] : []),
                  { id: 'simuladores', label: 'Simuladores', icon: Calculator }
                ].map(tab => {
                  const Icon = tab.icon;
                  return (
                    <button key={tab.id} onClick={() => setDashboardSubTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 font-medium text-xs transition ${
                        dashboardSubTab === tab.id ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'
                      }`}>
                      <Icon size={14} />{tab.label}
                    </button>
                  );
                })}
              </div>
            </div>

            

            {dashboardSubTab === 'resumo' && (
              <>
            {/* Date Filter - VERS√ÉO MELHORADA */}
            <div className="backdrop-blur-lg bg-white/80 border border-white/60 rounded-2xl shadow-xl p-5">
              <div className="flex flex-col gap-4">
                {/* Bot√µes de per√≠odo */}
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => setDateFilter('all')}
                    className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                      dateFilter === 'all' 
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                    }`}
                  >
                    üìä Tudo
                  </button>

                  <button
                    onClick={() => setDateFilter('week')}
                    className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                      dateFilter === 'week' 
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                    }`}
                  >
                    üìÖ Semana
                  </button>

                  <button
                    onClick={() => setDateFilter('month')}
                    className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                      dateFilter === 'month' 
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                    }`}
                  >
                    üóìÔ∏è M√™s
                  </button>

                  <button
                    onClick={() => setDateFilter('year')}
                    className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                      dateFilter === 'year' 
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                    }`}
                  >
                    üìÜ Ano
                  </button>

                  <button
                    onClick={() => setDateFilter('lastYear')}
                    className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                      dateFilter === 'lastYear' 
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                    }`}
                  >
                    üïê √öltimo Ano
                  </button>

                  <button
                    onClick={() => setDateFilter('custom')}
                    className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                      dateFilter === 'custom' 
                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                    }`}
                  >
                    ‚öôÔ∏è Personalizado
                  </button>
                </div>

                {/* Sele√ß√£o de datas personalizadas */}
                {dateFilter === 'custom' && (
                  <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200">
                    <div className="flex items-center gap-2">
                      <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span className="text-sm font-semibold text-gray-700">De:</span>
                    </div>
                    <input
                      type="date"
                      value={customStartDate}
                      onChange={(e) => setCustomStartDate(e.target.value)}
                      className="flex-1 border-2 border-purple-300 rounded-lg px-3 py-2 text-sm font-medium focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition"
                    />
                    
                    <svg className="w-5 h-5 text-gray-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>

                    <div className="flex items-center gap-2">
                      <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span className="text-sm font-semibold text-gray-700">At√©:</span>
                    </div>
                    <input
                      type="date"
                      value={customEndDate}
                      onChange={(e) => setCustomEndDate(e.target.value)}
                      className="flex-1 border-2 border-purple-300 rounded-lg px-3 py-2 text-sm font-medium focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition"
                    />
                  </div>
                )}

                {/* Info sobre o per√≠odo selecionado */}
                {dateFilter !== 'all' && (
                  <div className="flex items-center gap-3 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                      </svg>
                    </div>
                    <div className="flex-1">
                      <p className="text-sm font-bold text-gray-900">
                        {filteredVendas.length} vendas ‚Ä¢ {todasDespesas.length} despesas
                      </p>
                      <p className="text-xs text-gray-600">
                        {dateFilter === 'week' && '√öltimos 7 dias'}
                        {dateFilter === 'month' && '√öltimos 30 dias'}
                        {dateFilter === 'year' && `De 1 de Janeiro de ${new Date().getFullYear()} at√© hoje`}
                        {dateFilter === 'lastYear' && `Ano ${new Date().getFullYear() - 1} completo (1 Jan - 31 Dez)`}
                        {dateFilter === 'custom' && customStartDate && customEndDate && 
                          `De ${new Date(customStartDate).toLocaleDateString('pt-PT')} at√© ${new Date(customEndDate).toLocaleDateString('pt-PT')}`
                        }
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* KPI Cards - 2 filas de 2 */}
          
          <div className="grid grid-cols-2 lg:grid-cols-6 gap-2">
              <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg shadow p-3 text-white">
                <Tooltip text="Total de vendas no per√≠odo (COM IVA). Este √© o valor bruto antes de deduzir impostos e custos." position="bottom">
                  <p className="text-green-100 text-xs mb-1 flex items-center gap-1">
                    Fatura√ß√£o Bruta
                    <span className="text-green-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className="text-xl font-bold">‚Ç¨{totV.toFixed(2)}</p>
                <p className="text-green-100 text-xs">‚Ç¨{medFat.toFixed(2)}/dia</p>
              </div>

              <div className="bg-gradient-to-br from-red-500 to-pink-600 rounded-lg shadow p-3 text-white">
                <div className="flex items-center justify-between mb-1">
                  <Tooltip text="Total de todas as despesas: fixas (renda, sal√°rios) + vari√°veis (ingredientes, utilities). Quanto mais baixas, maior o lucro." position="bottom">
                    <p className="text-red-100 text-xs mb-0 flex items-center gap-1">
                      Despesas (com IVA)
                      <span className="text-red-300 text-sm">‚ìò</span>
                    </p>
                  </Tooltip>
                  <div className="flex items-center gap-1">
                    {(() => {
                      const ratioDespesaFaturacao = totV > 0 ? (totD / totV) * 100 : 0;
                      const limiteArtigo53 = 15000;
                      const percentualLimite = (totalVendasAnoAtual / limiteArtigo53) * 100;
                      
                      return (
                        <>
                          {/* Alerta de Limite IVA 2026 (Artigo 53) */}
                          {totalVendasAnoAtual >= limiteArtigo53 * 0.8 && (
                            <Tooltip text={`‚ö†Ô∏è LIMITE IVA ${anoAtual}: Atingiu ‚Ç¨${totalVendasAnoAtual.toFixed(0)} (${percentualLimite.toFixed(0)}%) de ‚Ç¨${limiteArtigo53.toLocaleString()}. ${totalVendasAnoAtual >= limiteArtigo53 ? 'Limite ultrapassado! Deve passar para Contabilidade Organizada.' : 'Est√° pr√≥ximo do limite do regime simplificado (Artigo 53). Acima de ‚Ç¨15.000 deve passar para Contabilidade Organizada.'}`} position="left">
                              <span className={`${totalVendasAnoAtual >= limiteArtigo53 ? 'text-red-300' : 'text-yellow-300'} text-lg animate-pulse cursor-help`}>
                                {totalVendasAnoAtual >= limiteArtigo53 ? 'üö®' : '‚ö†Ô∏è'}
                              </span>
                            </Tooltip>
                          )}
                          
                          {/* Alerta de Despesas > 40% */}
                          {ratioDespesaFaturacao >= 40 && (
                            <Tooltip text="‚ö†Ô∏è ALERTA: As suas despesas representam mais de 40% da fatura√ß√£o. Considere passar para Contabilidade Organizada para recuperar todo o IVA das despesas e otimizar a carga fiscal." position="left">
                              <span className="text-yellow-300 text-lg animate-pulse cursor-help">‚ö†Ô∏è</span>
                            </Tooltip>
                          )}
                        </>
                      );
                    })()}
                    <button
                      onClick={() => setShowDespesasDetails(!showDespesasDetails)}
                      className="text-red-100 hover:text-white hover:bg-red-600 rounded p-1 transition"
                      title={showDespesasDetails ? "Recolher detalhes" : "Ver detalhes"}
                    >
                      {showDespesasDetails ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                    </button>
                  </div>
                </div>
                <p className="text-xl font-bold">‚Ç¨{totD.toFixed(2)}</p>
                <p className="text-red-100 text-xs">Sem IVA: ‚Ç¨{despesasSemIva.toFixed(2)}</p>
              </div>

              {/* üÜï CARD EXPANS√çVEL DO LUCRO L√çQUIDO */}
              <div 
                className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-xl transition-all"
                onClick={() => setMostrarBreakdownFinanceiro(!mostrarBreakdownFinanceiro)}
              >
                <div className="flex items-start justify-between">
                  <Tooltip text="Clica para ver como √© calculado. Fatura√ß√£o L√≠quida (sem IVA) - Food Cost - Despesas = Lucro Real." position="bottom">
                    <p className="text-blue-100 text-xs mb-1 flex items-center gap-1">
                      Lucro L√≠quido
                      <span className="text-blue-300 text-sm">‚ìò</span>
                    </p>
                  </Tooltip>
                  <div className="text-blue-200">
                    {mostrarBreakdownFinanceiro ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                  </div>
                </div>
                <p className={`text-xl font-bold ${lucroLiquido >= 0 ? '' : 'text-red-200'}`}>
                  ‚Ç¨{lucroLiquido.toFixed(2)}
                </p>
                <p className="text-blue-100 text-xs">
                  {margemLiquida.toFixed(1)}% margem
                </p>
              </div>

              {/* üÜï CARD DE MARGEM BRUTA */}
              <div className="bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg shadow p-3 text-white">
                <Tooltip text="Fatura√ß√£o L√≠quida (sem IVA) - Food Cost = Dinheiro dispon√≠vel antes de pagar despesas operacionais." position="bottom">
                  <p className="text-teal-100 text-xs mb-1 flex items-center gap-1">
                    Margem Bruta
                    <span className="text-teal-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className="text-xl font-bold">
                  ‚Ç¨{margemBruta.toFixed(2)}
                </p>
                <p className="text-teal-100 text-xs">
                  {margemBrutaPercentage.toFixed(1)}% da fatura√ß√£o
                </p>
              </div>

              <div className="bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg shadow p-3 text-white">
                <div className="flex items-center justify-between mb-1">
                  <Tooltip text="IVA a pagar/receber no ano. Calculado como: IVA cobrado nas vendas - IVA pago nas compras. Valor positivo = tens de pagar ao estado." position="bottom">
                    <p className="text-orange-100 text-xs mb-0 flex items-center gap-1">
                      IVA {ivaP >= 0 ? 'Pagar' : 'Receber'} Q{quarter}/{currentYear}
                      <span className="text-orange-300 text-sm">‚ìò</span>
                    </p>
                  </Tooltip>
                  <button
                    onClick={() => setShowIVADetails(!showIVADetails)}
                    className="text-orange-100 hover:text-white hover:bg-orange-600 rounded p-1 transition"
                    title={showIVADetails ? "Recolher detalhes" : "Ver detalhes"}
                  >
                    {showIVADetails ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                  </button>
                </div>
                <p className="text-xl font-bold">‚Ç¨{Math.abs(ivaP).toFixed(2)}</p>
                <p className="text-orange-100 text-xs">{ivaP >= 0 ? 'Entregar' : 'Cr√©dito'}</p>
              </div>
              
              {/* üÜï CARD DE DESPERD√çCIO */}
              <div className={`bg-gradient-to-br rounded-lg shadow p-3 text-white ${
                indiceDesperdicio.desperdicioPercent > 15 ? 'from-red-500 to-red-700' :
                indiceDesperdicio.desperdicioPercent > 10 ? 'from-yellow-500 to-orange-600' :
                'from-purple-500 to-purple-700'
              }`}>
                <Tooltip text="Desperd√≠cio = Total Compras - Custo Real das Vendas. Inclui stock n√£o vendido, desperd√≠cio real, e perdas. Ideal: 5-10%" position="bottom">
                  <p className="text-purple-100 text-xs mb-1 flex items-center gap-1">
                    Desperd√≠cio
                    <span className="text-purple-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className="text-xl font-bold">
                  {indiceDesperdicio.desperdicioPercent.toFixed(1)}%
                </p>
                <p className="text-purple-100 text-xs">
                  {indiceDesperdicio.status === 'alto' ? '‚ö†Ô∏è Alto' : '‚úÖ Normal'}
                </p>
              </div>
            </div>
            
            {/* üí∞ BREAKDOWN FINANCEIRO EXPANS√çVEL */}
            {mostrarBreakdownFinanceiro && (
              <div className="backdrop-blur-lg bg-gradient-to-br from-blue-50/90 to-indigo-50/90 border-2 border-blue-300/50 rounded-2xl shadow-xl p-4 animate-fadeIn">
                <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  üí∞ Como √© Calculado o Lucro Real
                </h3>
                
                <div className="space-y-2 text-xs">
                  <div className="flex items-start gap-2">
                    <span className="text-green-600 font-bold mt-0.5">1.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Fatura√ß√£o Bruta:</span>
                      <span className="text-gray-600"> ‚Ç¨{totV.toFixed(2)} (com IVA)</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2">
                    <span className="text-blue-600 font-bold mt-0.5">2.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Deduzir IVA das vendas:</span>
                      <span className="text-gray-600"> -‚Ç¨{ivaVendasPeriodo.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 border-l-2 border-blue-300">
                    <span className="text-blue-700 font-bold">‚Üí</span>
                    <div>
                      <span className="font-semibold text-blue-700">Fatura√ß√£o L√≠quida (sem IVA):</span>
                      <span className="text-blue-800 font-bold"> ‚Ç¨{faturacaoSemIva.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 mt-3">
                    <span className="text-orange-600 font-bold mt-0.5">3.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Deduzir Food Cost:</span>
                      <span className="text-gray-600"> -‚Ç¨{custoRealVendas.toFixed(2)} ({foodCostPercentage.toFixed(1)}%)</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 border-l-2 border-teal-300">
                    <span className="text-teal-700 font-bold">‚Üí</span>
                    <div>
                      <span className="font-semibold text-teal-700">Margem Bruta:</span>
                      <span className="text-teal-800 font-bold"> ‚Ç¨{margemBruta.toFixed(2)}</span>
                      <span className="text-teal-600 text-xs"> ({margemBrutaPercentage.toFixed(1)}%)</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 mt-3">
                    <span className="text-red-600 font-bold mt-0.5">4.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Deduzir Despesas Operacionais (sem IVA):</span>
                      <span className="text-gray-600"> -‚Ç¨{despesasSemIva.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 ml-5 text-xs text-gray-500 italic">
                    <span>‚Ü≥</span>
                    <div>
                      <span>Total despesas: ‚Ç¨{totD.toFixed(2)} - IVA dedut√≠vel: ‚Ç¨{ivaTotalDespesas.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 border-l-2 border-green-400 bg-green-50 -mx-2 px-4 py-2 rounded">
                    <span className="text-green-700 font-bold text-base">‚úì</span>
                    <div>
                      <span className="font-bold text-green-800 text-sm">Lucro L√≠quido Real:</span>
                      <span className={`font-bold text-base ml-2 ${lucroLiquido >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                        ‚Ç¨{lucroLiquido.toFixed(2)}
                      </span>
                      <span className="text-green-600 text-xs ml-1">({margemLiquida.toFixed(1)}% margem)</span>
                    </div>
                  </div>
                </div>
                
                <div className="mt-3 pt-3 border-t border-blue-200">
                  <p className="text-xs text-gray-600 flex items-start gap-1">
                    <span className="text-blue-600 font-bold">üí°</span>
                    <span>
                      <span className="font-semibold">Nota:</span> Este √© o dinheiro real que sobra para lucros, impostos sobre lucros (IRC), 
                      e reinvestimento no neg√≥cio. O IVA n√£o √© inclu√≠do aqui porque √© um imposto "neutro" - o que cobras dos clientes 
                      entregas ao estado (deduzindo o IVA que j√° pagaste nas compras).
                    </span>
                  </p>
                </div>
              </div>
            )}
            
            {/* üßæ DETALHES DO IVA EXPANS√çVEL */}
            {showIVADetails && (
              <div className="backdrop-blur-lg bg-gradient-to-br from-orange-50/90 to-amber-50/90 border-2 border-orange-300/50 rounded-2xl shadow-xl p-4 animate-fadeIn">
                <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  üßæ Pr√≥xima Entrega de IVA
                </h3>
                
                {/* Layout Horizontal Compacto - Resumo e Prazo lado a lado */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-3">
                  {/* Resumo do Trimestre */}
                  <div className="bg-white rounded-lg p-3 border border-orange-200">
                    <p className="text-xs font-semibold text-gray-700 mb-2">
                      {quarter}¬∫ Trimestre {currentYear}
                    </p>
                    <div className="space-y-1.5">
                      <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-600">IVA Vendas:</span>
                        <span className="text-sm font-bold text-green-600">‚Ç¨{ivaV.toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-600">IVA Dedut√≠vel:</span>
                        <span className="text-sm font-bold text-blue-600">-‚Ç¨{ivaCompras.toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between items-center pt-1.5 border-t-2 border-orange-300 mt-1.5">
                        <span className="text-sm font-bold text-gray-700">A {ivaP >= 0 ? 'Pagar' : 'Receber'}:</span>
                        <span className={`text-lg font-bold ${ivaP >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                          ‚Ç¨{Math.abs(ivaP).toFixed(2)}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Prazo de Entrega */}
                  <div className="bg-gradient-to-br from-orange-100 to-amber-100 rounded-lg p-3 border border-orange-300">
                    <p className="text-xs font-bold text-orange-900 mb-2">
                      üìÖ Prazo de Entrega
                    </p>
                    <div className="space-y-1.5">
                      <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-700">Data limite:</span>
                        <span className="text-xs font-bold text-orange-800">
                          {(() => {

                            let deadlineMonth, deadlineYear;
                            if (quarter === 1) {
                              deadlineMonth = 4; // 20 de maio (m√™s 4 = maio, 0-indexed)
                              deadlineYear = currentYear;
                            } else if (quarter === 2) {
                              deadlineMonth = 7; // 20 de agosto
                              deadlineYear = currentYear;
                            } else if (quarter === 3) {
                              deadlineMonth = 10; // 20 de novembro
                              deadlineYear = currentYear;
                            } else {
                              deadlineMonth = 1; // 20 de fevereiro do ano seguinte
                              deadlineYear = currentYear + 1;
                            }
                            const prazo = new Date(deadlineYear, deadlineMonth, 20);
                            return prazo.toLocaleDateString('pt-PT', { day: 'numeric', month: 'short' });
                          })()}
                        </span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-700">Tempo restante:</span>
                        <span className="text-xs font-bold text-orange-800">
                          {(() => {
                            const hoje = new Date();
                            let deadlineMonth, deadlineYear;
                            if (quarter === 1) {
                              deadlineMonth = 4;
                              deadlineYear = currentYear;
                            } else if (quarter === 2) {
                              deadlineMonth = 7;
                              deadlineYear = currentYear;
                            } else if (quarter === 3) {
                              deadlineMonth = 10;
                              deadlineYear = currentYear;
                            } else {
                              deadlineMonth = 1;
                              deadlineYear = currentYear + 1;
                            }
                            const prazo = new Date(deadlineYear, deadlineMonth, 20);
                            const diffTime = prazo - hoje;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return diffDays > 0 ? `${diffDays} dias` : 'EXPIRADO!';
                          })()}
                        </span>
                      </div>
                      <div className="pt-1.5 border-t border-orange-300 mt-1.5">
                        <p className="text-xs text-gray-700 text-center">
                          Declara√ß√£o dia <span className="font-bold">20</span> ‚Ä¢ Pagamento dia <span className="font-bold">25</span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* Nota Informativa - Compacta */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-2.5 mb-3">
                  <p className="text-xs text-blue-800">
                    <span className="font-semibold">üí° IVA Dedut√≠vel:</span> Apenas FT ou FR (n√£o FS) ‚Ä¢ 
                    <span className="font-semibold"> Regime Trimestral:</span> 4x/ano (volume &lt; ‚Ç¨650k)
                  </p>
                </div>
                
                {/* üìä HIST√ìRICO DE TRIMESTRES DO ANO ANTERIOR */}
                <div className="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-3">
                  <h4 className="text-xs font-bold text-gray-800 mb-2 flex items-center gap-2">
                    üìä Hist√≥rico IVA {anoAnterior}
                  </h4>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                    {historicoAnoAnterior.map(h => (
                      <div 
                        key={h.trimestre}
                        className="rounded-lg p-2 bg-white border border-gray-200 hover:border-purple-300 transition-all"
                      >
                        <div className="flex items-center justify-between mb-1.5">
                          <span className="text-xs font-bold px-1.5 py-0.5 rounded bg-purple-100 text-purple-700">
                            Q{h.trimestre}
                          </span>
                          <p className={`text-xs font-bold ${h.tipo === 'pagar' ? 'text-red-600' : 'text-green-600'}`}>
                            ‚Ç¨{Math.abs(h.ivaPagar).toFixed(0)}
                          </p>
                        </div>
                        <div className="space-y-0.5 text-xs">
                          <div className="flex justify-between">
                            <span className="text-gray-500">Vendas:</span>
                            <span className="font-semibold text-green-700">‚Ç¨{h.ivaVendas.toFixed(0)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-500">Deduz:</span>
                            <span className="font-semibold text-blue-700">‚Ç¨{h.ivaCompras.toFixed(0)}</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="mt-2 pt-2 border-t border-purple-200 bg-white rounded-lg p-2">
                    <div className="flex justify-between items-center text-xs font-bold">
                      <span className="text-gray-700">üí∞ Total {anoAnterior}:</span>
                      <span className={historicoAnoAnterior.reduce((s, h) => s + h.ivaPagar, 0) >= 0 ? 'text-red-600' : 'text-green-600'}>
                        ‚Ç¨{Math.abs(historicoAnoAnterior.reduce((s, h) => s + h.ivaPagar, 0)).toFixed(2)}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* üìä BREAKDOWN DE DESPESAS EXPANS√çVEL */}
            {showDespesasDetails && (
              <div className="backdrop-blur-lg bg-gradient-to-br from-red-50/90 to-pink-50/90 border-2 border-red-300/50 rounded-2xl shadow-xl p-4 animate-fadeIn">
                <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  üìä Breakdown de Despesas
                </h3>
                
                {(() => {

                  const despesasPorCategoria = {};
                  
                  todasDespesas.forEach(d => {

                    if (d.origem === 'fatura') {
                      const tipo = d.tipo;
                      let incluir = false;
                      if (tipo === 'FT' && configuracoes.metricas?.incluirFT !== false) incluir = true;
                      if (tipo === 'FR' && configuracoes.metricas?.incluirFR !== false) incluir = true;
                      if (tipo === 'FS' && configuracoes.metricas?.incluirFS !== false) incluir = true;

                      if (!tipo || (tipo !== 'FT' && tipo !== 'FR' && tipo !== 'FS')) {
                        incluir = true;
                      }
                      
                      if (!incluir) return; // Pular esta despesa
                    }
                    
                    const cat = d.categoria || 'outros';
                    if (!despesasPorCategoria[cat]) {
                      despesasPorCategoria[cat] = {
                        total: 0,
                        itens: 0
                      };
                    }
                    despesasPorCategoria[cat].total += d.valor;
                    despesasPorCategoria[cat].itens += 1;
                  });

                  const categoriasOrdenadas = Object.entries(despesasPorCategoria)
                    .sort(([, a], [, b]) => b.total - a.total);

                  const totalGeral = totD;

                  const labelsCategorias = {
                    'compras': 'üõí Compras',
                    'compras_alimentares': 'üçΩÔ∏è Compras Alimentares',
                    'materiais_operacionais': 'üßπ Materiais Operacionais',
                    'embalagens_consumiveis': 'üì¶ Embalagens/Consum√≠veis',
                    'renda': 'üè† Renda',
                    'salarios': 'üë• Sal√°rios',
                    'eletricidade': '‚ö° Eletricidade',
                    'agua': 'üíß √Ågua',
                    'gas': 'üî• G√°s',
                    'internet': 'üåê Internet',
                    'consumiveis': 'üì¶ Consum√≠veis',
                    'marketing': 'üì¢ Marketing',
                    'manutencao': 'üîß Manuten√ß√£o',
                    'outros': 'üìã Outros'
                  };

                  const coresCategorias = {
                    'compras': 'bg-blue-600',
                    'renda': 'bg-purple-600',
                    'salarios': 'bg-green-600',
                    'eletricidade': 'bg-yellow-500',
                    'agua': 'bg-cyan-500',
                    'gas': 'bg-orange-500',
                    'internet': 'bg-indigo-500',
                    'consumiveis': 'bg-pink-500',
                    'marketing': 'bg-red-500',
                    'manutencao': 'bg-gray-600',
                    'outros': 'bg-gray-400'
                  };
                  
                  return (
                    <div className="space-y-3">
                      <div className="space-y-3 bg-white rounded-lg p-3 border border-red-200">
                        {categoriasOrdenadas.map(([categoria, dados]) => {
                          const percentagem = totalGeral > 0 ? (dados.total / totalGeral) * 100 : 0;
                          
                          return (
                            <div 
                              key={categoria} 
                              className="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition"
                              onClick={() => {

                                setCategoriaFaturaFiltro(categoria);
                                setActiveTab('gestao');
                                setGestaoSubTab('faturas');

                                setTimeout(() => {
                                  window.scrollTo({ top: 0, behavior: 'smooth' });
                                }, 100);
                              }}
                            >
                              <div className="flex-1">
                                <div className="flex justify-between items-center mb-1">
                                  <span className="text-sm font-medium hover:text-blue-600 transition">
                                    {labelsCategorias[categoria] || categoria}
                                  </span>
                                  <span className="text-sm font-bold">
                                    ‚Ç¨{dados.total.toFixed(2)}
                                  </span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                  <div 
                                    className={`${coresCategorias[categoria] || 'bg-gray-400'} h-2.5 rounded-full transition-all`}
                                    style={{ width: `${Math.min(percentagem, 100)}%` }}
                                  ></div>
                                </div>
                                <div className="flex justify-between mt-1">
                                  <span className="text-xs text-gray-500">
                                    {dados.itens} {dados.itens === 1 ? 'item' : 'itens'}
                                  </span>
                                  <span className="text-xs text-gray-500">
                                    {percentagem.toFixed(1)}%
                                  </span>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                        
                        <div className="pt-3 border-t border-gray-200">
                          <div className="flex justify-between items-center">
                            <span className="font-bold text-gray-800">Total Despesas</span>
                            <span className="font-bold text-lg text-red-600">‚Ç¨{totalGeral.toFixed(2)}</span>
                          </div>
                          {dateFilter !== 'all' && dias > 0 && (
                            <div className="text-xs text-gray-500 mt-1">
                              M√©dia di√°ria: ‚Ç¨{(totalGeral / dias).toFixed(2)}/dia
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Nota Informativa */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p className="text-xs text-blue-800 flex items-start gap-1">
                          <span className="text-blue-600 font-bold">üí°</span>
                          <span>
                            <span className="font-semibold">Gest√£o de Despesas:</span> Controlar despesas fixas (renda, sal√°rios) 
                            e vari√°veis (ingredientes, utilities) √© essencial para aumentar a rentabilidade. As despesas fixas 
                            devem representar no m√°ximo 30-40% da fatura√ß√£o para um neg√≥cio saud√°vel.
                          </span>
                        </p>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}
            
            {/* Todos os produtos e an√°lises em colunas lado a lado */}
            <div className="grid grid-cols-4 gap-2 overflow-x-auto">
              {/* Top Vendidos */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-blue-600">üèÜ Top Vendidos</h3>
                <div className="space-y-1">
                  {top5Venda.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-blue-600 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-green-600 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {top5Venda.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>
              
              {/* Top Rent√°veis */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-green-600">üíé Top Rent√°veis</h3>
                <div className="space-y-1">
                  {top5Lucro.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-green-600 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-green-700 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {top5Lucro.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>

              {/* Pior Vendidos */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-red-600">üìâ Pior Vendidos</h3>
                <div className="space-y-1">
                  {pior5Venda.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-red-400 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-red-600 font-semibold text-xs">{Math.round(d.quantidade)}un</span>
                    </div>
                  ))}
                  {pior5Venda.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>

              {/* Pior Rent√°veis */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-orange-600">‚ö†Ô∏è Pior Rent√°veis</h3>
                <div className="space-y-1">
                  {pior5Lucro.slice(0, 5).map(([n, d], i) => {
                    const mostrarTotal = d.lucro === 0 && d.total > 0;
                    return (
                      <div key={n} className="flex items-center gap-1 text-xs">
                        <span className="font-bold text-orange-400 w-4">#{i+1}</span>
                        <span className="flex-1 truncate text-gray-700" title={n}>{n}</span>
                        {mostrarTotal ? (
                          <span className="text-blue-600 font-semibold text-xs" title="Sem receita - mostrando fatura√ß√£o">‚Ç¨{d.total.toFixed(0)}*</span>
                        ) : (
                          <span className="text-orange-700 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                        )}
                      </div>
                    );
                  })}
                  {pior5Lucro.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
                {pior5Lucro.some(([n, d]) => d.lucro === 0 && d.total > 0) && (
                  <p className="text-[10px] text-gray-500 mt-2 italic">* Sem receita definida</p>
                )}
              </div>
            </div>

            {/* An√°lise Financeira - REMOVIDA (alerta movido para card de Despesas) */}

              </>
            )}

            {dashboardSubTab === 'metricas' && (
              <>
                {/* FILTRO DE PER√çODO - VERS√ÉO MELHORADA (IGUAL AO RESUMO) */}
                <div className="backdrop-blur-lg bg-white/80 border border-white/60 rounded-2xl shadow-xl p-5 mb-4">
                  <div className="flex flex-col gap-4">
                    {/* Bot√µes de per√≠odo */}
                    <div className="flex flex-wrap gap-2">
                      <button
                        onClick={() => setDateFilter('all')}
                        className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                          dateFilter === 'all' 
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                        }`}
                      >
                        üìä Tudo
                      </button>

                      <button
                        onClick={() => setDateFilter('week')}
                        className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                          dateFilter === 'week' 
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                        }`}
                      >
                        üìÖ Semana
                      </button>

                      <button
                        onClick={() => setDateFilter('month')}
                        className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                          dateFilter === 'month' 
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                        }`}
                      >
                        üóìÔ∏è M√™s
                      </button>

                      <button
                        onClick={() => setDateFilter('year')}
                        className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                          dateFilter === 'year' 
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                        }`}
                      >
                        üìÜ Ano
                      </button>

                      <button
                        onClick={() => setDateFilter('lastYear')}
                        className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                          dateFilter === 'lastYear' 
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                        }`}
                      >
                        üïê √öltimo Ano
                      </button>

                      <button
                        onClick={() => setDateFilter('custom')}
                        className={`px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 ${
                          dateFilter === 'custom' 
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' 
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200 hover:scale-105'
                        }`}
                      >
                        ‚öôÔ∏è Personalizado
                      </button>
                    </div>

                    {/* Sele√ß√£o de datas personalizadas */}
                    {dateFilter === 'custom' && (
                      <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200">
                        <div className="flex items-center gap-2">
                          <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          <label className="text-sm font-semibold text-purple-900">De:</label>
                          <input
                            type="date"
                            value={customStartDate}
                            onChange={(e) => setCustomStartDate(e.target.value)}
                            className="border-2 border-purple-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          />
                        </div>
                        
                        <div className="flex items-center gap-2">
                          <label className="text-sm font-semibold text-purple-900">At√©:</label>
                          <input
                            type="date"
                            value={customEndDate}
                            onChange={(e) => setCustomEndDate(e.target.value)}
                            className="border-2 border-purple-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          />
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* KPIs PRINCIPAIS - PROPOSTA A (FLAT DESIGN) */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-6 px-4">
                  {/* Ticket M√©dio */}
                  <div className="flex flex-col gap-1">
                    <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">üí∂ Ticket M√©dio</span>
                    <span className="text-4xl font-extrabold text-blue-600 leading-none">
                      ‚Ç¨{filteredVendas.length > 0 ? (totV / filteredVendas.length).toFixed(2) : '0.00'}
                    </span>
                    <span className="text-xs text-gray-400">por venda</span>
                  </div>

                  {/* Food Cost */}
                  <div className="flex flex-col gap-1">
                    <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">üçΩÔ∏è Food Cost</span>
                    <span className={`text-4xl font-extrabold leading-none ${
                      foodCostPercentage > 100 ? 'text-red-600 animate-pulse' :
                      foodCostPercentage > 40 ? 'text-red-600' :
                      foodCostPercentage > 35 ? 'text-orange-600' : 'text-purple-600'
                    }`}>
                      {foodCostPercentage > 100 ? '‚ö†Ô∏è ERRO' : `${foodCostPercentage.toFixed(1)}%`}
                    </span>
                    <span className="text-xs text-gray-400">ideal: 25-35%</span>
                  </div>

                  {/* Labor Cost */}
                  <div className="flex flex-col gap-1">
                    <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">üë• Labor Cost</span>
                    <span className={`text-4xl font-extrabold leading-none ${
                      laborCostPercentage > 35 ? 'text-red-600' : 
                      laborCostPercentage > 30 ? 'text-orange-600' : 'text-orange-600'
                    }`}>
                      {laborCostPercentage.toFixed(1)}%
                    </span>
                    <span className="text-xs text-gray-400">ideal: 25-30%</span>
                  </div>

                  {/* Prime Cost */}
                  <div className="flex flex-col gap-1">
                    <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">
                      ‚ö° Prime Cost <span className="text-[9px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-bold ml-1">REI</span>
                    </span>
                    <span className={`text-4xl font-extrabold leading-none ${
                      primeCostPercentage > 65 ? 'text-red-600' :
                      primeCostPercentage > 60 ? 'text-orange-600' : 'text-green-600'
                    }`}>
                      {primeCostPercentage.toFixed(1)}%
                    </span>
                    <span className="text-xs text-gray-400">ideal: 55-60%</span>
                  </div>
                </div>

                {/* GR√ÅFICOS VISUAIS */}
                <MetricasGraficos filteredVendas={filteredVendas} filteredFaturasComConfig={filteredFaturasComConfig} todasDespesas={todasDespesas} dateFilter={dateFilter} />

                {/* AN√ÅLISE DETALHADA DE PRODUTOS - DROPDOWN (s√≥ aparece quando clicar no gr√°fico) */}
                {showProdutosDetails && (
                  <div className="bg-white rounded-lg shadow p-4 mb-4">
                    <button
                      onClick={() => setShowProdutosDetails(false)}
                      className="w-full flex items-center justify-between hover:bg-gray-50 transition rounded-lg p-2 mb-4"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-lg">üìä</span>
                        <h2 className="text-lg font-bold text-gray-800">An√°lise Detalhada de Produtos</h2>
                      </div>
                      <span className="text-gray-600 text-xl">‚ñº</span>
                    </button>

                    <div>
                      {/* Tabs */}
                      <div className="flex gap-2 mb-4 border-b">
                        <button
                          onClick={() => setProdutosAnaliseTab('categorias')}
                          className={`px-4 py-2 text-sm font-semibold transition border-b-2 ${
                            produtosAnaliseTab === 'categorias'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-600 hover:text-gray-900'
                          }`}
                        >
                          üìä Por Categoria
                        </button>
                        <button
                          onClick={() => setProdutosAnaliseTab('ranking')}
                          className={`px-4 py-2 text-sm font-semibold transition border-b-2 ${
                            produtosAnaliseTab === 'ranking'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-600 hover:text-gray-900'
                          }`}
                        >
                          üìã Ranking
                        </button>
                      </div>
                      
                      {/* TAB 1: POR CATEGORIA */}
                      {produtosAnaliseTab === 'categorias' && (
                        <div>
                          <p className="text-xs text-gray-600 mb-3">üìä Clica numa categoria para ver gr√°ficos detalhados de cada produto</p>
                          
                          {(() => {

                            const vendasPorCategoria = {};
                            
                            filteredVendas.forEach(v => {
                              const produto = produtos.find(p => p.id === v.produtoId) || produtos.find(p => p.nome === v.produto);
                              const categoria = produto?.categoria || 'outros';
                              
                              if (!vendasPorCategoria[categoria]) {
                                vendasPorCategoria[categoria] = {
                                  quantidade: 0,
                                  faturacao: 0,
                                  lucro: 0,
                                  produtos: {}
                                };
                              }
                              
                              vendasPorCategoria[categoria].quantidade = Math.round((vendasPorCategoria[categoria].quantidade + v.quantidade) * 100) / 100;
                              vendasPorCategoria[categoria].faturacao = Math.round((vendasPorCategoria[categoria].faturacao + v.valor) * 100) / 100;
                              vendasPorCategoria[categoria].lucro = Math.round((vendasPorCategoria[categoria].lucro + calcLucroVenda(v).lucro) * 100) / 100;

                              if (!vendasPorCategoria[categoria].produtos[v.produto]) {
                                vendasPorCategoria[categoria].produtos[v.produto] = {
                                  nome: v.produto,
                                  quantidade: 0,
                                  faturacao: 0,
                                  lucro: 0
                                };
                              }
                              vendasPorCategoria[categoria].produtos[v.produto].quantidade += v.quantidade;
                              vendasPorCategoria[categoria].produtos[v.produto].faturacao += v.valor;
                              vendasPorCategoria[categoria].produtos[v.produto].lucro += calcLucroVenda(v).lucro;
                            });
                            
                            const categoriasComDados = Object.entries(vendasPorCategoria)
                              .filter(([_, dados]) => dados.quantidade > 0)
                              .sort((a, b) => b[1].faturacao - a[1].faturacao);
                            
                            if (categoriasComDados.length === 0) {
                              return (
                                <div className="text-center py-8 bg-gray-50 rounded-lg">
                                  <p className="text-gray-600">üì¶ Sem vendas no per√≠odo selecionado</p>
                                  <p className="text-xs text-gray-500 mt-2">Adicione produtos com categorias para ver m√©tricas</p>
                                </div>
                              );
                            }
                            
                            return (
                              <div className="space-y-3">
                                {categoriasComDados.map(([cat, dados]) => {
                                  const info = CATEGORIAS_PRODUTOS[cat] || { nome: cat, cor: 'gray', emoji: 'üìã' };
                                  const margemPerc = dados.faturacao > 0 ? (dados.lucro / dados.faturacao) * 100 : 0;
                                  const isExpanded = categoriaExpandida === cat;

                                  const produtosArray = Object.values(dados.produtos).sort((a, b) => b.quantidade - a.quantidade);
                                  const maxQuantidade = Math.max(...produtosArray.map(p => p.quantidade));
                                  
                                  return (
                                    <div key={cat} className="bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-300 rounded-xl overflow-hidden">
                                      {/* HEADER - Bot√£o da Categoria */}
                                      <button
                                        onClick={() => setCategoriaExpandida(isExpanded ? null : cat)}
                                        className="w-full p-4 flex items-center justify-between hover:bg-gray-200/50 transition"
                                      >
                                        <div className="flex items-center gap-3">
                                          <span className="text-2xl">{info.emoji}</span>
                                          <div className="text-left">
                                            <h3 className="text-lg font-bold text-gray-900">{info.nome}</h3>
                                            <p className="text-xs text-gray-600">
                                              {Math.round(dados.quantidade)} unidades ‚Ä¢ ‚Ç¨{dados.faturacao.toFixed(0)} ‚Ä¢ {margemPerc.toFixed(1)}% margem
                                            </p>
                                          </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                          <div className="text-right">
                                            <div className="text-2xl font-bold text-gray-900">{produtosArray.length}</div>
                                            <div className="text-xs text-gray-600">produtos</div>
                                          </div>
                                          <span className="text-2xl text-gray-600">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                        </div>
                                      </button>
                                      
                                      {/* DETALHES EXPANDIDOS - Gr√°ficos por Produto */}
                                      {isExpanded && (
                                        <div className="p-4 bg-white border-t-2 border-gray-300">
                                          <h4 className="text-sm font-bold text-gray-800 mb-3">üìä Vendas por Produto</h4>
                                          
                                          <div className="space-y-3">
                                            {produtosArray.map((prod, index) => {
                                              const margemProd = prod.faturacao > 0 ? (prod.lucro / prod.faturacao) * 100 : 0;

                                              const vendasProduto = filteredVendas.filter(v => v.produto === prod.nome);

                                              const vendasPorDia = {};
                                              vendasProduto.forEach(v => {
                                                const dataVenda = new Date(v.data);
                                                const dataKey = `${dataVenda.getFullYear()}-${String(dataVenda.getMonth() + 1).padStart(2, '0')}-${String(dataVenda.getDate()).padStart(2, '0')}`;
                                                
                                                if (!vendasPorDia[dataKey]) {
                                                  vendasPorDia[dataKey] = 0;
                                                }
                                                vendasPorDia[dataKey] += v.quantidade;
                                              });

                                              const datasOrdenadas = Object.keys(vendasPorDia).sort();
                                              const quantidades = datasOrdenadas.map(d => vendasPorDia[d]);
                                              const maxQtd = Math.max(...quantidades, 1);
                                              
                                              return (
                                                <div key={prod.nome} className="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 transition">
                                                  {/* Nome e Posi√ß√£o */}
                                                  <div className="flex items-start justify-between mb-2">
                                                    <div className="flex items-center gap-2">
                                                      <span className="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                        #{index + 1}
                                                      </span>
                                                      <span className="text-sm font-bold text-gray-900">{prod.nome}</span>
                                                    </div>
                                                    <span className="text-lg font-bold text-blue-600">{Math.round(prod.quantidade)}</span>
                                                  </div>
                                                  
                                                  {/* GR√ÅFICO DE LINHA - Evolu√ß√£o Temporal */}
                                                  <div className="mb-3 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-3 border border-purple-200">
                                                    <div className="flex items-center justify-between mb-2">
                                                      <span className="text-xs font-semibold text-purple-900">üìà Evolu√ß√£o de Vendas</span>
                                                      <span className="text-xs text-purple-700">{datasOrdenadas.length} dia{datasOrdenadas.length !== 1 ? 's' : ''}</span>
                                                    </div>
                                                    
                                                    {datasOrdenadas.length > 0 ? (
                                                      <div style={{position: 'relative', height: '140px', width: '100%', paddingBottom: '20px'}}>
                                                        {/* SVG para a linha e √°rea (com aspecto distorcido) */}
                                                        <svg 
                                                          width="100%" 
                                                          height="140" 
                                                          viewBox="0 0 100 100" 
                                                          preserveAspectRatio="none"
                                                          style={{display: 'block', position: 'absolute', top: 0, left: 0, paddingLeft: '5px', paddingRight: '5px', boxSizing: 'border-box'}}
                                                        >
                                                          <defs>
                                                            {/* Gradient FORTE para a linha (azul brilhante ‚Üí rosa/roxo) */}
                                                            <linearGradient id={`line-gradient-${index}`} x1="0%" y1="0%" x2="100%" y2="0%">
                                                              <stop offset="0%" stopColor="#3b82f6" />
                                                              <stop offset="30%" stopColor="#6366f1" />
                                                              <stop offset="60%" stopColor="#8b5cf6" />
                                                              <stop offset="100%" stopColor="#d946ef" />
                                                            </linearGradient>
                                                            
                                                            {/* Gradient para a √°rea (vertical - roxo transparente) */}
                                                            <linearGradient id={`area-gradient-${index}`} x1="0%" y1="0%" x2="0%" y2="100%">
                                                              <stop offset="0%" stopColor="#8b5cf6" stopOpacity="0.4" />
                                                              <stop offset="100%" stopColor="#8b5cf6" stopOpacity="0.05" />
                                                            </linearGradient>
                                                          </defs>
                                                          
                                                          {/* Grid horizontal */}
                                                          <line x1="2.5" y1="85" x2="97.5" y2="85" stroke="rgba(139, 92, 246, 0.1)" strokeWidth="0.3" vectorEffect="non-scaling-stroke" />
                                                          <line x1="2.5" y1="42.5" x2="97.5" y2="42.5" stroke="rgba(139, 92, 246, 0.05)" strokeWidth="0.3" strokeDasharray="1,1" vectorEffect="non-scaling-stroke" />
                                                          
                                                          {(() => {

                                                            const pontos = quantidades.map((qtd, i) => ({
                                                              x: 2.5 + (i / Math.max(quantidades.length - 1, 1)) * 95,
                                                              y: 85 - ((qtd / maxQtd) * 80),
                                                              qtd,
                                                              data: datasOrdenadas[i]
                                                            }));

                                                            const linePath = pontos.map((p, i) => 
                                                              `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
                                                            ).join(' ');

                                                            const areaPath = `${linePath} L 97.5 90 L 2.5 90 Z`;
                                                            
                                                            return (
                                                              <>
                                                                {/* √Årea preenchida */}
                                                                <path
                                                                  d={areaPath}
                                                                  fill={`url(#area-gradient-${index})`}
                                                                />
                                                                
                                                                {/* Linha principal GROSSA com gradient FORTE azul‚Üírosa */}
                                                                <path
                                                                  d={linePath}
                                                                  fill="none"
                                                                  stroke={`url(#line-gradient-${index})`}
                                                                  strokeWidth="2"
                                                                  strokeLinejoin="round"
                                                                  strokeLinecap="round"
                                                                  vectorEffect="non-scaling-stroke"
                                                                />
                                                              </>
                                                            );
                                                          })()}
                                                        </svg>
                                                        
                                                        {/* SVG separado para os pontos (SEM distor√ß√£o) */}
                                                        <svg 
                                                          width="100%" 
                                                          height="140"
                                                          style={{display: 'block', position: 'absolute', top: 0, left: 0, pointerEvents: 'none', paddingLeft: '5px', paddingRight: '5px', boxSizing: 'border-box'}}
                                                        >
                                                          {quantidades.map((qtd, i) => {

                                                            const xPercent = 2.5 + (i / Math.max(quantidades.length - 1, 1)) * 95;
                                                            const yPercent = 85 - ((qtd / maxQtd) * 80);
                                                            
                                                            return (
                                                              <circle
                                                                key={i}
                                                                cx={`${xPercent}%`}
                                                                cy={`${yPercent * 1.4}px`}
                                                                r="5"
                                                                fill="white"
                                                                stroke="#8b5cf6"
                                                                strokeWidth="2.5"
                                                                style={{pointerEvents: 'all', cursor: 'pointer'}}
                                                              >
                                                                <title>{datasOrdenadas[i]}: {Math.round(qtd)} un</title>
                                                              </circle>
                                                            );
                                                          })}
                                                        </svg>
                                                        
                                                        {/* Labels das datas em baixo (estilo Chart.js) */}
                                                        <div style={{
                                                          position: 'absolute',
                                                          bottom: '0px',
                                                          left: 0,
                                                          right: 0,
                                                          height: '20px',
                                                          display: 'flex',
                                                          fontSize: '9px',
                                                          color: '#666',
                                                          fontWeight: '400'
                                                        }}>
                                                          {quantidades.map((qtd, i) => {

                                                            const xPercent = 2.5 + (i / Math.max(quantidades.length - 1, 1)) * 95;

                                                            const mostrar = datasOrdenadas.length <= 15 || i % Math.ceil(datasOrdenadas.length / 10) === 0;
                                                            
                                                            if (!mostrar) return null;
                                                            
                                                            return (
                                                              <div
                                                                key={i}
                                                                style={{
                                                                  position: 'absolute',
                                                                  left: `${xPercent}%`,
                                                                  transform: 'translateX(-50%)',
                                                                  whiteSpace: 'nowrap',
                                                                  fontSize: '9px'
                                                                }}
                                                              >
                                                                {datasOrdenadas[i]}
                                                              </div>
                                                            );
                                                          })}
                                                        </div>
                                                        
                                                        {/* Escala Y (quantidades) */}
                                                        <div style={{
                                                          position: 'absolute',
                                                          left: '-35px',
                                                          top: 0,
                                                          bottom: '20px',
                                                          display: 'flex',
                                                          flexDirection: 'column',
                                                          justifyContent: 'space-between',
                                                          fontSize: '10px',
                                                          color: '#666',
                                                          textAlign: 'right'
                                                        }}>
                                                          <span>{Math.round(maxQtd)}</span>
                                                          <span>{Math.round(maxQtd / 2)}</span>
                                                          <span>0</span>
                                                        </div>
                                                      </div>
                                                    ) : (
                                                      <div className="text-center py-4 text-xs text-gray-400">
                                                        Sem dados temporais
                                                      </div>
                                                    )}
                                                  </div>
                                                  
                                                  {/* M√©tricas - 4 colunas (Fatura√ß√£o, Lucro, Margem, Extras) */}
                                                  {(() => {

                                                    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                                                    const vendasPorDiaSemana = {};
                                                    
                                                    vendasProduto.forEach(v => {
                                                      const data = new Date(v.data);
                                                      const diaSemana = diasSemana[data.getDay()];
                                                      if (!vendasPorDiaSemana[diaSemana]) {
                                                        vendasPorDiaSemana[diaSemana] = { total: 0, dias: 0 };
                                                      }
                                                      vendasPorDiaSemana[diaSemana].total += v.quantidade;
                                                      vendasPorDiaSemana[diaSemana].dias += 1;
                                                    });

                                                    const mediasPorDia = Object.entries(vendasPorDiaSemana)
                                                      .filter(([dia]) => dia !== 'Qua') // ‚ö†Ô∏è EXCLUIR QUARTAS-FEIRAS
                                                      .map(([dia, stats]) => ({
                                                        dia,
                                                        media: stats.total / stats.dias
                                                      }));
                                                    
                                                    const melhorDiaSemana = mediasPorDia.length > 0 
                                                      ? mediasPorDia.reduce((max, curr) => curr.media > max.media ? curr : max)
                                                      : null;
                                                    
                                                    const piorDiaSemana = mediasPorDia.length > 0
                                                      ? mediasPorDia.reduce((min, curr) => curr.media < min.media ? curr : min)
                                                      : null;

                                                    const totalDiasPeriodo = (() => {
                                                      if (vendasProduto.length === 0) return 1;
                                                      const primeiraVenda = new Date(vendasProduto[0].data);
                                                      const ultimaVenda = new Date(vendasProduto[vendasProduto.length - 1].data);
                                                      const diasCorridos = Math.max(1, Math.ceil((ultimaVenda - primeiraVenda) / (1000 * 60 * 60 * 24)) + 1);
                                                      const semanas = diasCorridos / 7;

                                                      return Math.max(1, Math.round(semanas * 6));
                                                    })();
                                                    
                                                    const mediaDiaria = prod.quantidade / totalDiasPeriodo;

                                                    let tendencia = 'est√°vel';
                                                    let tendenciaIcon = '‚Üí';
                                                    let tendenciaColor = 'text-gray-600';
                                                    if (quantidades.length >= 7) {
                                                      const ultimos7 = quantidades.slice(-7).reduce((a, b) => a + b, 0) / 7;
                                                      const anteriores7 = quantidades.length >= 14
                                                        ? quantidades.slice(-14, -7).reduce((a, b) => a + b, 0) / 7
                                                        : ultimos7;
                                                      
                                                      if (ultimos7 > anteriores7 * 1.1) {
                                                        tendencia = 'crescente';
                                                        tendenciaIcon = '‚Üó';
                                                        tendenciaColor = 'text-green-600';
                                                      } else if (ultimos7 < anteriores7 * 0.9) {
                                                        tendencia = 'decrescente';
                                                        tendenciaIcon = '‚Üò';
                                                        tendenciaColor = 'text-red-600';
                                                      }
                                                    }

                                                    const media = quantidades.reduce((a, b) => a + b, 0) / quantidades.length;
                                                    const variancia = quantidades.reduce((sum, val) => sum + Math.pow(val - media, 2), 0) / quantidades.length;
                                                    const desvioPadrao = Math.sqrt(variancia);
                                                    const coeficienteVariacao = media > 0 ? (desvioPadrao / media) * 100 : 0;
                                                    
                                                    let consistencia = 'Alta';
                                                    let consistenciaColor = 'text-green-600';
                                                    if (coeficienteVariacao > 60) {
                                                      consistencia = 'Baixa';
                                                      consistenciaColor = 'text-red-600';
                                                    } else if (coeficienteVariacao > 30) {
                                                      consistencia = 'M√©dia';
                                                      consistenciaColor = 'text-orange-600';
                                                    }

                                                    const diasComVendas = datasOrdenadas.length;
                                                    const taxaDias = ((diasComVendas / totalDiasPeriodo) * 100).toFixed(0);
                                                    
                                                    return (
                                                      <div className="grid grid-cols-4 gap-2">
                                                        {/* Fatura√ß√£o */}
                                                        <div className="bg-white rounded p-1.5 text-center border border-green-200">
                                                          <div className="text-[9px] text-gray-600">Fatura√ß√£o</div>
                                                          <div className="text-sm font-bold text-green-700">‚Ç¨{prod.faturacao.toFixed(0)}</div>
                                                        </div>
                                                        
                                                        {/* Lucro */}
                                                        <div className="bg-white rounded p-1.5 text-center border border-blue-200">
                                                          <div className="text-[9px] text-gray-600">Lucro</div>
                                                          <div className="text-sm font-bold text-blue-700">‚Ç¨{prod.lucro.toFixed(0)}</div>
                                                        </div>
                                                        
                                                        {/* Margem */}
                                                        <div className="bg-white rounded p-1.5 text-center border border-purple-200">
                                                          <div className="text-[9px] text-gray-600">Margem</div>
                                                          <div className={`text-sm font-bold ${
                                                            margemProd > 60 ? 'text-green-600' :
                                                            margemProd > 40 ? 'text-blue-600' : 'text-orange-600'
                                                          }`}>
                                                            {margemProd.toFixed(0)}%
                                                          </div>
                                                        </div>
                                                        
                                                        {/* M√©tricas Extras - Grid 2x3 mais descritivo */}
                                                        <div className="bg-white rounded p-1.5 border border-gray-200">
                                                          <div className="grid grid-cols-2 gap-1 text-[9px]">
                                                            {/* Melhor dia */}
                                                            <div 
                                                              className="flex flex-col items-start cursor-help" 
                                                              title={`Melhor dia da semana: ${melhorDiaSemana?.dia || '-'} com m√©dia de ${melhorDiaSemana?.media.toFixed(1) || 0} vendas/dia`}
                                                            >
                                                              <span className="text-[8px] text-gray-500">Melhor</span>
                                                              <span className="font-bold text-green-700 text-xs">üìÖ {melhorDiaSemana?.dia || '-'}</span>
                                                            </div>
                                                            
                                                            {/* Pior dia (excluindo quartas) */}
                                                            <div 
                                                              className="flex flex-col items-start cursor-help" 
                                                              title={`Pior dia da semana: ${piorDiaSemana?.dia || '-'} com m√©dia de ${piorDiaSemana?.media.toFixed(1) || 0} vendas/dia (quartas exclu√≠das - folga)`}
                                                            >
                                                              <span className="text-[8px] text-gray-500">Pior</span>
                                                              <span className="font-bold text-red-600 text-xs">üìÜ {piorDiaSemana?.dia || '-'}</span>
                                                            </div>
                                                            
                                                            {/* Tend√™ncia */}
                                                            <div 
                                                              className="flex flex-col items-start cursor-help" 
                                                              title={`Tend√™ncia de vendas: ${tendencia} (comparando √∫ltimos 7 dias com 7 dias anteriores)`}
                                                            >
                                                              <span className="text-[8px] text-gray-500">Tend√™ncia</span>
                                                              <span className={`font-bold ${tendenciaColor} text-xs`}>{tendenciaIcon} {tendencia}</span>
                                                            </div>
                                                            
                                                            {/* M√©dia di√°ria */}
                                                            <div 
                                                              className="flex flex-col items-start cursor-help" 
                                                              title={`M√©dia di√°ria: ${mediaDiaria.toFixed(1)} vendas/dia √∫til (6 dias/semana, excluindo quartas)`}
                                                            >
                                                              <span className="text-[8px] text-gray-500">M√©dia/dia</span>
                                                              <span className="font-bold text-blue-700 text-xs">üéØ {mediaDiaria.toFixed(1)}</span>
                                                            </div>
                                                            
                                                            {/* Consist√™ncia */}
                                                            <div 
                                                              className="flex flex-col items-start cursor-help" 
                                                              title={`Consist√™ncia das vendas: ${consistencia} (varia√ß√£o ${coeficienteVariacao.toFixed(0)}% - quanto menor, mais consistente)`}
                                                            >
                                                              <span className="text-[8px] text-gray-500">Consist.</span>
                                                              <span className={`font-bold ${consistenciaColor} text-xs`}>üìä {consistencia}</span>
                                                            </div>
                                                            
                                                            {/* Taxa dias */}
                                                            <div 
                                                              className="flex flex-col items-start cursor-help" 
                                                              title={`Frequ√™ncia de vendas: ${taxaDias}% dos dias √∫teis tiveram vendas (${diasComVendas} de ${totalDiasPeriodo} dias √∫teis)`}
                                                            >
                                                              <span className="text-[8px] text-gray-500">Freq.</span>
                                                              <span className="font-bold text-purple-700 text-xs">üåü {taxaDias}%</span>
                                                            </div>
                                                          </div>
                                                        </div>
                                                      </div>
                                                    );
                                                  })()}
                                                </div>
                                              );
                                            })}
                                          </div>
                                          
                                          {/* Resumo da Categoria */}
                                          <div className="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
                                            <h5 className="text-xs font-bold text-blue-900 mb-2">üìà Resumo {info.nome}</h5>
                                            <div className="grid grid-cols-4 gap-2 text-center">
                                              <div>
                                                <div className="text-xs text-gray-600">Total Vendas</div>
                                                <div className="text-lg font-bold text-gray-900">{Math.round(dados.quantidade)}</div>
                                              </div>
                                              <div>
                                                <div className="text-xs text-gray-600">Fatura√ß√£o</div>
                                                <div className="text-lg font-bold text-green-700">‚Ç¨{dados.faturacao.toFixed(0)}</div>
                                              </div>
                                              <div>
                                                <div className="text-xs text-gray-600">Lucro</div>
                                                <div className="text-lg font-bold text-blue-700">‚Ç¨{dados.lucro.toFixed(0)}</div>
                                              </div>
                                              <div>
                                                <div className="text-xs text-gray-600">Margem M√©dia</div>
                                                <div className={`text-lg font-bold ${
                                                  margemPerc > 60 ? 'text-green-600' :
                                                  margemPerc > 40 ? 'text-blue-600' : 'text-orange-600'
                                                }`}>
                                                  {margemPerc.toFixed(1)}%
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  );
                                })}
                              </div>
                            );
                          })()}
                        </div>
                      )}
                      
                      {/* TAB 2: RANKING */}
                      {produtosAnaliseTab === 'ranking' && (
                        <div>
                          {/* Filtros */}
                          <div className="mb-4 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200 flex flex-wrap gap-3 items-end">
                            <div className="flex-1 min-w-[200px]">
                              <label className="text-xs font-semibold text-gray-700 block mb-2">üîç Buscar produto:</label>
                              <input
                                type="text"
                                value={buscaProdutoIndividual}
                                onChange={(e) => setBuscaProdutoIndividual(e.target.value)}
                                placeholder="Digite o nome do produto..."
                                className="w-full px-4 py-2 border-2 border-blue-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              />
                            </div>
                            
                            <div className="flex-1 min-w-[200px]">
                              <label className="text-xs font-semibold text-gray-700 block mb-2">Filtrar por categoria:</label>
                              <select
                                value={categoriaFiltroDesempenho}
                                onChange={(e) => setCategoriaFiltroDesempenho(e.target.value)}
                                className="w-full px-4 py-2 border-2 border-blue-300 rounded-lg text-sm font-semibold bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              >
                                <option value="todos">üìä Todos os Produtos</option>
                                {Object.entries(CATEGORIAS_PRODUTOS).map(([key, info]) => (
                                  <option key={key} value={key}>{info.nome}</option>
                                ))}
                              </select>
                            </div>
                          </div>
                          
                          <p className="text-xs text-gray-600 mb-3">
                            üí° Clica nos t√≠tulos das colunas para ordenar
                            {categoriaFiltroDesempenho !== 'todos' && (
                              <span className="font-bold text-blue-600"> ‚Ä¢ {CATEGORIAS_PRODUTOS[categoriaFiltroDesempenho]?.nome || categoriaFiltroDesempenho}</span>
                            )}
                            {buscaProdutoIndividual && (
                              <span className="font-bold text-purple-600"> ‚Ä¢ Busca: "{buscaProdutoIndividual}"</span>
                            )}
                          </p>
                          
                          {(() => {

                            const vendasPorProduto = {};
                            
                            filteredVendas.forEach(v => {
                              if (!vendasPorProduto[v.produto]) {
                                vendasPorProduto[v.produto] = {
                                  nome: v.produto,
                                  quantidade: 0,
                                  faturacao: 0,
                                  lucro: 0
                                };
                              }
                              
                              vendasPorProduto[v.produto].quantidade = Math.round((vendasPorProduto[v.produto].quantidade + v.quantidade) * 100) / 100;
                              vendasPorProduto[v.produto].faturacao = Math.round((vendasPorProduto[v.produto].faturacao + v.valor) * 100) / 100;
                              vendasPorProduto[v.produto].lucro = Math.round((vendasPorProduto[v.produto].lucro + calcLucroVenda(v).lucro) * 100) / 100;
                            });
                            
                            let produtosArray = Object.values(vendasPorProduto);

                            if (categoriaFiltroDesempenho !== 'todos') {
                              produtosArray = produtosArray.filter(pVenda => {
                                const produto = produtos.find(p => p.nome === pVenda.nome);
                                if (categoriaFiltroDesempenho === 'outros') {
                                  return !produto || produto.categoria === 'outros';
                                }
                                return produto && produto.categoria === categoriaFiltroDesempenho;
                              });
                            }

                            if (buscaProdutoIndividual.trim()) {
                              produtosArray = produtosArray.filter(pVenda =>
                                normalizeText(pVenda.nome).includes(normalizeText(buscaProdutoIndividual))
                              );
                            }

                            if (ordenarPor === 'faturacao') {
                              produtosArray.sort((a, b) => b.faturacao - a.faturacao);
                            } else if (ordenarPor === 'quantidade') {
                              produtosArray.sort((a, b) => b.quantidade - a.quantidade);
                            } else if (ordenarPor === 'lucro') {
                              produtosArray.sort((a, b) => b.lucro - a.lucro);
                            } else if (ordenarPor === 'margem') {
                              produtosArray.sort((a, b) => {
                                const margemA = a.faturacao > 0 ? (a.lucro / a.faturacao) * 100 : 0;
                                const margemB = b.faturacao > 0 ? (b.lucro / b.faturacao) * 100 : 0;
                                return margemB - margemA;
                              });
                            }
                            
                            if (produtosArray.length === 0) {
                              return (
                                <div className="text-center py-8 bg-gray-50 rounded-lg">
                                  <p className="text-gray-600">
                                    üì¶ Sem vendas{categoriaFiltroDesempenho !== 'todos' ? ` da categoria "${CATEGORIAS_PRODUTOS[categoriaFiltroDesempenho]?.nome}"` : ''} no per√≠odo selecionado
                                  </p>
                                </div>
                              );
                            }
                            
                            return (
                              <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                  <thead>
                                    <tr className="bg-gradient-to-r from-blue-100 to-indigo-100 border-b-2 border-blue-300">
                                      <th className="text-left p-2 font-bold text-blue-900">#</th>
                                      <th className="text-left p-2 font-bold text-blue-900">Produto</th>
                                      <th 
                                        className="text-right p-2 font-bold text-blue-900 cursor-pointer hover:bg-blue-200 transition"
                                        onClick={() => setOrdenarPor('quantidade')}
                                        title="Clique para ordenar"
                                      >
                                        üì¶ Qtd {ordenarPor === 'quantidade' && '‚ñº'}
                                      </th>
                                      <th 
                                        className="text-right p-2 font-bold text-blue-900 cursor-pointer hover:bg-blue-200 transition"
                                        onClick={() => setOrdenarPor('faturacao')}
                                        title="Clique para ordenar"
                                      >
                                        üí∞ Fatura√ß√£o {ordenarPor === 'faturacao' && '‚ñº'}
                                      </th>
                                      <th 
                                        className="text-right p-2 font-bold text-blue-900 cursor-pointer hover:bg-blue-200 transition"
                                        onClick={() => setOrdenarPor('lucro')}
                                        title="Clique para ordenar"
                                      >
                                        üíµ Lucro {ordenarPor === 'lucro' && '‚ñº'}
                                      </th>
                                      <th 
                                        className="text-right p-2 font-bold text-blue-900 cursor-pointer hover:bg-blue-200 transition"
                                        onClick={() => setOrdenarPor('margem')}
                                        title="Clique para ordenar"
                                      >
                                        üìä Margem {ordenarPor === 'margem' && '‚ñº'}
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {produtosArray.map((p, idx) => {
                                      const margem = p.faturacao > 0 ? (p.lucro / p.faturacao) * 100 : 0;
                                      return (
                                        <tr key={idx} className="border-b hover:bg-blue-50 transition">
                                          <td className="p-2 font-semibold text-gray-600">{idx + 1}</td>
                                          <td className="p-2 font-semibold">{p.nome}</td>
                                          <td className="p-2 text-right">{Math.round(p.quantidade)}</td>
                                          <td className="p-2 text-right font-bold text-green-700">‚Ç¨{p.faturacao.toFixed(2)}</td>
                                          <td className="p-2 text-right font-bold text-blue-700">‚Ç¨{p.lucro.toFixed(2)}</td>
                                          <td className="p-2 text-right font-bold">
                                            <span className={
                                              margem > 60 ? 'text-green-600' :
                                              margem > 40 ? 'text-blue-600' : 'text-orange-600'
                                            }>
                                              {margem.toFixed(1)}%
                                            </span>
                                          </td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                </table>
                              </div>
                            );
                          })()}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* AN√ÅLISE MENSAL COMPARATIVA - DROPDOWN (s√≥ aparece quando clicar no gr√°fico) */}
                {showMensalDetails && (
                  <div className="bg-white rounded-lg shadow p-4 mb-4">
                    <button
                      onClick={() => setShowMensalDetails(false)}
                      className="w-full flex items-center justify-between hover:bg-gray-50 transition rounded-lg p-2 mb-4"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-lg">üìÖ</span>
                        <h2 className="text-lg font-bold text-gray-800">An√°lise Mensal Comparativa</h2>
                      </div>
                      <span className="text-gray-600 text-xl">‚ñº</span>
                    </button>

                    <div>
                      {(() => {
                        const meses = [
                          'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                        ];

                        const calcularMetricasMes = (mes, ano) => {
                          const vendasMes = vendas.filter(v => {
                            const d = new Date(v.data);
                            return d.getMonth() === mes && d.getFullYear() === ano;
                          });
                          
                          const despesasMes = despesas.filter(d => {
                            const data = new Date(d.data);
                            return data.getMonth() === mes && data.getFullYear() === ano;
                          });
                          
                          const faturacao = vendasMes.reduce((s, v) => s + v.valor, 0);
                          const custosDespesas = despesasMes.reduce((s, d) => s + d.valor, 0);
                          const lucroVendas = vendasMes.reduce((s, v) => s + calcLucroVenda(v).lucro, 0);
                          const lucroTotal = lucroVendas - custosDespesas;

                          const produtosPorQtd = {};
                          vendasMes.forEach(v => {
                            produtosPorQtd[v.produto] = (produtosPorQtd[v.produto] || 0) + v.quantidade;
                          });
                          
                          const entries = Object.entries(produtosPorQtd);
                          const maisVendido = entries.length > 0 
                            ? entries.sort((a, b) => b[1] - a[1])[0]
                            : null;
                          const menosVendido = entries.length > 0
                            ? entries.sort((a, b) => a[1] - b[1])[0]
                            : null;
                          
                          return {
                            faturacao,
                            lucroTotal,
                            totalVendas: vendasMes.length,
                            totalQuantidade: vendasMes.reduce((s, v) => s + v.quantidade, 0),
                            maisVendido: maisVendido ? { nome: maisVendido[0], qtd: maisVendido[1] } : null,
                            menosVendido: menosVendido ? { nome: menosVendido[0], qtd: menosVendido[1] } : null
                          };
                        };
                        
                        const mesAtual = calcularMetricasMes(mesSelecionado, anoSelecionado);

                        const mesAnteriorNum = mesSelecionado === 0 ? 11 : mesSelecionado - 1;
                        const anoAnteriorNum = mesSelecionado === 0 ? anoSelecionado - 1 : anoSelecionado;
                        const mesAnterior = calcularMetricasMes(mesAnteriorNum, anoAnteriorNum);

                        const variacaoFaturacao = mesAnterior.faturacao > 0 
                          ? ((mesAtual.faturacao - mesAnterior.faturacao) / mesAnterior.faturacao) * 100 
                          : 0;
                        const variacaoLucro = mesAnterior.lucroTotal > 0
                          ? ((mesAtual.lucroTotal - mesAnterior.lucroTotal) / mesAnterior.lucroTotal) * 100
                          : 0;
                        const variacaoVendas = mesAnterior.totalVendas > 0
                          ? ((mesAtual.totalVendas - mesAnterior.totalVendas) / mesAnterior.totalVendas) * 100
                          : 0;
                        
                        return (
                          <div>
                            {/* Seletor de M√™s */}
                            <div className="mb-4 flex flex-wrap gap-2">
                              {meses.map((mes, idx) => (
                                <button
                                  key={idx}
                                  onClick={() => setMesSelecionado(idx)}
                                  className={`px-3 py-1 rounded text-sm font-semibold transition ${
                                    mesSelecionado === idx
                                      ? 'bg-blue-600 text-white shadow-lg'
                                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                  }`}
                                >
                                  {mes.substring(0, 3)}
                                </button>
                              ))}
                            </div>
                            
                            {/* Card do M√™s */}
                            <div className="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-6">
                              <h3 className="text-2xl font-bold text-blue-900 mb-4">
                                üìÖ {meses[mesSelecionado]} {anoSelecionado}
                              </h3>
                              
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {/* Fatura√ß√£o */}
                                <div className="bg-white rounded-lg p-4 shadow">
                                  <div className="text-sm text-gray-600 mb-1">üí∞ Fatura√ß√£o Total</div>
                                  <div className="text-2xl font-bold text-green-600">
                                    ‚Ç¨{mesAtual.faturacao.toFixed(2)}
                                  </div>
                                  {mesAnterior.faturacao > 0 && (
                                    <div className={`text-sm mt-1 ${variacaoFaturacao >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      vs {meses[mesAnteriorNum]}: {variacaoFaturacao >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoFaturacao).toFixed(1)}%
                                      <span className="text-gray-600 ml-1">
                                        ({variacaoFaturacao >= 0 ? '+' : ''}‚Ç¨{(mesAtual.faturacao - mesAnterior.faturacao).toFixed(2)})
                                      </span>
                                    </div>
                                  )}
                                </div>
                                
                                {/* Lucro */}
                                <div className="bg-white rounded-lg p-4 shadow">
                                  <div className="text-sm text-gray-600 mb-1">üèÜ Lucro Total</div>
                                  <div className={`text-2xl font-bold ${mesAtual.lucroTotal >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                    ‚Ç¨{mesAtual.lucroTotal.toFixed(2)}
                                  </div>
                                  {mesAnterior.lucroTotal !== 0 && (
                                    <div className={`text-sm mt-1 ${variacaoLucro >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      vs {meses[mesAnteriorNum]}: {variacaoLucro >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoLucro).toFixed(1)}%
                                      <span className="text-gray-600 ml-1">
                                        ({variacaoLucro >= 0 ? '+' : ''}‚Ç¨{(mesAtual.lucroTotal - mesAnterior.lucroTotal).toFixed(2)})
                                      </span>
                                    </div>
                                  )}
                                </div>
                                
                                {/* Total Vendas */}
                                <div className="bg-white rounded-lg p-4 shadow">
                                  <div className="text-sm text-gray-600 mb-1">üì¶ Total Vendas</div>
                                  <div className="text-2xl font-bold text-purple-600">
                                    {mesAtual.totalQuantidade} un
                                  </div>
                                  {mesAnterior.totalVendas > 0 && (
                                    <div className={`text-sm mt-1 ${variacaoVendas >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                      vs {meses[mesAnteriorNum]}: {variacaoVendas >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoVendas).toFixed(1)}%
                                      <span className="text-gray-600 ml-1">
                                        ({variacaoVendas >= 0 ? '+' : ''}{mesAtual.totalVendas - mesAnterior.totalVendas} vendas)
                                      </span>
                                    </div>
                                  )}
                                </div>
                                
                                {/* Produto Mais Vendido */}
                                <div className="bg-white rounded-lg p-4 shadow">
                                  <div className="text-sm text-gray-600 mb-1">ü•á Mais Vendido</div>
                                  {mesAtual.maisVendido ? (
                                    <>
                                      <div className="text-lg font-bold text-amber-600">
                                        {mesAtual.maisVendido.nome}
                                      </div>
                                      <div className="text-sm text-gray-600">
                                        {mesAtual.maisVendido.qtd}x vendidas
                                      </div>
                                      {mesAnterior.maisVendido && mesAnterior.maisVendido.nome !== mesAtual.maisVendido.nome && (
                                        <div className="text-xs text-gray-500 mt-1">
                                          {meses[mesAnteriorNum]}: {mesAnterior.maisVendido.nome}
                                        </div>
                                      )}
                                    </>
                                  ) : (
                                    <div className="text-gray-400">Sem dados</div>
                                  )}
                                </div>
                                
                                {/* Produto Menos Vendido */}
                                <div className="bg-white rounded-lg p-4 shadow">
                                  <div className="text-sm text-gray-600 mb-1">üìâ Menos Vendido</div>
                                  {mesAtual.menosVendido ? (
                                    <>
                                      <div className="text-lg font-bold text-gray-600">
                                        {mesAtual.menosVendido.nome}
                                      </div>
                                      <div className="text-sm text-gray-600">
                                        {mesAtual.menosVendido.qtd}x vendidas
                                      </div>
                                      {mesAnterior.menosVendido && mesAnterior.menosVendido.nome !== mesAtual.menosVendido.nome && (
                                        <div className="text-xs text-gray-500 mt-1">
                                          {meses[mesAnteriorNum]}: {mesAnterior.menosVendido.nome}
                                        </div>
                                      )}
                                    </>
                                  ) : (
                                    <div className="text-gray-400">Sem dados</div>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                {/* BREAK-EVEN, IVA E BOLOS - 3 COLUNAS */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                  
                  {/* BREAK-EVEN - DESIGN COMPACTO COM GAUGE */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 shadow-lg p-3">
                    <button
                      onClick={() => setShowBreakEvenDetails(!showBreakEvenDetails)}
                      className="w-full p-3 flex items-center justify-between hover:bg-green-100/50 transition rounded-lg"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-xl">üéØ</span>
                        <div className="text-left">
                          <h3 className="font-bold text-green-900">Break-Even</h3>
                          <p className="text-xs text-green-700">
                            {((totV / Math.max(breakEvenPoint, 1)) * 100).toFixed(0)}% atingido
                          </p>
                        </div>
                      </div>
                      <span className="text-green-900 text-xl">
                        {showBreakEvenDetails ? '‚ñº' : '‚ñ∂'}
                      </span>
                    </button>

                    {/* Gauge Circular */}
                    <div className="relative flex items-center justify-center my-2">
                      <svg width="100" height="100" className="transform -rotate-90">
                        {/* Background circle */}
                        <circle
                          cx="50"
                          cy="50"
                          r="40"
                          fill="none"
                          stroke="#e5e7eb"
                          strokeWidth="8"
                        />
                        {/* Progress circle */}
                        <circle
                          cx="50"
                          cy="50"
                          r="40"
                          fill="none"
                          stroke={totV >= breakEvenPoint ? 'url(#greenGradient)' : 'url(#blueGradient)'}
                          strokeWidth="8"
                          strokeDasharray={`${2 * Math.PI * 40}`}
                          strokeDashoffset={`${2 * Math.PI * 40 * (1 - Math.min(totV / Math.max(breakEvenPoint, 1), 1))}`}
                          strokeLinecap="round"
                          className="transition-all duration-1000"
                        />
                        {/* Gradients */}
                        <defs>
                          <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="#10b981" />
                            <stop offset="100%" stopColor="#14b8a6" />
                          </linearGradient>
                          <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="#3b82f6" />
                            <stop offset="100%" stopColor="#8b5cf6" />
                          </linearGradient>
                        </defs>
                      </svg>
                      
                      {/* Center text */}
                      <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <p className="text-lg font-extrabold text-green-900">
                          ‚Ç¨{faturacaoNecessariaDiaria.toFixed(0)}
                        </p>
                        <p className="text-[9px] text-gray-600 mt-0.5">necess√°rio/dia</p>
                      </div>
                    </div>

                    {/* Card de M√©dia Actual */}
                    <div className="bg-white/60 rounded-lg px-2 py-1.5 mb-2 text-center border border-green-200">
                      <p className="text-[9px] text-green-600 font-medium">M√©dia Actual</p>
                      <p className="text-base font-bold text-green-900">‚Ç¨{medFat.toFixed(0)}</p>
                      <p className="text-[9px] text-green-600">por dia</p>
                    </div>

                    {/* Stats compactos */}
                    <div className="space-y-1 text-xs">
                      <div className="flex justify-between items-center bg-white rounded-lg p-1.5">
                        <span className="text-gray-600 text-[10px]">Objetivo:</span>
                        <span className="font-bold text-green-900">‚Ç¨{breakEvenPoint.toFixed(0)}</span>
                      </div>
                      <div className="flex justify-between items-center bg-white rounded-lg p-1.5">
                        <span className="text-gray-600 text-[10px]">Atual:</span>
                        <span className="font-bold text-blue-700">‚Ç¨{totV.toFixed(0)}</span>
                      </div>
                    </div>

                    {/* Detalhes expand√≠veis */}
                    {showBreakEvenDetails && (
                      <div className="mt-3 space-y-2 animate-fadeIn">
                        <div className="bg-white rounded-lg p-2 text-[10px] space-y-1.5">
                          <div className="flex justify-between">
                            <span className="text-gray-600">Faltam:</span>
                            <span className={`font-bold ${totV >= breakEvenPoint ? 'text-green-600' : 'text-red-600'}`}>
                              {totV >= breakEvenPoint ? '‚úÖ Atingido!' : `‚Ç¨${(breakEvenPoint - totV).toFixed(0)}`}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-600">Vendas/dia necess√°rias:</span>
                            <span className="font-bold text-blue-700">{Math.ceil(vendasNecessariasPorDia)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-600">Ticket m√©dio:</span>
                            <span className="font-bold text-purple-700">‚Ç¨{ticketMedio.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-600">Margem/venda:</span>
                            <span className="font-bold text-purple-700">‚Ç¨{margemPorVenda.toFixed(2)}</span>
                          </div>
                        </div>

                        <div className={`rounded-lg p-2 text-[10px] ${
                          totV >= breakEvenPoint * 1.2 
                            ? 'bg-green-100 border border-green-300' 
                            : totV >= breakEvenPoint 
                              ? 'bg-yellow-100 border border-yellow-300' 
                              : 'bg-red-100 border border-red-300'
                        }`}>
                          <p className="font-semibold">
                            {totV >= breakEvenPoint * 1.2 
                              ? '‚úÖ Excelente! Margem de seguran√ßa.' 
                              : totV >= breakEvenPoint 
                                ? '‚ö†Ô∏è No limite. Aumenta 20%.' 
                                : `üö® Faltam ‚Ç¨${(faturacaoNecessariaDiaria - medFat).toFixed(0)}/dia`}
                          </p>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* AN√ÅLISE FISCAL (IVA) - COLUNA CENTRO */}
                  <div className="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl border-2 border-orange-200 shadow-lg p-4">
                    <button
                      onClick={() => setShowIVADetails(!showIVADetails)}
                      className="w-full p-3 flex items-center justify-between hover:bg-orange-100/50 transition rounded-lg"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-xl">üßæ</span>
                        <div className="text-left">
                          <h3 className="font-bold text-orange-900">An√°lise Fiscal (IVA)</h3>
                          <p className="text-xs text-orange-700">
                            Q{quarter}/{currentYear} ‚Ä¢ {ivaP >= 0 ? 'A Pagar' : 'A Receber'}: ‚Ç¨{Math.abs(ivaP).toFixed(0)}
                          </p>
                        </div>
                      </div>
                      <span className="text-orange-900 text-xl">
                        {showIVADetails ? '‚ñº' : '‚ñ∂'}
                      </span>
                    </button>

                    {/* RESUMO SEMPRE VIS√çVEL */}
                    <div className="mt-3 grid grid-cols-3 gap-2">
                      <div className="bg-white rounded-lg p-2 border border-green-200 text-center">
                        <div className="text-[9px] text-gray-600 mb-0.5">Vendas</div>
                        <div className="text-sm font-bold text-green-600">‚Ç¨{ivaV.toFixed(0)}</div>
                      </div>
                      <div className="bg-white rounded-lg p-2 border border-blue-200 text-center">
                        <div className="text-[9px] text-gray-600 mb-0.5">Dedut√≠vel</div>
                        <div className="text-sm font-bold text-blue-600">‚Ç¨{ivaCompras.toFixed(0)}</div>
                      </div>
                      <div className={`bg-white rounded-lg p-2 border-2 ${ivaP >= 0 ? 'border-red-300' : 'border-green-300'} text-center`}>
                        <div className="text-[9px] text-gray-600 mb-0.5">{ivaP >= 0 ? 'Pagar' : 'Receber'}</div>
                        <div className={`text-sm font-bold ${ivaP >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                          ‚Ç¨{Math.abs(ivaP).toFixed(0)}
                        </div>
                      </div>
                    </div>

                    {/* Taxa Efetiva e M√©dia */}
                    <div className="mt-2 bg-white/60 rounded-lg p-2 border border-orange-200">
                      <div className="grid grid-cols-2 gap-2 text-xs">
                        <div className="flex justify-between">
                          <span className="text-gray-600">Taxa efetiva:</span>
                          <span className="font-bold text-orange-700">
                            {totV > 0 ? ((ivaV / totV) * 100).toFixed(1) : '0.0'}%
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">M√©dia/dia:</span>
                          <span className="font-bold text-purple-700">
                            ‚Ç¨{(() => {
                              const diasNoTrimestre = (() => {
                                const today = new Date();
                                const startOfQuarter = new Date(currentYear, (quarter - 1) * 3, 1);
                                const endOfQuarter = new Date(currentYear, quarter * 3, 0);
                                const now = today > endOfQuarter ? endOfQuarter : today;
                                return Math.max(1, Math.ceil((now - startOfQuarter) / (1000 * 60 * 60 * 24)));
                              })();
                              return (Math.abs(ivaP) / diasNoTrimestre).toFixed(2);
                            })()}
                          </span>
                        </div>
                      </div>
                    </div>

                    {showIVADetails && (
                      <div className="mt-3 backdrop-blur-lg bg-gradient-to-br from-orange-50/90 to-amber-50/90 border-2 border-orange-300/50 rounded-2xl shadow-xl p-4">
                        <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                          üßæ Pr√≥xima Entrega de IVA
                        </h3>
                        
                        <div className="grid grid-cols-1 gap-3 mb-3">
                          <div className="bg-white rounded-lg p-3 border border-orange-200">
                            <p className="text-xs font-semibold text-gray-700 mb-2">
                              {quarter}¬∫ Trimestre {currentYear}
                            </p>
                            <div className="space-y-1.5">
                              <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-600">IVA Vendas:</span>
                                <span className="text-sm font-bold text-green-600">‚Ç¨{ivaV.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-600">IVA Dedut√≠vel:</span>
                                <span className="text-sm font-bold text-blue-600">-‚Ç¨{ivaCompras.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between items-center pt-1.5 border-t-2 border-orange-300 mt-1.5">
                                <span className="text-sm font-bold text-gray-700">A {ivaP >= 0 ? 'Pagar' : 'Receber'}:</span>
                                <span className={`text-lg font-bold ${ivaP >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                  ‚Ç¨{Math.abs(ivaP).toFixed(2)}
                                </span>
                              </div>
                            </div>
                          </div>
                          
                          <div className="bg-gradient-to-br from-orange-100 to-amber-100 rounded-lg p-3 border border-orange-300">
                            <p className="text-xs font-bold text-orange-900 mb-2">üìÖ Prazo de Entrega</p>
                            <div className="space-y-1.5">
                              <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-700">Data limite:</span>
                                <span className="text-xs font-bold text-orange-800">
                                  {(() => {
                                    let deadlineMonth, deadlineYear;
                                    if (quarter === 1) { deadlineMonth = 4; deadlineYear = currentYear; }
                                    else if (quarter === 2) { deadlineMonth = 7; deadlineYear = currentYear; }
                                    else if (quarter === 3) { deadlineMonth = 10; deadlineYear = currentYear; }
                                    else { deadlineMonth = 1; deadlineYear = currentYear + 1; }
                                    const prazo = new Date(deadlineYear, deadlineMonth, 20);
                                    return prazo.toLocaleDateString('pt-PT', { day: 'numeric', month: 'short' });
                                  })()}
                                </span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-700">Tempo restante:</span>
                                <span className="text-xs font-bold text-orange-800">
                                  {(() => {
                                    const hoje = new Date();
                                    let deadlineMonth, deadlineYear;
                                    if (quarter === 1) { deadlineMonth = 4; deadlineYear = currentYear; }
                                    else if (quarter === 2) { deadlineMonth = 7; deadlineYear = currentYear; }
                                    else if (quarter === 3) { deadlineMonth = 10; deadlineYear = currentYear; }
                                    else { deadlineMonth = 1; deadlineYear = currentYear + 1; }
                                    const prazo = new Date(deadlineYear, deadlineMonth, 20);
                                    const diffTime = prazo - hoje;
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    return diffDays > 0 ? `${diffDays} dias` : 'EXPIRADO!';
                                  })()}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-2.5 mb-3">
                          <p className="text-xs text-blue-800">
                            <span className="font-semibold">üí° IVA Dedut√≠vel:</span> Apenas FT ou FR (n√£o FS) ‚Ä¢ 
                            <span className="font-semibold"> Regime Trimestral:</span> 4x/ano (volume &lt; ‚Ç¨650k)
                          </p>
                        </div>

                        {/* AN√ÅLISE DE TEND√äNCIA E PREVIS√ÉO */}
                        <div className="bg-gradient-to-br from-indigo-50 to-blue-50 border-2 border-indigo-200 rounded-xl p-3 mb-3">
                          <h4 className="text-xs font-bold text-gray-800 mb-2 flex items-center gap-2">
                            üìà Tend√™ncia & Previs√£o
                          </h4>
                          <div className="space-y-2">
                            {/* Compara√ß√£o com trimestre anterior */}
                            <div className="bg-white rounded-lg p-2 border border-gray-200">
                              <div className="flex justify-between items-center mb-1">
                                <span className="text-xs text-gray-600">vs Q{quarter === 1 ? 4 : quarter - 1} {quarter === 1 ? anoAnterior : currentYear}:</span>
                                {(() => {
                                  const trimestreAnterior = quarter === 1 ? 4 : quarter - 1;
                                  const anoAnteriorRef = quarter === 1 ? anoAnterior : currentYear;
                                  const historicoAnterior = historicoAnoAnterior.find(h => h.trimestre === trimestreAnterior);
                                  const ivaPagarAnterior = historicoAnterior ? historicoAnterior.ivaPagar : 0;
                                  const diferenca = ivaP - ivaPagarAnterior;
                                  const percentualMudanca = ivaPagarAnterior !== 0 ? (diferenca / Math.abs(ivaPagarAnterior)) * 100 : 0;
                                  return (
                                    <span className={`text-xs font-bold flex items-center gap-1 ${
                                      diferenca > 0 ? 'text-red-600' : diferenca < 0 ? 'text-green-600' : 'text-gray-600'
                                    }`}>
                                      {diferenca > 0 ? '‚Üë' : diferenca < 0 ? '‚Üì' : '='} {percentualMudanca !== 0 ? `${Math.abs(percentualMudanca).toFixed(0)}%` : '0%'}
                                    </span>
                                  );
                                })()}
                              </div>
                            </div>

                            {/* Proje√ß√£o fim do trimestre */}
                            <div className="bg-white rounded-lg p-2 border border-gray-200">
                              <div className="text-xs text-gray-600 mb-1">Proje√ß√£o fim trimestre:</div>
                              <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-500">Estimativa:</span>
                                {(() => {
                                  const today = new Date();
                                  const startOfQuarter = new Date(currentYear, (quarter - 1) * 3, 1);
                                  const endOfQuarter = new Date(currentYear, quarter * 3, 0);
                                  const diasPassados = Math.max(1, Math.ceil((today - startOfQuarter) / (1000 * 60 * 60 * 24)));
                                  const diasTotais = Math.ceil((endOfQuarter - startOfQuarter) / (1000 * 60 * 60 * 24));
                                  const projecao = (ivaP / diasPassados) * diasTotais;
                                  return (
                                    <span className={`text-sm font-bold ${projecao >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                      ‚Ç¨{Math.abs(projecao).toFixed(0)}
                                    </span>
                                  );
                                })()}
                              </div>
                            </div>

                            {/* M√©dia ano corrente */}
                            <div className="bg-white rounded-lg p-2 border border-gray-200">
                              <div className="flex justify-between items-center">
                                <span className="text-xs text-gray-600">M√©dia {currentYear}:</span>
                                {(() => {

                                  const trimestresCorrentes = quarter;
                                  const mediaAno = ivaP / trimestresCorrentes;
                                  return (
                                    <span className={`text-sm font-bold ${mediaAno >= 0 ? 'text-orange-600' : 'text-teal-600'}`}>
                                      ‚Ç¨{Math.abs(mediaAno).toFixed(0)}/trim
                                    </span>
                                  );
                                })()}
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <div className="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-3">
                          <h4 className="text-xs font-bold text-gray-800 mb-2 flex items-center gap-2">
                            üìä Hist√≥rico IVA {anoAnterior}
                          </h4>
                          <div className="grid grid-cols-2 gap-2">
                            {historicoAnoAnterior.map(h => (
                              <div key={h.trimestre} className="rounded-lg p-2 bg-white border border-gray-200 hover:border-purple-300 transition-all">
                                <div className="flex items-center justify-between mb-1.5">
                                  <span className="text-xs font-bold px-1.5 py-0.5 rounded bg-purple-100 text-purple-700">Q{h.trimestre}</span>
                                  <p className={`text-xs font-bold ${h.tipo === 'pagar' ? 'text-red-600' : 'text-green-600'}`}>
                                    ‚Ç¨{Math.abs(h.ivaPagar).toFixed(0)}
                                  </p>
                                </div>
                                <div className="space-y-0.5 text-xs">
                                  <div className="flex justify-between">
                                    <span className="text-gray-500">Vendas:</span>
                                    <span className="font-semibold text-green-700">‚Ç¨{h.ivaVendas.toFixed(0)}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span className="text-gray-500">Compras:</span>
                                    <span className="font-semibold text-blue-700">‚Ç¨{h.ivaCompras.toFixed(0)}</span>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* BOLOS EXTERNOS - COLUNA DIREITA */}
                  <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200 shadow-lg p-4">
                    <button
                      onClick={() => setMostrarBolosExternos(!mostrarBolosExternos)}
                      className="w-full p-3 flex items-center justify-between hover:bg-purple-100/50 transition rounded-lg"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-xl">üéÇ</span>
                        <div className="text-left">
                          <span className="font-bold text-purple-900 flex items-center gap-2">
                            Bolos Externos
                            {bolosExternos.length > 0 && (
                              <span className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full">
                                {bolosExternos.length}
                              </span>
                            )}
                          </span>
                          <p className="text-xs text-purple-700">
                            {bolosExternos.length > 0 
                              ? `‚Ç¨${bolosExternos.reduce((sum, b) => sum + (b.preco || 0), 0).toFixed(0)} ‚Ä¢ ${bolosExternos.reduce((sum, b) => sum + (b.peso || 0), 0).toFixed(1)}kg`
                              : 'Nenhum registo'
                            }
                          </p>
                        </div>
                      </div>
                      <span className="text-purple-900 text-xl">
                        {mostrarBolosExternos ? '‚ñº' : '‚ñ∂'}
                      </span>
                    </button>

                    {/* RESUMO SEMPRE VIS√çVEL */}
                    {bolosExternos.length > 0 && (
                      <div className="mt-3 grid grid-cols-2 gap-2">
                        <div className="bg-white rounded-lg p-2 border border-purple-200 text-center">
                          <div className="text-[9px] text-gray-600 mb-0.5">Ticket M√©dio</div>
                          <div className="text-sm font-bold text-purple-600">
                            ‚Ç¨{(bolosExternos.reduce((sum, b) => sum + (b.preco || 0), 0) / bolosExternos.length).toFixed(0)}
                          </div>
                        </div>
                        <div className="bg-white rounded-lg p-2 border border-pink-200 text-center">
                          <div className="text-[9px] text-gray-600 mb-0.5">Margem M√©dia</div>
                          <div className="text-sm font-bold text-pink-600">
                            {(() => {
                              const total = bolosExternos.reduce((sum, b) => sum + (b.preco || 0), 0);
                              const lucro = bolosExternos.reduce((sum, b) => sum + (b.lucro || 0), 0);
                              return total > 0 ? ((lucro / total) * 100).toFixed(0) : '0';
                            })()}%
                          </div>
                        </div>
                      </div>
                    )}

                    {mostrarBolosExternos && (() => {
                      const totalBolos = bolosExternos.length;
                      const pesoTotal = bolosExternos.reduce((sum, b) => sum + (b.peso || 0), 0);
                      const faturacaoTotal = bolosExternos.reduce((sum, b) => sum + (b.preco || 0), 0);
                      const lucroTotal = bolosExternos.reduce((sum, b) => sum + (b.lucro || 0), 0);
                      const margemMedia = faturacaoTotal > 0 ? (lucroTotal / faturacaoTotal) * 100 : 0;

                      const porTipo = {};
                      bolosExternos.forEach(b => {
                        const nome = b.nomeBolo || 'Desconhecido';
                        if (!porTipo[nome]) {
                          porTipo[nome] = { quantidade: 0, faturacao: 0, lucro: 0 };
                        }
                        porTipo[nome].quantidade++;
                        porTipo[nome].faturacao += b.preco || 0;
                        porTipo[nome].lucro += b.lucro || 0;
                      });

                      return (
                        <div className="mt-3 space-y-3 bg-white/50 rounded-lg p-3">
                          {bolosExternos.length === 0 ? (
                            <div className="text-center py-6">
                              <span className="text-4xl mb-2 block">üéÇ</span>
                              <p className="text-sm text-gray-600">Nenhum bolo externo registado</p>
                              <button
                                onClick={() => buscarBolosAgendados()}
                                className="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
                              >
                                üîç Verificar Calendar
                              </button>
                            </div>
                          ) : (
                            <>
                              <div className="grid grid-cols-2 gap-2">
                                <div className="bg-white p-2 rounded border border-blue-200">
                                  <div className="text-xs text-gray-600">Bolos</div>
                                  <div className="text-lg font-bold text-blue-900">{totalBolos}</div>
                                </div>
                                <div className="bg-white p-2 rounded border border-purple-200">
                                  <div className="text-xs text-gray-600">Peso</div>
                                  <div className="text-lg font-bold text-purple-900">{pesoTotal.toFixed(1)}kg</div>
                                </div>
                                <div className="bg-white p-2 rounded border border-green-200">
                                  <div className="text-xs text-gray-600">Fatura√ß√£o</div>
                                  <div className="text-lg font-bold text-green-900">‚Ç¨{faturacaoTotal.toFixed(0)}</div>
                                </div>
                                <div className="bg-white p-2 rounded border border-yellow-200">
                                  <div className="text-xs text-gray-600">Lucro</div>
                                  <div className="text-lg font-bold text-yellow-900">
                                    ‚Ç¨{lucroTotal.toFixed(0)}
                                    <span className="text-xs ml-1">({margemMedia.toFixed(0)}%)</span>
                                  </div>
                                </div>
                              </div>

                              <div className="bg-white rounded border border-gray-200 p-2">
                                <h4 className="font-bold text-xs mb-2 text-gray-900">üèÜ Por Tipo</h4>
                                <div className="space-y-1">
                                  {Object.entries(porTipo)
                                    .sort((a, b) => b[1].faturacao - a[1].faturacao)
                                    .slice(0, 3)
                                    .map(([nome, stats]) => {
                                      const margem = stats.faturacao > 0 ? (stats.lucro / stats.faturacao) * 100 : 0;
                                      return (
                                        <div key={nome} className="flex justify-between items-center text-xs py-1 border-b last:border-0">
                                          <span className="font-semibold text-gray-800 truncate">{nome}</span>
                                          <div className="flex gap-2 text-gray-600">
                                            <span>{stats.quantidade}x</span>
                                            <span className="text-green-700 font-semibold">‚Ç¨{stats.faturacao.toFixed(0)}</span>
                                          </div>
                                        </div>
                                      );
                                    })
                                  }
                                </div>
                              </div>

                              {/* AN√ÅLISE TEMPORAL */}
                              <div className="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-2">
                                <h4 className="font-bold text-xs mb-2 text-gray-900">üìÖ An√°lise Temporal</h4>
                                
                                {/* Breakdown por m√™s */}
                                <div className="space-y-1.5 mb-2">
                                  {(() => {

                                    const porMes = {};
                                    bolosExternos.forEach(b => {
                                      if (!b.dataEntrega) return;
                                      const data = new Date(b.dataEntrega);
                                      const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
                                      if (!porMes[mesAno]) {
                                        porMes[mesAno] = { quantidade: 0, faturacao: 0, lucro: 0, mes: data.getMonth(), ano: data.getFullYear() };
                                      }
                                      porMes[mesAno].quantidade++;
                                      porMes[mesAno].faturacao += b.preco || 0;
                                      porMes[mesAno].lucro += b.lucro || 0;
                                    });

                                    return Object.entries(porMes)
                                      .sort((a, b) => {
                                        const dateA = new Date(a[1].ano, a[1].mes);
                                        const dateB = new Date(b[1].ano, b[1].mes);
                                        return dateB - dateA;
                                      })
                                      .slice(0, 3)
                                      .map(([mesAno, stats]) => {
                                        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                                        const mesNome = meses[stats.mes];
                                        return (
                                          <div key={mesAno} className="bg-white rounded-lg p-1.5 border border-gray-200">
                                            <div className="flex justify-between items-center">
                                              <span className="text-xs font-bold text-purple-700">{mesNome}/{stats.ano}</span>
                                              <div className="flex gap-2 text-xs">
                                                <span className="text-gray-600">{stats.quantidade}x</span>
                                                <span className="font-bold text-green-700">‚Ç¨{stats.faturacao.toFixed(0)}</span>
                                              </div>
                                            </div>
                                          </div>
                                        );
                                      });
                                  })()}
                                </div>

                                {/* M√©dia mensal */}
                                <div className="bg-white rounded-lg p-2 border border-purple-200">
                                  <div className="flex justify-between items-center">
                                    <span className="text-xs text-gray-600">M√©dia mensal:</span>
                                    <span className="text-sm font-bold text-purple-600">
                                      {(() => {

                                        const mesesUnicos = new Set(
                                          bolosExternos
                                            .filter(b => b.dataEntrega)
                                            .map(b => {
                                              const d = new Date(b.dataEntrega);
                                              return `${d.getMonth()}-${d.getFullYear()}`;
                                            })
                                        ).size;
                                        const mediaMensal = mesesUnicos > 0 ? faturacaoTotal / mesesUnicos : 0;
                                        return `‚Ç¨${mediaMensal.toFixed(0)}`;
                                      })()}
                                    </span>
                                  </div>
                                </div>

                                {/* Pr√≥ximos bolos (nos pr√≥ximos 7 dias) */}
                                {(() => {
                                  const hoje = new Date();
                                  const seteDias = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);
                                  const proximosBolos = bolosExternos.filter(b => {
                                    if (!b.dataEntrega) return false;
                                    const dataEntrega = new Date(b.dataEntrega);
                                    return dataEntrega >= hoje && dataEntrega <= seteDias;
                                  }).length;

                                  if (proximosBolos > 0) {
                                    return (
                                      <div className="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg p-2 border-2 border-yellow-300 mt-2">
                                        <div className="flex items-center justify-between">
                                          <span className="text-xs font-bold text-orange-800">‚è∞ Pr√≥ximos 7 dias:</span>
                                          <span className="text-sm font-bold text-orange-900">{proximosBolos} bolo{proximosBolos > 1 ? 's' : ''}</span>
                                        </div>
                                      </div>
                                    );
                                  }
                                  return null;
                                })()}
                              </div>

                              <button
                                onClick={() => {
                                  setActiveTab('dashboard');
                                  setDashboardSubTab('bolos');
                                }}
                                className="w-full text-center text-xs text-purple-700 hover:text-purple-900 font-semibold py-2 hover:bg-purple-100 rounded transition"
                              >
                                Ver Detalhes Completos ‚Üí
                              </button>
                            </>
                          )}
                        </div>
                      );
                    })()}
                  </div>

                </div>
              
              </>
            )}

            {dashboardSubTab === 'compras' && (
              <ComprasAnalysis 
                despesas={despesas}
                faturas={faturas}
                ingredientes={ingredientes}
                fornecedores={fornecedores}
                setActiveTab={setActiveTab}
                setExpandedFatura={setExpandedFatura}
                setGestaoSubTab={setGestaoSubTab}
              />
            )}
            {dashboardSubTab === 'delivery' && deliveryApps.some(app => app.ativo) && (
              <>
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                  üöó An√°lise de Delivery
                </h2>
                
                <div className="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-lg p-4 mb-4">
                  <p className="text-sm text-gray-700 mb-2">
                    üí° <strong>Compara√ß√£o de Pre√ßos e Margens</strong> - Produtos Take-Away vs Apps Delivery
                  </p>
                  <p className="text-xs text-gray-600">
                    Apps ativas: {deliveryApps.filter(app => app.ativo).map(app => `${app.nome} (${app.comissao}%)`).join(', ')}
                  </p>
                </div>
                
                {/* Barra de Pesquisa de Produtos Take-Away */}
                <div className="mb-4">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar produto take-away..."
                      value={searchTakeAway}
                      onChange={(e) => setSearchTakeAway(e.target.value)}
                      className="w-full px-4 py-2 border-2 border-orange-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50"
                    />
                    {searchTakeAway && (
                      <button
                        onClick={() => setSearchTakeAway('')}
                        className="absolute right-3 top-2.5 text-orange-500 hover:text-orange-700 font-bold text-lg"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  {searchTakeAway && (
                    <p className="text-xs text-gray-600 mt-1 ml-1">
                      A filtrar por: <span className="font-semibold text-orange-600">{searchTakeAway}</span>
                    </p>
                  )}
                </div>
                
                {/* Filtrar produtos com embalagens */}
                {(() => {

                  const embalagens = ingredientes.filter(i => i.categoria === 'embalagens');

                  const produtosTakeAway = produtos
                    .filter(p => {
                      if (!p.embalagens || !Array.isArray(p.embalagens) || p.embalagens.length === 0) {

                        return false;
                      }
                      
                      const temEmbalagem = p.embalagens.some(e => {
                        const ing = ingredientes.find(i => i.id == e.ingredienteId);
                        if (ing && ing.categoria === 'embalagens') {

                          return true;
                        }
                        return false;
                      });
                      
                      return temEmbalagem;
                    })
                    .filter(p => 
                      p.nome.toLowerCase().includes(searchTakeAway.toLowerCase())
                    );

                  if (produtosTakeAway.length === 0) {

                    const totalTakeAway = produtos.filter(p => {
                      if (!p.embalagens || !Array.isArray(p.embalagens) || p.embalagens.length === 0) {
                        return false;
                      }
                      return p.embalagens.some(e => {
                        const ing = ingredientes.find(i => i.id == e.ingredienteId);
                        return ing && ing.categoria === 'embalagens';
                      });
                    }).length;
                    
                    if (searchTakeAway && totalTakeAway > 0) {

                      return (
                        <div className="text-center py-12 bg-orange-50 rounded-lg border-2 border-orange-200">
                          <p className="text-orange-700 mb-2 font-bold">üîç Nenhum resultado encontrado</p>
                          <p className="text-sm text-orange-600 mb-3">
                            N√£o h√° produtos take-away com o nome "<strong>{searchTakeAway}</strong>"
                          </p>
                          <button
                            onClick={() => setSearchTakeAway('')}
                            className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-semibold"
                          >
                            ‚úï Limpar Pesquisa
                          </button>
                          <p className="text-xs text-gray-600 mt-3">
                            {totalTakeAway} produto{totalTakeAway !== 1 ? 's' : ''} take-away dispon√≠ve{totalTakeAway !== 1 ? 'is' : 'l'}
                          </p>
                        </div>
                      );
                    }

                    return (
                      <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed">
                        <p className="text-gray-600 mb-2">üì¶ Nenhum produto Take-Away encontrado</p>
                        <p className="text-sm text-gray-500 mb-2">
                          Adicione produtos com embalagens (categoria "Embalagens") para ver an√°lise de delivery
                        </p>
                        <div className="text-xs text-left bg-white p-4 rounded mx-auto max-w-md mt-4">
                          <p className="font-bold mb-2">Debug Info:</p>
                          <p>Total produtos: {(produtos || []).length}</p>
                          <p>Total ingredientes: {(ingredientes || []).length}</p>
                          <p>Ingredientes "embalagens": {embalagens.length}</p>
                          <p className="mt-2 text-gray-600">Categorias encontradas:</p>
                          <p className="text-xs">{[...new Set((ingredientes || []).map(i => i.categoria))].join(', ')}</p>
                        </div>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="space-y-4">
                      {searchTakeAway && (
                        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-sm">
                          <p className="text-blue-700">
                            <span className="font-bold">{produtosTakeAway.length}</span> produto{produtosTakeAway.length !== 1 ? 's' : ''} encontrado{produtosTakeAway.length !== 1 ? 's' : ''} para "<strong>{searchTakeAway}</strong>"
                          </p>
                        </div>
                      )}
                      {produtosTakeAway.map(produto => {
                        const precos = calcPrecosPorModalidade(produto);
                        const appsAtivas = deliveryApps.filter(app => app.ativo);
                        
                        return (
                          <div key={produto.id} className="border-2 border-gray-200 rounded-lg overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-3 border-b-2 border-blue-200">
                              <h3 className="font-bold text-lg">{produto.nome}</h3>
                              <p className="text-xs text-gray-600">
                                Custo ingredientes: ‚Ç¨{precos.takeaway.custo - precos.takeaway.custoEmbalagens || 0} | 
                                Custo embalagens: ‚Ç¨{precos.takeaway.custoEmbalagens.toFixed(2)} | 
                                <strong> Total: ‚Ç¨{precos.takeaway.custo.toFixed(2)}</strong>
                              </p>
                            </div>
                            
                            <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                              {/* Take-Away Direto */}
                              <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-2xl">üõçÔ∏è</span>
                                  <div>
                                    <p className="font-bold text-sm">Take-Away Direto</p>
                                    <p className="text-xs text-gray-600">Sem comiss√µes</p>
                                  </div>
                                </div>
                                <div className="space-y-1">
                                  <div className="flex justify-between text-xs">
                                    <span>Pre√ßo:</span>
                                    <span className="font-bold">‚Ç¨{precos.takeaway.preco.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-xs">
                                    <span>Margem:</span>
                                    <span className="font-bold text-green-700">‚Ç¨{precos.takeaway.margem.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-xs">
                                    <span>Margem %:</span>
                                    <span className="font-bold text-green-700">{precos.takeaway.margemPerc.toFixed(0)}%</span>
                                  </div>
                                </div>
                              </div>
                              
                              {/* Apps de Delivery */}
                              {appsAtivas.map(app => {
                                const dados = precos.delivery[app.id];
                                const diferencaMargem = ((dados.margemPerc - precos.takeaway.margemPerc) / precos.takeaway.margemPerc * 100);
                                
                                return (
                                  <div key={app.id} className="bg-orange-50 border-2 border-orange-300 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-2xl">üöó</span>
                                      <div>
                                        <p className="font-bold text-sm">{app.nome}</p>
                                        <p className="text-xs text-gray-600">Comiss√£o {app.comissao}%</p>
                                      </div>
                                    </div>
                                    <div className="space-y-1">
                                      <div className="flex justify-between text-xs">
                                        <span>Pre√ßo sugerido:</span>
                                        <span className="font-bold">‚Ç¨{dados.precoSugerido.toFixed(2)}</span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Receita l√≠quida:</span>
                                        <span className="font-semibold text-blue-600">‚Ç¨{dados.receitaLiquida.toFixed(2)}</span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Margem:</span>
                                        <span className={`font-bold ${dados.margem > 0 ? 'text-green-700' : 'text-red-700'}`}>
                                          ‚Ç¨{dados.margem.toFixed(2)}
                                        </span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Margem %:</span>
                                        <span className={`font-bold ${dados.margem > 0 ? 'text-green-700' : 'text-red-700'}`}>
                                          {dados.margemPerc.toFixed(0)}%
                                        </span>
                                      </div>
                                      <div className="pt-1 border-t border-orange-200">
                                        <p className={`text-xs font-semibold ${diferencaMargem < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                          {diferencaMargem >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(diferencaMargem).toFixed(0)}% vs direto
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            
                            {/* Recomenda√ß√£o */}
                            <div className="bg-blue-50 p-3 border-t-2 border-blue-200">
                              <p className="text-xs text-blue-900">
                                <strong>üí° Recomenda√ß√£o:</strong> {(() => {
                                  const melhorApp = appsAtivas.reduce((melhor, app) => {
                                    const dados = precos.delivery[app.id];
                                    const melhorDados = precos.delivery[melhor.id];
                                    return dados.margemPerc > melhorDados.margemPerc ? app : melhor;
                                  });
                                  
                                  const melhorDados = precos.delivery[melhorApp.id];
                                  
                                  if (melhorDados.margemPerc < precos.takeaway.margemPerc * 0.7) {
                                    return `‚ö†Ô∏è Todas as apps reduzem margem >30%. Considere aumentar pre√ßos ou venda direta.`;
                                  }
                                  
                                  return `Melhor app: ${melhorApp.nome} (margem ${melhorDados.margemPerc.toFixed(0)}%)`;
                                })()}
                              </p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>
              </>
            )}

            {dashboardSubTab === 'simuladores' && (
              <>
                {/* Simulador de Custos Laborais */}
                <div className="bg-white rounded-lg shadow p-4 mb-3">
                  <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                    üí∞ Simulador de Custos Laborais
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">
                    Calcula o custo real de um funcion√°rio incluindo subs√≠dios obrigat√≥rios e encargos da Seguran√ßa Social
                  </p>
                  
                  {/* Seletor de Modo */}
                  <div className="mb-4 flex gap-2">
                    <button
                      onClick={() => setModoSimulador('fulltime')}
                      className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${
                        modoSimulador === 'fulltime' 
                          ? 'bg-blue-500 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üëî Full-Time (40h/semana)
                    </button>
                    <button
                      onClick={() => setModoSimulador('parttime')}
                      className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${
                        modoSimulador === 'parttime' 
                          ? 'bg-green-500 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ‚è∞ Part-Time
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {/* Input */}
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                      <h3 className="font-semibold text-blue-900 mb-3">üìù Dados do Sal√°rio</h3>
                      
                      <div className="space-y-3">
                        {modoSimulador === 'parttime' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Horas Semanais
                            </label>
                            <div className="relative">
                              <input
                                type="number"
                                value={horasSemanaisPartTime}
                                onChange={(e) => setHorasSemanaisPartTime(parseFloat(e.target.value) || 0)}
                                className="w-full border rounded px-3 py-2 pr-12"
                                placeholder="8"
                                min="1"
                                max="30"
                              />
                              <span className="absolute right-3 top-2.5 text-gray-500 text-sm">h/sem</span>
                            </div>
                            <p className="text-xs text-gray-600 mt-1">
                              = {((horasSemanaisPartTime / 40) * 100).toFixed(0)}% de um full-time
                            </p>
                          </div>
                        )}
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {modoSimulador === 'fulltime' ? 'Sal√°rio Bruto Mensal' : 'Sal√°rio Refer√™ncia Full-Time'}
                          </label>
                          <div className="relative">
                            <input
                              type="number"
                              value={ordenadoDesejado}
                              onChange={(e) => setOrdenadoDesejado(parseFloat(e.target.value) || 0)}
                              className="w-full border rounded px-3 py-2 pr-8"
                              placeholder="920"
                            />
                            <span className="absolute right-3 top-2.5 text-gray-500 font-semibold">‚Ç¨</span>
                          </div>
                          {modoSimulador === 'parttime' && (
                            <p className="text-xs text-green-700 mt-1 font-medium">
                              ‚Üí Part-time: ‚Ç¨{(ordenadoDesejado * horasSemanaisPartTime / 40).toFixed(2)}/m√™s
                            </p>
                          )}
                        </div>
                        
                        {/* Subs√≠dio de Alimenta√ß√£o */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirSubsidioAlimentacao}
                              onChange={(e) => setIncluirSubsidioAlimentacao(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Subs√≠dio de Alimenta√ß√£o</span>
                          </label>
                          
                          {incluirSubsidioAlimentacao && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="0.10"
                                  value={valorSubsidioAlimentacao}
                                  onChange={(e) => setValorSubsidioAlimentacao(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">
                                  ‚Ç¨/dia √ó {modoSimulador === 'parttime' ? Math.ceil(horasSemanaisPartTime / 5) : '22'} dias
                                </span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                {modoSimulador === 'fulltime' ? (
                                  `= ‚Ç¨${(valorSubsidioAlimentacao * 22).toFixed(2)}/m√™s`
                                ) : (
                                  <>
                                    {horasSemanaisPartTime < 25 ? (
                                      `= ‚Ç¨${(valorSubsidioAlimentacao * Math.ceil(horasSemanaisPartTime / 5) * 0.8).toFixed(2)}/m√™s (proporcional <5h/dia)`
                                    ) : (
                                      `= ‚Ç¨${(valorSubsidioAlimentacao * Math.ceil(horasSemanaisPartTime / 5)).toFixed(2)}/m√™s`
                                    )}
                                  </>
                                )}
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° N√£o obrigat√≥rio no setor privado. Refer√™ncia: ‚Ç¨6.00/dia (fun√ß√£o p√∫blica)
                          </p>
                        </div>
                        
                        {/* Medicina no Trabalho */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirMedicinaTrabalho}
                              onChange={(e) => setIncluirMedicinaTrabalho(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Medicina no Trabalho</span>
                          </label>
                          
                          {incluirMedicinaTrabalho && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="1"
                                  value={valorMedicinaTrabalho}
                                  onChange={(e) => setValorMedicinaTrabalho(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">‚Ç¨/ano</span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                = ‚Ç¨{(valorMedicinaTrabalho / 12).toFixed(2)}/m√™s
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° Obrigat√≥rio. M√©dia: ‚Ç¨80-150/ano por trabalhador
                          </p>
                        </div>
                        
                        {/* Seguro Contra Acidentes */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirSeguroAcidentes}
                              onChange={(e) => setIncluirSeguroAcidentes(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Seguro Contra Acidentes</span>
                          </label>
                          
                          {incluirSeguroAcidentes && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="1"
                                  value={valorSeguroAcidentes}
                                  onChange={(e) => setValorSeguroAcidentes(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">‚Ç¨/ano</span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                = ‚Ç¨{(valorSeguroAcidentes / 12).toFixed(2)}/m√™s
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° Obrigat√≥rio. M√©dia restaura√ß√£o: ‚Ç¨100-200/ano por trabalhador
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Output */}
                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4">
                      <h3 className="font-semibold text-green-900 mb-3">üíµ Custo Real para a Empresa</h3>
                      
                      {(() => {

                        const proporcaoPartTime = modoSimulador === 'parttime' ? horasSemanaisPartTime / 40 : 1;
                        const salarioBase = ordenadoDesejado * proporcaoPartTime;

                        let subsidioAlimentacaoMensal = 0;
                        if (incluirSubsidioAlimentacao) {
                          if (modoSimulador === 'fulltime') {
                            subsidioAlimentacaoMensal = valorSubsidioAlimentacao * 22;
                          } else {
                            const diasTrabalhados = Math.ceil(horasSemanaisPartTime / 5); // aprox dias/semana
                            const valorDiario = horasSemanaisPartTime < 25 ? valorSubsidioAlimentacao * 0.8 : valorSubsidioAlimentacao;
                            subsidioAlimentacaoMensal = valorDiario * diasTrabalhados;
                          }
                        }
                        
                        const salarioComSubsidios = salarioBase + salarioBase / 12 * 2;
                        const tsuBase = salarioComSubsidios * 0.2375;

                        const medicinaTrabalhoMensal = incluirMedicinaTrabalho ? valorMedicinaTrabalho / 12 : 0;
                        const seguroAcidentesMensal = incluirSeguroAcidentes ? valorSeguroAcidentes / 12 : 0;
                        
                        const custoTotal = salarioComSubsidios * 1.2375 + subsidioAlimentacaoMensal + medicinaTrabalhoMensal + seguroAcidentesMensal;
                        
                        return (
                          <>
                            {modoSimulador === 'parttime' && (
                              <div className="bg-green-100 border border-green-300 rounded p-2 mb-3">
                                <p className="text-xs font-semibold text-green-900">
                                  ‚è∞ Part-Time: {horasSemanaisPartTime}h/semana ({(proporcaoPartTime * 100).toFixed(0)}%)
                                </p>
                              </div>
                            )}
                            
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between items-center pb-2 border-b border-green-200">
                                <span className="text-gray-700">Sal√°rio mensal base:</span>
                                <span className="font-semibold">‚Ç¨{salarioBase.toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-xs text-gray-600">
                                <span>Subs√≠dio de F√©rias (1/12):</span>
                                <span>‚Ç¨{(salarioBase / 12).toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-xs text-gray-600 pb-2 border-b border-green-200">
                                <span>Subs√≠dio de Natal (1/12):</span>
                                <span>‚Ç¨{(salarioBase / 12).toFixed(2)}</span>
                              </div>
                              
                              {incluirSubsidioAlimentacao && (
                                <div className="flex justify-between items-center text-xs text-blue-700 pb-2 border-b border-green-200">
                                  <span>Subs√≠dio de Alimenta√ß√£o:</span>
                                  <span>‚Ç¨{subsidioAlimentacaoMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              <div className="flex justify-between items-center pb-2 border-b border-green-200">
                                <span className="text-gray-700">Subtotal com subs√≠dios:</span>
                                <span className="font-semibold">‚Ç¨{(salarioComSubsidios + subsidioAlimentacaoMensal).toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-orange-700 pb-2 border-b border-green-300">
                                <span className="font-medium">TSU Patronal (23.75%):</span>
                                <span className="font-semibold">‚Ç¨{tsuBase.toFixed(2)}</span>
                              </div>
                              
                              {incluirMedicinaTrabalho && (
                                <div className="flex justify-between items-center text-xs text-purple-700 pt-1">
                                  <span>Medicina no Trabalho:</span>
                                  <span>‚Ç¨{medicinaTrabalhoMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              {incluirSeguroAcidentes && (
                                <div className="flex justify-between items-center text-xs text-purple-700 pb-2 border-b-2 border-green-300">
                                  <span>Seguro Contra Acidentes:</span>
                                  <span>‚Ç¨{seguroAcidentesMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              <div className="flex justify-between items-center pt-2">
                                <span className="text-lg font-bold text-green-900">CUSTO TOTAL MENSAL:</span>
                                <span className="text-2xl font-bold text-green-900">
                                  ‚Ç¨{custoTotal.toFixed(2)}
                                </span>
                              </div>
                            </div>
                            
                            <div className="mt-3 pt-3 border-t border-green-300">
                              <div className="text-xs text-green-800 space-y-1">
                                <p>üí° <strong>Custo anual:</strong> ‚Ç¨{(custoTotal * 12).toFixed(2)}</p>
                                <p>üìä <strong>Encargos adicionais:</strong> +{((custoTotal / salarioBase - 1) * 100).toFixed(1)}% sobre sal√°rio base</p>
                              </div>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>
                  
                  {/* Info Box */}
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>‚ÑπÔ∏è O que est√° inclu√≠do:</strong>
                    </p>
                    <ul className="text-xs text-blue-700 mt-2 space-y-1 ml-4">
                      <li>‚Ä¢ <strong>Subs√≠dio de F√©rias</strong>: 1 m√™s de sal√°rio (14¬∫ m√™s) - obrigat√≥rio por lei</li>
                      <li>‚Ä¢ <strong>Subs√≠dio de Natal</strong>: 1 m√™s de sal√°rio (13¬∫ m√™s) - obrigat√≥rio por lei</li>
                      <li>‚Ä¢ <strong>Subs√≠dio de Alimenta√ß√£o</strong>: Opcional (n√£o obrigat√≥rio no setor privado). Isento at√© ‚Ç¨6/dia em dinheiro ou ‚Ç¨10.20/dia em cart√£o</li>
                      <li>‚Ä¢ <strong>TSU Patronal</strong>: 23.75% sobre sal√°rio + subs√≠dios de f√©rias e natal (n√£o incide sobre subs√≠dio alimenta√ß√£o at√© limites isentos)</li>
                      <li>‚Ä¢ <strong>Medicina no Trabalho</strong>: Obrigat√≥rio. Consultas m√©dicas peri√≥dicas para vigil√¢ncia da sa√∫de. M√©dia: ‚Ç¨80-150/ano</li>
                      <li>‚Ä¢ <strong>Seguro Contra Acidentes</strong>: Obrigat√≥rio. Seguro de acidentes de trabalho. M√©dia restaura√ß√£o: ‚Ç¨100-200/ano</li>
                      <li>‚Ä¢ <strong>Nota</strong>: Trabalhador tamb√©m desconta 11% (retido do sal√°rio), mas n√£o est√° inclu√≠do aqui</li>
                    </ul>
                  </div>
                </div>

              </>
            )}

            {/* SUB-TAB: BOLOS EXTERNOS */}
            {dashboardSubTab === 'bolos' && (
              <div className="space-y-4">
                {/* Header */}
                <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 border-2 border-purple-200">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-4xl">üéÇ</span>
                    <div>
                      <h2 className="text-2xl font-bold text-purple-900">
                        Bolos Externos
                      </h2>
                      <p className="text-sm text-purple-700">
                        üìÖ Encomendas do Google Calendar ‚Ä¢ M√©tricas separadas do Munchi
                      </p>
                    </div>
                  </div>
                </div>

                {(() => {

                  const totalBolos = bolosExternos.length;
                  const pesoTotal = bolosExternos.reduce((sum, b) => sum + (b.peso || 0), 0);
                  const faturacaoTotal = bolosExternos.reduce((sum, b) => sum + (b.preco || 0), 0);
                  const lucroTotal = bolosExternos.reduce((sum, b) => sum + (b.lucro || 0), 0);
                  const margemMedia = faturacaoTotal > 0 ? (lucroTotal / faturacaoTotal) * 100 : 0;

                  const porTipo = {};
                  bolosExternos.forEach(b => {
                    const nome = b.nomeBolo || 'Desconhecido';
                    if (!porTipo[nome]) {
                      porTipo[nome] = { quantidade: 0, peso: 0, faturacao: 0, lucro: 0 };
                    }
                    porTipo[nome].quantidade++;
                    porTipo[nome].peso += b.peso || 0;
                    porTipo[nome].faturacao += b.preco || 0;
                    porTipo[nome].lucro += b.lucro || 0;
                  });

                  const porMes = {};
                  bolosExternos.forEach(b => {
                    const data = new Date(b.data);
                    const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                    if (!porMes[mesAno]) {
                      porMes[mesAno] = { quantidade: 0, faturacao: 0, lucro: 0 };
                    }
                    porMes[mesAno].quantidade++;
                    porMes[mesAno].faturacao += b.preco || 0;
                    porMes[mesAno].lucro += b.lucro || 0;
                  });

                  return (
                    <>
                      {/* Cards de Resumo */}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div className="bg-white p-5 rounded-lg border-2 border-blue-200 shadow-sm">
                          <div className="text-sm text-gray-600 mb-1">Bolos Vendidos</div>
                          <div className="text-3xl font-bold text-blue-900">{totalBolos}</div>
                        </div>
                        <div className="bg-white p-5 rounded-lg border-2 border-purple-200 shadow-sm">
                          <div className="text-sm text-gray-600 mb-1">Peso Total</div>
                          <div className="text-3xl font-bold text-purple-900">{pesoTotal.toFixed(1)}kg</div>
                        </div>
                        <div className="bg-white p-5 rounded-lg border-2 border-green-200 shadow-sm">
                          <div className="text-sm text-gray-600 mb-1">Fatura√ß√£o</div>
                          <div className="text-3xl font-bold text-green-900">‚Ç¨{faturacaoTotal.toFixed(2)}</div>
                        </div>
                        <div className="bg-white p-5 rounded-lg border-2 border-yellow-200 shadow-sm">
                          <div className="text-sm text-gray-600 mb-1">Lucro</div>
                          <div className="text-3xl font-bold text-yellow-900">
                            ‚Ç¨{lucroTotal.toFixed(2)}
                            <span className="text-sm ml-2">({margemMedia.toFixed(0)}%)</span>
                          </div>
                        </div>
                      </div>

                      {bolosExternos.length === 0 ? (
                        <div className="bg-white rounded-lg shadow p-12 text-center">
                          <span className="text-6xl mb-4 block">üéÇ</span>
                          <h3 className="text-xl font-bold text-gray-900 mb-2">
                            Nenhum Bolo Externo Registado
                          </h3>
                          <p className="text-gray-600 mb-4">
                            Os bolos agendados no Google Calendar aparecer√£o aqui quando forem registados.
                          </p>
                          <button
                            onClick={() => buscarBolosAgendados()}
                            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                          >
                            üîç Verificar Calendar Agora
                          </button>
                        </div>
                      ) : (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                          {/* Ranking por Tipo */}
                          <div className="bg-white p-6 rounded-lg shadow">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                              üèÜ Ranking por Tipo
                            </h3>
                            <div className="space-y-2">
                              {Object.entries(porTipo)
                                .sort((a, b) => b[1].faturacao - a[1].faturacao)
                                .slice(0, 5)
                                .map(([nome, stats]) => {
                                  const margem = stats.faturacao > 0 ? (stats.lucro / stats.faturacao) * 100 : 0;
                                  return (
                                    <div key={nome} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                      <div className="flex-1">
                                        <div className="font-semibold text-gray-900">{nome}</div>
                                        <div className="text-xs text-gray-600">{stats.quantidade}x ‚Ä¢ {stats.peso.toFixed(1)}kg</div>
                                      </div>
                                      <div className="text-right">
                                        <div className="text-green-700 font-semibold">‚Ç¨{stats.faturacao.toFixed(0)}</div>
                                        <div className="text-xs text-purple-600">{margem.toFixed(0)}%</div>
                                      </div>
                                    </div>
                                  );
                                })
                              }
                            </div>
                          </div>

                          {/* Evolu√ß√£o Mensal */}
                          <div className="bg-white p-6 rounded-lg shadow">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                              üìä Evolu√ß√£o Mensal
                            </h3>
                            <div className="space-y-2">
                              {Object.entries(porMes)
                                .sort((a, b) => b[0].localeCompare(a[0]))
                                .slice(0, 6)
                                .map(([mesAno, stats]) => {
                                  const [ano, mes] = mesAno.split('-');
                                  const nomeMes = new Date(ano, parseInt(mes) - 1).toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' });
                                  const margem = stats.faturacao > 0 ? (stats.lucro / stats.faturacao) * 100 : 0;
                                  return (
                                    <div key={mesAno} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                      <div className="flex-1">
                                        <div className="font-semibold text-gray-900 capitalize">{nomeMes}</div>
                                        <div className="text-xs text-gray-600">{stats.quantidade} bolos</div>
                                      </div>
                                      <div className="text-right">
                                        <div className="text-green-700 font-semibold">‚Ç¨{stats.faturacao.toFixed(0)}</div>
                                        <div className="text-xs text-purple-600">{margem.toFixed(0)}%</div>
                                      </div>
                                    </div>
                                  );
                                })
                              }
                            </div>
                          </div>

                          {/* Hist√≥rico Completo */}
                          <div className="bg-white p-6 rounded-lg shadow lg:col-span-2">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                              üìã Hist√≥rico Completo
                            </h3>
                            <div className="overflow-x-auto">
                              <table className="w-full text-sm">
                                <thead className="bg-gray-100">
                                  <tr>
                                    <th className="p-2 text-left font-semibold text-gray-700">Data</th>
                                    <th className="p-2 text-left font-semibold text-gray-700">Tipo</th>
                                    <th className="p-2 text-left font-semibold text-gray-700">Cliente</th>
                                    <th className="p-2 text-center font-semibold text-gray-700">Peso</th>
                                    <th className="p-2 text-right font-semibold text-gray-700">Pre√ßo</th>
                                    <th className="p-2 text-right font-semibold text-gray-700">Lucro</th>
                                    <th className="p-2 text-right font-semibold text-gray-700">Margem</th>
                                    <th className="p-2 text-center font-semibold text-gray-700">A√ß√µes</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {bolosExternos
                                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                                    .map((bolo, idx) => {
                                      const margem = bolo.preco > 0 ? (bolo.lucro / bolo.preco) * 100 : 0;
                                      return (
                                        <tr key={idx} className="border-b hover:bg-gray-50">
                                          <td className="p-2">
                                            {new Date(bolo.data).toLocaleDateString('pt-PT')}
                                          </td>
                                          <td className="p-2 font-semibold">{bolo.nomeBolo}</td>
                                          <td className="p-2 text-gray-600">{bolo.cliente || '---'}</td>
                                          <td className="p-2 text-center">{bolo.peso}kg</td>
                                          <td className="p-2 text-right text-green-700 font-semibold">
                                            ‚Ç¨{(bolo.preco || 0).toFixed(2)}
                                          </td>
                                          <td className="p-2 text-right text-blue-700 font-semibold">
                                            ‚Ç¨{(bolo.lucro || 0).toFixed(2)}
                                          </td>
                                          <td className="p-2 text-right text-purple-700 font-semibold">
                                            {margem.toFixed(0)}%
                                          </td>
                                          <td className="p-2 text-center">
                                            <button
                                              onClick={async () => {
                                                if (!confirm(`Eliminar bolo ${bolo.nomeBolo} (${bolo.peso}kg) de ${bolo.cliente || 'cliente'}?\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita.\n\nüí° Opcional: Devolver ingredientes ao stock?`)) {
                                                  return;
                                                }

                                                const devolverStock = confirm('Devolver ingredientes ao stock?\n\nClica OK para devolver, Cancelar para apenas eliminar o registo.');
                                                
                                                if (devolverStock && bolo.ingredientesUsados && bolo.ingredientesUsados.length > 0) {

                                                  for (const item of bolo.ingredientesUsados) {
                                                    const ingrediente = ingredientes.find(i => i.id === item.ingredienteId);
                                                    if (ingrediente) {
                                                      const stockAntes = ingrediente.stockAtual || 0;
                                                      ingrediente.stockAtual = stockAntes + item.quantidade;

                                                    }
                                                  }
                                                  setIngredientes([...ingredientes]);
                                                }

                                                if (bolo.id) {
                                                  await db.bolosExternos.delete(bolo.id);
                                                } else {

                                                  const bolosDB = await db.bolosExternos.toArray();
                                                  const boloParaEliminar = bolosDB.find(b => 
                                                    b.timestamp === bolo.timestamp || 
                                                    (b.eventoCalendarId && b.eventoCalendarId === bolo.eventoCalendarId)
                                                  );
                                                  if (boloParaEliminar) {
                                                    await db.bolosExternos.delete(boloParaEliminar.id);
                                                  }
                                                }

                                                setBolosExternos(bolosExternos.filter((b, i) => i !== idx));
                                                
                                                showNotification(
                                                  `üóëÔ∏è Bolo eliminado!\n${bolo.nomeBolo} ${bolo.peso}kg${devolverStock ? '\nüì¶ Ingredientes devolvidos ao stock' : ''}`,
                                                  'success'
                                                );

                                              }}
                                              className="text-red-600 hover:text-red-800 hover:bg-red-100 p-1.5 rounded transition"
                                              title="Eliminar bolo"
                                            >
                                              üóëÔ∏è
                                            </button>
                                          </td>
                                        </tr>
                                      );
                                    })
                                  }
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      )}
                    </>
                  );
                })()}
              </div>
            )}
          </div>
        )}

        {activeTab === 'gestao' && (
          <div className="space-y-3">
            {/* Gest√£o Sub-tabs */}
            <div className="backdrop-blur-lg bg-white/60 border border-white/40 rounded-xl shadow-lg">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'ingredientes', label: 'Ingredientes', icon: FileText },
                  { id: 'produtos', label: 'Produtos', icon: Package },
                  { id: 'faturas', label: 'Faturas', icon: FileText },
                  { id: 'vendas', label: 'Vendas', icon: Upload }
                ].map(tab => {
                  const Icon = tab.icon;
                  return (
                    <button key={tab.id} onClick={() => setGestaoSubTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 font-medium text-xs transition ${
                        gestaoSubTab === tab.id ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-blue-50'
                      }`}>
                      <Icon size={14} />{tab.label}
                    </button>
                  );
                })}
              </div>
            </div>
            

            {gestaoSubTab === 'ingredientes' && (
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <h2 className="text-lg font-bold mb-3">Ingredientes</h2>
                
                <div className={`rounded p-3 mb-3 border ${editandoIngrediente ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-200'}`}>
                  <h3 className="font-semibold text-xs mb-2">{editandoIngrediente ? 'Editar Ingrediente' : 'Adicionar Ingrediente'}</h3>
                  <div className="grid grid-cols-6 gap-2">
                    <input type="text" placeholder="Nome" value={novoIngrediente.nome}
                      onChange={(e) => {
                        const nome = e.target.value;
                        const catDetectada = detectarCategoria(nome);
                        setNovoIngrediente({ ...novoIngrediente, nome: nome, categoria: catDetectada });
                      }}
                      className="border rounded px-2 py-1.5 text-xs" />
                    <select value={novoIngrediente.categoria || 'outros'}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, categoria: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs"
                      title="Categoria auto-detectada (pode editar)">
                      <option value="vegetais">Vegetais</option>
                      <option value="frutas">Frutas</option>
                      <option value="carnes">Carnes</option>
                      <option value="peixe">Peixe</option>
                      <option value="latic√≠nios">Latic√≠nios</option>
                      <option value="padaria">Padaria</option>
                      <option value="pastelaria">Pastelaria</option>
                      <option value="compotas">Compotas</option>
                      <option value="bebidas">Bebidas</option>
                      <option value="temperos">Temperos</option>
                      <option value="embalagens">Embalagens</option>
                      <option value="limpeza">Limpeza</option>
                      <option value="operacionais">Operacionais</option>
                      <option value="outros">Outros</option>
                    </select>
                    <select value={novoIngrediente.unidade}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, unidade: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs">
                      <option value="kg">kg</option>
                      <option value="g">g</option>
                      <option value="L">L</option>
                      <option value="ml">ml</option>
                      <option value="un">un</option>
                    </select>
                    <input type="number" step="0.01" placeholder="Custo ‚Ç¨" value={novoIngrediente.custoUnitario}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, custoUnitario: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs" />
                    <select value={novoIngrediente.iva}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, iva: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs">
                      <option value="6">IVA 6%</option>
                      <option value="13">IVA 13%</option>
                      <option value="23">IVA 23%</option>
                    </select>
                    {editandoIngrediente ? (
                      <div className="flex gap-1">
                        <button onClick={atualizarIngrediente}
                          className="flex-1 bg-yellow-600 text-white rounded px-2 py-1.5 text-xs hover:bg-yellow-700 flex items-center justify-center font-semibold">
                          <Save size={14} />
                        </button>
                        <button onClick={cancelarEdicaoIngrediente}
                          className="bg-gray-400 text-white rounded px-2 py-1.5 text-xs hover:bg-gray-500">
                          X
                        </button>
                      </div>
                    ) : (
                      <button onClick={adicionarIngrediente}
                        className="bg-blue-600 text-white rounded px-3 py-1.5 text-xs hover:bg-blue-700 flex items-center justify-center gap-1 font-semibold">
                        <Plus size={14} />Add
                      </button>
                    )}
                  </div>
                </div>

                {/* üìã Bot√µes de A√ß√µes - Invent√°rio F√≠sico */}
                <div className="flex flex-wrap items-center gap-3 mb-4">
                  {/* üÜï BOT√ÉO DE INVENT√ÅRIO F√çSICO */}
                  <button
                    onClick={iniciarInventario}
                    className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95 flex items-center gap-2"
                  >
                    <span className="text-xl">üìã</span>
                    Fazer Invent√°rio F√≠sico
                  </button>
                  
                  {/* üÜï BOT√ÉO DE HIST√ìRICO (s√≥ aparece se houver invent√°rios) */}
                  {contagensHistorico.length > 0 && (
                    <button
                      onClick={() => setMostrarHistoricoInventarios(true)}
                      className="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all hover:scale-105 active:scale-95 flex items-center gap-2"
                    >
                      <span className="text-xl">üìä</span>
                      Hist√≥rico ({contagensHistorico.length})
                    </button>
                  )}
                  
                  {/* Info sobre invent√°rio */}
                  {contagensHistorico.length > 0 && (() => {
                    const ultimoInventario = contagensHistorico[contagensHistorico.length - 1];
                    const diasDesdeUltimo = Math.floor(
                      (new Date() - new Date(ultimoInventario.dataInicio)) / (1000 * 60 * 60 * 24)
                    );
                    
                    return (
                      <div className="ml-auto flex items-center gap-2 px-4 py-2 bg-purple-50 border border-purple-200 rounded-lg">
                        <span className="text-sm text-purple-700">
                          ‚è±Ô∏è √öltimo invent√°rio h√° {diasDesdeUltimo} {diasDesdeUltimo === 1 ? 'dia' : 'dias'}
                        </span>
                        {diasDesdeUltimo > 7 && (
                          <span className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded">
                            ‚ö†Ô∏è Recomendado
                          </span>
                        )}
                      </div>
                    );
                  })()}
                </div>

                {/* Search Bar e Filtro de Categoria */}
                <div className="mb-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar ingrediente..."
                      value={searchIngredienteGlobal}
                      onChange={(e) => setSearchIngredienteGlobal(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {searchIngredienteGlobal && (
                      <button
                        onClick={() => setSearchIngredienteGlobal('')}
                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 font-bold"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  
                  <select
                    value={categoriaFiltro}
                    onChange={(e) => setCategoriaFiltro(e.target.value)}
                    className="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                  >
                    <option value="todas">üìÅ Todas as Categorias</option>
                    <option value="padaria">üçû Padaria</option>
                    <option value="lacteos">ü•õ Lactic√≠nios</option>
                    <option value="latic√≠nios">üßÄ Latic√≠nios</option>
                    <option value="carnes">ü•© Carnes</option>
                    <option value="peixe">üêü Peixe</option>
                    <option value="vegetais">ü•¨ Vegetais</option>
                    <option value="frutas">üçé Frutas</option>
                    <option value="bebidas">ü•§ Bebidas</option>
                    <option value="cafe">‚òï Caf√©</option>
                    <option value="especiarias">üå∂Ô∏è Especiarias</option>
                    <option value="temperos">üßÇ Temperos</option>
                    <option value="oleos">ü´í √ìleos</option>
                    <option value="cereais">üåæ Cereais</option>
                    <option value="compotas">üçØ Compotas</option>
                    <option value="consumiveis">üß¥ Consum√≠veis</option>
                    <option value="pastelaria">üßÅ Pastelaria</option>
                    <option value="limpeza">üßπ Limpeza</option>
                    <option value="operacionais">üîß Operacionais</option>
                    <option value="outros">üì¶ Outros</option>
                  </select>
                </div>

                {/* Contador de Resultados e Bot√£o Movimenta√ß√µes */}
                <div className="mb-2 flex items-center justify-between">
                  <div className="text-sm text-gray-600">
                    {(() => {
                      const total = (ingredientes || []).length;
                      const filtrados = (ingredientes || []).filter(ing => {
                        const matchNome = normalizeText(ing.nome).includes(normalizeText(searchIngredienteGlobal));
                        const matchCategoria = categoriaFiltro === 'todas' || ing.categoria === categoriaFiltro;
                        return matchNome && matchCategoria;
                      }).length;
                      
                      if (categoriaFiltro !== 'todas' || searchIngredienteGlobal) {
                        return <p>üìä A mostrar <span className="font-bold">{filtrados}</span> de {total} ingredientes</p>;
                      }
                      return <p>üìä Total: <span className="font-bold">{total}</span> ingredientes</p>;
                    })()}
                  </div>
                  
                  <button
                    onClick={() => setMostrarModalMovimentacoes(true)}
                    className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-xs shadow"
                  >
                    <BarChart3 className="w-4 h-4" />
                    üìä Ver Movimenta√ß√µes
                  </button>
                </div>

                <div className="overflow-x-auto rounded border">
                  <table className="w-full text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left font-semibold">Nome</th>
                        <th className="px-2 py-2 text-left font-semibold">Categoria</th>
                        <th className="px-2 py-2 text-left font-semibold">Unid</th>
                        <th className="px-2 py-2 text-right font-semibold">Custo</th>
                        <th className="px-2 py-2 text-center font-semibold">IVA</th>
                        <th className="px-2 py-2 text-left font-semibold">üì¶ Stock</th>
                        <th className="px-2 py-2 text-left font-semibold">‚ôªÔ∏è Desperd√≠cio</th>
                        <th className="px-2 py-2 text-center font-semibold">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        const ingredientesFiltrados = (ingredientes || []).filter(ing => {
                          const matchNome = normalizeText(ing.nome).includes(normalizeText(searchIngredienteGlobal));
                          const matchCategoria = categoriaFiltro === 'todas' || ing.categoria === categoriaFiltro;
                          return matchNome && matchCategoria;
                        });
                        
                        if (ingredientesFiltrados.length === 0) {
                          return (
                            <tr>
                              <td colSpan="8" className="px-4 py-8 text-center text-gray-400 text-sm">
                                {categoriaFiltro !== 'todas' 
                                  ? `Nenhum ingrediente encontrado na categoria "${categoriaFiltro}"` 
                                  : 'Nenhum ingrediente encontrado'}
                              </td>
                            </tr>
                          );
                        }
                        
                        return ingredientesFiltrados.map((ing, idx) => (
                        <tr key={ing.id} className={`border-t ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 py-2 font-medium">{ing.nome}</td>
                          <td className="px-2 py-2">
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded">{ing.categoria || 'outros'}</span>
                          </td>
                          <td className="px-2 py-2">{ing.unidade}</td>
                          <td className="px-2 py-2 text-right">
                            <div className="text-xs">
                              <div className="font-bold text-gray-900">‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}</div>
                              {ing.custoUnitario && ing.iva && (
                                <div className="text-gray-500 text-[10px]">
                                  s/IVA: ‚Ç¨{(ing.custoUnitario / (1 + ing.iva / 100)).toFixed(2)}
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">{ing.iva}%</span>
                          </td>
                          <td className="px-2 py-2">
                            {(() => {
                              const status = getStockStatus(ing);
                              const editandoEste = ingredienteEditandoMin === ing.id;
                              
                              return (
                                <div className="space-y-1">
                                  {/* ALERTA INLINE se stock cr√≠tico/baixo */}
                                  {(status.status === 'CRITICO' || status.status === 'BAIXO') && (
                                    <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                                      status.status === 'CRITICO' 
                                        ? 'bg-red-100 text-red-700' 
                                        : 'bg-orange-100 text-orange-700'
                                    }`}>
                                      {status.status === 'CRITICO' ? 'üî¥ CR√çTICO!' : 'üü† BAIXO'}
                                    </div>
                                  )}
                                  
                                  <div className="flex items-center gap-1">
                                    <span className="text-base">{status.icone}</span>
                                    <div className="flex-1">
                                      <p className="text-xs font-semibold">{(ing.stockAtual || 0).toFixed(2)} {ing.unidade}</p>
                                      {editandoEste ? (
                                        <div className="flex items-center gap-1 mt-0.5">
                                          <input
                                            type="number"
                                            step="0.1"
                                            value={valorMinEdicao}
                                            onChange={(e) => setValorMinEdicao(e.target.value)}
                                            className="w-12 px-1 py-0 text-[10px] border rounded"
                                            autoFocus
                                            onKeyPress={(e) => {
                                              if (e.key === 'Enter') {
                                                const val = parseFloat(valorMinEdicao) || 0;
                                                setIngredientes(ingredientes.map(i => 
                                                  i.id === ing.id ? {...i, stockMinimo: val} : i
                                                ));
                                                showNotification(`Stock m√≠nimo atualizado para ${val}`, 'success');
                                                setIngredienteEditandoMin(null);
                                              }
                                            }}
                                          />
                                          <button
                                            onClick={() => {
                                              const val = parseFloat(valorMinEdicao) || 0;
                                              setIngredientes(ingredientes.map(i => 
                                                i.id === ing.id ? {...i, stockMinimo: val} : i
                                              ));
                                              showNotification(`Stock m√≠nimo atualizado`, 'success');
                                              setIngredienteEditandoMin(null);
                                            }}
                                            className="text-green-600 hover:text-green-800 text-xs"
                                            title="Salvar"
                                          >
                                            ‚úì
                                          </button>
                                          <button
                                            onClick={() => {
                                              setIngredienteEditandoMin(null);
                                            }}
                                            className="text-red-600 hover:text-red-800 text-xs"
                                            title="Cancelar"
                                          >
                                            ‚úï
                                          </button>
                                        </div>
                                      ) : (
                                        <button
                                          onClick={() => {
                                            setIngredienteEditandoMin(ing.id);
                                            setValorMinEdicao(ing.stockMinimo || 0);
                                          }}
                                          className="text-[10px] text-gray-500 hover:text-blue-600 hover:underline"
                                          title="Clica para editar stock m√≠nimo"
                                        >
                                          Min: {ing.stockMinimo || 0} ‚úèÔ∏è
                                        </button>
                                      )}
                                    </div>
                                  </div>
                                  <button
                                    onClick={() => abrirContagem(ing)}
                                    className="text-[10px] px-2 py-0.5 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded font-semibold w-full"
                                    title="Fazer contagem de stock"
                                  >
                                    üìä Contar
                                  </button>
                                </div>
                              );
                            })()}
                          </td>
                          <td className="px-2 py-2">
                            {(() => {
                              const analise = calcularDesperdicio(ing);
                              if (!analise || !analise.temDados || movimentacoesStock.length === 0) {
                                return <span className="text-gray-400 text-xs">-</span>;
                              }
                              
                              return (
                                <div>
                                  <div className={`font-bold text-sm ${
                                    analise.percentualDesperdicio > 25 ? 'text-red-600' :
                                    analise.percentualDesperdicio > 15 ? 'text-orange-600' :
                                    analise.percentualDesperdicio > 10 ? 'text-yellow-600' :
                                    'text-green-600'
                                  }`}>
                                    {analise.percentualDesperdicio.toFixed(1)}%
                                  </div>
                                  <div className="text-xs text-gray-500">
                                    Te√≥rico: {analise.stockTeorico.toFixed(1)} {ing.unidade}
                                  </div>
                                </div>
                              );
                            })()}
                          </td>
                          <td className="px-2 py-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button onClick={() => editarIngrediente(ing)}
                                className="text-yellow-600 hover:bg-yellow-50 p-1 rounded">
                                <Edit2 size={14} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar?')) {
                                  const ingId = ing.id;
                                  // Remover ingrediente da lista
                                  setIngredientes(ingredientes.filter(i => i.id !== ingId));
                                  // Limpar refer√™ncias nas receitas dos produtos
                                  const produtosAfetados = produtos.filter(p => 
                                    p.receita && p.receita.some(r => r.ingredienteId === ingId)
                                  );
                                  if (produtosAfetados.length > 0) {
                                    setProdutos(produtos.map(p => ({
                                      ...p,
                                      receita: p.receita ? p.receita.filter(r => r.ingredienteId !== ingId) : []
                                    })));
                                  }
                                  // Limpar refer√™ncias nos itens das faturas
                                  const faturasAfetadas = faturas.filter(f => 
                                    f.itens && f.itens.some(item => item.ingredienteId === ingId)
                                  );
                                  if (faturasAfetadas.length > 0) {
                                    setFaturas(faturas.map(f => ({
                                      ...f,
                                      itens: f.itens ? f.itens.map(item => {
                                        if (item.ingredienteId !== ingId) return item;
                                        const { ingredienteId, ...itemSemIng } = item;
                                        return itemSemIng;
                                      }) : []
                                    })));
                                  }
                                  const totalAfetados = produtosAfetados.length + faturasAfetadas.length;
                                  if (totalAfetados > 0) {
                                    const msgs = [];
                                    if (produtosAfetados.length > 0) msgs.push(`${produtosAfetados.length} receita(s)`);
                                    if (faturasAfetadas.length > 0) msgs.push(`${faturasAfetadas.length} fatura(s)`);
                                    showNotification(`Eliminado! Refer√™ncias removidas de ${msgs.join(' e ')}.`, 'success');
                                  } else {
                                    showNotification('Eliminado!', 'success');
                                  }
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1 rounded">
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ));
                      })()}
                    </tbody>
                  </table>
                </div>
                {!(ingredientes || []).length && <p className="text-center text-gray-400 py-6 text-xs">Nenhum ingrediente</p>}
              </div>
            )}

            {gestaoSubTab === 'produtos' && (
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <h2 className="text-lg font-bold mb-3">Produtos</h2>
                
                <div className={`rounded p-3 mb-3 border ${editandoProduto ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-200'}`}>
                  <h3 className="font-semibold text-xs mb-2">{editandoProduto ? 'Editar Produto' : 'Adicionar Produto'}</h3>
                  <div className="space-y-2">
                    <div className="grid grid-cols-6 gap-2">
                      <input type="text" placeholder="Nome do produto" value={novoProduto.nome}
                        onChange={(e) => setNovoProduto({ ...novoProduto, nome: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm" />
                      <input type="number" step="0.01" placeholder="Pre√ßo ‚Ç¨" value={novoProduto.precoVenda}
                        onChange={(e) => setNovoProduto({ ...novoProduto, precoVenda: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm" />
                      <select value={novoProduto.iva}
                        onChange={(e) => setNovoProduto({ ...novoProduto, iva: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm">
                        <option value="6">IVA 6%</option>
                        <option value="13">IVA 13%</option>
                        <option value="23">IVA 23%</option>
                      </select>
                      <select value={novoProduto.categoria || 'cafes'}
                        onChange={(e) => setNovoProduto({ ...novoProduto, categoria: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm">
                        <option value="cafes">‚òï Caf√©s</option>
                        <option value="bebidas">ü•§ Bebidas</option>
                        <option value="pratos">üçΩÔ∏è Pratos</option>
                        <option value="sobremesas">üç∞ Sobremesas</option>
                        <option value="takeaway">üì¶ Take Away</option>
                        <option value="outros">üìã Outros</option>
                      </select>
                      <input
                        type="number"
                        min="1"
                        value={novoProduto.porcoes || 1}
                        onChange={(e) => setNovoProduto({...novoProduto, porcoes: parseInt(e.target.value) || 1})}
                        placeholder="N¬∫ Por√ß√µes"
                        title="N¬∫ Por√ß√µes (para bolos/sobremesas)"
                        className="border rounded px-2 py-1.5 text-sm"
                      />
                      {editandoProduto ? (
                        <div className="flex gap-1">
                          <button onClick={atualizarProduto}
                            className="flex-1 bg-yellow-600 text-white rounded px-2 py-1.5 text-xs hover:bg-yellow-700 flex items-center justify-center font-semibold">
                            <Save size={14} />
                          </button>
                          <button onClick={cancelarEdicaoProduto}
                            className="bg-gray-400 text-white rounded px-2 py-1.5 text-xs hover:bg-gray-500">
                            X
                          </button>
                        </div>
                      ) : (
                        <button onClick={adicionarProduto}
                          className="bg-green-600 text-white rounded px-3 py-1.5 text-xs hover:bg-green-700 flex items-center justify-center gap-1 font-semibold">
                          <Plus size={14} />Add
                        </button>
                      )}
                    </div>
                    
                    {/* √Årea de Receita - Expans√≠vel */}
                    {(editandoProduto || novoProduto.nome) && (
                      <div className="bg-white border rounded-lg p-3 space-y-2">
                        <h4 className="font-semibold text-xs text-gray-700 flex items-center gap-1">
                          <FileText size={14} />
                          Receita (Ingredientes):
                        </h4>
                        
                        {/* Search ingredients */}
                        <div className="relative">
                          <input
                            type="text"
                            placeholder="üîç Procurar ingrediente para adicionar..."
                            value={searchIngrediente}
                            onChange={(e) => {
                              setSearchIngrediente(e.target.value);
                              setShowIngredienteSuggestions(e.target.value.length > 0);
                            }}
                            onFocus={() => setShowIngredienteSuggestions(searchIngrediente.length > 0)}
                            className="w-full px-3 py-1.5 border rounded text-sm focus:border-green-500 focus:ring-1 focus:ring-green-200"
                          />
                          
                          {/* Dropdown com resultados */}
                          {showIngredienteSuggestions && searchIngrediente && searchIngrediente.length > 0 && (
                            <div className="absolute z-10 w-full bg-white border rounded shadow-lg mt-1 max-h-40 overflow-y-auto">
                              {ingredientes
                                .filter(ing => 
                                  normalizeText(ing.nome).includes(normalizeText(searchIngrediente)) &&
                                  !novoProduto.receita.find(r => r.ingredienteId === ing.id)
                                )
                                .map(ing => (
                                  <button
                                    key={ing.id}
                                    type="button"
                                    onClick={() => {
                                      setNovoProduto({
                                        ...novoProduto,
                                        receita: [...novoProduto.receita, {
                                          ingredienteId: ing.id,
                                          quantidade: 0,
                                          unidade: ing.unidade
                                        }]
                                      });
                                      setSearchIngrediente('');
                                      setShowIngredienteSuggestions(false);
                                    }}
                                    className="w-full text-left px-3 py-2 hover:bg-green-50 flex justify-between items-center text-sm border-b last:border-b-0"
                                  >
                                    <span className="font-medium">{ing.nome}</span>
                                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
                                      ‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}/{ing.unidade}
                                    </span>
                                  </button>
                                ))}
                              {ingredientes.filter(ing => 
                                normalizeText(ing.nome).includes(normalizeText(searchIngrediente)) &&
                                !novoProduto.receita.find(r => r.ingredienteId === ing.id)
                              ).length === 0 && (
                                <div className="px-3 py-4 text-gray-400 text-center text-xs">
                                  Nenhum ingrediente encontrado
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* Selected ingredients */}
                        <div className="space-y-1">
                          {(novoProduto.receita || []).map((item, idx) => {
                            const ing = ingredientes.find(i => i.id === item.ingredienteId);
                            if (!ing) return null;
                            
                            return (
                              <div key={idx} className="flex items-center gap-2 bg-green-50 p-1.5 rounded border border-green-200">
                                <span className="text-xs font-medium flex-1">{ing.nome}</span>
                                <input 
                                  type="number" 
                                  step="0.01" 
                                  placeholder="Qtd"
                                  value={item.quantidade || ''}
                                  onChange={(e) => {
                                    const newReceita = [...novoProduto.receita];
                                    newReceita[idx].quantidade = parseFloat(e.target.value) || 0;
                                    setNovoProduto({ ...novoProduto, receita: newReceita });
                                  }}
                                  className="border rounded px-2 py-1 text-xs w-20" 
                                />
                                <select
                                  value={item.unidade || ing.unidade}
                                  onChange={(e) => {
                                    const newReceita = [...novoProduto.receita];
                                    newReceita[idx].unidade = e.target.value;
                                    setNovoProduto({ ...novoProduto, receita: newReceita });
                                  }}
                                  className="border rounded px-1 py-1 text-xs w-14"
                                >
                                  <option value="kg">kg</option>
                                  <option value="g">g</option>
                                  <option value="L">L</option>
                                  <option value="ml">ml</option>
                                  <option value="un">un</option>
                                </select>
                                <button
                                  type="button"
                                  onClick={() => {
                                    setNovoProduto({ 
                                      ...novoProduto, 
                                      receita: novoProduto.receita.filter((_, i) => i !== idx) 
                                    });
                                  }}
                                  className="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            );
                          })}
                          {novoProduto.receita.length === 0 && (
                            <p className="text-center text-gray-400 italic py-2 text-xs">
                              Nenhum ingrediente adicionado. Use a pesquisa acima.
                            </p>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {editandoProduto ? (
                      <div className="flex gap-2">
                        <button onClick={atualizarProduto}
                          className="flex-1 bg-yellow-600 text-white rounded px-4 py-2 text-sm hover:bg-yellow-700 flex items-center justify-center gap-2 font-semibold">
                          <Save size={16} />Atualizar Produto
                        </button>
                        <button onClick={cancelarEdicaoProduto}
                          className="bg-gray-400 text-white rounded px-4 py-2 text-sm hover:bg-gray-500 font-semibold">
                          Cancelar
                        </button>
                      </div>
                    ) : (
                      <button onClick={adicionarProduto}
                        className="w-full bg-green-600 text-white rounded px-4 py-2 text-sm hover:bg-green-700 flex items-center justify-center gap-2 font-semibold">
                        <Plus size={16} />Adicionar Produto
                      </button>
                    )}
                  </div>
                </div>

                {/* Search Bar Produtos */}
                <div className="mb-3">
                  <div className="flex gap-2">
                    {/* Barra de Pesquisa */}
                    <div className="relative flex-1">
                      <input
                        type="text"
                        placeholder="üîç Procurar produto..."
                        value={searchProdutoGlobal}
                        onChange={(e) => setSearchProdutoGlobal(e.target.value)}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      {searchProdutoGlobal && (
                        <button
                          onClick={() => setSearchProdutoGlobal('')}
                          className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 font-bold"
                        >
                          ‚úï
                        </button>
                      )}
                    </div>
                    
                    {/* Dropdown de Categoria */}
                    <div className="w-48">
                      <select
                        value={filterCategoriaGlobal}
                        onChange={(e) => setFilterCategoriaGlobal(e.target.value)}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white"
                      >
                        <option value="">üìÇ Todas Categorias</option>
                        <option value="cafes">‚òï Caf√©s</option>
                        <option value="bebidas">ü•§ Bebidas</option>
                        <option value="pratos">üçΩÔ∏è Pratos</option>
                        <option value="sobremesas">üç∞ Sobremesas</option>
                        <option value="takeaway">üì¶ Take Away</option>
                        <option value="outros">üìã Outros</option>
                      </select>
                    </div>
                  </div>
                </div>

                {/* Products Grid - Layout 3 Colunas */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {produtos.filter(p => 
                    p.nome.toLowerCase().includes(searchProdutoGlobal.toLowerCase()) &&
                    (filterCategoriaGlobal === '' || p.categoria === filterCategoriaGlobal)
                  ).map((p) => {
                    const { custo, margem, margemPercentual } = calcMargem(p);
                    const isExpanded = expandedProduct === p.id;

                    const categoriaInfo = {
                      'cafes': { emoji: '‚òï', label: 'Caf√©s', gradient: 'from-amber-400 to-amber-500', textColor: 'text-amber-50' },
                      'bebidas': { emoji: 'ü•§', label: 'Bebidas', gradient: 'from-blue-400 to-blue-500', textColor: 'text-blue-50' },
                      'pratos': { emoji: 'üçΩÔ∏è', label: 'Pratos', gradient: 'from-orange-400 to-orange-500', textColor: 'text-orange-50' },
                      'sobremesas': { emoji: 'üç∞', label: 'Sobremesas', gradient: 'from-pink-400 to-pink-500', textColor: 'text-pink-50' },
                      'takeaway': { emoji: 'üì¶', label: 'Take Away', gradient: 'from-purple-400 to-purple-500', textColor: 'text-purple-50' },
                      'outros': { emoji: 'üìã', label: 'Outros', gradient: 'from-gray-400 to-gray-500', textColor: 'text-gray-50' }
                    };
                    const cat = categoriaInfo[p.categoria] || categoriaInfo['outros'];
                    
                    return (
                      <div key={p.id} className="border-2 rounded-xl overflow-hidden hover:shadow-lg transition bg-white hover:border-blue-400">
                        {/* Header colorido */}
                        <div className={`bg-gradient-to-r ${cat.gradient} p-2`}>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <span className="text-2xl">{cat.emoji}</span>
                              <div>
                                <h3 className="font-bold text-white text-sm">{p.nome}</h3>
                                <p className={`text-xs ${cat.textColor}`}>{cat.label}</p>
                              </div>
                            </div>
                            <span className="font-bold text-white text-lg">‚Ç¨{p.precoVenda.toFixed(2)}</span>
                          </div>
                        </div>
                        
                        {/* Corpo do card */}
                        <div className="p-3">
                          {/* Badges de informa√ß√£o extra */}
                          <div className="flex flex-wrap gap-1 mb-2">
                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                              IVA {p.iva}%
                            </span>
                            {p.porcoes && p.porcoes > 1 && (
                              <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-semibold">
                                üç∞ {p.porcoes}x
                              </span>
                            )}
                            {p.receita && p.receita.some(r => {
                              const ing = ingredientes.find(i => i.id == r.ingredienteId);
                              return ing && ing.categoria === 'embalagens';
                            }) && (
                              <span className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold">
                                üì¶ Take-Away
                              </span>
                            )}
                            {/* üÜï BADGE SUGEST√ÉO DE PRE√áO COMPACTO */}
                            {(() => {
                              const sugestao = calcPrecoSugerido(p);
                              if (!sugestao || !sugestao.diferenciSignificativa) return null;
                              
                              const precoMaiorQueAtual = sugestao.precoSugerido > p.precoVenda;
                              const corFundo = precoMaiorQueAtual ? 'bg-blue-50' : 'bg-green-50';
                              const corTexto = precoMaiorQueAtual ? 'text-blue-700' : 'text-green-700';
                              const corBorda = precoMaiorQueAtual ? 'border-blue-300' : 'border-green-300';
                              const icone = precoMaiorQueAtual ? 'üìà' : 'üìâ';
                              
                              return (
                                <span 
                                  className={`px-2 py-0.5 ${corFundo} ${corTexto} rounded text-xs font-semibold border ${corBorda} cursor-help`}
                                  title={`Sugest√£o: ‚Ç¨${sugestao.precoSugerido.toFixed(2)} (margem ${sugestao.margemReal.toFixed(0)}%)${sugestao.baseadoEmHistorico ? ` - Baseado em ${sugestao.numeroVendas} vendas recentes` : ` - Baseado na categoria ${p.categoria}`}`}
                                >
                                  {icone} ‚Ç¨{sugestao.precoSugerido.toFixed(2)}{sugestao.baseadoEmHistorico ? 'üìä' : ''}
                                </span>
                              );
                            })()}
                          </div>
                          
                          {/* M√©tricas financeiras - Grid 3 colunas */}
                          <div className="grid grid-cols-3 gap-1.5 mb-2 text-xs">
                            <div className="bg-red-50 rounded p-1.5 text-center border border-red-200">
                              <p className="text-red-600 font-semibold text-[10px] mb-0.5">Custo</p>
                              <p className="font-bold text-red-800">‚Ç¨{custo.toFixed(2)}</p>
                            </div>
                            <div className="bg-green-50 rounded p-1.5 text-center border border-green-200 relative group">
                              <p className="text-green-600 font-semibold text-[10px] mb-0.5">
                                Margem
                                <span className="ml-0.5 text-gray-400 cursor-help">‚ÑπÔ∏è</span>
                              </p>
                              <p className="font-bold text-green-800">‚Ç¨{margem.toFixed(2)}</p>
                              
                              {/* Tooltip com breakdown do c√°lculo - COMPACTO */}
                              <div className="absolute left-1/2 -translate-x-1/2 top-full mt-2 bg-gray-900 text-white text-[10px] rounded-md px-2 py-1.5 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-[9999] whitespace-nowrap pointer-events-none">
                                <div className="flex items-center gap-2">
                                  <span>‚Ç¨{p.precoVenda.toFixed(2)}</span>
                                  <span className="text-gray-400">-{p.iva}%</span>
                                  <span className="text-red-300">-‚Ç¨{custo.toFixed(2)}</span>
                                  <span className="text-green-300 font-bold">=‚Ç¨{margem.toFixed(2)}</span>
                                </div>
                                {/* Seta apontando para cima */}
                                <div className="absolute left-1/2 -translate-x-1/2 bottom-full w-0 h-0 border-l-[5px] border-r-[5px] border-b-[5px] border-transparent border-b-gray-900"></div>
                              </div>
                            </div>
                            <div className={`rounded p-1.5 text-center border ${
                              margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                ? 'bg-green-100 border-green-300'
                                : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                  ? 'bg-yellow-100 border-yellow-300'
                                  : 'bg-red-100 border-red-300'
                            }`}>
                              <p className={`font-semibold text-[10px] mb-0.5 ${
                                margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                  ? 'text-green-700'
                                  : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                    ? 'text-yellow-700'
                                    : 'text-red-700'
                              }`}>
                                % {margemPercentual < (configuracoes?.alertas?.margemCritica || 55) ? '‚ö†Ô∏è' : ''}
                              </p>
                              <p className={`font-bold ${
                                margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                  ? 'text-green-900'
                                  : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                    ? 'text-yellow-900'
                                    : 'text-red-900'
                              }`}>
                                {margemPercentual.toFixed(0)}%
                              </p>
                            </div>
                          </div>
                          
                          {/* Alerta de margem baixa */}
                          {margemPercentual < (configuracoes?.alertas?.margemCritica || 55) && (
                            <div className="mb-2 p-1.5 bg-red-50 border border-red-200 rounded">
                              <p className="text-[10px] text-red-700 font-semibold text-center">
                                ‚ö†Ô∏è Margem abaixo de {configuracoes?.alertas?.margemCritica || 55}%
                              </p>
                            </div>
                          )}
                          
                          {/* Bot√µes de a√ß√£o */}
                          <div className="flex gap-1">
                            {p.receita && p.receita.length > 0 && (
                              <button 
                                onClick={() => setExpandedProduct(isExpanded ? null : p.id)}
                                className="flex-1 text-xs bg-blue-50 text-blue-700 hover:bg-blue-100 py-1 rounded font-semibold"
                                title={isExpanded ? "Ocultar receita" : "Ver receita"}
                              >
                                {isExpanded ? '‚ñ≤' : 'üìã'}
                              </button>
                            )}
                            <button 
                              onClick={() => editarProduto(p)}
                              className="flex-1 text-xs bg-yellow-50 text-yellow-700 hover:bg-yellow-100 py-1 rounded font-semibold"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button 
                              onClick={() => {

                                const vendasAssociadas = vendas.filter(v => v.produtoId === p.id);
                                
                                if (vendasAssociadas.length > 0) {
                                  const msg = `‚ö†Ô∏è ATEN√á√ÉO!\n\nEste produto tem ${vendasAssociadas.length} vendas associadas.\n\nSe apagar o produto, as vendas continuar√£o a existir mas podem n√£o aparecer corretamente nas m√©tricas.\n\nRecomenda√ß√£o: Em vez de apagar, edite o nome do produto.\n\nTem a certeza que quer apagar?`;
                                  
                                  if (!confirm(msg)) return;
                                }
                                
                                if (confirm('Eliminar este produto?')) {
                                  setProdutos(produtos.filter(x => x.id !== p.id));
                                  showNotification('Produto eliminado!', 'success');

                                  if (vendasAssociadas.length > 0) {

                                  }
                                }
                              }}
                              className="flex-1 text-xs bg-red-50 text-red-700 hover:bg-red-100 py-1 rounded font-semibold"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                          
                          {/* Receita expandida */}
                          {isExpanded && p.receita && p.receita.length > 0 && (
                            <div className="mt-2 pt-2 border-t">
                              <p className="text-xs font-bold text-gray-700 mb-1 flex items-center gap-1">
                                <FileText size={12} />Receita:
                              </p>
                              <div className="space-y-1">
                                {(p.receita || []).map((item, idx) => {
                                  const ing = ingredientes.find(i => i.id === item.ingredienteId);
                                  if (!ing) return null;

                                  let q = item.quantidade;
                                  const unidadeReceita = item.unidade || ing.unidade;
                                  if (ing.unidade === 'kg' && unidadeReceita === 'g') q = item.quantidade / 1000;
                                  if (ing.unidade === 'L' && unidadeReceita === 'ml') q = item.quantidade / 1000;
                                  if (ing.unidade === 'g' && unidadeReceita === 'kg') q = item.quantidade * 1000;
                                  if (ing.unidade === 'ml' && unidadeReceita === 'L') q = item.quantidade * 1000;
                                  if (unidadeReceita === ing.unidade) q = item.quantidade;

                                  const custoBase = q * ing.custoUnitario;

                                  const percentagemDesperdicio = getPercentagemDesperdicio(ing);
                                  const custoComDesperdicio = custoBase * (1 + percentagemDesperdicio / 100);
                                  
                                  return (
                                    <div key={idx} className="bg-gray-50 p-1.5 rounded">
                                      <div className="flex justify-between items-center text-[10px]">
                                        <span className="font-medium text-gray-800">{ing.nome}</span>
                                        <div className="flex items-center gap-2">
                                          <span className="text-gray-600">{item.quantidade}{item.unidade || ing.unidade}</span>
                                          <span className="font-semibold text-blue-600">‚Ç¨{custoBase.toFixed(2)}</span>
                                        </div>
                                      </div>
                                      {percentagemDesperdicio > 0 && (
                                        <div className="flex justify-between items-center text-[9px] mt-0.5 text-orange-600">
                                          <span>+ Desperd√≠cio ({percentagemDesperdicio.toFixed(0)}%)</span>
                                          <span className="font-bold">‚Ç¨{custoComDesperdicio.toFixed(2)}</span>
                                        </div>
                                      )}
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>

              </div>
            )}

            {gestaoSubTab === 'faturas' && (
              <div className="space-y-6">
                
                {/* Header com bot√£o Guardar */}
                <div className={`rounded-xl shadow-lg p-5 ${faturaEditando ? 'bg-yellow-50 border-2 border-yellow-400' : 'bg-white'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-800">üõí Gest√£o de Compras</h1>
                      <p className="text-gray-500 text-sm">{faturaEditando ? '‚úèÔ∏è Editar fatura' : '‚ûï Nova fatura'}</p>
                    </div>
                    <div className="flex items-center gap-3">
                      {faturaEditando && (
                        <button 
                          onClick={() => {
                            if (confirm('Cancelar edi√ß√£o? As altera√ß√µes ser√£o perdidas.')) {
                              setNovaFatura({
                                numero: '',
                                tipoDocumento: 'FT',
                                data: new Date().toISOString().split('T')[0],
                                fornecedorId: '',
                                itens: [],
                                notas: '',
                                categoria: 'compras',
                                recorrente: false,
                                diaRecorrencia: 1,
                                documentoPDF: null,
                                nomeDocumento: ''
                              });
                              setItemFatura({
                                ingredienteId: '',
                                descricao: '',
                                quantidade: '',
                                unidade: '',
                                precoTotal: '',
                                iva: '13',
                                num_funcionarios: 1
                              });
                              setFaturaEditando(null);
                              setEditandoFatura(false);
                            }
                          }}
                          className="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition font-semibold flex items-center gap-2"
                        >
                          <X className="w-5 h-5" />
                          Cancelar
                        </button>
                      )}
                      <button 
                      onClick={() => {

                        if (!novaFatura.fornecedorId || !novaFatura.numero || (novaFatura.itens || []).length === 0) {
                          alert('‚ö†Ô∏è Preencha fornecedor, n√∫mero da fatura e adicione pelo menos um item!');
                          return;
                        }

                        const totalComIva = (novaFatura.itens || []).reduce((sum, item) => 
                          sum + parseFloat(item.subtotal || item.precoTotal || 0), 0);
                        
                        let subtotalSemIva = 0;
                        let totalIva = 0;
                        
                        (novaFatura.itens || []).forEach(item => {
                          const valorComIva = parseFloat(item.subtotal || item.precoTotal || 0);
                          const taxaIva = parseFloat(item.iva || 0);

                          const valorSemIva = valorComIva / (1 + taxaIva / 100);
                          const valorIva = valorComIva - valorSemIva;
                          
                          subtotalSemIva += valorSemIva;
                          totalIva += valorIva;
                        });

                        const fornecedor = fornecedores.find(f => String(f.id || f) === String(novaFatura.fornecedorId));

                        let fornecedorNome = '';
                        let fornecedorNif = '';
                        
                        if (fornecedor) {
                          fornecedorNome = fornecedor.nome || fornecedor;
                          fornecedorNif = fornecedor.nif || '';
                        } else if (faturaEditando) {

                          const faturaOriginal = faturas.find(f => f.id === faturaEditando);
                          fornecedorNome = faturaOriginal?.fornecedorNome || novaFatura.fornecedorNome || '';
                          fornecedorNif = faturaOriginal?.fornecedorNif || '';
                        }
                        
                        const novaFaturaCompleta = {
                          id: faturaEditando || Date.now(),
                          numero: novaFatura.numero,
                          data: novaFatura.data,
                          fornecedorId: novaFatura.fornecedorId,
                          fornecedorNome: fornecedorNome,
                          fornecedorNif: fornecedorNif,
                          tipo: novaFatura.tipoDocumento,
                          categoria: novaFatura.categoria || 'compras',
                          itens: (novaFatura.itens || []).map(item => ({
                            id: item.id,
                            ingredienteId: item.ingredienteId,
                            ingredienteNome: item.descricao || item.ingredienteNome || '',
                            descricao: item.descricao || item.ingredienteNome || '',
                            quantidade: parseFloat(item.quantidade || 0),
                            unidade: item.unidade || '',
                            precoUnitario: parseFloat(item.precoUnitario || 0),
                            precoTotal: parseFloat(item.precoTotal || 0),
                            subtotal: parseFloat(item.subtotal || item.precoTotal || 0),
                            iva: parseFloat(item.iva || 13)
                          })),
                          subtotal: subtotalSemIva,
                          totalIva: totalIva,
                          totais: {
                            subtotal: subtotalSemIva,
                            totalIva: totalIva,
                            total: totalComIva
                          },
                          total: totalComIva,
                          notas: novaFatura.notas || '',
                          documentoPDF: novaFatura.documentoPDF || null,
                          nomeDocumento: novaFatura.nomeDocumento || '',
                          timestamp: new Date().toISOString()
                        };

                        if (faturaEditando) {

                          setFaturas(faturas.map(f => f.id === faturaEditando ? novaFaturaCompleta : f));
                          showNotification('‚úÖ Fatura atualizada!', 'success');
                        } else {

                          setFaturas([...faturas, novaFaturaCompleta]);
                          showNotification('‚úÖ Fatura guardada!', 'success');
                        }

                        setNovaFatura({
                          numero: '',
                          tipoDocumento: 'FT',
                          data: new Date().toISOString().split('T')[0],
                          fornecedorId: '',
                          itens: [],
                          notas: '',
                          categoria: 'compras',
                          recorrente: false,
                          diaRecorrencia: 1,
                          documentoPDF: null,
                          nomeDocumento: ''
                        });
                        setItemFatura({
                          ingredienteId: '',
                          descricao: '',
                          quantidade: '',
                          unidade: '',
                          precoTotal: '',
                          iva: '13',
                          num_funcionarios: 1
                        });
                        setFaturaEditando(null);
                        setEditandoFatura(false);

                      }}
                      className={`px-6 py-3 text-white rounded-lg hover:shadow-lg transition font-semibold flex items-center gap-2 ${
                        faturaEditando 
                          ? 'bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600' 
                          : 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700'
                      }`}
                    >
                      <Check className="w-5 h-5" />
                      {faturaEditando ? 'Atualizar' : 'Guardar'}
                    </button>
                    </div>
                  </div>
                </div>

                {/* Main Content: 3 Columns - HORIZONTAL para telem√≥vel */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  
                  {/* 1¬™ COLUNA (MOBILE): Importa√ß√£o OCR - 3¬™ no desktop */}
                  <div className="col-span-1 lg:order-3">
                    <div className="bg-white rounded-xl shadow-lg p-5">
                      <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span className="text-xl">üì∏</span> Importa√ß√£o
                      </h3>
                      
                      <div className="space-y-3">
                        {/* OCR Local */}
                        <input
                          type="file"
                          accept=".pdf,image/*"
                          onChange={handleLerPDFAutomatico}
                          className="hidden"
                          id="ocr-compras-local"
                          disabled={processandoOCR}
                        />
                        <label
                          htmlFor="ocr-compras-local"
                          className={`block w-full ${
                            processandoOCR 
                              ? 'bg-gray-400 cursor-not-allowed' 
                              : 'bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 cursor-pointer'
                          } text-white font-semibold py-4 rounded-lg transition shadow-md text-center`}
                        >
                          <div className="flex flex-col items-center gap-1">
                            <span className="text-xl">‚ö°</span>
                            <span>OCR Local</span>
                            <span className="text-xs opacity-80">R√°pido</span>
                          </div>
                        </label>
                        
                        {/* Google OCR */}
                        {driveAccessToken ? (
                          <button 
                            onClick={handleImportarDriveComOCR}
                            disabled={processandoOCR}
                            className={`w-full ${
                              processandoOCR 
                                ? 'bg-gray-400 cursor-not-allowed' 
                                : 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700'
                            } text-white font-semibold py-4 rounded-lg transition shadow-md flex flex-col items-center gap-1`}
                          >
                            <span className="text-xl">üåê</span>
                            <span>Google OCR</span>
                            <span className="text-xs opacity-80">Melhor qualidade</span>
                          </button>
                        ) : (
                          <button 
                            onClick={() => {
                              setActiveTab('definicoes');
                              setBackupExpanded(true);
                              setTimeout(() => {
                                const driveSection = document.getElementById('google-drive-section');
                                if (driveSection) {
                                  driveSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                              }, 100);
                            }}
                            className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-semibold py-4 rounded-lg transition shadow-md flex flex-col items-center gap-1"
                          >
                            <span className="text-xl">üîå</span>
                            <span>Conectar Drive</span>
                            <span className="text-xs opacity-80">Para Google OCR</span>
                          </button>
                        )}
                      </div>
                      
                      {processandoOCR && (
                        <div className="mt-4 pt-4 border-t">
                          <div className="flex items-center justify-center gap-2 text-sm text-gray-600">
                            <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                            </svg>
                            <span>{progressoOCR || 'Processando...'}</span>
                          </div>
                        </div>
                      )}
                      
                      <div className="mt-4 pt-4 border-t">
                        <p className="text-xs text-gray-500 text-center">ou preencha manualmente abaixo</p>
                      </div>
                    </div>
                  </div>

                  {/* 2¬™ COLUNA (MOBILE): Dados da Fatura - 2¬™ no desktop */}
                  <div className="col-span-1 lg:order-2">
                    <div className="bg-white rounded-xl shadow-lg p-5">
                      <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span className="text-xl">üìã</span> Dados da Fatura
                      </h3>
                      
                      <div className="space-y-3">
                        <div>
                          <label className="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">
                            Fornecedor <span className="text-red-500">*</span>
                          </label>
                          <select 
                            value={novaFatura.fornecedorId}
                            onChange={(e) => {
                              setNovaFatura({...novaFatura, fornecedorId: e.target.value});
                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                          >
                            <option value="">Selecionar fornecedor...</option>
                            {fornecedores.map(f => (
                              <option key={f.id || f} value={f.id || f}>
                                {f.nome || f} {f.nif ? `(${f.nif})` : ''}
                              </option>
                            ))}
                          </select>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">
                              N¬∫ Fatura <span className="text-red-500">*</span>
                            </label>
                            <input 
                              type="text" 
                              placeholder="FT 2025/001"
                              value={novaFatura.numero}
                              onChange={(e) => setNovaFatura({...novaFatura, numero: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">
                              Data <span className="text-red-500">*</span>
                            </label>
                            <input 
                              type="date" 
                              value={novaFatura.data}
                              onChange={(e) => setNovaFatura({...novaFatura, data: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">
                            Tipo Documento
                          </label>
                          <select 
                            value={novaFatura.tipoDocumento}
                            onChange={(e) => setNovaFatura({...novaFatura, tipoDocumento: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                          >
                            <option value="FT">FT - Fatura</option>
                            <option value="FS">FS - Fatura Simplificada</option>
                            <option value="FR">FR - Fatura-Recibo</option>
                            <option value="NC">NC - Nota de Cr√©dito</option>
                            <option value="ND">ND - Nota de D√©bito</option>
                            <option value="GR">GR - Guia de Remessa</option>
                          </select>
                        </div>

                        <div>
                          <label className="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">
                            Observa√ß√µes
                          </label>
                          <textarea 
                            placeholder="Notas adicionais..."
                            value={novaFatura.observacoes}
                            onChange={(e) => setNovaFatura({...novaFatura, observacoes: e.target.value})}
                            rows="3"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm resize-none"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* 3¬™ COLUNA (MOBILE): Items + Resumo - 1¬™ no desktop */}
                  <div className="col-span-1 lg:order-1 space-y-4">
                    {/* Items */}
                    <div className="bg-white rounded-xl shadow-lg p-5">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                          <span className="text-xl">üì¶</span> Items
                        </h3>
                      </div>
                      
                      {/* Add Item Form */}
                      <div className="space-y-2 mb-3 bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <div className="relative">
                          <input 
                            type="text" 
                            placeholder="Ingrediente..."
                            value={searchIngredienteCompra}
                            onChange={(e) => {
                              setSearchIngredienteCompra(e.target.value);
                              setShowDropdownIngredienteCompra(true);
                            }}
                            onFocus={() => setShowDropdownIngredienteCompra(true)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                          />
                          
                          {/* Dropdown Ingredientes */}
                          {showDropdownIngredienteCompra && (
                            <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                              {ingredientes
                                .filter(ing => !searchIngredienteCompra || normalizeText(ing.nome).includes(normalizeText(searchIngredienteCompra)))
                                .map(ing => (
                                  <div
                                    key={ing.id}
                                    onClick={() => {
                                      setItemFatura({
                                        ...itemFatura,
                                        ingrediente: ing.nome,
                                        ingredienteId: ing.id,
                                        preco: ing.custoUnitario.toString()
                                      });
                                      setSearchIngredienteCompra(ing.nome);
                                      setShowDropdownIngredienteCompra(false);
                                    }}
                                    className="px-3 py-2 hover:bg-green-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                  >
                                    <div className="font-medium text-sm">{ing.nome}</div>
                                    <div className="text-xs text-gray-600">
                                      ‚Ç¨{(ing.custoUnitario || 0).toFixed(2)}/{ing.unidade}
                                    </div>
                                  </div>
                                ))}
                              
                              {ingredientes.filter(ing => !searchIngredienteCompra || normalizeText(ing.nome).includes(normalizeText(searchIngredienteCompra))).length === 0 && (
                                <div className="px-3 py-4 text-center text-gray-500 text-sm">
                                  Nenhum ingrediente encontrado
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-2">
                          <input 
                            type="number" 
                            placeholder="Qtd."
                            value={itemFatura.quantidade}
                            onChange={(e) => setItemFatura({...itemFatura, quantidade: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                          />
                          <input 
                            type="number" 
                            placeholder="Pre√ßo ‚Ç¨"
                            value={itemFatura.preco}
                            onChange={(e) => setItemFatura({...itemFatura, preco: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                          />
                        </div>
                        
                        <button 
                          onClick={() => {
                            if (!itemFatura.ingrediente || !itemFatura.quantidade || !itemFatura.preco) {
                              alert('‚ö†Ô∏è Preencha todos os campos!');
                              return;
                            }
                            
                            const novoItem = {
                              id: Date.now(),
                              ...itemFatura
                            };
                            
                            setNovaFatura({
                              ...novaFatura,
                              items: [...novaFatura.itens, novoItem]
                            });
                            
                            setItemFatura({
                              ingrediente: '',
                              quantidade: '',
                              preco: '',
                              ingredienteId: ''
                            });
                            setSearchIngredienteCompra('');
                          }}
                          className="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold text-sm transition"
                        >
                          + Adicionar
                        </button>
                      </div>

                      {/* Items List */}
                      <div className="border-t pt-3">
                        {novaFatura.itens.length === 0 ? (
                          <p className="text-center text-gray-400 text-xs py-6">
                            Nenhum item adicionado
                          </p>
                        ) : (
                          <div className="space-y-2">
                            {novaFatura.itens.map(item => (
                              <div key={item.id} className={`bg-gray-50 p-2 rounded border ${editandoItemId === item.id ? 'border-blue-400 bg-blue-50' : ''}`}>
                                {editandoItemId === item.id ? (

                                  <div className="space-y-2">
                                    {/* Searchbox para ingrediente com dropdown - APENAS PARA COMPRAS */}
                                    <div className="relative">
                                      <input 
                                        type="text"
                                        value={itemEditTemp.descricao || ''}
                                        onChange={(e) => {
                                          setItemEditTemp({...itemEditTemp, descricao: e.target.value});
                                          if (novaFatura.categoria === 'compras') {
                                            setShowDropdownEditItem(true);
                                          }
                                        }}
                                        onFocus={() => {
                                          if (novaFatura.categoria === 'compras') {
                                            setShowDropdownEditItem(true);
                                          }
                                        }}
                                        onBlur={() => {

                                          setTimeout(() => setShowDropdownEditItem(false), 200);
                                        }}
                                        className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                        placeholder={novaFatura.categoria === 'compras' ? 'üîç Procurar ingrediente...' : 'Descri√ß√£o'}
                                      />
                                      
                                      {/* Dropdown Ingredientes para edi√ß√£o - S√ì APARECE PARA COMPRAS */}
                                      {novaFatura.categoria === 'compras' && showDropdownEditItem && itemEditTemp.descricao && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                          {ingredientes
                                            .filter(ing => normalizeText(ing.nome).includes(normalizeText(itemEditTemp.descricao)))
                                            .map(ing => (
                                              <div
                                                key={ing.id}
                                                onClick={() => {
                                                  setItemEditTemp({
                                                    ...itemEditTemp, 
                                                    descricao: ing.nome,
                                                    ingredienteId: ing.id
                                                  });
                                                  setShowDropdownEditItem(false);
                                                }}
                                                className="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                              >
                                                <div className="font-medium text-sm">{ing.nome}</div>
                                                <div className="text-xs text-gray-600">
                                                  ‚Ç¨{(ing.custoUnitario || 0).toFixed(2)}/{ing.unidade}
                                                </div>
                                              </div>
                                            ))}
                                          
                                          {ingredientes.filter(ing => normalizeText(ing.nome).includes(normalizeText(itemEditTemp.descricao))).length === 0 && (
                                            <div className="px-3 py-4 text-center text-gray-500 text-sm">
                                              Nenhum ingrediente encontrado
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                    
                                    {/* Mostrar quantidade e unidade APENAS para compras */}
                                    {novaFatura.categoria === 'compras' && (
                                      <div className="grid grid-cols-2 gap-2">
                                        <input 
                                          type="number"
                                          step="0.01"
                                          value={itemEditTemp.quantidade || ''}
                                          onChange={(e) => {
                                            const qtd = parseFloat(e.target.value) || 0;
                                            const precoTotal = parseFloat(itemEditTemp.precoTotal) || 0;
                                            setItemEditTemp({
                                              ...itemEditTemp, 
                                              quantidade: e.target.value,
                                              precoUnitario: qtd > 0 ? (precoTotal / qtd).toFixed(4) : '0' // Recalcular pre√ßo unit√°rio
                                            });
                                          }}
                                          className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                          placeholder="Quantidade"
                                        />
                                        <select
                                          value={itemEditTemp.unidade || 'kg'}
                                          onChange={(e) => setItemEditTemp({...itemEditTemp, unidade: e.target.value})}
                                          className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                        >
                                          <option value="kg">kg</option>
                                          <option value="g">g</option>
                                          <option value="L">L</option>
                                          <option value="ml">ml</option>
                                          <option value="un">un</option>
                                          <option value="cx">cx</option>
                                          <option value="pc">pc</option>
                                        </select>
                                      </div>
                                    )}
                                    
                                    {/* Mostrar apenas pre√ßo total para compras (pre√ßo unit√°rio calculado automaticamente em background) */}
                                    {novaFatura.categoria === 'compras' ? (
                                      <input 
                                        type="number"
                                        step="0.01"
                                        value={itemEditTemp.precoTotal || ''}
                                        onChange={(e) => {
                                          const precoTotal = parseFloat(e.target.value) || 0;
                                          const qtd = parseFloat(itemEditTemp.quantidade) || 1;
                                          setItemEditTemp({
                                            ...itemEditTemp, 
                                            precoTotal: e.target.value,
                                            precoUnitario: qtd > 0 ? (precoTotal / qtd).toFixed(4) : '0' // Calculado em background
                                          });
                                        }}
                                        className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                        placeholder="Pre√ßo Total (com IVA) ‚Ç¨"
                                      />
                                    ) : (
                                      <input 
                                        type="number"
                                        step="0.01"
                                        value={itemEditTemp.precoTotal || ''}
                                        onChange={(e) => setItemEditTemp({...itemEditTemp, precoTotal: e.target.value})}
                                        className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                        placeholder="Valor Total (com IVA) ‚Ç¨"
                                      />
                                    )}
                                    
                                    <select
                                      value={itemEditTemp.iva || '13'}
                                      onChange={(e) => setItemEditTemp({...itemEditTemp, iva: e.target.value})}
                                      className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                    >
                                      <option value="6">IVA 6%</option>
                                      <option value="13">IVA 13%</option>
                                      <option value="23">IVA 23%</option>
                                    </select>
                                    
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => {

                                          const quantidade = novaFatura.categoria === 'compras' ? (parseFloat(itemEditTemp.quantidade) || 0) : 1;
                                          const precoUnitario = novaFatura.categoria === 'compras' ? (parseFloat(itemEditTemp.precoUnitario) || 0) : 0;
                                          const precoTotal = parseFloat(itemEditTemp.precoTotal) || 0;
                                          const iva = parseFloat(itemEditTemp.iva) || 13;

                                          const subtotal = precoTotal / (1 + iva / 100);
                                          
                                          setNovaFatura({
                                            ...novaFatura,
                                            itens: novaFatura.itens.map(i => 
                                              i.id === item.id ? {
                                                ...i,
                                                descricao: itemEditTemp.descricao,
                                                ingredienteNome: itemEditTemp.descricao,
                                                quantidade: quantidade,
                                                unidade: novaFatura.categoria === 'compras' ? itemEditTemp.unidade : '',
                                                precoUnitario: precoUnitario,
                                                precoTotal: precoTotal,
                                                subtotal: subtotal, // ‚úÖ Calculado automaticamente
                                                iva: iva
                                              } : i
                                            )
                                          });
                                          setEditandoItemId(null);
                                          setItemEditTemp(null);
                                          setShowDropdownEditItem(false); // Fechar dropdown
                                        }}
                                        className="flex-1 bg-green-500 hover:bg-green-600 text-white py-1 rounded text-xs font-semibold"
                                      >
                                        ‚úì Guardar
                                      </button>
                                      <button
                                        onClick={() => {
                                          setEditandoItemId(null);
                                          setItemEditTemp(null);
                                          setShowDropdownEditItem(false); // Fechar dropdown
                                        }}
                                        className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-1 rounded text-xs font-semibold"
                                      >
                                        ‚úï Cancelar
                                      </button>
                                    </div>
                                  </div>
                                ) : (

                                  <div className="flex items-center justify-between">
                                    <div className="flex-1">
                                      <p className="text-sm font-medium text-gray-800">{item.descricao || item.ingredienteNome || 'Item'}</p>
                                      <p className="text-xs text-gray-500">
                                        {item.quantidade} {item.unidade || ''} x ‚Ç¨{parseFloat(item.precoUnitario || 0).toFixed(2)} = ‚Ç¨{parseFloat(item.precoTotal || 0).toFixed(2)}
                                      </p>
                                      {item.iva && <p className="text-xs text-gray-400">IVA: {item.iva}%</p>}
                                    </div>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={() => {
                                          setEditandoItemId(item.id);
                                          setItemEditTemp({
                                            descricao: item.descricao || item.ingredienteNome || '',
                                            quantidade: item.quantidade || '',
                                            unidade: item.unidade || '',
                                            precoUnitario: item.precoUnitario || '',
                                            precoTotal: item.precoTotal || '',
                                            subtotal: item.subtotal || item.precoTotal || '',
                                            iva: item.iva || 13
                                          });
                                        }}
                                        className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                        title="Editar item"
                                      >
                                        <Edit2 className="w-4 h-4" />
                                      </button>
                                      <button
                                        onClick={() => {
                                          if (confirm('Eliminar este item?')) {
                                            setNovaFatura({
                                              ...novaFatura,
                                              itens: novaFatura.itens.filter(i => i.id !== item.id)
                                            });
                                          }
                                        }}
                                        className="text-red-600 hover:bg-red-50 p-1 rounded"
                                        title="Eliminar item"
                                      >
                                        <Trash2 className="w-4 h-4" />
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Resumo */}
                    <div className="bg-white rounded-xl shadow-lg p-5">
                      <h4 className="font-semibold text-gray-700 mb-3 text-sm">üìä Resumo</h4>
                      {novaFatura.itens.length > 0 ? (
                        <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                          <div className="flex justify-between text-sm mb-1">
                            <span>Subtotal:</span>
                            <span className="font-semibold">‚Ç¨{novaFatura.itens.reduce((s, i) => s + (parseFloat(i.subtotal || 0)), 0).toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between text-sm mb-1">
                            <span>IVA Total:</span>
                            <span className="font-semibold">‚Ç¨{novaFatura.itens.reduce((s, i) => s + ((parseFloat(i.subtotal || 0)) * (parseFloat(i.iva || 0)) / 100), 0).toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between text-base font-bold border-t border-blue-300 pt-2 mt-1">
                            <span>Total c/ IVA:</span>
                            <span className="text-blue-700">‚Ç¨{novaFatura.itens.reduce((s, i) => s + ((parseFloat(i.subtotal || 0)) * (1 + (parseFloat(i.iva || 0)) / 100)), 0).toFixed(2)}</span>
                          </div>
                        </div>
                      ) : (
                        <div className="text-center text-gray-500 text-sm py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                          Nenhum item adicionado
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Compras Registadas */}
                <div className="bg-white rounded-xl shadow-lg p-5">
                  
                  {/* Filtros: Ano, M√™s e Fornecedor */}
                  <div className="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                    <div className="grid grid-cols-3 gap-3">
                      {/* Filtro de Ano */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Ano</label>
                        <select
                          value={anoFaturaSelecionado}
                          onChange={(e) => setAnoFaturaSelecionado(Number(e.target.value))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                        >
                          {(() => {
                            const anos = [...new Set(
                              faturas
                                .filter(f => f.data)
                                .map(f => new Date(f.data).getFullYear())
                                .filter(ano => !isNaN(ano))
                            )].sort((a, b) => b - a);
                            
                            if (anos.length === 0) {
                              anos.push(new Date().getFullYear());
                            }
                            
                            return anos.map(ano => (
                              <option key={ano} value={ano}>{ano}</option>
                            ));
                          })()}
                        </select>
                      </div>
                      
                      {/* Filtro de M√™s */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üìÜ M√™s</label>
                        <select
                          value={mesFaturaSelecionado ?? ''}
                          onChange={(e) => setMesFaturaSelecionado(e.target.value === '' ? null : Number(e.target.value))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                        >
                          <option value="">Todos os meses</option>
                          <option value="0">Janeiro</option>
                          <option value="1">Fevereiro</option>
                          <option value="2">Mar√ßo</option>
                          <option value="3">Abril</option>
                          <option value="4">Maio</option>
                          <option value="5">Junho</option>
                          <option value="6">Julho</option>
                          <option value="7">Agosto</option>
                          <option value="8">Setembro</option>
                          <option value="9">Outubro</option>
                          <option value="10">Novembro</option>
                          <option value="11">Dezembro</option>
                        </select>
                      </div>
                      
                      {/* Filtro de Fornecedor */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üè™ Fornecedor</label>
                        <select
                          value={fornecedorFiltro}
                          onChange={(e) => setFornecedorFiltro(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                        >
                          <option value="">Todos os fornecedores</option>
                          {(() => {
                            const fornecedoresUnicos = [...new Set(
                              faturas
                                .map(f => f.fornecedorNome || '')
                                .filter(Boolean)
                            )].sort();
                            return fornecedoresUnicos.map(nome => (
                              <option key={nome} value={nome}>{nome}</option>
                            ));
                          })()}
                        </select>
                      </div>
                      
                      {/* üÜï FILTRO POR CATEGORIA */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üìã Categoria</label>
                        <select 
                          value={categoriaFaturaFiltro || ''}
                          onChange={(e) => setCategoriaFaturaFiltro(e.target.value || null)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                        >
                          <option value="">Todas as categorias</option>
                          <option value="compras">üõí Compras</option>
                          <option value="compras_alimentares">üçΩÔ∏è Compras Alimentares</option>
                          <option value="materiais_operacionais">üßπ Materiais Operacionais</option>
                          <option value="embalagens_consumiveis">üì¶ Embalagens/Consum√≠veis</option>
                          <option value="renda">üè† Renda</option>
                          <option value="salarios">üë• Sal√°rios</option>
                          <option value="eletricidade">‚ö° Eletricidade</option>
                          <option value="agua">üíß √Ågua</option>
                          <option value="gas">üî• G√°s</option>
                          <option value="internet">üåê Internet</option>
                          <option value="consumiveis">üì¶ Consum√≠veis</option>
                          <option value="marketing">üì¢ Marketing</option>
                          <option value="manutencao">üîß Manuten√ß√£o</option>
                          <option value="outros">üìã Outros</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                      <span className="text-xl">üõí</span> 
                      Compras Registadas ({faturas
                        .filter(f => {
                          const faturaDate = new Date(f.data);
                          const ano = faturaDate.getFullYear();
                          const mes = faturaDate.getMonth();
                          
                          if (ano !== anoFaturaSelecionado) return false;
                          if (mesFaturaSelecionado !== null && mes !== mesFaturaSelecionado) return false;
                          
                          if (fornecedorFiltro && f.fornecedorNome !== fornecedorFiltro) return false;

                          if (categoriaFaturaFiltro) {

                            if (['compras_alimentares', 'materiais_operacionais', 'embalagens_consumiveis'].includes(categoriaFaturaFiltro)) {
                              if (f.categoria !== 'compras' || !f.itens || f.itens.length === 0) return false;

                              const temItemDaCategoria = f.itens.some(item => {
                                const ingrediente = item.ingredienteId ? ingredientes.find(i => i.id === item.ingredienteId) : null;
                                
                                if (categoriaFaturaFiltro === 'compras_alimentares') {
                                  return ingrediente && !['limpeza', 'operacionais', 'embalagens'].includes(ingrediente.categoria);
                                } else if (categoriaFaturaFiltro === 'materiais_operacionais') {
                                  return ingrediente && ['limpeza', 'operacionais'].includes(ingrediente.categoria);
                                } else if (categoriaFaturaFiltro === 'embalagens_consumiveis') {
                                  return ingrediente && ingrediente.categoria === 'embalagens';
                                }
                                return false;
                              });
                              
                              if (!temItemDaCategoria) return false;
                            } else {

                              if (f.categoria !== categoriaFaturaFiltro) return false;
                            }
                          }
                          
                          return true;
                        }).length})
                    </h3>
                    <div className="flex items-center gap-3 text-xs">
                      <span className="flex items-center gap-1 bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold">
                        <FileText className="w-3 h-3" />
                        {faturas.filter(f => f.documentoPDF).length} com PDF
                      </span>
                      <span className="flex items-center gap-1 bg-red-100 text-red-700 px-3 py-1 rounded-full font-semibold">
                        <AlertCircle className="w-3 h-3" />
                        {faturas.filter(f => !f.documentoPDF).length} sem PDF
                      </span>
                    </div>
                  </div>
                  
                  {/* üÜï BADGE DE FILTRO ATIVO */}
                  {categoriaFaturaFiltro && (
                    <div className="mb-4 flex items-center gap-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
                      <span className="text-sm text-blue-800">
                        üîç Mostrando apenas: <strong>
                          {categoriaFaturaFiltro === 'compras' && 'üõí Compras'}
                          {categoriaFaturaFiltro === 'compras_alimentares' && 'üçΩÔ∏è Compras Alimentares'}
                          {categoriaFaturaFiltro === 'materiais_operacionais' && 'üßπ Materiais Operacionais'}
                          {categoriaFaturaFiltro === 'embalagens_consumiveis' && 'üì¶ Embalagens/Consum√≠veis'}
                          {categoriaFaturaFiltro === 'renda' && 'üè† Renda'}
                          {categoriaFaturaFiltro === 'salarios' && 'üë• Sal√°rios'}
                          {categoriaFaturaFiltro === 'eletricidade' && '‚ö° Eletricidade'}
                          {categoriaFaturaFiltro === 'agua' && 'üíß √Ågua'}
                          {categoriaFaturaFiltro === 'gas' && 'üî• G√°s'}
                          {categoriaFaturaFiltro === 'internet' && 'üåê Internet'}
                          {categoriaFaturaFiltro === 'consumiveis' && 'üì¶ Consum√≠veis'}
                          {categoriaFaturaFiltro === 'marketing' && 'üì¢ Marketing'}
                          {categoriaFaturaFiltro === 'manutencao' && 'üîß Manuten√ß√£o'}
                          {categoriaFaturaFiltro === 'outros' && 'üìã Outros'}
                        </strong>
                      </span>
                      <button
                        onClick={() => setCategoriaFaturaFiltro(null)}
                        className="ml-auto px-3 py-1 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 transition"
                      >
                        ‚úï Limpar filtro
                      </button>
                    </div>
                  )}

                  {/* Invoice Cards */}
                  <div className="space-y-3">
                    {faturas.length === 0 ? (
                      <p className="text-center text-gray-400 py-8">Nenhuma compra registada ainda</p>
                    ) : (
                      faturas
                        .filter(f => {
                          const faturaDate = new Date(f.data);
                          const ano = faturaDate.getFullYear();
                          const mes = faturaDate.getMonth();
                          
                          if (ano !== anoFaturaSelecionado) return false;
                          if (mesFaturaSelecionado !== null && mes !== mesFaturaSelecionado) return false;
                          
                          if (fornecedorFiltro && f.fornecedorNome !== fornecedorFiltro) return false;

                          if (categoriaFaturaFiltro) {

                            if (['compras_alimentares', 'materiais_operacionais', 'embalagens_consumiveis'].includes(categoriaFaturaFiltro)) {
                              if (f.categoria !== 'compras' || !f.itens || f.itens.length === 0) return false;

                              const temItemDaCategoria = f.itens.some(item => {
                                const ingrediente = item.ingredienteId ? ingredientes.find(i => i.id === item.ingredienteId) : null;
                                
                                if (categoriaFaturaFiltro === 'compras_alimentares') {
                                  return ingrediente && !['limpeza', 'operacionais', 'embalagens'].includes(ingrediente.categoria);
                                } else if (categoriaFaturaFiltro === 'materiais_operacionais') {
                                  return ingrediente && ['limpeza', 'operacionais'].includes(ingrediente.categoria);
                                } else if (categoriaFaturaFiltro === 'embalagens_consumiveis') {
                                  return ingrediente && ingrediente.categoria === 'embalagens';
                                }
                                return false;
                              });
                              
                              if (!temItemDaCategoria) return false;
                            } else {

                              if (f.categoria !== categoriaFaturaFiltro) return false;
                            }
                          }
                          
                          return true;
                        })
                        .map(fatura => {
                          return (
                            <div 
                              key={fatura.id} 
                              id={`fatura-${fatura.id}`}
                              className="border rounded-lg hover:shadow-md transition relative group"
                              style={{scrollMarginTop: '80px'}}
                            >
                              {/* Cabe√ßalho da Fatura (sempre vis√≠vel) */}
                              <div 
                                onClick={() => setExpandedFatura(expandedFatura === fatura.id ? null : fatura.id)}
                                className={`p-4 cursor-pointer transition rounded-lg ${
                                  fatura.id === ultimaFaturaInserida
                                    ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 hover:from-green-100 hover:to-emerald-100'
                                    : 'bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100'
                                }`}
                              >
                                <div className="flex items-center justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-3 mb-1">
                                      {fatura.id === ultimaFaturaInserida && (
                                        <span className="flex items-center gap-1 bg-green-600 text-white text-xs px-2 py-1 rounded font-bold shadow-md">
                                          ‚ö° √öLTIMA INSERIDA
                                        </span>
                                      )}
                                      
                                      <span className="font-bold text-blue-700">
                                        üìÑ {fatura.numero || 'Recibo'}
                                      </span>
                                      
                                      <span className={`text-xs px-2 py-1 rounded font-bold ${
                                        fatura.tipo === 'FT' ? 'bg-green-100 text-green-700 border border-green-300' :
                                        fatura.tipo === 'FS' ? 'bg-purple-100 text-purple-700 border border-purple-300' :
                                        fatura.tipo === 'FR' ? 'bg-blue-100 text-blue-700 border border-blue-300' :
                                        'bg-gray-100 text-gray-700 border border-gray-300'
                                      }`}>
                                        {fatura.tipo || 'FT'}
                                      </span>
                                      
                                      {fatura.documentoPDF ? (
                                        <span className="text-green-600 cursor-pointer" title={fatura.nomeDocumento || "PDF anexado"}>
                                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                          </svg>
                                        </span>
                                      ) : (
                                        <span className="text-red-600" title="SEM PDF">
                                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                          </svg>
                                        </span>
                                      )}
                                      
                                      <span className="text-sm text-gray-600">{fatura.fornecedorNome}</span>
                                      <span className="text-xs text-gray-500">{new Date(fatura.data).toLocaleDateString('pt-PT')}</span>
                                    </div>
                                    
                                    <div className="flex items-center gap-4 text-sm">
                                      <span className="text-gray-600">{(fatura.itens || []).length} {(fatura.itens || []).length === 1 ? 'item' : 'items'}</span>
                                      <span className="font-bold text-blue-700">Total: ‚Ç¨{(fatura.total || 0).toFixed(2)}</span>
                                    </div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        editarFatura(fatura);
                                      }}
                                      className="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-2 rounded transition"
                                      title="Editar"
                                    >
                                      <Edit2 size={16} />
                                    </button>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        if (confirm('‚ùå Tem a certeza que deseja eliminar esta fatura?')) {
                                          setFaturas(faturas.filter(f => f.id !== fatura.id));
                                          showNotification('üóëÔ∏è Fatura eliminada', 'success');

                                        }
                                      }}
                                      className="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition"
                                      title="Eliminar"
                                    >
                                      <Trash2 size={16} />
                                    </button>
                                    <button className="text-gray-600">
                                      {expandedFatura === fatura.id ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                    </button>
                                  </div>
                                </div>
                              </div>
                              
                              {/* Detalhes da Fatura (expans√≠vel) */}
                              {expandedFatura === fatura.id && (
                                <div className="bg-white p-4 border-t">
                                  <div className="mb-3">
                                    <h4 className="font-semibold text-sm mb-2 text-gray-700">Fornecedor:</h4>
                                    <div className="bg-gray-50 rounded p-2 text-sm">
                                      <p><strong>{fatura.fornecedorNome}</strong></p>
                                      {fatura.fornecedorNif && <p className="text-gray-600 text-xs">NIF: {fatura.fornecedorNif}</p>}
                                    </div>
                                  </div>
                                  
                                  <div className="mb-3">
                                    <h4 className="font-semibold text-sm mb-2 text-gray-700">Items:</h4>
                                    <div className="space-y-2">
                                      {(fatura.itens || []).map(item => {
                                        const ingredienteNome = item.ingredienteNome || item.descricao || 'N/A';
                                        const quantidade = item.quantidade || 0;
                                        const precoUnitario = item.precoUnitario || 0;
                                        const subtotal = item.subtotal || 0;
                                        const unidade = item.unidade || '';
                                        const iva = item.iva || 6;
                                        
                                        return (
                                        <div key={item.id || Math.random()} className="bg-gray-50 rounded p-3 text-sm relative group">
                                          <div className="flex justify-between items-start mb-1">
                                            <span className="font-medium">{ingredienteNome}</span>
                                            <span className="font-semibold text-blue-700">‚Ç¨{subtotal.toFixed(2)}</span>
                                          </div>
                                          <div className="text-xs text-gray-600">
                                            {quantidade} {unidade} √ó ‚Ç¨{precoUnitario.toFixed(2)}
                                            <span className="ml-2">(IVA {iva}%: +‚Ç¨{(subtotal * iva / 100).toFixed(2)})</span>
                                          </div>
                                          
                                          {/* Tooltip com quantidade e unidade */}
                                          <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block z-10 pointer-events-none">
                                            <div className="bg-gray-900 text-white px-3 py-2 rounded-lg shadow-lg text-xs font-semibold whitespace-nowrap">
                                              <div className="flex items-center gap-2">
                                                <span className="text-blue-300">üì¶</span>
                                                <span>{quantidade} {unidade}</span>
                                              </div>
                                              {/* Seta apontando para baixo */}
                                              <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
                                            </div>
                                          </div>
                                        </div>
                                        );
                                      })}
                                    </div>
                                  </div>
                                  
                                  <div className="bg-blue-50 rounded p-3 border border-blue-200">
                                    <div className="flex justify-between text-sm mb-1">
                                      <span>Subtotal:</span>
                                      <span className="font-semibold">‚Ç¨{(fatura.subtotal || fatura.total || 0).toFixed(2)}</span>
                                    </div>
                                    <div className="flex justify-between text-sm mb-1">
                                      <span>IVA Total:</span>
                                      <span className="font-semibold">‚Ç¨{(fatura.totalIva || 0).toFixed(2)}</span>
                                    </div>
                                    <div className="flex justify-between text-base font-bold border-t border-blue-300 pt-2 mt-1">
                                      <span>Total c/ IVA:</span>
                                      <span className="text-blue-700">‚Ç¨{(fatura.total || 0).toFixed(2)}</span>
                                    </div>
                                  </div>
                                  
                                  {fatura.notas && (
                                    <div className="mt-3 bg-yellow-50 rounded p-2 border border-yellow-200">
                                      <p className="text-xs text-gray-700"><strong>Notas:</strong> {fatura.notas}</p>
                                    </div>
                                  )}
                                  
                                  {/* Sec√ß√£o de PDF */}
                                  <div className="mt-3">
                                    {fatura.documentoPDF ? (
                                      <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                        <div className="flex items-center justify-between">
                                          <div className="flex items-center gap-3">
                                            <div>
                                              <p className="text-sm font-semibold text-green-900">
                                                üìÑ {fatura.nomeDocumento || 'Documento.pdf'}
                                              </p>
                                              <p className="text-xs text-green-700">
                                                PDF anexado ‚úÖ
                                              </p>
                                            </div>
                                          </div>
                                          <button
                                            onClick={() => {
                                              try {

                                                const base64Data = fatura.documentoPDF.split(',')[1] || fatura.documentoPDF;
                                                const byteCharacters = atob(base64Data);
                                                const byteNumbers = new Array(byteCharacters.length);
                                                for (let i = 0; i < byteCharacters.length; i++) {
                                                  byteNumbers[i] = byteCharacters.charCodeAt(i);
                                                }
                                                const byteArray = new Uint8Array(byteNumbers);
                                                const blob = new Blob([byteArray], { type: 'application/pdf' });

                                                const blobUrl = URL.createObjectURL(blob);

                                                window.open(blobUrl, '_blank');
                                              } catch (error) {
                                                console.error('Erro ao abrir PDF:', error);
                                                alert('Erro ao abrir PDF. Verifique a consola para detalhes.');
                                              }
                                            }}
                                            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition"
                                          >
                                            <Eye size={18} />
                                            Visualizar PDF
                                          </button>
                                        </div>
                                      </div>
                                    ) : (
                                      <div className="bg-red-50 border-2 border-red-300 rounded-lg p-3">
                                        <div className="flex items-center gap-3">
                                          <div className="flex-1">
                                            <p className="text-sm font-semibold text-red-900">
                                              ‚ö†Ô∏è SEM PDF Anexado
                                            </p>
                                            <p className="text-xs text-red-700 mt-1">
                                              Sem o documento fiscal original, a AT pode rejeitar a dedu√ß√£o de IVA!
                                              Edite a fatura e adicione o PDF.
                                            </p>
                                          </div>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })
                    )}
                  </div>
                </div>
              </div>
            )}

            {gestaoSubTab === 'vendas' && (() => {

              const vendasFiltradas = filtroVendas.trim()
                ? vendas.filter(v => {
                    const termoPesquisa = normalizeText(filtroVendas);
                    const nomeProduto = normalizeText(v.produto || '');
                    return nomeProduto.includes(termoPesquisa);
                  })
                : vendas;

              return (
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-bold">Gest√£o de Vendas</h2>
                  <button
                    onClick={() => setMostrarVendaManual(true)}
                    className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition flex items-center gap-2 font-semibold shadow"
                  >
                    <Plus size={18} />
                    Adicionar Venda Manual
                  </button>
                </div>
                
                {/* NOVO: Importa√ß√£o com Mapeamento Autom√°tico */}
                <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
                  <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                    <Upload size={20} />
                    üì• Importar Vendas
                  </h3>
                  <p className="text-sm text-gray-600 mb-3">
                    Importe vendas do Moloni (CSV) ou Zobaze (Excel) com mapeamento autom√°tico de produtos.
                  </p>
                  <button
                    onClick={() => setMostrarImportacao(true)}
                    className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition flex items-center gap-2 font-bold shadow-lg w-full justify-center"
                  >
                    <Upload size={18} />
                    üöÄ Importar com Mapeamento Autom√°tico
                  </button>
                  
                  {/* üÜï Informa√ß√£o sobre √∫ltimas importa√ß√µes - SEMPRE VIS√çVEL */}
                  <div className="mt-3 pt-3 border-t border-purple-200">
                    <p className="text-xs font-semibold text-gray-700 mb-2">üìÖ √öltimas Importa√ß√µes:</p>
                    <div className="grid grid-cols-2 gap-2">
                      <div className="bg-white border border-green-200 rounded-lg p-2">
                        <div className="flex items-center gap-1.5 mb-1">
                          <span className="text-lg">üè¢</span>
                          <span className="text-xs font-bold text-gray-700">Moloni</span>
                        </div>
                        <p className={`text-sm font-mono font-bold ${ultimaImportacaoMoloni ? 'text-green-700' : 'text-gray-400'}`}>
                          {ultimaImportacaoMoloni 
                            ? new Date(ultimaImportacaoMoloni).toLocaleDateString('pt-PT')
                            : '‚Äî'}
                        </p>
                      </div>
                      <div className="bg-white border border-blue-200 rounded-lg p-2">
                        <div className="flex items-center gap-1.5 mb-1">
                          <span className="text-lg">üì±</span>
                          <span className="text-xs font-bold text-gray-700">Zobaze</span>
                        </div>
                        <p className={`text-sm font-mono font-bold ${ultimaImportacaoZobaze ? 'text-blue-700' : 'text-gray-400'}`}>
                          {ultimaImportacaoZobaze 
                            ? new Date(ultimaImportacaoZobaze).toLocaleDateString('pt-PT')
                            : '‚Äî'}
                        </p>
                      </div>
                    </div>
                    <p className="text-xs text-gray-600 mt-2 italic">
                      üí° Use estas datas como refer√™ncia para evitar importa√ß√µes duplicadas
                    </p>
                  </div>
                </div>

                {/* Campo de Pesquisa de Vendas */}
                <div className="mb-4">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="Pesquisar produto de venda..."
                      value={filtroVendas}
                      onChange={(e) => setFiltroVendas(e.target.value)}
                      className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition text-sm"
                    />
                    {filtroVendas && (
                      <button
                        onClick={() => setFiltroVendas('')}
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        title="Limpar pesquisa"
                      >
                        <X size={18} />
                      </button>
                    )}
                  </div>
                  {filtroVendas && (
                    <p className="text-xs text-gray-600 mt-1.5 ml-1">
                      {vendasFiltradas.length} {vendasFiltradas.length === 1 ? 'resultado encontrado' : 'resultados encontrados'}
                    </p>
                  )}
                </div>

                {/* Sales Table */}
                <div className="overflow-x-auto rounded border">
                  <table className="w-full text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left font-semibold">Data</th>
                        <th className="px-2 py-2 text-left font-semibold">Produto</th>
                        <th className="px-2 py-2 text-right font-semibold">Quantidade</th>
                        <th className="px-2 py-2 text-right font-semibold">Valor</th>
                        <th className="px-2 py-2 text-center font-semibold">IVA</th>
                        <th className="px-2 py-2 text-center font-semibold">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {vendasFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 100).map((v, idx) => (
                        <tr key={v.id} className={`border-t hover:bg-gray-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 py-2">{new Date(v.data).toLocaleDateString('pt-PT')}</td>
                          <td className="px-2 py-2 font-medium">
                            <div className="flex items-center gap-2">
                              {v.produto}
                              {/* Tag de Origem */}
                              {v.origem === 'moloni' && (
                                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-[10px] font-bold" title="Importado do Moloni">
                                  MOLONI
                                </span>
                              )}
                              {v.origem === 'zobaze' && (
                                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-bold" title="Importado do Zobaze">
                                  ZOBAZE
                                </span>
                              )}
                              {!v.origem && v.tipo === 'manual' && (
                                <span className="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-[10px] font-bold" title="Venda manual">
                                  MANUAL
                                </span>
                              )}
                              {!v.produtoId && (
                                <span className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold" title="Produto n√£o emparelhado">
                                  ‚ö†Ô∏è Sem emparelhamento
                                </span>
                              )}
                            </div>
                          </td>
                          <td className="px-2 py-2 text-right">{v.quantidade}</td>
                          <td className="px-2 py-2 text-right font-bold text-green-600">‚Ç¨{v.valor.toFixed(2)}</td>
                          <td className="px-2 py-2 text-center">
                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                              {v.iva}%
                            </span>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button 
                                onClick={() => {
                                  setVendaEditando(v.id);
                                  setProdutoOriginalVenda(v.produto); // üÜï Guardar nome original
                                  setNovaVenda({
                                    data: v.data,
                                    produtoId: v.produtoId || '',
                                    produto: v.produto,
                                    quantidade: v.quantidade,
                                    valorManual: v.valor.toString(),
                                    usarValorManual: true
                                  });
                                  setMostrarEditarVenda(true);
                                }}
                                className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                title="Editar venda"
                              >
                                <Edit size={14} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar esta venda?')) {
                                  setVendas(vendas.filter(x => x.id !== v.id));
                                  showNotification('Venda eliminada!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="Eliminar venda"
                              >
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                {(vendas || []).length > 100 && (
                  <p className="text-center text-xs text-gray-500 mt-2">
                    A mostrar as 100 vendas mais recentes de {(vendas || []).length} totais
                  </p>
                )}
                
                {!(vendas || []).length && (
                  <div className="text-center py-12">
                    <p className="text-gray-400 text-sm">Nenhuma venda importada</p>
                    <p className="text-gray-400 text-xs mt-1">Importe um ficheiro CSV do Moloni ou adicione vendas manualmente</p>
                  </div>
                )}
                
                {/* Modal Venda Manual */}
                {mostrarVendaManual && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 pt-8 overflow-y-auto">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold">Adicionar Venda Manual</h3>
                        <button
                          onClick={() => setMostrarVendaManual(false)}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <X size={24} />
                        </button>
                      </div>
                      
                      <div className="space-y-4">
                        {/* Data */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Data *
                          </label>
                          <input
                            type="date"
                            value={novaVenda.data}
                            onChange={(e) => setNovaVenda({...novaVenda, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          />
                        </div>
                        
                        {/* Produto */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Produto * {produtos.length === 0 && <span className="text-red-500 text-xs">(Nenhum produto dispon√≠vel)</span>}
                          </label>
                          <select
                            value={novaVenda.produtoId}
                            onChange={(e) => setNovaVenda({...novaVenda, produtoId: e.target.value ? parseInt(e.target.value) : ''})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          >
                            <option value="">Selecione um produto</option>
                            {produtos.map(p => (
                              <option key={p.id} value={p.id}>
                                {p.nome} - ‚Ç¨{p.precoVenda.toFixed(2)} (IVA {p.iva}%)
                              </option>
                            ))}
                          </select>
                        </div>
                        
                        {/* Quantidade */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Quantidade *
                          </label>
                          <input
                            type="number"
                            min="1"
                            step="1"
                            value={novaVenda.quantidade}
                            onChange={(e) => setNovaVenda({...novaVenda, quantidade: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          />
                        </div>
                        
                        {/* Informa√ß√£o do produto selecionado */}
                        {novaVenda.produtoId && (() => {
                          const produtoSelecionado = produtos.find(p => p.id === novaVenda.produtoId);
                          if (!produtoSelecionado) return null;
                          
                          const valorCalculado = produtoSelecionado.precoVenda * parseFloat(novaVenda.quantidade || 0);
                          
                          return (
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg space-y-2">
                              <div className="flex justify-between text-sm">
                                <span className="text-gray-600">Pre√ßo unit√°rio:</span>
                                <span className="font-semibold">‚Ç¨{produtoSelecionado.precoVenda.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between text-sm">
                                <span className="text-gray-600">IVA:</span>
                                <span className="font-semibold">{produtoSelecionado.iva}%</span>
                              </div>
                              <div className="flex justify-between text-sm pt-2 border-t border-blue-300">
                                <span className="text-gray-700 font-medium">Valor total:</span>
                                <span className="font-bold text-green-600 text-lg">‚Ç¨{valorCalculado.toFixed(2)}</span>
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* Valor manual (opcional) */}
                        {novaVenda.produtoId && (
                          <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <label className="flex items-center gap-2 cursor-pointer mb-2">
                              <input
                                type="checkbox"
                                checked={novaVenda.usarValorManual}
                                onChange={(e) => setNovaVenda({...novaVenda, usarValorManual: e.target.checked})}
                                className="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                              />
                              <span className="text-sm text-gray-700 font-medium">Sobrescrever valor total</span>
                            </label>
                            
                            {novaVenda.usarValorManual && (
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">Valor personalizado:</label>
                                <input
                                  type="number"
                                  step="0.01"
                                  min="0"
                                  value={novaVenda.valorManual}
                                  onChange={(e) => setNovaVenda({...novaVenda, valorManual: e.target.value})}
                                  placeholder="‚Ç¨0.00"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                  Use isto para descontos ou promo√ß√µes especiais
                                </p>
                              </div>
                            )}
                          </div>
                        )}
                        
                        {/* Campos de Documenta√ß√£o Oficial (Expand√≠vel) */}
                        <details className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                          <summary className="cursor-pointer font-medium text-sm text-gray-700 flex items-center gap-2">
                            üìã Documenta√ß√£o Oficial (Opcional)
                          </summary>
                          <div className="space-y-3 mt-3">
                            {/* N√∫mero do Documento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                N¬∫ Documento
                              </label>
                              <input
                                type="text"
                                value={novaVenda.numeroDocumento}
                                onChange={(e) => setNovaVenda({...novaVenda, numeroDocumento: e.target.value})}
                                placeholder="Ex: VD-2026-0001"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              />
                            </div>
                            
                            {/* Tipo de Documento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Tipo de Documento
                              </label>
                              <select
                                value={novaVenda.tipoDocumento}
                                onChange={(e) => setNovaVenda({...novaVenda, tipoDocumento: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              >
                                <option value="Venda">Venda</option>
                                <option value="Fatura Simplificada">Fatura Simplificada</option>
                                <option value="Fatura">Fatura</option>
                                <option value="Recibo">Recibo</option>
                                <option value="Nota de Cr√©dito">Nota de Cr√©dito</option>
                              </select>
                            </div>
                            
                            {/* Forma de Pagamento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Forma de Pagamento
                              </label>
                              <select
                                value={novaVenda.formaPagamento}
                                onChange={(e) => setNovaVenda({...novaVenda, formaPagamento: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              >
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="MB Way">MB Way</option>
                                <option value="Multibanco">Multibanco</option>
                                <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
                                <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
                                <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                                <option value="Cheque">Cheque</option>
                              </select>
                            </div>
                            
                            {/* Observa√ß√µes */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Observa√ß√µes
                              </label>
                              <textarea
                                value={novaVenda.observacoes}
                                onChange={(e) => setNovaVenda({...novaVenda, observacoes: e.target.value})}
                                placeholder="Informa√ß√µes adicionais..."
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              />
                            </div>
                          </div>
                        </details>
                        
                        {/* Bot√µes */}
                        <div className="flex gap-3 pt-4">
                          <button
                            onClick={() => setMostrarVendaManual(false)}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={adicionarVendaManual}
                            className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                          >
                            Adicionar Venda
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Modal Editar Venda */}
                {mostrarEditarVenda && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 pt-8 overflow-y-auto">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold">‚úèÔ∏è Editar Venda</h3>
                        <button
                          onClick={() => {
                            setMostrarEditarVenda(false);
                            setVendaEditando(null);
                            setProdutoOriginalVenda(''); // Limpar
                          }}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <X size={20} />
                        </button>
                      </div>
                      
                      <div className="space-y-4">
                        {/* Nome do Produto - Mostra mudan√ßa APENAS se mudou */}
                        <div className="bg-gradient-to-r from-gray-50 to-blue-50 border-2 rounded-lg p-3">
                          <p className="text-xs text-gray-600 mb-1 font-semibold">
                            {novaVenda.produto !== produtoOriginalVenda ? 'üîÑ Nome ser√° atualizado:' : 'üì¶ Produto atual:'}
                          </p>
                          <div className="flex items-center gap-2">
                            {novaVenda.produto !== produtoOriginalVenda && (
                              <>
                                <p className="text-sm text-gray-500 line-through">{produtoOriginalVenda}</p>
                                <span className="text-blue-600 font-bold">‚Üí</span>
                              </>
                            )}
                            <p className={`font-bold ${novaVenda.produto !== produtoOriginalVenda ? 'text-blue-700' : 'text-gray-800'}`}>
                              {novaVenda.produto}
                            </p>
                          </div>
                          {novaVenda.produto !== produtoOriginalVenda && (
                            <p className="text-xs text-green-700 mt-1 font-semibold">
                              ‚úÖ O nome ser√° alterado para "{novaVenda.produto}" ao guardar
                            </p>
                          )}
                        </div>
                        
                        {/* Emparelhar com Produto */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">
                            üîó Emparelhar com Produto:
                          </label>
                          <select
                            value={novaVenda.produtoId}
                            onChange={(e) => {
                              const prodId = e.target.value;

                              const prod = produtos.find(p => String(p.id) === String(prodId));
                              
                              const novoNome = prod ? prod.nome : produtoOriginalVenda;

                              setNovaVenda({
                                ...novaVenda, 
                                produtoId: prodId,
                                produto: novoNome,
                                valorManual: prod ? prod.precoVenda.toString() : novaVenda.valorManual
                              });

                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- Sem emparelhamento --</option>
                            {produtos.map(p => (
                              <option key={p.id} value={p.id}>
                                {p.nome} (‚Ç¨{p.precoVenda})
                              </option>
                            ))}
                          </select>
                          <p className="text-xs text-gray-500 mt-1">
                            {novaVenda.produtoId 
                              ? '‚úÖ Produto emparelhado - aparecer√° nas m√©tricas' 
                              : '‚ö†Ô∏è Sem emparelhamento - n√£o afeta m√©tricas de produto'}
                          </p>
                        </div>
                        
                        {/* Data */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Data:</label>
                          <input
                            type="date"
                            value={novaVenda.data}
                            onChange={(e) => setNovaVenda({...novaVenda, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Quantidade */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Quantidade:</label>
                          <input
                            type="number"
                            min="1"
                            value={novaVenda.quantidade}
                            onChange={(e) => setNovaVenda({...novaVenda, quantidade: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Valor */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Valor (‚Ç¨):</label>
                          <input
                            type="number"
                            step="0.01"
                            min="0"
                            value={novaVenda.valorManual}
                            onChange={(e) => setNovaVenda({...novaVenda, valorManual: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Bot√µes */}
                        <div className="flex gap-2 pt-4">
                          <button
                            onClick={() => {
                              setMostrarEditarVenda(false);
                              setVendaEditando(null);
                              setProdutoOriginalVenda(''); // Limpar
                            }}
                            className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={async () => {

                              const vendaAtualizada = {
                                ...vendas.find(v => v.id === vendaEditando),
                                data: novaVenda.data,
                                produtoId: novaVenda.produtoId || null,
                                produto: novaVenda.produto, // üî• SIMPLIFICADO: usa direto o que est√° em novaVenda
                                quantidade: novaVenda.quantidade,
                                valor: parseFloat(novaVenda.valorManual)
                              };

                              setVendas(vendas.map(v => 
                                v.id === vendaEditando ? vendaAtualizada : v
                              ));
                              
                              setMostrarEditarVenda(false);
                              setVendaEditando(null);
                              setProdutoOriginalVenda('');
                              
                              showNotification('‚úÖ Venda atualizada: ' + novaVenda.produto, 'success');

                              setTimeout(() => {

                                saveToDrive(false);
                              }, 500);
                            }}
                            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                          >
                            üíæ Guardar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              );
            })()}
          </div>
        )}

        {/* TAB BOLOS EXTERNOS */}

        {/* TAB DEFINI√á√ïES */}
        {activeTab === 'definicoes' && (
          <div className="space-y-3">
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-2xl font-bold mb-4">
                ‚öôÔ∏è Defini√ß√µes
              </h2>
              <p className="text-gray-600 mb-6">Configure as prefer√™ncias do Munchi Manager</p>
              
              <div className="space-y-6">
                {/* ==================== CONFIGURA√á√ïES V2.0 ==================== */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-green-50 to-blue-50">
                  <button
                    onClick={() => setConfiguracoesExpanded(!configuracoesExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-green-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        ‚öôÔ∏è Configura√ß√µes do Sistema
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Filtros de m√©tricas, alertas de margem e objetivo de ordenados
                      </p>
                    </div>
                    {configuracoesExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {configuracoesExpanded && (
                    <div className="p-4 border-t border-green-200 bg-white">
                      <PainelConfiguracoes
                        configuracoes={configuracoes}
                        onSalvar={handleSalvarConfiguracoes}
                        vendas={vendas}
                        setVendas={setVendas}
                        showNotification={showNotification}
                        ordenadoObjetivo={ordenadoObjetivo}
                        setOrdenadoObjetivo={setOrdenadoObjetivo}
                      />
                    </div>
                  )}
                </div>
                {/* ==================== FIM CONFIGURA√á√ïES V2.0 ==================== */}
                
                {/* Dados da Empresa */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-blue-50 to-purple-50">
                  <button
                    onClick={() => setDadosEmpresaExpanded(!dadosEmpresaExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-blue-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üè¢ Dados da Empresa
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Informa√ß√µes fiscais da sua empresa
                      </p>
                    </div>
                    {dadosEmpresaExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {dadosEmpresaExpanded && (
                    <div className="p-4 border-t border-blue-200 bg-white">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        NIF/NIPC *
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).nif}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), nif: e.target.value})}
                        placeholder="123456789"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Nome da Empresa *
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).nome}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), nome: e.target.value})}
                        placeholder="Munchi Restaurant, Lda"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Morada Fiscal
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).morada}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), morada: e.target.value})}
                        placeholder="Rua Example, 123"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        C√≥digo Postal
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).codigoPostal}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), codigoPostal: e.target.value})}
                        placeholder="1000-001"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Cidade
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).cidade}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), cidade: e.target.value})}
                        placeholder="Lisboa"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        CAE (C√≥digo Atividade)
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).cae}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), cae: e.target.value})}
                        placeholder="56101"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Email
                      </label>
                      <input
                        type="email"
                        value={(dadosEmpresa || {}).email}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), email: e.target.value})}
                        placeholder="geral@munchi.pt"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Telefone
                      </label>
                      <input
                        type="tel"
                        value={(dadosEmpresa || {}).telefone}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), telefone: e.target.value})}
                        placeholder="+351 21 123 4567"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                  </div>
                  
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>üí° Dica:</strong> Estes dados ser√£o inclu√≠dos nos exports CSV para o contabilista e em futuros exports certificados (SAF-T).
                    </p>
                  </div>
                  
                  {(dadosEmpresa.nif && dadosEmpresa.nome) && (
                    <div className="mt-3 bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                      <span className="text-green-600">‚úÖ</span>
                      <p className="text-xs text-green-800 font-medium">
                        Dados da empresa configurados!
                      </p>
                    </div>
                  )}
                </div>
              )}
                </div>
                
                {/* Fornecedores */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-purple-50 to-pink-50">
                  <button
                    onClick={() => setFornecedoresExpanded(!fornecedoresExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-purple-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üë• Fornecedores
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Gerir contactos de fornecedores
                      </p>
                    </div>
                    {fornecedoresExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {fornecedoresExpanded && (
                    <div className="p-4 border-t border-purple-200 bg-white">
                      {/* Formul√°rio Novo Fornecedor */}
                      <div id="fornecedor-form" className="bg-purple-50 rounded-lg p-4 mb-4 border-2 border-purple-200">
                        <h4 className="font-semibold text-sm mb-3">
                          {editandoFornecedor ? '‚úèÔ∏è Editar Fornecedor' : '‚ûï Adicionar Fornecedor'}
                        </h4>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Nome do Fornecedor *
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.nome}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, nome: e.target.value})}
                              placeholder="Ex: Mercearia Silva"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              NIF
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.nif}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, nif: e.target.value})}
                              placeholder="123456789"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div className="md:col-span-2">
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Morada
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.morada}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, morada: e.target.value})}
                              placeholder="Rua Example, 123"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Email
                            </label>
                            <input
                              type="email"
                              value={dadosFornecedor.email}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, email: e.target.value})}
                              placeholder="contacto@fornecedor.pt"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Telefone
                            </label>
                            <input
                              type="tel"
                              value={dadosFornecedor.telefone}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, telefone: e.target.value})}
                              placeholder="+351 21 123 4567"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                        </div>
                        
                        {editandoFornecedor ? (
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={salvarEdicaoFornecedor}
                              className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                            >
                              <Save size={16} /> Guardar Altera√ß√µes
                            </button>
                            <button
                              onClick={cancelarEdicaoFornecedor}
                              className="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition"
                            >
                              Cancelar
                            </button>
                          </div>
                        ) : (
                          <button
                            onClick={adicionarNovoFornecedor}
                            className="w-full mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                          >
                            <Plus size={16} /> Adicionar Fornecedor
                          </button>
                        )}
                      </div>
                      
                      {/* Lista de Fornecedores */}
                      <div>
                        <h4 className="font-semibold text-sm mb-3">
                          üìã Fornecedores Registados ({(fornecedores || []).length})
                        </h4>
                        
                        {(fornecedores || []).length === 0 ? (
                          <div className="text-center text-gray-500 text-sm py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                            Nenhum fornecedor registado.
                          </div>
                        ) : (
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {(fornecedores || []).map(fornecedor => {
                              const isOldFormat = typeof fornecedor === 'string';
                              const id = isOldFormat ? fornecedor : fornecedor.id;
                              const nome = isOldFormat ? fornecedor : fornecedor.nome;
                              const nif = isOldFormat ? '' : fornecedor.nif;
                              const morada = isOldFormat ? '' : fornecedor.morada;
                              const email = isOldFormat ? '' : fornecedor.email;
                              const telefone = isOldFormat ? '' : fornecedor.telefone;
                              
                              return (
                                <div key={id} className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-200">
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex-1">
                                      <h5 className="font-bold text-purple-900 text-sm">{nome}</h5>
                                      {nif && <p className="text-xs text-gray-600 mt-1">NIF: {nif}</p>}
                                    </div>
                                    {!isOldFormat && (
                                      <div className="flex gap-1">
                                        <button
                                          onClick={() => editarFornecedor(fornecedor)}
                                          className="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-1 rounded transition"
                                          title="Editar fornecedor"
                                        >
                                          <Edit2 size={14} />
                                        </button>
                                        <button
                                          onClick={() => apagarFornecedor(id)}
                                          className="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded transition"
                                          title="Apagar fornecedor"
                                        >
                                          <Trash2 size={14} />
                                        </button>
                                      </div>
                                    )}
                                  </div>
                                  
                                  {!isOldFormat && (
                                    <div className="text-xs text-gray-600 space-y-1">
                                      {morada && <p>üìç {morada}</p>}
                                      {email && <p>‚úâÔ∏è {email}</p>}
                                      {telefone && <p>üìû {telefone}</p>}
                                    </div>
                                  )}
                                  
                                  <div className="mt-2 pt-2 border-t border-purple-200 flex items-center justify-between text-xs">
                                    <span className="text-gray-600">
                                      Compras: <strong>{(faturas || []).filter(f => f.fornecedorId === id).length}</strong>
                                    </span>
                                    <span className="text-gray-600">
                                      Total: <strong>‚Ç¨{(faturas || []).filter(f => f.fornecedorId === id).reduce((sum, f) => sum + f.total, 0).toFixed(2)}</strong>
                                    </span>
                                  </div>
                                  
                                  {/* üö´ FILTROS OCR - BLACKLIST E PALAVRAS A LIMPAR */}
                                  {nif && (() => {
                                    const template = templatesOCR.find(t => t.nifFornecedor === nif);
                                    const temBlacklist = template?.blacklist && template.blacklist.length > 0;
                                    const temPalavras = template?.palavrasLimpar && template.palavrasLimpar.length > 0;
                                    const totalFiltros = (template?.blacklist?.length || 0) + (template?.palavrasLimpar?.length || 0);
                                    
                                    if (!temBlacklist && !temPalavras) return null;
                                    
                                    const isExpanded = fornecedoresExpandidos[nif];
                                    
                                    return (
                                      <div className="mt-2 pt-2 border-t border-purple-200">
                                        <button
                                          onClick={() => setFornecedoresExpandidos(prev => ({
                                            ...prev,
                                            [nif]: !prev[nif]
                                          }))}
                                          className="w-full flex items-center justify-between hover:bg-purple-50 -mx-3 px-3 py-1.5 rounded transition"
                                        >
                                          <span className="text-xs font-semibold text-purple-900 flex items-center gap-1">
                                            üö´ Filtros OCR
                                            <span className="bg-purple-200 text-purple-800 px-1.5 py-0.5 rounded-full text-[10px] font-bold">
                                              {totalFiltros}
                                            </span>
                                          </span>
                                          {isExpanded ? <ChevronUp size={14} /> : <ChevronDown size={14} />}
                                        </button>
                                        
                                        {isExpanded && (
                                          <div className="mt-2 space-y-2">
                                            {/* BLACKLIST */}
                                            {temBlacklist && (
                                              <div className="bg-red-50 rounded-lg p-2 border border-red-200">
                                                <div className="flex items-center justify-between mb-1.5">
                                                  <h5 className="text-[10px] font-bold text-red-900 uppercase tracking-wide">
                                                    üö´ Blacklist ({template.blacklist.length})
                                                  </h5>
                                                </div>
                                                <div className="space-y-1 max-h-32 overflow-y-auto">
                                                  {template.blacklist.map((item, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-white p-1.5 rounded border border-red-100 text-[10px]">
                                                      <span className="font-mono text-gray-700 flex-1 truncate" title={item}>
                                                        {item}
                                                      </span>
                                                      <button
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          if (confirm(`Remover "${item.substring(0, 40)}..." da blacklist?`)) {
                                                            const novaBlacklist = template.blacklist.filter(b => b !== item);
                                                            const index = templatesOCR.findIndex(t => t.nifFornecedor === nif);
                                                            const novos = [...templatesOCR];
                                                            novos[index] = { ...template, blacklist: novaBlacklist };
                                                            setTemplatesOCR(novos);
                                                            showNotification('‚úÖ Removido da blacklist!', 'success');
                                                          }
                                                        }}
                                                        className="text-red-600 hover:text-red-800 px-1 hover:bg-red-100 rounded ml-1"
                                                      >
                                                        ‚ùå
                                                      </button>
                                                    </div>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                            
                                            {/* PALAVRAS A LIMPAR */}
                                            {temPalavras && (
                                              <div className="bg-blue-50 rounded-lg p-2 border border-blue-200">
                                                <div className="flex items-center justify-between mb-1.5">
                                                  <h5 className="text-[10px] font-bold text-blue-900 uppercase tracking-wide">
                                                    üßπ Palavras Limpar ({template.palavrasLimpar.length})
                                                  </h5>
                                                </div>
                                                <div className="space-y-1 max-h-32 overflow-y-auto">
                                                  {template.palavrasLimpar.map((palavra, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-white p-1.5 rounded border border-blue-100 text-[10px]">
                                                      <span className="font-mono text-gray-700 flex-1 truncate" title={palavra}>
                                                        {palavra}
                                                      </span>
                                                      <button
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          if (confirm(`Restaurar "${palavra}"?`)) {
                                                            const novasPalavras = template.palavrasLimpar.filter(p => p !== palavra);
                                                            const index = templatesOCR.findIndex(t => t.nifFornecedor === nif);
                                                            const novos = [...templatesOCR];
                                                            novos[index] = { ...template, palavrasLimpar: novasPalavras };
                                                            setTemplatesOCR(novos);
                                                            showNotification('‚úÖ Palavra restaurada!', 'success');
                                                          }
                                                        }}
                                                        className="text-blue-600 hover:text-blue-800 px-1 hover:bg-blue-100 rounded ml-1"
                                                      >
                                                        ‚Ü©Ô∏è
                                                      </button>
                                                    </div>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })()}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Apps de Delivery */}
                <div className="border rounded-lg overflow-hidden shadow-sm bg-gradient-to-br from-orange-50 to-yellow-50 border-orange-200">
                  <button
                    onClick={() => setDeliveryAppsExpanded(!deliveryAppsExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-orange-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üöó Apps de Delivery
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Configurar Uber Eats, Glovo, Bolt Food, etc
                      </p>
                    </div>
                    {deliveryAppsExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {deliveryAppsExpanded && (
                    <div className="p-4 border-t border-orange-200 bg-white">
                      <p className="text-xs text-gray-600 mb-4">
                        üí° Ative as apps que utiliza para ver simula√ß√µes de pre√ßos e margens no Dashboard
                      </p>
                      
                      {/* Lista de Apps */}
                      <div className="space-y-3 mb-4">
                        {(deliveryApps || []).map(app => (
                          <div key={app.id} className={`border-2 rounded-lg p-3 ${app.ativo ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-3">
                                <button
                                  onClick={() => toggleApp(app.id)}
                                  className={`w-12 h-6 rounded-full transition ${app.ativo ? 'bg-green-500' : 'bg-gray-300'} relative`}
                                >
                                  <div className={`w-5 h-5 rounded-full bg-white absolute top-0.5 transition-all ${app.ativo ? 'left-6' : 'left-0.5'}`}></div>
                                </button>
                                <div>
                                  <h4 className="font-bold text-sm">{app.nome}</h4>
                                  <p className="text-xs text-gray-500">
                                    {app.ativo ? '‚úÖ Ativa' : '‚ùå Inativa'}
                                  </p>
                                </div>
                              </div>
                              
                              <button
                                onClick={() => apagarApp(app.id)}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="Apagar app"
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">Comiss√£o (%)</label>
                                {editandoApp === app.id ? (
                                  <div className="flex gap-1">
                                    <input
                                      type="number"
                                      step="0.1"
                                      defaultValue={app.comissao}
                                      id={`comissao-${app.id}`}
                                      className="w-full px-2 py-1 border rounded text-sm"
                                    />
                                    <button
                                      onClick={() => {
                                        const novaComissao = document.getElementById(`comissao-${app.id}`).value;
                                        atualizarComissaoApp(app.id, novaComissao);
                                      }}
                                      className="bg-green-500 text-white px-2 rounded hover:bg-green-600"
                                    >
                                      ‚úì
                                    </button>
                                  </div>
                                ) : (
                                  <div className="flex items-center gap-2">
                                    <span className="font-bold text-lg">{app.comissao}%</span>
                                    <button
                                      onClick={() => setEditandoApp(app.id)}
                                      className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                    >
                                      <Edit2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                              
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">√öltima atualiza√ß√£o</label>
                                <span className="text-xs text-gray-500">{new Date(app.dataAtualizacao).toLocaleDateString('pt-PT')}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      {/* Adicionar Nova App */}
                      <div className="bg-orange-50 rounded-lg p-3 border-2 border-orange-200">
                        <h4 className="font-semibold text-sm mb-2">‚ûï Adicionar Nova App</h4>
                        <div className="grid grid-cols-2 gap-2">
                          <input
                            type="text"
                            placeholder="Nome (ex: Just Eat)"
                            value={novaApp.nome}
                            onChange={(e) => setNovaApp({...novaApp, nome: e.target.value})}
                            className="px-2 py-1.5 border rounded text-sm"
                          />
                          <div className="flex gap-1">
                            <input
                              type="number"
                              step="0.1"
                              placeholder="Comiss√£o %"
                              value={novaApp.comissao}
                              onChange={(e) => setNovaApp({...novaApp, comissao: e.target.value})}
                              className="flex-1 px-2 py-1.5 border rounded text-sm"
                            />
                            <button
                              onClick={adicionarNovaApp}
                              className="bg-orange-500 text-white px-3 rounded hover:bg-orange-600 font-semibold text-sm"
                            >
                              +
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Backup e Sincroniza√ß√£o */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-gray-50 to-blue-50">
                  <button
                    onClick={() => setBackupExpanded(!backupExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-blue-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üíæ Backup e Sincroniza√ß√£o
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Sincronize automaticamente com a cloud ou fa√ßa backup/restauro manual.
                      </p>
                    </div>
                    {backupExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {backupExpanded && (
                  <div className="border-t border-gray-200 bg-white p-4">
                  
                  {/* Grid: Export/Import + GitHub + Google Drive */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    
                    {/* Coluna Esquerda: Export/Import + GitHub */}
                    <div className="space-y-3">
                      {/* Exportar/Importar Local */}
                      <div className="grid grid-cols-2 gap-3">
                        {/* Exportar */}
                        <div className="bg-white rounded-lg p-3 border-2 border-green-200">
                          <h4 className="font-semibold text-green-800 text-sm mb-2 flex items-center gap-1">
                            <Download size={14} />
                            Exportar
                          </h4>
                          <p className="text-xs text-gray-600 mb-2">
                            Backup local (JSON) - Dados do Google Drive
                          </p>
                          <button 
                            onClick={exportarDados}
                            className="w-full bg-green-600 hover:bg-green-700 text-white rounded px-3 py-2 text-xs font-semibold flex items-center justify-center gap-1 transition"
                            title="Exporta os dados atuais (mesmos que est√£o no Google Drive)"
                          >
                            <Download size={12} />
                            Exportar
                          </button>
                        </div>
                        
                        {/* Importar */}
                        <div className="bg-white rounded-lg p-3 border-2 border-blue-200">
                          <h4 className="font-semibold text-blue-800 text-sm mb-2 flex items-center gap-1">
                            <Upload size={14} />
                            Importar
                          </h4>
                          <p className="text-xs text-gray-600 mb-2">
                            Restaurar backup
                          </p>
                          <label className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-2 text-xs font-semibold flex items-center justify-center gap-1 transition cursor-pointer">
                            <Upload size={12} />
                            Importar
                            <input type="file" accept=".json" onChange={importarDados} className="hidden" />
                          </label>
                        </div>
                      </div>
                      
                      {/* GitHub Backup */}
                      <GitHubBackupPanel 
                        onSync={async () => {
                          const token = GitHubSync.getToken();
                          if (!token) {
                            showNotification('Configure o GitHub primeiro!', 'error');
                            return;
                          }
                          
                          const allData = {
                            produtos,
                            ingredientes,
                            vendas,
                            despesas,
                            faturas,
                            fornecedores,
                            deliveryApps,
                            embalagens,
                            dadosEmpresa,
                            version: '2.0'
                          };
                          
                          const result = await GitHubSync.saveToGist(allData, token);
                          if (result.success) {
                            showNotification('‚úÖ Backup sincronizado com GitHub!', 'success');
                          } else {
                            showNotification(`‚ùå Erro: ${result.error}`, 'error');
                          }
                        }}
                      />
                    </div>

                    {/* Coluna Direita: Google Drive */}
                    <div id="google-drive-section">
                      {!driveAccessToken ? (
                        <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 h-full">
                          <div className="flex items-start gap-3 mb-3">
                            <div className="bg-blue-600 rounded-lg p-2 flex-shrink-0">
                              <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12.945 1.379l-.652.763c-.026-.008-.052-.014-.078-.023L6.364 7.97l3.352 5.796 2.32-4.01a1.158 1.158 0 011.099-.706c.326.006.611.177.78.435l.033.053 8.684 15.07h-6.666L13.185 18h-2.37l-.003.001L6.277 7.965 6.209 8h-.012L1.363 16l3.314 5.735 8.716.002c.276 0 .509-.137.709-.356l9.677-16.91-.002-.002c-.01-.017-.022-.032-.033-.049-.288-.52-.754-.882-1.308-.988L12.945 1.379z"/>
                              </svg>
                            </div>
                            <div className="flex-1">
                              <h4 className="font-bold text-blue-900 mb-1 text-sm">
                                ‚òÅÔ∏è Google Drive
                              </h4>
                              <p className="text-xs text-gray-700 mb-2">
                                Sincroniza√ß√£o autom√°tica entre dispositivos.
                              </p>
                              <ul className="text-xs text-gray-600 space-y-0.5 mb-3">
                                <li>‚úÖ Multi-dispositivo</li>
                                <li>‚úÖ Backup autom√°tico</li>
                                <li>‚úÖ 15GB gr√°tis</li>
                              </ul>
                            </div>
                          </div>
                          
                          <button
                            onClick={loginGoogleDrive}
                            className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 hover:shadow-lg rounded-lg px-3 py-2.5 text-sm font-semibold flex items-center justify-center gap-2 transition"
                          >
                            <svg className="w-4 h-4" viewBox="0 0 24 24">
                              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Conectar
                          </button>
                          
                          <p className="text-xs text-gray-500 mt-2 text-center">
                            üîí Acesso s√≥ aos ficheiros do Munchi
                          </p>
                        </div>
                      ) : (
                        <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 h-full">
                          <div className="flex items-center gap-2 mb-3">
                            {driveUser?.image && (
                              <img 
                                src={driveUser.image} 
                                alt={driveUser.name}
                                className="w-10 h-10 rounded-full border-2 border-green-400"
                              />
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="font-bold text-green-900 text-sm truncate">{driveUser?.name || 'Utilizador'}</p>
                              <p className="text-xs text-green-700 truncate">{driveUser?.email || ''}</p>
                              <p className="text-xs text-gray-600 mt-0.5">
                                {driveSyncing ? (
                                  <span className="flex items-center gap-1">
                                    <svg className="animate-spin h-3 w-3" viewBox="0 0 24 24">
                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                    </svg>
                                    A sincronizar...
                                  </span>
                                ) : driveLastSync ? (
                                  `‚úÖ Sync h√° ${Math.round((new Date() - driveLastSync) / 60000)} min`
                                ) : (
                                  '‚è≥ Aguardando sync'
                                )}
                              </p>
                            </div>
                            <button
                              onClick={logoutGoogleDrive}
                              className="text-xs text-red-600 hover:text-red-800 px-2 py-1 border border-red-300 rounded hover:bg-red-50 transition flex-shrink-0"
                            >
                              Sair
                            </button>
                          </div>
                          
                          {/* ‚úÖ Indicador de Status do Token */}
                          <div className={`mb-3 p-2 rounded-lg border-2 ${
                            driveTokenValid 
                              ? 'bg-green-100 border-green-400' 
                              : driveTokenTimeLeft > 0 
                                ? 'bg-yellow-100 border-yellow-400' 
                                : 'bg-red-100 border-red-400'
                          }`}>
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${
                                  driveTokenValid 
                                    ? 'bg-green-500' 
                                    : driveTokenTimeLeft > 0 
                                      ? 'bg-yellow-500 animate-pulse' 
                                      : 'bg-red-500'
                                }`}></div>
                                <span className="text-xs font-semibold">
                                  {driveTokenValid 
                                    ? 'üîì Conectado' 
                                    : driveTokenTimeLeft > 0 
                                      ? '‚ö†Ô∏è A expirar' 
                                      : 'üîí Expirado'}
                                </span>
                              </div>
                              {driveTokenTimeLeft > 0 && (
                                <span className={`text-xs font-mono ${
                                  driveTokenTimeLeft < 10 ? 'text-red-600 font-bold' : 'text-gray-700'
                                }`}>
                                  {driveTokenTimeLeft}min
                                </span>
                              )}
                            </div>
                          </div>
                          
                          {driveError && (
                            <div className="bg-red-100 border border-red-300 rounded p-2 mb-2">
                              <p className="text-xs text-red-800">‚ö†Ô∏è {driveError}</p>
                            </div>
                          )}
                          
                          <div className="grid grid-cols-2 gap-2 mb-2">
                            <button
                              onClick={() => saveToDrive(true)}
                              disabled={driveSyncing || !driveTokenValid}
                              className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                            >
                              <Upload size={12} />
                              Sync
                            </button>
                            
                            <button
                              onClick={() => loadFromDrive()}
                              disabled={driveSyncing || !driveTokenValid}
                              className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                            >
                              <Download size={12} />
                              Carregar
                            </button>
                          </div>
                          
                          {/* üÜï Bot√£o Restaurar Backups Versionados */}
                          <button
                            onClick={async () => {
                              setLoadingBackups(true);
                              const backups = await listDriveBackups(driveAccessToken);
                              setDriveBackups(backups);
                              setShowBackupRecovery(true);
                              setLoadingBackups(false);
                            }}
                            disabled={driveSyncing || !driveTokenValid}
                            className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition mb-2"
                          >
                            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd"/>
                            </svg>
                            Restaurar Backup Anterior
                          </button>
                          
                          {/* ‚úÖ Bot√£o de Renova√ß√£o de Token */}
                          <button
                            onClick={loginGoogleDrive}
                            className="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                          >
                            üîë Renovar Token
                          </button>
                          
                          {driveFileId && (
                            <p className="text-xs text-gray-500 mt-2 text-center">
                              üìÅ {GOOGLE_DRIVE_CONFIG.FILE_NAME}
                            </p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                    <p className="text-xs text-yellow-800">
                      <strong>üí° Dica:</strong> Use GitHub ou Google Drive para backup autom√°tico. Export/Import para backup manual.
                    </p>
                  </div>
                  </div>
                  )}
                </div>
                
                {/* Exportar para Contabilista - Dropdown */}
                <div className="border rounded-lg overflow-hidden">
                  <button
                    onClick={() => setExportarExpanded(!exportarExpanded)}
                    className="w-full p-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-green-50 hover:from-blue-100 hover:to-green-100 transition"
                  >
                    <div className="text-left">
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üìä Exportar para Contabilista
                      </h3>
                      <p className="text-sm text-gray-600">
                        Gerar CSV/ZIP com faturas do per√≠odo selecionado
                      </p>
                    </div>
                    {exportarExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                  </button>
                  
                  {exportarExpanded && (
                    <div className="border-t bg-white p-4 space-y-4">
                      
                      {/* Filtro de Datas */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 className="font-semibold text-sm mb-3 flex items-center gap-2">
                          üìÖ Per√≠odo para Exportar
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Data In√≠cio
                            </label>
                            <input
                              type="date"
                              value={exportDateStart}
                              onChange={(e) => setExportDateStart(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Data Fim
                            </label>
                            <input
                              type="date"
                              value={exportDateEnd}
                              onChange={(e) => setExportDateEnd(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>
                        
                        {/* Atalhos r√°pidos */}
                        <div className="flex flex-wrap gap-2 mt-3">
                          <button
                            onClick={() => {
                              const hoje = new Date();
                              const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                              setExportDateStart(inicioMes.toISOString().split('T')[0]);
                              setExportDateEnd(hoje.toISOString().split('T')[0]);
                            }}
                            className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                          >
                            Este M√™s
                          </button>
                          <button
                            onClick={() => {
                              const hoje = new Date();
                              const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
                              const fimMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
                              setExportDateStart(inicioMesAnterior.toISOString().split('T')[0]);
                              setExportDateEnd(fimMesAnterior.toISOString().split('T')[0]);
                            }}
                            className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                          >
                            M√™s Anterior
                          </button>
                          <button
                            onClick={() => {
                              setExportDateStart('');
                              setExportDateEnd('');
                            }}
                            className="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700"
                          >
                            Todas as Datas
                          </button>
                        </div>
                        
                        <p className="text-xs text-blue-700 mt-2">
                          üí° <strong>Em Portugal:</strong> Enviar faturas ao contabilista <strong>mensalmente at√© dia 10</strong> do m√™s seguinte
                        </p>
                      </div>
                  
                      {/* Export Combinado */}
                      <div className="bg-gradient-to-br from-white to-blue-50 rounded-lg border-2 border-blue-300 p-4">
                        <h4 className="font-bold text-blue-900 mb-3">
                          üìã Relat√≥rio de Apoio Contabil√≠stico
                        </h4>
                        
                        {/* Estat√≠sticas do per√≠odo selecionado */}
                        <div className="bg-purple-50 border border-purple-200 rounded p-3 mb-4">
                          <div className="flex items-center gap-2 mb-2">
                            <h5 className="font-bold text-purple-900 text-sm">üìÑ Documentos no Per√≠odo</h5>
                          </div>
                          <div className="grid grid-cols-3 gap-2 mb-3">
                            <div className="bg-white rounded-lg p-2 text-center border border-purple-200">
                              <p className="text-lg font-bold text-purple-600">{(() => {

                                if (!exportDateStart && !exportDateEnd) return faturas.filter(f => f.tipoDocumento === 'fatura' || !f.tipoDocumento).length;
                                return faturas.filter(f => {
                                  if (f.tipoDocumento === 'recibo') return false; // Excluir recibos
                                  const dataFatura = f.data;
                                  if (!dataFatura) return false;
                                  if (exportDateStart && dataFatura < exportDateStart) return false;
                                  if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                  return true;
                                }).length;
                              })()}</p>
                              <p className="text-purple-600 text-xs mt-1">Total</p>
                            </div>
                            <div className="bg-green-50 rounded-lg p-2 text-center border border-green-200">
                              <p className="text-lg font-bold text-green-600">{(() => {
                                if (!exportDateStart && !exportDateEnd) return faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && f.documentoPDF).length;
                                return faturas.filter(f => {
                                  if (f.tipoDocumento === 'recibo') return false;
                                  const dataFatura = f.data;
                                  if (!dataFatura) return false;
                                  if (exportDateStart && dataFatura < exportDateStart) return false;
                                  if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                  return f.documentoPDF;
                                }).length;
                              })()}</p>
                              <p className="text-green-600 text-xs mt-1">‚úÖ Com PDF</p>
                            </div>
                            <div className="bg-red-50 rounded-lg p-2 text-center border border-red-200">
                              <p className="text-lg font-bold text-red-600">{(() => {
                                if (!exportDateStart && !exportDateEnd) return faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && !f.documentoPDF).length;
                                return faturas.filter(f => {
                                  if (f.tipoDocumento === 'recibo') return false;
                                  const dataFatura = f.data;
                                  if (!dataFatura) return false;
                                  if (exportDateStart && dataFatura < exportDateStart) return false;
                                  if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                  return !f.documentoPDF;
                                }).length;
                              })()}</p>
                              <p className="text-red-600 text-xs mt-1">‚ö†Ô∏è Sem PDF</p>
                            </div>
                          </div>
                          
                          {/* Breakdown por tipo de fatura */}
                          <div className="bg-blue-50 border-t border-blue-200 pt-2 mt-2">
                            <p className="text-xs font-semibold text-blue-900 mb-2">Por Tipo de Documento:</p>
                            <div className="grid grid-cols-3 gap-2 text-xs">
                              <div className="bg-white rounded p-1.5 text-center">
                                <p className="font-bold text-green-700">{(() => {
                                  const filtered = faturas.filter(f => {
                                    if (f.tipoDocumento === 'recibo') return false;
                                    const dataFatura = f.data;
                                    if (!dataFatura) return false;
                                    if (exportDateStart && dataFatura < exportDateStart) return false;
                                    if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                    return (f.tipo === 'FT' || !f.tipo);
                                  });
                                  return exportDateStart || exportDateEnd ? filtered.length : faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && (f.tipo === 'FT' || !f.tipo)).length;
                                })()}</p>
                                <p className="text-green-700">‚úÖ FT</p>
                              </div>
                              <div className="bg-white rounded p-1.5 text-center">
                                <p className="font-bold text-blue-700">{(() => {
                                  const filtered = faturas.filter(f => {
                                    if (f.tipoDocumento === 'recibo') return false;
                                    const dataFatura = f.data;
                                    if (!dataFatura) return false;
                                    if (exportDateStart && dataFatura < exportDateStart) return false;
                                    if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                    return f.tipo === 'FR';
                                  });
                                  return exportDateStart || exportDateEnd ? filtered.length : faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && f.tipo === 'FR').length;
                                })()}</p>
                                <p className="text-blue-700">‚úÖ FR</p>
                              </div>
                              <div className="bg-white rounded p-1.5 text-center">
                                <p className="font-bold text-orange-700">{(() => {
                                  const filtered = faturas.filter(f => {
                                    if (f.tipoDocumento === 'recibo') return false;
                                    const dataFatura = f.data;
                                    if (!dataFatura) return false;
                                    if (exportDateStart && dataFatura < exportDateStart) return false;
                                    if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                    return f.tipo === 'FS';
                                  });
                                  return exportDateStart || exportDateEnd ? filtered.length : faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && f.tipo === 'FS').length;
                                })()}</p>
                                <p className="text-orange-700">‚ùå FS</p>
                              </div>
                            </div>
                            <p className="text-xs text-blue-800 mt-2 italic">
                              * Apenas FT e FR ser√£o exportadas para o contabilista
                            </p>
                          </div>
                        </div>
                        
                        {/* Bot√µes de Export */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <button 
                            onClick={exportarRelatorioCompletoCSV}
                            className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-6 py-3 text-base font-bold flex items-center justify-center gap-2 transition shadow-lg"
                          >
                            <FileText size={18} />
                            S√≥ CSV (R√°pido)
                          </button>
                          
                          <button 
                            onClick={exportarPacoteCompleto}
                            className="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white rounded-lg px-6 py-3 text-base font-bold flex items-center justify-center gap-2 transition shadow-lg"
                          >
                            <Download size={18} />
                            Pacote Completo (ZIP)
                          </button>
                        </div>
                        
                        <p className="text-xs text-gray-600 mt-3">
                          <strong>CSV:</strong> Dados estruturados para lan√ßamento<br/>
                          <strong>ZIP:</strong> CSV + PDFs das faturas (recomendado)
                        </p>
                      </div>
                      
                      {/* AVISO LEGAL */}
                      <div className="bg-red-50 border border-red-300 rounded p-3">
                        <p className="text-xs font-bold text-red-900 mb-1">‚ö†Ô∏è AVISO LEGAL</p>
                        <ul className="text-xs text-red-800 space-y-1">
                          <li>‚Ä¢ CSV √© APOIO, n√£o substitui documentos fiscais</li>
                          <li>‚Ä¢ PDFs das faturas s√£o OBRIGAT√ìRIOS</li>
                          <li>‚Ä¢ <strong>Apenas FT e FR</strong> s√£o exportadas (FS n√£o pode ser deduzida)</li>
                          <li>‚Ä¢ Conservar documentos 10 anos (Lei Geral Tribut√°ria)</li>
                        </ul>
                      </div>
                    </div>
                  )}
                </div>
                
                <div>
                  <h3 className="font-semibold mb-2">‚ÑπÔ∏è Sobre</h3>
                  <p className="text-sm text-gray-600">
                    <strong>Munchi Manager</strong> v1.0<br/>
                    Sistema de gest√£o para restaurantes
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
      
      {/* Modal OCR */}
      {mostrarModalOCR && (
        <ModalConfirmacaoOCR 
          linhas={linhasOCR}
          ingredientes={ingredientes}
          metadata={metadataOCR}
          fornecedores={fornecedores}
          onConfirmar={handleConfirmarOCR}
          onCancelar={() => setMostrarModalOCR(false)}
          showNotification={showNotification}
          setFornecedores={setFornecedores}
        />
      )}
      
      {/* ==================== MODAL CONFIRMA√á√ÉO FATURA V2.0 ==================== */}
      {modalConfirmacaoFatura.mostrar && modalConfirmacaoFatura.dados && (
        <ModalConfirmacaoFatura
          dadosFatura={modalConfirmacaoFatura.dados}
          fornecedores={fornecedores}
          onConfirmar={handleConfirmarFatura}
          onCancelar={handleCancelarFatura}
          showNotification={showNotification}
          setFornecedores={setFornecedores}
        />
      )}
      {/* ==================== FIM MODAL V2.0 ==================== */}
      
      {/* ==================== üÜï MODAL DESPESA SIMPLES (RENDA/LUZ/√ÅGUA) ==================== */}
      {modalDespesaSimples.mostrar && modalDespesaSimples.dados && (
        <ModalDespesaSimples
          dadosDespesa={modalDespesaSimples.dados}
          onConfirmar={handleConfirmarDespesaSimples}
          onCancelar={handleCancelarDespesaSimples}
        />
      )}
      {/* ==================== FIM MODAL DESPESA SIMPLES ==================== */}
      
      {/* Modal de Importa√ß√£o com Mapeamento Autom√°tico */}
      {mostrarImportacao && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 pt-8 overflow-y-auto">
          <div className="bg-white rounded-lg p-6 max-w-md w-full my-8">
            <h3 className="text-lg font-bold mb-4">üì¶ Importar Vendas (Autom√°tico)</h3>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Fonte dos Dados:</label>
              <select
                value={fonteImportacao}
                onChange={(e) => setFonteImportacao(e.target.value)}
                className="w-full border rounded p-2"
              >
                <option value="moloni">üè¢ Moloni</option>
                <option value="zobaze">üì± Zobaze</option>
              </select>
            </div>
            
            <div className="bg-purple-50 border border-purple-200 rounded p-3 mb-4">
              <p className="text-xs text-purple-800 mb-2 font-semibold">
                ‚ú® Mapeamento Autom√°tico Ativado!
              </p>
              <p className="text-xs text-purple-700">
                ‚Ä¢ <strong>134 regras</strong> de convers√£o autom√°ticas<br/>
                ‚Ä¢ Nomes corrigidos instantaneamente<br/>
                ‚Ä¢ Ex: "Expresso" ‚Üí "Caf√© Expresso"
              </p>
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Formato CSV esperado:</label>
              <div className="bg-gray-50 border rounded p-2 text-xs font-mono">
                Data,Produto,Valor<br/>
                2026-02-01,Expresso,1.35<br/>
                2026-02-01,Croissant,10.00
              </div>
            </div>
            
            <div className="mb-4">
              <label className="bg-purple-600 text-white rounded px-4 py-2 text-sm hover:bg-purple-700 cursor-pointer inline-flex items-center gap-2 font-semibold shadow hover:shadow-lg transition w-full justify-center">
                <Upload size={16} />
                Escolher Arquivo CSV
                <input
                  type="file"
                  accept={fonteImportacao === 'moloni' ? '.csv' : '.xlsx,.xls'}
                  onChange={fonteImportacao === 'moloni' ? importarVendasCSV : processarZobaze}
                  className="hidden"
                />
              </label>
            </div>
            
            <div className="flex gap-2">
              <button
                onClick={() => setMostrarImportacao(false)}
                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üÜï MODAL DE CONTAGEM MANUAL */}
      {modalContagem && ingredienteContagem && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 my-8">
            <h3 className="text-xl font-bold mb-4">
              üìä Contagem de Stock - {ingredienteContagem.nome}
            </h3>
            
            <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
              <p className="text-sm text-gray-700">
                <span className="font-semibold">Modo:</span> {ingredienteContagem.modoWaste === 'manual' ? 'üë§ Manual' : 'ü§ñ Autom√°tico'}
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-semibold">Stock Atual:</span> {(ingredienteContagem.stockAtual || 0).toFixed(2)} {ingredienteContagem.unidade}
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-semibold">Stock M√≠nimo:</span> {ingredienteContagem.stockMinimo || 0} {ingredienteContagem.unidade}
              </p>
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Stock Real Contado (hoje):
              </label>
              <div className="flex gap-2 items-center">
                <input
                  type="number"
                  step="0.01"
                  value={valorContagem}
                  onChange={(e) => setValorContagem(e.target.value)}
                  className="flex-1 px-3 py-2 border rounded text-lg font-bold"
                  placeholder="0.00"
                  autoFocus
                />
                <span className="text-gray-600 font-semibold">{ingredienteContagem.unidade}</span>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                üí° Conta fisicamente o stock atual e insere o valor
              </p>
            </div>
            
            {ingredienteContagem.modoWaste === 'manual' && (
              <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-xs text-yellow-800">
                  ‚ö†Ô∏è <span className="font-semibold">Modo Manual:</span> O sistema calcular√° automaticamente a % real de desperd√≠cio comparando com o stock te√≥rico.
                </p>
              </div>
            )}
            
            <div className="flex gap-2">
              <button
                onClick={() => {
                  setModalContagem(false);
                  setIngredienteContagem(null);
                  setValorContagem(0);
                }}
                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 font-semibold"
              >
                Cancelar
              </button>
              <button
                onClick={salvarContagem}
                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold"
              >
                ‚úÖ Salvar Stock
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üìä MODAL DE MOVIMENTA√á√ïES DE STOCK */}
      {mostrarModalMovimentacoes && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="bg-gradient-to-r from-indigo-600 to-blue-600 px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">üìä Hist√≥rico de Movimenta√ß√µes de Stock</h2>
              <div className="flex items-center gap-2">
                <button 
                  onClick={recalcularMovimentacoes} 
                  className="text-white hover:bg-white/20 rounded-lg px-3 py-2 transition flex items-center gap-2 text-sm font-semibold"
                  title="Recalcular todo o hist√≥rico baseado nas compras e vendas atuais"
                >
                  <RefreshCw className="w-4 h-4" />
                  Recalcular Stock
                </button>
                <button 
                  onClick={recalcularCustosProdutos} 
                  className="text-white hover:bg-white/20 rounded-lg px-3 py-2 transition flex items-center gap-2 text-sm font-semibold bg-white/10"
                  title="Recalcular custos dos produtos baseado nos ingredientes"
                >
                  <Calculator className="w-4 h-4" />
                  Recalcular Custos
                </button>
                <button onClick={() => setMostrarModalMovimentacoes(false)} className="text-white hover:bg-white/20 rounded-full p-2 transition">
                  <X className="w-5 h-5" />
                </button>
              </div>
            </div>
            <div className="bg-gray-50 px-6 py-3 border-b grid grid-cols-4 gap-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">{movimentacoesStock.filter(m => m.tipo === 'entrada').length}</div>
                <div className="text-xs text-gray-600">Entradas</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-red-600">{movimentacoesStock.filter(m => m.tipo === 'saida').length}</div>
                <div className="text-xs text-gray-600">Sa√≠das</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">{movimentacoesStock.filter(m => m.tipo === 'ajuste').length}</div>
                <div className="text-xs text-gray-600">Ajustes</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-gray-700">{movimentacoesStock.length}</div>
                <div className="text-xs text-gray-600">Total</div>
              </div>
            </div>
            <div className="flex-1 overflow-auto p-6">
              {movimentacoesStock.length === 0 ? (
                <div className="text-center py-12">
                  <BarChart3 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-500 font-medium">Nenhuma movimenta√ß√£o registrada ainda</p>
                  <p className="text-xs text-gray-400 mt-2">As movimenta√ß√µes ser√£o registradas automaticamente</p>
                </div>
              ) : (
                <table className="w-full"><thead className="bg-gray-100 sticky top-0"><tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Data</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Tipo</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Ingrediente</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold">Quantidade</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold">Stock Antes</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold">Stock Depois</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Observa√ß√£o</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold">A√ß√µes</th>
                </tr></thead><tbody className="divide-y divide-gray-200">
                  {movimentacoesStock.sort((a, b) => new Date(b.data) - new Date(a.data)).map((mov, idx) => (
                    <tr key={mov.id || idx} className="hover:bg-gray-50">
                      <td className="px-4 py-3 text-sm">{new Date(mov.data).toLocaleDateString('pt-PT')}</td>
                      <td className="px-4 py-3">
                        <span className={`px-2 py-1 text-xs font-semibold rounded ${
                          mov.tipo === 'entrada' ? 'bg-green-100 text-green-700' : 
                          mov.tipo === 'ajuste' ? 'bg-purple-100 text-purple-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {mov.tipo === 'entrada' ? '‚Üë Entrada' : 
                           mov.tipo === 'ajuste' ? '‚öôÔ∏è Ajuste' :
                           '‚Üì Sa√≠da'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-sm font-medium">{mov.ingredienteNome}</td>
                      <td className="px-4 py-3 text-sm text-right font-mono">
                        <span className={
                          mov.tipo === 'entrada' ? 'text-green-600' : 
                          mov.tipo === 'ajuste' ? (mov.quantidade >= 0 ? 'text-purple-600' : 'text-orange-600') :
                          'text-red-600'
                        }>
                          {mov.tipo === 'entrada' || (mov.tipo === 'ajuste' && mov.quantidade >= 0) ? '+' : '-'}
                          {Math.abs(mov.quantidade).toFixed(2)} {mov.unidade}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-sm text-right font-mono text-gray-600">{mov.stockAnterior ? mov.stockAnterior.toFixed(2) : '0.00'}</td>
                      <td className="px-4 py-3 text-sm text-right font-mono font-semibold">{mov.stockNovo ? mov.stockNovo.toFixed(2) : '0.00'}</td>
                      <td className="px-4 py-3 text-xs text-gray-600">{mov.observacao}</td>
                      <td className="px-4 py-3 text-center">
                        {mov.tipo === 'ajuste' ? (
                          <button
                            onClick={() => removerMovimentacao(mov.id)}
                            className="text-red-600 hover:bg-red-50 rounded p-1 transition"
                            title="Remover ajuste manual"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        ) : (
                          <span className="text-gray-300 text-xs">‚Äî</span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody></table>
              )}
            </div>
            <div className="bg-gray-50 px-6 py-3 border-t flex justify-between items-center">
              <div className="text-xs text-gray-500">üí° Movimenta√ß√µes autom√°ticas de vendas e compras</div>
              <button onClick={() => setMostrarModalMovimentacoes(false)} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold text-sm">Fechar</button>
            </div>
          </div>
        </div>
      )}
      
      {/* üÜï MODAL DE RECOVERY DE BACKUPS VERSIONADOS */}
      {showBackupRecovery && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white flex items-center gap-2">
                <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd"/>
                </svg>
                Restaurar Backup Anterior
              </h2>
              <button 
                onClick={() => setShowBackupRecovery(false)}
                className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="p-6 overflow-y-auto flex-1">
              {loadingBackups ? (
                <div className="flex items-center justify-center py-12">
                  <svg className="animate-spin h-8 w-8 text-purple-600" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                  </svg>
                </div>
              ) : driveBackups.length === 0 ? (
                <div className="text-center py-12">
                  <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  <p className="text-gray-600 font-semibold">Nenhum backup encontrado</p>
                  <p className="text-sm text-gray-500 mt-2">Os backups s√£o criados automaticamente ao sincronizar</p>
                </div>
              ) : (
                <div className="space-y-3">
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-blue-800">
                      <strong>üí° Dica:</strong> Backups s√£o criados automaticamente a cada sincroniza√ß√£o. 
                      Os √∫ltimos {GOOGLE_DRIVE_CONFIG.MAX_BACKUPS} backups s√£o mantidos.
                    </p>
                  </div>
                  
                  {driveBackups.map((backup, index) => {
                    const date = new Date(backup.modifiedTime);
                    const isRecent = index === 0;
                    const size = (backup.size / 1024).toFixed(1);
                    
                    return (
                      <div 
                        key={backup.id}
                        className={`border-2 rounded-lg p-4 transition hover:shadow-md ${
                          isRecent 
                            ? 'border-green-400 bg-green-50' 
                            : 'border-gray-200 bg-white'
                        }`}
                      >
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              {isRecent && (
                                <span className="bg-green-600 text-white text-xs px-2 py-0.5 rounded-full font-semibold">
                                  MAIS RECENTE
                                </span>
                              )}
                              <span className="text-gray-500 text-xs">#{driveBackups.length - index}</span>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2 text-sm">
                              <div>
                                <span className="text-gray-600">üìÖ Data:</span>
                                <span className="ml-2 font-semibold">{date.toLocaleDateString('pt-PT')}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">‚è∞ Hora:</span>
                                <span className="ml-2 font-semibold">{date.toLocaleTimeString('pt-PT')}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">üíæ Tamanho:</span>
                                <span className="ml-2 font-mono text-xs">{size} KB</span>
                              </div>
                              <div>
                                <span className="text-gray-600">üïê H√°:</span>
                                <span className="ml-2 font-semibold">
                                  {Math.round((new Date() - date) / 60000)} min
                                </span>
                              </div>
                            </div>
                            
                            <p className="text-xs text-gray-500 mt-2 font-mono truncate">
                              {backup.name}
                            </p>
                          </div>
                          
                          <button
                            onClick={async () => {
                              if (confirm(`‚ö†Ô∏è CONFIRMAR RESTAURO\n\nVai restaurar o backup de:\n${date.toLocaleString('pt-PT')}\n\nOs dados atuais ser√£o substitu√≠dos.\n\nContinuar?`)) {
                                const success = await loadSpecificBackup(driveAccessToken, backup.id);
                                if (success) {
                                  setShowBackupRecovery(false);
                                }
                              }
                            }}
                            className={`px-4 py-2 rounded-lg font-semibold text-sm transition flex items-center gap-2 ${
                              isRecent
                                ? 'bg-green-600 hover:bg-green-700 text-white'
                                : 'bg-purple-600 hover:bg-purple-700 text-white'
                            }`}
                          >
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd"/>
                            </svg>
                            Restaurar
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            
            <div className="bg-gray-50 px-6 py-3 border-t flex justify-end">
              <button 
                onClick={() => setShowBackupRecovery(false)}
                className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üéÇ NOTIFICA√á√ÉO DE BOLOS AGENDADOS */}
      {bolosAgendados.filter(b => !b.processado).length > 0 && (
        <div className="fixed bottom-4 right-4 max-w-lg bg-white rounded-lg shadow-2xl border-2 border-blue-500 p-5 z-50 max-h-[80vh] overflow-y-auto">
          <div className="flex justify-between items-start mb-3 sticky top-0 bg-white pb-3 border-b">
            <div className="flex items-center gap-2">
              <span className="text-3xl">üéÇ</span>
              <div>
                <h3 className="font-bold text-lg text-gray-900">
                  {bolosAgendados.filter(b => !b.processado).length} Bolo(s) Pendente(s)
                </h3>
                <p className="text-xs text-gray-600">Do Google Calendar</p>
              </div>
            </div>
            <button 
              onClick={() => {
                setBolosAgendados([]);
              }}
              className="text-gray-400 hover:text-gray-600"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          
          <div className="space-y-3">
            {bolosAgendados
              .filter(b => !b.processado)
              .sort((a, b) => new Date(a.dataEntrega) - new Date(b.dataEntrega))
              .map((bolo, idx) => {
                const preview = bolo.tipoBolo && bolo.peso ? 
                  calcularBoloExterno(bolo.tipoBolo, bolo.peso) : null;
                
                const dataEntrega = new Date(bolo.dataEntrega);
                const hoje = new Date();
                const diasDif = Math.floor((dataEntrega - hoje) / (1000 * 60 * 60 * 24));
                
                let labelData = '';
                if (diasDif === 0) labelData = 'üìÖ Hoje';
                else if (diasDif === -1) labelData = 'üìÖ Ontem';
                else if (diasDif === -2) labelData = 'üìÖ Anteontem';
                else if (diasDif > 0) labelData = `üìÖ Daqui a ${diasDif} dias`;
                else labelData = `üìÖ H√° ${Math.abs(diasDif)} dias`;
                
                return (
                  <div key={bolo.eventoId} className="border-2 border-gray-200 rounded-lg p-4 bg-gray-50 hover:bg-blue-50 transition">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <div className="font-semibold text-sm text-gray-600 mb-1">{labelData}</div>
                        <div className="font-bold text-gray-900">{bolo.titulo}</div>
                      </div>
                      {!bolo.parseOk && (
                        <span className="text-yellow-600 text-xl">‚ö†Ô∏è</span>
                      )}
                    </div>
                    
                    <div className="grid grid-cols-2 gap-2 text-xs mb-3">
                      {bolo.tipoBolo && (
                        <div>
                          <span className="text-gray-600">Tipo:</span>
                          <span className="ml-1 font-semibold">{bolo.tipoBolo.nome}</span>
                        </div>
                      )}
                      {bolo.peso && (
                        <div>
                          <span className="text-gray-600">Peso:</span>
                          <span className="ml-1 font-semibold">{bolo.peso}kg</span>
                        </div>
                      )}
                      {bolo.preco && (
                        <div>
                          <span className="text-gray-600">Pre√ßo:</span>
                          <span className="ml-1 font-semibold">‚Ç¨{bolo.preco}</span>
                        </div>
                      )}
                      {bolo.cliente && (
                        <div>
                          <span className="text-gray-600">Cliente:</span>
                          <span className="ml-1 font-semibold">{bolo.cliente}</span>
                        </div>
                      )}
                    </div>
                    
                    {preview && bolo.preco && (
                      <div className="bg-green-50 border border-green-200 rounded p-2 mb-3 text-xs">
                        <div className="flex justify-between text-green-800">
                          <span>Custo: ‚Ç¨{preview.custoTotal.toFixed(2)}</span>
                          <span>Lucro: ‚Ç¨{(parseFloat(bolo.preco) - preview.custoTotal).toFixed(2)}</span>
                          <span className="font-bold">{(((parseFloat(bolo.preco) - preview.custoTotal) / parseFloat(bolo.preco)) * 100).toFixed(0)}%</span>
                        </div>
                      </div>
                    )}
                    
                    {!bolo.parseOk && (
                      <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mb-3 text-xs text-yellow-800">
                        ‚ö†Ô∏è Faltam dados. Completa no Calendar ou preenche manualmente.
                      </div>
                    )}
                    
                    <div className="flex gap-2">
                      <button
                        onClick={() => {

                          setBolosAgendados(bolosAgendados.map(b => 
                            b.eventoId === bolo.eventoId 
                              ? {...b, processado: true}
                              : b
                          ));
                        }}
                        className="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 text-xs font-semibold"
                      >
                        Ignorar
                      </button>
                      <button
                        onClick={async () => {

                          if (!bolo.tipoBolo || !bolo.peso || !bolo.preco) {
                            showNotification('‚ùå Faltam dados! Complete no Google Calendar.', 'error');
                            return;
                          }
                          
                          const pesoNum = parseFloat(bolo.peso);
                          const precoNum = parseFloat(bolo.preco);

                          const calculo = calcularBoloExterno(bolo.tipoBolo, pesoNum);
                          
                          if (!calculo) {

                          }
                          
                          const custoTotal = calculo ? calculo.custoTotal : 0;
                          const ingredientesUsados = calculo ? calculo.ingredientes : [];
                          
                          const boloExterno = {
                            tipo: 'bolo_externo',
                            data: bolo.dataEntrega.split('T')[0], // usar data do evento
                            timestamp: Date.now(),
                            eventoCalendarId: bolo.eventoId,
                            produtoBase: bolo.tipoBolo.id,
                            nomeBolo: bolo.tipoBolo.nome,
                            peso: pesoNum,
                            preco: precoNum,
                            ingredientesUsados: ingredientesUsados,
                            custoIngredientes: custoTotal,
                            lucro: precoNum - custoTotal,
                            margem: ((precoNum - custoTotal) / precoNum) * 100,
                            cliente: bolo.cliente,
                            origem: 'calendar'
                          };

                          await db.bolosExternos.add(boloExterno);

                          if (ingredientesUsados.length > 0) {

                            for (const item of ingredientesUsados) {
                              const ingrediente = ingredientes.find(i => i.id === item.ingredienteId);
                              if (ingrediente) {
                                const stockAntes = ingrediente.stockAtual || 0;
                                ingrediente.stockAtual = stockAntes - item.quantidade;

                              } else {
                                console.warn('‚ö†Ô∏è Ingrediente n√£o encontrado:', item.ingredienteId);
                              }
                            }
                          } else {

                          }
                          
                          setIngredientes([...ingredientes]);
                          setBolosExternos([...bolosExternos, boloExterno]);

                          setBolosAgendados(bolosAgendados.map(b => 
                            b.eventoId === bolo.eventoId 
                              ? {...b, processado: true}
                              : b
                          ));
                          
                          showNotification(
                            `‚úÖ Bolo registado!\n${bolo.tipoBolo.nome} ${pesoNum}kg\nLucro: ‚Ç¨${boloExterno.lucro.toFixed(2)}`,
                            'success'
                          );
                          
                          saveToDrive(false);
                        }}
                        disabled={!bolo.parseOk || !bolo.preco}
                        className="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 text-xs font-semibold"
                      >
                        ‚úÖ Registar
                      </button>
                    </div>
                  </div>
                );
              })}
          </div>
          
          <div className="mt-4 pt-3 border-t text-center">
            <button
              onClick={() => buscarBolosAgendados()}
              className="text-xs text-blue-600 hover:text-blue-800 font-semibold"
            >
              üîÑ Atualizar Lista
            </button>
          </div>
        </div>
      )}

      {/* üìã MODAL DE INVENT√ÅRIO F√çSICO */}
      {mostrarModalInventario && inventarioAtivo && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            {(() => {
              const ingrediente = inventarioAtivo.ingredientes[indiceAtualInventario];
              const progresso = ((indiceAtualInventario + 1) / inventarioAtivo.ingredientes.length) * 100;
              const ingredientesContados = inventarioAtivo.ingredientes.filter(i => i.stockReal !== null).length;
              
              let variacaoPreview = null;
              if (inputStockReal !== '' && !isNaN(parseFloat(inputStockReal))) {
                const stockRealTemp = parseFloat(inputStockReal);
                const variacaoTemp = stockRealTemp - ingrediente.stockTeorico;
                const variacaoPercTemp = ingrediente.stockTeorico > 0 
                  ? (variacaoTemp / ingrediente.stockTeorico) * 100 
                  : 0;
                const variacaoEurosTemp = variacaoTemp * ingrediente.custoUnitario;
                
                variacaoPreview = {
                  quantidade: arredondar(variacaoTemp),
                  percentagem: arredondar(variacaoPercTemp),
                  euros: arredondar(variacaoEurosTemp)
                };
              }
              
              return (
                <>
                  <div className="p-6 border-b bg-gradient-to-r from-purple-50 to-pink-50">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-900">üìã Invent√°rio F√≠sico</h2>
                        <p className="text-sm text-gray-600 mt-1">
                          {ingrediente.categoria.charAt(0).toUpperCase() + ingrediente.categoria.slice(1)}
                        </p>
                      </div>
                      <div className="text-right">
                        <span className="text-3xl font-bold text-purple-600">{indiceAtualInventario + 1}</span>
                        <span className="text-gray-400 text-xl"> / {inventarioAtivo.ingredientes.length}</span>
                        <p className="text-xs text-gray-500 mt-1">‚úÖ {ingredientesContados} contados</p>
                      </div>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                      <div 
                        className="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 h-3 rounded-full transition-all duration-500"
                        style={{ width: `${progresso}%` }}
                      />
                    </div>
                    <p className="text-xs text-gray-500 text-right mt-1">{progresso.toFixed(0)}% completo</p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-8">
                    <div className="text-center mb-8">
                      <h3 className="text-5xl font-bold text-gray-900 mb-3">{ingrediente.ingredienteNome}</h3>
                      <div className="flex items-center justify-center gap-3">
                        <span className="inline-block px-4 py-1.5 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">
                          {ingrediente.categoria}
                        </span>
                        <span className="inline-block px-4 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                          {ingrediente.unidade}
                        </span>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                      <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 text-center border-2 border-blue-200">
                        <p className="text-xs font-semibold text-blue-600 mb-1">üìä STOCK TE√ìRICO</p>
                        <p className="text-3xl font-bold text-blue-900">{ingrediente.stockTeorico.toFixed(2)}</p>
                        <p className="text-sm text-blue-700 mt-1">{ingrediente.unidade}</p>
                      </div>
                      
                      <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 text-center border border-green-200">
                        <p className="text-xs font-semibold text-green-600 mb-1">üìÖ √öLTIMA COMPRA</p>
                        {ingrediente.ultimaCompra ? (
                          <>
                            <p className="text-lg font-bold text-green-900">
                              {new Date(ingrediente.ultimaCompra.data).toLocaleDateString('pt-PT')}
                            </p>
                            <p className="text-sm text-green-700">
                              {ingrediente.ultimaCompra.quantidade.toFixed(2)} {ingrediente.unidade}
                            </p>
                          </>
                        ) : (
                          <p className="text-sm text-gray-500 py-2">Sem dados</p>
                        )}
                      </div>
                      
                      <div className="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-xl p-5 text-center border border-amber-200">
                        <p className="text-xs font-semibold text-amber-600 mb-1">üí∂ VALOR UNIT√ÅRIO</p>
                        <p className="text-2xl font-bold text-amber-900">‚Ç¨{ingrediente.custoUnitario.toFixed(2)}</p>
                        <p className="text-sm text-amber-700">por {ingrediente.unidade}</p>
                      </div>
                    </div>
                    
                    <div className="mb-8">
                      <label className="block text-center text-lg font-bold text-gray-900 mb-3">
                        üì¶ Quanto stock f√≠sico contou?
                      </label>
                      <div className="relative">
                        <input
                          type="number"
                          step="0.01"
                          min="0"
                          value={inputStockReal}
                          onChange={(e) => setInputStockReal(e.target.value)}
                          className="w-full text-5xl font-bold text-center border-4 border-purple-400 rounded-2xl py-6 px-8 focus:border-purple-600 focus:ring-8 focus:ring-purple-200 transition shadow-xl"
                          placeholder="0.00"
                          autoFocus
                          onKeyPress={(e) => {
                            if (e.key === 'Enter' && inputStockReal !== '') {
                              registarStockReal(inputStockReal);
                              proximoIngredienteInventario();
                            }
                          }}
                        />
                        <span className="absolute right-8 top-1/2 -translate-y-1/2 text-4xl font-bold text-gray-400 pointer-events-none">
                          {ingrediente.unidade}
                        </span>
                      </div>
                      <div className="flex items-center justify-center gap-4 mt-3">
                        <p className="text-sm text-gray-500 text-center">
                          üí° Pressione <kbd className="px-2 py-1 bg-gray-200 rounded border">Enter</kbd> para confirmar
                        </p>
                        {ingrediente.stockReal !== null && (
                          <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                            ‚úì J√° contado
                          </span>
                        )}
                      </div>
                    </div>
                    
                    {variacaoPreview && (
                      <div className={`rounded-2xl p-6 text-center shadow-lg border-2 ${
                        Math.abs(variacaoPreview.quantidade) < 0.01 ? 'bg-green-50 border-green-300' :
                        variacaoPreview.quantidade > 0 ? 'bg-blue-50 border-blue-300' : 'bg-red-50 border-red-300'
                      }`}>
                        <p className={`text-sm font-bold mb-2 ${
                          Math.abs(variacaoPreview.quantidade) < 0.01 ? 'text-green-700' :
                          variacaoPreview.quantidade > 0 ? 'text-blue-700' : 'text-red-700'
                        }`}>
                          {Math.abs(variacaoPreview.quantidade) < 0.01 ? '‚úÖ STOCK CORRETO' :
                           variacaoPreview.quantidade > 0 ? 'üìà EXCEDENTE' : 'üìâ FALTA'}
                        </p>
                        <div className="grid grid-cols-3 gap-4">
                          <div>
                            <p className="text-xs text-gray-600 mb-1">Quantidade</p>
                            <p className={`text-2xl font-bold ${
                              Math.abs(variacaoPreview.quantidade) < 0.01 ? 'text-green-700' :
                              variacaoPreview.quantidade > 0 ? 'text-blue-700' : 'text-red-700'
                            }`}>
                              {variacaoPreview.quantidade > 0 ? '+' : ''}{variacaoPreview.quantidade.toFixed(2)}
                            </p>
                            <p className="text-xs text-gray-600">{ingrediente.unidade}</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-600 mb-1">Percentagem</p>
                            <p className={`text-2xl font-bold ${
                              Math.abs(variacaoPreview.quantidade) < 0.01 ? 'text-green-700' :
                              variacaoPreview.quantidade > 0 ? 'text-blue-700' : 'text-red-700'
                            }`}>
                              {variacaoPreview.percentagem > 0 ? '+' : ''}{variacaoPreview.percentagem.toFixed(1)}%
                            </p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-600 mb-1">Valor</p>
                            <p className={`text-2xl font-bold ${
                              Math.abs(variacaoPreview.quantidade) < 0.01 ? 'text-green-700' :
                              variacaoPreview.quantidade > 0 ? 'text-blue-700' : 'text-red-700'
                            }`}>
                              {variacaoPreview.euros > 0 ? '+' : ''}‚Ç¨{Math.abs(variacaoPreview.euros).toFixed(2)}
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50 flex items-center justify-between gap-3">
                    <button
                      onClick={ingredienteAnteriorInventario}
                      disabled={indiceAtualInventario === 0}
                      className="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition-all hover:scale-105 active:scale-95"
                    >
                      ‚Üê Anterior
                    </button>
                    
                    <button
                      onClick={pularIngredienteInventario}
                      className="px-6 py-3 bg-yellow-100 text-yellow-700 rounded-xl font-semibold hover:bg-yellow-200 transition-all hover:scale-105 active:scale-95"
                    >
                      ‚è≠ Pular
                    </button>
                    
                    <button
                      onClick={proximoIngredienteInventario}
                      className="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-bold hover:shadow-xl transition-all hover:scale-105 active:scale-95"
                    >
                      {indiceAtualInventario === inventarioAtivo.ingredientes.length - 1 ? '‚úì Concluir Invent√°rio' : 'Pr√≥ximo ‚Üí'}
                    </button>
                  </div>
                  
                  <div className="p-4 border-t text-center bg-gray-100">
                    <button
                      onClick={cancelarInventario}
                      className="text-sm text-gray-600 hover:text-red-600 font-medium transition-colors"
                    >
                      ‚úñÔ∏è Cancelar Invent√°rio
                    </button>
                  </div>
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* üìä MODAL DE HIST√ìRICO DE INVENT√ÅRIOS */}
      {mostrarHistoricoInventarios && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b bg-gradient-to-r from-purple-50 to-pink-50">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">üìä Hist√≥rico de Invent√°rios</h2>
                  <p className="text-sm text-gray-600 mt-1">
                    {contagensHistorico.length} {contagensHistorico.length === 1 ? 'invent√°rio realizado' : 'invent√°rios realizados'}
                  </p>
                </div>
                <button
                  onClick={() => setMostrarHistoricoInventarios(false)}
                  className="p-2 hover:bg-gray-200 rounded-lg transition"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-6">
              {contagensHistorico.length === 0 ? (
                <div className="text-center py-12">
                  <p className="text-gray-500 text-lg">Nenhum invent√°rio realizado ainda</p>
                  <p className="text-gray-400 text-sm mt-2">Clique em "Fazer Invent√°rio" para come√ßar</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {[...contagensHistorico].reverse().map((contagem, index) => {
                    const ingredientesContados = contagem.ingredientes.filter(i => i.stockReal !== null).length;
                    const variacaoPositiva = contagem.resumo.variacaoTotalEuros >= 0;
                    
                    return (
                      <div key={contagem.id} className="border-2 border-gray-200 rounded-xl p-5 hover:shadow-lg transition">
                        <div className="flex items-start justify-between mb-4">
                          <div>
                            <h3 className="text-lg font-bold text-gray-900">
                              Invent√°rio #{contagensHistorico.length - index}
                            </h3>
                            <p className="text-sm text-gray-600">
                              üìÖ {new Date(contagem.dataInicio).toLocaleString('pt-PT')}
                            </p>
                            <p className="text-xs text-gray-500">üë§ {contagem.utilizador}</p>
                          </div>
                          <div className={`text-right px-4 py-2 rounded-lg ${
                            variacaoPositiva ? 'bg-blue-100' : 'bg-red-100'
                          }`}>
                            <p className={`text-2xl font-bold ${
                              variacaoPositiva ? 'text-blue-700' : 'text-red-700'
                            }`}>
                              {variacaoPositiva ? '+' : ''}‚Ç¨{contagem.resumo.variacaoTotalEuros.toFixed(2)}
                            </p>
                            <p className="text-xs text-gray-600">Varia√ß√£o Total</p>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                          <div className="bg-gray-50 rounded-lg p-3 text-center">
                            <p className="text-xs text-gray-600 mb-1">Contados</p>
                            <p className="text-xl font-bold text-gray-900">
                              {ingredientesContados}/{contagem.resumo.totalIngredientes}
                            </p>
                          </div>
                          <div className="bg-green-50 rounded-lg p-3 text-center">
                            <p className="text-xs text-green-600 mb-1">Excesso</p>
                            <p className="text-xl font-bold text-green-700">
                              ‚Ç¨{contagem.resumo.excessoEuros.toFixed(2)}
                            </p>
                          </div>
                          <div className="bg-red-50 rounded-lg p-3 text-center">
                            <p className="text-xs text-red-600 mb-1">Falta</p>
                            <p className="text-xl font-bold text-red-700">
                              ‚Ç¨{contagem.resumo.faltaEuros.toFixed(2)}
                            </p>
                          </div>
                          <div className="bg-purple-50 rounded-lg p-3 text-center">
                            <p className="text-xs text-purple-600 mb-1">Categorias</p>
                            <p className="text-xl font-bold text-purple-700">
                              {Object.keys(contagem.resumo.categorias).length}
                            </p>
                          </div>
                        </div>
                        
                        <div className="mb-4">
                          <p className="text-xs font-semibold text-gray-600 mb-2">Top 3 Categorias (varia√ß√£o):</p>
                          <div className="flex flex-wrap gap-2">
                            {Object.entries(contagem.resumo.categorias)
                              .sort((a, b) => Math.abs(b[1].variacaoEuros) - Math.abs(a[1].variacaoEuros))
                              .slice(0, 3)
                              .map(([cat, dados]) => (
                                <span 
                                  key={cat}
                                  className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                    dados.variacaoEuros >= 0 
                                      ? 'bg-blue-100 text-blue-700' 
                                      : 'bg-red-100 text-red-700'
                                  }`}
                                >
                                  {cat}: {dados.variacaoEuros >= 0 ? '+' : ''}‚Ç¨{dados.variacaoEuros.toFixed(2)}
                                </span>
                              ))}
                          </div>
                        </div>
                        
                        <button
                          onClick={() => exportarRelatorioInventario(contagem)}
                          className="w-full py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:shadow-lg transition"
                        >
                          üìÑ Exportar Relat√≥rio Completo
                        </button>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<RestauranteGestor />);
    </script>
</body>
</html>
