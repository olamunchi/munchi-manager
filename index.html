<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munchi Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- IndexedDB Library - Dexie.js -->
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
  <!-- OCR Libraries - PDF.js Legacy + Tesseract -->
  <!-- Vers√£o 3.11 √© mais est√°vel que 4.x -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuzzball@2.1.2/dist/fuzzball.umd.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  
  <!-- IMPORTANTE: config.js cont√©m a API Key e N√ÉO deve ser commitado no git -->
  <!-- Se n√£o existir, copie config.example.js para config.js e adicione sua API key -->
  <script src="config.js"></script>
  
  <script>
    // Configurar PDF.js worker
    void 0;
    
    const configurePDFJS = () => {
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        void 0;
        return true;
      }
      return false;
    };
    
    // Tentar configurar imediatamente
    if (!configurePDFJS()) {
      // Retry ap√≥s 500ms
      setTimeout(() => {
        if (!configurePDFJS()) {
          // Retry final ap√≥s 1.5s
          setTimeout(() => {
            if (!configurePDFJS()) {
              void 0;
            }
          }, 1000);
        }
      }, 500);
    }
  </script>
</head>
<body style="background: linear-gradient(to bottom right, #eff6ff, #f3e8ff, #fce7f3); min-height: 100vh;">
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

// ==================== FUN√á√ÉO DE NORMALIZA√á√ÉO DE TEXTO ====================
// Remove acentos, cedilhas e outros diacr√≠ticos para facilitar busca
const normalizeText = (text) => {
  if (!text) return '';
  return text
    .toLowerCase()
    .normalize('NFD') // Decomp√µe caracteres acentuados
    .replace(/[\u0300-\u036f]/g, '') // Remove diacr√≠ticos (acentos)
    .replace(/√ß/g, 'c') // Cedilha
    .replace(/[^a-z0-9\s]/g, ''); // Remove caracteres especiais, mant√©m espa√ßos
};

// Icons
const Plus = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
const Trash2 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
const RefreshCw = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
const Upload = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
const Download = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>;
const TrendingUp = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
const DollarSign = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const Package = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>;
const FileText = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
const Calculator = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>;
const BarChart3 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>;
const Target = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
const Check = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;
const X = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
const AlertCircle = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const ChevronDown = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>;
const ChevronUp = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>;
const Search = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
const Settings = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
const Edit2 = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
const Edit = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>;
const Save = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>;
const Users = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;
const Paperclip = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>;
const FilePdf = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>;
const Eye = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>;

// ==================== INDEXEDDB CONFIGURATION ====================
// Configura√ß√£o da base de dados IndexedDB usando Dexie
const db = new Dexie('MunchiManagerDB');

// VERS√ÉO 1: Movimenta√ß√µes de stock
db.version(1).stores({
  movimentacoesStock: '++id, data, tipo, ingredienteId, produtoId',
});

// üÜï VERS√ÉO 2: Dados cr√≠ticos para funcionamento offline
db.version(2).stores({
  movimentacoesStock: '++id, data, tipo, ingredienteId, produtoId',
  vocabulario: 'id, fornecedorNIF, textoNormalizado, ingredienteId',
  ingredientes: 'id, nome, categoria',
  fornecedores: 'id, nif, nome',
  templates: 'nifFornecedor, linhaInicio, linhaFim'  // ‚úÖ nifFornecedor √© o identificador
});

// Helper functions para IndexedDB
const IndexedDBStorage = {
  // Salvar movimenta√ß√µes - üö´ DESATIVADO
  async saveMovimentacoes(movimentacoes) {
    // üö´ DESATIVADO: IndexedDB desativado, s√≥ Google Drive
    console.log(`üíæ IndexedDB desativado - dados v√£o apenas para Google Drive`);
    return true;
  },

  // Carregar movimenta√ß√µes - ‚úÖ ATIVO (leitura OK)
  async loadMovimentacoes() {
    try {
      const movimentacoes = await db.movimentacoesStock.toArray();
      console.log(`‚úÖ IndexedDB: ${movimentacoes.length} movimenta√ß√µes carregadas`);
      return movimentacoes;
    } catch (error) {
      console.error('‚ùå Erro ao carregar do IndexedDB:', error);
      return [];
    }
  },

  // Obter estat√≠sticas - ‚úÖ ATIVO (leitura OK)
  async getStats() {
    try {
      const total = await db.movimentacoesStock.count();
      const entradas = await db.movimentacoesStock.where('tipo').equals('entrada').count();
      const saidas = await db.movimentacoesStock.where('tipo').equals('saida').count();
      const ajustes = await db.movimentacoesStock.where('tipo').equals('ajuste').count();
      
      return { total, entradas, saidas, ajustes };
    } catch (error) {
      console.error('‚ùå Erro ao obter estat√≠sticas:', error);
      return { total: 0, entradas: 0, saidas: 0, ajustes: 0 };
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üß† DADOS CR√çTICOS - NECESS√ÅRIOS PARA FUNCIONAMENTO OFFLINE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // VOCABUL√ÅRIO: Sistema de aprendizagem OCR
  async saveVocabulario(data) {
    try {
      if (!data || data.length === 0) return true;
      
      // Garantir que todos t√™m ID (criar se n√£o tiver)
      const comIds = data.map((item, index) => {
        if (item && item.id) return item;
        // Criar ID se faltar (n√£o deveria acontecer, mas √© fallback)
        return {
          ...item,
          id: `vocab_fallback_${Date.now()}_${index}`
        };
      });
      
      await db.vocabulario.clear();
      await db.vocabulario.bulkPut(comIds);
      console.log('üíæ Vocabul√°rio ‚Üí IndexedDB:', comIds.length, 'entradas');
      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar vocabul√°rio:', e);
      console.log('Amostra:', data?.[0]);
      return false;
    }
  },

  async loadVocabulario() {
    try {
      const data = await db.vocabulario.toArray();
      console.log('‚úÖ Vocabul√°rio ‚Üê IndexedDB:', data.length, 'entradas');
      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar vocabul√°rio:', e);
      return [];
    }
  },

  // INGREDIENTES: Necess√°rios para dropdown em faturas
  async saveIngredientes(data) {
    try {
      if (!data || data.length === 0) return true;
      
      // Garantir que todos t√™m ID (criar se n√£o tiver)
      const comIds = data.map((item, index) => {
        if (item && item.id) return item;
        // Criar ID se faltar (n√£o deveria acontecer, mas √© fallback)
        return {
          ...item,
          id: `ing_fallback_${Date.now()}_${index}`
        };
      });
      
      await db.ingredientes.clear();
      await db.ingredientes.bulkPut(comIds);
      console.log('üíæ Ingredientes ‚Üí IndexedDB:', comIds.length);
      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar ingredientes:', e);
      console.log('Amostra:', data?.[0]);
      return false;
    }
  },

  async loadIngredientes() {
    try {
      const data = await db.ingredientes.toArray();
      console.log('‚úÖ Ingredientes ‚Üê IndexedDB:', data.length);
      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar ingredientes:', e);
      return [];
    }
  },

  // FORNECEDORES: Necess√°rios para dropdown em faturas
  async saveFornecedores(data) {
    try {
      if (!data || data.length === 0) return true;
      
      // Garantir que todos t√™m ID (criar se n√£o tiver)
      const comIds = data.map((item, index) => {
        if (item && item.id) return item;
        // Criar ID se faltar (n√£o deveria acontecer, mas √© fallback)
        return {
          ...item,
          id: `forn_fallback_${Date.now()}_${index}`
        };
      });
      
      await db.fornecedores.clear();
      await db.fornecedores.bulkPut(comIds);
      console.log('üíæ Fornecedores ‚Üí IndexedDB:', comIds.length);
      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar fornecedores:', e);
      console.log('Amostra:', data?.[0]);
      return false;
    }
  },

  async loadFornecedores() {
    try {
      const data = await db.fornecedores.toArray();
      console.log('‚úÖ Fornecedores ‚Üê IndexedDB:', data.length);
      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar fornecedores:', e);
      return [];
    }
  },

  // TEMPLATES OCR: Necess√°rios para extrair dados de PDFs
  async saveTemplates(data) {
    try {
      if (!data || data.length === 0) return true;
      
      // Templates usam nifFornecedor como identificador √∫nico
      // Filtrar apenas templates v√°lidos (com nifFornecedor)
      const validos = data.filter(t => t && t.nifFornecedor);
      
      if (validos.length === 0) {
        console.log('‚ÑπÔ∏è Nenhum template para guardar');
        return true;
      }
      
      await db.templates.clear();
      await db.templates.bulkPut(validos);
      console.log('üíæ Templates OCR ‚Üí IndexedDB:', validos.length);
      return true;
    } catch (e) {
      console.error('‚ùå Erro ao guardar templates:', e);
      console.log('Amostra:', data?.[0]);
      return false;
    }
  },

  async loadTemplates() {
    try {
      const data = await db.templates.toArray();
      console.log('‚úÖ Templates OCR ‚Üê IndexedDB:', data.length);
      return data;
    } catch (e) {
      console.error('‚ùå Erro ao carregar templates:', e);
      return [];
    }
  },

  // Limpar todos os dados
  async clearAll() {
    try {
      await db.movimentacoesStock.clear();
      await db.vocabulario.clear();
      await db.ingredientes.clear();
      await db.fornecedores.clear();
      await db.templates.clear();
      console.log('‚úÖ IndexedDB limpo (todas as tabelas)');
      return true;
    } catch (error) {
      console.error('‚ùå Erro ao limpar IndexedDB:', error);
      return false;
    }
  },

  // Migrar dados do localStorage para IndexedDB (apenas primeira vez)
  async migrateFromLocalStorage() {
    try {
      const localData = localStorage.getItem('movimentacoesStock');
      if (localData) {
        const movimentacoes = JSON.parse(localData);
        const count = await db.movimentacoesStock.count();
        
        // S√≥ migrar se IndexedDB estiver vazio
        if (count === 0 && movimentacoes.length > 0) {
          await db.movimentacoesStock.bulkAdd(movimentacoes);
          console.log(`‚úÖ Migra√ß√£o: ${movimentacoes.length} movimenta√ß√µes de localStorage ‚Üí IndexedDB`);
          
          // Remover do localStorage ap√≥s migra√ß√£o bem-sucedida
          localStorage.removeItem('movimentacoesStock');
          return true;
        }
      }
      return false;
    } catch (error) {
      console.error('‚ùå Erro na migra√ß√£o:', error);
      return false;
    }
  }
};

// ==================== GITHUB GIST SYNC ====================
const GitHubSync = {
  GIST_ID_KEY: 'munchi_gist_id',
  TOKEN_KEY: 'munchi_github_token',
  LAST_SYNC_KEY: 'munchi_last_sync',
  
  async saveToGist(data, token) {
    try {
      const gistId = localStorage.getItem(this.GIST_ID_KEY);
      const url = gistId 
        ? `https://api.github.com/gists/${gistId}`
        : 'https://api.github.com/gists';
      
      const method = gistId ? 'PATCH' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          description: 'Munchi Manager - Backup Autom√°tico',
          public: false,
          files: {
            'munchi-data.json': {
              content: JSON.stringify(data, null, 2)
            }
          }
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`GitHub API error: ${response.status} - ${errorText}`);
      }
      
      const result = await response.json();
      
      if (!gistId) {
        localStorage.setItem(this.GIST_ID_KEY, result.id);
      }
      
      localStorage.setItem(this.LAST_SYNC_KEY, new Date().toISOString());
      
      return { success: true, gistId: result.id, url: result.html_url };
    } catch (error) {
      void 0;
      return { success: false, error: error.message };
    }
  },
  
  async loadFromGist(token) {
    try {
      const gistId = localStorage.getItem(this.GIST_ID_KEY);
      if (!gistId) {
        return { success: false, error: 'Nenhum backup encontrado' };
      }
      
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: {
          'Authorization': `token ${token}`,
        }
      });
      
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }
      
      const gist = await response.json();
      const content = gist.files['munchi-data.json'].content;
      const data = JSON.parse(content);
      
      return { success: true, data };
    } catch (error) {
      void 0;
      return { success: false, error: error.message };
    }
  },
  
  isConfigured() {
    return !!localStorage.getItem(this.TOKEN_KEY);
  },
  
  getToken() {
    return localStorage.getItem(this.TOKEN_KEY);
  },
  
  setToken(token) {
    localStorage.setItem(this.TOKEN_KEY, token);
  },
  
  clearConfig() {
    localStorage.removeItem(this.TOKEN_KEY);
    localStorage.removeItem(this.GIST_ID_KEY);
    localStorage.removeItem(this.LAST_SYNC_KEY);
  },
  
  getLastSync() {
    const lastSync = localStorage.getItem(this.LAST_SYNC_KEY);
    return lastSync ? new Date(lastSync) : null;
  },
  
  getGistUrl() {
    const gistId = localStorage.getItem(this.GIST_ID_KEY);
    return gistId ? `https://gist.github.com/${gistId}` : null;
  },
  
  getAutoSyncEnabled() {
    const enabled = localStorage.getItem('munchi_auto_sync_enabled');
    return enabled === null ? true : enabled === 'true';
  },
  
  setAutoSyncEnabled(enabled) {
    localStorage.setItem('munchi_auto_sync_enabled', enabled.toString());
  }
};

// Novos √≠cones para cloud sync
const Cloud = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>;
const CloudCheck = (props) => <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;


if (typeof window.storage === 'undefined') {
  window.storage = {
    get: (key) => { 
      return Promise.resolve().then(() => {
        try { 
          const value = localStorage.getItem(key); 
          return value ? { key, value, shared: false } : null; 
        } catch (e) { 
          console.error('Storage get error:', e);
          return null; 
        }
      });
    },
    set: (key, value) => { 
      // üö´ DESATIVADO: LocalStorage causa crashes quando cheio
      // Google Drive √© a √∫nica fonte de verdade
      return Promise.resolve({ key, value, shared: false });
    },
    delete: (key) => { 
      return Promise.resolve().then(() => {
        try { 
          localStorage.removeItem(key); 
          return { key, deleted: true, shared: false }; 
        } catch (e) { 
          console.error('Storage delete error:', e);
          return null; 
        }
      });
    },
    list: () => Promise.resolve({ keys: Object.keys(localStorage), shared: false })
  };
}




const CloudSyncPanel = ({ 
  onSync, 
  isSyncing, 
  lastSync, 
  syncError,
  autoSyncEnabled,
  setAutoSyncEnabled 
}) => {
  const [showConfig, setShowConfig] = React.useState(false);
  const [token, setToken] = React.useState('');
  const [showToken, setShowToken] = React.useState(false);
  
  const isConfigured = GitHubSync.isConfigured();
  const gistUrl = GitHubSync.getGistUrl();
  
  const saveToken = () => {
    if (token.trim()) {
      GitHubSync.setToken(token.trim());
      setShowConfig(false);
      setToken('');
      alert('‚úÖ Token guardado! A sincronizar dados...');
      setTimeout(onSync, 500);
    }
  };
  
  const clearConfig = () => {
    if (confirm('‚ö†Ô∏è Tem a certeza que quer desconectar o GitHub?\n\nOs dados locais N√ÉO ser√£o apagados, mas o backup autom√°tico ser√° desativado.')) {
      GitHubSync.clearConfig();
      setShowConfig(false);
      alert('‚úÖ GitHub desconectado');
    }
  };
  
  const getTimeSince = (date) => {
    if (!date) return 'Nunca';
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Agora mesmo';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `H√° ${minutes} min`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `H√° ${hours}h`;
    const days = Math.floor(hours / 24);
    return `H√° ${days} ${days === 1 ? 'dia' : 'dias'}`;
  };
  
  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Cloud className="w-6 h-6 text-blue-600" />
          <div>
            <h3 className="font-bold text-blue-900">Backup Cloud (GitHub)</h3>
            {isConfigured && !showConfig && (
              <p className="text-xs text-blue-700">Auto-sync: {autoSyncEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</p>
            )}
          </div>
        </div>
        <button
          onClick={() => setShowConfig(!showConfig)}
          className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded transition"
          title="Configura√ß√µes"
        >
          <Settings className="w-5 h-5" />
        </button>
      </div>
      
      {showConfig ? (
        <div className="space-y-3 bg-white rounded-lg p-4 border border-blue-300">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üîë GitHub Personal Access Token
            </label>
            <div className="relative">
              <input
                type={showToken ? "text" : "password"}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                className="w-full px-3 py-2 pr-20 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-semibold"
              >
                {showToken ? 'Ocultar' : 'Mostrar'}
              </button>
            </div>
            
            <div className="mt-2 space-y-1 text-xs text-gray-600">
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">1.</span>
                <span>Crie token em: <a href="https://github.com/settings/tokens/new?scopes=gist&description=Munchi%20Manager%20Backup" target="_blank" className="text-blue-600 underline font-semibold hover:text-blue-800">github.com/settings/tokens</a></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">2.</span>
                <span>Marque apenas: <strong className="text-green-700">‚úì gist</strong></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">3.</span>
                <span>Cole aqui e clique em "Guardar"</span>
              </p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={saveToken}
              disabled={!token.trim()}
              className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
            >
              üíæ Guardar Token
            </button>
            {isConfigured && (
              <button
                onClick={clearConfig}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition"
              >
                üîå Desconectar
              </button>
            )}
          </div>
          
          <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-900">
            <p className="font-semibold mb-1 flex items-center gap-1">
              üîí Seguran√ßa & Privacidade
            </p>
            <ul className="space-y-1 ml-4 text-yellow-800">
              <li>‚Ä¢ Token guardado <strong>localmente</strong> no seu browser</li>
              <li>‚Ä¢ Nunca partilhado com servidores externos</li>
              <li>‚Ä¢ Gist criado como <strong>privado</strong> (s√≥ voc√™ v√™)</li>
              <li>‚Ä¢ Pode revogar token a qualquer momento</li>
            </ul>
          </div>
        </div>
      ) : (
        <>
          {!isConfigured ? (
            <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              <p className="text-sm text-yellow-800 flex items-center gap-2">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <span>Configure o GitHub para ativar backup autom√°tico na cloud</span>
              </p>
              <button
                onClick={() => setShowConfig(true)}
                className="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-semibold transition text-sm"
              >
                ‚öôÔ∏è Configurar Agora
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              {/* Status Card */}
              <div className="bg-white rounded-lg p-3 border-2 border-green-300 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <CloudCheck className="w-5 h-5 text-green-600" />
                    <div>
                      <p className="text-sm font-semibold text-green-900">Conectado ‚úì</p>
                      <p className="text-xs text-green-700">√öltimo backup: {getTimeSince(lastSync)}</p>
                    </div>
                  </div>
                  <button
                    onClick={onSync}
                    disabled={isSyncing}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    {isSyncing ? 'A sincronizar...' : 'Sync'}
                  </button>
                </div>
                
                {gistUrl && (
                  <a
                    href={gistUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1"
                  >
                    üîó Ver backup no GitHub
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
              
              {/* Error Message */}
              {syncError && (
                <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                  <p className="text-sm text-red-800 flex items-start gap-2">
                    <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                    <span><strong>Erro:</strong> {syncError}</span>
                  </p>
                  <button
                    onClick={() => setShowConfig(true)}
                    className="mt-2 text-xs text-red-700 hover:text-red-900 underline font-semibold"
                  >
                    ‚Üí Reconfigurar token
                  </button>
                </div>
              )}
              
              {/* Auto-sync Toggle */}
              <div className="flex items-center justify-between bg-white rounded p-2 border border-gray-200">
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="autoSyncToggle"
                    checked={autoSyncEnabled}
                    onChange={(e) => setAutoSyncEnabled(e.target.checked)}
                    className="w-4 h-4 rounded text-blue-600 focus:ring-2 focus:ring-blue-500"
                  />
                  <label htmlFor="autoSyncToggle" className="text-sm text-gray-700 cursor-pointer">
                    üîÑ Auto-sync a cada 5 minutos
                  </label>
                </div>
                <span className={`text-xs font-semibold px-2 py-1 rounded ${autoSyncEnabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                  {autoSyncEnabled ? 'ON' : 'OFF'}
                </span>
              </div>
              
              {/* Info Box */}
              <div className="bg-blue-50 border border-blue-200 rounded p-2 text-xs text-blue-800">
                <p className="font-semibold mb-1">üí° Como funciona:</p>
                <ul className="space-y-0.5 ml-3">
                  <li>‚Ä¢ Dados guardados automaticamente no GitHub</li>
                  <li>‚Ä¢ Aceda de qualquer dispositivo com o mesmo token</li>
                  <li>‚Ä¢ Hist√≥rico completo no seu Gist privado</li>
                </ul>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

const ComprasAnalysis = ({ despesas, faturas = [], ingredientes, fornecedores }) => {
  const [searchCompra, setSearchCompra] = React.useState('');
  const [expandedIngrediente, setExpandedIngrediente] = React.useState(null); // Ingrediente expandido na an√°lise
  const [categoriaCompra, setCategoriaCompra] = React.useState('all');
  
  // Combinar despesas antigas com faturas novas
  const todasCompras = React.useMemo(() => {
    const compras = [];
    
    // Adicionar despesas antigas (se existirem)
    despesas.forEach(d => {
      if (d.ingredienteId && d.quantidade && d.quantidade > 0) {
        compras.push({
          ingredienteId: d.ingredienteId,
          quantidade: d.quantidade,
          fornecedor: d.fornecedor,
          precoUnitario: d.valor / d.quantidade,
          data: d.data
        });
      }
    });
    
    // Adicionar items de faturas novas
    faturas.forEach(f => {
      if (f.itens && Array.isArray(f.itens)) {
        f.itens.forEach(item => {
          compras.push({
            ingredienteId: item.ingredienteId || item.ingrediente,
            quantidade: item.quantidade,
            fornecedor: f.fornecedor || f.fornecedorNome,
            precoUnitario: item.precoUnitario,
            data: f.data
          });
        });
      }
    });
    
    return compras;
  }, [despesas, faturas]);
  
  
  // Categorize ingredients
  const categorias = {
    'vegetais': ['alface', 'tomate', 'cebola', 'cenoura', 'batata', 'cogumelo', 'pimento', 'alho', 'couve', 'br√≥colos', 'espinafre'],
    'carnes': ['frango', 'carne', 'porco', 'vaca', 'peru', 'bacon', 'salsicha', 'bife', 'costela'],
    'peixe': ['salm√£o', 'atum', 'bacalhau', 'camar√£o', 'polvo', 'lula', 'peixe', 'marisco'],
    'latic√≠nios': ['leite', 'queijo', 'iogurte', 'manteiga', 'nata', 'mozzarella', 'requeij√£o', 'mozarela'],
    'padaria': ['p√£o'],
    'pastelaria': ['farinha', 'fermento', 'chocolate', 'cacau', 'baunilha', 'am√™ndoa', 'noz'],
    'compotas': ['a√ß√∫car', 'pectina', '√°cido c√≠trico'],
    'bebidas': ['√°gua', 'sumo', 'refrigerante', 'vinho', 'cerveja', 'caf√©', 'ch√°'],
    'temperos': ['sal', 'pimenta', 'azeite', 'vinagre', 'oreg√£os', 'especiaria', 'canela', 'colorau']
  };
  
  const getCategoria = (ingrediente) => {
    return ingrediente.categoria || 'outros';
  };
  
  // Build price comparison data
  const comprasPorIngrediente = React.useMemo(() => {
    const result = {};
    todasCompras.forEach(compra => {
      const ing = ingredientes.find(i => i.id == compra.ingredienteId);
      if (!ing) return;
      
      if (!result[compra.ingredienteId]) {
        result[compra.ingredienteId] = {
          nome: ing.nome,
          unidade: ing.unidade,
          categoria: getCategoria(ing),
          compras: []
        };
      }
      
      result[compra.ingredienteId].compras.push({
        fornecedor: compra.fornecedor,
        precoUnitario: compra.precoUnitario,
        data: compra.data,
        quantidade: compra.quantidade
      });
    });
    return result;
  }, [todasCompras, ingredientes]);
  
  // Filter ingredients
  const ingredientesFiltrados = React.useMemo(() => {
    let filtered = Object.values(comprasPorIngrediente).filter(ing => ing.compras.length > 0);
    
    if (categoriaCompra !== 'all') {
      filtered = filtered.filter(ing => ing.categoria === categoriaCompra);
    }
    
    if (searchCompra) {
      filtered = filtered.filter(ing => 
        normalizeText(ing.nome).includes(normalizeText(searchCompra))
      );
    }
    
    return filtered.slice(0, 50);
  }, [comprasPorIngrediente, categoriaCompra, searchCompra]);
  
  // Count by category
  const countByCategoria = React.useMemo(() => {
    const counts = {};
    Object.values(comprasPorIngrediente).forEach(ing => {
      counts[ing.categoria] = (counts[ing.categoria] || 0) + 1;
    });
    return counts;
  }, [comprasPorIngrediente]);
  
  const allCount = Object.values(comprasPorIngrediente).filter(ing => ing.compras.length > 0).length;
  
  return (
    <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
      <h2 className="text-base font-bold mb-3">üìä An√°lise de Compras</h2>
      
      {/* Summary Cards */}
<div className="grid grid-cols-3 gap-2 mb-3">
        <div className="bg-blue-50 rounded p-3 border border-blue-200">
          <p className="text-xs text-blue-700 mb-1">Total Compras</p>
          <p className="text-xl font-bold text-blue-900">
            ‚Ç¨{todasCompras.reduce((sum, c) => sum + (c.precoUnitario * c.quantidade), 0).toFixed(2)}
          </p>
        </div>
        <div className="bg-green-50 rounded p-3 border border-green-200">
          <p className="text-xs text-green-700 mb-1">N¬∫ Fornecedores</p>
          <p className="text-xl font-bold text-green-900">{(fornecedores || []).length}</p>
        </div>
        <div className="bg-purple-50 rounded p-3 border border-purple-200">
          <p className="text-xs text-purple-700 mb-1">Ingredientes</p>
          <p className="text-xl font-bold text-purple-900">{(ingredientes || []).length}</p>
        </div>
      </div>

      {/* Price Comparison */}
      <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded border border-blue-200 p-3">
        <h3 className="text-sm font-bold mb-3 text-blue-900">üí∞ Compara√ß√£o de Pre√ßos</h3>
        
        {/* Category Tabs */}
        <div className="flex gap-1 mb-3 overflow-x-auto bg-white p-1 rounded">
          {[
            {id: 'all', emoji: 'üì¶', label: 'Todos', count: allCount},
            {id: 'vegetais', emoji: 'ü•¨', label: 'Vegetais', count: countByCategoria['vegetais'] || 0},
            {id: 'carnes', emoji: 'ü•©', label: 'Carnes', count: countByCategoria['carnes'] || 0},
            {id: 'peixe', emoji: 'üêü', label: 'Peixe', count: countByCategoria['peixe'] || 0},
            {id: 'latic√≠nios', emoji: 'üßÄ', label: 'Latic√≠nios', count: countByCategoria['latic√≠nios'] || 0},
            {id: 'padaria', emoji: 'ü•ñ', label: 'Padaria', count: countByCategoria['padaria'] || 0},
            {id: 'pastelaria', emoji: 'üç∞', label: 'Pastelaria', count: countByCategoria['pastelaria'] || 0},
            {id: 'compotas', emoji: 'üçØ', label: 'Compotas', count: countByCategoria['compotas'] || 0},
            {id: 'bebidas', emoji: 'ü•§', label: 'Bebidas', count: countByCategoria['bebidas'] || 0},
            {id: 'temperos', emoji: 'üßÇ', label: 'Temperos', count: countByCategoria['temperos'] || 0},
            {id: 'embalagens', emoji: 'üì¶', label: 'Embalagens', count: countByCategoria['embalagens'] || 0},
            {id: 'limpeza', emoji: 'üßπ', label: 'Limpeza', count: countByCategoria['limpeza'] || 0},
            {id: 'outros', emoji: 'üìã', label: 'Outros', count: countByCategoria['outros'] || 0}
          ].map(cat => (
            <button
              key={cat.id}
              onClick={() => setCategoriaCompra(cat.id)}
              className={`px-3 py-1.5 rounded text-xs font-semibold whitespace-nowrap transition-colors ${
                categoriaCompra === cat.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {cat.emoji} {cat.label} ({cat.count})
            </button>
          ))}
        </div>
        
        {/* Search Bar */}
        <div className="mb-3">
          <input
            type="text"
            placeholder="üîç Procurar ingrediente..."
            value={searchCompra}
            onChange={(e) => setSearchCompra(e.target.value)}
            className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
          />
        </div>
        
        {/* Results */}
        {ingredientesFiltrados.length === 0 ? (
          <div className="text-center py-8 bg-white rounded border">
            <p className="text-sm text-gray-600">
              {searchCompra ? `Nenhum ingrediente encontrado com "${searchCompra}"` : 'Nenhum ingrediente nesta categoria'}
            </p>
          </div>
        ) : (
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {ingredientesFiltrados.map(ing => {
              const precoMedio = ing.compras.reduce((s, c) => s + c.precoUnitario, 0) / ing.compras.length;
              const precoMin = Math.min(...ing.compras.map(c => c.precoUnitario));
              const precoMax = Math.max(...ing.compras.map(c => c.precoUnitario));
              const melhorCompra = ing.compras.reduce((best, curr) => 
                curr.precoUnitario < best.precoUnitario ? curr : best
              );
              
              const isExpanded = expandedIngrediente === ing.nome;
              
              return (
                <div key={ing.nome} className="bg-white rounded border hover:shadow-md transition-shadow">
                  {/* HEADER - Sempre vis√≠vel e clic√°vel */}
                  <div 
                    onClick={() => setExpandedIngrediente(isExpanded ? null : ing.nome)}
                    className="p-2 cursor-pointer hover:bg-gray-50 transition-colors"
                  >
                    <div className="flex justify-between items-start mb-1">
                      <div className="flex items-center gap-2">
                        <span className="text-gray-500">
                          {isExpanded ? '‚ñº' : '‚ñ∂'}
                        </span>
                        <span className="font-bold text-sm text-gray-800">{ing.nome}</span>
                      </div>
                      <div className="text-right">
                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded block">
                          {ing.compras.length} compra{ing.compras.length > 1 ? 's' : ''}
                        </span>
                        {(() => {
                          // Calculate monthly average
                          if (ing.compras.length === 0) return null;
                          
                          const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                          const firstDate = new Date(sortedCompras[0].data);
                          const lastDate = new Date(sortedCompras[sortedCompras.length - 1].data);
                          
                          // Calculate months between first and last purchase
                          const monthsDiff = (lastDate.getFullYear() - firstDate.getFullYear()) * 12 + 
                                            (lastDate.getMonth() - firstDate.getMonth()) + 1; // +1 to include both months
                          
                          const comprasPorMes = ing.compras.length / monthsDiff;
                          const qtdTotal = ing.compras.reduce((sum, c) => sum + c.quantidade, 0);
                          const qtdPorMes = qtdTotal / monthsDiff;
                          const gastoTotal = ing.compras.reduce((sum, c) => sum + (c.precoUnitario * c.quantidade), 0);
                          const gastoPorMes = gastoTotal / monthsDiff;
                          
                          return (
                            <div className="mt-1 text-[10px] text-gray-600 space-y-0.5">
                              <div className="bg-purple-50 px-1.5 py-0.5 rounded">
                                üìä {comprasPorMes.toFixed(1)}x/m√™s
                              </div>
                              <div className="bg-green-50 px-1.5 py-0.5 rounded">
                                üì¶ {qtdPorMes.toFixed(1)}{ing.unidade}/m√™s
                              </div>
                              <div className="bg-orange-50 px-1.5 py-0.5 rounded">
                                üí∞ ‚Ç¨{gastoPorMes.toFixed(2)}/m√™s
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-xs">
                      <div>
                        <span className="text-gray-600">M√©dio:</span>
                        <span className="font-semibold ml-1">‚Ç¨{precoMedio.toFixed(2)}/{ing.unidade}</span>
                      </div>
                      <div>
                        <span className="text-green-600">Min:</span>
                        <span className="font-semibold ml-1 text-green-700">‚Ç¨{precoMin.toFixed(2)}</span>
                      </div>
                      <div>
                        <span className="text-red-600">Max:</span>
                        <span className="font-semibold ml-1 text-red-700">‚Ç¨{precoMax.toFixed(2)}</span>
                      </div>
                    </div>
                    {melhorCompra.fornecedor && (
                      <p className="text-xs text-gray-600 mt-1">
                        üí° Melhor: <span className="font-semibold">{melhorCompra.fornecedor}</span> - ‚Ç¨{melhorCompra.precoUnitario.toFixed(2)}/{ing.unidade}
                      </p>
                    )}
                  </div>
                  
                  {/* CONTE√öDO EXPAND√çVEL - S√≥ vis√≠vel quando expandido */}
                  {isExpanded && (
                    <div className="px-2 pb-2 pt-2 border-t border-gray-200 bg-gray-50">
                  
                  {/* Hist√≥rico de Compras - √öltimas 3 */}
                  {ing.compras.length > 1 && (
                    <div className="mb-3 bg-gray-50 rounded p-2">
                      <p className="text-xs font-semibold text-gray-700 mb-1">üìÖ √öltimas Compras:</p>
                      <div className="space-y-0.5">
                        {ing.compras
                          .sort((a, b) => new Date(b.data) - new Date(a.data))
                          .slice(0, 3) // S√≥ mostrar as 3 mais recentes
                          .map((compra, idx) => {
                            const isMelhor = compra.precoUnitario === precoMin;
                            return (
                              <div key={idx} className={`text-xs flex justify-between items-center ${isMelhor ? 'font-semibold text-green-700' : 'text-gray-600'}`}>
                                <span>
                                  {new Date(compra.data).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' })} 
                                  {' ‚Ä¢ '}
                                  {compra.fornecedor}
                                </span>
                                <span>
                                  ‚Ç¨{compra.precoUnitario.toFixed(2)}/{ing.unidade}
                                  {isMelhor && ' ‚≠ê'}
                                </span>
                              </div>
                            );
                          })}
                      </div>
                    </div>
                  )}
                  
                  {/* Price Evolution Chart */}
                  {ing.compras.length > 2 && (
                    <div className="mt-2 bg-blue-50 rounded p-2 border border-blue-200">
                      <p className="text-xs font-semibold text-blue-900 mb-2">üìà Evolu√ß√£o de Pre√ßos</p>
                      <div className="relative h-40 bg-white rounded p-3">
                        {(() => {
                          const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                          const precos = sortedCompras.map(c => c.precoUnitario);
                          const minPreco = Math.min(...precos);
                          const maxPreco = Math.max(...precos);
                          const range = maxPreco - minPreco || 1;
                          
                          return (
                            <>
                              {/* Grid lines with labels */}
                              <div className="absolute inset-0 p-2 pointer-events-none">
                                {[0, 0.25, 0.5, 0.75, 1].map((percent, idx) => {
                                  const price = minPreco + (maxPreco - minPreco) * (1 - percent);
                                  const yPos = `${percent * 100}%`;
                                  return (
                                    <div key={idx} className="absolute w-full" style={{top: yPos}}>
                                      <div className={`border-t ${idx === 0 || idx === 4 ? 'border-gray-400' : 'border-gray-200'} border-dashed`}></div>
                                      <span className="absolute left-0 -top-2 text-[9px] font-semibold text-gray-700 bg-white/90 px-1">
                                        ‚Ç¨{price.toFixed(2)}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {/* Price line */}
                              <svg className="absolute inset-0 w-full h-full p-2" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                                <polyline
                                  points={sortedCompras.map((c, i) => {
                                    const x = (i / (sortedCompras.length - 1)) * 100;
                                    const y = 100 - ((c.precoUnitario - minPreco) / range) * 80;
                                    return `${x},${y}`;
                                  }).join(' ')}
                                  fill="none"
                                  stroke="#3b82f6"
                                  strokeWidth="0.8"
                                  vectorEffect="non-scaling-stroke"
                                />
                                {/* Points */}
                                {sortedCompras.map((c, i) => {
                                  const x = (i / (sortedCompras.length - 1)) * 100;
                                  const y = 100 - ((c.precoUnitario - minPreco) / range) * 80;
                                  const isMelhor = c.precoUnitario === minPreco;
                                  
                                  // Determine color based on price change
                                  let priceColor = '#6b7280'; // gray for first point
                                  if (i > 0) {
                                    const prevPrice = sortedCompras[i - 1].precoUnitario;
                                    if (c.precoUnitario < prevPrice) {
                                      priceColor = '#10b981'; // GREEN (desceu)
                                    } else if (c.precoUnitario > prevPrice) {
                                      priceColor = '#ef4444'; // RED (subiu)
                                    } else {
                                      priceColor = '#6b7280'; // GRAY (igual)
                                    }
                                  }
                                  
                                  return (
                                    <g key={i}>
                                      <circle
                                        cx={x}
                                        cy={y}
                                        r="2"
                                        fill={isMelhor ? '#10b981' : '#3b82f6'}
                                        stroke="white"
                                        strokeWidth="0.3"
                                      />
                                      {/* Price label */}
                                      <text
                                        x={x}
                                        y={y + 6}
                                        fontSize="6"
                                        fontWeight="800"
                                        fill={priceColor}
                                        stroke="white"
                                        strokeWidth="0.4"
                                        textAnchor="middle"
                                        className="pointer-events-none"
                                      >
                                        ‚Ç¨{c.precoUnitario.toFixed(2)}
                                      </text>
                                      {/* Date label */}
                                      <text
                                        x={x}
                                        y={y + 13}
                                        fontSize="4"
                                        fontWeight="700"
                                        fill="#6b7280"
                                        textAnchor="middle"
                                        className="pointer-events-none"
                                      >
                                        {new Date(c.data).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' })}
                                      </text>
                                    </g>
                                  );
                                })}
                              </svg>
                              

                              {/* Date labels - Smart spacing */}
                              <div className="absolute bottom-0 left-0 right-0 flex justify-between px-2 text-[9px] font-semibold text-blue-700">
                                {(() => {
                                  // Show 4-6 date markers evenly spaced
                                  const numLabels = Math.min(6, sortedCompras.length);
                                  const step = Math.max(1, Math.floor(sortedCompras.length / (numLabels - 1)));
                                  const labels = [];
                                  
                                  for (let i = 0; i < sortedCompras.length; i += step) {
                                    if (labels.length >= numLabels - 1) break;
                                    labels.push(i);
                                  }
                                  // Always include last
                                  if (labels[labels.length - 1] !== sortedCompras.length - 1) {
                                    labels.push(sortedCompras.length - 1);
                                  }
                                  
                                  return labels.map((idx, i) => (
                                    <span key={i} className="bg-blue-50/90 px-1 py-0.5 rounded">
                                      {new Date(sortedCompras[idx].data).toLocaleDateString('pt-PT', { day: 'numeric', month: 'short' })}
                                    </span>
                                  ));
                                })()}
                              </div>
                            </>
                          );
                        })()}
                      </div>
                      
                      {/* Trend indicator */}
                      {(() => {
                        const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                        const primeiroPreco = sortedCompras[0].precoUnitario;
                        const ultimoPreco = sortedCompras[sortedCompras.length - 1].precoUnitario;
                        const variacao = ((ultimoPreco - primeiroPreco) / primeiroPreco) * 100;
                        const isSubiu = variacao > 0;
                        
                        return (
                          <div className={`mt-1 text-xs flex items-center gap-1 ${isSubiu ? 'text-red-600' : variacao < 0 ? 'text-green-600' : 'text-gray-600'}`}>
                            {isSubiu ? 'üìà' : variacao < 0 ? 'üìâ' : '‚û°Ô∏è'}
                            <span className="font-semibold">
                              {isSubiu ? '+' : ''}{variacao.toFixed(1)}%
                            </span>
                            <span>desde {new Date(sortedCompras[0].data).toLocaleDateString('pt-PT', { month: 'short' })}</span>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                  
                  {/* Price Alerts */}
                  {ing.compras.length > 1 && (() => {
                    const sortedCompras = [...ing.compras].sort((a, b) => new Date(a.data) - new Date(b.data));
                    const precos = sortedCompras.map(c => c.precoUnitario);
                    const minPreco = Math.min(...precos);
                    const maxPreco = Math.max(...precos);
                    const variacao = ((maxPreco - minPreco) / minPreco) * 100;
                    
                    // Check last 30 days
                    const hoje = new Date();
                    const trinta_dias = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
                    const comprasRecentes = sortedCompras.filter(c => new Date(c.data) >= trinta_dias);
                    
                    // Trend in last month
                    let trendAlert = null;
                    if (comprasRecentes.length >= 2) {
                      const primeiraRecente = comprasRecentes[0].precoUnitario;
                      const ultimaRecente = comprasRecentes[comprasRecentes.length - 1].precoUnitario;
                      const variacaoMes = ((ultimaRecente - primeiraRecente) / primeiraRecente) * 100;
                      
                      if (variacaoMes > 5) {
                        trendAlert = { type: 'warning', message: `Pre√ßo subiu ${variacaoMes.toFixed(1)}% este m√™s`, icon: '‚ö†Ô∏è' };
                      } else if (variacaoMes < -5) {
                        trendAlert = { type: 'success', message: `Pre√ßo desceu ${Math.abs(variacaoMes).toFixed(1)}% este m√™s`, icon: '‚úÖ' };
                      }
                    }
                    
                    // Best price recently
                    const melhorCompraRecente = sortedCompras.find(c => c.precoUnitario === minPreco);
                    const diasDesdeRecorde = melhorCompraRecente ? Math.floor((hoje - new Date(melhorCompraRecente.data)) / (24 * 60 * 60 * 1000)) : 999;
                    const recordeRecente = diasDesdeRecorde <= 30;
                    
                    // High variation alert
                    const altaVariacao = variacao > 10;
                    
                    const alerts = [];
                    if (trendAlert) alerts.push(trendAlert);
                    if (recordeRecente) alerts.push({ 
                      type: 'info', 
                      message: `Melhor pre√ßo nos √∫ltimos 30 dias (${melhorCompraRecente.fornecedor})`,
                      icon: 'üéØ'
                    });
                    if (altaVariacao) alerts.push({
                      type: 'warning',
                      message: `Varia√ß√£o de ${variacao.toFixed(1)}% entre fornecedores`,
                      icon: 'üìä'
                    });
                    
                    return alerts.length > 0 ? (
                      <div className="mt-2 space-y-1">
                        {alerts.map((alert, idx) => (
                          <div 
                            key={idx}
                            className={`text-xs px-2 py-1 rounded flex items-start gap-1 ${
                              alert.type === 'warning' ? 'bg-orange-50 text-orange-800 border border-orange-200' :
                              alert.type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
                              'bg-blue-50 text-blue-800 border border-blue-200'
                            }`}
                          >
                            <span>{alert.icon}</span>
                            <span className="flex-1">{alert.message}</span>
                          </div>
                        ))}
                      </div>
                    ) : null;
                  })()}
                    </div>
                  )}
                </div>
              );
            })}
            {ingredientesFiltrados.length === 50 && (
              <p className="text-xs text-center text-gray-500 py-2">
                A mostrar 50 ingredientes. Refine a pesquisa para ver mais resultados espec√≠ficos.
              </p>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// ==================== GITHUB BACKUP PANEL COMPONENT ====================
const GitHubBackupPanel = ({ onSync }) => {
  const [token, setToken] = React.useState('');
  const [showToken, setShowToken] = React.useState(false);
  const [showConfig, setShowConfig] = React.useState(false);
  const [isSyncing, setIsSyncing] = React.useState(false);
  const [passwordInput, setPasswordInput] = React.useState('');
  const [showSavedToken, setShowSavedToken] = React.useState(false);
  
  const isConfigured = GitHubSync.isConfigured();
  const gistUrl = GitHubSync.getGistUrl();
  const lastSync = GitHubSync.getLastSync();
  const autoSyncEnabled = GitHubSync.getAutoSyncEnabled();

  const saveToken = () => {
    if (token.trim()) {
      GitHubSync.setToken(token.trim());
      setShowConfig(false);
      setToken('');
      alert('‚úÖ Token guardado! A sincronizar dados...');
      handleSync();
    }
  };

  const clearConfig = () => {
    if (confirm('‚ö†Ô∏è Tem a certeza que quer desconectar o GitHub?\\n\\nOs dados locais N√ÉO ser√£o apagados, mas o backup autom√°tico ser√° desativado.')) {
      GitHubSync.clearConfig();
      setShowConfig(false);
      alert('‚úÖ GitHub desconectado');
    }
  };

  const handleSync = async () => {
    setIsSyncing(true);
    try {
      await onSync();
    } finally {
      setIsSyncing(false);
    }
  };

  const getTimeSince = (dateString) => {
    if (!dateString) return 'Nunca';
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'Agora mesmo';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `H√° ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `H√° ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
    const days = Math.floor(hours / 24);
    return `H√° ${days} ${days === 1 ? 'dia' : 'dias'}`;
  };
  
  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Cloud className="w-6 h-6 text-blue-600" />
          <div>
            <h3 className="font-bold text-blue-900">Backup Cloud (GitHub)</h3>
            {isConfigured && !showConfig && (
              <p className="text-xs text-blue-700">Auto-sync: {autoSyncEnabled ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado'}</p>
            )}
          </div>
        </div>
        <button
          onClick={() => setShowConfig(!showConfig)}
          className="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded transition"
          title="Configura√ß√µes"
        >
          <Settings className="w-5 h-5" />
        </button>
      </div>
      
      {showConfig ? (
        <div className="space-y-3 bg-white rounded-lg p-4 border border-blue-300">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üîë GitHub Personal Access Token
            </label>
            <div className="relative">
              <input
                type={showToken ? "text" : "password"}
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                className="w-full px-3 py-2 pr-20 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={() => setShowToken(!showToken)}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-semibold"
              >
                {showToken ? 'Ocultar' : 'Mostrar'}
              </button>
            </div>
            
            <div className="mt-2 space-y-1 text-xs text-gray-600">
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">1.</span>
                <span>Crie token em: <a href="https://github.com/settings/tokens/new?scopes=gist&description=Munchi%20Manager%20Backup" target="_blank" className="text-blue-600 underline font-semibold hover:text-blue-800">github.com/settings/tokens</a></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">2.</span>
                <span>Marque apenas: <strong className="text-green-700">‚úì gist</strong></span>
              </p>
              <p className="flex items-start gap-1">
                <span className="text-blue-600 font-bold">3.</span>
                <span>Cole aqui e clique em "Guardar"</span>
              </p>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={saveToken}
              disabled={!token.trim()}
              className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-semibold transition"
            >
              üíæ Guardar Token
            </button>
            {isConfigured && (
              <button
                onClick={clearConfig}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold transition"
              >
                üîå Desconectar
              </button>
            )}
          </div>
          
          <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-900">
            <p className="font-semibold mb-1 flex items-center gap-1">
              üîí Seguran√ßa & Privacidade
            </p>
            <ul className="space-y-1 ml-4 text-yellow-800">
              <li>‚Ä¢ Token guardado <strong>localmente</strong> no seu browser</li>
              <li>‚Ä¢ Nunca partilhado com servidores externos</li>
              <li>‚Ä¢ Gist criado como <strong>privado</strong> (s√≥ voc√™ v√™)</li>
              <li>‚Ä¢ Pode revogar token a qualquer momento</li>
            </ul>
          </div>
        </div>
      ) : (
        <>
          {!isConfigured ? (
            <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              <p className="text-sm text-yellow-800 flex items-center gap-2">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <span>Configure o GitHub para ativar backup autom√°tico na cloud</span>
              </p>
              <button
                onClick={() => setShowConfig(true)}
                className="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-semibold transition text-sm"
              >
                ‚öôÔ∏è Configurar Agora
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="bg-white rounded-lg p-3 border-2 border-green-300 shadow-sm">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <CloudCheck className="w-5 h-5 text-green-600" />
                    <div>
                      <p className="text-sm font-semibold text-green-900">Conectado ‚úì</p>
                      <p className="text-xs text-green-700">√öltimo backup: {getTimeSince(lastSync)}</p>
                    </div>
                  </div>
                  <button
                    onClick={handleSync}
                    disabled={isSyncing}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded font-semibold transition flex items-center gap-2 text-sm"
                    title="Sincronizar agora"
                  >
                    <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
                    {isSyncing ? 'A sincronizar...' : 'Sync'}
                  </button>
                </div>
                
                {gistUrl && (
                  <a
                    href={gistUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center gap-1"
                  >
                    üîó Ver backup no GitHub
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
              
              {/* Ver Token Protegido por Password */}
              <div className="bg-white rounded-lg p-3 border border-gray-300">
                <div className="space-y-2">
                  <p className="text-sm font-semibold text-gray-900 flex items-center gap-2">
                    üîê Ver Token
                    <span className="text-xs font-normal text-gray-500">(para copiar noutro dispositivo)</span>
                  </p>
                  
                  {!showSavedToken ? (
                    <div className="space-y-2">
                      <div className="flex gap-2">
                        <input
                          type="password"
                          value={passwordInput}
                          onChange={(e) => setPasswordInput(e.target.value)}
                          placeholder="Password de prote√ß√£o"
                          className="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              const savedPwd = localStorage.getItem('munchi_token_password');
                              
                              if (!savedPwd) {
                                // Primeira vez - define a password
                                localStorage.setItem('munchi_token_password', passwordInput);
                                setShowSavedToken(true);
                                setPasswordInput('');
                                alert('‚úÖ Password definida! Use esta password para ver o token no futuro.');
                              } else if (passwordInput === savedPwd) {
                                // Password correta
                                setShowSavedToken(true);
                                setPasswordInput('');
                              } else {
                                // Password errada
                                alert('‚ùå Password incorreta!');
                                setPasswordInput('');
                              }
                            }
                          }}
                        />
                        <button
                          onClick={() => {
                            const savedPwd = localStorage.getItem('munchi_token_password');
                            
                            if (!savedPwd) {
                              localStorage.setItem('munchi_token_password', passwordInput);
                              setShowSavedToken(true);
                              setPasswordInput('');
                              alert('‚úÖ Password definida! Use esta password para ver o token no futuro.');
                            } else if (passwordInput === savedPwd) {
                              setShowSavedToken(true);
                              setPasswordInput('');
                            } else {
                              alert('‚ùå Password incorreta!');
                              setPasswordInput('');
                            }
                          }}
                          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold transition text-sm whitespace-nowrap"
                        >
                          üëÅÔ∏è Ver
                        </button>
                      </div>
                      <p className="text-xs text-gray-500">
                        {localStorage.getItem('munchi_token_password') 
                          ? 'üí° Introduce a tua password para ver o token' 
                          : 'üí° Define uma password para proteger o acesso ao token'}
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="relative">
                        <input
                          type="text"
                          value={GitHubSync.getToken()}
                          readOnly
                          className="w-full px-3 py-2 pr-24 border border-gray-300 rounded text-xs bg-gray-50 font-mono"
                        />
                        <button
                          onClick={() => {
                            navigator.clipboard.writeText(GitHubSync.getToken());
                            alert('‚úÖ Token copiado para a √°rea de transfer√™ncia!');
                          }}
                          className="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold"
                        >
                          üìã Copiar
                        </button>
                      </div>
                      <button
                        onClick={() => {
                          setShowSavedToken(false);
                          setPasswordInput('');
                        }}
                        className="text-xs text-blue-600 hover:text-blue-800 font-semibold"
                      >
                        üîí Ocultar
                      </button>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="bg-white rounded-lg p-3 border border-gray-300">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-semibold text-gray-900">Sincroniza√ß√£o Autom√°tica</p>
                    <p className="text-xs text-gray-600">Backup a cada 5 minutos</p>
                  </div>
                  <button
                    onClick={() => {
                      GitHubSync.setAutoSyncEnabled(!autoSyncEnabled);
                      window.location.reload();
                    }}
                    className={`w-12 h-6 rounded-full transition ${autoSyncEnabled ? 'bg-green-500' : 'bg-gray-300'} relative`}
                  >
                    <div className={`w-5 h-5 rounded-full bg-white absolute top-0.5 transition-all ${autoSyncEnabled ? 'left-6' : 'left-0.5'}`}></div>
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

// Tooltip Component
const Tooltip = ({ children, text, position = 'top' }) => {
  const [show, setShow] = React.useState(false);
  
  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2'
  };
  
  return (
    <div className="relative inline-block">
      <div
        onMouseEnter={() => setShow(true)}
        onMouseLeave={() => setShow(false)}
        className="cursor-help"
      >
        {children}
      </div>
      {show && (
        <div className={`absolute ${positionClasses[position]} z-50 w-64 pointer-events-none`}>
          <div className="bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg">
            {text}
            <div className={`absolute w-2 h-2 bg-gray-900 transform rotate-45 ${
              position === 'top' ? 'bottom-[-4px] left-1/2 -translate-x-1/2' :
              position === 'bottom' ? 'top-[-4px] left-1/2 -translate-x-1/2' :
              position === 'left' ? 'right-[-4px] top-1/2 -translate-y-1/2' :
              'left-[-4px] top-1/2 -translate-y-1/2'
            }`}></div>
          </div>
        </div>
      )}
    </div>
  );
};

// ===== MODAL CONFIRMA√á√ÉO OCR =====
const ModalConfirmacaoOCR = ({ linhas, ingredientes, metadata, onConfirmar, onCancelar, fornecedores, showNotification, setFornecedores }) => {
  const [linhasEditadas, setLinhasEditadas] = useState(linhas);
  const [stats, setStats] = useState(null);
  const [ingredientesLocais, setIngredientesLocais] = useState(ingredientes); // Lista local que pode crescer
  const [mostrarModalCriarIng, setMostrarModalCriarIng] = useState(false);
  const [novoIngrediente, setNovoIngrediente] = useState({
    nome: '',
    categoria: 'outros',
    unidade: 'kg',
    custo: '',
    iva: '13'
  });
  const [linhaIndexCriando, setLinhaIndexCriando] = useState(null);
  
  // üßπ States para modal de limpeza de palavras
  const [mostrarModalLimparPalavras, setMostrarModalLimparPalavras] = useState(false);
  const [linhaParaLimpar, setLinhaParaLimpar] = useState(null);
  const [palavrasSelecionadas, setPalavrasSelecionadas] = useState([]);
  const [sempreRemover, setSempreRemover] = useState(true);
  
  // States para search de ingredientes
  const [searchIngredienteOCR, setSearchIngredienteOCR] = useState(() => {
    // ‚úÖ INICIALIZAR com nomes dos ingredientes auto-preenchidos OU sugeridos com alta confian√ßa
    const initial = {};
    console.log('üîç INICIALIZANDO searchIngredienteOCR com', linhas.length, 'linhas');
    linhas.forEach((linha, index) => {
      // ‚úÖ CRIAR ID √öNICO para cada linha baseado no conte√∫do
      const linhaId = `${linha.nomeProduto}_${index}`;
      linha._id = linhaId; // Adicionar ID √† linha
      
      console.log(`Linha ${index}:`, {
        _id: linhaId,
        nomeProduto: linha.nomeProduto,
        ingredienteConfirmado: linha.ingredienteConfirmado,
        ingredienteSugerido: linha.ingredienteSugerido,
        confiancaSugestao: linha.confiancaSugestao
      });
      
      // Prioridade 1: ingrediente j√° confirmado
      if (linha.ingredienteConfirmado) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteConfirmado);
        if (ing) {
          initial[linhaId] = ing.nome;
          console.log(`  ‚úÖ Confirmado: ${ing.nome}`);
        }
      } 
      // Prioridade 2: sugest√£o com confian√ßa >= 80% (auto-insert)
      else if (linha.ingredienteSugerido && linha.confiancaSugestao >= 80) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteSugerido.id);
        if (ing) {
          initial[linhaId] = ing.nome;
          console.log(`  ‚úÖ Auto-insert (${linha.confiancaSugestao}%): ${ing.nome}`);
        } else {
          console.log(`  ‚ùå Ingrediente n√£o encontrado:`, linha.ingredienteSugerido);
        }
      }
    });
    console.log('üìã Initial search:', initial);
    return initial;
  });
  const [showDropdownOCR, setShowDropdownOCR] = useState({});
  
  // üÜï Atualizar search quando linhas mudarem (especialmente com auto-insert)
  useEffect(() => {
    const novoSearch = { ...searchIngredienteOCR };
    let houveMudancas = false;
    
    linhasEditadas.forEach((linha, index) => {
      // ‚úÖ Garantir que a linha tem ID
      if (!linha._id) {
        linha._id = `${linha.nomeProduto}_${index}`;
      }
      const linhaId = linha._id;
      
      // Se j√° tem valor no search, n√£o mexer
      if (searchIngredienteOCR[linhaId]) return;
      
      // Se tem ingrediente confirmado
      if (linha.ingredienteConfirmado) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteConfirmado);
        if (ing && !searchIngredienteOCR[linhaId]) {
          novoSearch[linhaId] = ing.nome;
          houveMudancas = true;
        }
      }
      // Se tem sugest√£o com alta confian√ßa (>= 80%)
      else if (linha.ingredienteSugerido && linha.confiancaSugestao >= 80) {
        const ing = ingredientes.find(i => i.id === linha.ingredienteSugerido.id);
        if (ing && !searchIngredienteOCR[linhaId]) {
          novoSearch[linhaId] = ing.nome;
          houveMudancas = true;
        }
      }
    });
    
    if (houveMudancas) {
      setSearchIngredienteOCR(novoSearch);
    }
  }, [linhasEditadas]); // Reagir quando linhas mudarem
  
  // üÜï Auto-preencher ingredienteConfirmado quando h√° sugest√£o com alta confian√ßa
  useEffect(() => {
    const novasLinhas = linhasEditadas.map(linha => {
      // Se j√° tem ingrediente confirmado, n√£o alterar
      if (linha.ingredienteConfirmado) return linha;
      
      // Se tem sugest√£o com confian√ßa >= 80%, auto-preencher
      if (linha.ingredienteSugerido && linha.confiancaSugestao >= 80) {
        return {
          ...linha,
          ingredienteConfirmado: linha.ingredienteSugerido.id
        };
      }
      
      return linha;
    });
    
    // S√≥ atualizar se houve mudan√ßas
    const houveMudancas = novasLinhas.some((linha, idx) => 
      linha.ingredienteConfirmado !== linhasEditadas[idx].ingredienteConfirmado
    );
    
    if (houveMudancas) {
      setLinhasEditadas(novasLinhas);
    }
  }, []); // Executar apenas uma vez ao montar o componente
  
  // States para documento
  const [numeroFaturaManual, setNumeroFaturaManual] = useState(metadata?.numeroFatura || '');
  const [fornecedorManual, setFornecedorManual] = useState('');
  const [fornecedoresLocais, setFornecedoresLocais] = useState(fornecedores); // Lista local
  const [mostrarModalNovoFornecedor, setMostrarModalNovoFornecedor] = useState(false);
  const [novoFornecedor, setNovoFornecedor] = useState({
    nome: '',
    nif: metadata?.nif || '',
    contacto: '',
    email: ''
  });

  // üîß Fun√ß√£o helper para criar fornecedor (com acesso √†s props)
  const criarNovoFornecedor = () => {
    if (!novoFornecedor.nome.trim()) {
      alert('Nome √© obrigat√≥rio!');
      return;
    }
    
    // Criar fornecedor com ID permanente
    const novoFornTemp = {
      id: Date.now(),
      nome: novoFornecedor.nome.trim(),
      nif: novoFornecedor.nif.trim(),
      telefone: novoFornecedor.contacto.trim(),
      email: novoFornecedor.email.trim(),
      morada: '',
      dataCriacao: new Date().toISOString()
    };
    
    // ‚úÖ ADICIONAR IMEDIATAMENTE AO ESTADO GLOBAL (guardado permanentemente)
    if (setFornecedores && typeof setFornecedores === 'function') {
      setFornecedores([...fornecedores, novoFornTemp]);
    }
    
    // Adicionar √† lista LOCAL (aparece no dropdown imediatamente)
    setFornecedoresLocais([...fornecedoresLocais, novoFornTemp]);
    
    // Adicionar ao metadata para ser processado depois (fallback)
    if (!window._novosFornecedores) window._novosFornecedores = [];
    window._novosFornecedores.push(novoFornTemp);
    
    // Selecionar o fornecedor rec√©m-criado
    setFornecedorManual(novoFornTemp.id);
    
    // Mostrar notifica√ß√£o de sucesso
    if (showNotification && typeof showNotification === 'function') {
      showNotification('‚úÖ Fornecedor criado com sucesso!', 'success');
    }
    
    // Fechar modal
    setMostrarModalNovoFornecedor(false);
    setNovoFornecedor({ nome: '', nif: metadata.nif || '', contacto: '', email: '' });
  };

  useEffect(() => {
    const calculateStats = (linhas) => {
      const total = linhas.length;
      const comSugestao = linhas.filter(l => l.ingredienteSugerido).length;
      const altaConfianca = linhas.filter(l => l.confiancaSugestao >= 80).length;
      const mediaConfianca = linhas.filter(l => l.confiancaSugestao >= 60 && l.confiancaSugestao < 80).length;
      return {
        total, comSugestao, altaConfianca, mediaConfianca,
        semSugestao: total - comSugestao,
        percentagemAuto: total > 0 ? Math.round((altaConfianca / total) * 100) : 0
      };
    };
    setStats(calculateStats(linhasEditadas));
  }, [linhasEditadas]);

  const handleIngredienteChange = (index, ingredienteId) => {
    const novas = [...linhasEditadas];
    novas[index].ingredienteConfirmado = ingredienteId;
    setLinhasEditadas(novas);
  };

  const handleQuantidadeChange = (index, quantidade) => {
    const novas = [...linhasEditadas];
    novas[index].quantidade = parseFloat(quantidade) || null;
    setLinhasEditadas(novas);
  };

  const handleUnidadeChange = (index, unidade) => {
    const novas = [...linhasEditadas];
    novas[index].unidade = unidade;
    setLinhasEditadas(novas);
  };

  const handlePrecoChange = (index, preco) => {
    const novas = [...linhasEditadas];
    novas[index].preco = parseFloat(preco) || null;
    setLinhasEditadas(novas);
  };

  const handleLimparPalavrasLinha = (index) => {
    const linha = linhasEditadas[index];
    
    // Buscar NIF: 1) metadata.nif, 2) fornecedor selecionado manualmente
    let nifFornecedor = metadata?.nif;
    
    if (!nifFornecedor && fornecedorManual) {
      const fornecedorObj = fornecedoresLocais.find(f => f.id === fornecedorManual);
      if (fornecedorObj && fornecedorObj.nif) {
        nifFornecedor = fornecedorObj.nif;
      }
    }
    
    if (!nifFornecedor) {
      alert('‚ö†Ô∏è NIF do fornecedor n√£o detectado. N√£o √© poss√≠vel adicionar palavras para limpar.');
      return;
    }
    
    // Abrir modal com a linha e NIF
    setLinhaParaLimpar({ ...linha, index, nifFornecedor });
    setPalavrasSelecionadas([]);
    setSempreRemover(true);
    setMostrarModalLimparPalavras(true);
  };
  
  const confirmarLimpezaPalavras = () => {
    if (!linhaParaLimpar || palavrasSelecionadas.length === 0) {
      alert('Selecione pelo menos uma palavra para limpar!');
      return;
    }
    
    // Se "sempre remover" est√° ativado, adicionar √† lista permanente
    if (sempreRemover && window._adicionarAPalavrasLimpar) {
      palavrasSelecionadas.forEach(palavra => {
        window._adicionarAPalavrasLimpar(linhaParaLimpar.nifFornecedor, palavra);
      });
    }
    
    // Remover a linha da lista
    setLinhasEditadas(linhasEditadas.filter((_, i) => i !== linhaParaLimpar.index));
    
    // Fechar modal
    setMostrarModalLimparPalavras(false);
    setLinhaParaLimpar(null);
    setPalavrasSelecionadas([]);
  };

  const handleRemoverLinha = (index) => {
    setLinhasEditadas(linhasEditadas.filter((_, i) => i !== index));
  };
  
  // üö´ Adicionar linha √† blacklist e remover
  const handleBlacklistLinha = (index) => {
    const linha = linhasEditadas[index];
    
    // Buscar NIF: 1) metadata.nif, 2) fornecedor selecionado manualmente
    let nifFornecedor = metadata?.nif;
    
    if (!nifFornecedor && fornecedorManual) {
      // Buscar NIF do fornecedor selecionado
      const fornecedorObj = fornecedoresLocais.find(f => f.id === fornecedorManual);
      if (fornecedorObj && fornecedorObj.nif) {
        nifFornecedor = fornecedorObj.nif;
      }
    }
    
    if (!nifFornecedor) {
      alert('‚ö†Ô∏è NIF do fornecedor n√£o detectado ou fornecedor n√£o tem NIF cadastrado. N√£o √© poss√≠vel adicionar √† blacklist.');
      return;
    }
    
    // Confirmar a√ß√£o
    if (confirm(`üö´ Adicionar √† blacklist permanente?\n\nLinha: "${linha.textoOriginal.substring(0, 60)}..."\n\nEsta linha nunca mais aparecer√° em faturas deste fornecedor (NIF: ${nifFornecedor}).`)) {
      // Adicionar √† blacklist (via window global para chamar fun√ß√£o do componente pai)
      if (window._adicionarABlacklist) {
        window._adicionarABlacklist(nifFornecedor, linha.textoOriginal);
      }
      
      // Remover da lista
      setLinhasEditadas(linhasEditadas.filter((_, i) => i !== index));
    }
  };

  const handleCriarIngrediente = () => {
    // Validar
    if (!novoIngrediente.nome || !novoIngrediente.custo) {
      alert('‚ùå Preencha nome e custo!');
      return;
    }
    
    // Criar
    const novoIng = {
      id: `ing_${Date.now()}`,
      nome: novoIngrediente.nome,
      categoria: novoIngrediente.categoria,
      unidade: novoIngrediente.unidade,
      custoUnitario: parseFloat(novoIngrediente.custo),
      precoUnitario: parseFloat(novoIngrediente.custo),
      iva: parseFloat(novoIngrediente.iva)
    };
    
    // Adicionar √† lista
    setIngredientesLocais([...ingredientesLocais, novoIng]);
    
    // Guardar globalmente
    if (!window._novosIngredientes) window._novosIngredientes = [];
    window._novosIngredientes.push(novoIng);
    
    // Selecionar automaticamente
    if (linhaIndexCriando !== null) {
      handleIngredienteChange(linhaIndexCriando, novoIng.id);
    }
    
    // Fechar modal
    setMostrarModalCriarIng(false);
    setNovoIngrediente({ nome: '', categoria: 'outros', unidade: 'kg', custo: '', iva: '13' });
  };

  const handleConfirmar = () => {
    const linhasSemIngrediente = linhasEditadas.filter(
      l => !l.ingredienteConfirmado && !l.ingredienteSugerido
    );
    if (linhasSemIngrediente.length > 0) {
      if (!confirm(`${linhasSemIngrediente.length} linha(s) sem ingrediente. Continuar?`)) return;
    }
    const linhasFinais = linhasEditadas.map(linha => ({
      ...linha,
      ingredienteConfirmado: linha.ingredienteConfirmado || linha.ingredienteSugerido?.id
    }));
    
    // Passar novos ingredientes criados no modal
    const novosIngs = window._novosIngredientes || [];
    
    // Adicionar dados do documento √† metadata
    const numeroFinal = numeroFaturaManual || metadata?.numeroFatura || null;
    
    // Adicionar "FT " se n√∫mero existe mas n√£o tem prefixo
    let numeroComPrefixo = numeroFinal;
    if (numeroFinal && !numeroFinal.toUpperCase().startsWith('FT')) {
      numeroComPrefixo = 'FT ' + numeroFinal;
    }
    
    const metadataCompleta = { 
      ...(metadata || {}),
      numeroFatura: numeroComPrefixo,
      tipoDocumento: numeroComPrefixo ? 'fatura' : 'recibo', // Auto-detecta tipo
      fornecedorManual: fornecedorManual, // ID do fornecedor selecionado manualmente
      novosIngredientes: novosIngs 
    };
    
    // Limpar cache de novos ingredientes
    window._novosIngredientes = [];
    
    onConfirmar(linhasFinais, metadataCompleta);
  };

  const getConfidenceClass = (confianca) => {
    if (confianca >= 80) return 'text-green-600 bg-green-50';
    if (confianca >= 60) return 'text-yellow-600 bg-yellow-50';
    return 'text-red-600 bg-red-50';
  };

  const getConfidenceIcon = (confianca) => {
    if (confianca >= 80) return '‚úì';
    if (confianca >= 60) return '‚ö†';
    return '‚úó';
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
      <div className="bg-white rounded-lg shadow-xl max-w-[95vw] w-full max-h-[95vh] flex flex-col">
        <div className="p-4 border-b flex-shrink-0">
          <h2 className="text-xl font-bold mb-2">üìÑ Confirmar Produtos Extra√≠dos</h2>
          
          {/* Info do Documento - COMPACTO */}
          <div className="mb-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded">
            <div className="grid grid-cols-3 gap-3 text-sm">
              {/* N√∫mero Fatura */}
              <div>
                <label className="text-xs font-semibold text-gray-600 block mb-1">üìã N√∫mero</label>
                {metadata?.numeroFatura ? (
                  <div className="px-2 py-1 bg-white border border-green-300 rounded font-bold text-green-700 text-sm">
                    {metadata.numeroFatura}
                  </div>
                ) : (
                  <div className="flex items-center gap-1">
                    <span className="px-2 py-1 bg-gray-100 border rounded text-sm font-semibold text-gray-600">FT</span>
                    <input
                      type="text"
                      value={numeroFaturaManual}
                      onChange={(e) => setNumeroFaturaManual(e.target.value)}
                      placeholder="2025/156"
                      className="flex-1 px-2 py-1 border rounded text-sm"
                    />
                  </div>
                )}
              </div>
              
              {/* Fornecedor */}
              <div>
                <label className="text-xs font-semibold text-gray-600 block mb-1">üè¢ Fornecedor</label>
                {(() => {
                  const fornecedorDetectado = metadata?.nif 
                    ? fornecedores.find(f => f.nif === metadata.nif)
                    : null;
                  
                  if (fornecedorDetectado) {
                    return (
                      <div className="px-2 py-1 bg-white border border-blue-300 rounded text-sm">
                        <span className="font-bold text-blue-700">{fornecedorDetectado.nome}</span>
                      </div>
                    );
                  } else {
                    return (
                      <select
                        value={fornecedorManual}
                        onChange={(e) => {
                          if (e.target.value === 'novo') {
                            setMostrarModalNovoFornecedor(true);
                          } else {
                            setFornecedorManual(e.target.value);
                          }
                        }}
                        className="w-full px-2 py-1 border rounded text-sm"
                      >
                        <option value="">Escolher...</option>
                        {fornecedoresLocais.map(f => (
                          <option key={f.id} value={f.id}>
                            {f.nome}
                          </option>
                        ))}
                        <option value="novo" className="font-bold">‚ûï Criar Novo</option>
                      </select>
                    );
                  }
                })()}
              </div>
              
              {/* Badge Tipo */}
              <div className="flex items-end">
                <span className={`px-3 py-1 rounded text-xs font-bold ${
                  metadata?.numeroFatura || numeroFaturaManual
                    ? 'bg-green-100 text-green-700' 
                    : 'bg-gray-100 text-gray-700'
                }`}>
                  {metadata?.numeroFatura || numeroFaturaManual ? 'üßæ FATURA' : 'üìù RECIBO'}
                </span>
              </div>
            </div>
          </div>
          
          {/* Stats de Aprendizagem - MELHORADO */}
          {stats && (
            <div className="mb-2">
              <div className="flex gap-2 text-xs mb-2">
                <div className="bg-blue-100 border border-blue-300 px-3 py-1.5 rounded font-semibold text-blue-900">
                  üì¶ <strong>{stats.total}</strong> produtos
                </div>
                <div className="bg-green-100 border border-green-300 px-3 py-1.5 rounded font-semibold text-green-900">
                  ‚úì <strong>{stats.altaConfianca}</strong> auto-preenchidos
                </div>
                <div className="bg-yellow-100 border border-yellow-300 px-3 py-1.5 rounded font-semibold text-yellow-900">
                  ‚ö† <strong>{stats.mediaConfianca}</strong> para verificar
                </div>
                <div className="bg-gray-100 border border-gray-300 px-3 py-1.5 rounded font-semibold text-gray-700">
                  ‚ùì <strong>{stats.semSugestao}</strong> manual
                </div>
              </div>
              
              {/* Barra de progresso removida - n√£o √© necess√°ria */}
            </div>
          )}
        </div>
        <div className="flex-1 overflow-auto p-6">
          
          <table className="w-full border-collapse">
            <thead className="sticky top-0 bg-gray-100">
              <tr>
                <th className="border p-2 text-left text-sm font-semibold">Texto PDF</th>
                {/* üÜï S√≥ mostrar colunas de Ingrediente se categoria = compras */}
                {metadata?.categoria === 'compras' && (
                  <>
                    <th className="border p-2 text-left text-sm font-semibold">Ingrediente</th>
                    <th className="border p-2 text-center text-sm font-semibold w-20">Conf.</th>
                  </>
                )}
                <th className="border p-2 text-center text-sm font-semibold w-24">Qtd</th>
                <th className="border p-2 text-center text-sm font-semibold w-20">Un</th>
                <th className="border p-2 text-center text-sm font-semibold w-24">Pre√ßo</th>
                <th className="border p-2 text-center text-sm font-semibold w-16">A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              {linhasEditadas.map((linha, index) => {
                const ingredienteSugerido = linha.ingredienteSugerido || null;
                const confianca = linha.confiancaSugestao || 0;
                const historico = linha.historicoSugestao;
                
                return (
                  <tr key={index} className="hover:bg-gray-50">
                    <td className="border p-2 text-sm">
                      <div className="font-mono text-xs text-gray-600 mb-1">{linha.textoOriginal}</div>
                      <div className="text-sm font-semibold">{linha.nomeProduto}</div>
                    </td>
                    
                    {/* üÜï S√≥ mostrar colunas de ingrediente se categoria = compras */}
                    {metadata?.categoria === 'compras' && (
                      <>
                        <td className="border p-2">
                          <div className="flex gap-1">
                            {/* Search + Dropdown de ingredientes */}
                            <div className="flex-1 relative">
                              <div className="relative">
                                <input
                                  type="text"
                                  value={searchIngredienteOCR[linha._id] || ''}
                                  onChange={(e) => {
                                    const valor = e.target.value;
                                    setSearchIngredienteOCR({...searchIngredienteOCR, [linha._id]: valor});
                                    setShowDropdownOCR({...showDropdownOCR, [index]: valor.length >= 2});
                                  }}
                                  onFocus={() => {
                                    if ((searchIngredienteOCR[linha._id] || '').length >= 2) {
                                      setShowDropdownOCR({...showDropdownOCR, [index]: true});
                                    }
                                  }}
                                  onBlur={() => {
                                    // Delay para permitir click no dropdown
                                    setTimeout(() => {
                                      setShowDropdownOCR({...showDropdownOCR, [index]: false});
                                    }, 200);
                                  }}
                                  placeholder="Digite para buscar..."
                                  className={`w-full px-2 py-1 text-sm border-2 rounded ${
                                    confianca >= 80 ? 'border-green-400 bg-green-50' :
                                    confianca >= 60 ? 'border-yellow-400 bg-yellow-50' :
                                    confianca > 0 ? 'border-orange-300 bg-orange-50' :
                                    'border-gray-300'
                                  }`}
                                />
                                {/* Badge de confian√ßa */}
                                {confianca > 0 && (
                                  <div className="relative group">
                                    <div className={`absolute -top-2 -right-2 px-1.5 py-0.5 rounded-full text-xs font-bold cursor-help ${
                                      confianca >= 80 ? 'bg-green-500 text-white' :
                                      confianca >= 60 ? 'bg-yellow-500 text-white' :
                                      'bg-orange-500 text-white'
                                    }`}>
                                      {confianca}%
                                    </div>
                                    
                                    {/* üÜï Tooltip com breakdown da confian√ßa */}
                                    {historico && (
                                      <div className="absolute right-0 top-6 mt-1 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 w-64">
                                        <div className="font-semibold mb-2 border-b border-gray-600 pb-1">
                                          {confianca >= 80 ? '‚úÖ Auto-Insert Ativo' : 'üìä Progresso de Aprendizagem'}
                                        </div>
                                        
                                        <div className="space-y-1 mb-2">
                                          <div className="flex justify-between">
                                            <span className="text-gray-400">Confirma√ß√µes:</span>
                                            <span className="font-bold text-green-300">{historico.confirmacoes || 0}</span>
                                          </div>
                                          {historico.correcoes > 0 && (
                                            <div className="flex justify-between">
                                              <span className="text-gray-400">Corre√ß√µes:</span>
                                              <span className="font-bold text-red-300">{historico.correcoes}</span>
                                            </div>
                                          )}
                                          <div className="flex justify-between">
                                            <span className="text-gray-400">Similaridade:</span>
                                            <span className="font-bold">{linha.similaridadeSugestao || 0}%</span>
                                          </div>
                                        </div>
                                        
                                        {confianca < 80 ? (
                                          <div className="border-t border-gray-600 pt-2 mt-2">
                                            <div className="text-yellow-300 font-semibold mb-1">
                                              ‚ö° Para atingir 80%:
                                            </div>
                                            <div className="text-xs">
                                              {historico.confirmacoes === 0 ? (
                                                '‚Ä¢ Confirme este ingrediente 2x'
                                              ) : historico.confirmacoes === 1 ? (
                                                '‚Ä¢ Confirme mais 1x (total: 2)'
                                              ) : (
                                                '‚Ä¢ Melhore a similaridade do texto'
                                              )}
                                            </div>
                                            {(historico.confirmacoes || 0) < 2 && (
                                              <div className="mt-2 bg-blue-900 rounded p-1.5">
                                                <div className="text-xs">
                                                  Pr√≥xima confirma√ß√£o ‚Üí <strong className="text-green-300">{historico.confirmacoes === 0 ? '76.5%' : '85.5%'}</strong>
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        ) : (
                                          <div className="border-t border-green-600 pt-2 mt-2 text-green-300">
                                            ‚úÖ Ingrediente ser√° inserido automaticamente!
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                              
                              {/* Dropdown de sugest√µes */}
                              {showDropdownOCR[index] && (
                                (() => {
                                  const search = normalizeText(searchIngredienteOCR[linha._id] || '');
                                  const sugestoes = ingredientesLocais
                                    .filter(ing => normalizeText(ing.nome).includes(search))
                                    .slice(0, 10);
                                  
                                  if (sugestoes.length === 0) return null;
                                  
                                  return (
                                    <div className="absolute top-full left-0 right-0 bg-white border shadow-lg z-50 max-h-60 overflow-y-auto mt-1 rounded">
                                      {sugestoes.map(ing => (
                                        <div
                                          key={ing.id}
                                          onMouseDown={(e) => {
                                            e.preventDefault();
                                            handleIngredienteChange(index, ing.id);
                                            setSearchIngredienteOCR({...searchIngredienteOCR, [linha._id]: ing.nome});
                                            setShowDropdownOCR({...showDropdownOCR, [index]: false});
                                          }}
                                          className="p-2 hover:bg-blue-50 cursor-pointer border-b"
                                        >
                                          <div className="font-semibold text-sm">{ing.nome}</div>
                                          <div className="text-xs text-gray-600">
                                            ‚Ç¨{ing.custoUnitario.toFixed(2)}/{ing.unidade} ¬∑ {ing.categoria}
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  );
                                })()
                              )}
                              
                              {/* Mostrar ingrediente selecionado */}
                              {linha.ingredienteConfirmado && !searchIngredienteOCR[linha._id] && (
                                (() => {
                                  const ingSelecionado = ingredientesLocais.find(i => i.id === linha.ingredienteConfirmado);
                                  if (ingSelecionado) {
                                    return (
                                      <div className="mt-1 text-xs text-blue-600 font-semibold">
                                        ‚úì {ingSelecionado.nome}
                                      </div>
                                    );
                                  }
                                  return null;
                                })()
                              )}
                            </div>
                            
                            <button
                              onClick={() => {
                                setNovoIngrediente({
                                  nome: linha.nomeProduto || '',
                                  categoria: 'outros',
                                  unidade: linha.unidade || 'kg',
                                  custo: linha.preco ? linha.preco.toString() : '',
                                  iva: linha.iva ? linha.iva.toString() : (metadata?.iva ? metadata.iva.toString() : '13')
                                });
                                setLinhaIndexCriando(index);
                                setMostrarModalCriarIng(true);
                              }}
                              className="ml-1 px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                              title="Criar novo ingrediente"
                            >
                              +
                            </button>
                          </div>

                        </td>
                        <td className={`border p-2 text-center ${getConfidenceClass(confianca)}`}>
                          <div className="text-sm font-bold">{linha.ingredienteSugerido ? `${confianca}%` : '--'}</div>
                          <div className="text-xs">{getConfidenceIcon(confianca)}</div>
                        </td>
                      </>
                    )}
                    <td className="border p-2">
                      <input
                        type="number"
                        step="0.01"
                        value={linha.quantidade || ''}
                        onChange={(e) => handleQuantidadeChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded text-center"
                        placeholder="--"
                      />
                    </td>
                    <td className="border p-2">
                      <select
                        value={linha.unidade || ''}
                        onChange={(e) => handleUnidadeChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded"
                      >
                        <option value="">--</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="l">l</option>
                        <option value="ml">ml</option>
                        <option value="un">un</option>
                      </select>
                    </td>
                    <td className="border p-2">
                      <input
                        type="number"
                        step="0.01"
                        value={linha.preco || ''}
                        onChange={(e) => handlePrecoChange(index, e.target.value)}
                        className="w-full px-2 py-1 text-sm border rounded text-right"
                        placeholder="--"
                      />

                      {/* ‚ú® PREVIEW DO PRE√áO UNIT√ÅRIO CALCULADO */}
                      {linha.preco && linha.quantidade && linha.ingredienteConfirmado && (() => {
                        const ing = ingredientesLocais.find(i => i.id === linha.ingredienteConfirmado);
                        if (!ing) return null;
                        
                        const precoTotal = parseFloat(linha.preco);
                        const quantidade = parseFloat(linha.quantidade);
                        const unidadeCompra = linha.unidade || ing.unidade;
                        const unidadeBase = ing.unidade;
                        
                        // Converter quantidade para unidade base
                        let quantidadeBase = quantidade;
                        if (unidadeCompra === 'g' && unidadeBase === 'kg') {
                          quantidadeBase = quantidade / 1000;
                        } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
                          quantidadeBase = quantidade / 1000;
                        } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
                          quantidadeBase = quantidade * 1000;
                        } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
                          quantidadeBase = quantidade * 1000;
                        }
                        
                        const precoUnitario = precoTotal / quantidadeBase;
                        
                        return (
                          <div className="text-xs mt-1 text-green-600 font-semibold">
                            = ‚Ç¨{precoUnitario.toFixed(2)}/{unidadeBase}
                          </div>
                        );
                      })()}
                    </td>
                    <td className="border p-2 text-center">
                      <button
                        onClick={() => handleLimparPalavrasLinha(index)}
                        className="text-blue-600 hover:text-blue-800 text-sm mr-1"
                        title="Limpar palavras (remove do nome)"
                      >
                        üßπ
                      </button>
                      <button
                        onClick={() => handleBlacklistLinha(index)}
                        className="text-gray-700 hover:text-black text-sm"
                        title="Blacklist (bloqueia linha inteira)"
                      >
                        üö´
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {linhasEditadas.length === 0 && (
            <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
              <p className="text-gray-600 mb-3">‚ö†Ô∏è Nenhum produto detectado no OCR</p>
              <p className="text-sm text-gray-500 mb-4">Adicione produtos manualmente clicando no bot√£o abaixo</p>
              <button
                onClick={() => {
                  const novaLinha = {
                    nomeProduto: '',
                    quantidade: '',
                    preco: '',
                    ingredienteConfirmado: null
                  };
                  setLinhasEditadas([novaLinha]);
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ûï Adicionar Primeira Linha
              </button>
            </div>
          )}
        </div>
        <div className="p-6 border-t bg-gray-50">
          <div className="flex justify-end items-center">
            <div className="flex gap-3">
            <button
              onClick={onCancelar}
              className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold"
            >
              Cancelar
            </button>
            <button
              onClick={handleConfirmar}
              disabled={linhasEditadas.length === 0}
              className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-semibold"
            >
              Confirmar {linhasEditadas.length > 0 && `(${linhasEditadas.length})`}
            </button>
          </div>
          </div>
        </div>
      </div>

      {/* Modal Criar Ingrediente */}
      {mostrarModalCriarIng && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 my-8">
            <h3 className="text-xl font-bold mb-4 text-gray-800">‚ú® Criar Novo Ingrediente</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoIngrediente.nome}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, nome: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: Tomate Cherry"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Categoria *</label>
                <select
                  value={novoIngrediente.categoria}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, categoria: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="vegetais">ü•¨ Vegetais</option>
                  <option value="frutas">üçé Frutas</option>
                  <option value="carnes">ü•© Carnes</option>
                  <option value="peixe">üêü Peixe/Marisco</option>
                  <option value="latic√≠nios">ü•õ Latic√≠nios</option>
                  <option value="√≥leos">ü´í √ìleos/Gorduras</option>
                  <option value="cereais">üåæ Cereais/Massas</option>
                  <option value="especiarias">üå∂Ô∏è Especiarias</option>
                  <option value="bebidas">üç∫ Bebidas</option>
                  <option value="embalagens">üì¶ Embalagens</option>
                  <option value="limpeza">üßπ Limpeza</option>
                  <option value="compotas">üçØ Compotas/Doces</option>
                  <option value="outros">üìã Outros</option>
                </select>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Unidade *</label>
                  <select
                    value={novoIngrediente.unidade}
                    onChange={(e) => setNovoIngrediente({...novoIngrediente, unidade: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="l">l</option>
                    <option value="ml">ml</option>
                    <option value="un">un</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">Custo (‚Ç¨) *</label>
                  <input
                    type="number"
                    step="0.01"
                    value={novoIngrediente.custo}
                    onChange={(e) => setNovoIngrediente({...novoIngrediente, custo: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">IVA (%) *</label>
                <select
                  value={novoIngrediente.iva}
                  onChange={(e) => setNovoIngrediente({...novoIngrediente, iva: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="6">6% (Essencial)</option>
                  <option value="13">13% (Reduzido)</option>
                  <option value="23">23% (Normal)</option>
                </select>
              </div>
            </div>
            
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => {
                  setMostrarModalCriarIng(false);
                  setNovoIngrediente({ nome: '', categoria: 'outros', unidade: 'kg', custo: '', iva: '13' });
                }}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold text-gray-700"
              >
                Cancelar
              </button>
              <button
                onClick={handleCriarIngrediente}
                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
              >
                ‚ú® Criar Ingrediente
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Modal Criar Fornecedor */}
      {mostrarModalNovoFornecedor && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
            <h3 className="text-xl font-bold mb-4">‚ûï Criar Novo Fornecedor</h3>
            
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-semibold mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoFornecedor.nome}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nome: e.target.value})}
                  placeholder="Ex: Pingo Doce"
                  className="w-full px-3 py-2 border rounded"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">NIF</label>
                <input
                  type="text"
                  value={novoFornecedor.nif}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nif: e.target.value})}
                  placeholder="9 d√≠gitos"
                  maxLength="9"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Contacto</label>
                <input
                  type="text"
                  value={novoFornecedor.contacto}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, contacto: e.target.value})}
                  placeholder="Telefone"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Email</label>
                <input
                  type="email"
                  value={novoFornecedor.email}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, email: e.target.value})}
                  placeholder="email@exemplo.com"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            
            <div className="flex gap-2 mt-6">
              <button
                onClick={() => {
                  setMostrarModalNovoFornecedor(false);
                  setNovoFornecedor({ nome: '', nif: metadata.nif || '', contacto: '', email: '' });
                }}
                className="flex-1 px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              >
                Cancelar
              </button>
              <button
                onClick={criarNovoFornecedor}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ú® Criar
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üßπ Modal Limpar Palavras */}
      {mostrarModalLimparPalavras && linhaParaLimpar && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex items-center justify-between sticky top-0">
              <h3 className="text-xl font-bold text-white">üßπ Limpar Palavras do Nome</h3>
              <button onClick={() => { setMostrarModalLimparPalavras(false); setLinhaParaLimpar(null); setPalavrasSelecionadas([]); }} className="text-white hover:bg-white/20 rounded-full p-2 transition">‚úï</button>
            </div>
            <div className="p-6 space-y-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Texto Original:</label>
                <div className="bg-gray-100 border border-gray-300 rounded-lg p-3">
                  <p className="font-mono text-sm text-gray-800">{linhaParaLimpar.textoOriginal}</p>
                </div>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">Selecione as palavras a remover:</label>
                <div className="grid grid-cols-2 gap-2">
                  {linhaParaLimpar.textoOriginal.split(/\s+/).filter(p => p.length > 1).map((palavra, idx) => {
                    const isSelected = palavrasSelecionadas.includes(palavra);
                    return (<button key={idx} onClick={() => { if (isSelected) { setPalavrasSelecionadas(palavrasSelecionadas.filter(p => p !== palavra)); } else { setPalavrasSelecionadas([...palavrasSelecionadas, palavra]); } }} className={`px-4 py-2 rounded-lg border-2 font-mono text-sm transition ${isSelected ? 'bg-blue-100 border-blue-500 text-blue-900 font-semibold' : 'bg-white border-gray-300 text-gray-700 hover:border-blue-300'}`}>{isSelected && '‚úì '}{palavra}</button>);
                  })}
                </div>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Resultado (preview):</label>
                <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                  <p className="font-mono text-sm text-green-900 font-semibold">{(() => { let resultado = linhaParaLimpar.textoOriginal; palavrasSelecionadas.forEach(palavra => { const regex = new RegExp(`\\b${palavra}\\b`, 'gi'); resultado = resultado.replace(regex, '').replace(/\s+/g, ' ').trim(); }); return resultado || '(vazio)'; })()}</p>
                </div>
                {palavrasSelecionadas.length > 0 && (<p className="text-xs text-gray-500 mt-2">Palavras removidas: <span className="font-semibold text-blue-600">{palavrasSelecionadas.join(', ')}</span></p>)}
              </div>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <label className="flex items-start gap-3 cursor-pointer">
                  <input type="checkbox" checked={sempreRemover} onChange={(e) => setSempreRemover(e.target.checked)} className="w-5 h-5 rounded text-blue-600 focus:ring-2 focus:ring-blue-500 mt-0.5" />
                  <div>
                    <p className="font-semibold text-sm text-gray-800">‚úÖ Sempre remover estas palavras deste fornecedor</p>
                    <p className="text-xs text-gray-600 mt-1">As palavras selecionadas ser√£o automaticamente removidas em futuras faturas deste fornecedor (NIF: {linhaParaLimpar.nifFornecedor})</p>
                  </div>
                </label>
              </div>
            </div>
            <div className="border-t border-gray-200 px-6 py-4 flex gap-3 justify-end bg-gray-50 sticky bottom-0">
              <button onClick={() => { setMostrarModalLimparPalavras(false); setLinhaParaLimpar(null); setPalavrasSelecionadas([]); }} className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold text-gray-700 transition">Cancelar</button>
              <button onClick={confirmarLimpezaPalavras} disabled={palavrasSelecionadas.length === 0} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-semibold transition flex items-center gap-2">üßπ Limpar {palavrasSelecionadas.length > 0 && `(${palavrasSelecionadas.length})`}</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== MODAL DE CONFIRMA√á√ÉO DE TIPO DE FATURA ====================
// Este componente deve ser adicionado antes do componente RestauranteGestor (por volta da linha 2300)

/**
 * üÜï MODAL SIMPLES PARA DESPESAS FIXAS (renda, luz, √°gua, etc)
 * S√≥ pede pre√ßo e IVA, sem ingredientes
 */
const ModalDespesaSimples = ({ dadosDespesa, onConfirmar, onCancelar }) => {
  const { categoria, fornecedor, valorDetectado, metadata } = dadosDespesa;
  
  const [precoTotal, setPrecoTotal] = React.useState(() => {
    // Arredondar para 2 casas decimais para evitar 210.94000000000005
    return valorDetectado ? parseFloat(valorDetectado).toFixed(2) : '';
  });
  const [ivaPercentagem, setIvaPercentagem] = React.useState(() => {
    // IVA padr√£o por categoria
    if (categoria === 'salarios') return '0';
    if (categoria === 'agua') return '6';
    return '23'; // Padr√£o para renda, eletricidade, gas, internet, etc
  });
  
  // Labels das categorias
  const labelsCategorias = {
    'renda': 'üè† Renda',
    'eletricidade': '‚ö° Eletricidade',
    'agua': 'üíß √Ågua',
    'gas': 'üî• G√°s',
    'internet': 'üåê Internet',
    'salarios': 'üë• Sal√°rios',
    'marketing': 'üì¢ Marketing',
    'consumiveis': 'üì¶ Consum√≠veis',
    'manutencao': 'üîß Manuten√ß√£o',
    'outros': 'üìã Outros'
  };
  
  const handleConfirmar = () => {
    const precoFinal = parseFloat(precoTotal);
    const iva = parseFloat(ivaPercentagem);
    
    if (!precoFinal || precoFinal <= 0) {
      alert('Por favor, insira um pre√ßo v√°lido');
      return;
    }
    
    onConfirmar({
      precoTotal: precoFinal,
      iva: iva,
      categoria: categoria,
      fornecedor: fornecedor,
      metadata: metadata
    });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
      <div className="bg-white rounded-lg shadow-2xl max-w-md w-full">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-lg">
          <h2 className="text-xl font-bold flex items-center gap-2">
            {labelsCategorias[categoria] || 'üìã Despesa'}
          </h2>
          <p className="text-blue-100 text-sm mt-1">Confirme os valores da despesa</p>
        </div>
        
        {/* Body */}
        <div className="p-6 space-y-4">
          {/* Fornecedor */}
          <div className="bg-gray-50 p-3 rounded border">
            <label className="text-xs font-semibold text-gray-600 block mb-1">
              üè¢ Fornecedor
            </label>
            <p className="font-bold text-gray-800">
              {fornecedor?.nome || 'N√£o especificado'}
            </p>
            {fornecedor?.nif && (
              <p className="text-xs text-gray-500">NIF: {fornecedor.nif}</p>
            )}
          </div>
          
          {/* Pre√ßo Total */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üí∞ Pre√ßo Total (com IVA)
            </label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">
                ‚Ç¨
              </span>
              <input
                type="number"
                step="0.01"
                value={precoTotal}
                onChange={(e) => setPrecoTotal(e.target.value)}
                className="w-full pl-8 pr-3 py-3 border-2 border-gray-300 rounded-lg text-lg font-bold focus:border-blue-500 focus:outline-none"
                placeholder="0.00"
                autoFocus
              />
            </div>
            {valorDetectado && (
              <p className="text-xs text-blue-600 mt-1">
                üí° Valor detectado pelo OCR: ‚Ç¨{parseFloat(valorDetectado).toFixed(2)}
              </p>
            )}
          </div>
          
          {/* IVA */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">
              üìä Taxa de IVA
            </label>
            <select
              value={ivaPercentagem}
              onChange={(e) => setIvaPercentagem(e.target.value)}
              className="w-full px-3 py-3 border-2 border-gray-300 rounded-lg font-semibold focus:border-blue-500 focus:outline-none"
            >
              <option value="0">0% (Isento)</option>
              <option value="6">6% (Taxa reduzida)</option>
              <option value="13">13% (Taxa interm√©dia)</option>
              <option value="23">23% (Taxa normal)</option>
            </select>
            <p className="text-xs text-gray-500 mt-1">
              {categoria === 'salarios' && 'üí° Sal√°rios normalmente isentos de IVA'}
              {categoria === 'agua' && 'üí° √Ågua normalmente tem IVA de 6%'}
              {categoria === 'renda' && 'üí° Renda normalmente tem IVA de 23%'}
            </p>
          </div>
          
          {/* Preview c√°lculo */}
          {precoTotal && (
            <div className="bg-blue-50 p-3 rounded border border-blue-200">
              <div className="flex justify-between text-sm">
                <span className="text-gray-700">Base tribut√°vel:</span>
                <span className="font-semibold">
                  ‚Ç¨{(parseFloat(precoTotal) / (1 + parseFloat(ivaPercentagem) / 100)).toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-700">IVA ({ivaPercentagem}%):</span>
                <span className="font-semibold">
                  ‚Ç¨{(parseFloat(precoTotal) - (parseFloat(precoTotal) / (1 + parseFloat(ivaPercentagem) / 100))).toFixed(2)}
                </span>
              </div>
              <div className="flex justify-between text-sm font-bold text-blue-700 mt-2 pt-2 border-t border-blue-300">
                <span>Total com IVA:</span>
                <span>‚Ç¨{parseFloat(precoTotal).toFixed(2)}</span>
              </div>
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className="bg-gray-50 px-6 py-4 rounded-b-lg flex gap-3">
          <button
            onClick={onCancelar}
            className="flex-1 px-4 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold transition"
          >
            Cancelar
          </button>
          <button
            onClick={handleConfirmar}
            className="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 font-semibold transition shadow-lg"
          >
            ‚úÖ Confirmar e Guardar
          </button>
        </div>
      </div>
    </div>
  );
};

/**
 * Modal para confirmar tipo de fatura detectado
 */
const ModalConfirmacaoFatura = ({ dadosFatura, onConfirmar, onCancelar, fornecedores = [], showNotification, setFornecedores }) => {
  const [tipoSelecionado, setTipoSelecionado] = React.useState(dadosFatura.tipo);
  const [categoriaSelecionada, setCategoriaSelecionada] = React.useState(dadosFatura.categoria || 'compras'); // üÜï CATEGORIA
  const [dataCorrigida, setDataCorrigida] = React.useState(dadosFatura.data || '');
  const [temNifCliente, setTemNifCliente] = React.useState(dadosFatura.temNifCliente || false); // üÜï NIF CLIENTE
  const [mostrarModalNovoFornecedor, setMostrarModalNovoFornecedor] = React.useState(false);
  const [fornecedoresLocais, setFornecedoresLocais] = React.useState(fornecedores);
  const [novoFornecedor, setNovoFornecedor] = React.useState({
    nome: '',
    nif: dadosFatura.fornecedor?.nif || '',
    contacto: '',
    email: ''
  });
  
  // üîß Fun√ß√£o helper para criar fornecedor (com acesso √†s props)
  const criarNovoFornecedor = () => {
    if (!novoFornecedor.nome.trim()) {
      alert('Nome √© obrigat√≥rio!');
      return;
    }
    
    // Criar fornecedor com ID permanente
    const novoFornTemp = {
      id: Date.now(),
      nome: novoFornecedor.nome.trim(),
      nif: novoFornecedor.nif.trim(),
      telefone: novoFornecedor.contacto.trim(),
      email: novoFornecedor.email.trim(),
      morada: '',
      dataCriacao: new Date().toISOString()
    };
    
    // ‚úÖ ADICIONAR IMEDIATAMENTE AO ESTADO GLOBAL (guardado permanentemente)
    if (setFornecedores && typeof setFornecedores === 'function') {
      setFornecedores([...fornecedores, novoFornTemp]);
    }
    
    // Adicionar √† lista LOCAL (aparece no dropdown imediatamente)
    setFornecedoresLocais([...fornecedoresLocais, novoFornTemp]);
    
    // Adicionar ao metadata para ser processado depois (fallback)
    if (!window._novosFornecedores) window._novosFornecedores = [];
    window._novosFornecedores.push(novoFornTemp);
    
    // Selecionar o fornecedor rec√©m-criado
    setFornecedorSelecionado(novoFornTemp);
    
    // Mostrar notifica√ß√£o de sucesso
    if (showNotification && typeof showNotification === 'function') {
      showNotification('‚úÖ Fornecedor criado com sucesso!', 'success');
    }
    
    // Fechar modal
    setMostrarModalNovoFornecedor(false);
    setNovoFornecedor({ nome: '', nif: dadosFatura.fornecedor?.nif || '', contacto: '', email: '' });
  };
  
  // ‚úÖ MATCH INTELIGENTE: NOME primeiro (mais confi√°vel), depois NIF
  const [fornecedorSelecionado, setFornecedorSelecionado] = React.useState(() => {
    void 0;
    void 0;
    
    // 1. PRIORIDADE: Match por NOME (mais confi√°vel que OCR de NIF)
    if (dadosFatura.fornecedor?.nome) {
      const nomeDetectado = dadosFatura.fornecedor.nome.toLowerCase().trim();
      void 0;
      
      const porNome = fornecedores.find(f => {
        if (!f.nome) return false;
        const nomeCadastrado = f.nome.toLowerCase().trim();
        
        void 0;
        
        // Match exato (ignora case)
        if (nomeDetectado === nomeCadastrado) {
          void 0;
          return true;
        }
        
        // Match se um cont√©m o outro
        if (nomeCadastrado.includes(nomeDetectado) || nomeDetectado.includes(nomeCadastrado)) {
          void 0;
          return true;
        }
        
        // Extrair palavras significativas (3+ chars)
        const palavrasDetectadas = nomeDetectado.split(/\s+/).filter(p => p.length >= 3);
        const palavrasCadastradas = nomeCadastrado.split(/\s+/).filter(p => p.length >= 3);
        
        void 0;
        void 0;
        
        // Match se pelo menos 1 palavra em comum
        const temMatch = palavrasDetectadas.some(pd => 
          palavrasCadastradas.some(pc => pc.includes(pd) || pd.includes(pc))
        );
        
        if (temMatch) {
          void 0;
        }
        
        return temMatch;
      });
      
      if (porNome) {
        void 0;
        return porNome;
      }
    }
    
    // 2. FALLBACK: Match por NIF (s√≥ se nome n√£o funcionou)
    if (dadosFatura.fornecedor?.nif) {
      void 0;
      const porNif = fornecedores.find(f => f.nif === dadosFatura.fornecedor.nif);
      if (porNif) {
        void 0;
        return porNif;
      }
    }
    
    void 0;
    return null;
  });
  
  const [numeroFatura, setNumeroFatura] = React.useState(dadosFatura.numero || '');
  
  const handleConfirmar = () => {
    onConfirmar({
      ...dadosFatura,
      tipo: tipoSelecionado,
      categoria: categoriaSelecionada, // üÜï PASSAR CATEGORIA
      numero: numeroFatura || dadosFatura.numero,
      data: dataCorrigida || dadosFatura.data, // üÜï PASSAR DATA CORRIGIDA
      temNifCliente: temNifCliente, // üÜï PASSAR NIF CLIENTE do state
      fornecedor: fornecedorSelecionado ? {
        nome: fornecedorSelecionado.nome,
        nif: fornecedorSelecionado.nif,
        id: fornecedorSelecionado.id
      } : dadosFatura.fornecedor
    });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
      <div className="bg-white rounded-lg p-6 max-w-4xl w-full shadow-xl max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold">Confirmar Tipo de Fatura</h3>
          {dadosFatura.pdfUrl && (
            <button
              onClick={() => window.open(dadosFatura.pdfUrl, '_blank')}
              className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
              title="Visualizar PDF original"
            >
              <FileText className="w-4 h-4" />
              Ver PDF
            </button>
          )}
        </div>
        
        {/* Layout em 2 colunas */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          {/* COLUNA ESQUERDA: Info detectada */}
          <div>
            <div className="mb-4 p-4 bg-blue-50 rounded-lg">
              <h4 className="font-semibold mb-2">Dados Detectados:</h4>
              <p className="text-sm text-gray-700">
                <strong>Tipo:</strong> {INVOICE_TYPES[dadosFatura.tipo]?.label || dadosFatura.tipo}
              </p>
              {dadosFatura.numero !== 'N/A' && (
                <p className="text-sm text-gray-700 mt-1">
                  <strong>N√∫mero:</strong> {dadosFatura.numero}
                </p>
              )}
              <p className="text-sm text-gray-700 mt-1">
                <strong>Fornecedor:</strong> {dadosFatura.fornecedor.nome}
              </p>
              {dadosFatura.fornecedor.nif && (
                <p className="text-sm text-gray-700 mt-1">
                  <strong>NIF:</strong> {dadosFatura.fornecedor.nif}
                </p>
              )}
              <p className="text-sm text-gray-700 mt-1">
                <strong>Data:</strong> {dadosFatura.data}
              </p>
              {dadosFatura.totais.total > 0 && (
                <p className="text-sm text-gray-700 mt-1">
                  <strong>Total:</strong> {dadosFatura.totais.total.toFixed(2)}‚Ç¨
                </p>
              )}
            </div>
            
            {/* Dropdown Fornecedor */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                Selecionar Fornecedor:
                {(!fornecedorSelecionado || fornecedorSelecionado.nome === 'Desconhecido' || dadosFatura.fornecedor.nome === 'Desconhecido') && (
                  <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-bold">
                    ‚ö†Ô∏è N√ÉO DETETADO
                  </span>
                )}
              </label>
              <select
                value={fornecedorSelecionado?.id || ''}
                onChange={(e) => {
                  const idSelecionado = e.target.value;
                  void 0;
                  void 0;
                  
                  // ‚úÖ Verificar se √© "novo" para abrir modal
                  if (idSelecionado === 'novo') {
                    setMostrarModalNovoFornecedor(true);
                  } else {
                    // ‚úÖ FIX: Comparar como string (e.target.value sempre retorna string)
                    const forn = fornecedoresLocais.find(f => String(f.id) === String(idSelecionado));
                    void 0;
                    setFornecedorSelecionado(forn || null);
                  }
                }}
                className={`w-full p-2 border-2 rounded-lg transition-colors ${
                  !fornecedorSelecionado || fornecedorSelecionado.nome === 'Desconhecido' || dadosFatura.fornecedor.nome === 'Desconhecido'
                    ? 'bg-red-50 border-red-400 text-red-900 font-semibold'
                    : 'border-gray-300'
                }`}
              >
                <option value="">Desconhecido</option>
                {fornecedoresLocais.map(f => (
                  <option key={f.id} value={f.id}>
                    {f.nome} {f.nif ? `(NIF: ${f.nif})` : ''}
                  </option>
                ))}
                <option value="novo" className="font-bold">‚ûï Criar Novo</option>
              </select>
            </div>
            
            {/* üÜï Data e Categoria lado a lado */}
            <div className="grid grid-cols-2 gap-4 mb-4">
              {/* Campo Data */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                  Data da Fatura:
                  {(!dadosFatura.data || dadosFatura.data === 'N/A' || dadosFatura.data === '') && (
                    <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-bold">
                      ‚ö†Ô∏è N√ÉO DETETADA
                    </span>
                  )}
                </label>
                <input
                  type="date"
                  value={dataCorrigida}
                  onChange={(e) => setDataCorrigida(e.target.value)}
                  className={`w-full p-2 border-2 rounded-lg transition-colors ${
                    !dadosFatura.data || dadosFatura.data === 'N/A' || dadosFatura.data === ''
                      ? 'bg-red-50 border-red-400'
                      : 'border-gray-300'
                  }`}
                />
                <p className="text-xs text-gray-500 mt-1">
                  üí° Detectada: {dadosFatura.data}
                </p>
              </div>
              
              {/* üÜï Sele√ß√£o de Categoria */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  üìÇ Categoria da Despesa:
                </label>
                <select
                  value={categoriaSelecionada}
                  onChange={(e) => setCategoriaSelecionada(e.target.value)}
                  className="w-full p-2 border rounded-lg"
                >
                  <option value="compras">üõí Compras</option>
                  <option value="renda">üè† Renda</option>
                  <option value="eletricidade">üí° Eletricidade</option>
                  <option value="agua">üíß √Ågua</option>
                  <option value="gas">üî• G√°s</option>
                  <option value="internet">üåê Internet/Telefone</option>
                  <option value="salarios">üë• Sal√°rios</option>
                  <option value="marketing">üì¢ Marketing</option>
                  <option value="consumiveis">üßª Consum√≠veis</option>
                  <option value="manutencao">üîß Manuten√ß√£o</option>
                  <option value="outros">üì¶ Outros</option>
                </select>
              </div>
            </div>
            
            {/* Campo N√∫mero Fatura */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                N√∫mero da Fatura:
                {(!dadosFatura.numero || dadosFatura.numero === 'N/A' || dadosFatura.numero === '') && (
                  <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded font-bold">
                    ‚ö†Ô∏è N√ÉO DETETADO
                  </span>
                )}
              </label>
              <input
                type="text"
                value={numeroFatura}
                onChange={(e) => setNumeroFatura(e.target.value)}
                placeholder="Ex: FT 2024/001"
                className={`w-full p-2 border-2 rounded-lg transition-colors ${
                  !dadosFatura.numero || dadosFatura.numero === 'N/A' || dadosFatura.numero === ''
                    ? 'bg-red-50 border-red-400'
                    : 'border-gray-300'
                }`}
              />
            </div>
          </div>
          
          {/* COLUNA DIREITA: Sele√ß√£o de tipo */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Tipo de Fatura:
            </label>
            
            <div className="space-y-2">
              {Object.entries(INVOICE_TYPES).map(([tipo, config]) => (
                <label
                  key={tipo}
                  className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${
                    tipoSelecionado === tipo
                      ? 'border-green-500 bg-green-50'
                      : 'border-gray-200 hover:border-green-300 hover:bg-gray-50'
                  }`}
                >
                  <div className="flex items-center">
                    <input
                      type="radio"
                      name="tipoFatura"
                      value={tipo}
                      checked={tipoSelecionado === tipo}
                      onChange={(e) => setTipoSelecionado(e.target.value)}
                      className="mr-3 h-4 w-4 text-green-600"
                    />
                    <div>
                      <div className="font-semibold">{config.label}</div>
                      <div className="text-sm text-gray-600">{config.description}</div>
                    </div>
                  </div>
                </label>
              ))}
            </div>
            
            {/* üÜï CAMPO NIF DO CLIENTE (s√≥ para FS) */}
            {tipoSelecionado === 'FS' && (
              <div className={`mt-3 p-3 rounded-lg border-2 ${
                temNifCliente
                  ? 'bg-green-50 border-green-500' 
                  : 'bg-red-50 border-red-500'
              }`}>
                <label className="flex items-start gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={temNifCliente}
                    onChange={(e) => setTemNifCliente(e.target.checked)}
                    className="w-5 h-5 mt-1 cursor-pointer"
                  />
                  <div className="flex-1">
                    <div className="font-semibold text-sm flex items-center flex-wrap gap-2">
                      <span>Esta fatura cont√©m o meu NIF (255274513)</span>
                      {temNifCliente && (
                        <span className="px-2 py-1 bg-green-600 text-white text-xs rounded whitespace-nowrap">
                          ‚úÖ DETETADO
                        </span>
                      )}
                      {!temNifCliente && (
                        <span className="px-2 py-1 bg-orange-600 text-white text-xs rounded whitespace-nowrap">
                          ‚ö†Ô∏è ADICIONAR MANUALMENTE
                        </span>
                      )}
                    </div>
                    <div className={`text-xs mt-1 ${
                      temNifCliente ? 'text-green-700' : 'text-red-700'
                    }`}>
                      {temNifCliente ? (
                        <>
                          ‚ÑπÔ∏è O sistema encontrou o teu NIF nesta fatura. Pode ser inclu√≠da na partilha para o contabilista.
                        </>
                      ) : (
                        <>
                          ‚ö†Ô∏è O sistema n√£o encontrou o teu NIF. Se esta fatura tiver o teu NIF, marca esta op√ß√£o para poder deduzir.
                        </>
                      )}
                    </div>
                  </div>
                </label>
              </div>
            )}
          </div>
        </div>
        
        {/* Buttons */}
        <div className="flex gap-3 mt-6">
          <button
            onClick={handleConfirmar}
            className="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors"
          >
            Confirmar
          </button>
          <button
            onClick={onCancelar}
            className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
          >
            Cancelar
          </button>
        </div>
      </div>
      
      {/* Modal Criar Fornecedor */}
      {mostrarModalNovoFornecedor && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
            <h3 className="text-xl font-bold mb-4">‚ûï Criar Novo Fornecedor</h3>
            
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-semibold mb-1">Nome *</label>
                <input
                  type="text"
                  value={novoFornecedor.nome}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nome: e.target.value})}
                  placeholder="Ex: Pingo Doce"
                  className="w-full px-3 py-2 border rounded"
                  autoFocus
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">NIF</label>
                <input
                  type="text"
                  value={novoFornecedor.nif}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, nif: e.target.value})}
                  placeholder="9 d√≠gitos"
                  maxLength="9"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Contacto</label>
                <input
                  type="text"
                  value={novoFornecedor.contacto}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, contacto: e.target.value})}
                  placeholder="Telefone"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold mb-1">Email</label>
                <input
                  type="email"
                  value={novoFornecedor.email}
                  onChange={(e) => setNovoFornecedor({...novoFornecedor, email: e.target.value})}
                  placeholder="email@exemplo.com"
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            
            <div className="flex gap-2 mt-6">
              <button
                onClick={() => {
                  setMostrarModalNovoFornecedor(false);
                  setNovoFornecedor({ nome: '', nif: dadosFatura.fornecedor?.nif || '', contacto: '', email: '' });
                }}
                className="flex-1 px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              >
                Cancelar
              </button>
              <button
                onClick={criarNovoFornecedor}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
              >
                ‚ú® Criar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== COMPONENTE DE BLACKLIST ====================

// ==================== COMPONENTE DE CONFIGURA√á√ïES ====================

/**
 * Painel de Configura√ß√µes
 */
const PainelConfiguracoes = ({ configuracoes, onSalvar, vendas, setVendas, showNotification }) => {
  const [config, setConfig] = React.useState(configuracoes);
  const [mostrarSucesso, setMostrarSucesso] = React.useState(false);
  const [alertasExpanded, setAlertasExpanded] = React.useState(false);
  
  const handleSalvar = () => {
    onSalvar(config);
    setMostrarSucesso(true);
    setTimeout(() => setMostrarSucesso(false), 3000);
  };
  
  const atualizarConfig = (secao, campo, valor) => {
    const novoConfig = {
      ...config,
      [secao]: {
        ...config[secao],
        [campo]: valor
      }
    };
    setConfig(novoConfig);
    
    // ‚úÖ ATUALIZAR IMEDIATAMENTE para filtros de m√©tricas
    if (secao === 'metricas') {
      void 0;
      onSalvar(novoConfig);
    }
  };
  
  return (
    <div className="space-y-4">
      {/* Filtro de M√©tricas com Tags Individuais */}
      <div className="bg-gray-50 rounded-lg p-4">
        <h4 className="font-semibold mb-3 text-gray-700">üè∑Ô∏è Filtro de M√©tricas por Tags</h4>
        <p className="text-xs text-gray-600 mb-3">Seleciona quais origens incluir nas m√©tricas do dashboard</p>
        
        {/* Vendas */}
        <div className="mb-4">
          <p className="text-sm font-semibold text-gray-700 mb-2">üìä Vendas</p>
          <div className="space-y-2">
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirMoloni !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirMoloni', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">MOLONI</span>
                Vendas importadas do Moloni
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-blue-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirZobaze !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirZobaze', e.target.checked)}
                className="mr-2 h-4 w-4 text-blue-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-bold mr-2">ZOBAZE</span>
                Vendas importadas do Zobaze
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-gray-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirManual !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirManual', e.target.checked)}
                className="mr-2 h-4 w-4 text-gray-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-xs font-bold mr-2">MANUAL</span>
                Vendas adicionadas manualmente
              </span>
            </label>
          </div>
        </div>
        
        {/* Faturas/Despesas */}
        <div>
          <p className="text-sm font-semibold text-gray-700 mb-2">üìÑ Faturas de Compras</p>
          <div className="space-y-2">
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFT !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFT', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">FT</span>
                Faturas (oficial para contabilista)
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-green-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFR !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFR', e.target.checked)}
                className="mr-2 h-4 w-4 text-green-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold mr-2">FR</span>
                Faturas-Recibo (oficial para contabilista)
              </span>
            </label>
            
            <label className="flex items-center p-2 bg-white rounded cursor-pointer hover:bg-orange-50 transition border border-gray-200">
              <input
                type="checkbox"
                checked={config.metricas.incluirFS !== false}
                onChange={(e) => atualizarConfig('metricas', 'incluirFS', e.target.checked)}
                className="mr-2 h-4 w-4 text-orange-600 rounded"
              />
              <span className="text-sm">
                <span className="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-bold mr-2">FS</span>
                Faturas Simplificadas (n√£o oficial)
              </span>
            </label>
          </div>
        </div>
        
        {/* Atalhos R√°pidos */}
        <div className="mt-4 pt-4 border-t border-gray-300">
          <p className="text-xs font-semibold text-gray-600 mb-2">‚ö° Atalhos</p>
          <div className="flex gap-2">
            <button
              onClick={() => {
                const novoConfig = {
                  ...config,
                  metricas: {
                    ...config.metricas,
                    incluirMoloni: true,
                    incluirZobaze: false,
                    incluirManual: true,
                    incluirFT: true,
                    incluirFR: true,
                    incluirFS: false
                  }
                };
                setConfig(novoConfig);
                onSalvar(novoConfig);
              }}
              className="flex-1 bg-green-600 text-white px-3 py-1.5 rounded text-xs hover:bg-green-700 transition font-semibold"
            >
              üìä S√≥ Oficial
            </button>
            <button
              onClick={() => {
                const novoConfig = {
                  ...config,
                  metricas: {
                    ...config.metricas,
                    incluirMoloni: true,
                    incluirZobaze: true,
                    incluirManual: true,
                    incluirFT: true,
                    incluirFR: true,
                    incluirFS: true
                  }
                };
                setConfig(novoConfig);
                onSalvar(novoConfig);
              }}
              className="flex-1 bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 transition font-semibold"
            >
              üìà Tudo
            </button>
          </div>
        </div>
      </div>
      
      {/* Alertas de Margem */}
      <div className="border rounded-lg overflow-hidden">
        <button
          onClick={() => setAlertasExpanded(!alertasExpanded)}
          className="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition"
        >
          <div className="text-left">
            <h4 className="font-semibold text-gray-700">Alertas de Margem</h4>
            <p className="text-sm text-gray-600">
              Configurar limites de margem baixa e cr√≠tica
            </p>
          </div>
          {alertasExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
        </button>
        
        {alertasExpanded && (
          <div className="p-4 bg-white border-t space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Margem baixa (alerta amarelo):
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={config.alertas.margemBaixa}
                  onChange={(e) => atualizarConfig('alertas', 'margemBaixa', parseFloat(e.target.value))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg"
                />
                <span>%</span>
                <span className="text-sm text-gray-600">(default: 70%)</span>
              </div>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Margem cr√≠tica (alerta vermelho):
              </label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  max="100"
                  value={config.alertas.margemCritica}
                  onChange={(e) => atualizarConfig('alertas', 'margemCritica', parseFloat(e.target.value))}
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg"
                />
                <span>%</span>
                <span className="text-sm text-gray-600">(default: 55%)</span>
              </div>
            </div>
          </div>
        )}
      </div>
      
      <button
        onClick={handleSalvar}
        className="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
      >
        <Save className="w-5 h-5" />
        Guardar Defini√ß√µes
      </button>
      
      {/* Bot√£o Apagar Vendas */}
      <div className="border border-gray-300 rounded-lg p-4 bg-gray-50">
        <p className="text-sm font-semibold text-gray-700 mb-2">
          üóëÔ∏è Limpar Dados
        </p>
        <p className="text-xs text-gray-600 mb-3">
          Apaga todas as vendas. √ötil para importar dados novos.
        </p>
        <button
          onClick={() => {
            if (window.confirm(`Apagar ${vendas.length} vendas?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
              setVendas([]);
              showNotification('Vendas apagadas!', 'success');
            }
          }}
          className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition"
        >
          Apagar Todas as Vendas ({vendas.length})
        </button>
      </div>
      
      {mostrarSucesso && (
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg flex items-center gap-2">
          <Check className="w-5 h-5" />
          <span>Defini√ß√µes guardadas com sucesso!</span>
        </div>
      )}
    </div>
  );
};

// ==================== DISPLAY DE MARGENS ====================

/**
 * Componente para mostrar margens de produto com c√≥digo de cores
 */
const DisplayMargem = ({ produto, configuracoes }) => {
  const margens = calcularMargensProduto(produto, configuracoes);
  
  if (!margens) {
    return <span className="text-gray-400">N/A</span>;
  }
  
  const corClasses = {
    green: 'bg-green-100 border-green-500 text-green-800',
    yellow: 'bg-yellow-100 border-yellow-500 text-yellow-800',
    red: 'bg-red-100 border-red-500 text-red-800'
  };
  
  const corClass = corClasses[margens.status.cor] || corClasses.green;
  
  return (
    <div className={`p-3 rounded-lg border-l-4 ${corClass}`}>
      <div className="flex items-center justify-between">
        <span className="font-semibold">Margem Bruta:</span>
        <span className="text-lg font-bold">{margens.margemBruta.toFixed(1)}%</span>
      </div>
      
      {margens.status.status === 'critical' && (
        <div className="mt-2 pt-2 border-t border-red-300 text-sm">
          <div className="flex items-start gap-2">
            <AlertCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
            <div>
              <div className="font-semibold">Margem abaixo de {configuracoes?.alertas?.margemCritica || 55}%</div>
              <div>A√ß√£o sugerida: rever pre√ßo ou receita</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== FUN√á√ïES GLOBAIS NECESS√ÅRIAS ====================

const CONFIGURACOES_DEFAULT = {
  metricas: {
    // Tags individuais (padr√£o = tudo ativado)
    incluirMoloni: true,
    incluirZobaze: true,
    incluirManual: true,
    incluirFT: true,
    incluirFR: true,
    incluirFS: true,
    // Legacy (manter para compatibilidade)
    apenasOficial: false,
    // üÜï NIF da empresa para dete√ß√£o autom√°tica em FS
    nifEmpresa: '255274513' // C√°tia Santos
  },
  alertas: {
    margemBaixa: 70,
    margemCritica: 55
  }
};

const carregarConfiguracoes = () => {
  try {
    const guardado = localStorage.getItem('munchi_configuracoes');
    return guardado ? JSON.parse(guardado) : CONFIGURACOES_DEFAULT;
  } catch (e) {
    void 0;
    return CONFIGURACOES_DEFAULT;
  }
};

const guardarConfiguracoes = (configuracoes) => {
  try {
    localStorage.setItem('munchi_configuracoes', JSON.stringify(configuracoes));
    void 0;
    return true;
  } catch (e) {
    void 0;
    return false;
  }
};

// ==================== TIPOS DE FATURA ====================

const INVOICE_TYPES = {
  FT: {
    label: 'Fatura (FT)',
    description: 'Vai para contabilista',
    patterns: [
      /Fatura\s+N[.¬∫¬∞]\s*FT\s+\d{4}\/\d+/i,
      /FT\s+\d{4}\/\d+/,
      /^Fatura$/i
    ],
    numberPatterns: [
      // ‚úÖ SEMPRE com contexto de fatura
      /(?:FT|Fatura)\s*N?[.¬∫¬∞:]*\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /N[.¬∫¬∞:]\s*FT\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /FT\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      // Com "N.¬∫" mas s√≥ se tiver "Fatura" antes no texto
      /Fatura.*?N[.¬∫¬∞:]\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      // Padr√µes antigos espec√≠ficos
      /Fatura\s+N[.¬∫¬∞]\s*(FT\s*\d{4}\/\d+)/i,
      /N[.¬∫¬∞]\s*(FT[_\s-]?\d{4}[\/\s-]?\d+)/i,
      /(FT\s*\d{4}\/\d+)/,
      /PP\s+(\d+)/
    ]
  },
  FR: {
    label: 'Fatura-Recibo (FR)',
    description: 'Vai para contabilista',
    patterns: [
      /Fatura[_\s\/-]Recibo/i,
      /\d{2}\/Fatura\/Recibo/,
      /FR\s+\d{4}\/\d+/,
      /04\/Fatura/,
      /\bFR\b/i,  // ‚úÖ NOVO: Detectar "FR" sozinho
      /Fatura.*Recibo/i,  // ‚úÖ NOVO: Fatura...Recibo (com texto no meio)
      /Recibo.*Fatura/i   // ‚úÖ NOVO: Recibo...Fatura
    ],
    numberPatterns: [
      // ‚úÖ SEMPRE com contexto de fatura-recibo
      /(?:FR|Fatura[_\s-]?Recibo)\s*N?[.¬∫¬∞:]*\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /N[.¬∫¬∞:]\s*FR\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /FR\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      // Com "N.¬∫" mas s√≥ se tiver "Fatura" e "Recibo" antes
      /Fatura.*?Recibo.*?N[.¬∫¬∞:]\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      // Padr√£o de data (caso espec√≠fico de alguns fornecedores)
      /Fatura[_\s-]Recibo.*?(\d{4}[-_\/]\d{2}[-_\/]\d{2})/,
      // Padr√µes antigos
      /04\/Fatura\/Recibo\s+(\d{4}[-_]\d{2}[-_]\d{2})/,
      /(FR\s*\d{4}\/\d+)/,
      /PP\s+(\d+)/
    ]
  },
  FS: {
    label: 'Fatura Simplificada (FS)',
    description: 'Vai para contabilista SE tiver NIF',
    patterns: [
      /Fatura\s+Simplificada/i,
      /FS\s+[MN]\/\d+/i, // FS M/68601
      /FS\s+\d{4}\/\d+/,
      /Recibo\s+N[.¬∫¬∞]\s*\d+/,
      /Simplificada/i,
      /\bFS\b/i,  // ‚úÖ NOVO: Detectar "FS" sozinho
      /Fatura.*Simplificada/i,  // ‚úÖ NOVO: Fatura...Simplificada
      /Simplif/i  // ‚úÖ NOVO: OCR pode cortar palavra
    ],
    numberPatterns: [
      // ‚úÖ SEMPRE com contexto de fatura simplificada
      /(?:FS|Fatura\s+Simplificada|Simplificada)\s*N?[.¬∫¬∞:]*\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /N[.¬∫¬∞:]\s*FS\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      /FS\s*[:\s-]*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      // Padr√µes espec√≠ficos FS com M/ ou N/
      /Simplificada\s+FS\s+([MN]\/[A-Z0-9]+)/i,
      /FS\s+([MN]\/[A-Z0-9]+)/i,
      // Com "N.¬∫" mas s√≥ se tiver "Simplificada" antes
      /Simplificada.*?N[.¬∫¬∞:]\s*([A-Z0-9]+\s*[\/\-]\s*[A-Z0-9]+)/i,
      // Padr√µes antigos
      /(FS\s*\d{4}\/\d+)/,
      /Recibo\s+N[.¬∫¬∞]\s*(\d+)/,
      /Simplificada\s+(\d+)/
    ]
  }
};

const FORNECEDORES_CONHECIDOS = {
  recheio: {
    nome: 'Recheio Cash & Carry',
    patterns: [
      /Recheio\s+Cash\s+&\s+Carry/i,
      /PT\s+HF\s+9568126/i,
      /NIF[:\s]*500145415/i
    ],
    nif: '500145415'
  },
  mania: {
    nome: 'MANIA CERVEJEIRA',
    patterns: [
      /MANIA\s+CERVEJEIRA/i,
      /Stefan\s+Hunold/i
    ],
    nif: '278240160'
  },
  pingoDoce: {
    nome: 'Pingo Doce',
    patterns: [
      /Pingo\s*Doce/i,
      /JERONIMO\s+MARTINS/i,
      /JMR\s*-/i,
      /NIF[:\s]*500829993/i
    ],
    nif: '500829993'
  },
  continente: {
    nome: 'Continente',
    patterns: [
      /MODELO\s+CONTINENTE/i,
      /CONTINENTE\s+HIPERMERCADOS/i,
      /SONAE\s+MC/i,
      /NIF[:\s]*502011475/i
    ],
    nif: '502011475'
  },
  lidl: {
    nome: 'Lidl',
    patterns: [
      /LIDL\s+&\s+CIA/i,
      /LIDL\s+PORTUGAL/i,
      /NIF[:\s]*500871029/i
    ],
    nif: '500871029'
  },
  auchan: {
    nome: 'Auchan',
    patterns: [
      /AUCHAN\s+PORTUGAL/i,
      /JUMBO/i,
      /NIF[:\s]*500038191/i
    ],
    nif: '500038191'
  },
  makro: {
    nome: 'Makro',
    patterns: [
      /MAKRO\s+CASH/i,
      /MAKRO\s+PORTUGAL/i,
      /NIF[:\s]*500576602/i
    ],
    nif: '500576602'
  }
};

void 0;

  // ===== üÜï COMPONENTE: PAINEL DE ALERTAS DE STOCK =====

const RestauranteGestor = () => {
  const [activeTab, setActiveTab] = useState('dashboard');

  // üÜï Fun√ß√£o helper para mudar de aba e fazer scroll para o topo
  const mudarParaAba = (aba) => {
    setActiveTab(aba);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const [isSyncing, setIsSyncing] = React.useState(false);
  const [lastSync, setLastSync] = React.useState(GitHubSync.getLastSync());
  const [syncError, setSyncError] = React.useState(null);
  const [autoSyncEnabled, setAutoSyncEnabled] = React.useState(true);
  
  // Google Drive states
  const [driveAccessToken, setDriveAccessToken] = useState(null);
  const [driveUser, setDriveUser] = useState(null);
  const [driveSyncing, setDriveSyncing] = useState(false);
  const [driveFileId, setDriveFileId] = useState(localStorage.getItem('munchi_drive_file_id'));
  const [driveLastSync, setDriveLastSync] = useState(null);
  const [driveError, setDriveError] = useState(null);
  // üÜï Estados para gest√£o de token
  const [driveTokenValid, setDriveTokenValid] = useState(false);
  const [driveTokenTimeLeft, setDriveTokenTimeLeft] = useState(0);
  const tokenCheckIntervalRef = React.useRef(null);
  

  const [dashboardSubTab, setDashboardSubTab] = useState('resumo');
  const [dateFilter, setDateFilter] = useState('all'); // all, today, week, month, custom
  const [showBreakEvenDetails, setShowBreakEvenDetails] = useState(false); // Estado para dropdown do break-even
  const [showIVADetails, setShowIVADetails] = useState(false); // Estado para dropdown do IVA
  const [showDespesasDetails, setShowDespesasDetails] = useState(false); // Estado para dropdown de despesas
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [gestaoSubTab, setGestaoSubTab] = useState('ingredientes');
  const [produtos, setProdutos] = useState([]);
  const [ingredientes, setIngredientes] = useState([]);
  const [vendas, setVendas] = useState([]);
  const [despesas, setDespesas] = useState([]);
  const [fornecedores, setFornecedores] = useState([]);
  const [configuracaoWaste, setConfiguracaoWaste] = useState({
    percentagemGlobal: 8,
    percentagensPorCategoria: {
      'vegetais': 15, 'frutas': 14, 'peixe': 12, 'carnes': 10,
      'lacteos': 9, 'latic√≠nios': 9, 'compotas': 8, 'consumiveis': 7,
      'temperos': 6, 'padaria': 5, 'cafe': 4, 'cereais': 4,
      'especiarias': 3, 'oleos': 3, 'bebidas': 4, 'pastelaria': 5,
      'limpeza': 0, 'outros': 2, 'default': 8
    },
    usarCategorias: true
  });
  
  const [contagens, setContagens] = useState([]);
  const [vocabularioFornecedor, setVocabularioFornecedor] = useState([]); // üß† Sistema de aprendizagem
  const [templatesOCR, setTemplatesOCR] = useState([]); // üìã Templates por fornecedor
  const [novoProduto, setNovoProduto] = useState({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
  const [editandoProduto, setEditandoProduto] = useState(false);
  const [produtoEditandoId, setProdutoEditandoId] = useState(null);
  
  // Estados para venda manual
  const [mostrarVendaManual, setMostrarVendaManual] = useState(false);
  const [vendaEditando, setVendaEditando] = useState(null); // ID da venda sendo editada
  const [mostrarEditarVenda, setMostrarEditarVenda] = useState(false);
  const [novaVenda, setNovaVenda] = useState({
    data: new Date().toISOString().split('T')[0],
    produtoId: '',
    quantidade: 1,
    valorManual: '',
    usarValorManual: false,
    // Campos adicionais para documenta√ß√£o oficial
    numeroDocumento: '',
    tipoDocumento: 'Venda',
    formaPagamento: 'Dinheiro',
    observacoes: ''
  });
  
  // Estados para delivery apps
  const [deliveryApps, setDeliveryApps] = useState([
    { 
      id: 'uber', 
      nome: 'Uber Eats', 
      comissao: 25, 
      ativo: false, 
      cor: '#06c167',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    },
    { 
      id: 'glovo', 
      nome: 'Glovo', 
      comissao: 28, 
      ativo: false, 
      cor: '#ffc244',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    },
    { 
      id: 'bolt', 
      nome: 'Bolt Food', 
      comissao: 27, 
      ativo: false, 
      cor: '#34d186',
      dataAtualizacao: new Date().toISOString().split('T')[0]
    }
  ]);
  const [editandoApp, setEditandoApp] = useState(null);
  const [novaApp, setNovaApp] = useState({ nome: '', comissao: '25' });
  const [embalagens, setEmbalagens] = useState([]);
  const [novaEmbalagem, setNovaEmbalagem] = useState({ nome: '', custoUnitario: '', categoria: 'copos' });
  const [searchIngrediente, setSearchIngrediente] = useState('');
  const [searchIngredienteGlobal, setSearchIngredienteGlobal] = useState('');
  const [categoriaFiltro, setCategoriaFiltro] = useState('todas');
  const [searchProdutoGlobal, setSearchProdutoGlobal] = useState('');
  
  // üÜï ESTADOS PARA STOCK INTELIGENTE
  const [movimentacoesStock, setMovimentacoesStock] = useState([]);
  const [stockRastreamentoAtivo, setStockRastreamentoAtivo] = useState(true);
  const [alertasStock, setAlertasStock] = useState([]);
  const [mostrarModalMovimentacoes, setMostrarModalMovimentacoes] = useState(false);

  // Auto-save GitHub (handled by GitHubSync internally)

  const [showIngredienteSuggestions, setShowIngredienteSuggestions] = useState(false);
  const [searchIngredienteFatura, setSearchIngredienteFatura] = useState('');
  const [showIngredienteSuggestionsFatura, setShowIngredienteSuggestionsFatura] = useState(false);
  
  // ==================== NOVOS ESTADOS V2.0 ====================
  const [modalConfirmacaoFatura, setModalConfirmacaoFatura] = useState({ mostrar: false, dados: null });
  const [modalDespesaSimples, setModalDespesaSimples] = useState({ mostrar: false, dados: null }); // üÜï MODAL SIMPLES
  const [blacklist, setBlacklist] = useState([]);
  const [configuracoes, setConfiguracoes] = useState(carregarConfiguracoes());
  const [novoIngrediente, setNovoIngrediente] = useState({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
  const [editandoIngrediente, setEditandoIngrediente] = useState(false);
  const [modalContagem, setModalContagem] = useState(false);
  const [ingredienteContagem, setIngredienteContagem] = useState(null);
  const [valorContagem, setValorContagem] = useState(0);
  const [ingredienteEditandoMin, setIngredienteEditandoMin] = useState(null);
  const [valorMinEdicao, setValorMinEdicao] = useState(0);
  const [ingredienteEditandoId, setIngredienteEditandoId] = useState(null);
  const [novaDespesa, setNovaDespesa] = useState({ 
    descricao: '', 
    valor: '', 
    iva: '23', 
    data: new Date().toISOString().split('T')[0], 
    categoria: 'compras',
    fornecedor: '',
    ingredienteId: null,
    quantidade: '',
    num_funcionarios: 1,
    frequencia_pagamento: 'mensal',
    // Campos adicionais para documenta√ß√£o oficial
    numeroDocumento: '',
    tipoDocumento: 'Fatura',
    formaPagamento: 'Transfer√™ncia',
    notas: '',
    // Documento fiscal (PDF)
    documentoPDF: null, // Armazena o ficheiro PDF como base64
    nomeDocumento: '' // Nome original do ficheiro
  });
  const [searchDespesaIngrediente, setSearchDespesaIngrediente] = useState('');
  const [showDespesaSuggestions, setShowDespesaSuggestions] = useState(false);
  const [showPriceHistory, setShowPriceHistory] = useState(false);
  const [showPriceAlert, setShowPriceAlert] = useState(false);
  const [priceAlertData, setPriceAlertData] = useState(null);
  const [ordenadoDesejado, setOrdenadoDesejado] = useState(920);
  const [incluirSubsidioAlimentacao, setIncluirSubsidioAlimentacao] = useState(false);
  const [valorSubsidioAlimentacao, setValorSubsidioAlimentacao] = useState(6.00);
  const [incluirMedicinaTrabalho, setIncluirMedicinaTrabalho] = useState(false);
  const [valorMedicinaTrabalho, setValorMedicinaTrabalho] = useState(100); // ‚Ç¨100/ano (m√©dia)
  const [incluirSeguroAcidentes, setIncluirSeguroAcidentes] = useState(false);
  const [valorSeguroAcidentes, setValorSeguroAcidentes] = useState(150); // ‚Ç¨150/ano (m√©dia restaura√ß√£o)
  const [modoSimulador, setModoSimulador] = useState('fulltime'); // 'fulltime' ou 'parttime'
  const [horasSemanaisPartTime, setHorasSemanaisPartTime] = useState(8);
  const [horasSemanais, setHorasSemanais] = useState(20);
  const [valorHora, setValorHora] = useState(10);
  const [simuladorAberto, setSimuladorAberto] = useState(false);
  const [notification, setNotification] = useState(null);
  const [expandedProduct, setExpandedProduct] = useState(null);
  const [desempenhoProdutoExpanded, setDesempenhoProdutoExpanded] = useState(false);
  const [searchTakeAway, setSearchTakeAway] = useState('');
  
  // ============================================
  // üÜï FUN√á√ïES DE GEST√ÉO INTELIGENTE DE STOCK
  // ============================================
  
  // üîß Arredondar n√∫mero para evitar erros de ponto flutuante
  const arredondar = (numero, casasDecimais = 4) => {
    return Math.round(numero * Math.pow(10, casasDecimais)) / Math.pow(10, casasDecimais);
  };
  
  // Converter unidades (kg ‚Üî g, L ‚Üî ml)
  const converterParaUnidadeBase = (quantidade, unidadeOrigem, unidadeDestino) => {
    const origem = unidadeOrigem?.toLowerCase() || '';
    const destino = unidadeDestino?.toLowerCase() || '';
    
    if (origem === destino) return arredondar(quantidade);
    
    if (origem === 'kg' && destino === 'g') return arredondar(quantidade * 1000);
    if (origem === 'g' && destino === 'kg') return arredondar(quantidade / 1000);
    if (origem === 'l' && destino === 'ml') return arredondar(quantidade * 1000);
    if (origem === 'ml' && destino === 'l') return arredondar(quantidade / 1000);
    
    return arredondar(quantidade);
  };
  
  // Verificar compatibilidade de unidades
  const unidadesSaoCompativeis = (unidade1, unidade2) => {
    const u1 = unidade1?.toLowerCase() || '';
    const u2 = unidade2?.toLowerCase() || '';
    
    const unidadesPeso = ['kg', 'g'];
    const unidadesVolume = ['l', 'ml'];
    const unidadesContagem = ['un', 'unidade', 'unidades'];
    
    if (unidadesPeso.includes(u1) && unidadesPeso.includes(u2)) return true;
    if (unidadesVolume.includes(u1) && unidadesVolume.includes(u2)) return true;
    if (unidadesContagem.includes(u1) && unidadesContagem.includes(u2)) return true;
    if (u1 === u2) return true;
    
    return false;
  };
  
  // Registrar entrada de stock (compra)
  const registrarEntradaStock = (compraData) => {
    const { ingredienteId, quantidade, unidade, precoTotal, data, fornecedor, numeroDocumento } = compraData;
    
    const ingredienteIndex = ingredientes.findIndex(ing => ing.id === ingredienteId);
    if (ingredienteIndex === -1) return;
    
    const ingrediente = ingredientes[ingredienteIndex];
    const quantidadeConvertida = converterParaUnidadeBase(quantidade, unidade, ingrediente.unidade);
    
    if (!unidadesSaoCompativeis(unidade, ingrediente.unidade)) {
      console.warn(`Unidades incompat√≠veis: ${unidade} vs ${ingrediente.unidade}`);
      return;
    }
    
    const stockAnterior = arredondar(ingrediente.stockAtual || 0);
    const novoStock = arredondar(stockAnterior + quantidadeConvertida);
    const novosIngredientes = [...ingredientes];
    novosIngredientes[ingredienteIndex] = {
      ...ingrediente,
      stockAtual: novoStock
    };
    
    setIngredientes(novosIngredientes);
    
    const movimentacao = {
      id: Date.now() + Math.random(),
      data: data || new Date().toISOString().split('T')[0],
      tipo: 'entrada',
      ingredienteId: ingredienteId,
      ingredienteNome: ingrediente.nome,
      quantidade: quantidadeConvertida,
      unidade: ingrediente.unidade,
      precoUnitario: precoTotal / quantidade,
      precoTotal: precoTotal,
      stockAnterior: stockAnterior,
      stockNovo: novoStock,
      fornecedor: fornecedor || 'N/A',
      numeroDocumento: numeroDocumento || 'N/A',
      observacao: `Compra: +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
    };
    
    setMovimentacoesStock(prev => [...prev, movimentacao]);
  };
  
  // Registrar sa√≠da de stock (venda)
  const registrarSaidaStock = (vendaData) => {
    const { produtoId, quantidade, data } = vendaData;
    
    const produto = produtos.find(p => p.id === produtoId);
    if (!produto || !produto.receita || produto.receita.length === 0) return;
    
    const novosIngredientes = [...ingredientes];
    const novasMovimentacoes = [];
    
    produto.receita.forEach(receitaItem => {
      const ingredienteIndex = novosIngredientes.findIndex(ing => ing.id === receitaItem.ingredienteId);
      if (ingredienteIndex === -1) return;
      
      const ingrediente = novosIngredientes[ingredienteIndex];
      
      // üÜï CONVERTER unidade da receita para unidade do ingrediente
      const quantidadeReceitaConvertida = converterParaUnidadeBase(
        receitaItem.quantidade,
        receitaItem.unidade || ingrediente.unidade,
        ingrediente.unidade
      );
      
      const quantidadeUsada = arredondar(quantidadeReceitaConvertida * quantidade);
      const stockAnterior = arredondar(ingrediente.stockAtual || 0);
      const novoStock = arredondar(Math.max(0, stockAnterior - quantidadeUsada));
      
      novosIngredientes[ingredienteIndex] = {
        ...ingrediente,
        stockAtual: novoStock
      };
      
      const movimentacao = {
        id: Date.now() + Math.random(),
        data: data || new Date().toISOString().split('T')[0],
        tipo: 'saida',
        ingredienteId: ingrediente.id,
        ingredienteNome: ingrediente.nome,
        quantidade: quantidadeUsada,
        unidade: ingrediente.unidade,
        stockAnterior: stockAnterior,
        stockNovo: novoStock,
        produtoId: produto.id,
        produtoNome: produto.nome,
        quantidadeProdutos: quantidade,
        observacao: `Venda: -${quantidadeUsada.toFixed(2)} ${ingrediente.unidade} (${quantidade}x ${produto.nome})`
      };
      
      novasMovimentacoes.push(movimentacao);
    });
    
    setIngredientes(novosIngredientes);
    setMovimentacoesStock(prev => [...prev, ...novasMovimentacoes]);
  };
  
  // üîÑ RECALCULAR TODO O HIST√ìRICO DE MOVIMENTA√á√ïES
  const recalcularMovimentacoes = () => {
    console.log('üîÑ Bot√£o Recalcular pressionado');
    console.log('üì¶ Faturas:', faturas.length);
    console.log('üõí Vendas:', vendas.length);
    console.log('ü•ï Ingredientes:', ingredientes.length);
    
    if (!window.confirm('‚ö†Ô∏è Isso ir√° recalcular todas as movimenta√ß√µes baseado nos dados atuais.\n\n‚úÖ Ser√£o recalculadas:\n- Entradas de compras\n- Sa√≠das de vendas\n\n‚ùå Ser√£o removidos:\n- Todos os ajustes manuais\n\nDeseja continuar?')) {
      console.log('‚ùå Rec√°lculo cancelado pelo usu√°rio');
      return;
    }

    console.log('‚úÖ Iniciando rec√°lculo...');
    const novasMovimentacoes = [];
    
    // 1Ô∏è‚É£ RECALCULAR ENTRADAS (das faturas/compras)
    faturas.forEach(fatura => {
      fatura.itens.forEach(item => {
        const ingrediente = ingredientes.find(ing => ing.id === item.ingredienteId);
        if (!ingrediente) return;
        
        // Converter quantidade da fatura para unidade base do ingrediente
        const quantidadeConvertida = converterParaUnidadeBase(
          item.quantidade,
          item.unidade || ingrediente.unidade,
          ingrediente.unidade
        );
        
        const movimentacao = {
          id: Date.now() + Math.random(),
          data: fatura.data || new Date().toISOString().split('T')[0],
          tipo: 'entrada',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          quantidade: quantidadeConvertida,
          unidade: ingrediente.unidade,
          precoUnitario: item.precoTotal / item.quantidade,
          precoTotal: item.precoTotal,
          stockAnterior: 0, // Ser√° recalculado na ordena√ß√£o
          stockNovo: 0,     // Ser√° recalculado na ordena√ß√£o
          fornecedor: fatura.fornecedor || 'N/A',
          numeroDocumento: fatura.numeroDocumento || 'N/A',
          observacao: `Compra: +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
        };
        
        novasMovimentacoes.push(movimentacao);
      });
    });
    
    console.log('‚úÖ Entradas recalculadas:', novasMovimentacoes.filter(m => m.tipo === 'entrada').length);
    
    // 2Ô∏è‚É£ RECALCULAR SA√çDAS (das vendas)
    vendas.forEach(venda => {
      const produto = produtos.find(p => p.id === venda.produtoId);
      if (!produto || !produto.receita || produto.receita.length === 0) return;
      
      produto.receita.forEach(receitaItem => {
        const ingrediente = ingredientes.find(ing => ing.id === receitaItem.ingredienteId);
        if (!ingrediente) return;
        
        // Converter unidade da receita para unidade do ingrediente
        const quantidadeReceitaConvertida = converterParaUnidadeBase(
          receitaItem.quantidade,
          receitaItem.unidade || ingrediente.unidade,
          ingrediente.unidade
        );
        
        const quantidadeUsada = arredondar(quantidadeReceitaConvertida * venda.quantidade);
        
        const movimentacao = {
          id: Date.now() + Math.random(),
          data: venda.data || new Date().toISOString().split('T')[0],
          tipo: 'saida',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          quantidade: quantidadeUsada,
          unidade: ingrediente.unidade,
          stockAnterior: 0, // Ser√° recalculado na ordena√ß√£o
          stockNovo: 0,     // Ser√° recalculado na ordena√ß√£o
          produtoId: produto.id,
          produtoNome: produto.nome,
          quantidadeProdutos: venda.quantidade,
          observacao: `Venda: -${quantidadeUsada.toFixed(2)} ${ingrediente.unidade} (${venda.quantidade}x ${produto.nome})`
        };
        
        novasMovimentacoes.push(movimentacao);
      });
    });
    
    console.log('‚úÖ Sa√≠das recalculadas:', novasMovimentacoes.filter(m => m.tipo === 'saida').length);
    
    // 3Ô∏è‚É£ ORDENAR POR DATA e RECALCULAR STOCKS
    novasMovimentacoes.sort((a, b) => new Date(a.data) - new Date(b.data));
    
    const stocksPorIngrediente = {};
    
    novasMovimentacoes.forEach(mov => {
      if (!stocksPorIngrediente[mov.ingredienteId]) {
        stocksPorIngrediente[mov.ingredienteId] = 0;
      }
      
      mov.stockAnterior = stocksPorIngrediente[mov.ingredienteId];
      
      if (mov.tipo === 'entrada') {
        stocksPorIngrediente[mov.ingredienteId] += mov.quantidade;
      } else if (mov.tipo === 'saida') {
        stocksPorIngrediente[mov.ingredienteId] = Math.max(0, stocksPorIngrediente[mov.ingredienteId] - mov.quantidade);
      }
      
      mov.stockNovo = stocksPorIngrediente[mov.ingredienteId];
    });
    
    console.log('‚úÖ Stocks recalculados por ingrediente:', Object.keys(stocksPorIngrediente).length);
    
    // 4Ô∏è‚É£ ATUALIZAR STOCKS ATUAIS DOS INGREDIENTES
    const novosIngredientes = ingredientes.map(ing => ({
      ...ing,
      stockAtual: stocksPorIngrediente[ing.id] || 0
    }));
    
    console.log('‚úÖ Atualizando estado...');
    setIngredientes(novosIngredientes);
    setMovimentacoesStock(novasMovimentacoes);
    
    console.log('‚úÖ Estado atualizado! Total movimenta√ß√µes:', novasMovimentacoes.length);
    alert(`‚úÖ Hist√≥rico recalculado com sucesso!\n\nüìä Total de movimenta√ß√µes: ${novasMovimentacoes.length}\n‚Üë Entradas: ${novasMovimentacoes.filter(m => m.tipo === 'entrada').length}\n‚Üì Sa√≠das: ${novasMovimentacoes.filter(m => m.tipo === 'saida').length}`);
  };
  
  // üóëÔ∏è REMOVER MOVIMENTA√á√ÉO MANUAL (apenas ajustes)
  const removerMovimentacao = (movimentacaoId) => {
    const mov = movimentacoesStock.find(m => m.id === movimentacaoId);
    if (!mov) return;
    
    if (mov.tipo !== 'ajuste') {
      alert('‚ùå S√≥ √© poss√≠vel remover ajustes manuais.\n\nEntradas e sa√≠das s√£o geradas automaticamente das compras e vendas.');
      return;
    }
    
    if (!window.confirm(`üóëÔ∏è Remover ajuste manual?\n\nIngrediente: ${mov.ingredienteNome}\nQuantidade: ${mov.quantidade > 0 ? '+' : ''}${mov.quantidade.toFixed(2)} ${mov.unidade}\nData: ${new Date(mov.data).toLocaleDateString('pt-PT')}`)) {
      return;
    }
    
    // Remover movimenta√ß√£o
    const novasMovimentacoes = movimentacoesStock.filter(m => m.id !== movimentacaoId);
    
    // Reverter o ajuste no stock do ingrediente
    const ingrediente = ingredientes.find(ing => ing.id === mov.ingredienteId);
    if (ingrediente) {
      const novosIngredientes = ingredientes.map(ing => {
        if (ing.id === mov.ingredienteId) {
          return {
            ...ing,
            stockAtual: arredondar((ing.stockAtual || 0) - mov.quantidade)
          };
        }
        return ing;
      });
      setIngredientes(novosIngredientes);
    }
    
    setMovimentacoesStock(novasMovimentacoes);
    alert('‚úÖ Ajuste manual removido com sucesso!');
  };
  
  // Calcular desperd√≠cio real
  const calcularDesperdicio = (ingrediente) => {
    if (!ingrediente.id) return null;
    
    const movimentacoesIngrediente = movimentacoesStock.filter(m => m.ingredienteId === ingrediente.id);
    
    if (movimentacoesIngrediente.length === 0) {
      return {
        stockTeorico: ingrediente.stockAtual || 0,
        stockReal: ingrediente.stockAtual || 0,
        desperdicio: 0,
        percentualDesperdicio: 0,
        temDados: false
      };
    }
    
    let stockTeorico = 0;
    movimentacoesIngrediente.forEach(mov => {
      if (mov.tipo === 'entrada') {
        stockTeorico += mov.quantidade;
      } else if (mov.tipo === 'saida') {
        stockTeorico -= mov.quantidade;
      } else if (mov.tipo === 'ajuste') {
        stockTeorico += mov.quantidade; // ajuste pode ser + ou -
      }
    });
    
    const stockReal = ingrediente.stockAtual || 0;
    const desperdicio = Math.max(0, stockTeorico - stockReal);
    const percentualDesperdicio = stockTeorico > 0 ? (desperdicio / stockTeorico) * 100 : 0;
    
    return {
      stockTeorico,
      stockReal,
      desperdicio,
      percentualDesperdicio: parseFloat(percentualDesperdicio.toFixed(2)),
      temDados: true
    };
  };
  
  // Gerar alertas cr√≠ticos
  const gerarAlertasCriticos = () => {
    const alertas = [];
    
    ingredientes.forEach(ingrediente => {
      const stockAtual = ingrediente.stockAtual || 0;
      const stockMinimo = ingrediente.stockMinimo || 0;
      
      if (stockAtual === 0 && stockMinimo > 0) {
        alertas.push({
          id: `critical-${ingrediente.id}`,
          tipo: 'sem_stock',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          mensagem: `‚ùå SEM STOCK: ${ingrediente.nome}`,
          stockAtual: 0,
          unidade: ingrediente.unidade
        });
      } else if (stockAtual <= stockMinimo * 0.5 && stockMinimo > 0) {
        alertas.push({
          id: `low-${ingrediente.id}`,
          tipo: 'stock_critico',
          ingredienteId: ingrediente.id,
          ingredienteNome: ingrediente.nome,
          mensagem: `‚ö†Ô∏è Stock cr√≠tico: ${ingrediente.nome} (${stockAtual.toFixed(1)} ${ingrediente.unidade})`,
          stockAtual: stockAtual,
          stockMinimo: stockMinimo,
          unidade: ingrediente.unidade
        });
      }
    });
    
    return alertas;
  };
  
  // useEffect para recalcular alertas
  useEffect(() => {
    if (stockRastreamentoAtivo) {
      const alertasCriticos = gerarAlertasCriticos();
      setAlertasStock(alertasCriticos);
    }
  }, [ingredientes, stockRastreamentoAtivo]);
  
  // ============================================
  // FIM FUN√á√ïES STOCK INTELIGENTE
  // ============================================
  
  // Novos estados para Dados da Empresa
  const [dadosEmpresa, setDadosEmpresa] = useState({
    nif: '',
    nome: '',
    morada: '',
    codigoPostal: '',
    cidade: '',
    cae: '',
    email: '',
    telefone: ''
  });
  
  // Novos estados para Faturas
  const [faturas, setFaturas] = useState([]);

  // ============================================
  // üì¶ SISTEMA DE IMPORTA√á√ÉO AUTOM√ÅTICA
  // ============================================
  
  // Mapeamento de nomes Moloni/Zobaze ‚Üí Sistema
  const MAPEAMENTO_PRODUTOS = {"Expresso":"Caf√© Expresso","Bica/Expresso":"Caf√© Expresso","Expresso Take Away":"Caf√© Expresso","Bica/Take Away":"Caf√© Expresso","Meia De Leite":"Meia de Leite","Meia Leite":"Meia de Leite","Meia de Leite/White Coffee":"Meia de Leite","Meia de Leite Take Away":"Meia de Leite","Meia de Leite/White Coffee Take Away":"Meia de Leite","Capuccino":"Cappuccino","Cappuccino Take Away":"Cappuccino","Americano Take Away":"Americano","Americano/Black Coffee":"Americano","Descafeinado/Decaf":"Descafeinado","Galao":"Gal√£o","Matcha com Leite/Matcha Latte":"Matcha Latte","Matcha com Leite/Matcha Latte Take Away":"Matcha Latte","Matcha":"Matcha Latte","Matcha TG":"Matcha Latte","Cha/Tea":"Ch√°","Sumo de Laranja":"Sumo Laranja","Sumo de Laranja/Orange Juice":"Sumo Laranja","Sumo de Laranja Take Away":"Sumo Laranja","Sumo de Laranja/Take Away":"Sumo Laranja","Sumo Laranja TG":"Sumo Laranja","Sumo Caseiro Take Away":"Sumo Caseiro","Sumo Caseiro/Home made juice Take Away":"Sumo Caseiro","Mojito Picante/Spicy Mojito":"Spicy Mojito","Mojito Spicy":"Spicy Mojito","Mojito S/ Alcool":"Mojito Sem √Ålcool","Agua 1.5l":"√Ågua 1.5L","Agua Penacova 1.5L":"√Ågua 1.5L","Agua/Water 0.33l":"√Ågua 33cl","Aguas Penacova 33":"√Ågua 33cl","Aguas Penacova 50cl":"√Ågua 50cl","√Ågua Com G√°s":"√Ågua com G√°s 33cl","Agua com Gas Castello 25cl":"√Ågua com G√°s 25cl","Agua com Gas/Sparkling Water 0.33l":"√Ågua com G√°s 33cl","Cerveja Super Bock/Beer Super Bock 33l":"Cerveja Super Bock","Super Bock":"Cerveja Super Bock","Super Bock 33cl":"Cerveja Super Bock","Super Bock Stout":"Cerveja Super Bock Stout","Cerveja Preta/Stout":"Cerveja Super Bock Stout","Cerveja Artesanal 33l":"Cerveja Artesanal Mania","Cerveja Artesanal/Craft Beer 33l":"Cerveja Artesanal Mania","Castelo Rodrigo (branco) Garrafa":"Castelo Rodrigo Branco Garrafa","Castelo Rogrido Branco Copo":"Castelo Rodrigo Branco Copo","Castelo Rodrigo 100% Touriga Nacional Tinto (Beira Interior)":"Castelo Rodrigo Tinto Garrafa","Convento Aguiar Reserva Branco (Beira Interior)":"Convento Aguiar Branco Garrafa","Ladeira Santa Branco (Garrafa)":"Ladeira Santa Branco Garrafa","Ladeira da Santa Colheita Branco (Dao)":"Ladeira Santa Branco Garrafa","Ladeira da Santa 2023 Tinto (Dao)":"Ladeira Santa Tinto Garrafa","Ladeira da Santa Encruzado 2023 Tinto (Dao)":"Ladeira Santa Tinto Garrafa","Ladeira Santa Rose Copo":"Ladeira Santa Ros√© Copo","Ladeira da Santa Rose (Dao)":"Ladeira Santa Ros√© Copo","Falat√≥rio Bastardo Tinto (Lisboa)":"Falat√≥rio Bastardo Tinto","Aromas 4u Verde Copo":"Ladeira Santa Branco Copo","Aromas4U Sentido (Verde)":"Ladeira Santa Branco Garrafa","Ovos Turcos / Turkish Eggs":"Ovos Turcos","Ovos Turcos / Turkish Eggs s/picante":"Ovos Turcos","Croissant":"Olh'√≥ Croissant","Croque Monsieur":"Croque Monsieur Munchi","Croque Monsiur":"Croque Monsieur Munchi","Tosta de Abacate":"Tosta Abacate","Tosta Aberta de Abacate":"Tosta Abacate","Tosta de Requeij√£o":"Tosta Requeij√£o","Tosta de Requeij√£o":"Tosta Requeij√£o","Tosta Aberta de Requeij√£o":"Tosta Requeij√£o","Tosta Aberta de Requeij√£o":"Tosta Requeij√£o","Tosta Amendoim":"Tosta Manteiga Amendoim","Tosta Aberta de Manteiga de Amendoim":"Tosta Manteiga Amendoim","Wrap":"Wrap Ovo Bacon","Burrito":"Wrap Ovo Bacon","Rolos Crocantes picantes":"Rolos Crocantes Picante","Queijo Chevre":"Queijo Ch√®vre Flambeado","Queijo Chevre Flambeado":"Queijo Ch√®vre Flambeado","Sandes Polvo":"Sandes de Polvo","Sandes de Presunto, Brie e Mel":"Sandes Presunto TA","Sandes de Salm√£o Fumado e Salada de Ovo":"Sandes Salm√£o TA","Sandes de Salm√£o Fumado e Salada de Ovo":"Sandes Salm√£o TA","Salada de Queijo Burrata com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata e P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada de Queijo Burrata e P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada Burrata":"Salada P√™ssegos Grelhados","Salada Burrata C/Presunto":"Salada P√™ssegos Grelhados","Salada de Burrata e P√™ssego Grelhado C/ Presunto":"Salada P√™ssegos Grelhados","Salada de Burrata e P√™ssego Grelhado C/ Presunto":"Salada P√™ssegos Grelhados","Salada de Queijo Feta com P√™ssego":"Salada P√™ssegos Grelhados","Salada de Queijo Feta com P√™ssego":"Salada P√™ssegos Grelhados","Salada Feta":"Salada P√™ssegos Grelhados","Salada de Queijo com P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada de Queijo com P√™ssego Grelhado":"Salada P√™ssegos Grelhados","Salada Extra":"Salada P√™ssegos Grelhados","Bolo de Lim√£o/Lemon Cake":"Bolo de Lim√£o com Mirtilos","Bolo de Lim√£o/Lemon Cake":"Bolo de Lim√£o com Mirtilos","Bolo Lim√£o":"Bolo de Lim√£o com Mirtilos","Bolo Chocolate":"Bolo de Chocolate com Caramelo Salgado","Red Velvet":"Bolo Red Velvet com Frutos Vermelhos","Bolo Banana":"Bolo de Banana","Bolo Bolacha":"Bolo de Bolacha","Cheesecake Frutos Vermelhos":"Cheesecake de Frutos Vermelhos","Cheesecake Frutos Tropicais":"Cheesecake de Frutos Tropicais","Cheesecake frutos tropicais":"Cheesecake de Frutos Tropicais","Cheesecake Matcha":"Cheesecake de Matcha","Cheesecake Matcha Manga e Maracuja":"Cheesecake de Matcha","Cheesecake Merengue queimado":"Cheesecake Merengue Queimado","Pavlova":"Mini Pavlova de Frutos Vermelhos","Pudim Chia Frutos Vermelhos":"Pudim Chia","Pudim Chia com Matcha":"Pudim Chia Matcha","Pudin Chia Vegan":"Pudim Chia","Cebola 100":"Chutney Cebola 100ml","Cebola 100 ml":"Chutney Cebola 100ml","Cebola 250":"Chutney Cebola 250ml","Cebola 250 ml":"Chutney Cebola 250ml","Chipotle 100":"Chutney Chipotle 100ml","Chipotle 100 ml":"Chutney Chipotle 100ml","Chipotle 250":"Chutney Chipotle 250ml","Chipotle 250 ml":"Chutney Chipotle 250ml","Jalape√±os Verdes 100":"Chutney Jalape√±os Verde 100ml","Jalapenos Verde 100 ml":"Chutney Jalape√±os Verde 100ml","Jalape√±os Verdes 250":"Chutney Jalape√±os Verde 250ml","Jalapenos Verde 250 ml":"Chutney Jalape√±os Verde 250ml","Jalape√±os Vermelhos 100":"Chutney Jalape√±os Vermelho 100ml","Jalapenos Vermelhos 100 ml":"Chutney Jalape√±os Vermelho 100ml","Jalape√±os Vermelho 250":"Chutney Jalape√±os Vermelho 250ml","Jalapenos Vermelhos 250 ml":"Chutney Jalape√±os Vermelho 250ml","Pimentos Vermelhos 100":"Chutney Pimentos 100ml","Pimentos Vermelhos 100ml":"Chutney Pimentos 100ml","Pimentos Vermelhos 250ml":"Chutney Pimentos 250ml","Ab√≥bora 100":"Compota Ab√≥bora 100ml","Abobora 100 ml":"Compota Ab√≥bora 100ml","Ab√≥bora 250":"Compota Ab√≥bora 250ml","Abobora 250 ml":"Compota Ab√≥bora 250ml","Figo 100":"Compota Figo 100ml","Figo 250":"Compota Figo 250ml","Tomate 100":"Compota Tomate 100ml","Tomate 100 ml":"Compota Tomate 100ml","Tomate 250":"Compota Tomate 250ml","Tomate 250 ml":"Compota Tomate 250ml","Laranja 100":"Vinagrete Laranja 100ml","Laranja 100 ml":"Vinagrete Laranja 100ml","Laranja 250":"Vinagrete Laranja 250ml","Laranja 250 ml":"Vinagrete Laranja 250ml"};
  
  const mapearNomeProduto = (nome) => MAPEAMENTO_PRODUTOS[nome] || nome;

  
  // FUZZY MATCHING PARA VENDAS
  const findBestMatchProduto = (nomeProduto, produtos) => {
    if (!nomeProduto || !produtos || produtos.length === 0) return null;
    
    const normalize = (str) => {
      return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
    };
    
    const nomeNorm = normalize(nomeProduto);
    
    for (const prod of produtos) {
      if (normalize(prod.nome) === nomeNorm) {
        return { id: prod.id, nome: prod.nome, confianca: 100, metodo: 'exato' };
      }
    }
    
    const fuzz = window.fuzzball || window.fuzz;
    if (!fuzz) return null;
    
    let bestMatch = null;
    let bestScore = 0;
    
    for (const prod of produtos) {
      const prodNorm = normalize(prod.nome);
      let score = fuzz.ratio(nomeNorm, prodNorm);
      
      if (nomeNorm.includes(prodNorm) || prodNorm.includes(nomeNorm)) {
        score = Math.min(100, score + 10);
      }
      
      if (nomeNorm.length >= 4 && prodNorm.length >= 4 && nomeNorm.substring(0, 4) === prodNorm.substring(0, 4)) {
        score = Math.min(100, score + 5);
      }
      
      if (score > bestScore) {
        bestScore = score;
        bestMatch = { id: prod.id, nome: prod.nome, confianca: Math.round(score), metodo: 'fuzzy' };
      }
    }
    
    return bestScore >= 70 ? bestMatch : null;
  };
  
  const [mostrarImportacao, setMostrarImportacao] = useState(false);
  const [fonteImportacao, setFonteImportacao] = useState('moloni');
  const [fornecedoresExpandidos, setFornecedoresExpandidos] = useState({});
  const [mostrarBreakdownFinanceiro, setMostrarBreakdownFinanceiro] = useState(false);
  
  // Importar vendas CSV
  const importarVendasCSV = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const texto = e.target.result;
        const linhas = texto.split('\n');
        const vendasImportadas = [];
        let statsDicionario = 0, statsFuzzy = 0, statsExato = 0, statsSemMatch = 0;
        
        let startLine = 0;
        for (let i = 0; i < linhas.length; i++) {
          if (linhas[i].includes('"Data"') && linhas[i].includes('"Artigo"')) {
            startLine = i + 1;
            break;
          }
        }
        
        for (let i = startLine; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          if (!linha) continue;
          
          const campos = linha.split(';').map(c => c.replace(/"/g, '').trim());
          if (campos.length < 8) continue;
          
          const data = campos[0];
          const nomeProduto = campos[1];
          const valorStr = campos[7].replace(',', '.');
          const valor = parseFloat(valorStr);
          
          if (!data || !nomeProduto || isNaN(valor)) continue;
          
          let produto = null, confianca = 0, metodoMatch = 'nenhum';
          
          const nomeCorrigido = mapearNomeProduto(nomeProduto);
          if (nomeCorrigido !== nomeProduto) {
            produto = produtos.find(p => p.nome === nomeCorrigido);
            if (produto) { confianca = 100; metodoMatch = 'dicionario'; statsDicionario++; }
          }
          
          if (!produto) {
            const match = findBestMatchProduto(nomeProduto, produtos);
            if (match) {
              produto = produtos.find(p => p.id === match.id);
              confianca = match.confianca;
              metodoMatch = match.metodo;
              if (match.metodo === 'exato') statsExato++; else statsFuzzy++;
            } else {
              statsSemMatch++;
            }
          }
          
          let dataFormatada = data;
          if (data.match(/\d{2}-\d{2}-\d{4}/)) {
            const parts = data.split('-');
            dataFormatada = parts[2] + '-' + parts[1] + '-' + parts[0];
          }
          
          vendasImportadas.push({
            id: Date.now() + Math.random(),
            data: dataFormatada,
            produto: produto?.nome || nomeProduto,
            produtoId: produto?.id || null,
            quantidade: 1,
            valor: valor,
            iva: produto?.iva || 6,
            origem: fonteImportacao,
            confiancaMatch: confianca,
            metodoMatch: metodoMatch,
            nomeOriginalCSV: nomeProduto
          });
        }
        
        if (vendasImportadas.length > 0) {
          setVendas([...vendas, ...vendasImportadas]);
          setMostrarImportacao(false);
          
          const total = statsDicionario + statsExato + statsFuzzy;
          const pct = Math.round(total/vendasImportadas.length*100);
          
          showNotification(
            '‚úÖ ' + vendasImportadas.length + ' vendas!\n' +
            '‚úì ' + total + ' emparelhadas (' + pct + '%)\n' +
            '  ‚Ä¢ ' + statsDicionario + ' dicion√°rio\n' +
            '  ‚Ä¢ ' + statsExato + ' exato\n' +
            '  ‚Ä¢ ' + statsFuzzy + ' fuzzy\n' +
            (statsSemMatch > 0 ? '‚ö† ' + statsSemMatch + ' sem match' : ''),
            total === vendasImportadas.length ? 'success' : 'warning'
          );
          
          console.log('MOLONI:', {total: vendasImportadas.length, dicionario: statsDicionario, exato: statsExato, fuzzy: statsFuzzy, semMatch: statsSemMatch});
          if (statsSemMatch > 0) console.log('Sem match:', vendasImportadas.filter(v => !v.produtoId).map(v => v.nomeOriginalCSV));
        } else {
          alert('‚ùå Nenhuma venda v√°lida');
        }
      } catch (error) {
        console.error(error);
        alert('‚ùå Erro: ' + error.message);
      }
    };
    reader.readAsText(file, 'ISO-8859-1');
  };
  const [novaFatura, setNovaFatura] = useState({
    numero: '',
    tipoDocumento: 'fatura', // NOVO: 'fatura' ou 'recibo'
    data: new Date().toISOString().split('T')[0],
    fornecedorId: '',
    itens: [],
    notas: '',
    categoria: 'compras', // Nova: compras, renda, eletricidade, agua, gas, internet, salarios, marketing, consumiveis, manutencao, outros
    recorrente: false, // Nova: se repete mensalmente
    diaRecorrencia: 1, // Nova: dia do m√™s para repetir (1-31)
    documentoPDF: null, // PDF da fatura em base64
    nomeDocumento: '' // Nome original do ficheiro PDF
  });
  const [itemFatura, setItemFatura] = useState({
    ingredienteId: '',
    descricao: '', // Para despesas n√£o-compras
    quantidade: '',
    unidade: '',
    precoTotal: '',
    iva: '13',
    num_funcionarios: 1 // Para sal√°rios
  });
  const [criandoIngrediente, setCriandoIngrediente] = useState(false); // Modo cria√ß√£o inline
  const [showDropdownIngrediente, setShowDropdownIngrediente] = useState(false); // Controla dropdown
  const [expandedFatura, setExpandedFatura] = useState(null);
  const [searchFatura, setSearchFatura] = useState(''); // ‚úÖ SEARCH BOX FATURAS
  const [editandoFatura, setEditandoFatura] = useState(false);
  const [faturaEditando, setFaturaEditando] = useState(null);
  const [modoFormulario, setModoFormulario] = useState('completo'); // 'completo' ou 'rapido'
  const [dadosEmpresaExpanded, setDadosEmpresaExpanded] = useState(false);
  const [configuracoesExpanded, setConfiguracoesExpanded] = useState(false);
  const [categoriaFiltroDesempenho, setCategoriaFiltroDesempenho] = useState('todos');
  const [mesSelecionado, setMesSelecionado] = useState(new Date().getMonth());
  const [anoSelecionado, setAnoSelecionado] = useState(new Date().getFullYear());
  const [backupExpanded, setBackupExpanded] = useState(false);
  const [driveBackups, setDriveBackups] = useState([]); // üÜï Lista de backups dispon√≠veis
  const [showBackupRecovery, setShowBackupRecovery] = useState(false); // üÜï Modal de recovery
  const [loadingBackups, setLoadingBackups] = useState(false); // üÜï Loading ao listar backups
  const [exportarExpanded, setExportarExpanded] = useState(false);
  const [exportDateStart, setExportDateStart] = useState('');
  
  // üÜï Estados para filtros de Compras Registadas
  const [anoFaturaSelecionado, setAnoFaturaSelecionado] = useState(new Date().getFullYear());
  const [mesFaturaSelecionado, setMesFaturaSelecionado] = useState(null); // null = todos os meses
  const [fornecedorFiltro, setFornecedorFiltro] = useState(''); // '' = todos os fornecedores
  const [exportDateEnd, setExportDateEnd] = useState('');
  
  // üÜï Estado para destacar √∫ltima fatura inserida
  const [ultimaFaturaInserida, setUltimaFaturaInserida] = useState(null);
  
  // üÜï Auto-ajustar ano selecionado quando faturas mudarem
  React.useEffect(() => {
    if (faturas.length === 0) return;
    
    // Obter anos dispon√≠veis
    const anosDisponiveis = [...new Set(
      faturas
        .filter(f => f.data)
        .map(f => new Date(f.data).getFullYear())
        .filter(ano => !isNaN(ano))
    )].sort((a, b) => b - a);
    
    // Se o ano selecionado n√£o existe mais, mudar para o mais recente
    if (anosDisponiveis.length > 0 && !anosDisponiveis.includes(anoFaturaSelecionado)) {
      void 0;
      setAnoFaturaSelecionado(anosDisponiveis[0]); // Ano mais recente
    }
  }, [faturas.length, faturas]); // Trigger quando faturas mudarem
  
  // Estados OCR
  const [mostrarModalOCR, setMostrarModalOCR] = useState(false);
  const [linhasOCR, setLinhasOCR] = useState([]);
  const [metadataOCR, setMetadataOCR] = useState(null);
  const [processandoOCR, setProcessandoOCR] = useState(false);
  const [progressoOCR, setProgressoOCR] = useState('');
  
  // Verificar carregamento das bibliotecas OCR (Tesseract e Fuzzball apenas)
  
  // üÜï Carregar configura√ß√µes de waste ao inicializar
  useEffect(() => {
    const savedConfig = localStorage.getItem('configuracaoWaste');
    if (savedConfig) {
      try {
        setConfiguracaoWaste(JSON.parse(savedConfig));
      } catch (e) {
        console.error('Erro ao carregar configura√ß√£o waste:', e);
      }
    }
    
    const savedContagens = localStorage.getItem('contagens');
    if (savedContagens) {
      try {
        setContagens(JSON.parse(savedContagens));
      } catch (e) {
        console.error('Erro ao carregar contagens:', e);
      }
    }
  }, []);
  
  // üö´ LocalStorage desativado - tudo vai pro Google Drive
  // useEffect(() => {
  //   localStorage.setItem('configuracaoWaste', JSON.stringify(configuracaoWaste));
  // }, [configuracaoWaste]);
  
  // useEffect(() => {
  //   localStorage.setItem('contagens', JSON.stringify(contagens));
  // }, [contagens]);
  
  // üÜï CARREGAR MOVIMENTA√á√ïES DO INDEXEDDB (inicializa√ß√£o)
  // üö´ INDEXEDDB DESATIVADO - N√£o carrega nada
  useEffect(() => {
    console.log('üíæ IndexedDB e LocalStorage desativados - S√≥ Google Drive');
  }, []);
  
  // üö´ INDEXEDDB DESATIVADO - movimenta√ß√µes s√≥ v√£o para Google Drive
  // useEffect(() => {
  //   if (movimentacoesStock.length === 0) return;
  //   
  //   const saveData = async () => {
  //     try {
  //       await IndexedDBStorage.saveMovimentacoes(movimentacoesStock);
  //     } catch (error) {
  //       console.error('‚ùå Erro ao salvar dados:', error);
  //       
  //       // Se falhar, mostrar aviso
  //       if (error.name === 'QuotaExceededError') {
  //         alert(`‚ö†Ô∏è Espa√ßo de armazenamento cheio!\n\nTente:\n1. Fazer backup no Google Drive\n2. Exportar JSON\n3. Limpar dados antigos nas configura√ß√µes\n\nSe o problema persistir, contacte o suporte.`);
  //       }
  //     }
  //   };
  //   
  //   // Debounce para n√£o salvar a cada mudan√ßa m√≠nima
  //   const timeoutId = setTimeout(saveData, 500);
  //   return () => clearTimeout(timeoutId);
  // }, [movimentacoesStock]);


  
  // üÜï Inicializar ingredientes com campos de waste/stock quando carregarem
  useEffect(() => {
    // Verificar se algum ingrediente precisa ser inicializado
    const precisaInicializar = ingredientes.some(ing => ing.modoWaste === undefined);
    
    if (precisaInicializar && ingredientes.length > 0) {
      console.log('üîß Inicializando ingredientes com waste tracking...');
      const ingredientesInicializados = ingredientes.map(inicializarIngrediente);
      setIngredientes(ingredientesInicializados);
    }
  }, [ingredientes.length]); // Apenas quando o n√∫mero de ingredientes mudar
;
  
  useEffect(() => {
    let attempts = 0;
    const maxAttempts = 5;
    
    const checkLibraries = () => {
      const pdfjs = typeof pdfjsLib !== 'undefined';
      const tesseract = typeof Tesseract !== 'undefined';
      const fuzzball = typeof window.fuzzball !== 'undefined';
      
      if (pdfjs && tesseract && fuzzball) {
        void 0;
        showNotification('‚úÖ Sistema OCR completo pronto!', 'success');
        return true;
      }
      
      void 0;
      return false;
    };
    
    // Verificar com retry
    const checkInterval = setInterval(() => {
      attempts++;
      
      if (checkLibraries()) {
        clearInterval(checkInterval);
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        void 0;
        void 0;
        showNotification('‚ö†Ô∏è OCR pode n√£o funcionar. Tente recarregar a p√°gina.', 'warning');
      }
    }, 1000); // Verificar a cada 1 segundo
    
    
  

  return () => clearInterval(checkInterval);
  }, []);
  
  // ==================== CARREGAR BLACKLIST ====================
  useEffect(() => {
    const blacklistGuardada = localStorage.getItem('munchi_blacklist');
    if (blacklistGuardada) {
      try {
        setBlacklist(JSON.parse(blacklistGuardada));
        void 0;
      } catch (e) {
        void 0;
      }
    }
  }, []);
  
  // üîç DEBUG: Expor vari√°veis globalmente para Console
  useEffect(() => {
    window.DEBUG_MUNCHI = {
      produtos,
      ingredientes,
      vendas,
      despesas,
      fornecedores,
      faturas,
      diagnosticarPDFs: () => {
        console.log('üîç DIAGN√ìSTICO DE PDFs NAS FATURAS');
        console.log('‚ïê'.repeat(60));
        
        const faturasComPDF = faturas.filter(f => f.documentoPDF);
        const faturasSemPDF = faturas.filter(f => !f.documentoPDF);
        
        console.log(`\nüìä RESUMO:`);
        console.log(`Total de faturas: ${faturas.length}`);
        console.log(`‚úÖ Com PDF: ${faturasComPDF.length}`);
        console.log(`‚ùå Sem PDF: ${faturasSemPDF.length}`);
        
        if (faturasComPDF.length > 0) {
          console.log(`\nüìÑ AN√ÅLISE DOS PDFs:`);
          
          const analise = faturasComPDF.map(f => {
            const pdfData = f.documentoPDF || '';
            const hasPrefix = pdfData.includes('data:application/pdf;base64,');
            const base64 = hasPrefix ? pdfData.split(',')[1] : pdfData;
            const size = base64.length;
            const isValid = size > 100; // PDFs v√°lidos t√™m pelo menos 100 chars
            
            return {
              numero: f.numero || f.id,
              fornecedor: f.fornecedorNome || 'N/A',
              data: f.data,
              temPrefixo: hasPrefix ? '‚úÖ' : '‚ùå',
              tamanhoBase64: size,
              valido: isValid ? '‚úÖ' : '‚ùå VAZIO',
              tipo: f.tipo || 'FT'
            };
          });
          
          console.table(analise);
          
          const pdfsInvalidos = analise.filter(a => a.valido === '‚ùå VAZIO');
          if (pdfsInvalidos.length > 0) {
            console.log(`\n‚ö†Ô∏è ${pdfsInvalidos.length} PDF(s) VAZIO(S) OU CORROMPIDO(S):`);
            console.log('Estas faturas t√™m a propriedade documentoPDF mas o conte√∫do est√° vazio.');
            console.log('Solu√ß√£o: Apague e volte a fazer upload do PDF correto.');
          }
        }
        
        if (faturasSemPDF.length > 0) {
          console.log(`\n‚ö†Ô∏è FATURAS SEM PDF (${faturasSemPDF.length}):`);
          console.table(faturasSemPDF.map(f => ({
            numero: f.numero || f.id,
            fornecedor: f.fornecedorNome || 'N/A',
            data: f.data,
            tipo: f.tipo || 'FT',
            valor: (f.totais?.total || f.total || 0).toFixed(2) + '‚Ç¨'
          })));
          console.log('üí° Estas faturas precisam de ter o PDF anexado para dedu√ß√£o de IVA.');
        }
        
        console.log('\n' + '‚ïê'.repeat(60));
      },
      testarPDF: (numeroFatura) => {
        console.log('üß™ TESTAR PDF DA FATURA:', numeroFatura);
        console.log('‚ïê'.repeat(60));
        
        const fatura = faturas.find(f => f.numero === numeroFatura || f.id == numeroFatura);
        
        if (!fatura) {
          console.error('‚ùå Fatura n√£o encontrada:', numeroFatura);
          console.log('üí° Use: window.DEBUG_MUNCHI.faturas para ver todas as faturas');
          return;
        }
        
        if (!fatura.documentoPDF) {
          console.error('‚ùå Esta fatura n√£o tem PDF anexado');
          return;
        }
        
        console.log('üìÑ Fatura encontrada:');
        console.log('  N√∫mero:', fatura.numero);
        console.log('  Fornecedor:', fatura.fornecedorNome);
        console.log('  Data:', fatura.data);
        
        try {
          let base64Data = fatura.documentoPDF;
          
          // Extrair base64 puro
          if (base64Data.includes(',')) {
            const parts = base64Data.split(',');
            console.log('  Prefixo:', parts[0]);
            base64Data = parts[1];
          }
          
          // Limpar whitespace
          const original = base64Data.length;
          base64Data = base64Data.trim().replace(/\s/g, '');
          console.log('  Tamanho original:', original);
          console.log('  Tamanho ap√≥s limpeza:', base64Data.length);
          
          // Validar formato
          const base64Regex = /^[A-Za-z0-9+/]+=*$/;
          const formatoValido = base64Regex.test(base64Data);
          console.log('  Formato base64 v√°lido:', formatoValido ? '‚úÖ' : '‚ùå');
          
          // Verificar assinatura PDF
          const inicioPDF = base64Data.startsWith('JVBERi0');
          console.log('  Assinatura PDF (JVBERi0):', inicioPDF ? '‚úÖ' : '‚ùå');
          console.log('  Primeiros 20 chars:', base64Data.substring(0, 20));
          
          if (!formatoValido || !inicioPDF) {
            console.error('‚ùå PDF corrompido ou inv√°lido!');
            return;
          }
          
          // Tentar fazer download
          console.log('\nüîΩ A fazer download do PDF para teste...');
          
          const byteCharacters = atob(base64Data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'application/pdf' });
          
          console.log('  Tamanho do blob:', (blob.size / 1024).toFixed(2), 'KB');
          
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `TESTE_${fatura.numero.replace(/[\/\\:*?"<>|]/g, '_')}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          console.log('‚úÖ PDF baixado! Tente abrir o ficheiro.');
          console.log('üí° Se n√£o abrir, o PDF original est√° corrompido.');
          
        } catch (error) {
          console.error('‚ùå Erro ao processar PDF:', error);
        }
        
        console.log('\n' + '‚ïê'.repeat(60));
      },
      diagnosticar: () => {
        console.log('üîç DIAGN√ìSTICO MUNCHI MANAGER');
        console.log('‚ïê'.repeat(50));
        
        // 1. Produtos com custo alto
        const produtosAltos = produtos.filter(p => p.custoReceita > 50);
        if (produtosAltos.length > 0) {
          console.log('\n‚ö†Ô∏è PRODUTOS COM CUSTO > ‚Ç¨50:');
          console.table(produtosAltos.map(p => ({
            nome: p.nome,
            custoReceita: p.custoReceita,
            precoVenda: p.precoVenda,
            margem: p.precoVenda - p.custoReceita
          })));
        } else {
          console.log('\n‚úÖ Nenhum produto com custo > ‚Ç¨50');
        }
        
        // 2. Vendas com quantidade alta
        const vendasAltas = vendas.filter(v => v.quantidade > 1000);
        if (vendasAltas.length > 0) {
          console.log('\n‚ö†Ô∏è VENDAS COM QUANTIDADE > 1000:');
          console.table(vendasAltas.slice(0, 10).map(v => ({
            data: v.data,
            produto: v.produto || v.produtoId,
            quantidade: v.quantidade,
            valor: v.valor || v.total
          })));
        } else {
          console.log('\n‚úÖ Nenhuma venda com quantidade > 1000');
        }
        
        // 3. Categorias das faturas
        const categorias = {};
        faturas.forEach(f => {
          const cat = f.categoria || 'SEM_CATEGORIA';
          categorias[cat] = (categorias[cat] || 0) + 1;
        });
        console.log('\nüìä FATURAS POR CATEGORIA:');
        console.table(categorias);
        
        // 4. Faturas sem categoria
        const semCategoria = faturas.filter(f => !f.categoria);
        if (semCategoria.length > 0) {
          console.log('\n‚ö†Ô∏è FATURAS SEM CATEGORIA (' + semCategoria.length + '):');
          console.table(semCategoria.map(f => ({
            numero: f.numero || f.id,
            fornecedor: f.fornecedorNome,
            valor: (f.totais?.total || f.total || 0).toFixed(2),
            data: f.data
          })));
          console.log('üí° Edite essas faturas e defina a categoria (compras, luz, renda, agua, etc.)');
        } else {
          console.log('\n‚úÖ Todas as faturas t√™m categoria');
        }
        
        console.log('\n' + '‚ïê'.repeat(50));
        
        // 5. Sugest√£o de corre√ß√£o autom√°tica
        if (produtosAltos.length > 0) {
          console.log('\nüîß PROBLEMA DETECTADO: Custos muito altos!');
          console.log('Execute este comando para corrigir automaticamente:');
          console.log('  window.DEBUG_MUNCHI.corrigirCustos()');
        }
      },
      corrigirCustos: () => {
        console.log('üîß Corrigindo custos automaticamente...\n');
        
        let corrigidos = 0;
        const novoProdutos = produtos.map(p => {
          if (p.custoReceita > 50) {
            const custoAntigo = p.custoReceita;
            const custoNovo = p.custoReceita / 100;
            console.log(`‚úÖ ${p.nome}: ‚Ç¨${custoAntigo.toFixed(2)} ‚Üí ‚Ç¨${custoNovo.toFixed(2)}`);
            corrigidos++;
            return { ...p, custoReceita: custoNovo };
          }
          return p;
        });
        
        console.log(`\nüìä ${corrigidos} produtos corrigidos!`);
        console.log('üíæ Aplicando corre√ß√µes...');
        
        setProdutos(novoProdutos);
        
        setTimeout(() => {
          console.log('‚úÖ CORRE√á√ÉO COMPLETA!');
          console.log('As m√©tricas devem estar corretas agora.');
          console.log('Verifique o Dashboard.');
        }, 500);
      },
      recalcularTudo: () => {
        console.log('üîÑ RECALCULANDO TODOS OS CUSTOS DO ZERO...\n');
        
        const novoProdutos = produtos.map(produto => {
          if (!produto.receita || produto.receita.length === 0) {
            console.log(`‚è≠Ô∏è ${produto.nome}: Sem receita`);
            return produto;
          }
          
          // Calcular custo do zero
          const custoTotal = produto.receita.reduce((total, item) => {
            const ing = ingredientes.find(i => i.id === item.ingredienteId);
            if (!ing) return total;
            
            let quantidade = parseFloat(item.quantidade) || 0;
            const precoUnit = parseFloat(ing.custoUnitario) || 0;
            
            // Convers√£o de unidades
            const unidadeReceita = item.unidade || ing.unidade;
            if (ing.unidade === 'kg' && unidadeReceita === 'g') quantidade = quantidade / 1000;
            if (ing.unidade === 'L' && unidadeReceita === 'ml') quantidade = quantidade / 1000;
            if (ing.unidade === 'g' && unidadeReceita === 'kg') quantidade = quantidade * 1000;
            if (ing.unidade === 'ml' && unidadeReceita === 'L') quantidade = quantidade * 1000;
            
            return total + (quantidade * precoUnit);
          }, 0);
          
          // Dividir por por√ß√µes (SEM desperd√≠cio para come√ßar limpo)
          const custoFinal = (produto.porcoes && produto.porcoes > 1) 
            ? custoTotal / produto.porcoes 
            : custoTotal;
          
          const custoAntigo = produto.custoReceita || 0;
          
          if (Math.abs(custoFinal - custoAntigo) > 0.01) {
            console.log(`‚úÖ ${produto.nome}: ‚Ç¨${custoAntigo.toFixed(2)} ‚Üí ‚Ç¨${custoFinal.toFixed(2)} (${produto.porcoes || 1} por√ß√µes)`);
          }
          
          return {
            ...produto,
            custoReceita: custoFinal,
            margemLucro: produto.precoVenda > 0 ? ((produto.precoVenda - custoFinal) / produto.precoVenda) * 100 : 0
          };
        });
        
        console.log('\nüíæ Aplicando novo c√°lculo...');
        setProdutos(novoProdutos);
        
        setTimeout(() => {
          console.log('‚úÖ REC√ÅLCULO COMPLETO!');
          console.log('Recarregue a p√°gina (F5) para ver os resultados.');
        }, 500);
      },
      corrigirIngredientes: () => {
        console.log('üîß Corrigindo custos dos INGREDIENTES...\n');
        
        let corrigidos = 0;
        const novosIngredientes = ingredientes.map(ing => {
          if (ing.custoUnitario > 5) {
            const custoAntigo = ing.custoUnitario;
            const custoNovo = ing.custoUnitario / 100;
            console.log(`‚úÖ ${ing.nome}: ‚Ç¨${custoAntigo.toFixed(2)}/${ing.unidade} ‚Üí ‚Ç¨${custoNovo.toFixed(2)}/${ing.unidade}`);
            corrigidos++;
            return { ...ing, custoUnitario: custoNovo };
          }
          return ing;
        });
        
        console.log(`\nüìä ${corrigidos} ingredientes corrigidos!`);
        console.log('üíæ Aplicando corre√ß√µes...');
        
        setIngredientes(novosIngredientes);
        
        setTimeout(() => {
          console.log('‚úÖ CORRE√á√ÉO DE INGREDIENTES COMPLETA!');
          console.log('Recarregue a p√°gina (F5) para ver os resultados.');
        }, 500);
      }
    };
    
    console.log('üí° Vari√°veis dispon√≠veis no Console:');
    console.log('  - window.DEBUG_MUNCHI.produtos');
    console.log('  - window.DEBUG_MUNCHI.vendas');
    console.log('  - window.DEBUG_MUNCHI.faturas');
    console.log('  - window.DEBUG_MUNCHI.diagnosticar() ‚Üê Execute isto!');
    console.log('  - window.DEBUG_MUNCHI.diagnosticarPDFs() ‚Üê Verificar PDFs das faturas');
    console.log('  - window.DEBUG_MUNCHI.testarPDF("FT 2025/001") ‚Üê Testar PDF espec√≠fico');
    console.log('  - window.DEBUG_MUNCHI.corrigirCustos() ‚Üê Corrigir produtos');
    console.log('  - window.DEBUG_MUNCHI.corrigirIngredientes() ‚Üê Corrigir ingredientes!');
    console.log('  - window.DEBUG_MUNCHI.recalcularTudo() ‚Üê Recalcular tudo');
  }, [produtos, vendas, despesas, faturas, ingredientes, fornecedores]);
  
  const [fornecedoresExpanded, setFornecedoresExpanded] = useState(false);
  const [deliveryAppsExpanded, setDeliveryAppsExpanded] = useState(false);
  const [editandoFornecedor, setEditandoFornecedor] = useState(false);
  const [fornecedorEditandoId, setFornecedorEditandoId] = useState(null);
  const [dadosFornecedor, setDadosFornecedor] = useState({
    nome: '',
    nif: '',
    morada: '',
    email: '',
    telefone: ''
  });

  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // ==================== HANDLERS V2.0 ====================
  
  
  // ===== üÜï WASTE TRACKING & STOCK MANAGEMENT =====
  
  // Obter % de desperd√≠cio (h√≠brido: autom√°tico ou real)
  const getPercentagemDesperdicio = (ingrediente) => {
    if (!ingrediente) return 8;
    
    // Se modo manual E tem contagens hist√≥ricas
    if (ingrediente.modoWaste === 'manual' && ingrediente.historicoContagens?.length > 0) {
      const ultimas3 = ingrediente.historicoContagens.slice(-3);
      const mediaReal = ultimas3.reduce((sum, c) => sum + c.percentagem, 0) / ultimas3.length;
      return mediaReal;
    }
    
    // Se modo manual mas sem contagens (usa % categoria temporariamente)
    if (ingrediente.modoWaste === 'manual') {
      return configuracaoWaste.percentagensPorCategoria[ingrediente.categoria] || 8;
    }
    
    // Modo autom√°tico
    if (configuracaoWaste.usarCategorias) {
      return configuracaoWaste.percentagensPorCategoria[ingrediente.categoria] || 
             configuracaoWaste.percentagemGlobal;
    }
    
    return configuracaoWaste.percentagemGlobal;
  };
  
  // üÜï Inicializar ingredientes com campos de waste/stock se n√£o existirem
  const inicializarIngrediente = (ing) => {
    // Se j√° tem os campos, retornar como est√°
    if (ing.modoWaste !== undefined && ing.stockAtual !== undefined) {
      return ing;
    }
    
    // Obter % de desperd√≠cio da categoria
    const categoria = ing.categoria || 'default';
    const percentagemDesperdicio = configuracaoWaste.percentagensPorCategoria[categoria] || 8;
    
    // Obter stocks sugeridos (valores padr√£o por categoria)
    const stocksPorCategoria = {
      'vegetais': [2, 5], 'frutas': [2, 5], 'peixe': [0.5, 2], 'carnes': [1, 3],
      'lacteos': [3, 10], 'latic√≠nios': [1, 3], 'padaria': [10, 30], 'cafe': [2, 5],
      'cereais': [1, 3], 'especiarias': [0.1, 0.5], 'oleos': [2, 5], 'bebidas': [24, 100],
      'compotas': [1, 3], 'consumiveis': [1, 3], 'temperos': [0.1, 0.3],
      'pastelaria': [0.1, 0.5], 'limpeza': [5, 20], 'outros': [100, 500],
      'default': [5, 15]
    };
    
    const [stockMinimo, stockIdeal] = stocksPorCategoria[categoria] || stocksPorCategoria['default'];
    
    return {
      ...ing,
      modoWaste: ing.modoWaste || 'automatico',
      percentagemDesperdicio: ing.percentagemDesperdicio || percentagemDesperdicio,
      stockAtual: ing.stockAtual !== undefined ? ing.stockAtual : 0,
      stockMinimo: ing.stockMinimo || stockMinimo,
      stockIdeal: ing.stockIdeal || stockIdeal,
      ultimaContagem: ing.ultimaContagem || null,
      historicoContagens: ing.historicoContagens || [],
      ultimaCompra: ing.ultimaCompra || null
    };
  };

  
  // Obter status de stock (cr√≠tico, baixo, aten√ß√£o, ok)
  const getStockStatus = (ingrediente) => {
    const stock = ingrediente.stockAtual || 0;
    const minimo = ingrediente.stockMinimo || 0;
    const ideal = ingrediente.stockIdeal || 0;
    
    if (stock <= 0) {
      return {
        status: 'CRITICO',
        cor: 'red',
        icone: 'üî¥',
        mensagem: 'ESGOTADO',
        prioridade: 1
      };
    }
    
    if (stock < minimo) {
      return {
        status: 'BAIXO',
        cor: 'orange',
        icone: 'üü†',
        mensagem: 'Abaixo do m√≠nimo',
        prioridade: 2
      };
    }
    
    if (stock < ideal * 0.5) {
      return {
        status: 'ATENCAO',
        cor: 'yellow',
        icone: 'üü°',
        mensagem: 'Requer aten√ß√£o',
        prioridade: 3
      };
    }
    
    return {
      status: 'OK',
      cor: 'green',
      icone: 'üü¢',
      mensagem: 'Adequado',
      prioridade: 4
    };
  };
  
  // Toggle modo waste (autom√°tico <-> manual)
  const toggleModoWaste = (ingredienteId) => {
    setIngredientes(ingredientes.map(ing => {
      if (ing.id !== ingredienteId) return ing;
      
      const novoModo = ing.modoWaste === 'automatico' ? 'manual' : 'automatico';
      
      showNotification(
        `${ing.nome}: Modo ${novoModo === 'automatico' ? 'ü§ñ Autom√°tico' : 'üë§ Manual'}`,
        'success'
      );
      
      return {
        ...ing,
        modoWaste: novoModo
      };
    }));
  };
  
  // Calcular food cost COM desperd√≠cio
  const calcularFoodCostComDesperdicio = (produto) => {
    if (!produto.receita || produto.receita.length === 0) return 0;
    
    const custoIngredientes = produto.receita.reduce((total, item) => {
      const ingrediente = ingredientes.find(i => i.id === item.ingredienteId);
      if (!ingrediente) return total;
      
      let qtd = parseFloat(item.quantidade);
      if (item.unidade === 'g' && ingrediente.unidade === 'kg') qtd /= 1000;
      if (item.unidade === 'ml' && ingrediente.unidade === 'L') qtd /= 1000;
      
      // üî• APLICAR DESPERD√çCIO
      const custoBase = ingrediente.custoUnitario;
      const percentagemDesperdicio = getPercentagemDesperdicio(ingrediente);
      const custoAjustado = custoBase * (1 + percentagemDesperdicio / 100);
      
      return total + (qtd * custoAjustado);
    }, 0);
    
    const custoEmbalagens = (produto.embalagens || []).reduce((total, item) => {
      const embalagem = embalagens.find(e => e.id === item.embalagemId);
      return total + (embalagem ? embalagem.custoUnitario * (item.quantidade || 1) : 0);
    }, 0);
    
    return custoIngredientes + custoEmbalagens;
  };

  const handleAdicionarBlacklist = (item) => {
    const novaBlacklist = [...blacklist, item];
    setBlacklist(novaBlacklist);
    // üö´ localStorage.setItem('munchi_blacklist', JSON.stringify(novaBlacklist));
    showNotification(`‚úÖ "${item}" adicionado √† blacklist. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
  };

  const handleRemoverBlacklist = (item) => {
    const novaBlacklist = blacklist.filter(i => i !== item);
    setBlacklist(novaBlacklist);
    // üö´ localStorage.setItem('munchi_blacklist', JSON.stringify(novaBlacklist));
    showNotification(`‚úÖ "${item}" removido da blacklist. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
  };

  const handleSalvarConfiguracoes = (novasConfiguracoes) => {
    setConfiguracoes(novasConfiguracoes);
    guardarConfiguracoes(novasConfiguracoes);
    
    // Recalcular m√©tricas com novas configura√ß√µes
    const novasMetricas = recalcularMetricas(faturas, vendas, novasConfiguracoes); // ‚úÖ USAR FATURAS
    // TODO: Atualizar state de m√©tricas quando implementado
    
    showNotification('‚úÖ Configura√ß√µes guardadas!', 'success');
  };

  const handleConfirmarFatura = (dadosConfirmados) => {
    void 0;
    
    // üÜï DECIS√ÉO CR√çTICA: Verificar categoria ANTES de processar QUALQUER COISA
    const categoriaFatura = dadosConfirmados.categoria || 'compras';
    
    // Fechar Modal 1
    setModalConfirmacaoFatura({ mostrar: false, dados: null });
    
    void 0;
    
    // =============== CATEGORIA N√ÉO-COMPRAS (RENDA, LUZ, √ÅGUA, ETC) ===============
    if (categoriaFatura !== 'compras') {
      void 0;
      
      // üö´ GARANTIR que Modal 2 N√ÉO abre
      setMostrarModalOCR(false);
      setLinhasOCR([]);
      
      // Extrair valor total detectado pelo OCR
      const valorDetectado = metadataOCR?.totais?.total || 
                            (linhasOCR && linhasOCR.length > 0 ? 
                              linhasOCR.reduce((sum, l) => sum + (parseFloat(l.preco) || 0), 0) : 0);
      
      // Abrir Modal Simples (s√≥ pre√ßo e IVA)
      setModalDespesaSimples({
        mostrar: true,
        dados: {
          categoria: categoriaFatura,
          fornecedor: {
            id: dadosConfirmados.fornecedor.id,
            nome: dadosConfirmados.fornecedor.nome,
            nif: dadosConfirmados.fornecedor.nif
          },
          valorDetectado: valorDetectado,
          metadata: {
            ...metadataOCR,
            tipo: dadosConfirmados.tipo,
            numero: dadosConfirmados.numero,
            data: dadosConfirmados.data,
            atcud: dadosConfirmados.atcud,
            totais: dadosConfirmados.totais,
            categoria: categoriaFatura,
            temNifCliente: dadosConfirmados.temNifCliente || false // üÜï PASSAR NIF CLIENTE
          }
        }
      });
      
      showNotification(`Confirme os valores da ${categoriaFatura}`, 'info');
      return; // üö´ PARA AQUI - N√ÉO continua para processamento de ingredientes
    }
    
    // =============== CATEGORIA COMPRAS - PROCESSAMENTO COMPLETO ===============
    void 0;
    
    // üö´ CR√çTICO: RE-PARSEAR linhas com NIF confirmado para aplicar blacklist
    if (metadataOCR && metadataOCR.textoCompleto && dadosConfirmados.fornecedor.nif) {
      void 0;
      
      const nifConfirmado = dadosConfirmados.fornecedor.nif;
      const template = buscarTemplateOCR(nifConfirmado);
      
      if (template && template.blacklist && template.blacklist.length > 0) {
        void 0;
      }
      
      // Re-parsear com template/blacklist
      const linhasReparsed = template 
        ? parseComTemplate(metadataOCR.textoCompleto, template)
        : parseLinhasProdutos(metadataOCR.textoCompleto, nifConfirmado);
      
      void 0;
      
      // Fazer matching dos ingredientes COM sistema de aprendizagem
      const linhasComMatch = linhasReparsed.length > 0 
        ? matchIngredientes(linhasReparsed, ingredientes)
        : [];
      
      // üß† Aplicar sistema de aprendizagem IMEDIATAMENTE
      const linhasComAprendizagem = linhasComMatch.map(linha => {
        // Buscar no vocabul√°rio do fornecedor
        const resultado = buscarNoVocabulario(linha.nomeProduto, nifConfirmado);
        
        if (resultado) {
          const { ingredienteId, confianca, similaridade, confirmacoes, correcoes } = resultado;
          const ingrediente = ingredientes.find(i => i.id === ingredienteId);
          
          if (ingrediente) {
            void 0;
            
            // ‚úÖ Criar objeto ingrediente sugerido consistente
            const ing = ingredientes.find(i => i.id === ingredienteId);
            const ingredienteSugeridoObj = ing ? {
              id: ing.id,
              nome: ing.nome,
              confianca: confianca,
              metodo: 'VOCABULARIO'
            } : null;
            
            console.log(`üéØ Criando ingredienteSugerido para "${linha.nomeProduto}":`, {
              confianca: confianca,
              ingredienteSugeridoObj: ingredienteSugeridoObj,
              autoPreencherConfirmado: confianca >= 80
            });
            
            // ‚úÖ AUTO-PREENCHER SE CONFIAN√áA >= 80%
            if (confianca >= 80) {
              // üÜï APLICAR HIST√ìRICO DE COMPRAS
              const linhaBase = {
                ...linha,
                ingredienteConfirmado: ingredienteId,
                ingredienteSugerido: ingredienteSugeridoObj,
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes }
              };
              
              // Aplicar dados do hist√≥rico
              return aplicarHistoricoAoMatch(linhaBase, ingredienteId, nifConfirmado);
            } else {
              // S√≥ sugerir
              const linhaSugestao = {
                ...linha,
                ingredienteSugerido: ingredienteSugeridoObj,
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes }
              };
              
              // Aplicar hist√≥rico apenas como sugest√£o
              return aplicarHistoricoAoMatch(linhaSugestao, ingredienteId, nifConfirmado);
            }
          }
        }
        
        return linha;
      });
      
      // Atualizar linhas com blacklist aplicada E aprendizagem
      setLinhasOCR(linhasComAprendizagem);
    }
    
    // Atualizar metadata OCR com dados confirmados
    setMetadataOCR(prev => ({
      ...prev,
      tipoFatura: dadosConfirmados.tipo,
      numeroFatura: dadosConfirmados.numero,
      fornecedor: dadosConfirmados.fornecedor.nome,
      fornecedorId: dadosConfirmados.fornecedor.id,
      nif: dadosConfirmados.fornecedor.nif,
      dataFatura: dadosConfirmados.data,
      atcud: dadosConfirmados.atcud,
      totais: dadosConfirmados.totais,
      precosComIVA: dadosConfirmados.precosComIVA,
      categoria: dadosConfirmados.categoria || 'compras', // üÜï GUARDAR CATEGORIA
      temNifCliente: dadosConfirmados.temNifCliente || prev?.temNifCliente || false // üÜï NIF CLIENTE
    }));
    
    void 0;
    
    // ‚úÖ ABRIR MODAL 2 (ingredientes) - j√° sabemos que √© categoria COMPRAS
    // (se fosse outra categoria, j√° teria sa√≠do da fun√ß√£o no in√≠cio)
    if (linhasOCR && linhasOCR.length >= 0 && metadataOCR) {
      void 0;
      setMostrarModalOCR(true);
    }
    
    showNotification(`Fatura de compras confirmada!`, 'success');
  };


  const handleCancelarFatura = () => {
    setModalConfirmacaoFatura({ mostrar: false, dados: null });
  };

  /**
   * üÜï CONFIRMAR DESPESA SIMPLES (MODAL SIMPLES)
   * Salva fatura de renda/luz/√°gua sem ingredientes
   */
  const handleConfirmarDespesaSimples = (dadosDespesa) => {
    void 0;
    
    const { precoTotal, iva, categoria, fornecedor, metadata } = dadosDespesa;
    
    // Calcular valores
    const precoComIVA = precoTotal;
    const precoSemIVA = iva > 0 ? precoComIVA / (1 + iva / 100) : precoComIVA;
    const valorIVA = precoComIVA - precoSemIVA;
    
    // Criar item gen√©rico da despesa
    const item = {
      id: `despesa_${Date.now()}`,
      descricao: categoria.charAt(0).toUpperCase() + categoria.slice(1),
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoSemIVA,
      precoTotal: precoComIVA,
      subtotal: precoSemIVA,
      iva: iva,
      num_funcionarios: categoria === 'salarios' ? 1 : undefined
    };
    
    // Criar fatura completa
    const novaFaturaCompleta = {
      id: Date.now(),
      criadoEm: new Date().toISOString(), // üÜï Timestamp de cria√ß√£o
      numero: metadata?.numero || metadata?.numeroFatura || '',
      tipo: metadata?.tipo || metadata?.tipoFatura || 'FT',
      tipoDocumento: 'fatura',
      data: metadata?.data || metadata?.dataFatura || new Date().toISOString().split('T')[0],
      fornecedorId: fornecedor?.id || '',
      fornecedorNome: fornecedor?.nome || '',
      fornecedorNif: fornecedor?.nif || '',
      itens: [item],
      notas: '',
      categoria: categoria,
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: metadata?.pdfBase64 || null,
      nomeDocumento: metadata?.pdfNome || '',
      subtotal: precoSemIVA,
      totalIva: valorIVA,
      total: precoComIVA,
      totais: {
        subtotal: precoSemIVA,
        iva: valorIVA,
        total: precoComIVA
      },
      // üÜï CAMPOS DE NIF DO CLIENTE
      temNifCliente: metadata?.temNifCliente || false,
      nifCliente: metadata?.nifClienteDetetado || configuracoes.metricas.nifEmpresa || null,
      paraContabilista: (() => {
        const tipo = metadata?.tipo || metadata?.tipoFatura;
        const temNif = metadata?.temNifCliente;
        // FT e FR sempre v√£o
        if (tipo === 'FT' || tipo === 'FR') return true;
        // FS s√≥ vai se tiver NIF
        if (tipo === 'FS') return temNif === true;
        return false;
      })()
    };
    
    void 0;
    void 0;
    
    // Salvar fatura
    setFaturas([...faturas, novaFaturaCompleta]);
    setUltimaFaturaInserida(novaFaturaCompleta.id); // üÜï Marcar como √∫ltima inserida
    
    // Fechar modal
    setModalDespesaSimples({ mostrar: false, dados: null });
    
    // üö´ GARANTIR que Modal 2 N√ÉO abre
    setMostrarModalOCR(false);
    
    // Limpar estados OCR
    setLinhasOCR([]);
    setMetadataOCR(null);
    setProcessandoOCR(false);
    setProgressoOCR('');
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      tipo: 'FT',
      tipoDocumento: 'fatura',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });
    
    const labelsCategorias = {
      'renda': 'Renda',
      'eletricidade': 'Eletricidade',
      'agua': '√Ågua',
      'gas': 'G√°s',
      'internet': 'Internet',
      'salarios': 'Sal√°rios',
      'marketing': 'Marketing',
      'consumiveis': 'Consum√≠veis',
      'manutencao': 'Manuten√ß√£o',
      'outros': 'Outros'
    };
    
    showNotification(`‚úÖ ${labelsCategorias[categoria] || 'Despesa'} guardada com sucesso!`, 'success');
  };

  const handleCancelarDespesaSimples = () => {
    setModalDespesaSimples({ mostrar: false, dados: null });
    
    // üö´ GARANTIR que Modal 2 N√ÉO abre
    setMostrarModalOCR(false);
    
    // Limpar estados OCR
    setLinhasOCR([]);
    setMetadataOCR(null);
    setProcessandoOCR(false);
    setProgressoOCR('');
  };

  /**
   * üö´ FUN√á√ÉO ANTIGA - N√ÉO √â MAIS USADA (v1.1.3+)
   * Agora usamos ModalDespesaSimples em vez de salvar direto
   * 
   * üÜï SALVAR FATURA DE DESPESA DIRETA (SEM INGREDIENTES)
   * Para categorias: renda, eletricidade, agua, gas, internet, salarios, etc.
   */
  /*
  const salvarFaturaDespesaDireta = (dadosConfirmados, metadataOCR) => {
    void 0;
    
    const categoria = dadosConfirmados.categoria || metadataOCR?.categoria || 'outros';
    
    // Criar item gen√©rico da despesa (sem ingrediente)
    const totalFatura = metadataOCR?.totais?.total || 
                       dadosConfirmados.totais?.total || 
                       (linhasOCR && linhasOCR.length > 0 ? 
                         linhasOCR.reduce((sum, l) => sum + (parseFloat(l.preco) || 0), 0) : 0);
    
    // Determinar IVA baseado na categoria
    let iva = 23; // Padr√£o
    if (categoria === 'salarios') iva = 0; // Sal√°rios sem IVA
    if (categoria === 'renda') iva = 23;
    if (categoria === 'eletricidade') iva = 23;
    if (categoria === 'agua') iva = 6;
    if (categoria === 'gas') iva = 23;
    if (categoria === 'internet') iva = 23;
    
    const precoComIVA = totalFatura;
    const precoSemIVA = iva > 0 ? precoComIVA / (1 + iva / 100) : precoComIVA;
    const valorIVA = precoComIVA - precoSemIVA;
    
    const item = {
      id: `despesa_${Date.now()}`,
      descricao: categoria.charAt(0).toUpperCase() + categoria.slice(1), // Renda, Eletricidade, etc
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoSemIVA,
      precoTotal: precoComIVA,
      subtotal: precoSemIVA,
      iva: iva,
      num_funcionarios: categoria === 'salarios' ? 1 : undefined
    };
    
    void 0;
    
    // Buscar fornecedor
    let fornecedorId = '';
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (dadosConfirmados.fornecedor) {
      fornecedorId = dadosConfirmados.fornecedor.id || '';
      fornecedorNome = dadosConfirmados.fornecedor.nome || '';
      fornecedorNif = dadosConfirmados.fornecedor.nif || '';
    } else if (metadataOCR?.fornecedorId) {
      const fornecedor = fornecedores.find(f => f.id === metadataOCR.fornecedorId);
      if (fornecedor) {
        fornecedorId = fornecedor.id;
        fornecedorNome = fornecedor.nome;
        fornecedorNif = fornecedor.nif || '';
      }
    }
    
    // Criar fatura
    const novaFaturaCompleta = {
      id: Date.now(),
      numero: dadosConfirmados.numero || metadataOCR?.numeroFatura || '',
      tipo: dadosConfirmados.tipo || metadataOCR?.tipoFatura || 'FT',
      tipoDocumento: 'fatura',
      data: dadosConfirmados.data || metadataOCR?.dataFatura || new Date().toISOString().split('T')[0],
      fornecedorId: fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: '',
      categoria: categoria,
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: metadataOCR?.pdfBase64 || null,
      nomeDocumento: metadataOCR?.pdfNome || '',
      subtotal: precoSemIVA,
      totalIva: valorIVA,
      total: precoComIVA,
      totais: {
        subtotal: precoSemIVA,
        iva: valorIVA,
        total: precoComIVA
      },
      paraContabilista: (dadosConfirmados.tipo !== 'FS') // FS n√£o vai, FT e FR v√£o
    };
    
    void 0;
    void 0;
    
    // Salvar fatura
    setFaturas([...faturas, novaFaturaCompleta]);
    
    // Limpar estados OCR
    setLinhasOCR([]);
    setMetadataOCR(null);
    setProcessandoOCR(false);
    setProgressoOCR('');
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      tipo: 'FT',
      tipoDocumento: 'fatura',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });
    
    showNotification(`‚úÖ Fatura de ${categoria} guardada com sucesso!`, 'success');
  };
  */


  // ==================== üß† SISTEMA DE APRENDIZAGEM - FASE 1 ====================
  
  /**
   * Normaliza texto OCR para compara√ß√£o
   * Remove acentos, pontua√ß√£o, unidades, n√∫meros
   */
  const normalizarTexto = (texto) => {
    if (!texto) return '';
    
    return texto
      .toUpperCase()
      // Remover acentos
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      // Remover unidades comuns
      .replace(/\b(KG|GR|G|LT|L|ML|CX|UN|UND|UNID|PCT|PC|EMB)\b/gi, '')
      // Remover n√∫meros isolados
      .replace(/\b\d+\b/g, '')
      // Remover pontua√ß√£o e caracteres especiais
      .replace(/[^\w\s]/g, ' ')
      // Remover espa√ßos m√∫ltiplos
      .replace(/\s+/g, ' ')
      .trim();
  };

  /**
   * Calcula similaridade entre dois textos normalizados (0-100)
   * Usa algoritmo de Levenshtein via fuzzball
   */
  const calcularSimilaridade = (texto1, texto2) => {
    if (!texto1 || !texto2) return 0;
    if (typeof window.fuzzball === 'undefined') return 0;
    
    const norm1 = normalizarTexto(texto1);
    const norm2 = normalizarTexto(texto2);
    
    if (norm1 === norm2) return 100;
    
    try {
      return window.fuzzball.ratio(norm1, norm2);
    } catch (e) {
      void 0;
      return 0;
    }
  };

  /**
   * Busca ingrediente no vocabul√°rio do fornecedor
   * Retorna: { ingredienteId, confianca, historico } ou null
   */
   
// ==================== MUNCHI INVOICE PROCESSOR V2.0 ====================
// Este c√≥digo deve ser adicionado ap√≥s a linha 2500 do index.html
// (depois das fun√ß√µes de normaliza√ß√£o existentes)

// ==================== CONFIGURA√á√ÉO DE TIPOS DE FATURA ====================

// ==================== FUN√á√ïES DE DETEC√á√ÉO ====================

/**
 * Detecta o tipo de fatura (FT, FR ou FS)
 */
const detectarTipoFatura = (texto) => {
  if (!texto) return 'FT';
  
  // Verificar em ordem: FR, FS, FT (do mais espec√≠fico para o mais gen√©rico)
  const ordemVerificacao = ['FR', 'FS', 'FT'];
  
  for (const tipo of ordemVerificacao) {
    const config = INVOICE_TYPES[tipo];
    for (const pattern of config.patterns) {
      if (pattern.test(texto)) {
        void 0;
        return tipo;
      }
    }
  }
  
  void 0;
  return 'FT';
};

/**
 * Extrai o n√∫mero da fatura baseado no tipo
 */
const extrairNumeroFatura = (texto, tipoFatura) => {
  if (!texto) return null;
  
  const config = INVOICE_TYPES[tipoFatura];
  if (!config) return null;
  
  // ‚úÖ PR√â-PROCESSAMENTO: Limpar e normalizar texto OCR
  const textoLimpo = texto
    .replace(/\s+/g, ' ')           // Normalizar espa√ßos m√∫ltiplos
    .replace(/\s*\/\s*/g, '/')      // Remover espa√ßos ao redor de /
    .replace(/\s*-\s*/g, '-')       // Remover espa√ßos ao redor de -
    .trim();
  
  for (const pattern of config.numberPatterns) {
    const match = textoLimpo.match(pattern);
    if (match && match[1]) {
      let numero = match[1].trim();
      
      // ‚úÖ POST-PROCESSAMENTO: Limpar o n√∫mero capturado
      numero = numero
        .replace(/\s+/g, ' ')                    // Normalizar espa√ßos
        .replace(/\s*([\/\-])\s*/g, '$1')       // Remover espa√ßos ao redor de separadores
        .replace(/^(FT|FR|FS|NC|VD)\s*/i, '')   // Remover prefixo duplicado
        .replace(/\s+$/, '')                     // Remover espa√ßos finais
        .toUpperCase();
      
      // ‚úÖ VALIDA√á√ÉO: Verificar se tem conte√∫do e tamanho m√≠nimo
      const temConteudo = /[A-Z0-9]/.test(numero);
      const tamanhoOK = numero.length >= 3;
      
      if (temConteudo && tamanhoOK) {
        void 0;
        return numero;
      }
    }
  }
  
  // ‚ùå SEM FALLBACK - Se n√£o encontrou com contexto, n√£o retorna nada
  void 0;
  return null;
};

/**
 * Detecta fornecedor conhecido
 */
const detectarFornecedor = (texto, fornecedoresList = []) => {
  if (!texto) return { nome: 'Fornecedor Desconhecido', nif: '' };
  
  // 1. Tentar detectar por patterns conhecidos
  for (const [chave, fornecedor] of Object.entries(FORNECEDORES_CONHECIDOS)) {
    for (const pattern of fornecedor.patterns) {
      if (pattern.test(texto)) {
        void 0;
        
        // Procurar na lista fornecedores para pegar o ID
        const fornecedorNaLista = fornecedoresList.find(f => 
          f.nif === fornecedor.nif || f.nome.toLowerCase().includes(fornecedor.nome.toLowerCase())
        );
        
        if (fornecedorNaLista) {
          return {
            id: fornecedorNaLista.id,
            nome: fornecedorNaLista.nome,
            nif: fornecedorNaLista.nif
          };
        }
        
        return {
          chave: chave,
          nome: fornecedor.nome,
          nif: fornecedor.nif
        };
      }
    }
  }
  
  // 2. Tentar encontrar qualquer NIF no texto (m√∫ltiplos padr√µes)
  const padroesNIF = [
    /(?:NIF|N\.?I\.?F\.?)[:\s]*(\d{9})/i,
    /(?:Contribuinte)[:\s]*(\d{9})/i,
    /(?:NIPC)[:\s]*(\d{9})/i,
    /(?:N[¬∞¬∫]?\s*Contribuinte)[:\s]*(\d{9})/i,
    /PT\s*(\d{9})/,  // Formato PT 500829993
    /(\d{9})(?=\s*PT)/  // Formato 500829993 PT
  ];
  
  let nifEncontrado = null;
  for (const padrao of padroesNIF) {
    const match = texto.match(padrao);
    if (match) {
      nifEncontrado = match[1];
      console.log(`üîç [FORNECEDOR] NIF encontrado: ${nifEncontrado} (padr√£o: ${padrao})`);
      break;
    }
  }
  
  if (nifEncontrado) {
    // 3. Procurar fornecedor na lista pelo NIF
    const fornecedorEncontrado = fornecedoresList.find(f => f.nif === nifEncontrado);
    
    if (fornecedorEncontrado) {
      console.log(`üîç [FORNECEDOR] Match por NIF: ${fornecedorEncontrado.nome}`);
      return {
        id: fornecedorEncontrado.id,
        nome: fornecedorEncontrado.nome,
        nif: fornecedorEncontrado.nif
      };
    }
    
    // Verificar tamb√©m nos fornecedores conhecidos
    for (const [chave, fornecedor] of Object.entries(FORNECEDORES_CONHECIDOS)) {
      if (fornecedor.nif === nifEncontrado) {
        console.log(`üîç [FORNECEDOR] Match por NIF (conhecido): ${fornecedor.nome}`);
        return {
          chave: chave,
          nome: fornecedor.nome,
          nif: fornecedor.nif
        };
      }
    }
    
    // NIF encontrado mas fornecedor n√£o est√° na lista
    console.log(`üîç [FORNECEDOR] NIF ${nifEncontrado} n√£o encontrado na lista`);
    return {
      chave: 'desconhecido',
      nome: 'Fornecedor Desconhecido',
      nif: nifEncontrado
    };
  }
  
  // 4. FALLBACK: Tentar detectar por NOME (quando N√ÉO h√° NIF no texto)
  void 0;
  
  for (const fornecedor of fornecedoresList) {
    if (!fornecedor.nome) continue;
    
    // Normalizar nome para busca (remover acentos, lowercase)
    const nomeNormalizado = fornecedor.nome
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, ''); // Remove pontua√ß√£o
    
    const textoNormalizado = texto
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, '');
    
    // Pegar palavras significativas do nome (3+ caracteres)
    const palavrasNome = nomeNormalizado.split(/\s+/).filter(p => p.length >= 3);
    
    if (palavrasNome.length === 0) continue;
    
    // Contar quantas palavras do nome aparecem no texto
    let palavrasEncontradas = 0;
    for (const palavra of palavrasNome) {
      if (textoNormalizado.includes(palavra)) {
        palavrasEncontradas++;
      }
    }
    
    // Crit√©rio: 2+ palavras encontradas OU 1 palavra se nome tem s√≥ 1 palavra significativa
    const limiar = palavrasNome.length === 1 ? 1 : 2;
    
    if (palavrasEncontradas >= limiar) {
      void 0;
      return {
        id: fornecedor.id,
        nome: fornecedor.nome,
        nif: fornecedor.nif || ''
      };
    }
  }
  
  void 0;
  return { nome: 'Fornecedor Desconhecido', nif: '' };
};

/**
 * Extrai ATCUD da fatura
 */
const extrairATCUD = (texto) => {
  if (!texto) return null;
  
  const patterns = [
    /ATCUD:\s*([A-Z0-9-]+)/,
    /ATCUD:([A-Z0-9-]+)/
  ];
  
  for (const pattern of patterns) {
    const match = texto.match(pattern);
    if (match) {
      void 0;
      return match[1].trim();
    }
  }
  
  return null;
};

/**
 * Extrai data da fatura
 */
const extrairDataFatura = (texto) => {
  if (!texto) return new Date().toISOString().split('T')[0];
  
  // Patterns melhorados para capturar datas em v√°rios formatos
  const patterns = [
    /Data\s+de\s+Emiss√£o:\s*(\d{2})[-\/](\d{2})[-\/](\d{4})/i,
    /Data:\s*(\d{2})[-\/](\d{2})[-\/](\d{4})/i,
    /(\d{2})[-\/](\d{2})[-\/](\d{4})/,
    /(\d{4})[-\/](\d{2})[-\/](\d{2})/
  ];
  
  for (const pattern of patterns) {
    const match = texto.match(pattern);
    if (match) {
      let year, month, day;
      
      // Detectar formato baseado no comprimento do primeiro grupo
      if (match[1].length === 4) {
        // Formato YYYY-MM-DD ou YYYY/MM/DD
        year = match[1];
        month = match[2];
        day = match[3];
      } else {
        // Formato DD-MM-YYYY ou DD/MM/YYYY (padr√£o PT)
        day = match[1];
        month = match[2];
        year = match[3];
      }
      
      // Validar data
      const anoAtual = new Date().getFullYear();
      const monthNum = parseInt(month);
      const dayNum = parseInt(day);
      const yearNum = parseInt(year);
      
      // Valida√ß√µes cr√≠ticas
      if (yearNum < 2020 || yearNum > anoAtual + 1) {
        continue; // Data inv√°lida (ano fora do range razo√°vel)
      }
      
      if (monthNum < 1 || monthNum > 12 || dayNum < 1 || dayNum > 31) {
        continue; // Data inv√°lida (m√™s/dia imposs√≠vel)
      }
      
      // Verificar se dia e m√™s n√£o est√£o trocados (ex: 25/13/2025 -> trocar para 13/25/2025)
      if (monthNum > 12 && dayNum <= 12) {
        // Trocar dia e m√™s
        const temp = month;
        month = day;
        day = temp;
      }
      
      // Retornar em formato ISO (YYYY-MM-DD)
      const dataFormatada = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      void 0;
      return dataFormatada;
    }
  }
  
  // Se n√£o encontrou data v√°lida, usar data atual
  return new Date().toISOString().split('T')[0];
};

/**
 * Extrai totais da fatura (subtotal, IVA, total)
 */
const extrairTotaisFatura = (texto) => {
  if (!texto) return { subtotal: 0, iva: 0, total: 0 };
  
  const result = { subtotal: 0, iva: 0, total: 0 };
  
  // Padr√µes para subtotal
  const subtotalPatterns = [
    /Total\s+Il√≠q[:\.\s]+([\d,\.]+)‚Ç¨?/i,
    /Subtotal[:\s]+([\d,\.]+)/i,
    /Total\s+s\/\s*imp[:\s]+([\d,\.]+)/i
  ];
  
  // Padr√µes para IVA
  const ivaPatterns = [
    /IVA\s+Normal[:\s]+([\d,\.]+)‚Ç¨?/i,
    /IVA[:\s]+([\d,\.]+)‚Ç¨?/i,
    /Total\s+IVA[:\s]+([\d,\.]+)/i
  ];
  
  // Padr√µes para total
  const totalPatterns = [
    /Total\s+a\s+pagar[:\s]+([\d,\.]+)‚Ç¨?/i,
    /Total[:\s]+([\d,\.]+)‚Ç¨?\s*$/im,
    /TOTAL[:\s]+([\d,\.]+)/i
  ];
  
  // Extrair subtotal
  for (const pattern of subtotalPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.subtotal = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }
  
  // Extrair IVA
  for (const pattern of ivaPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.iva = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }
  
  // Extrair total
  for (const pattern of totalPatterns) {
    const match = texto.match(pattern);
    if (match) {
      result.total = parseFloat(match[1].replace(',', '.'));
      break;
    }
  }
  
  void 0;
  return result;
};

// ==================== PROCESSAMENTO PRINCIPAL ====================

/**
 * Processa texto OCR e extrai todos os dados da fatura
 */
const processarTextoFatura = (texto, fornecedoresList = []) => {
  void 0;
  
  const tipoFatura = detectarTipoFatura(texto);
  const numeroFatura = extrairNumeroFatura(texto, tipoFatura);
  const fornecedor = detectarFornecedor(texto, fornecedoresList); // ‚úÖ PASSAR LISTA
  const data = extrairDataFatura(texto);
  const atcud = extrairATCUD(texto);
  const totais = extrairTotaisFatura(texto);
  
  // Determinar se pre√ßos no PDF s√£o COM ou SEM IVA baseado no fornecedor
  let precosComIVA = true; // Default: pre√ßos COM IVA
  
  // MANIA CERVEJEIRA: pre√ßos SEM IVA
  if (fornecedor.nif === '278240160' || fornecedor.nome.includes('MANIA')) {
    precosComIVA = false;
  }
  
  // Recheio: pre√ßos COM IVA (padr√£o)
  if (fornecedor.nif === '9568126' || fornecedor.nome.includes('Recheio')) {
    precosComIVA = true;
  }
  
  const resultado = {
    tipo: tipoFatura,
    numero: numeroFatura || 'N/A',
    fornecedor: fornecedor,
    data: data,
    atcud: atcud,
    totais: totais,
    precosComIVA: precosComIVA, // NOVO: flag para saber se pre√ßos incluem IVA
    textoCompleto: texto
  };
  
  void 0;
  return resultado;
};

// ==================== C√ÅLCULOS DE PRE√áO COM IVA ====================

/**
 * Calcula breakdown de pre√ßo com IVA
 * @param {number} totalComIVA - Pre√ßo total com IVA
 * @param {number} quantidade - Quantidade de unidades
 * @param {number} taxaIVA - Taxa de IVA (ex: 23)
 * @returns {object} - { precoSemIVA, taxaIVA, valorIVA, precoComIVA }
 */
const calcularBreakdownPreco = (totalComIVA, quantidade, taxaIVA) => {
  const precoPorUnidadeComIVA = totalComIVA / quantidade;
  const precoPorUnidadeSemIVA = precoPorUnidadeComIVA / (1 + taxaIVA / 100);
  const valorIVAPorUnidade = precoPorUnidadeComIVA - precoPorUnidadeSemIVA;
  
  return {
    precoSemIVA: precoPorUnidadeSemIVA,
    taxaIVA: taxaIVA,
    valorIVA: valorIVAPorUnidade,
    precoComIVA: precoPorUnidadeComIVA,
    precoTotal: totalComIVA
  };
};

/**
 * Atualiza pre√ßo de ingrediente a partir de item da fatura
 * IMPORTANTE: Guarda o pre√ßo COM IVA!
 */
const atualizarPrecoIngrediente = (ingredienteId, dadosFatura, ingredientes) => {
  const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
  if (!ingrediente) {
    void 0;
    return ingredientes;
  }
  
  // Calcular breakdown de pre√ßos
  const breakdown = calcularBreakdownPreco(
    dadosFatura.precoTotal,
    dadosFatura.quantidade,
    dadosFatura.taxaIVA
  );
  
  // Atualizar ingrediente com pre√ßo COM IVA
  ingrediente.custoUnitario = breakdown.precoComIVA;
  ingrediente.taxaIVA = breakdown.taxaIVA;
  ingrediente.ultimaAtualizacao = new Date().toISOString();
  
  // Guardar info de display
  ingrediente.infoDisplay = {
    comIVA: breakdown.precoComIVA,
    semIVA: breakdown.precoSemIVA,
    valorIVA: breakdown.valorIVA
  };
  
  void 0;
  
  return [...ingredientes];
};

// ==================== C√ÅLCULOS DE MARGEM ====================

/**
 * Calcula margens de produto (markup E margem bruta)
 * @param {object} produto - Produto com precoVenda e custoReceita
 * @param {object} configuracoes - Configura√ß√µes de alertas
 * @returns {object} - Margens calculadas com status
 */
const calcularMargensProduto = (produto, configuracoes = null) => {
  const precoVenda = produto.precoVenda || 0;
  const custo = produto.custoReceita || 0;
  
  if (precoVenda === 0) return null;
  
  const lucro = precoVenda - custo;
  const markup = custo > 0 ? (lucro / custo) * 100 : 0;
  const margemBruta = (lucro / precoVenda) * 100;
  
  // Determinar status baseado nas configura√ß√µes
  let status = 'good';
  let cor = 'green';
  
  const limiarBaixo = configuracoes?.alertas?.margemBaixa || 70;
  const limiarCritico = configuracoes?.alertas?.margemCritica || 55;
  
  if (margemBruta < limiarCritico) {
    status = 'critical';
    cor = 'red';
  } else if (margemBruta < limiarBaixo) {
    status = 'warning';
    cor = 'yellow';
  }
  
  return {
    custo: custo,
    precoVenda: precoVenda,
    lucro: lucro,
    markup: markup,
    margemBruta: margemBruta,
    status: {
      status: status,
      cor: cor
    }
  };
};

// ==================== REC√ÅLCULO DE M√âTRICAS ====================

/**
 * Recalcula todas as m√©tricas ap√≥s mudan√ßas
 * Deve ser chamado ap√≥s: adicionar fatura, venda, ou mudar configura√ß√µes
 */
const recalcularMetricas = (faturas, vendas, configuracoes) => {
  void 0;
  void 0;
  void 0;
  
  const config = configuracoes || carregarConfiguracoes();
  void 0;
  
  // Calcular despesas por tipo
  const despesas = {
    FT: 0,
    FR: 0,
    FS: 0,
    total: 0
  };
  
  faturas.forEach(fatura => {
    const total = fatura.totais?.total || fatura.total || 0;
    const tipo = fatura.tipo || 'FT';
    
    void 0;
    
    if (tipo === 'FT') despesas.FT += total;
    else if (tipo === 'FR') despesas.FR += total;
    else if (tipo === 'FS') despesas.FS += total;
  });
  
  void 0;
  
  // Aplicar filtro de configura√ß√µes
  if (config.metricas.apenasOficial) {
    // Oficial LIGADO: s√≥ FT e FR (sem FS)
    despesas.total = despesas.FT + despesas.FR;
  } else {
    // Oficial DESLIGADO: tudo (FS + FT + FR)
    despesas.total = despesas.FT + despesas.FR + despesas.FS;
  }
  
  // Calcular receita
  let receita = 0;
  let vendasMoloni = 0;
  let vendasZobaze = 0;
  
  vendas.forEach(venda => {
    // Filtro baseado em modo oficial
    const eZobaze = venda.origem === 'zobaze';
    const eMoloni = venda.origem === 'moloni' || !venda.origem; // Default √© Moloni
    const total = venda.total || 0;
    
    void 0;
    
    if (eZobaze) vendasZobaze += total;
    if (eMoloni) vendasMoloni += total;
    
    if (config.metricas.apenasOficial) {
      // Oficial LIGADO: s√≥ Moloni
      if (eMoloni) {
        receita += total;
      }
    } else {
      // Oficial DESLIGADO: Moloni + Zobaze (tudo)
      receita += total;
    }
  });
  
  void 0;
  
  // Calcular COGS (Cost of Goods Sold)
  // Isto deve ser calculado baseado nas receitas dos produtos vendidos
  const cogs = 0; // TODO: implementar c√°lculo real
  
  // Margem bruta
  const margemBruta = receita - cogs;
  const margemBrutaPercent = receita > 0 ? (margemBruta / receita) * 100 : 0;
  
  // Lucro l√≠quido (s√≥ se todas as despesas estiverem preenchidas)
  const lucroLiquido = margemBruta - despesas.total;
  
  const resultado = {
    receita: receita,
    despesas: despesas,
    cogs: cogs,
    margemBruta: margemBruta,
    margemBrutaPercent: margemBrutaPercent,
    lucroLiquido: lucroLiquido,
    timestamp: new Date().toISOString()
  };
  
  void 0;
  return resultado;
};

// ==================== √çNDICE DE DESPERD√çCIO ====================

/**
 * Calcula √≠ndice de desperd√≠cio
 * F√≥rmula: (Compras - Vendas convertidas em custo) / Compras * 100
 */
const calcularIndiceDesperdicio = (comprasPeriodo, vendasPeriodo, produtos) => {
  // Total de compras
  const totalCompras = comprasPeriodo.reduce((sum, compra) => {
    return sum + (compra.totais?.total || compra.total || 0);
  }, 0);
  
  // Calcular custo real das vendas
  let custoVendas = 0;
  vendasPeriodo.forEach(venda => {
    // üîß SUPORTAR 2 FORMATOS:
    // Formato 1: venda.itens[] (array de produtos)
    // Formato 2: venda direto (produtoId + quantidade)
    
    if (venda.itens && venda.itens.length > 0) {
      // Formato 1: Array de itens
      venda.itens.forEach(item => {
        const produto = produtos.find(p => p.id === item.produtoId);
        if (produto && produto.custoReceita && produto.custoReceita > 0) {
          // ‚úÖ VALIDA√á√ïES DE SEGURAN√áA
          const custo = produto.custoReceita;
          const qtd = item.quantidade || 1;
          
          // Validar valores razo√°veis
          if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
            const custoItem = custo * qtd;
            if (custoItem < 5000) {
              custoVendas += custoItem;
            }
          }
        }
      });
    } else if (venda.produtoId) {
      // Formato 2: Venda direta
      const produto = produtos.find(p => p.id === venda.produtoId);
      if (produto && produto.custoReceita && produto.custoReceita > 0) {
        // ‚úÖ VALIDA√á√ïES DE SEGURAN√áA
        const custo = produto.custoReceita;
        const qtd = venda.quantidade || 1;
        
        // Validar valores razo√°veis
        if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
          const custoItem = custo * qtd;
          if (custoItem < 5000) {
            custoVendas += custoItem;
          }
        }
      }
    }
  });
  
  // Calcular desperd√≠cio
  const desperdicio = totalCompras - custoVendas;
  const desperdicioPercent = totalCompras > 0 ? (desperdicio / totalCompras) * 100 : 0;
  
  return {
    compras: totalCompras,
    custoVendas: custoVendas,
    desperdicio: desperdicio,
    desperdicioPercent: desperdicioPercent,
    status: desperdicioPercent > 10 ? 'alto' : 'normal'
  };
};

void 0;

  // ==================== üß† SISTEMA DE APRENDIZAGEM - CONTINUA√á√ÉO ====================
  
  const buscarNoVocabulario = (textoOCR, nifFornecedor) => {
    if (!textoOCR || !nifFornecedor) return null;
    
    const textoNorm = normalizarTexto(textoOCR);
    
    // Filtrar vocabul√°rio deste fornecedor
    const vocabFornecedor = vocabularioFornecedor.filter(
      v => v.fornecedorNIF === nifFornecedor
    );
    
    if (vocabFornecedor.length === 0) return null;
    
    // Procurar melhor match
    let melhorMatch = null;
    let melhorSimilaridade = 0;
    
    vocabFornecedor.forEach(vocab => {
      const similaridade = calcularSimilaridade(textoNorm, vocab.textoNormalizado);
      
      // üÜï THRESHOLD REDUZIDO: 60% (era 70%) - Captura mais varia√ß√µes
      if (similaridade > melhorSimilaridade && similaridade >= 60) {
        // üöÄ NOVA F√ìRMULA AGRESSIVA: Atinge 80% com apenas 2 confirma√ß√µes
        const confirmacoes = vocab.confirmacoes || 0;
        const correcoes = vocab.correcoes || 0;
        
        // üî• Fatores hist√≥ricos mais agressivos:
        // 1 confirma√ß√£o ‚Üí 85% (era 70%)
        // 2 confirma√ß√µes ‚Üí 95% (era 90%)
        // 3+ confirma√ß√µes ‚Üí 100% (era 98%)
        let fatorHistorico;
        if (confirmacoes === 1 && correcoes === 0) {
          fatorHistorico = 0.85; // 1¬™ confirma√ß√£o = 85% do potencial
        } else if (confirmacoes === 2 && correcoes === 0) {
          fatorHistorico = 0.95; // 2¬™ confirma√ß√£o = 95% (ATINGE 80% facilmente!)
        } else if (confirmacoes >= 3 && correcoes === 0) {
          fatorHistorico = 1.00; // 3+ confirma√ß√µes = 100% (certeza absoluta)
        } else {
          // Com corre√ß√µes, penalizar proporcionalmente (mas menos severo)
          fatorHistorico = Math.max(0.60, confirmacoes / (confirmacoes + correcoes * 1.5 + 1));
        }
        
        // üöÄ BOOST INICIAL: Se similaridade muito alta (90%+), dar boost extra
        let boostInicial = 1.0;
        if (confirmacoes === 1 && similaridade >= 90) {
          boostInicial = 1.05; // +5% boost para matches perfeitos na primeira vez
        }
        
        const confianca = (similaridade / 100) * fatorHistorico * boostInicial * 100;
        
        console.log(`üß† Match encontrado: "${vocab.textoOriginal}" ‚Üí Similaridade: ${similaridade}%, Confirma√ß√µes: ${confirmacoes}, Corre√ß√µes: ${correcoes}, Fator: ${(fatorHistorico*100).toFixed(0)}%, Boost: ${(boostInicial*100).toFixed(0)}%, Confian√ßa FINAL: ${Math.round(confianca)}%`);
        
        melhorMatch = {
          ingredienteId: vocab.ingredienteId,
          confianca: Math.round(confianca),
          similaridade: Math.round(similaridade),
          confirmacoes,
          correcoes,
          textoOriginal: vocab.textoOriginal
        };
        melhorSimilaridade = similaridade;
      }
    });
    
    return melhorMatch;
  };

  /**
   * Adiciona ou atualiza entrada no vocabul√°rio
   */
  const aprenderAssociacao = (textoOCR, ingredienteId, nifFornecedor, foiCorrecao = false, dadosLinha = {}) => {
    if (!textoOCR || !ingredienteId || !nifFornecedor) return;
    
    const textoNorm = normalizarTexto(textoOCR);
    
    // Verificar se j√° existe
    const indexExistente = vocabularioFornecedor.findIndex(
      v => v.fornecedorNIF === nifFornecedor && 
           v.textoNormalizado === textoNorm &&
           v.ingredienteId === ingredienteId
    );
    
    if (indexExistente >= 0) {
      // Atualizar existente
      const atualizado = [...vocabularioFornecedor];
      if (foiCorrecao) {
        atualizado[indexExistente].correcoes = (atualizado[indexExistente].correcoes || 0) + 1;
      } else {
        atualizado[indexExistente].confirmacoes = (atualizado[indexExistente].confirmacoes || 0) + 1;
      }
      atualizado[indexExistente].ultimaConfirmacao = new Date().toISOString();
      
      // üÜï Atualizar √∫ltimos valores usados (para sugest√£o futura)
      if (dadosLinha.quantidade !== undefined) {
        atualizado[indexExistente].ultimaQuantidade = dadosLinha.quantidade;
      }
      if (dadosLinha.unidade) {
        atualizado[indexExistente].ultimaUnidade = dadosLinha.unidade;
      }
      if (dadosLinha.preco !== undefined) {
        atualizado[indexExistente].ultimoPreco = dadosLinha.preco;
      }
      
      setVocabularioFornecedor(atualizado);
      
      void 0;
    } else {
      // Criar novo
      const novo = {
        id: `vocab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        fornecedorNIF: nifFornecedor,
        textoOriginal: textoOCR,
        textoNormalizado: textoNorm,
        ingredienteId: ingredienteId,
        confirmacoes: foiCorrecao ? 0 : 1,
        correcoes: foiCorrecao ? 1 : 0,
        ultimaConfirmacao: new Date().toISOString(),
        // üÜï Guardar valores da primeira vez
        ultimaQuantidade: dadosLinha.quantidade,
        ultimaUnidade: dadosLinha.unidade,
        ultimoPreco: dadosLinha.preco
      };
      
      setVocabularioFornecedor([...vocabularioFornecedor, novo]);
      void 0;
    }
  };

  // ==================== FIM SISTEMA DE APRENDIZAGEM ====================

  // ==================== üìã SISTEMA DE TEMPLATES OCR ====================
  
  const detectarLayoutFatura = (texto) => {
    const linhas = texto.split('\n').map(l => l.trim());
    const marcadoresInicio = [
      /ref.*artigo.*designa/i,
      /produto.*quantidade.*pre/i,
      /designa√ß√£o.*qtd.*pre√ßo/i
    ];
    const marcadoresFim = [
      /resumo.*impost/i,
      /total.*pagar/i,
      /informa.*banc√°ria/i
    ];
    
    let linhaInicio = -1;
    let linhaFim = linhas.length;
    
    for (let i = 0; i < linhas.length; i++) {
      if (marcadoresInicio.some(m => m.test(linhas[i]))) {
        linhaInicio = i + 1;
        break;
      }
    }
    
    for (let i = linhaInicio + 1; i < linhas.length; i++) {
      if (marcadoresFim.some(m => m.test(linhas[i]))) {
        linhaFim = i;
        break;
      }
    }
    
    return { linhaInicio: Math.max(0, linhaInicio), linhaFim };
  };
  
  const buscarTemplateOCR = (nifFornecedor) => {
    if (!nifFornecedor) return null;
    return templatesOCR.find(t => t.nifFornecedor === nifFornecedor);
  };
  
  // üö´ Extrair palavras-chave de uma linha para blacklist
  
  // üö´ Adicionar linha √† blacklist do template
  const adicionarABlacklist = (nifFornecedor, linha) => {
    void 0;
    
    if (!nifFornecedor) {
      void 0;
      showNotification('‚ùå NIF n√£o detectado! Imposs√≠vel adicionar √† blacklist.', 'error');
      return;
    }
    
    let template = buscarTemplateOCR(nifFornecedor);
    void 0;
    
    // Se n√£o existe template, criar um novo
    if (!template) {
      void 0;
      template = {
        nifFornecedor: nifFornecedor,
        linhaInicio: 0,
        linhaFim: 999,
        blacklist: [],
        palavrasLimpar: [], // üßπ Nova propriedade
        numProdutosEsperado: 0,
        vezeUsado: 0
      };
      setTemplatesOCR([...templatesOCR, template]);
    }
    
    const index = templatesOCR.findIndex(t => t.nifFornecedor === nifFornecedor);
    const blacklistAtual = template.blacklist || [];
    
    // ‚úÖ GUARDAR LINHA COMPLETA normalizada em lowercase (resolve CAPS)
    const linhaNormalizada = linha.toLowerCase().trim();
    
    // Verificar se j√° existe
    if (blacklistAtual.includes(linhaNormalizada)) {
      showNotification(`‚ö†Ô∏è "${linha}" j√° est√° na blacklist!`, 'warning');
      return;
    }
    
    const novaBlacklist = [...blacklistAtual, linhaNormalizada];
    
    void 0;
    void 0;
    
    const novoTemplate = {
      ...template,
      blacklist: novaBlacklist
    };
    
    const novos = index === -1 
      ? [...templatesOCR, novoTemplate]  // Adicionar novo
      : templatesOCR.map((t, i) => i === index ? novoTemplate : t);  // Atualizar existente
    
    setTemplatesOCR(novos);
    
    void 0;
    showNotification(`üö´ "${linha}" adicionado √† blacklist. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
  };
  
  // üßπ Adicionar palavra √† lista de limpeza
  const adicionarAPalavrasLimpar = (nifFornecedor, palavra) => {
    void 0;
    
    if (!nifFornecedor) {
      showNotification('‚ùå NIF n√£o detectado! Imposs√≠vel adicionar √† lista de limpeza.', 'error');
      return;
    }
    
    let template = buscarTemplateOCR(nifFornecedor);
    
    // Se n√£o existe template, criar um novo
    if (!template) {
      template = {
        nifFornecedor: nifFornecedor,
        linhaInicio: 0,
        linhaFim: 999,
        blacklist: [],
        palavrasLimpar: [],
        numProdutosEsperado: 0,
        vezeUsado: 0
      };
      setTemplatesOCR([...templatesOCR, template]);
    }
    
    const index = templatesOCR.findIndex(t => t.nifFornecedor === nifFornecedor);
    const palavrasAtual = template.palavrasLimpar || [];
    
    // Normalizar palavra
    const palavraNormalizada = palavra.toLowerCase().trim();
    
    // Verificar se j√° existe
    if (palavrasAtual.includes(palavraNormalizada)) {
      showNotification(`‚ö†Ô∏è "${palavra}" j√° est√° na lista de limpeza!`, 'warning');
      return;
    }
    
    const novasPalavras = [...palavrasAtual, palavraNormalizada];
    
    const novoTemplate = {
      ...template,
      palavrasLimpar: novasPalavras
    };
    
    const novos = index === -1 
      ? [...templatesOCR, novoTemplate]
      : templatesOCR.map((t, i) => i === index ? novoTemplate : t);
    
    setTemplatesOCR(novos);
    
    showNotification(`üßπ "${palavra}" adicionado √† lista de limpeza. üíæ Sincroniza com Drive para guardar!`, 'success', 5000);
  };
  
  /**
   * üÜï BUSCA HIST√ìRICO DE COMPRAS DE UM INGREDIENTE
   * Retorna dados da √∫ltima compra para auto-preencher quantidade, unidade e pre√ßo
   */
  const buscarHistoricoIngrediente = (ingredienteId, nifFornecedor = null) => {
    if (!ingredienteId) return null;
    
    // Buscar em todas as faturas salvas
    const comprasHistoricas = [];
    
    faturas.forEach(fatura => {
      // Se fornecedor espec√≠fico, filtrar
      if (nifFornecedor && fatura.fornecedorNif !== nifFornecedor) return;
      
      // Buscar itens que cont√©m esse ingrediente
      if (fatura.itens && Array.isArray(fatura.itens)) {
        fatura.itens.forEach(item => {
          if (item.ingredienteId === ingredienteId) {
            comprasHistoricas.push({
              quantidade: item.quantidade,
              unidade: item.unidade,
              precoUnitario: item.precoUnitario,
              precoTotal: item.precoTotal,
              data: fatura.data,
              fornecedorNif: fatura.fornecedorNif,
              fornecedorNome: fatura.fornecedorNome
            });
          }
        });
      }
    });
    
    // Se n√£o encontrou nada, retornar null
    if (comprasHistoricas.length === 0) return null;
    
    // Ordenar por data (mais recente primeiro)
    comprasHistoricas.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    // Retornar a compra mais recente
    const maisRecente = comprasHistoricas[0];
    
    return {
      quantidade: maisRecente.quantidade,
      unidade: maisRecente.unidade,
      precoUnitario: maisRecente.precoUnitario,
      precoTotal: maisRecente.precoTotal,
      dataUltimaCompra: maisRecente.data,
      fornecedorNif: maisRecente.fornecedorNif,
      fornecedorNome: maisRecente.fornecedorNome,
      historicoCompleto: comprasHistoricas // Para an√°lise de tend√™ncias
    };
  };

  /**
   * üÜï CALCULA ESTAT√çSTICAS DO HIST√ìRICO
   * Para mostrar varia√ß√£o de pre√ßos ao usu√°rio
   */
  const calcularEstatisticasHistorico = (ingredienteId, nifFornecedor = null) => {
    const historico = buscarHistoricoIngrediente(ingredienteId, nifFornecedor);
    
    if (!historico || !historico.historicoCompleto || historico.historicoCompleto.length === 0) {
      return null;
    }
    
    const precos = historico.historicoCompleto.map(h => h.precoUnitario);
    const precoMedio = precos.reduce((a, b) => a + b, 0) / precos.length;
    const precoMinimo = Math.min(...precos);
    const precoMaximo = Math.max(...precos);
    const variacaoPreco = precoMaximo - precoMinimo;
    const variacaoPercentual = precoMinimo > 0 ? ((variacaoPreco / precoMinimo) * 100) : 0;
    
    return {
      precoMedio,
      precoMinimo,
      precoMaximo,
      variacaoPreco,
      variacaoPercentual,
      numeroCompras: precos.length
    };
  };

  /**
   * üÜï APLICAR HIST√ìRICO AO MATCH
   * Preenche automaticamente quantidade, unidade e sugere pre√ßo baseado em compras anteriores
   */
  const aplicarHistoricoAoMatch = (linha, ingredienteId, nifFornecedor) => {
    // üÜï PRIORIDADE 1: Buscar no vocabul√°rio de aprendizagem (mais espec√≠fico)
    const vocabEntry = vocabularioFornecedor.find(
      v => v.fornecedorNIF === nifFornecedor && 
           v.ingredienteId === ingredienteId &&
           v.confirmacoes >= 2 // S√≥ usar se j√° confirmado 2+ vezes
    );
    
    if (vocabEntry) {
      void 0;
      
      return {
        ...linha,
        // Auto-preencher com √∫ltimos valores usados
        quantidade: linha.quantidade || vocabEntry.ultimaQuantidade,
        unidade: linha.unidade || vocabEntry.ultimaUnidade,
        preco: linha.preco || vocabEntry.ultimoPreco,
        // Sugest√£o de pre√ßo (sempre mostrar)
        precoSugerido: vocabEntry.ultimoPreco,
        // Flag
        preenchidoComVocabulario: true
      };
    }
    
    // FALLBACK: Buscar hist√≥rico nas faturas antigas
    const historico = buscarHistoricoIngrediente(ingredienteId, nifFornecedor);
    
    if (historico) {
      void 0;
      void 0;
      
      // Calcular estat√≠sticas
      const estatisticas = calcularEstatisticasHistorico(ingredienteId, nifFornecedor);
      
      // Auto-preencher com dados do hist√≥rico
      return {
        ...linha,
        // Se n√£o tem quantidade detectada pelo OCR, usar do hist√≥rico
        quantidade: linha.quantidade || historico.quantidade,
        // Se n√£o tem unidade detectada pelo OCR, usar do hist√≥rico
        unidade: linha.unidade || historico.unidade,
        // SEMPRE sugerir pre√ßo do hist√≥rico (usu√°rio decide se mant√©m ou atualiza)
        precoSugerido: historico.precoUnitario,
        precoTotalSugerido: historico.precoTotal,
        dataUltimaCompra: historico.dataUltimaCompra,
        // Se n√£o tem pre√ßo detectado, pr√©-preencher com sugest√£o
        preco: linha.preco || historico.precoTotal,
        // Adicionar estat√≠sticas para o usu√°rio ver
        estatisticasHistorico: estatisticas,
        // Flag para indicar que veio do hist√≥rico
        preenchidoComHistorico: true
      };
    }
    
    return linha;
  };

  const aprenderTemplateOCR = (nifFornecedor, texto, linhasValidadas) => {
    if (!nifFornecedor) return;
    
    const layout = detectarLayoutFatura(texto);
    const template = {
      nifFornecedor,
      linhaInicio: layout.linhaInicio,
      linhaFim: layout.linhaFim,
      blacklist: [], // üö´ Lista de palavras a ignorar
      numProdutosEsperado: linhasValidadas.length,
      vezeUsado: 1
    };
    
    const index = templatesOCR.findIndex(t => t.nifFornecedor === nifFornecedor);
    if (index !== -1) {
      const atual = templatesOCR[index];
      const novoTemplate = {
        ...atual,
        linhaInicio: Math.round((atual.linhaInicio + layout.linhaInicio) / 2),
        linhaFim: Math.round((atual.linhaFim + layout.linhaFim) / 2),
        blacklist: atual.blacklist || [], // Preservar blacklist
        vezeUsado: atual.vezeUsado + 1
      };
      const novos = [...templatesOCR];
      novos[index] = novoTemplate;
      setTemplatesOCR(novos);
      void 0;
    } else {
      setTemplatesOCR([...templatesOCR, template]);
      void 0;
    }
  };
  
  const parseComTemplate = (texto, template) => {
    if (!template) return parseLinhasProdutos(texto, template?.nifFornecedor);
    
    console.log('üîç [TEMPLATE] Usando parseComTemplate com template:', template.nifFornecedor);
    
    // 1. Split inicial
    let linhas = texto.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    console.log(`üîç [TEMPLATE] ${linhas.length} linhas ap√≥s split`);
    
    // 2. SEPARAR PRODUTOS COLADOS
    const linhasSeparadas = [];
    for (const linha of linhas) {
      const produtos = separarProdutosColados(linha);
      linhasSeparadas.push(...produtos);
    }
    linhas = linhasSeparadas;
    console.log(`üîç [TEMPLATE] ${linhas.length} linhas ap√≥s separa√ß√£o de produtos colados`);
    
    // 3. PROCESSAR TODAS AS LINHAS (sem linhaFim - confiar na blacklist!)
    const blacklist = template.blacklist || [];
    const palavrasLimpar = template.palavrasLimpar || []; // üßπ Palavras a limpar
    console.log(`üîç [TEMPLATE] Blacklist tem ${blacklist.length} palavras`);
    console.log(`üîç [TEMPLATE] Palavras a limpar: ${palavrasLimpar.length}`);
    
    const linhasProdutos = [];
    let linhasIgnoradasBlacklist = 0;
    let linhasIgnoradasFiltro = 0;
    
    for (let i = 0; i < linhas.length; i++) {
      const linha = linhas[i];
      if (!linha) continue;
      
      // Verificar blacklist
      const linhaLower = linha.toLowerCase();
      
      // üîç Encontrar QUAL palavra da blacklist bloqueou
      const palavrasBloqueadoras = blacklist.filter(palavra => linhaLower.includes(palavra.toLowerCase()));
      
      if (palavrasBloqueadoras.length > 0) {
        // üÜï LOG DETALHADO para template
        const mensagemBlacklist = `Bloqueada por: ${palavrasBloqueadoras.map(p => `"${p}"`).join(', ')}`;
        console.log(`üö´ [BLACKLIST/TEMPLATE] Linha bloqueada: "${linha}" - ${mensagemBlacklist}`);
        
        linhasIgnoradasBlacklist++;
        continue;
      }
      
      // Verificar filtro geral
      if (shouldIgnoreLine(linha)) {
        linhasIgnoradasFiltro++;
        continue;
      }
      
      // Parsear linha (passar palavrasLimpar)
      const parsed = parseLinha(linha, palavrasLimpar);
      if (parsed && parsed.nomeProduto) {
        linhasProdutos.push(parsed);
      }
    }
    
    console.log(`üîç [TEMPLATE] ${linhasProdutos.length} produtos detectados`);
    console.log(`üîç [TEMPLATE] ${linhasIgnoradasBlacklist} ignorados por blacklist, ${linhasIgnoradasFiltro} por filtro`);
    
    return linhasProdutos;
  };

  // ==================== FIM TEMPLATES OCR ====================


  const exportarDados = () => {
    // üíæ Nota: Este export usa os estados React atuais
    // Estes estados s√£o os mesmos que est√£o no Google Drive
    // LocalStorage N√ÉO √© usado - s√≥ Google Drive
    
    const dados = {
      versao: '2.0',
      dataExport: new Date().toISOString(),
      fonte: 'Estados React (mesmos dados do Google Drive)',
      produtos,
      ingredientes,
      vendas,
      despesas,
      fornecedores,
      dadosEmpresa,
      faturas,
      vocabularioFornecedor, // üß† Incluir aprendizagem
      templatesOCR, // üìã Incluir templates
      configuracaoWaste, // üÜï Waste tracking config
      contagens, // üÜï Hist√≥rico de contagens
      movimentacoesStock // üÜï STOCK INTELIGENTE
    };
    
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `munchi-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification('‚úÖ Backup exportado! (Dados do Google Drive)', 'success');
  };

  const importarDados = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const dados = JSON.parse(e.target.result);
        
        if (confirm('‚ö†Ô∏è Substituir todos os dados?')) {
          if (dados.produtos) setProdutos(dados.produtos);
          if (dados.ingredientes) setIngredientes(dados.ingredientes);
          if (dados.vendas) setVendas(dados.vendas);
          if (dados.despesas) setDespesas(dados.despesas);
          if (dados.fornecedores) setFornecedores(dados.fornecedores);
          if (dados.dadosEmpresa) setDadosEmpresa({
            nif: '',
            nome: '',
            morada: '',
            codigoPostal: '',
            cidade: '',
            cae: '',
            email: '',
            telefone: '',
            ...dados.dadosEmpresa
          });
          if (dados.faturas) {
            // ‚úÖ CONVERTER FATURAS ANTIGAS: tipo 'completa' ‚Üí 'FT'
            const faturasConvertidas = dados.faturas.map(f => {
              if (f.tipo === 'completa') {
                void 0;
                return {...f, tipo: 'FT'};
              }
              return f;
            });
            setFaturas(faturasConvertidas);
          }
          if (dados.vocabularioFornecedor) setVocabularioFornecedor(dados.vocabularioFornecedor); // üß† Importar aprendizagem
          if (dados.templatesOCR) setTemplatesOCR(dados.templatesOCR); // üìã Importar templates
          if (dados.configuracaoWaste) setConfiguracaoWaste(dados.configuracaoWaste); // üÜï Waste tracking config
          if (dados.contagens) setContagens(dados.contagens); // üÜï Contagens de invent√°rio
          if (dados.movimentacoesStock) setMovimentacoesStock(dados.movimentacoesStock); // üÜï STOCK INTELIGENTE
          
          // üÜï PROCESSAR HIST√ìRICO: Criar movimenta√ß√µes retroativas das vendas e despesas antigas
          setTimeout(() => {
            const novasMovimentacoes = [];
            let stocksAtualizados = {};
            
            // Inicializar stocks atuais
            if (dados.ingredientes) {
              dados.ingredientes.forEach(ing => {
                stocksAtualizados[ing.id] = ing.stockAtual || 0;
              });
            }
            
            // PROCESSAR DESPESAS/COMPRAS (entrada de stock)
            if (dados.despesas && dados.ingredientes) {
              const compras = dados.despesas.filter(d => d.categoria === 'compras' && d.ingredienteId);
              console.log(`üì¶ Processando ${compras.length} despesas de compras...`);
              
              compras
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .forEach(despesa => {
                  const ingrediente = dados.ingredientes.find(i => i.id === despesa.ingredienteId);
                  if (!ingrediente) {
                    console.warn(`‚ö†Ô∏è Ingrediente ${despesa.ingredienteId} n√£o encontrado na despesa`);
                    return;
                  }
                  
                  const quantidadeConvertida = converterParaUnidadeBase(
                    parseFloat(despesa.quantidade || 0),
                    despesa.unidade || ingrediente.unidade,
                    ingrediente.unidade
                  );
                  
                  const stockAnterior = stocksAtualizados[ingrediente.id] || 0;
                  const stockNovo = stockAnterior + quantidadeConvertida;
                  stocksAtualizados[ingrediente.id] = stockNovo;
                  
                  novasMovimentacoes.push({
                    id: Date.now() + Math.random(),
                    data: despesa.data,
                    tipo: 'entrada',
                    ingredienteId: ingrediente.id,
                    ingredienteNome: ingrediente.nome,
                    quantidade: quantidadeConvertida,
                    unidade: ingrediente.unidade,
                    stockAnterior: stockAnterior,
                    stockNovo: stockNovo,
                    fornecedor: despesa.fornecedor || 'N/A',
                    numeroDocumento: despesa.numeroDocumento || 'N/A',
                    precoTotal: parseFloat(despesa.valor || 0),
                    precoUnitario: parseFloat(despesa.valor || 0) / parseFloat(despesa.quantidade || 1),
                    observacao: `Compra: +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
                  });
                });
            }
            
            // üÜï PROCESSAR FATURAS (entrada de stock)
            if (dados.faturas && dados.ingredientes) {
              console.log(`üìÑ Processando faturas...`);
              dados.faturas
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .forEach(fatura => {
                  if (!fatura.itens || fatura.itens.length === 0) return;
                  
                  fatura.itens.forEach(item => {
                    if (!item.ingredienteId) return;
                    
                    const ingrediente = dados.ingredientes.find(i => i.id === item.ingredienteId);
                    if (!ingrediente) {
                      console.warn(`‚ö†Ô∏è Ingrediente ${item.ingredienteId} n√£o encontrado na fatura`);
                      return;
                    }
                    
                    const quantidadeConvertida = converterParaUnidadeBase(
                      parseFloat(item.quantidade || 0),
                      item.unidade || ingrediente.unidade,
                      ingrediente.unidade
                    );
                    
                    const stockAnterior = stocksAtualizados[ingrediente.id] || 0;
                    const stockNovo = stockAnterior + quantidadeConvertida;
                    stocksAtualizados[ingrediente.id] = stockNovo;
                    
                    novasMovimentacoes.push({
                      id: Date.now() + Math.random(),
                      data: fatura.data,
                      tipo: 'entrada',
                      ingredienteId: ingrediente.id,
                      ingredienteNome: ingrediente.nome,
                      quantidade: quantidadeConvertida,
                      unidade: ingrediente.unidade,
                      stockAnterior: stockAnterior,
                      stockNovo: stockNovo,
                      fornecedor: fatura.fornecedor || 'N/A',
                      numeroDocumento: fatura.numeroDocumento || fatura.numero || 'N/A',
                      precoTotal: parseFloat(item.total || 0),
                      precoUnitario: parseFloat(item.precoUnitario || 0),
                      observacao: `Compra (Fatura): +${quantidadeConvertida.toFixed(2)} ${ingrediente.unidade}`
                    });
                  });
                });
            }
            
            // PROCESSAR VENDAS (sa√≠da de stock)
            if (dados.vendas && dados.produtos && dados.ingredientes) {
              console.log(`üõí Processando ${dados.vendas.length} vendas...`);
              let vendasProcessadas = 0;
              let vendasSemReceita = 0;
              
              dados.vendas
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .forEach(venda => {
                  const produto = dados.produtos.find(p => p.id === venda.produtoId);
                  if (!produto) {
                    console.warn(`‚ö†Ô∏è Produto ${venda.produtoId} n√£o encontrado`);
                    return;
                  }
                  
                  if (!produto.receita || produto.receita.length === 0) {
                    vendasSemReceita++;
                    return;
                  }
                  
                  vendasProcessadas++;
                  produto.receita.forEach(receitaItem => {
                    const ingrediente = dados.ingredientes.find(i => i.id === receitaItem.ingredienteId);
                    if (!ingrediente) {
                      console.warn(`‚ö†Ô∏è Ingrediente ${receitaItem.ingredienteId} n√£o encontrado na receita de ${produto.nome}`);
                      return;
                    }
                    
                    // üÜï CONVERTER unidade da receita para unidade do ingrediente
                    const quantidadeReceitaConvertida = converterParaUnidadeBase(
                      receitaItem.quantidade,
                      receitaItem.unidade || ingrediente.unidade,
                      ingrediente.unidade
                    );
                    
                    const quantidadeUsada = arredondar(quantidadeReceitaConvertida * parseFloat(venda.quantidade || 1));
                    const stockAnterior = arredondar(stocksAtualizados[ingrediente.id] || 0);
                    const stockNovo = arredondar(Math.max(0, stockAnterior - quantidadeUsada));
                    stocksAtualizados[ingrediente.id] = stockNovo;
                    
                    novasMovimentacoes.push({
                      id: Date.now() + Math.random(),
                      data: venda.data,
                      tipo: 'saida',
                      ingredienteId: ingrediente.id,
                      ingredienteNome: ingrediente.nome,
                      quantidade: quantidadeUsada,
                      unidade: ingrediente.unidade,
                      stockAnterior: stockAnterior,
                      stockNovo: stockNovo,
                      produtoId: produto.id,
                      produtoNome: produto.nome,
                      quantidadeProdutos: parseFloat(venda.quantidade || 1),
                      observacao: `Venda: -${quantidadeUsada.toFixed(2)} ${ingrediente.unidade} (${venda.quantidade}x ${produto.nome})`
                    });
                  });
                });
              
              console.log(`‚úÖ Vendas processadas: ${vendasProcessadas} (${vendasSemReceita} sem receita)`);
            }
            
            // Adicionar movimenta√ß√µes antigas √†s existentes (se houver no JSON)
            const movimentacoesFinais = [...(dados.movimentacoesStock || []), ...novasMovimentacoes];
            setMovimentacoesStock(movimentacoesFinais);
            
            // Atualizar stocks dos ingredientes
            if (dados.ingredientes) {
              const ingredientesAtualizados = dados.ingredientes.map(ing => ({
                ...ing,
                stockAtual: stocksAtualizados[ing.id] !== undefined ? stocksAtualizados[ing.id] : ing.stockAtual
              }));
              setIngredientes(ingredientesAtualizados);
            }
            
            const entradas = novasMovimentacoes.filter(m => m.tipo === 'entrada').length;
            const saidas = novasMovimentacoes.filter(m => m.tipo === 'saida').length;
            console.log(`‚úÖ TOTAL: ${novasMovimentacoes.length} movimenta√ß√µes (${entradas} entradas, ${saidas} sa√≠das)`);
          }, 500);
          
          showNotification('Dados importados com sucesso!', 'success');
          // Navegar para dashboard com subtab resumo
          setActiveTab('dashboard');
          setDashboardSubTab('resumo');
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }, 100);
          event.target.value = '';
        }
      } catch (error) {
        showNotification('Erro ao importar!', 'error');
      }
    };
    reader.readAsText(file);
  };
  
  // ========== FUN√á√ïES DE EXPORT CSV ==========
  
  const exportarVendasCSV = () => {
    if (!vendas || (vendas || []).length === 0) {
      showNotification('Nenhuma venda para exportar!', 'error');
      return;
    }

    const filteredVendas = getFilteredData(vendas);
    
    if (filteredVendas.length === 0) {
      showNotification('Nenhuma venda no per√≠odo selecionado!', 'error');
      return;
    }

    // ===== EXPORT OFICIAL PARA CONTABILIDADE =====
    // Informa√ß√µes completas conforme requisitos legais em Portugal
    
    // Cabe√ßalho com dados da empresa
    const empresaInfo = [
      '===== RELAT√ìRIO OFICIAL DE VENDAS =====',
      `Empresa: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      `Per√≠odo: ${filteredVendas[0] ? new Date(filteredVendas[0].data).toLocaleDateString('pt-PT') : ''} a ${filteredVendas[filteredVendas.length - 1] ? new Date(filteredVendas[filteredVendas.length - 1].data).toLocaleDateString('pt-PT') : ''}`,
      `Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Registos: ${filteredVendas.length}`,
      '',
      '===== DETALHE DAS VENDAS =====',
      ''
    ];
    
    // Headers CSV detalhados para contabilidade
    const headers = [
      'Data',
      'Produto/Servi√ßo',
      'Quantidade',
      'Unidade',
      'Pre√ßo Unit√°rio (s/ IVA)',
      'Valor Base (s/ IVA)',
      'Taxa IVA (%)',
      'Valor IVA',
      'Valor Total (c/ IVA)',
      'Tipo Documento',
      'N¬∫ Documento',
      'Observa√ß√µes'
    ];
    
    // Build CSV rows com todas as informa√ß√µes
    const rows = filteredVendas.map((v, index) => {
      const valorBase = v.valor;
      const valorIva = valorBase * (v.iva / 100);
      const valorTotal = valorBase + valorIva;
      const precoUnitario = v.quantidade > 0 ? valorBase / v.quantidade : 0;
      
      return [
        new Date(v.data).toISOString().split('T')[0], // Data formato ISO
        `"${v.produto}"`,
        v.quantidade || 1,
        'un',
        precoUnitario.toFixed(2),
        valorBase.toFixed(2),
        v.iva,
        valorIva.toFixed(2),
        valorTotal.toFixed(2),
        'Venda',
        `VND-${new Date(v.data).getFullYear()}-${String(index + 1).padStart(6, '0')}`,
        `"${v.observacoes || ''}"`
      ].join(';');
    });
    
    // Resumo por taxa de IVA
    const resumoIVA = {};
    filteredVendas.forEach(v => {
      const taxa = v.iva;
      if (!resumoIVA[taxa]) {
        resumoIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = v.valor;
      const valorIva = valorBase * (taxa / 100);
      resumoIVA[taxa].base += valorBase;
      resumoIVA[taxa].iva += valorIva;
      resumoIVA[taxa].total += valorBase + valorIva;
      resumoIVA[taxa].count++;
    });
    
    const resumoSection = [
      '',
      '',
      '===== RESUMO POR TAXA DE IVA =====',
      'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;Valor IVA;Total',
      ...Object.entries(resumoIVA).map(([taxa, valores]) => 
        `${taxa}%;${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
      ),
      '',
      '===== TOTAIS GERAIS =====',
      `Total Base Tribut√°vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.base, 0).toFixed(2)}`,
      `Total IVA;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total Geral;${Object.values(resumoIVA).reduce((sum, v) => sum + v.total, 0).toFixed(2)}`,
      '',
      '',
      '===== INFORMA√á√ïES LEGAIS =====',
      'Este documento cont√©m informa√ß√£o fiscal relevante para efeitos de contabilidade e declara√ß√µes fiscais.',
      'Deve ser conservado de acordo com os prazos legais estabelecidos.',
      `Gerado automaticamente pelo sistema Munchi Manager em ${new Date().toLocaleString('pt-PT')}`
    ];
    
    // Create CSV content
    const csvContent = [
      ...empresaInfo,
      headers.join(';'),
      ...rows,
      ...resumoSection
    ].join('\n');
    
    // Download com BOM para Excel reconhecer UTF-8
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nome do ficheiro com per√≠odo
    const dataInicio = new Date(filteredVendas[0].data);
    const dataFim = new Date(filteredVendas[filteredVendas.length - 1].data);
    const nomeArquivo = `VENDAS_APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(`‚úÖ ${filteredVendas.length} vendas exportadas! Para vendas via Moloni/software certificado, n√£o √© necess√°rio enviar PDFs.`, 'success');
  };
  
  const exportarDespesasCSV = () => {
    if (!despesas || (despesas || []).length === 0) {
      showNotification('Nenhuma despesa para exportar!', 'error');
      return;
    }

    const filteredDespesas = getFilteredData(despesas);
    
    if (filteredDespesas.length === 0) {
      showNotification('Nenhuma despesa no per√≠odo selecionado!', 'error');
      return;
    }

    // ===== EXPORT OFICIAL PARA CONTABILIDADE =====
    // Informa√ß√µes completas conforme requisitos legais em Portugal
    
    // Cabe√ßalho com dados da empresa
    const empresaInfo = [
      '===== RELAT√ìRIO OFICIAL DE DESPESAS =====',
      `Empresa: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      `Per√≠odo: ${filteredDespesas[0] ? new Date(filteredDespesas[0].data).toLocaleDateString('pt-PT') : ''} a ${filteredDespesas[filteredDespesas.length - 1] ? new Date(filteredDespesas[filteredDespesas.length - 1].data).toLocaleDateString('pt-PT') : ''}`,
      `Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Registos: ${filteredDespesas.length}`,
      '',
      '===== DETALHE DAS DESPESAS =====',
      ''
    ];
    
    // Headers CSV detalhados para contabilidade
    const headers = [
      'Data',
      'N¬∫ Documento',
      'Tipo Documento',
      'Fornecedor',
      'NIF Fornecedor',
      'Categoria',
      'Descri√ß√£o',
      'Valor Base (s/ IVA)',
      'Taxa IVA (%)',
      'Valor IVA',
      'Valor Total (c/ IVA)',
      'Forma Pagamento',
      'Dedut√≠vel IVA',
      'Observa√ß√µes'
    ];
    
    // Build CSV rows com todas as informa√ß√µes
    const rows = filteredDespesas.map((d, index) => {
      const valorBase = d.valor;
      const valorIva = valorBase * (d.iva / 100);
      const valorTotal = valorBase + valorIva;
      
      // Encontrar fornecedor para obter NIF
      let fornecedorObj = null;
      if (d.fornecedor) {
        fornecedorObj = fornecedores.find(f => 
          (typeof f === 'object' && f.nome === d.fornecedor) || 
          (typeof f === 'string' && f === d.fornecedor)
        );
      }
      
      const fornecedorNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
      const fornecedorNome = d.fornecedor || 'N/A';
      
      // Determinar se IVA √© dedut√≠vel (geralmente sim para despesas de neg√≥cio)
      const dedutivelIVA = d.iva > 0 ? 'Sim' : 'N/A';
      
      return [
        new Date(d.data).toISOString().split('T')[0], // Data formato ISO
        d.numeroDocumento || `DSP-${new Date(d.data).getFullYear()}-${String(index + 1).padStart(6, '0')}`,
        d.tipoDocumento || 'Fatura',
        `"${fornecedorNome}"`,
        fornecedorNif,
        `"${d.categoria}"`,
        `"${d.descricao}"`,
        valorBase.toFixed(2),
        d.iva,
        valorIva.toFixed(2),
        valorTotal.toFixed(2),
        d.formaPagamento || 'Transfer√™ncia',
        dedutivelIVA,
        `"${d.notas || ''}"`
      ].join(';');
    });
    
    // Resumo por categoria
    const resumoCategoria = {};
    filteredDespesas.forEach(d => {
      const cat = d.categoria || 'Sem Categoria';
      if (!resumoCategoria[cat]) {
        resumoCategoria[cat] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = d.valor;
      const valorIva = valorBase * (d.iva / 100);
      resumoCategoria[cat].base += valorBase;
      resumoCategoria[cat].iva += valorIva;
      resumoCategoria[cat].total += valorBase + valorIva;
      resumoCategoria[cat].count++;
    });
    
    // Resumo por taxa de IVA
    const resumoIVA = {};
    filteredDespesas.forEach(d => {
      const taxa = d.iva;
      if (!resumoIVA[taxa]) {
        resumoIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
      }
      const valorBase = d.valor;
      const valorIva = valorBase * (taxa / 100);
      resumoIVA[taxa].base += valorBase;
      resumoIVA[taxa].iva += valorIva;
      resumoIVA[taxa].total += valorBase + valorIva;
      resumoIVA[taxa].count++;
    });
    
    const resumoSection = [
      '',
      '',
      '===== RESUMO POR CATEGORIA =====',
      'Categoria;N¬∫ Opera√ß√µes;Valor Base;Valor IVA;Total',
      ...Object.entries(resumoCategoria)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([cat, valores]) => 
          `"${cat}";${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
        ),
      '',
      '===== RESUMO POR TAXA DE IVA =====',
      'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;Valor IVA;Total',
      ...Object.entries(resumoIVA).map(([taxa, valores]) => 
        `${taxa}%;${valores.count};${valores.base.toFixed(2)};${valores.iva.toFixed(2)};${valores.total.toFixed(2)}`
      ),
      '',
      '===== TOTAIS GERAIS =====',
      `Total Base Tribut√°vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.base, 0).toFixed(2)}`,
      `Total IVA Suportado;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total IVA Dedut√≠vel;${Object.values(resumoIVA).reduce((sum, v) => sum + v.iva, 0).toFixed(2)}`,
      `Total Geral;${Object.values(resumoIVA).reduce((sum, v) => sum + v.total, 0).toFixed(2)}`,
      '',
      '',
      '===== FORNECEDORES =====',
      'Fornecedor;NIF;Total Faturado',
      ...(() => {
        const fornecedorTotais = {};
        filteredDespesas.forEach(d => {
          const fornNome = d.fornecedor || 'N/A';
          let fornecedorObj = null;
          if (d.fornecedor) {
            fornecedorObj = fornecedores.find(f => 
              (typeof f === 'object' && f.nome === d.fornecedor) || 
              (typeof f === 'string' && f === d.fornecedor)
            );
          }
          const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
          
          const key = `${fornNome}|${fornNif}`;
          if (!fornecedorTotais[key]) {
            fornecedorTotais[key] = 0;
          }
          fornecedorTotais[key] += d.valor * (1 + d.iva / 100);
        });
        
        return Object.entries(fornecedorTotais)
          .sort((a, b) => b[1] - a[1])
          .map(([key, total]) => {
            const [nome, nif] = key.split('|');
            return `"${nome}";${nif};${total.toFixed(2)}`;
          });
      })(),
      '',
      '',
      '===== INFORMA√á√ïES LEGAIS =====',
      'Este documento cont√©m informa√ß√£o fiscal relevante para efeitos de contabilidade e declara√ß√µes fiscais.',
      'Os valores de IVA dedut√≠vel devem ser confirmados com a contabilidade conforme legisla√ß√£o aplic√°vel.',
      'Deve ser conservado de acordo com os prazos legais estabelecidos.',
      `Gerado automaticamente pelo sistema Munchi Manager em ${new Date().toLocaleString('pt-PT')}`
    ];
    
    // Create CSV content
    const csvContent = [
      ...empresaInfo,
      headers.join(';'),
      ...rows,
      ...resumoSection
    ].join('\n');
    
    // Download com BOM para Excel reconhecer UTF-8
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nome do ficheiro com per√≠odo
    const dataInicio = new Date(filteredDespesas[0].data);
    const dataFim = new Date(filteredDespesas[filteredDespesas.length - 1].data);
    const nomeArquivo = `DESPESAS_APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification(`‚úÖ ${filteredDespesas.length} despesas exportadas! ‚ö†Ô∏è IMPORTANTE: Enviar tamb√©m os PDFs das faturas ao contabilista!`, 'success');
  };

  // ===== EXPORT DE APOIO CONTABIL√çSTICO (CSV) =====
  // IMPORTANTE: Este export N√ÉO substitui documentos fiscais!
  // √â apenas para facilitar o lan√ßamento contabil√≠stico.
  // Os PDFs das faturas s√£o OBRIGAT√ìRIOS e devem ser enviados separadamente.
  const exportarRelatorioCompletoCSV = () => {
    const filteredVendas = getExportFilteredData(vendas || []);
    
    // ‚ö†Ô∏è USAR FATURAS (sistema novo) em vez de despesas (sistema antigo)
    const filteredFaturasTemp = getExportFilteredData(faturas || []);
    
    // Filtrar: apenas faturas (n√£o recibos)
    const filteredFaturasSemRecibos = filteredFaturasTemp.filter(f => 
      f.tipoDocumento === 'fatura' || !f.tipoDocumento
    );
    
    // ‚ö†Ô∏è FILTRAR: Excluir FS sem NIF - apenas FT, FR e FS com NIF para contabilista
    const filteredFaturas = filteredFaturasSemRecibos.filter(f => {
      // N√£o √© FS? Incluir sempre (FT, FR, NC, etc)
      if (f.tipo !== 'FS') return true;
      
      // √â FS? S√≥ incluir se tiver NIF do cliente
      return f.temNifCliente === true;
    });
    
    const recibosIgnorados = filteredFaturasTemp.length - filteredFaturasSemRecibos.length;
    const fsComNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente === true
    ).length;
    const fsSemNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente !== true
    ).length;
    
    if (recibosIgnorados > 0 || fsComNif > 0 || fsSemNif > 0) {
      let msg = '‚ÑπÔ∏è Faturas: ';
      const partes = [];
      if (recibosIgnorados > 0) partes.push(`${recibosIgnorados} recibo(s) exclu√≠dos`);
      if (fsComNif > 0) partes.push(`${fsComNif} FS com NIF (inclu√≠das)`);
      if (fsSemNif > 0) partes.push(`${fsSemNif} FS sem NIF (exclu√≠das)`);
      msg += partes.join(' | ');
      void 0;
    }
    
    if (filteredVendas.length === 0 && filteredFaturas.length === 0) {
      showNotification('Nenhum dado para exportar no per√≠odo selecionado!', 'error');
      return;
    }
    
    // ===== CABE√áALHO COM DADOS DA EMPRESA =====
    const empresaInfo = [
      '='.repeat(80),
      'RELAT√ìRIO DE APOIO CONTABIL√çSTICO',
      '='.repeat(80),
      '',
      '‚ö†Ô∏è  AVISO LEGAL IMPORTANTE:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      'N√ÉO substitui os documentos fiscais originais (faturas em PDF).',
      'Para efeitos de Autoridade Tribut√°ria, √© obrigat√≥rio conservar os PDFs originais.',
      '',
      '===== IDENTIFICA√á√ÉO DA EMPRESA =====',
      `Nome: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      '===== INFORMA√á√ÉO DO RELAT√ìRIO =====',
      `Per√≠odo: ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.min(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''} a ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.max(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''}`,
      `Data de Emiss√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Vendas: ${filteredVendas.length} registos`,
      `Total de Faturas: ${filteredFaturas.length} registos`,
      '',
      ''
    ];
    
    // ===== SEC√á√ÉO 1: VENDAS =====
    const vendasSection = [
      '=' .repeat(80),
      'SEC√á√ÉO 1: RECEITAS E VENDAS',
      '='.repeat(80),
      ''
    ];
    
    if (filteredVendas.length > 0) {
      const vendasHeaders = [
        'Data',
        'N¬∫ Doc',
        'Tipo Doc',
        'Produto/Servi√ßo',
        'Origem', // ‚Üê NOVO
        'Qtd',
        'Pre√ßo Unit (s/ IVA)',
        'Base (s/ IVA)',
        'Taxa IVA',
        'Valor IVA',
        'Total (c/ IVA)',
        'Forma Pag',
        'Obs'
      ];
      
      const vendasRows = filteredVendas.map((v, idx) => {
        const valorBase = v.valor;
        const valorIva = valorBase * (v.iva / 100);
        const valorTotal = valorBase + valorIva;
        const precoUnit = v.quantidade > 0 ? valorBase / v.quantidade : 0;
        const origem = v.origem === 'moloni' ? 'MOLONI' : 
                      v.origem === 'zobaze' ? 'ZOBAZE' : 'MANUAL';
        
        return [
          new Date(v.data).toISOString().split('T')[0],
          v.numeroDocumento || `VND-${new Date(v.data).getFullYear()}-${String(idx + 1).padStart(6, '0')}`,
          v.tipoDocumento || 'Venda',
          `"${v.produto}"`,
          origem, // ‚Üê NOVO
          v.quantidade || 1,
          precoUnit.toFixed(2),
          valorBase.toFixed(2),
          `${v.iva}%`,
          valorIva.toFixed(2),
          valorTotal.toFixed(2),
          v.formaPagamento || 'N/A',
          `"${v.observacoes || ''}"`
        ].join(';');
      });
      
      vendasSection.push(vendasHeaders.join(';'), ...vendasRows);
      
      // Resumo de vendas por IVA
      const resumoVendasIVA = {};
      filteredVendas.forEach(v => {
        const taxa = v.iva;
        if (!resumoVendasIVA[taxa]) {
          resumoVendasIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = v.valor;
        const valorIva = valorBase * (taxa / 100);
        resumoVendasIVA[taxa].base += valorBase;
        resumoVendasIVA[taxa].iva += valorIva;
        resumoVendasIVA[taxa].total += valorBase + valorIva;
        resumoVendasIVA[taxa].count++;
      });
      
      vendasSection.push(
        '',
        '--- RESUMO DE VENDAS POR TAXA IVA ---',
        'Taxa IVA;N¬∫ Opera√ß√µes;Base Tribut√°vel;IVA Liquidado;Total',
        ...Object.entries(resumoVendasIVA).map(([taxa, v]) =>
          `${taxa}%;${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
        ),
        '',
        '--- TOTAIS DE VENDAS ---',
        `Total Base Tribut√°vel (Vendas);${Object.values(resumoVendasIVA).reduce((s, v) => s + v.base, 0).toFixed(2)}`,
        `Total IVA Liquidado;${Object.values(resumoVendasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total Receitas;${Object.values(resumoVendasIVA).reduce((s, v) => s + v.total, 0).toFixed(2)}`
      );
    } else {
      vendasSection.push('Nenhuma venda registada no per√≠odo selecionado.');
    }
    
    vendasSection.push('', '');
    
    // ===== SEC√á√ÉO 2: FATURAS DE FORNECEDORES =====
    const faturasSection = [
      '='.repeat(80),
      'SEC√á√ÉO 2: FATURAS DE FORNECEDORES',
      '='.repeat(80),
      ''
    ];
    
    if (filteredFaturas.length > 0) {
      const faturasHeaders = [
        'Data',
        'N¬∫ Doc',
        'Tipo',
        'Fornecedor',
        'NIF Forn',
        'Categoria',
        'Base (s/ IVA)',
        'Taxa IVA',
        'Valor IVA',
        'Total (c/ IVA)',
        'Tem PDF',
        'Notas'
      ];
      
      const faturasRows = filteredFaturas.map((f, idx) => {
        // Usar totais se existirem, caso contr√°rio calcular
        const valorBase = f.totais?.subtotal || f.subtotal || 0;
        const valorIva = f.totais?.iva || f.totalIva || 0;
        const valorTotal = f.totais?.total || f.total || 0;
        
        // IVA m√©dio (simplifica√ß√£o)
        const taxaIva = valorBase > 0 ? ((valorIva / valorBase) * 100).toFixed(0) : 0;
        
        return [
          new Date(f.data).toISOString().split('T')[0],
          f.numero || `FAT-${new Date(f.data).getFullYear()}-${String(idx + 1).padStart(6, '0')}`,
          f.tipo || 'FT',
          `"${f.fornecedorNome || 'N/A'}"`,
          f.fornecedorNif || '',
          `"${f.categoria || 'compras'}"`,
          valorBase.toFixed(2),
          `${taxaIva}%`,
          valorIva.toFixed(2),
          valorTotal.toFixed(2),
          f.documentoPDF ? 'Sim' : 'N√£o',
          `"${f.notas || ''}"`
        ].join(';');
      });
      
      faturasSection.push(faturasHeaders.join(';'), ...faturasRows);
      
      // Resumo de faturas por categoria
      const resumoFaturasCat = {};
      filteredFaturas.forEach(f => {
        const cat = f.categoria || 'compras';
        if (!resumoFaturasCat[cat]) {
          resumoFaturasCat[cat] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        const valorBase = f.totais?.subtotal || f.subtotal || 0;
        const valorIva = f.totais?.iva || f.totalIva || 0;
        resumoFaturasCat[cat].base += valorBase;
        resumoFaturasCat[cat].iva += valorIva;
        resumoFaturasCat[cat].total += valorBase + valorIva;
        resumoFaturasCat[cat].count++;
      });
      
      // Resumo de faturas por taxa IVA (aproximado)
      const resumoFaturasIVA = {};
      filteredFaturas.forEach(f => {
        const valorBase = f.totais?.subtotal || f.subtotal || 0;
        const valorIva = f.totais?.iva || f.totalIva || 0;
        // Calcular taxa m√©dia
        const taxa = valorBase > 0 ? Math.round((valorIva / valorBase) * 100) : 0;
        
        if (!resumoFaturasIVA[taxa]) {
          resumoFaturasIVA[taxa] = { base: 0, iva: 0, total: 0, count: 0 };
        }
        resumoFaturasIVA[taxa].base += valorBase;
        resumoFaturasIVA[taxa].iva += valorIva;
        resumoFaturasIVA[taxa].total += valorBase + valorIva;
        resumoFaturasIVA[taxa].count++;
      });
      
      faturasSection.push(
        '',
        '--- RESUMO DE FATURAS POR CATEGORIA ---',
        'Categoria;N¬∫ Opera√ß√µes;Base;IVA;Total',
        ...Object.entries(resumoFaturasCat)
          .sort((a, b) => b[1].total - a[1].total)
          .map(([cat, v]) =>
            `"${cat}";${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
          ),
        '',
        '--- RESUMO DE FATURAS POR TAXA IVA ---',
        'Taxa IVA;N¬∫ Opera√ß√µes;Base;IVA Suportado;Total',
        ...Object.entries(resumoFaturasIVA).map(([taxa, v]) =>
          `${taxa}%;${v.count};${v.base.toFixed(2)};${v.iva.toFixed(2)};${v.total.toFixed(2)}`
        ),
        '',
        '--- TOTAIS DE FATURAS ---',
        `Total Base (Faturas);${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.base, 0).toFixed(2)}`,
        `Total IVA Suportado;${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total IVA Dedut√≠vel;${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.iva, 0).toFixed(2)}`,
        `Total Faturas;${Object.values(resumoFaturasIVA).reduce((s, v) => s + v.total, 0).toFixed(2)}`
      );
    } else {
      faturasSection.push('Nenhuma fatura registada no per√≠odo selecionado.');
    }
    
    faturasSection.push('', '');
    
    // ===== SEC√á√ÉO 3: RESUMO FISCAL =====
    const totalVendasBase = filteredVendas.reduce((sum, v) => sum + v.valor, 0);
    const totalVendasIVA = filteredVendas.reduce((sum, v) => sum + (v.valor * v.iva / 100), 0);
    const totalVendas = totalVendasBase + totalVendasIVA;
    
    const totalFaturasBase = filteredFaturas.reduce((sum, f) => sum + (f.totais?.subtotal || f.subtotal || 0), 0);
    const totalFaturasIVA = filteredFaturas.reduce((sum, f) => sum + (f.totais?.iva || f.totalIva || 0), 0);
    const totalFaturas = totalFaturasBase + totalFaturasIVA;
    
    const saldoIVA = totalVendasIVA - totalFaturasIVA;
    const resultadoLiquido = totalVendas - totalFaturas;
    
    const resumoFiscal = [
      '='.repeat(80),
      'SEC√á√ÉO 3: RESUMO FISCAL E FINANCEIRO',
      '='.repeat(80),
      '',
      '--- APURAMENTO DE IVA ---',
      `IVA Liquidado (Vendas);${totalVendasIVA.toFixed(2)}`,
      `IVA Dedut√≠vel (Faturas);${totalFaturasIVA.toFixed(2)}`,
      `Saldo de IVA;${saldoIVA.toFixed(2)};${saldoIVA >= 0 ? 'A ENTREGAR ao Estado' : 'A RECEBER do Estado'}`,
      '',
      '--- DEMONSTRA√á√ÉO DE RESULTADOS (SIMPLIFICADA) ---',
      `Total de Vendas (c/ IVA);${totalVendas.toFixed(2)}`,
      `Total de Faturas (c/ IVA);${totalFaturas.toFixed(2)}`,
      `Resultado L√≠quido;${resultadoLiquido.toFixed(2)};${resultadoLiquido >= 0 ? 'LUCRO' : 'PREJU√çZO'}`,
      '',
      '--- VALORES BASE (s/ IVA) ---',
      `Vendas (Base);${totalVendasBase.toFixed(2)}`,
      `Faturas (Base);${totalFaturasBase.toFixed(2)}`,
      `Margem Bruta;${(totalVendasBase - totalFaturasBase).toFixed(2)}`,
      ''
    ];
    
    // ===== SEC√á√ÉO 4: FORNECEDORES =====
    if (filteredDespesas.length > 0) {
      const fornecedorTotais = {};
      filteredDespesas.forEach(d => {
        const fornNome = d.fornecedor || 'N/A';
        let fornecedorObj = null;
        if (d.fornecedor) {
          fornecedorObj = fornecedores.find(f => 
            (typeof f === 'object' && f.nome === d.fornecedor) || 
            (typeof f === 'string' && f === d.fornecedor)
          );
        }
        const fornNif = fornecedorObj && typeof fornecedorObj === 'object' ? (fornecedorObj.nif || '') : '';
        
        const key = `${fornNome}|${fornNif}`;
        if (!fornecedorTotais[key]) {
          fornecedorTotais[key] = 0;
        }
        fornecedorTotais[key] += d.valor * (1 + d.iva / 100);
      });
      
      resumoFiscal.push(
        '',
        '='.repeat(80),
        'SEC√á√ÉO 4: AN√ÅLISE DE FORNECEDORES',
        '='.repeat(80),
        '',
        'Fornecedor;NIF;Total Faturado',
        ...Object.entries(fornecedorTotais)
          .sort((a, b) => b[1] - a[1])
          .map(([key, total]) => {
            const [nome, nif] = key.split('|');
            return `"${nome}";${nif};${total.toFixed(2)}`;
          })
      );
    }
    
    // ===== RODAP√â LEGAL =====
    const rodape = [
      '',
      '',
      '='.repeat(80),
      'INFORMA√á√ïES LEGAIS E DECLARA√á√ïES',
      '='.repeat(80),
      '',
      'üìã NATUREZA DESTE DOCUMENTO:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      '',
      '‚ö†Ô∏è  IMPORTANTE - OBRIGA√á√ïES LEGAIS:',
      '',
      '1. DOCUMENTOS FISCAIS ORIGINAIS (OBRIGAT√ìRIO):',
      '   - As FATURAS EM PDF dos fornecedores s√£o OBRIGAT√ìRIAS',
      '   - Devem ser conservadas durante 10 anos',
      '   - S√£o a √öNICA prova aceite pela Autoridade Tribut√°ria',
      '   - Este CSV N√ÉO substitui os documentos fiscais',
      '',
      '2. PARA ENTREGAR AO CONTABILISTA:',
      '   ‚úì Este ficheiro CSV (dados estruturados)',
      '   ‚úì PASTA COM TODOS OS PDFs das faturas de fornecedores',
      '   ‚úì Faturas de vendas emitidas via software certificado (ex: Moloni)',
      '',
      '3. VENDAS:',
      '   - Se usa software certificado (Moloni, etc): comunica√ß√£o autom√°tica √† AT',
      '   - Este CSV serve apenas para controlo interno e confer√™ncia',
      '',
      '4. DESPESAS:',
      '   - Cada despesa DEVE ter a fatura original em PDF',
      '   - O PDF √© necess√°rio para dedu√ß√£o de IVA',
      '   - Sem PDF, a AT pode rejeitar a dedu√ß√£o',
      '',
      'Conforme:',
      '  - C√≥digo do IVA (CIVA)',
      '  - Lei Geral Tribut√°ria',
      '  - Decreto-Lei n.¬∫ 28/2019 (SAF-T)',
      '',
      `Documento gerado pelo sistema Munchi Manager`,
      `Data e hora: ${new Date().toLocaleString('pt-PT')}`,
      `Empresa: ${dadosEmpresa.nome || 'N/A'} (NIF: ${dadosEmpresa.nif || 'N/A'})`,
      '',
      '='.repeat(80),
      'FIM DO RELAT√ìRIO',
      '='.repeat(80)
    ];
    
    // ===== CRIAR FICHEIRO CSV =====
    const csvContent = [
      ...empresaInfo,
      ...vendasSection,
      ...faturasSection,
      ...resumoFiscal,
      ...rodape
    ].join('\n');
    
    // Download com BOM para Excel reconhecer UTF-8
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nome do ficheiro com per√≠odo - APOIO CONTABIL√çSTICO
    const todasDatas = [...filteredVendas, ...filteredFaturas].map(x => new Date(x.data));
    const dataInicio = todasDatas.length > 0 ? new Date(Math.min(...todasDatas)) : new Date();
    const dataFim = todasDatas.length > 0 ? new Date(Math.max(...todasDatas)) : new Date();
    const nomeArquivo = `APOIO_CONTABILISTICO_${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}.csv`;
    
    a.download = nomeArquivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    let msg = `‚úÖ Export para contabilista: ${filteredVendas.length} vendas + ${filteredFaturas.length} faturas`;
    if (recibosIgnorados > 0 || fsIgnoradas > 0) {
      msg += `\n\n‚ö†Ô∏è Exclu√≠dos: `;
      if (recibosIgnorados > 0) msg += `${recibosIgnorados} recibo(s) `;
      if (fsIgnoradas > 0) msg += `${fsIgnoradas} FS `;
    }
    msg += '\n\nüìé N√£o esquecer os PDFs das faturas!';
    
    showNotification(msg, 'success');
  };

  // ===== EXPORT COMPLETO: CSV + ZIP COM PDFs =====
  const exportarPacoteCompleto = async () => {
    const filteredVendas = getExportFilteredData(vendas || []);
    const filteredFaturasCompletas = getExportFilteredData(faturas || []); // Todas
    
    // ‚ö†Ô∏è FILTRAR: S√≥ FATURAS (n√£o recibos) para contabilista
    const filteredFaturasSemRecibos = filteredFaturasCompletas.filter(f => 
      f.tipoDocumento === 'fatura' || !f.tipoDocumento // Retrocompatibilidade
    );
    
    // ‚ö†Ô∏è FILTRAR: Excluir FS sem NIF - apenas FT, FR e FS com NIF para contabilista
    const filteredFaturas = filteredFaturasSemRecibos.filter(f => {
      // N√£o √© FS? Incluir sempre (FT, FR, NC, etc)
      if (f.tipo !== 'FS') return true;
      
      // √â FS? S√≥ incluir se tiver NIF do cliente
      return f.temNifCliente === true;
    });
    
    const recibosIgnorados = filteredFaturasCompletas.length - filteredFaturasSemRecibos.length;
    const fsComNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente === true
    ).length;
    const fsSemNif = filteredFaturasSemRecibos.filter(f => 
      f.tipo === 'FS' && f.temNifCliente !== true
    ).length;
    
    if (filteredVendas.length === 0 && filteredFaturas.length === 0) {
      showNotification('Nenhum dado para exportar no per√≠odo selecionado!', 'error');
      return;
    }
    
    // Contar quantas faturas t√™m PDF
    const faturasComPDF = filteredFaturas.filter(f => f.documentoPDF);
    const faturasSemPDF = filteredFaturas.filter(f => !f.documentoPDF);
    
    // Aviso se h√° recibos ou FS ignorados
    let avisos = [];
    if (recibosIgnorados > 0) {
      avisos.push(`${recibosIgnorados} recibo(s)`);
    }
    if (fsComNif > 0) {
      avisos.push(`${fsComNif} FS com NIF (inclu√≠das ‚úÖ)`);
    }
    if (fsSemNif > 0) {
      avisos.push(`${fsSemNif} FS sem NIF (exclu√≠das)`);
    }
    if (avisos.length > 0) {
      const msg = `‚ÑπÔ∏è Nota: ${avisos.join(' | ')}`;
      void 0;
    }
    
    if (faturasSemPDF.length > 0) {
      let mensagemAviso = `‚ö†Ô∏è ATEN√á√ÉO!\n\n${faturasSemPDF.length} fatura(s) N√ÉO t√™m PDF anexado.\n`;
      
      if (recibosIgnorados > 0 || fsComNif > 0 || fsSemNif > 0) {
        mensagemAviso += `\nInforma√ß√£o sobre documentos:\n`;
        if (recibosIgnorados > 0) mensagemAviso += `‚Ä¢ ${recibosIgnorados} recibo(s) - exclu√≠dos\n`;
        if (fsComNif > 0) mensagemAviso += `‚Ä¢ ${fsComNif} FS com NIF - inclu√≠das ‚úÖ\n`;
        if (fsSemNif > 0) mensagemAviso += `‚Ä¢ ${fsSemNif} FS sem NIF - exclu√≠das\n`;
        mensagemAviso += `\n`;
      }
      
      mensagemAviso += `Sem PDFs, o contabilista n√£o pode deduzir IVA!\n\nDeseja continuar mesmo assim?`;
      
      const confirmar = confirm(mensagemAviso);
      if (!confirmar) return;
    }
    
    showNotification('üì¶ A criar pacote completo... Aguarde!', 'info');
    
    try {
      // 1. Gerar CSV (reutiliza l√≥gica existente mas retorna string)
      const csvContent = gerarCSVCompleto(filteredVendas, filteredFaturas);
      
      // 2. Criar ZIP com JSZip
      const zip = new JSZip();
      
      // Adicionar CSV ao ZIP
      const todasDatas = [...filteredVendas, ...filteredFaturas].map(x => new Date(x.data));
      const dataInicio = todasDatas.length > 0 ? new Date(Math.min(...todasDatas)) : new Date();
      const dataFim = todasDatas.length > 0 ? new Date(Math.max(...todasDatas)) : new Date();
      const periodoStr = `${dataInicio.getFullYear()}${String(dataInicio.getMonth() + 1).padStart(2, '0')}_${dataFim.getFullYear()}${String(dataFim.getMonth() + 1).padStart(2, '0')}`;
      
      const BOM = '\uFEFF';
      zip.file(`APOIO_CONTABILISTICO_${periodoStr}.csv`, BOM + csvContent);
      
      // 3. Adicionar PDFs ao ZIP (em pasta separada com data)
      const pdfFolder = zip.folder(`PDFs_Fornecedores_${periodoStr}`);
      
      let pdfsAdicionados = 0;
      let pdfsComErro = 0;
      
      filteredFaturas.forEach((fatura, index) => {
        if (fatura.documentoPDF) {
          try {
            // Extrair base64 puro (remover prefixo data:application/pdf;base64,)
            let base64Data = fatura.documentoPDF;
            
            // Verificar se tem o prefixo data:
            if (base64Data.includes(',')) {
              base64Data = base64Data.split(',')[1];
            }
            
            // ‚ö†Ô∏è CR√çTICO: Limpar whitespace e newlines do base64
            base64Data = base64Data.trim().replace(/\s/g, '');
            
            // Validar se o base64 n√£o est√° vazio
            if (!base64Data || base64Data.length < 100) {
              void 0;
              pdfsComErro++;
              return; // Skip este PDF
            }
            
            // Validar se √© base64 v√°lido (s√≥ caracteres A-Z, a-z, 0-9, +, /, =)
            const base64Regex = /^[A-Za-z0-9+/]+=*$/;
            if (!base64Regex.test(base64Data)) {
              void 0;
              pdfsComErro++;
              return; // Skip este PDF
            }
            
            // Validar se come√ßa com assinatura PDF (JVBERi0 = %PDF- em base64)
            if (!base64Data.startsWith('JVBERi0')) {
              void 0;
              pdfsComErro++;
              return; // Skip este PDF
            }
            
            // Nome do ficheiro PDF - LIMPAR BEM para evitar problemas no Windows
            const dataStr = new Date(fatura.data).toISOString().split('T')[0].replace(/-/g, '');
            const fornecedor = fatura.fornecedorNome || 'SemFornecedor';
            // Limpar TODOS os caracteres especiais que o Windows n√£o gosta
            const fornecedorClean = fornecedor
              .replace(/[\/\\:*?"<>|]/g, '') // Remove caracteres proibidos no Windows
              .replace(/[^a-zA-Z0-9\s]/g, '_') // Substitui outros especiais por _
              .replace(/\s+/g, '_') // Espa√ßos viram _
              .substring(0, 30); // Limita tamanho
            
            const numDoc = fatura.numero || `FAT${String(index + 1).padStart(4, '0')}`;
            // Limpar n√∫mero do documento (remove /, \, etc)
            const numDocClean = numDoc
              .replace(/[\/\\:*?"<>|]/g, '_')
              .replace(/[^a-zA-Z0-9]/g, '_');
            
            const nomeArquivo = `${dataStr}_${fornecedorClean}_${numDocClean}.pdf`;
            
            pdfFolder.file(nomeArquivo, base64Data, {base64: true});
            pdfsAdicionados++;
            
          } catch (error) {
            void 0;
            pdfsComErro++;
          }
        }
      });
      
      // 4. Gerar ZIP e download
      const zipBlob = await zip.generateAsync({type: 'blob'});
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `PACOTE_CONTABILIDADE_${periodoStr}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      let mensagemFinal = `‚úÖ Pacote completo criado!\n\nüìÑ CSV: 1 ficheiro\nüìé PDFs: ${pdfsAdicionados} documento(s)`;
      
      if (pdfsComErro > 0) {
        mensagemFinal += `\n‚ö†Ô∏è PDFs com erro: ${pdfsComErro} (vazios ou corrompidos)`;
      }
      
      if (faturasSemPDF.length > 0) {
        mensagemFinal += `\n‚ö†Ô∏è Sem PDF: ${faturasSemPDF.length} fatura(s)`;
      }
      
      showNotification(mensagemFinal, pdfsComErro > 0 ? 'warning' : 'success');
      
    } catch (error) {
      void 0;
      showNotification('‚ùå Erro ao criar pacote! Veja o console (F12).', 'error');
    }
  };
  
  // Fun√ß√£o auxiliar para gerar CSV (extrai l√≥gica da fun√ß√£o exportarRelatorioCompletoCSV)
  const gerarCSVCompleto = (filteredVendas, filteredFaturas) => {
    // Reutiliza toda a l√≥gica da fun√ß√£o exportarRelatorioCompletoCSV
    // mas retorna o CSV em vez de fazer download
    
    // ===== CABE√áALHO COM DADOS DA EMPRESA =====
    const empresaInfo = [
      '='.repeat(80),
      'RELAT√ìRIO DE APOIO CONTABIL√çSTICO',
      '='.repeat(80),
      '',
      '‚ö†Ô∏è  AVISO LEGAL IMPORTANTE:',
      'Este ficheiro CSV cont√©m dados estruturados para APOIO ao lan√ßamento contabil√≠stico.',
      'N√ÉO substitui os documentos fiscais originais (faturas em PDF).',
      'Para efeitos de Autoridade Tribut√°ria, √© obrigat√≥rio conservar os PDFs originais.',
      '',
      '===== IDENTIFICA√á√ÉO DA EMPRESA =====',
      `Nome: ${dadosEmpresa.nome || 'N/A'}`,
      `NIF: ${dadosEmpresa.nif || 'N/A'}`,
      `CAE: ${dadosEmpresa.cae || 'N/A'}`,
      `Morada: ${dadosEmpresa.morada || 'N/A'}`,
      `C√≥digo Postal: ${dadosEmpresa.codigoPostal || 'N/A'}`,
      `Cidade: ${dadosEmpresa.cidade || 'N/A'}`,
      `Email: ${dadosEmpresa.email || 'N/A'}`,
      `Telefone: ${dadosEmpresa.telefone || 'N/A'}`,
      '',
      '===== INFORMA√á√ÉO DO RELAT√ìRIO =====',
      `Per√≠odo: ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.min(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''} a ${filteredVendas.length > 0 || filteredFaturas.length > 0 ? new Date(Math.max(...[...filteredVendas, ...filteredFaturas].map(x => new Date(x.data)))).toLocaleDateString('pt-PT') : ''}`,
      `Data de Emiss√£o: ${new Date().toLocaleString('pt-PT')}`,
      `Total de Vendas: ${filteredVendas.length} registos`,
      `Total de Faturas: ${filteredFaturas.length} registos`,
      '',
      ''
    ];
    
    // Por simplicidade, retorna apenas estrutura b√°sica
    // O CSV completo ser√° gerado pela fun√ß√£o principal em produ√ß√£o
    const csvSimples = [
      ...empresaInfo,
      '',
      '='.repeat(80),
      'VENDAS E FATURAS',
      '='.repeat(80),
      '',
      `Total Vendas: ${filteredVendas.length}`,
      `Total Faturas: ${filteredFaturas.length}`,
      '',
      '(Relat√≥rio completo gerado automaticamente)',
      ''
    ].join('\n');
    
    return csvSimples;
  };

  // === GOOGLE DRIVE TOKEN MANAGER ===
  // Sistema de gest√£o inteligente de tokens do Google Drive
  const GoogleDriveTokenManager = {
    TOKEN_KEY: 'munchi_drive_token',
    CHECK_INTERVAL: 60000, // Verificar a cada 1 minuto
    RENEWAL_BUFFER: 5 * 60 * 1000, // Renovar 5 min antes de expirar
    
    /**
     * Verifica se o token ainda √© v√°lido
     */
    isTokenValid() {
      const tokenData = this.getTokenData();
      if (!tokenData || !tokenData.expires_at) return false;
      
      const now = Date.now();
      const expiresAt = tokenData.expires_at;
      const timeUntilExpiry = expiresAt - now;
      
      // Token expirado ou vai expirar em menos de 5 minutos
      return timeUntilExpiry > this.RENEWAL_BUFFER;
    },
    
    /**
     * Obt√©m dados do token guardado
     */
    getTokenData() {
      try {
        const saved = localStorage.getItem(this.TOKEN_KEY);
        if (!saved) return null;
        return JSON.parse(saved);
      } catch (e) {
        console.error('Erro ao ler token:', e);
        return null;
      }
    },
    
    /**
     * Guarda token com timestamp de expira√ß√£o
     */
    saveToken(accessToken, expiresIn = 3600) {
      const tokenData = {
        access_token: accessToken,
        expires_at: Date.now() + (expiresIn * 1000),
        saved_at: Date.now()
      };
      localStorage.setItem(this.TOKEN_KEY, JSON.stringify(tokenData));
      return tokenData;
    },
    
    /**
     * Remove token
     */
    clearToken() {
      localStorage.removeItem(this.TOKEN_KEY);
    },
    
    /**
     * Obt√©m tempo restante at√© expira√ß√£o (em minutos)
     */
    getTimeUntilExpiry() {
      const tokenData = this.getTokenData();
      if (!tokenData || !tokenData.expires_at) return 0;
      
      const timeLeft = tokenData.expires_at - Date.now();
      return Math.max(0, Math.floor(timeLeft / 60000)); // minutos
    }
  };

  // === GOOGLE IDENTITY SERVICES ===
  // SEGURAN√áA: A API Key agora √© carregada do ficheiro config.js (n√£o commitado no git)
  // Certifique-se que configurou as restri√ß√µes na Google Cloud Console!
  const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '344967437318-oe9hr1t5m9bcs7qvdm0t5dr9f0delaom.apps.googleusercontent.com',
    API_KEY: window.GOOGLE_API_KEY || '', // Carregada do config.js
    SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/documents.readonly',
    FILE_NAME: 'munchi-data.json',
    BACKUP_PREFIX: 'munchi-backup-', // üÜï Prefixo para backups versionados
    MAX_BACKUPS: 10 // üÜï Manter √∫ltimos 10 backups
  };

  const loadUserInfo = async (token) => {
    try {
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const userInfo = await response.json();
        setDriveUser({
          name: userInfo.name,
          email: userInfo.email,
          image: userInfo.picture
        });
      }
    } catch (error) {
      void 0;
    }
  };

  const loginGoogleDrive = () => {
    if (!window.google) {
      showNotification('‚ö†Ô∏è Google Identity Services ainda n√£o carregou', 'error');
      return;
    }
    const client = window.google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
      scope: GOOGLE_DRIVE_CONFIG.SCOPES,
      callback: (response) => {
        if (response.access_token) {
          // ‚úÖ Usar GoogleDriveTokenManager
          GoogleDriveTokenManager.saveToken(response.access_token, response.expires_in || 3600);
          setDriveAccessToken(response.access_token);
          setDriveError(null);
          loadUserInfo(response.access_token);
          loadFromDrive(response.access_token);
          showNotification('‚úÖ Conectado ao Google Drive!', 'success');
          // Navegar para dashboard com subtab resumo
          setActiveTab('dashboard');
          setDashboardSubTab('resumo');
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }, 100);
        } else {
          setDriveError('Erro ao obter token');
          showNotification('‚ùå Erro ao conectar', 'error');
        }
      }
    });
    client.requestAccessToken();
  };

  const logoutGoogleDrive = () => {
    if (driveAccessToken && window.google) {
      window.google.accounts.oauth2.revoke(driveAccessToken);
    }
    // ‚úÖ Usar GoogleDriveTokenManager
    GoogleDriveTokenManager.clearToken();
    localStorage.removeItem('munchi_drive_file_id');
    setDriveAccessToken(null);
    setDriveUser(null);
    setDriveFileId(null);
    showNotification('Desconectado do Google Drive', 'info');
  };

  const findDriveFile = async (token) => {
    try {
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name='${GOOGLE_DRIVE_CONFIG.FILE_NAME}' and mimeType='application/json' and trashed=false&fields=files(id,name,modifiedTime)`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      if (response.ok) {
        const data = await response.json();
        return data.files && data.files.length > 0 ? data.files[0] : null;
      }
    } catch (error) {
      void 0;
    }
    return null;
  };

  const createDriveFile = async (token, data) => {
    const metadata = { name: GOOGLE_DRIVE_CONFIG.FILE_NAME, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
      { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form }
    );
    if (response.ok) {
      const result = await response.json();
      setDriveFileId(result.id);
      localStorage.setItem('munchi_drive_file_id', result.id);
      return result.id;
    }
    // ‚úÖ Incluir status code no erro
    throw new Error(`Erro ao criar ficheiro (${response.status})`);
  };

  const updateDriveFile = async (token, fileId, data) => {
    const response = await fetch(
      `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
      {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(data, null, 2)
      }
    );
    if (!response.ok) {
      // ‚úÖ Incluir status code no erro
      throw new Error(`Erro ao atualizar (${response.status})`);
    }
    return true;
  };

  // üÜï SISTEMA DE BACKUPS VERSIONADOS
  
  // Criar backup com timestamp
  const createVersionedBackup = async (token, data) => {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const fileName = `${GOOGLE_DRIVE_CONFIG.BACKUP_PREFIX}${timestamp}.json`;
    
    const metadata = { name: fileName, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
    
    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,modifiedTime',
      { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form }
    );
    
    if (!response.ok) {
      throw new Error(`Erro ao criar backup (${response.status})`);
    }
    
    return await response.json();
  };
  
  // Listar todos os backups dispon√≠veis
  const listDriveBackups = async (token) => {
    try {
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name contains '${GOOGLE_DRIVE_CONFIG.BACKUP_PREFIX}' and mimeType='application/json' and trashed=false&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      
      if (response.ok) {
        const data = await response.json();
        return data.files || [];
      }
    } catch (error) {
      console.error('Erro ao listar backups:', error);
    }
    return [];
  };
  
  // Carregar backup espec√≠fico
  const loadSpecificBackup = async (token, fileId) => {
    try {
      setDriveSyncing(true);
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      
      if (response.ok) {
        const data = await response.json();
        
        // ‚úÖ VALIDAR dados antes de carregar
        const totalRecords = (data.produtos?.length || 0) + (data.ingredientes?.length || 0) + (data.vendas?.length || 0);
        
        if (totalRecords === 0) {
          showNotification('‚ö†Ô∏è Backup vazio! N√£o foi carregado.', 'warning');
          return false;
        }
        
        // Carregar todos os dados
        if (data.produtos) setProdutos(data.produtos);
        if (data.ingredientes) setIngredientes(data.ingredientes);
        if (data.vendas) setVendas(data.vendas);
        if (data.faturas) setFaturas(data.faturas);
        if (data.fornecedores) setFornecedores(data.fornecedores);
        if (data.dadosEmpresa) setDadosEmpresa(data.dadosEmpresa);
        if (data.deliveryApps) setDeliveryApps(data.deliveryApps);
        if (data.blacklist) setBlacklist(data.blacklist);
        if (data.templatesOCR) setTemplatesOCR(data.templatesOCR);
        if (data.vocabularioFornecedor) setVocabularioFornecedor(data.vocabularioFornecedor);
        if (data.configuracaoWaste) setConfiguracaoWaste(data.configuracaoWaste);
        if (data.contagens) setContagens(data.contagens);
        if (data.movimentacoesStock) setMovimentacoesStock(data.movimentacoesStock);
        if (data.ultimaFaturaInserida !== undefined) setUltimaFaturaInserida(data.ultimaFaturaInserida);
        
        showNotification('‚úÖ Backup restaurado com sucesso!', 'success');
        return true;
      }
    } catch (error) {
      console.error('Erro ao carregar backup:', error);
      showNotification('‚ùå Erro ao carregar backup', 'error');
    } finally {
      setDriveSyncing(false);
    }
    return false;
  };
  
  // Limpar backups antigos (manter apenas os √∫ltimos X)
  const cleanOldBackups = async (token) => {
    try {
      const backups = await listDriveBackups(token);
      
      if (backups.length <= GOOGLE_DRIVE_CONFIG.MAX_BACKUPS) {
        return; // Nada a limpar
      }
      
      // Eliminar os mais antigos
      const toDelete = backups.slice(GOOGLE_DRIVE_CONFIG.MAX_BACKUPS);
      
      for (const backup of toDelete) {
        await fetch(
          `https://www.googleapis.com/drive/v3/files/${backup.id}`,
          { 
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          }
        );
      }
      
      console.log(`üóëÔ∏è ${toDelete.length} backups antigos eliminados`);
    } catch (error) {
      console.error('Erro ao limpar backups antigos:', error);
    }
  };

  const saveToDrive = async () => {
    if (!driveAccessToken) {
      showNotification('‚ö†Ô∏è N√£o conectado', 'error');
      return;
    }
    
    // ‚úÖ Verificar se token EXPIROU COMPLETAMENTE (0 minutos)
    const timeLeft = GoogleDriveTokenManager.getTimeUntilExpiry();
    if (timeLeft === 0) {
      showNotification('üîí Token expirado. Clique no indicador do Drive para renovar.', 'error');
      return;
    }
    
    // ‚ö†Ô∏è Avisar se est√° a expirar em breve, mas PERMITIR sync
    if (timeLeft > 0 && timeLeft <= 5) {
      showNotification(`‚ö†Ô∏è Token expira em ${timeLeft} min. Renove ap√≥s o sync!`, 'warning');
    }
    
    try {
      setDriveSyncing(true);
      setDriveError(null);
      
      const data = {
        produtos: produtos || [],
        ingredientes: ingredientes || [],
        vendas: vendas || [],
        faturas: faturas || [],
        fornecedores: fornecedores || [],
        dadosEmpresa: dadosEmpresa || {},
        deliveryApps: deliveryApps || [],
        blacklist: blacklist || [],
        templatesOCR: templatesOCR || [],
        vocabularioFornecedor: vocabularioFornecedor || [],
        configuracaoWaste: configuracaoWaste || {},
        contagens: contagens || [],
        movimentacoesStock: movimentacoesStock || [],
        ultimaFaturaInserida: ultimaFaturaInserida || null,
        lastUpdate: new Date().toISOString()
      };
      
      // üõ°Ô∏è VALIDA√á√ÉO DE SEGURAN√áA - Prevenir guardar dados vazios
      const totalRecords = (produtos?.length || 0) + (ingredientes?.length || 0) + (vendas?.length || 0);
      
      if (totalRecords < 5) {
        const confirmSave = confirm(
          `‚ö†Ô∏è AVISO DE SEGURAN√áA\n\n` +
          `Os dados parecem suspeitos:\n` +
          `‚Ä¢ Produtos: ${produtos?.length || 0}\n` +
          `‚Ä¢ Ingredientes: ${ingredientes?.length || 0}\n` +
          `‚Ä¢ Vendas: ${vendas?.length || 0}\n\n` +
          `Isto pode indicar que os dados n√£o carregaram corretamente.\n\n` +
          `Confirma que quer SOBRESCREVER o backup no Drive?`
        );
        
        if (!confirmSave) {
          showNotification('‚ùå Sincroniza√ß√£o cancelada por seguran√ßa', 'warning');
          setDriveSyncing(false);
          return;
        }
      }
      
      // üÜï CRIAR BACKUP VERSIONADO (com timestamp)
      await createVersionedBackup(driveAccessToken, data);
      console.log('‚úÖ Backup versionado criado');
      
      // üßπ LIMPAR BACKUPS ANTIGOS (manter apenas √∫ltimos 10)
      await cleanOldBackups(driveAccessToken);
      
      // Atualizar ficheiro principal (opcional - podemos remover isto se quiseres)
      let fileId = driveFileId;
      if (!fileId) {
        const existingFile = await findDriveFile(driveAccessToken);
        if (existingFile) {
          fileId = existingFile.id;
          setDriveFileId(fileId);
          localStorage.setItem('munchi_drive_file_id', fileId);
        }
      }
      
      if (fileId) {
        await updateDriveFile(driveAccessToken, fileId, data);
      } else {
        await createDriveFile(driveAccessToken, data);
      }
      
      setDriveLastSync(new Date());
      showNotification('‚úÖ Sincronizado com backup!', 'success');
      
    } catch (error) {
      console.error('Erro ao sincronizar:', error);
      
      // ‚úÖ Detetar erro de autentica√ß√£o (401/403)
      const errorMessage = error.message || String(error);
      if (errorMessage.includes('401') || errorMessage.includes('403') || errorMessage.includes('Unauthorized')) {
        showNotification('üîí Token inv√°lido. A solicitar nova autentica√ß√£o...', 'error');
        logoutGoogleDrive();
        return;
      }
      
      setDriveError('Erro ao sincronizar');
      showNotification('‚ùå Erro ao sincronizar', 'error');
    } finally {
      setDriveSyncing(false);
    }
  };

  // === GOOGLE DRIVE OCR ===
  /**
   * Converte PDF para Google Doc usando OCR do Google
   * Retorna texto extra√≠do com alta qualidade
   */
  const convertPDFToGoogleDocOCR = async (pdfFile, token = driveAccessToken) => {
    if (!token) {
      throw new Error('Token Google Drive n√£o dispon√≠vel');
    }

    try {
      void 0;
      
      // 1. Upload PDF para Google Drive
      const metadata = {
        name: `ocr_temp_${Date.now()}.pdf`,
        mimeType: 'application/pdf'
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', pdfFile);

      const uploadResponse = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
        {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: form
        }
      );

      if (!uploadResponse.ok) {
        throw new Error('Falha ao fazer upload do PDF');
      }

      const uploadResult = await uploadResponse.json();
      const pdfFileId = uploadResult.id;
      void 0;

      // 2. Copiar PDF como Google Doc (Google faz OCR automaticamente)
      void 0;
      
      const copyResponse = await fetch(
        `https://www.googleapis.com/drive/v3/files/${pdfFileId}/copy`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: `ocr_doc_${Date.now()}`,
            mimeType: 'application/vnd.google-apps.document'
          })
        }
      );

      if (!copyResponse.ok) {
        const errorText = await copyResponse.text();
        void 0;
        throw new Error('Falha ao converter PDF para Google Doc');
      }

      const docResult = await copyResponse.json();
      const docFileId = docResult.id;
      void 0;

      // 3. Exportar Google Doc como texto plain (funcionava antes)
      void 0;
      
      const exportResponse = await fetch(
        `https://www.googleapis.com/drive/v3/files/${docFileId}/export?mimeType=text/plain`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (!exportResponse.ok) {
        throw new Error('Falha ao exportar texto');
      }

      const textContent = await exportResponse.text();
      
      void 0;
      void 0;

      // 4. Limpar ficheiros tempor√°rios do Drive
      await fetch(
        `https://www.googleapis.com/drive/v3/files/${pdfFileId}`,
        {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );
      await fetch(
        `https://www.googleapis.com/drive/v3/files/${docFileId}`,
        {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );
      void 0;

      return textContent;
    } catch (error) {
      void 0;
      throw error;
    }
  };

  // üÜï FUN√á√ÉO DE DETE√á√ÉO DE NIF DO CLIENTE
  /**
   * Deteta se o texto OCR cont√©m o NIF configurado
   * Procura por padr√µes como:
   * - "Contribuinte: 123456789"
   * - "NIF: 123456789"
   * - "NIPC: 123456789"
   * - "Contribuinte N.¬∫ 123456789"
   */
  const detetarNifCliente = (textoOCR, nifProcurado) => {
    if (!textoOCR || !nifProcurado) return false;
    
    // Limpar o NIF (s√≥ n√∫meros)
    const nifLimpo = nifProcurado.replace(/\D/g, '');
    
    if (nifLimpo.length !== 9) return false;
    
    console.log(`üîç [NIF] Procurando NIF ${nifLimpo} no texto...`);
    
    // Padr√µes para procurar o NIF
    const padroes = [
      // "Contribuinte: 123456789" ou "Contribuinte 123456789"
      new RegExp(`Contribuinte[:\\s]+${nifLimpo}`, 'i'),
      
      // "NIF: 123456789" ou "NIF 123456789"
      new RegExp(`NIF[:\\s]+${nifLimpo}`, 'i'),
      
      // "NIPC: 123456789"
      new RegExp(`NIPC[:\\s]+${nifLimpo}`, 'i'),
      
      // "Contribuinte N.¬∫ 123456789"
      new RegExp(`Contribuinte\\s+N[.¬∫¬∞]+\\s*${nifLimpo}`, 'i'),
      
      // "NIF N.¬∫ 123456789"
      new RegExp(`NIF\\s+N[.¬∫¬∞]+\\s*${nifLimpo}`, 'i'),
      
      // Formato com espa√ßos: "123 456 789"
      new RegExp(nifLimpo.replace(/(\d{3})(\d{3})(\d{3})/, '$1\\s*$2\\s*$3')),
      
      // üîç Procurar tamb√©m com poss√≠veis erros de OCR
      // "1Z3456789" (Z em vez de 2), "12345678Q" (Q em vez de 9), etc
      new RegExp(
        nifLimpo
          .split('')
          .map(d => {
            // Mapear d√≠gitos com letras que OCR pode confundir
            const confusoes = {
              '0': '[0OoQD]',
              '1': '[1IlL]',
              '2': '[2Z]',
              '3': '[3]',
              '4': '[4]',
              '5': '[5S]',
              '6': '[6G]',
              '7': '[7]',
              '8': '[8B]',
              '9': '[9gq]'
            };
            return confusoes[d] || d;
          })
          .join('\\s*'),
        'i'
      )
    ];
    
    // Verificar se algum padr√£o match
    for (const padrao of padroes) {
      if (padrao.test(textoOCR)) {
        console.log(`‚úÖ [NIF] NIF ${nifLimpo} ENCONTRADO no texto!`);
        return true;
      }
    }
    
    console.log(`‚ö†Ô∏è [NIF] NIF ${nifLimpo} N√ÉO encontrado no texto`);
    return false;
  };

  /**
   * Handler para importar fatura do Google Drive com OCR
   * Usa Google Picker para escolher ficheiro do Drive
   */
  const handleImportarDriveComOCR = async () => {
    if (!driveAccessToken) {
      showNotification('‚ö†Ô∏è Fa√ßa login no Google Drive primeiro', 'error');
      return;
    }

    // Verificar se Google Picker est√° carregado
    if (!window.gapi) {
      showNotification('‚ö†Ô∏è Google API ainda n√£o carregou. Aguarde...', 'error');
      return;
    }

    try {
      // Carregar Google Picker API
      await new Promise((resolve) => {
        window.gapi.load('picker', resolve);
      });

      // Criar Google Picker para escolher PDF do Drive
      const picker = new window.google.picker.PickerBuilder()
        .addView(
          new window.google.picker.DocsView(window.google.picker.ViewId.DOCS)
            .setMimeTypes('application/pdf')
            .setIncludeFolders(true) // ‚úÖ Permite ver pastas
        )
        .setOAuthToken(driveAccessToken)
        .setDeveloperKey(GOOGLE_DRIVE_CONFIG.API_KEY)
        .setCallback(async (data) => {
          if (data.action === window.google.picker.Action.PICKED) {
            const file = data.docs[0];
            const fileId = file.id;
            const fileName = file.name;

            try {
              setProcessandoOCR(true);
              setProgressoOCR('Baixando PDF do Drive...');

              // 1. Baixar PDF do Drive
              const downloadResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                {
                  headers: { 'Authorization': `Bearer ${driveAccessToken}` }
                }
              );

              if (!downloadResponse.ok) {
                throw new Error('Falha ao baixar PDF do Drive');
              }

              const pdfBlob = await downloadResponse.blob();
              const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

              setProgressoOCR('Convertendo com Google OCR...');

              // 2. Converter PDF usando Google OCR
              const textoExtraido = await convertPDFToGoogleDocOCR(pdfFile, driveAccessToken);
              
              if (!textoExtraido || textoExtraido.length < 50) {
                throw new Error('Texto extra√≠do est√° vazio ou muito curto');
              }

              setProgressoOCR('Processando fatura...');

              // 3. Processar texto limpo do Google
              const dadosFatura = processarTextoFatura(textoExtraido, fornecedores); // ‚úÖ PASSAR FORNECEDORES
              void 0;

              // 4. Parsear linhas de produtos
              void 0;
              const template = buscarTemplateOCR(dadosFatura.fornecedor.nif);
              const linhas = template 
                ? parseComTemplate(textoExtraido, template) 
                : parseLinhasProdutos(textoExtraido, dadosFatura.fornecedor.nif); // üö´ CORRIGIDO: Passar NIF para usar blacklist
              
              void 0;
              if (linhas.length > 0) {
                void 0;
              }

              // 5. Converter PDF para base64 (para guardar na fatura)
              const reader = new FileReader();
              const base64Promise = new Promise((resolve) => {
                reader.onloadend = () => {
                  const base64 = reader.result.split(',')[1];
                  resolve(base64);
                };
                reader.readAsDataURL(pdfBlob);
              });
              
              const pdfBase64 = await base64Promise;

              // 6. Criar metadata completa
              const metadata = {
                numeroFatura: dadosFatura.numero,
                data: dadosFatura.data,
                nif: dadosFatura.fornecedor.nif,
                fornecedor: dadosFatura.fornecedor.nome,
                total: dadosFatura.totais.total,
                pdfBase64: pdfBase64,
                pdfNome: fileName,
                textoCompleto: textoExtraido,
                precosComIVA: dadosFatura.precosComIVA,
                metodoOCR: 'Google Drive OCR'
              };
              
              // üÜï DETECTAR SE TEM NIF DO CLIENTE
              const nifEmpresa = configuracoes.metricas.nifEmpresa;
              if (nifEmpresa) {
                const temNifCliente = detetarNifCliente(textoExtraido, nifEmpresa);
                metadata.temNifCliente = temNifCliente;
                metadata.nifClienteDetetado = temNifCliente ? nifEmpresa : null;
                console.log(`üîç [NIF] Dete√ß√£o: ${temNifCliente ? 'ENCONTRADO' : 'N√ÉO encontrado'}`);
              } else {
                metadata.temNifCliente = false;
                metadata.nifClienteDetetado = null;
              }

              // 7. Criar URL do PDF para visualiza√ß√£o
              const pdfUrl = URL.createObjectURL(pdfBlob);

              // 8. Mostrar modal de confirma√ß√£o de fatura PRIMEIRO
              setModalConfirmacaoFatura({
                mostrar: true,
                dados: {
                  ...dadosFatura,
                  pdfUrl: pdfUrl,
                  metodoOCR: 'Google Drive OCR'
                }
              });

              // 9. Fazer matching dos ingredientes
              const linhasComMatch = linhas.length > 0 
                ? matchIngredientes(linhas, ingredientes)
                : [];
              
              // 10. Preparar modal de ingredientes (abre ap√≥s confirmar fatura)
              setLinhasOCR(linhasComMatch);
              setMetadataOCR(metadata);
              // N√ÉO abrir ainda - vai abrir quando confirmar fatura

              if (linhas.length === 0) {
                showNotification('‚úÖ Fatura processada! Nenhum produto detectado.', 'warning');
              } else {
                showNotification(`‚úÖ OCR conclu√≠do! ${linhas.length} produtos identificados.`, 'success');
              }
            } catch (error) {
              void 0;
              showNotification(`‚ùå Erro: ${error.message}. Tente com OCR local.`, 'error');
            } finally {
              setProcessandoOCR(false);
              setProgressoOCR('');
            }
          }
        })
        .build();

      picker.setVisible(true);
    } catch (error) {
      void 0;
      showNotification('‚ùå Erro ao abrir seletor do Drive', 'error');
    }
  };

  const loadFromDrive = async (token = driveAccessToken) => {
    if (!token) return;
    try {
      setDriveSyncing(true);
      const file = await findDriveFile(token);
      if (!file) {
        setDriveSyncing(false);
        return;
      }
      setDriveFileId(file.id);
      localStorage.setItem('munchi_drive_file_id', file.id);
      const response = await fetch(
        `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
        { headers: { 'Authorization': `Bearer ${token}` } }
      );
      if (response.ok) {
        const data = await response.json();
        if (data.produtos) setProdutos(data.produtos);
        if (data.ingredientes) setIngredientes(data.ingredientes);
        if (data.vendas) setVendas(data.vendas);
        if (data.faturas) setFaturas(data.faturas);
        if (data.fornecedores) setFornecedores(data.fornecedores);
        if (data.dadosEmpresa) setDadosEmpresa(data.dadosEmpresa);
        if (data.deliveryApps) setDeliveryApps(data.deliveryApps);
        
        // ‚úÖ BLACKLIST: Carregar do Drive
        if (data.blacklist && data.blacklist.length > 0) {
          setBlacklist(data.blacklist);
          // üö´ localStorage.setItem('munchi_blacklist', JSON.stringify(data.blacklist));
          void 0;
        } else {
          const localBlacklist = localStorage.getItem('munchi_blacklist');
          if (localBlacklist) {
            void 0;
          }
        }
        
        // ‚úÖ TEMPLATES OCR: Carregar
        if (data.templatesOCR && data.templatesOCR.length > 0) {
          setTemplatesOCR(data.templatesOCR);
          // Guardar tamb√©m no IndexedDB
          await IndexedDBStorage.saveTemplates(data.templatesOCR);
        }
        
        // üß† VOCABUL√ÅRIO DE APRENDIZAGEM: Carregar
        if (data.vocabularioFornecedor && data.vocabularioFornecedor.length > 0) {
          setVocabularioFornecedor(data.vocabularioFornecedor);
          // Guardar tamb√©m no IndexedDB
          await IndexedDBStorage.saveVocabulario(data.vocabularioFornecedor);
        }
        
        // üíæ INGREDIENTES & FORNECEDORES: Guardar no IndexedDB tamb√©m
        if (data.ingredientes && data.ingredientes.length > 0) {
          await IndexedDBStorage.saveIngredientes(data.ingredientes);
        }
        if (data.fornecedores && data.fornecedores.length > 0) {
          await IndexedDBStorage.saveFornecedores(data.fornecedores);
        }
        
        // üÜï WASTE TRACKING: Carregar configura√ß√£o e contagens
        if (data.configuracaoWaste) {
          setConfiguracaoWaste(data.configuracaoWaste);
          void 0;
        }
        if (data.contagens) {
          setContagens(data.contagens);
          void 0;
        }
        
        // üÜï STOCK INTELIGENTE: Carregar movimenta√ß√µes
        if (data.movimentacoesStock) {
          setMovimentacoesStock(data.movimentacoesStock);
          void 0;
        }
        
        // üÜï √öLTIMA FATURA INSERIDA: Carregar
        if (data.ultimaFaturaInserida !== undefined) {
          setUltimaFaturaInserida(data.ultimaFaturaInserida);
          void 0;
        }
        
        setDriveLastSync(new Date(file.modifiedTime));
        showNotification('‚úÖ Dados carregados!', 'success');
      }
    } catch (error) {
      void 0;
      setDriveError('Erro ao carregar');
    } finally {
      setDriveSyncing(false);
    }
  };

  useEffect(() => {
    const carregar = async () => {
      console.log('üöÄ CARREGANDO DADOS CR√çTICOS...');
      
      try {
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üì¶ CARREGAR DADOS CR√çTICOS DO INDEXEDDB (offline-ready)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const [vocab, ings, forns, temps] = await Promise.all([
          IndexedDBStorage.loadVocabulario(),
          IndexedDBStorage.loadIngredientes(),
          IndexedDBStorage.loadFornecedores(),
          IndexedDBStorage.loadTemplates()
        ]);
        
        // Se IndexedDB tiver dados, usar
        if (vocab.length > 0) setVocabularioFornecedor(vocab);
        if (ings.length > 0) setIngredientes(ings);
        if (forns.length > 0) setFornecedores(forns);
        if (temps.length > 0) setTemplatesOCR(temps);
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîÑ MIGRA√á√ÉO: localStorage ‚Üí IndexedDB (primeira vez)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const precisaMigrar = vocab.length === 0 || ings.length === 0 || forns.length === 0;
        
        if (precisaMigrar) {
          console.log('üîÑ Migrando dados de localStorage ‚Üí IndexedDB...');
          
          const [vocLS, ingsLS, fornsLS, tempsLS] = await Promise.all([
            window.storage.get('vocabularioFornecedor').catch(() => null),
            window.storage.get('ingredientes').catch(() => null),
            window.storage.get('fornecedores').catch(() => null),
            window.storage.get('templatesOCR').catch(() => null)
          ]);
          
          // Migrar e guardar no IndexedDB
          if (vocLS && vocab.length === 0) {
            const data = JSON.parse(vocLS.value);
            await IndexedDBStorage.saveVocabulario(data);
            setVocabularioFornecedor(data);
          }
          
          if (ingsLS && ings.length === 0) {
            const data = JSON.parse(ingsLS.value);
            await IndexedDBStorage.saveIngredientes(data);
            setIngredientes(data);
          }
          
          if (fornsLS && forns.length === 0) {
            const data = JSON.parse(fornsLS.value);
            await IndexedDBStorage.saveFornecedores(data);
            setFornecedores(data);
          }
          
          if (tempsLS && temps.length === 0) {
            const data = JSON.parse(tempsLS.value);
            await IndexedDBStorage.saveTemplates(data);
            setTemplatesOCR(data);
          }
          
          console.log('‚úÖ Migra√ß√£o completa!');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üßπ LIMPEZA: Remover dados desnecess√°rios do localStorage
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const keysParaLimpar = [
          'produtos',              // Carrega do Drive
          'vendas',                // Carrega do Drive
          'faturas',               // Carrega do Drive
          'despesas',              // Carrega do Drive
          'movimentacoesStock',    // 3.6 MB! Vai pro IndexedDB separado
          'ingredientes',          // Agora no IndexedDB
          'fornecedores',          // Agora no IndexedDB
          'vocabularioFornecedor', // Agora no IndexedDB
          'templatesOCR'           // Agora no IndexedDB
        ];
        
        let espacoLiberado = 0;
        keysParaLimpar.forEach(key => {
          const item = localStorage.getItem(key);
          if (item) {
            espacoLiberado += item.length;
            localStorage.removeItem(key);
          }
        });
        
        if (espacoLiberado > 0) {
          console.log('üßπ localStorage limpo:', (espacoLiberado / 1024).toFixed(0), 'KB liberados');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìä VERIFICAR ESPA√áO FINAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        try {
          let totalSize = 0;
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              totalSize += localStorage[key].length + key.length;
            }
          }
          const sizeInKB = (totalSize / 1024).toFixed(1);
          console.log(`üíæ localStorage: ${sizeInKB} KB (s√≥ configs)`);
        } catch (e) {
          // Ignorar erro
        }
        
        console.log('‚úÖ APP PRONTO! Dados cr√≠ticos carregados do IndexedDB');
        console.log('‚ÑπÔ∏è Produtos/vendas/faturas carregam do Drive quando conectar');
        
      } catch (e) {
        console.error('‚ùå Erro ao carregar dados:', e);
      }
    };
    carregar();
  }, []);

  // üö´ Expor fun√ß√£o de blacklist globalmente para o modal
  useEffect(() => {
    window._adicionarABlacklist = adicionarABlacklist;
    window._adicionarAPalavrasLimpar = adicionarAPalavrasLimpar;
    return () => {
      delete window._adicionarABlacklist;
      delete window._adicionarAPalavrasLimpar;
    };
  }, [templatesOCR]);

  // Close ingredient suggestions when changing tabs
  useEffect(() => {
    setShowIngredienteSuggestions(false);
  }, [activeTab, gestaoSubTab]);

  // üö´ LocalStorage desativado - ultimaFaturaInserida s√≥ vai pro Google Drive
  // useEffect(() => {
  //   if (ultimaFaturaInserida !== null) {
  //     window.storage.set('ultimaFaturaInserida', JSON.stringify(ultimaFaturaInserida)).catch(() => {});
  //   }
  // }, [ultimaFaturaInserida]);

  // üö´ LocalStorage desativado - apenas Google Drive √© usado
  // Os dados s√£o guardados automaticamente no Drive quando mudarem
  // useEffect(() => {
  //   const salvar = async () => {
  //     await Promise.all([...]);
  //   };
  //   salvar();
  // }, [produtos, ingredientes, ...]);
  
  // üÜï Log para debug - remover depois
  useEffect(() => {
    console.log('üíæ Dados alterados - ser√£o sincronizados no pr√≥ximo save do Google Drive');
  }, [produtos, ingredientes, vendas, despesas, fornecedores, dadosEmpresa, faturas, vocabularioFornecedor, templatesOCR]);


  const detectarCategoria = (nome) => {
    const n = nome.toLowerCase();
    const categorias = {
      'vegetais': ['alface', 'tomate', 'cebola', 'cenoura', 'batata', 'cogumelo', 'pimento', 'alho', 'couve', 'br√≥colos', 'espinafre'],
      'frutas': ['morango', 'banana', 'ma√ß√£', 'laranja', 'lim√£o', 'p√™ra', 'uva', 'mel√£o', 'melancia', 'kiwi', 'manga', 'abacaxi', 'framboesa', 'mirtilo', 'cereja', 'ameixa', 'p√™ssego', 'nectarina', 'damasco', 'figo', 't√¢mara', 'coco', 'abacate', 'fruta'],
      'carnes': ['frango', 'carne', 'porco', 'vaca', 'peru', 'bacon', 'salsicha', 'bife', 'costela'],
      'peixe': ['salm√£o', 'atum', 'bacalhau', 'camar√£o', 'polvo', 'lula', 'peixe', 'marisco'],
      'latic√≠nios': ['leite', 'queijo', 'iogurte', 'manteiga', 'nata', 'mozzarella', 'requeij√£o', 'mozarela'],
      'padaria': ['p√£o'],
      'pastelaria': ['farinha', 'fermento', 'chocolate', 'cacau', 'baunilha', 'am√™ndoa', 'noz'],
      'compotas': ['a√ß√∫car', 'pectina', '√°cido c√≠trico'],
      'bebidas': ['√°gua', 'sumo', 'refrigerante', 'vinho', 'cerveja', 'caf√©', 'ch√°'],
      'temperos': ['sal', 'pimenta', 'azeite', 'vinagre', 'oreg√£os', 'especiaria', 'canela', 'colorau']
    };
    
    for (const [cat, keywords] of Object.entries(categorias)) {
      if (keywords.some(k => n.includes(k))) return cat;
    }
    return 'outros';
  };

  const adicionarIngrediente = () => {
    if (!novoIngrediente.nome || !novoIngrediente.custoUnitario) {
      showNotification('Preencha nome e custo!', 'error');
      return;
    }
    const custoComIva = parseFloat(novoIngrediente.custoUnitario);
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    
    setIngredientes([...ingredientes, { 
      id: Date.now(), 
      ...novoIngrediente, 
      custoUnitario: custoComIva,
      custoSemIva: custoSemIva,
      iva: iva,
      categoria: novoIngrediente.categoria || 'outros'
    }]);
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    showNotification('Ingrediente adicionado!', 'success');
  };
  
  // CRIAR INGREDIENTE INLINE NA FATURA
  const criarIngredienteInline = () => {
    if (!novoIngrediente.nome) {
      showNotification('Preencha o nome do ingrediente!', 'error');
      return;
    }
    
    // NOVO: Se tiver pre√ßo total e quantidade na embalagem, calcular custo unit√°rio automaticamente
    let custoComIva;
    if (novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem) {
      const precoTotal = parseFloat(novoIngrediente.precoTotal);
      const qtdEmbalagem = parseFloat(novoIngrediente.quantidadeEmbalagem);
      custoComIva = precoTotal / qtdEmbalagem; // Ex: ‚Ç¨21.29 / 12 unidades = ‚Ç¨1.77/un
    } else if (novoIngrediente.custoUnitario) {
      custoComIva = parseFloat(novoIngrediente.custoUnitario);
    } else {
      showNotification('Preencha o pre√ßo total e quantidade na embalagem, ou o custo unit√°rio!', 'error');
      return;
    }
    
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    const quantidade = parseFloat(novoIngrediente.quantidade || 1);
    
    // CONVERS√ÉO: Custo √© SEMPRE por kg/L, mas quantidade pode estar em g/ml
    let quantidadeEmUnidadeBase = quantidade;
    if (novoIngrediente.unidade === 'g') {
      quantidadeEmUnidadeBase = quantidade / 1000; // 500g ‚Üí 0.5kg
    } else if (novoIngrediente.unidade === 'ml') {
      quantidadeEmUnidadeBase = quantidade / 1000; // 500ml ‚Üí 0.5L
    }
    // kg, L, un ‚Üí n√£o converte (j√° est√° em unidade base)
    
    const precoTotal = custoComIva * quantidadeEmUnidadeBase;
    
    const novoIng = { 
      id: Date.now(), 
      nome: novoIngrediente.nome,
      unidade: novoIngrediente.unidade,
      custoUnitario: custoComIva, // sempre em kg/L
      custoSemIva: custoSemIva,
      iva: iva,
      categoria: novoIngrediente.categoria || 'outros'
    };
    
    // Adiciona aos ingredientes
    setIngredientes([...ingredientes, novoIng]);
    
    // Seleciona automaticamente o ingrediente criado COM a quantidade
    setItemFatura({
      ...itemFatura,
      ingredienteId: novoIng.id,
      quantidade: quantidade.toString(), // quantidade original (500g)
      unidade: novoIng.unidade, // unidade original (g)
      precoTotal: precoTotal.toFixed(2), // pre√ßo convertido
      iva: novoIng.iva.toString()
    });
    
    // Reset
    setCriandoIngrediente(false);
    setSearchIngredienteFatura(novoIng.nome);
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
    
    showNotification(`‚ú® Ingrediente "${novoIng.nome}" criado e adicionado √† fatura!`, 'success');
  };
  
  const adicionarEmbalagem = () => {
    if (!novaEmbalagem.nome || !novaEmbalagem.custoUnitario) {
      showNotification('Preencha nome e custo da embalagem!', 'error');
      return;
    }
    setEmbalagens([...embalagens, {
      id: Date.now(),
      ...novaEmbalagem,
      custoUnitario: parseFloat(novaEmbalagem.custoUnitario)
    }]);
    setNovaEmbalagem({ nome: '', custoUnitario: '', categoria: 'copos' });
    showNotification('Embalagem adicionada!', 'success');
  };
  
  const toggleApp = (appId) => {
    setDeliveryApps(deliveryApps.map(app => 
      app.id === appId ? { ...app, ativo: !app.ativo } : app
    ));
    const app = deliveryApps.find(a => a.id === appId);
    showNotification(`${app.nome} ${app.ativo ? 'desativada' : 'ativada'}!`, 'success');
  };
  
  const atualizarComissaoApp = (appId, novaComissao) => {
    setDeliveryApps(deliveryApps.map(app => 
      app.id === appId ? { 
        ...app, 
        comissao: parseFloat(novaComissao),
        dataAtualizacao: new Date().toISOString().split('T')[0]
      } : app
    ));
    setEditandoApp(null);
    showNotification('Comiss√£o atualizada!', 'success');
  };
  
  const adicionarNovaApp = () => {
    if (!novaApp.nome || !novaApp.comissao) {
      showNotification('Preencha nome e comiss√£o!', 'error');
      return;
    }
    setDeliveryApps([...deliveryApps, {
      id: Date.now().toString(),
      nome: novaApp.nome,
      comissao: parseFloat(novaApp.comissao),
      ativo: false,
      cor: '#' + Math.floor(Math.random()*16777215).toString(16),
      dataAtualizacao: new Date().toISOString().split('T')[0]
    }]);
    setNovaApp({ nome: '', comissao: '25' });
    showNotification('App adicionada!', 'success');
  };
  
  const apagarApp = (appId) => {
    if (confirm('Apagar esta app?')) {
      setDeliveryApps(deliveryApps.filter(app => app.id !== appId));
      showNotification('App apagada!', 'success');
    }
  };
  
  const editarIngrediente = (ingrediente) => {
    void 0;
    
    setNovoIngrediente({
      nome: ingrediente.nome || '',
      unidade: ingrediente.unidade || 'kg',
      custoUnitario: (ingrediente.custoUnitario || ingrediente.preco || 0).toString(),
      iva: (ingrediente.iva || 23).toString(),
      categoria: ingrediente.categoria || 'outros'
    });
    setEditandoIngrediente(true);
    setIngredienteEditandoId(ingrediente.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarIngrediente = () => {
    void 0;
    void 0;
    void 0;
    
    if (!novoIngrediente.nome || !novoIngrediente.custoUnitario) {
      void 0;
      showNotification('Preencha nome e custo!', 'error');
      return;
    }
    
    const ingredienteAntigo = ingredientes.find(i => i.id === ingredienteEditandoId);
    
    if (!ingredienteAntigo) {
      void 0;
      showNotification('Erro: ingrediente n√£o encontrado!', 'error');
      return;
    }
    
    const custoNovo = parseFloat(novoIngrediente.custoUnitario);
    const custoAntigo = ingredienteAntigo.custoUnitario || ingredienteAntigo.precoUnitario || 0;
    const diferenca = Math.abs(custoNovo - custoAntigo);
    const diferencaPerc = custoAntigo > 0 ? (diferenca / custoAntigo) * 100 : 100;
    
    void 0;
    void 0;
    void 0;
    
    // Se pre√ßo mudou mais de 5%, mostrar alerta
    if (diferencaPerc > 5) {
      // Encontrar produtos afetados
      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId === ingredienteEditandoId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId === ingredienteEditandoId);
        const custoAntes = receitaItem.quantidade * custoAntigo;
        const custoDepois = receitaItem.quantidade * custoNovo;
        const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          return s + (r.quantidade * (ing?.custoUnitario || 0));
        }, 0);
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes
        };
      });
      
      setPriceAlertData({
        ingrediente: ingredienteAntigo,
        precoAtual: custoAntigo,
        precoNovo: custoNovo,
        diferencaPerc,
        produtosAfetados,
        ingredienteData: novoIngrediente,
        tipoFatura: 'ingrediente' // Marca como edi√ß√£o de ingrediente
      });
      setShowPriceAlert(true);
      return; // N√£o atualiza ainda
    }
    
    // Se pre√ßo n√£o mudou muito, atualiza normalmente
    atualizarIngredienteSemAlerta();
  };
  
  const atualizarIngredienteSemAlerta = () => {
    void 0;
    void 0;
    void 0;
    
    const custoComIva = parseFloat(novoIngrediente.custoUnitario);
    const iva = parseFloat(novoIngrediente.iva);
    const custoSemIva = custoComIva / (1 + iva / 100);
    
    void 0;
    void 0;
    void 0;
    
    const ingredientesAtualizados = (ingredientes || []).map(i => {
      if (i.id === ingredienteEditandoId) {
        void 0;
        return {
          ...i,
          nome: novoIngrediente.nome,
          unidade: novoIngrediente.unidade,
          custoUnitario: custoComIva,
          precoUnitario: custoComIva, // ‚úÖ MANTER COMPATIBILIDADE
          custoSemIva: custoSemIva,
          iva: iva,
          categoria: novoIngrediente.categoria || 'outros'
        };
      }
      return i;
    });
    
    void 0;
    
    setIngredientes(ingredientesAtualizados);
    
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    setEditandoIngrediente(false);
    setIngredienteEditandoId(null);
    showNotification('Ingrediente atualizado!', 'success');
  };
  
  const cancelarEdicaoIngrediente = () => {
    setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros' });
    setEditandoIngrediente(false);
    setIngredienteEditandoId(null);
  };

  // üÜï FUN√á√ïES DE CONTAGEM MANUAL
  const abrirContagem = (ingrediente) => {
    setIngredienteContagem(ingrediente);
    setValorContagem(ingrediente.stockAtual || 0);
    setModalContagem(true);
  };
  
  const salvarContagem = () => {
    if (!ingredienteContagem) return;
    
    const novoStock = parseFloat(valorContagem) || 0;
    const ingrediente = ingredientes.find(ing => ing.id === ingredienteContagem.id);
    if (!ingrediente) return;
    
    // üÜï CALCULAR STOCK TE√ìRICO baseado em movimenta√ß√µes
    const movimentacoesIngrediente = movimentacoesStock.filter(m => m.ingredienteId === ingrediente.id);
    let stockTeorico = 0;
    
    movimentacoesIngrediente.forEach(mov => {
      if (mov.tipo === 'entrada') {
        stockTeorico += mov.quantidade;
      } else if (mov.tipo === 'saida') {
        stockTeorico -= mov.quantidade;
      } else if (mov.tipo === 'ajuste') {
        stockTeorico += mov.quantidade; // ajuste pode ser + ou -
      }
    });
    
    // Se n√£o h√° movimenta√ß√µes, usar stock atual como base
    if (movimentacoesIngrediente.length === 0) {
      stockTeorico = ingrediente.stockAtual || 0;
    }
    
    // üÜï CALCULAR AJUSTE NECESS√ÅRIO
    const ajuste = novoStock - stockTeorico;
    const desperdicio = Math.max(0, stockTeorico - novoStock);
    const percentagem = stockTeorico > 0 ? (desperdicio / stockTeorico) * 100 : 0;
    
    // üÜï CRIAR MOVIMENTA√á√ÉO DE AJUSTE (se houver diferen√ßa)
    if (Math.abs(ajuste) > 0.001) { // Toler√¢ncia para erros de arredondamento
      const tipoAjuste = ajuste < 0 ? 'desperd√≠cio' : 'excesso';
      const movimentacaoAjuste = {
        id: Date.now() + Math.random(),
        data: new Date().toISOString().split('T')[0],
        tipo: 'ajuste',
        subTipo: tipoAjuste,
        ingredienteId: ingrediente.id,
        ingredienteNome: ingrediente.nome,
        quantidade: ajuste,
        unidade: ingrediente.unidade,
        stockAnterior: stockTeorico,
        stockNovo: novoStock,
        observacao: ajuste < 0 
          ? `Ajuste invent√°rio: ${Math.abs(ajuste).toFixed(2)} ${ingrediente.unidade} de desperd√≠cio (${percentagem.toFixed(1)}%)`
          : `Ajuste invent√°rio: +${ajuste.toFixed(2)} ${ingrediente.unidade} excesso detectado`
      };
      
      setMovimentacoesStock(prev => [...prev, movimentacaoAjuste]);
    }
    
    // Atualizar ingrediente com novo stock
    setIngredientes(ingredientes.map(ing => {
      if (ing.id !== ingredienteContagem.id) return ing;
      
      // Criar registro de contagem para hist√≥rico
      const novaContagem = {
        id: Date.now(),
        data: new Date().toISOString(),
        stockTeorico: stockTeorico,
        stockReal: novoStock,
        desperdicio: desperdicio,
        percentagem: percentagem,
        ajuste: ajuste,
        observacoes: ''
      };
      
      // Adicionar contagem ao hist√≥rico global
      setContagens(prev => [...prev, {
        ...novaContagem,
        ingredienteId: ing.id,
        ingredienteNome: ing.nome,
        unidade: ing.unidade
      }]);
      
      return {
        ...ing,
        stockAtual: novoStock,
        ultimaContagem: new Date().toISOString(),
        historicoContagens: [...(ing.historicoContagens || []), novaContagem]
      };
    }));
    
    // Mensagem de feedback
    if (Math.abs(ajuste) > 0.001) {
      if (ajuste < 0) {
        showNotification(
          `Stock atualizado: ${novoStock} ${ingrediente.unidade} | Desperd√≠cio: ${Math.abs(ajuste).toFixed(2)} ${ingrediente.unidade} (${percentagem.toFixed(1)}%)`,
          'warning'
        );
      } else {
        showNotification(
          `Stock atualizado: ${novoStock} ${ingrediente.unidade} | Excesso: +${ajuste.toFixed(2)} ${ingrediente.unidade}`,
          'success'
        );
      }
    } else {
      showNotification(`Stock confirmado: ${novoStock} ${ingrediente.unidade} ‚úì`, 'success');
    }
    
    setModalContagem(false);
    setIngredienteContagem(null);
    setValorContagem(0);
  };

  const adicionarProduto = () => {
    if (!novoProduto.nome || !novoProduto.precoVenda) {
      showNotification('Preencha nome e pre√ßo!', 'error');
      return;
    }
    setProdutos([...produtos, { id: Date.now(), ...novoProduto, precoVenda: parseFloat(novoProduto.precoVenda), iva: parseFloat(novoProduto.iva) }]);
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    showNotification('Produto adicionado!', 'success');
  };
  
  const editarProduto = (produto) => {
    setNovoProduto({
      nome: produto.nome,
      precoVenda: produto.precoVenda.toString(),
      iva: produto.iva.toString(),
      categoria: produto.categoria || 'cafes',
      receita: produto.receita || [],
      embalagens: produto.embalagens || [],
      porcoes: produto.porcoes || 1
    });
    setEditandoProduto(true);
    setProdutoEditandoId(produto.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarProduto = () => {
    if (!novoProduto.nome || !novoProduto.precoVenda) {
      showNotification('Preencha nome e pre√ßo!', 'error');
      return;
    }
    
    setProdutos(produtos.map(p => 
      p.id === produtoEditandoId ? {
        ...p,
        nome: novoProduto.nome,
        precoVenda: parseFloat(novoProduto.precoVenda),
        iva: parseFloat(novoProduto.iva),
        categoria: novoProduto.categoria || 'cafes',
        receita: novoProduto.receita,
        embalagens: novoProduto.embalagens || [],
        porcoes: novoProduto.porcoes || 1
      } : p
    ));
    
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', categoria: 'cafes', receita: [], embalagens: [], porcoes: 1 });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    setEditandoProduto(false);
    setProdutoEditandoId(null);
    showNotification('Produto atualizado!', 'success');
  };
  
  const cancelarEdicaoProduto = () => {
    setNovoProduto({ nome: '', precoVenda: '', iva: '6', receita: [] });
    setSearchIngrediente('');
    setShowIngredienteSuggestions(false);
    setEditandoProduto(false);
    setProdutoEditandoId(null);
  };

  // ===== FUN√á√ÉO PARA UPLOAD DE PDF (DESPESAS) =====
  const handlePDFUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    // Verificar se √© PDF
    if (file.type !== 'application/pdf') {
      showNotification('‚ö†Ô∏è Por favor, selecione apenas ficheiros PDF!', 'error');
      return;
    }
    
    // Limite de 5MB
    if (file.size > 5 * 1024 * 1024) {
      showNotification('‚ö†Ô∏è O ficheiro √© demasiado grande! M√°ximo 5MB.', 'error');
      return;
    }
    
    // Converter para base64
    const reader = new FileReader();
    reader.onload = (e) => {
      setNovaFatura({
        ...novaFatura,
        documentoPDF: e.target.result,
        nomeDocumento: file.name
      });
      showNotification(`‚úÖ PDF "${file.name}" carregado com sucesso!`, 'success');
    };
    reader.onerror = () => {
      showNotification('‚ùå Erro ao ler o ficheiro PDF!', 'error');
    };
    reader.readAsDataURL(file);
  };

  const adicionarDespesa = () => {
    if (!novaDespesa.descricao || !novaDespesa.valor) {
      showNotification('Preencha descri√ß√£o e valor!', 'error');
      return;
    }
    
    // Check price difference if ingredient selected
    if (novaDespesa.ingredienteId && novaDespesa.quantidade) {
      const ingrediente = ingredientes.find(i => i.id === novaDespesa.ingredienteId);
      const precoNovo = parseFloat(novaDespesa.valor) / parseFloat(novaDespesa.quantidade);
      const precoAtual = ingrediente.custoUnitario;
      const diferenca = Math.abs(precoNovo - precoAtual);
      const diferencaPerc = (diferenca / precoAtual) * 100;
      
      // Show alert if price differs by more than 5%
      if (diferencaPerc > 5) {
        // Find affected products
        const produtosAfetados = produtos.filter(p => 
          p.receita && p.receita.some(r => r.ingredienteId === novaDespesa.ingredienteId)
        ).map(p => {
          const receitaItem = p.receita.find(r => r.ingredienteId === novaDespesa.ingredienteId);
          const custoAntes = receitaItem.quantidade * precoAtual;
          const custoDepois = receitaItem.quantidade * precoNovo;
          const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
            const ing = ingredientes.find(i => i.id === r.ingredienteId);
            return s + (r.quantidade * (ing?.custoUnitario || 0));
          }, 0);
          const margemDepois = margemAntes - (custoDepois - custoAntes);
          
          return {
            nome: p.nome,
            margemDif: margemDepois - margemAntes
          };
        });
        
        setPriceAlertData({
          ingrediente,
          precoAtual,
          precoNovo,
          diferencaPerc,
          produtosAfetados,
          despesaData: novaDespesa
        });
        setShowPriceAlert(true);
        return; // Don't add yet, wait for user decision
      }
    }
    
    // Add expense normally
    if (novaDespesa.fornecedor && !fornecedores.includes(novaDespesa.fornecedor)) {
      setFornecedores([...fornecedores, novaDespesa.fornecedor]);
    }
    
    setDespesas([...despesas, { 
      id: Date.now(), 
      ...novaDespesa, 
      valor: parseFloat(novaDespesa.valor), 
      iva: parseFloat(novaDespesa.iva),
      quantidade: novaDespesa.quantidade ? parseFloat(novaDespesa.quantidade) : null
    }]);
    
    // üÜï Se for compra de ingrediente, registrar entrada no stock
    if (novaDespesa.categoria === 'compras' && novaDespesa.ingredienteId && stockRastreamentoAtivo) {
      registrarEntradaStock({
        ingredienteId: novaDespesa.ingredienteId,
        quantidade: parseFloat(novaDespesa.quantidade || 0),
        unidade: novaDespesa.unidade || 'kg',
        precoTotal: parseFloat(novaDespesa.valor || 0),
        data: novaDespesa.data,
        fornecedor: novaDespesa.fornecedor,
        numeroDocumento: novaDespesa.numeroDocumento
      });
    }
    
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    showNotification('Despesa adicionada!', 'success');
  };

  const adicionarVendaManual = () => {
    // Valida√ß√£o robusta do produtoId
    if (!novaVenda.produtoId || novaVenda.produtoId === '' || isNaN(novaVenda.produtoId)) {
      showNotification('‚ö†Ô∏è Selecione um produto!', 'error');
      return;
    }
    
    if (!novaVenda.quantidade || parseFloat(novaVenda.quantidade) <= 0) {
      showNotification('‚ö†Ô∏è Quantidade inv√°lida!', 'error');
      return;
    }
    
    const produto = produtos.find(p => p.id === parseInt(novaVenda.produtoId));
    if (!produto) {
      showNotification('‚ùå Produto n√£o encontrado!', 'error');
      return;
    }
    
    // Calcular valor
    let valorTotal;
    if (novaVenda.usarValorManual && novaVenda.valorManual) {
      valorTotal = parseFloat(novaVenda.valorManual);
    } else {
      valorTotal = produto.precoVenda * parseFloat(novaVenda.quantidade);
    }
    
    // Criar venda
    const vendaManual = {
      id: Date.now(),
      data: novaVenda.data,
      produto: produto.nome,
      produtoId: produto.id,
      quantidade: parseFloat(novaVenda.quantidade),
      valor: valorTotal,
      total: valorTotal, // ‚úÖ ADICIONAR CAMPO TOTAL
      iva: produto.iva,
      tipo: 'manual', // Marcar como manual
      origem: 'moloni' // ‚úÖ PARA FILTRO DE M√âTRICAS (vendas manuais = Moloni)
    };
    
    // üÜï Registrar sa√≠da de stock automaticamente
    if (stockRastreamentoAtivo && produto.receita && produto.receita.length > 0) {
      registrarSaidaStock({
        produtoId: produto.id,
        quantidade: parseFloat(novaVenda.quantidade),
        data: novaVenda.data
      });
    }
    
    setVendas([...vendas, vendaManual]);
    
    // Reset form
    setNovaVenda({
      data: new Date().toISOString().split('T')[0],
      produtoId: '',
      quantidade: 1,
      valorManual: '',
      usarValorManual: false,
      numeroDocumento: '',
      tipoDocumento: 'Venda',
      formaPagamento: 'Dinheiro',
      observacoes: ''
    });
    
    setMostrarVendaManual(false);
    showNotification('‚úÖ Venda adicionada com sucesso!', 'success');
  };

  const confirmarDespesaSemAtualizar = () => {
    const despesaData = priceAlertData.despesaData;
    
    if (despesaData.fornecedor && !fornecedores.includes(despesaData.fornecedor)) {
      setFornecedores([...fornecedores, despesaData.fornecedor]);
    }
    
    setDespesas([...despesas, { 
      id: Date.now(), 
      ...despesaData, 
      valor: parseFloat(despesaData.valor), 
      iva: parseFloat(despesaData.iva),
      quantidade: despesaData.quantidade ? parseFloat(despesaData.quantidade) : null
    }]);
    
    // üÜï Se for compra de ingrediente, registrar entrada no stock
    if (despesaData.categoria === 'compras' && despesaData.ingredienteId && stockRastreamentoAtivo) {
      registrarEntradaStock({
        ingredienteId: despesaData.ingredienteId,
        quantidade: parseFloat(despesaData.quantidade || 0),
        unidade: despesaData.unidade || 'kg',
        precoTotal: parseFloat(despesaData.valor || 0),
        data: despesaData.data,
        fornecedor: despesaData.fornecedor,
        numeroDocumento: despesaData.numeroDocumento
      });
    }
    
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    setShowPriceAlert(false);
    setPriceAlertData(null);
    showNotification('Despesa adicionada!', 'success');
  };

  const confirmarDespesaEAtualizar = () => {
    const { ingrediente, precoNovo, produtosAfetados, despesaData } = priceAlertData;
    
    // Update ingredient cost
    const updatedIngredientes = (ingredientes || []).map(i => 
      i.id === ingrediente.id ? { ...i, custoUnitario: precoNovo } : i
    );
    setIngredientes(updatedIngredientes);
    
    // Add expense
    if (despesaData.fornecedor && !fornecedores.includes(despesaData.fornecedor)) {
      setFornecedores([...fornecedores, despesaData.fornecedor]);
    }
    
    setDespesas([...despesas, { 
      id: Date.now(), 
      ...despesaData, 
      valor: parseFloat(despesaData.valor), 
      iva: parseFloat(despesaData.iva),
      quantidade: despesaData.quantidade ? parseFloat(despesaData.quantidade) : null
    }]);
    
    // üÜï Se for compra de ingrediente, registrar entrada no stock
    if (despesaData.categoria === 'compras' && despesaData.ingredienteId && stockRastreamentoAtivo) {
      registrarEntradaStock({
        ingredienteId: despesaData.ingredienteId,
        quantidade: parseFloat(despesaData.quantidade || 0),
        unidade: despesaData.unidade || 'kg',
        precoTotal: parseFloat(despesaData.valor || 0),
        data: despesaData.data,
        fornecedor: despesaData.fornecedor,
        numeroDocumento: despesaData.numeroDocumento
      });
    }
    
    setNovaDespesa({ 
      descricao: '', 
      valor: '', 
      iva: '23', 
      data: new Date().toISOString().split('T')[0], 
      categoria: 'compras',
      fornecedor: '',
      ingredienteId: null,
      quantidade: '',
      num_funcionarios: 1,
      frequencia_pagamento: 'mensal',
      numeroDocumento: '',
      tipoDocumento: 'Fatura',
      formaPagamento: 'Transfer√™ncia',
      notas: '',
      documentoPDF: null,
      nomeDocumento: ''
    });
    setSearchDespesaIngrediente('');
    setShowPriceAlert(false);
    setPriceAlertData(null);
    showNotification(`‚úÖ Custo do ${ingrediente.nome} atualizado! ${produtosAfetados.length} produtos recalculados`, 'success');
  };

  // ========== FUN√á√ïES PARA FATURAS ==========
  
  const confirmarFaturaSemAtualizar = () => {
    void 0;
    
    // CASO ESPECIAL: OCR Price Update Queue
    if (priceAlertData.tipoOperacao === 'ocrPriceUpdate') {
      const ctx = window._ocrContext;
      if (!ctx) {
        void 0;
        setShowPriceAlert(false);
        return;
      }
      
      void 0;
      
      // Avan√ßar para pr√≥xima mudan√ßa SEM aplicar a atual
      ctx.indiceAtual++;
      
      if (ctx.indiceAtual < ctx.mudancasPreco.length) {
        // Ainda h√° mudan√ßas - mostrar pr√≥ximo modal
        const proximaMudanca = ctx.mudancasPreco[ctx.indiceAtual];
        const proximoIngrediente = ctx.ingredientesAtualizados.find(i => i.id === proximaMudanca.ingredienteId);
        
        setPriceAlertData({
          tipoOperacao: 'ocrPriceUpdate',
          ingrediente: proximoIngrediente,
          precoAtual: proximaMudanca.precoAnterior,
          precoNovo: proximaMudanca.precoNovo,
          unidadeBase: proximoIngrediente.unidade,
          produtosAfetados: produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId === proximoIngrediente.id)
          ),
          totalMudancas: ctx.mudancasPreco.length,
          mudancaAtual: ctx.indiceAtual + 1
        });
        
        void 0;
        return; // Mant√©m modal aberto para pr√≥xima mudan√ßa
      } else {
        // Todas mudan√ßas processadas - finalizar
        void 0;
        setShowPriceAlert(false);
        setPriceAlertData(null);
        finalizarFaturaOCR(ctx.ingredientesAtualizados, ctx.linhasValidadas, ctx.metadata);
        window._ocrContext = null;
        return;
      }
    }
    
    // CASOS NORMAIS (n√£o-OCR) - Guardar sem atualizar custo
    if (priceAlertData.tipoOperacao === 'adicionarItem') {
      // Adicionar item SEM atualizar pre√ßo do ingrediente
      const item = priceAlertData.itemParaAdicionar;
      setNovaFatura({
        ...novaFatura,
        itens: [...novaFatura.itens, item]
      });
      setItemFatura({
        ingredienteId: '',
        quantidade: '',
        unidade: '',
        precoTotal: '',
        iva: '13'
      });
      showNotification('Item adicionado SEM atualizar pre√ßo base!', 'success');
    } else if (priceAlertData.tipoFatura === 'rapido') {
      salvarFaturaRapidaSemAlerta();
    } else if (priceAlertData.tipoFatura === 'edicao') {
      atualizarFaturaSemAlerta(priceAlertData.faturaData, priceAlertData.faturaEditandoId);
    } else if (priceAlertData.tipoFatura === 'ingrediente') {
      atualizarIngredienteSemAlerta();
    } else {
      salvarFaturaSemAlerta(priceAlertData.faturaData);
    }
    setShowPriceAlert(false);
    setPriceAlertData(null);
  };
  
  const confirmarFaturaEAtualizar = () => {
    void 0;
    const { ingrediente, precoNovo, produtosAfetados } = priceAlertData;
    
    // CASO ESPECIAL: OCR Price Update Queue
    if (priceAlertData.tipoOperacao === 'ocrPriceUpdate') {
      const ctx = window._ocrContext;
      if (!ctx) {
        void 0;
        setShowPriceAlert(false);
        return;
      }
      
      // Aplicar mudan√ßa atual
      const mudancaAtual = ctx.mudancasPreco[ctx.indiceAtual];
      ctx.ingredientesAtualizados[mudancaAtual.ingredienteIndex] = {
        ...ctx.ingredientesAtualizados[mudancaAtual.ingredienteIndex],
        custoUnitario: mudancaAtual.precoNovo,
        precoUnitario: mudancaAtual.precoNovo
      };
      
      void 0;
      
      // Avan√ßar para pr√≥xima mudan√ßa
      ctx.indiceAtual++;
      
      if (ctx.indiceAtual < ctx.mudancasPreco.length) {
        // Ainda h√° mudan√ßas - mostrar pr√≥ximo modal
        const proximaMudanca = ctx.mudancasPreco[ctx.indiceAtual];
        const proximoIngrediente = ctx.ingredientesAtualizados.find(i => i.id === proximaMudanca.ingredienteId);
        
        setPriceAlertData({
          tipoOperacao: 'ocrPriceUpdate',
          ingrediente: proximoIngrediente,
          precoAtual: proximaMudanca.precoAnterior,
          precoNovo: proximaMudanca.precoNovo,
          unidadeBase: proximoIngrediente.unidade,
          produtosAfetados: produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId === proximoIngrediente.id)
          ),
          totalMudancas: ctx.mudancasPreco.length,
          mudancaAtual: ctx.indiceAtual + 1
        });
        
        void 0;
        return; // Mant√©m modal aberto para pr√≥xima mudan√ßa
      } else {
        // Todas mudan√ßas confirmadas - finalizar
        void 0;
        setShowPriceAlert(false);
        setPriceAlertData(null);
        finalizarFaturaOCR(ctx.ingredientesAtualizados, ctx.linhasValidadas, ctx.metadata);
        window._ocrContext = null;
        return;
      }
    }
    
    // CASOS NORMAIS (n√£o-OCR)
    if (priceAlertData.tipoOperacao === 'adicionarItem') {
      // Atualizar custo do ingrediente E adicionar item
      setIngredientes(ingredientes.map(ing => 
        ing.id === ingrediente.id 
          ? { 
              ...ing, 
              custoUnitario: precoNovo,
              historicoPrecos: [
                ...(ing.historicoPrecos || []),
                { data: novaFatura.data, preco: precoNovo }
              ]
            }
          : ing
      ));
      
      const item = priceAlertData.itemParaAdicionar;
      setNovaFatura({
        ...novaFatura,
        itens: [...novaFatura.itens, item]
      });
      setItemFatura({
        ingredienteId: '',
        quantidade: '',
        unidade: '',
        precoTotal: '',
        iva: '13'
      });
      showNotification(`Item adicionado! Pre√ßo atualizado: ‚Ç¨${precoNovo.toFixed(2)}/${priceAlertData.unidadeBase}`, 'success');
    } else if (priceAlertData.tipoFatura !== 'ingrediente') {
      // Se for edi√ß√£o de ingrediente, N√ÉO atualiza custo (j√° est√° sendo atualizado)
      // Atualizar custo do ingrediente (para faturas)
      const updatedIngredientes = (ingredientes || []).map(i => 
        i.id == ingrediente.id ? { ...i, custoUnitario: precoNovo } : i
      );
      setIngredientes(updatedIngredientes);
    
      // Guardar/atualizar
      if (priceAlertData.tipoFatura === 'rapido') {
        salvarFaturaRapidaSemAlerta();
      } else if (priceAlertData.tipoFatura === 'edicao') {
        atualizarFaturaSemAlerta(priceAlertData.faturaData, priceAlertData.faturaEditandoId);
      } else if (priceAlertData.tipoFatura === 'ingrediente') {
        atualizarIngredienteSemAlerta();
      } else {
        salvarFaturaSemAlerta(priceAlertData.faturaData);
      }
      showNotification(`Custo do ${ingrediente.nome} atualizado! ${produtosAfetados.length} produtos afetados`, 'success');
    }
    setShowPriceAlert(false);
    setPriceAlertData(null);
  };
  
  const adicionarItemFatura = () => {
    void 0;
    
    // MODO COMPRAS - Valida√ß√£o para ingredientes
    if (novaFatura.categoria === 'compras') {
      if (!itemFatura.ingredienteId || !itemFatura.quantidade || !itemFatura.precoTotal || !itemFatura.unidade) {
        void 0;
        showNotification('Preencha todos os campos do item!', 'error');
        return;
      }
      
      const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
      void 0;
      
      if (!ingrediente) {
        showNotification('Ingrediente n√£o encontrado!', 'error');
      return;
    }
    
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    const iva = parseFloat(itemFatura.iva || '13');
    
    // CONVERTER para unidade base
    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === unidadeBase) {
      quantidadeBase = quantidade;
    }
    
    // CALCULAR pre√ßo por unidade base SEM IVA
    // O precoTotal INCLUI IVA, ent√£o primeiro removemos o IVA
    const subtotalSemIva = precoTotal / (1 + iva / 100);
    const precoPorUnidadeBase = subtotalSemIva / quantidadeBase;
    
    void 0;
    
    // VERIFICAR se pre√ßo mudou mais de 5%
    const precoAtual = ingrediente.custoUnitario;
    const diferenca = Math.abs(precoPorUnidadeBase - precoAtual);
    const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
    
    if (diferencaPerc > 5) {
      // Encontrar produtos afetados
      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId == itemFatura.ingredienteId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId == itemFatura.ingredienteId);
        
        // Converter quantidade da receita para unidade base se necess√°rio
        let quantidadeReceita = receitaItem.quantidade;
        const unidadeReceita = receitaItem.unidade || ingrediente.unidade;
        if (ingrediente.unidade === 'kg' && unidadeReceita === 'g') {
          quantidadeReceita = receitaItem.quantidade / 1000;
        } else if (ingrediente.unidade === 'L' && unidadeReceita === 'ml') {
          quantidadeReceita = receitaItem.quantidade / 1000;
        }
        
        const custoAntes = quantidadeReceita * precoAtual;
        const custoDepois = quantidadeReceita * precoPorUnidadeBase;
        
        // Calcular margem atual
        const custoTotalAntes = (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          if (!ing) return s;
          let q = r.quantidade;
          const ur = r.unidade || ing.unidade;
          if (ing.unidade === 'kg' && ur === 'g') q = r.quantidade / 1000;
          if (ing.unidade === 'L' && ur === 'ml') q = r.quantidade / 1000;
          return s + (q * ing.custoUnitario);
        }, 0);
        
        const margemAntes = p.precoVenda - custoTotalAntes;
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes,
          custoAntes,
          custoDepois
        };
      });
      
      // Guardar dados do item para processar depois
      const subtotalSemIva = precoTotal / (1 + iva / 100);
      const itemParaGuardar = {
        id: Date.now(),
        ingredienteId: itemFatura.ingredienteId,
        ingredienteNome: ingrediente.nome,
        unidade: unidadeCompra,
        quantidade,
        precoUnitario: precoPorUnidadeBase,
        iva,
        subtotal: subtotalSemIva
      };
      
      setPriceAlertData({
        ingrediente,
        precoAtual,
        precoNovo: precoPorUnidadeBase,
        diferencaPerc,
        produtosAfetados,
        itemParaAdicionar: itemParaGuardar,
        quantidadeBase,
        unidadeBase,
        tipoOperacao: 'adicionarItem'
      });
      setShowPriceAlert(true);
      return; // Para aqui, espera decis√£o do utilizador
    }
    
    // Se pre√ßo n√£o mudou muito (<5%), atualiza direto
    // ATUALIZAR custo do ingrediente
    setIngredientes(ingredientes.map(ing => 
      ing.id === ingrediente.id 
        ? { 
            ...ing, 
            custoUnitario: precoPorUnidadeBase,
            historicoPrecos: [
              ...(ing.historicoPrecos || []),
              { data: novaFatura.data, preco: precoPorUnidadeBase }
            ]
          }
        : ing
    ));
    
    // ADICIONAR item √† fatura (subtotalSemIva j√° foi calculado acima)
    const novoItem = {
      id: Date.now(),
      ingredienteId: itemFatura.ingredienteId,
      ingredienteNome: ingrediente.nome,
      unidade: unidadeCompra,
      quantidade,
      precoUnitario: precoPorUnidadeBase,
      iva,
      subtotal: subtotalSemIva
    };
    
    void 0;
    
    setNovaFatura({
      ...novaFatura,
      itens: [...novaFatura.itens, novoItem]
    });
    
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13',
      num_funcionarios: 1
    });
    
    // Resetar campo de pesquisa
    setSearchIngredienteFatura('');
    
    showNotification(`Item adicionado! Pre√ßo atualizado: ‚Ç¨${precoPorUnidadeBase.toFixed(2)}/${unidadeBase}`, 'success');
    return; // Fim do modo compras
    } // Fim do if categoria === 'compras'
    
    // MODO OUTRAS DESPESAS (n√£o-compras)
    if (!itemFatura.descricao || !itemFatura.precoTotal) {
      void 0;
      showNotification('Preencha descri√ß√£o e valor!', 'error');
      return;
    }
    
    const precoTotal = parseFloat(itemFatura.precoTotal);
    // SAL√ÅRIOS N√ÉO T√äM IVA!
    const iva = novaFatura.categoria === 'salarios' ? 0 : parseFloat(itemFatura.iva || '23');
    const subtotalSemIva = iva > 0 ? precoTotal / (1 + iva / 100) : precoTotal;
    
    const novoItem = {
      id: Date.now(),
      descricao: itemFatura.descricao,
      quantidade: 1, // Fixo para despesas
      unidade: 'servi√ßo', // Fixo para despesas
      precoUnitario: precoTotal, // Valor total = valor unit√°rio
      iva,
      subtotal: subtotalSemIva,
      num_funcionarios: itemFatura.num_funcionarios || 1 // Para sal√°rios
    };
    
    void 0;
    
    setNovaFatura({
      ...novaFatura,
      itens: [...novaFatura.itens, novoItem]
    });
    
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13',
      num_funcionarios: 1
    });
    
    showNotification('Item adicionado!', 'success');
  };
  
  const removerItemFatura = (itemId) => {
    setNovaFatura({
      ...novaFatura,
      itens: novaFatura.itens.filter(item => item.id !== itemId)
    });
  };
  
  const salvarFatura = () => {
    // Valida√ß√£o: fornecedor √© obrigat√≥rio EXCETO para sal√°rios
    if (novaFatura.categoria !== 'salarios' && !novaFatura.fornecedorId) {
      showNotification('Selecione um fornecedor!', 'error');
      return;
    }
    
    if ((novaFatura.itens || []).length === 0) {
      showNotification('Adicione pelo menos 1 item!', 'error');
      return;
    }
    
    // Gerar n√∫mero automaticamente APENAS para FATURAS (n√£o recibos)
    // Se n√£o tem tipoDocumento, assume fatura (retrocompatibilidade)
    const tipoDoc = novaFatura.tipoDocumento || 'fatura';
    
    if (tipoDoc === 'fatura' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const faturasHoje = (faturas || []).filter(f => f.data === novaFatura.data).length;
      novaFatura.numero = `FAT/${ano}/${String(faturasHoje + 1).padStart(4, '0')}`;
    }
    
    // Se √© recibo e n√£o tem n√∫mero, deixa null
    if (tipoDoc === 'recibo' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      novaFatura.numero = null;
    }
    
    // ‚úÖ PULAR VERIFICA√á√ÉO DE PRE√áOS se veio do OCR (j√° foi processada)
    if (novaFatura.fromOCR) {
      void 0;
      salvarFaturaSemAlerta();
      return;
    }
    
    // Verificar se algum item tem pre√ßo muito diferente
    let temAlertaPreco = false;
    for (const item of novaFatura.itens) {
      const ingrediente = ingredientes.find(i => i.id == item.ingredienteId);
      if (ingrediente) {
        const precoAtual = ingrediente.custoUnitario;
        const precoNovo = item.precoUnitario;
        const diferenca = Math.abs(precoNovo - precoAtual);
        const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
        
        if (diferencaPerc > 5) {
          // Mostrar alerta para o primeiro item com diferen√ßa > 5%
          const produtosAfetados = produtos.filter(p => 
            p.receita && p.receita.some(r => r.ingredienteId == item.ingredienteId)
          ).map(p => {
            const receitaItem = p.receita.find(r => r.ingredienteId == item.ingredienteId);
            const custoAntes = receitaItem.quantidade * precoAtual;
            const custoDepois = receitaItem.quantidade * precoNovo;
            const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
              const ing = ingredientes.find(i => i.id == r.ingredienteId);
              return s + (r.quantidade * (ing?.custoUnitario || 0));
            }, 0);
            const margemDepois = margemAntes - (custoDepois - custoAntes);
            
            return {
              nome: p.nome,
              margemDif: margemDepois - margemAntes
            };
          });
          
          setPriceAlertData({
            ingrediente,
            precoAtual,
            precoNovo,
            diferencaPerc,
            produtosAfetados,
            faturaData: novaFatura,
            tipoFatura: 'completa'
          });
          setShowPriceAlert(true);
          temAlertaPreco = true;
          return; // N√£o guarda ainda
        }
      }
    }
    
    // Se n√£o tem alerta, guarda normalmente
    if (!temAlertaPreco) {
      salvarFaturaSemAlerta();
    }
  };
  
  const salvarFaturaSemAlerta = (dadosFatura = null) => {
    // Se n√£o recebeu dados, usa novaFatura atual
    const faturaParaGuardar = dadosFatura || novaFatura;
    
    // Buscar fornecedor (suporta strings antigas E objetos novos)
    // Para sal√°rios, fornecedor √© opcional
    let fornecedor = null;
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (faturaParaGuardar.categoria === 'salarios') {
      // Sal√°rios n√£o t√™m fornecedor
      fornecedorNome = 'Equipa';
      fornecedorNif = '';
    } else if (faturaParaGuardar.fornecedorId) {
      // Outras categorias: buscar fornecedor
      fornecedor = fornecedores.find(f => {
        const fId = f.id || f;
        return String(fId) === String(faturaParaGuardar.fornecedorId);
      });
      
      fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
      fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    }
    
    const novaFaturaCompleta = {
      id: Date.now(),
      criadoEm: new Date().toISOString(), // üÜï Timestamp de cria√ß√£o
      numero: faturaParaGuardar.numero,
      tipo: faturaParaGuardar.tipo || 'FT', // ‚úÖ TIPO DE FATURA (FT/FR/FS)
      tipoDocumento: faturaParaGuardar.tipoDocumento || 'fatura', // NOVO: tipo de documento
      data: faturaParaGuardar.data,
      fornecedorId: faturaParaGuardar.fornecedorId || '',
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: faturaParaGuardar.itens,
      notas: faturaParaGuardar.notas,
      categoria: faturaParaGuardar.categoria || 'compras', // Nova
      recorrente: faturaParaGuardar.recorrente || false, // Nova
      diaRecorrencia: faturaParaGuardar.diaRecorrencia || 1, // Nova
      documentoPDF: faturaParaGuardar.documentoPDF || null, // PDF da fatura
      nomeDocumento: faturaParaGuardar.nomeDocumento || '', // Nome do PDF
      // üÜï CAMPOS DE NIF DO CLIENTE
      temNifCliente: faturaParaGuardar.temNifCliente || false,
      nifCliente: faturaParaGuardar.nifCliente || null,
      paraContabilista: (() => {
        const tipo = faturaParaGuardar.tipo || 'FT';
        const temNif = faturaParaGuardar.temNifCliente;
        // FT e FR sempre v√£o
        if (tipo === 'FT' || tipo === 'FR') return true;
        // FS s√≥ vai se tiver NIF
        if (tipo === 'FS') return temNif === true;
        return false;
      })(),
      subtotal: faturaParaGuardar.itens.reduce((sum, item) => sum + item.subtotal, 0),
      totalIva: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
      total: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0),
      totais: faturaParaGuardar.totais || { // ‚úÖ TOTAIS ESTRUTURADOS
        subtotal: faturaParaGuardar.itens.reduce((sum, item) => sum + item.subtotal, 0),
        iva: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
        total: faturaParaGuardar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0)
      }
    };
    
    void 0;
    void 0;
    
    setFaturas([...faturas, novaFaturaCompleta]);
    setUltimaFaturaInserida(novaFaturaCompleta.id); // üÜï Marcar como √∫ltima inserida
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      tipoDocumento: 'fatura', // NOVO
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1,
      documentoPDF: null,
      nomeDocumento: ''
    });
    
    // Resetar campo de pesquisa de ingrediente
    setSearchIngredienteFatura('');
    setCriandoIngrediente(false);
    
    setEditandoFatura(false);
    showNotification('Fatura guardada!', 'success');
  };
  
  const salvarFaturaRapida = () => {
    // Valida√ß√£o: fornecedor √© obrigat√≥rio EXCETO para sal√°rios
    if (novaFatura.categoria !== 'salarios' && !novaFatura.fornecedorId) {
      showNotification('Selecione um fornecedor!', 'error');
      return;
    }
    
    if (novaFatura.categoria === 'compras') {
      // Valida√ß√£o para compras (ingredientes)
      if (!itemFatura.ingredienteId || !itemFatura.quantidade || !itemFatura.precoTotal || !itemFatura.unidade) {
        showNotification('Preencha todos os campos obrigat√≥rios!', 'error');
        return;
      }
    } else {
      // Valida√ß√£o para outras despesas
      if (!itemFatura.descricao || !itemFatura.precoTotal) {
        showNotification('Preencha descri√ß√£o e valor!', 'error');
        return;
      }
      
      // Processar despesa n√£o-compras
      salvarFaturaRapidaDespesa();
      return;
    }
    
    // Continua com processamento de compras (ingredientes)
    const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    
    // Converter para unidade base
    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    }
    
    const precoPorUnidadeBase = precoTotal / quantidadeBase;
    const precoAtual = ingrediente.custoUnitario;
    const diferenca = Math.abs(precoPorUnidadeBase - precoAtual);
    const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
    
    // Se pre√ßo mudou mais de 5%, mostrar alerta
    if (diferencaPerc > 5) {
      // Encontrar produtos afetados
      const produtosAfetados = produtos.filter(p => 
        p.receita && p.receita.some(r => r.ingredienteId == itemFatura.ingredienteId)
      ).map(p => {
        const receitaItem = p.receita.find(r => r.ingredienteId == itemFatura.ingredienteId);
        const custoAntes = receitaItem.quantidade * precoAtual;
        const custoDepois = receitaItem.quantidade * precoPorUnidadeBase;
        const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
          const ing = ingredientes.find(i => i.id == r.ingredienteId);
          return s + (r.quantidade * (ing?.custoUnitario || 0));
        }, 0);
        const margemDepois = margemAntes - (custoDepois - custoAntes);
        
        return {
          nome: p.nome,
          margemDif: margemDepois - margemAntes
        };
      });
      
      setPriceAlertData({
        ingrediente,
        precoAtual,
        precoNovo: precoPorUnidadeBase,
        diferencaPerc,
        produtosAfetados,
        faturaData: {
          ...novaFatura,
          itemFatura: itemFatura
        },
        tipoFatura: 'rapido'
      });
      setShowPriceAlert(true);
      return; // N√£o guarda ainda, espera decis√£o do utilizador
    }
    
    // Se pre√ßo n√£o mudou muito, guarda normalmente
    salvarFaturaRapidaSemAlerta();
  };
  
  const salvarFaturaRapidaSemAlerta = () => {
    const ingrediente = ingredientes.find(i => i.id == itemFatura.ingredienteId);
    const fornecedor = fornecedores.find(f => (f.id || f) === novaFatura.fornecedorId);
    
    // Handle both old format (string) and new format (object)
    const fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
    const fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    
    const quantidade = parseFloat(itemFatura.quantidade);
    const precoTotal = parseFloat(itemFatura.precoTotal);
    const unidadeCompra = itemFatura.unidade;
    const unidadeBase = ingrediente.unidade;
    const iva = parseFloat(itemFatura.iva);
    
    // Converter para unidade base
    let quantidadeBase = quantidade;
    if (unidadeCompra === 'g' && unidadeBase === 'kg') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
      quantidadeBase = quantidade / 1000;
    } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
      quantidadeBase = quantidade * 1000;
    } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
      quantidadeBase = quantidade * 1000;
    }
    
    const precoPorUnidadeBase = precoTotal / quantidadeBase;
    
    // ATUALIZAR custo do ingrediente
    setIngredientes(ingredientes.map(ing => 
      ing.id === ingrediente.id 
        ? { 
            ...ing, 
            custoUnitario: precoPorUnidadeBase,
            historicoPrecos: [
              ...(ing.historicoPrecos || []),
              { data: novaFatura.data, preco: precoPorUnidadeBase }
            ]
          }
        : ing
    ));
    
    // Pre√ßo Total J√Å INCLUI IVA
    const subtotalSemIva = precoTotal / (1 + iva / 100);
    const totalIva = precoTotal - subtotalSemIva;
    const total = precoTotal; // J√° est√° com IVA
    
    // Gerar n√∫mero autom√°tico para registo r√°pido
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const registosRapidosHoje = (faturas || []).filter(f => 
      f.tipo === 'rapido' && 
      f.data === novaFatura.data
    ).length;
    const numeroAuto = `RR/${ano}/${String(registosRapidosHoje + 1).padStart(3, '0')}`;
    
    const item = {
      id: Date.now(),
      ingredienteId: itemFatura.ingredienteId,
      ingredienteNome: ingrediente.nome,
      unidade: unidadeCompra,
      quantidade,
      precoUnitario: precoPorUnidadeBase,
      iva,
      subtotal: subtotalSemIva
    };
    
    const faturaRapida = {
      id: Date.now(),
      numero: numeroAuto,
      tipoDocumento: novaFatura.tipoDocumento || 'fatura', // NOVO
      data: novaFatura.data,
      fornecedorId: novaFatura.fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: novaFatura.notas || 'Registo r√°pido',
      categoria: novaFatura.categoria || 'compras', // Nova
      recorrente: novaFatura.recorrente || false, // Nova
      diaRecorrencia: novaFatura.diaRecorrencia || 1, // Nova
      subtotal: subtotalSemIva,
      totalIva,
      total,
      tipo: 'rapido' // Marca que √© registo r√°pido
    };
    
    setFaturas([...faturas, faturaRapida]);
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1
    });
    setItemFatura({
      ingredienteId: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13'
    });
    
    showNotification(`Compra registada! Pre√ßo atualizado: ‚Ç¨${precoPorUnidadeBase.toFixed(2)}/${unidadeBase}`, 'success');
  };
  
  const salvarFaturaRapidaDespesa = () => {
    // Fun√ß√£o para salvar fatura r√°pida de despesas n√£o-compras (renda, utilities, etc)
    let fornecedorNome = '';
    let fornecedorNif = '';
    
    if (novaFatura.categoria === 'salarios') {
      // Sal√°rios n√£o t√™m fornecedor
      fornecedorNome = 'Equipa';
      fornecedorNif = '';
    } else if (novaFatura.fornecedorId) {
      // Outras categorias: buscar fornecedor
      const fornecedor = fornecedores.find(f => (f.id || f) === novaFatura.fornecedorId);
      fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
      fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    }
    
    const precoTotal = parseFloat(itemFatura.precoTotal);
    // SAL√ÅRIOS N√ÉO T√äM IVA!
    const iva = novaFatura.categoria === 'salarios' ? 0 : parseFloat(itemFatura.iva);
    const subtotalSemIva = iva > 0 ? precoTotal / (1 + iva / 100) : precoTotal;
    const totalIva = precoTotal - subtotalSemIva;
    
    // Gerar n√∫mero autom√°tico
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const registosRapidosHoje = (faturas || []).filter(f => 
      f.tipo === 'rapido' && 
      f.data === novaFatura.data
    ).length;
    const numeroAuto = `RR/${ano}/${String(registosRapidosHoje + 1).padStart(3, '0')}`;
    
    const item = {
      id: Date.now(),
      descricao: itemFatura.descricao,
      quantidade: 1,
      unidade: 'servi√ßo',
      precoUnitario: precoTotal,
      iva,
      subtotal: subtotalSemIva,
      num_funcionarios: itemFatura.num_funcionarios || 1 // Para sal√°rios
    };
    
    const faturaRapida = {
      id: Date.now(),
      numero: numeroAuto,
      tipoDocumento: novaFatura.tipoDocumento || 'fatura', // NOVO
      data: novaFatura.data,
      fornecedorId: novaFatura.fornecedorId || '',
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: [item],
      notas: novaFatura.notas || 'Registo r√°pido',
      categoria: novaFatura.categoria,
      recorrente: novaFatura.recorrente || false,
      diaRecorrencia: novaFatura.diaRecorrencia || 1,
      subtotal: subtotalSemIva,
      totalIva,
      total: precoTotal,
      tipo: 'rapido'
    };
    
    setFaturas([...faturas, faturaRapida]);
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: '',
      categoria: 'compras',
      recorrente: false,
      diaRecorrencia: 1
    });
    setItemFatura({
      ingredienteId: '',
      descricao: '',
      quantidade: '',
      unidade: '',
      precoTotal: '',
      iva: '13'
    });
    
    showNotification('Despesa registada!', 'success');
  };
  
  const apagarFatura = (faturaId) => {
    if (confirm('‚ö†Ô∏è Apagar esta compra?')) {
      setFaturas((faturas || []).filter(f => f.id !== faturaId));
      showNotification('Compra apagada!', 'success');
    }
  };
  
  const editarFatura = (fatura) => {
    setNovaFatura({
      numero: fatura.numero,
      data: fatura.data,
      fornecedorId: fatura.fornecedorId,
      itens: fatura.itens,
      notas: fatura.notas,
      categoria: fatura.categoria || 'compras', // ‚úÖ PRESERVAR CATEGORIA
      tipoDocumento: fatura.tipoDocumento || 'fatura', // ‚úÖ PRESERVAR TIPO DOCUMENTO
      tipo: fatura.tipo || 'FT', // ‚úÖ PRESERVAR TIPO (FT/FR/FS)
      recorrente: fatura.recorrente || false, // ‚úÖ PRESERVAR RECORR√äNCIA
      diaRecorrencia: fatura.diaRecorrencia || 1, // ‚úÖ PRESERVAR DIA RECORR√äNCIA
      documentoPDF: fatura.documentoPDF || null, // ‚úÖ PRESERVAR PDF
      nomeDocumento: fatura.nomeDocumento || '', // ‚úÖ PRESERVAR NOME
      totais: fatura.totais || null // ‚úÖ PRESERVAR TOTAIS ESTRUTURADOS
    });
    setEditandoFatura(true);
    setFaturaEditando(fatura.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  const atualizarFatura = () => {
    void 0;
    
    if (!novaFatura.fornecedorId || (novaFatura.itens || []).length === 0) {
      showNotification('Preencha fornecedor e adicione pelo menos 1 item!', 'error');
      return;
    }
    
    // Gerar n√∫mero automaticamente APENAS para FATURAS (n√£o recibos)
    const tipoDoc = novaFatura.tipoDocumento || 'fatura';
    
    if (tipoDoc === 'fatura' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      const hoje = new Date();
      const ano = hoje.getFullYear();
      const faturasHoje = (faturas || []).filter(f => f.data === novaFatura.data && f.id !== faturaEditando).length;
      novaFatura.numero = `FAT/${ano}/${String(faturasHoje + 1).padStart(4, '0')}`;
    }
    
    // Se √© recibo e n√£o tem n√∫mero, deixa null
    if (tipoDoc === 'recibo' && (!novaFatura.numero || novaFatura.numero.trim() === '')) {
      novaFatura.numero = null;
    }
    
    // Verificar se algum item tem pre√ßo muito diferente
    // IMPORTANTE: S√≥ verificar se o pre√ßo do item mudou em rela√ß√£o √† fatura original
    const faturaOriginal = faturas.find(f => f.id === faturaEditando);
    
    let temAlertaPreco = false;
    for (const item of novaFatura.itens) {
      const ingrediente = ingredientes.find(i => i.id == item.ingredienteId);
      if (ingrediente) {
        // Buscar o item original da fatura
        const itemOriginal = faturaOriginal?.itens.find(i => i.ingredienteId === item.ingredienteId);
        
        // S√≥ mostrar alerta se o item n√£o existia antes OU se o pre√ßo unit√°rio mudou
        const precoMudou = !itemOriginal || Math.abs(item.precoUnitario - itemOriginal.precoUnitario) > 0.001;
        
        if (precoMudou) {
          const precoAtual = ingrediente.custoUnitario;
          const precoNovo = item.precoUnitario;
          const diferenca = Math.abs(precoNovo - precoAtual);
          const diferencaPerc = precoAtual > 0 ? (diferenca / precoAtual) * 100 : 0;
          
          if (diferencaPerc > 5) {
            // Mostrar alerta para o primeiro item com diferen√ßa > 5%
            const produtosAfetados = produtos.filter(p => 
              p.receita && p.receita.some(r => r.ingredienteId == item.ingredienteId)
            ).map(p => {
              const receitaItem = p.receita.find(r => r.ingredienteId == item.ingredienteId);
              const custoAntes = receitaItem.quantidade * precoAtual;
              const custoDepois = receitaItem.quantidade * precoNovo;
              const margemAntes = p.precoVenda - (p.receita || []).reduce((s, r) => {
                const ing = ingredientes.find(i => i.id == r.ingredienteId);
                return s + (r.quantidade * (ing?.custoUnitario || 0));
              }, 0);
              const margemDepois = margemAntes - (custoDepois - custoAntes);
              
              return {
                nome: p.nome,
                margemDif: margemDepois - margemAntes
              };
            });
            
            setPriceAlertData({
              ingrediente,
              precoAtual,
              precoNovo,
              diferencaPerc,
              produtosAfetados,
              faturaData: novaFatura,
              faturaEditandoId: faturaEditando, // Guardar ID da fatura em edi√ß√£o
              tipoFatura: 'edicao' // Marcar como edi√ß√£o
            });
            setShowPriceAlert(true);
            temAlertaPreco = true;
            return; // N√£o atualiza ainda
          }
        }
      }
    }
    
    // Se n√£o tem alerta, atualiza normalmente
    if (!temAlertaPreco) {
      atualizarFaturaSemAlerta();
    }
  };
  
  const atualizarFaturaSemAlerta = (dadosFatura = null, faturaId = null) => {
    const faturaParaAtualizar = dadosFatura || novaFatura;
    const idParaAtualizar = faturaId || faturaEditando;
    
    const fornecedor = fornecedores.find(f => (f.id || f) === faturaParaAtualizar.fornecedorId);
    void 0;
    
    // Handle both old format (string) and new format (object)
    const fornecedorNome = typeof fornecedor === 'string' ? fornecedor : (fornecedor?.nome || '');
    const fornecedorNif = typeof fornecedor === 'string' ? '' : (fornecedor?.nif || '');
    
    const faturaOriginal = faturas.find(f => f.id === idParaAtualizar);
    
    const faturaAtualizada = {
      ...faturaOriginal, // ‚úÖ PRESERVAR TUDO DA FATURA ORIGINAL
      id: idParaAtualizar,
      numero: faturaParaAtualizar.numero,
      data: faturaParaAtualizar.data,
      fornecedorId: faturaParaAtualizar.fornecedorId,
      fornecedorNome: fornecedorNome,
      fornecedorNif: fornecedorNif,
      itens: faturaParaAtualizar.itens,
      notas: faturaParaAtualizar.notas,
      subtotal: faturaParaAtualizar.itens.reduce((sum, item) => sum + item.subtotal, 0),
      totalIva: faturaParaAtualizar.itens.reduce((sum, item) => sum + (item.subtotal * item.iva / 100), 0),
      total: faturaParaAtualizar.itens.reduce((sum, item) => sum + (item.subtotal * (1 + item.iva / 100)), 0)
      // ‚úÖ documentoPDF, nomeDocumento, tipo, paraContabilista j√° preservados por ...faturaOriginal
    };
    
    setFaturas(faturas.map(f => f.id === idParaAtualizar ? faturaAtualizada : f));
    
    // Resetar formul√°rio
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: ''
    });
    
    setEditandoFatura(false);
    setFaturaEditando(null);
    showNotification('Fatura atualizada!', 'success');
  };
  
  const cancelarEdicaoFatura = () => {
    setNovaFatura({
      numero: '',
      data: new Date().toISOString().split('T')[0],
      fornecedorId: '',
      itens: [],
      notas: ''
    });
    setEditandoFatura(false);
    setFaturaEditando(null);
  };
  
  // ========== FUN√á√ïES PARA FORNECEDORES ==========
  
  const adicionarFornecedor = (nome, nif = '', morada = '', email = '', telefone = '') => {
    const novoFornecedor = {
      id: Date.now(),
      nome,
      nif,
      morada,
      email,
      telefone,
      dataCriacao: new Date().toISOString()
    };
    setFornecedores([...fornecedores, novoFornecedor]);
    return novoFornecedor.id;
  };
  
  const atualizarFornecedor = (fornecedorId, dadosAtualizados) => {
    setFornecedores((fornecedores || []).map(f => 
      f.id === fornecedorId ? { ...f, ...dadosAtualizados } : f
    ));
  };
  
  const apagarFornecedor = (fornecedorId) => {
    // Verificar se h√° faturas com este fornecedor
    const faturasComFornecedor = (faturas || []).filter(f => f.fornecedorId === fornecedorId);
    if (faturasComFornecedor.length > 0) {
      showNotification(`N√£o pode apagar! Existem ${faturasComFornecedor.length} faturas com este fornecedor.`, 'error');
      return;
    }
    
    if (confirm('‚ö†Ô∏è Apagar este fornecedor?')) {
      setFornecedores(fornecedores.filter(f => f.id !== fornecedorId));
      showNotification('Fornecedor apagado!', 'success');
    }
  };
  
  const editarFornecedor = (fornecedor) => {
    setEditandoFornecedor(true);
    setFornecedorEditandoId(fornecedor.id);
    setDadosFornecedor({
      nome: fornecedor.nome,
      nif: fornecedor.nif || '',
      morada: fornecedor.morada || '',
      email: fornecedor.email || '',
      telefone: fornecedor.telefone || ''
    });
    // Scroll suave para o formul√°rio
    setTimeout(() => {
      const elem = document.querySelector('#fornecedor-form');
      if (elem) elem.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };
  
  const salvarEdicaoFornecedor = () => {
    if (!dadosFornecedor.nome) {
      showNotification('Preencha o nome do fornecedor!', 'error');
      return;
    }
    
    atualizarFornecedor(fornecedorEditandoId, dadosFornecedor);
    
    // Reset
    setEditandoFornecedor(false);
    setFornecedorEditandoId(null);
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
    
    showNotification('Fornecedor atualizado!', 'success');
  };
  
  const cancelarEdicaoFornecedor = () => {
    setEditandoFornecedor(false);
    setFornecedorEditandoId(null);
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
  };
  
  const adicionarNovoFornecedor = () => {
    if (!dadosFornecedor.nome) {
      showNotification('Preencha o nome do fornecedor!', 'error');
      return;
    }
    
    adicionarFornecedor(
      dadosFornecedor.nome,
      dadosFornecedor.nif,
      dadosFornecedor.morada,
      dadosFornecedor.email,
      dadosFornecedor.telefone
    );
    
    // Limpar
    setDadosFornecedor({
      nome: '',
      nif: '',
      morada: '',
      email: '',
      telefone: ''
    });
    
    showNotification('Fornecedor adicionado!', 'success');
  };

  const processarFicheiro = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
      const txt = ev.target.result;
      const lns = txt.split('\n').filter(l => l.trim());
      const vs = [];
      
      void 0;
      
      for (let i = 0; i < lns.length; i++) {
        const ln = lns[i];
        
        // Skip header line
        if (i === 0 || ln.toLowerCase().includes('data') || ln.toLowerCase().includes('documento')) {
          void 0;
          continue;
        }
        
        if (ln.includes(';')) {
          const pts = ln.split(';').map(p => p.replace(/"/g, '').trim());
          
          if (i < 3) {
            void 0;
          }
          
          // Tentar encontrar data (pode estar em posi√ß√µes diferentes)
          let dataStr = pts[0];
          let produto = pts[1];
          let quantidade = 1;
          let total = 0;
          
          // Tentar parsear data em diferentes formatos
          let dt = null;
          
          // Formato DD-MM-YYYY
          if (dataStr && dataStr.match(/\d{2}-\d{2}-\d{4}/)) {
            const [d, m, a] = dataStr.split('-');
            dt = `${a}-${m}-${d}`;
          }
          // Formato DD/MM/YYYY
          else if (dataStr && dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) {
            const [d, m, a] = dataStr.split('/');
            dt = `${a}-${m}-${d}`;
          }
          // Formato YYYY-MM-DD (j√° correto)
          else if (dataStr && dataStr.match(/\d{4}-\d{2}-\d{2}/)) {
            dt = dataStr;
          }
          
          // Tentar encontrar quantidade e total
          for (let j = 0; j < pts.length; j++) {
            const val = pts[j];
            
            // Procurar quantidade (pode ter "Uni." ou ser n√∫mero com v√≠rgula)
            if (val.includes('Uni.') || (j > 8 && j < 13 && val.match(/^\d+[,.]?\d*$/))) {
              const q = parseFloat(val.replace('Uni.', '').replace(',', '.'));
              if (!isNaN(q) && q > 0) quantidade = q;
            }
            
            // Procurar total (tem ‚Ç¨ ou √© n√∫mero com v√≠rgula nas √∫ltimas colunas)
            if ((val.includes('‚Ç¨') || (j > 10 && val.match(/^\d+[,.]?\d*$/))) && j > 9) {
              const t = parseFloat(val.replace('‚Ç¨', '').replace(',', '.'));
              if (!isNaN(t) && t > 0) total = t;
            }
          }
          
          if (dt && produto && total > 0) {
            vs.push({ 
              id: Date.now() + i, 
              data: dt, 
              produto: produto, 
              quantidade: quantidade, 
              valor: total, 
              total: total,
              iva: 6,
              origem: 'moloni'
            });
            
            if (vs.length <= 3) {
              void 0;
            }
          }
        }
      }
      
      void 0;
      
      if (vs.length > 0) { 
        setVendas([...vendas, ...vs]); 
        showNotification(`${vs.length} vendas importadas!`, 'success');
        e.target.value = ''; 
      }
      else {
        void 0;
        showNotification('Nenhuma venda encontrada. Verifica formato CSV.', 'error');
      }
    };
    r.readAsText(f);
  };

  // Fun√ß√£o para processar Excel do Zobaze
  const processarZobaze = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const worksheet = workbook.Sheets['receiptsWithItems'];
      
      if (!worksheet) {
        showNotification('‚ùå Sheet "receiptsWithItems" n√£o encontrada', 'error');
        return;
      }
      
      const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const vendasImportadas = [];
      let statsDicionario = 0, statsFuzzy = 0, statsExato = 0, statsSemMatch = 0;
      
      let currentDate = '';
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        
        // Se tem data na coluna [1], guardar (√© linha de cabe√ßalho do receipt)
        if (row[1]) {
          currentDate = row[1];
        }
        
        // Processar apenas items
        if (row[6] !== 'Item' || !row[7] || !row[8]) continue;
        
        const match = String(row[7]).match(/(.+?)\s*\(\d+(?:\.\d+)?\s*X\s*[\d.]+\)/);
        const nomeProduto = match ? match[1].trim() : String(row[7]).trim();
        const valor = parseFloat(row[8]) || 0;
        
        if (!nomeProduto || valor === 0) continue;
        
        let produto = null, confianca = 0, metodoMatch = 'nenhum';
        
        const nomeCorrigido = mapearNomeProduto(nomeProduto);
        if (nomeCorrigido !== nomeProduto) {
          produto = produtos.find(p => p.nome === nomeCorrigido);
          if (produto) { confianca = 100; metodoMatch = 'dicionario'; statsDicionario++; }
        }
        
        if (!produto) {
          const matchResult = findBestMatchProduto(nomeProduto, produtos);
          if (matchResult) {
            produto = produtos.find(p => p.id === matchResult.id);
            confianca = matchResult.confianca;
            metodoMatch = matchResult.metodo;
            if (matchResult.metodo === 'exato') statsExato++; else statsFuzzy++;
          } else {
            statsSemMatch++;
          }
        }
        
        // Usar a data guardada do receipt
        let dataFormatada = '';
        if (currentDate) {
          try {
            const dt = new Date(currentDate);
            dataFormatada = !isNaN(dt.getTime()) ? dt.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
          } catch (err) {
            dataFormatada = new Date().toISOString().split('T')[0];
          }
        } else {
          dataFormatada = new Date().toISOString().split('T')[0];
        }
        
        vendasImportadas.push({
          id: Date.now() + Math.random(),
          data: dataFormatada,
          produto: produto?.nome || nomeProduto,
          produtoId: produto?.id || null,
          quantidade: 1,
          valor: valor,
          iva: produto?.iva || 6,
          origem: 'zobaze',
          confiancaMatch: confianca,
          metodoMatch: metodoMatch,
          nomeOriginalCSV: nomeProduto
        });
      }
      
      if (vendasImportadas.length > 0) {
        setVendas([...vendas, ...vendasImportadas]);
        setMostrarImportacao(false);
        
        const total = statsDicionario + statsExato + statsFuzzy;
        const pct = Math.round(total/vendasImportadas.length*100);
        
        showNotification(
          '‚úÖ ' + vendasImportadas.length + ' vendas Zobaze!\n' +
          '‚úì ' + total + ' emparelhadas (' + pct + '%)\n' +
          '  ‚Ä¢ ' + statsDicionario + ' dicion√°rio\n' +
          '  ‚Ä¢ ' + statsExato + ' exato\n' +
          '  ‚Ä¢ ' + statsFuzzy + ' fuzzy\n' +
          (statsSemMatch > 0 ? '‚ö† ' + statsSemMatch + ' sem match' : ''),
          total === vendasImportadas.length ? 'success' : 'warning'
        );
        
        console.log('ZOBAZE:', {total: vendasImportadas.length, dicionario: statsDicionario, exato: statsExato, fuzzy: statsFuzzy, semMatch: statsSemMatch});
        if (statsSemMatch > 0) console.log('Sem match:', vendasImportadas.filter(v => !v.produtoId).map(v => v.nomeOriginalCSV));
        
        e.target.value = '';
      } else {
        showNotification('‚ùå Nenhuma venda v√°lida encontrada', 'error');
      }
    } catch (err) {
      console.error('Erro Zobaze:', err);
      showNotification('‚ùå Erro: ' + err.message, 'error');
    }
  };

  // Fun√ß√£o para gerar faturas recorrentes automaticamente
  const gerarFaturasRecorrentes = React.useCallback(() => {
    const hoje = new Date();
    const diaHoje = hoje.getDate();
    const mesHoje = hoje.getMonth();
    const anoHoje = hoje.getFullYear();
    
    // Pegar faturas recorrentes
    const faturasRecorrentes = (faturas || []).filter(f => f.recorrente === true);
    
    if (faturasRecorrentes.length === 0) return;
    
    const novasFaturas = [];
    
    faturasRecorrentes.forEach(faturaOriginal => {
      const diaRecorrencia = faturaOriginal.diaRecorrencia || 1;
      
      // Verificar se hoje √© o dia de recorr√™ncia
      if (diaHoje !== diaRecorrencia) return;
      
      // Verificar se j√° existe fatura gerada este m√™s
      const dataHoje = `${anoHoje}-${String(mesHoje + 1).padStart(2, '0')}-${String(diaHoje).padStart(2, '0')}`;
      
      const jaExiste = (faturas || []).some(f => 
        f.data === dataHoje && 
        f.numero.startsWith(faturaOriginal.numero) &&
        f.categoria === faturaOriginal.categoria
      );
      
      if (jaExiste) return; // J√° foi gerada este m√™s
      
      // Gerar nova fatura
      const novaFatura = {
        ...faturaOriginal,
        id: Date.now() + Math.random(), // ID √∫nico
        numero: `${faturaOriginal.numero.split('/')[0]}/AUTO-${anoHoje}${String(mesHoje + 1).padStart(2, '0')}`,
        data: dataHoje,
        notas: `${faturaOriginal.notas || ''} (Gerada automaticamente)`.trim()
      };
      
      novasFaturas.push(novaFatura);
    });
    
    if (novasFaturas.length > 0) {
      setFaturas([...faturas, ...novasFaturas]);
      showNotification(`‚ú® ${novasFaturas.length} fatura(s) recorrente(s) gerada(s) automaticamente!`, 'success');
    }
  }, [faturas, setFaturas, showNotification]);
  
  // Verificar faturas recorrentes diariamente
  React.useEffect(() => {
    // Executar ao carregar
    gerarFaturasRecorrentes();
    
    // Executar a cada 24 horas
    const intervalo = setInterval(gerarFaturasRecorrentes, 24 * 60 * 60 * 1000);
    
    return () => clearInterval(intervalo);
  }, [gerarFaturasRecorrentes]);


  const syncToGitHub = React.useCallback(async () => {
    if (!GitHubSync.isConfigured() || isSyncing) return;
    
    setIsSyncing(true);
    setSyncError(null);
    
    try {
      const token = GitHubSync.getToken();
      const data = {
        produtos,
        ingredientes,
        vendas,
        despesas,
        fornecedores,
        dadosEmpresa,
        faturas,
        movimentacoesStock, // üÜï STOCK INTELIGENTE
        timestamp: new Date().toISOString()
      };
      
      const result = await GitHubSync.saveToGist(data, token);
      
      if (result.success) {
        setLastSync(new Date());
      } else {
        setSyncError(result.error);
      }
    } catch (error) {
      setSyncError(error.message);
    } finally {
      setIsSyncing(false);
    }
  }, [produtos, ingredientes, vendas, despesas, fornecedores, dadosEmpresa, faturas, isSyncing]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üíæ INDEXEDDB: Auto-save dos dados cr√≠ticos
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Vocabul√°rio
  useEffect(() => {
    if (vocabularioFornecedor && vocabularioFornecedor.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveVocabulario(vocabularioFornecedor);
      };
      const timeout = setTimeout(save, 1000);
      return () => clearTimeout(timeout);
    }
  }, [vocabularioFornecedor]);
  
  // Ingredientes
  useEffect(() => {
    if (ingredientes && ingredientes.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveIngredientes(ingredientes);
      };
      const timeout = setTimeout(save, 2000);
      return () => clearTimeout(timeout);
    }
  }, [ingredientes]);
  
  // Fornecedores
  useEffect(() => {
    if (fornecedores && fornecedores.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveFornecedores(fornecedores);
      };
      const timeout = setTimeout(save, 2000);
      return () => clearTimeout(timeout);
    }
  }, [fornecedores]);
  
  // Templates OCR
  useEffect(() => {
    if (templatesOCR && templatesOCR.length > 0) {
      const save = async () => {
        await IndexedDBStorage.saveTemplates(templatesOCR);
      };
      const timeout = setTimeout(save, 2000);
      return () => clearTimeout(timeout);
    }
  }, [templatesOCR]);

  // Google Drive: Sincroniza√ß√£o autom√°tica
  useEffect(() => {
    if (driveAccessToken) {
      const timeout = setTimeout(() => saveToDrive(), 3000);
      return () => clearTimeout(timeout);
    }
  }, [produtos, ingredientes, vendas, faturas, fornecedores, vocabularioFornecedor, driveAccessToken]);

  // Google Drive: Inicializar Google Identity Services
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.onload = () => {
      // ‚úÖ Usar GoogleDriveTokenManager
      const tokenData = GoogleDriveTokenManager.getTokenData();
      
      if (tokenData && GoogleDriveTokenManager.isTokenValid()) {
        setDriveAccessToken(tokenData.access_token);
        loadUserInfo(tokenData.access_token);
        loadFromDrive(tokenData.access_token);
        showNotification('‚úÖ Reconectado automaticamente ao Google Drive', 'success');
      } else if (tokenData) {
        // Token existe mas est√° expirado
        GoogleDriveTokenManager.clearToken();
        showNotification('üîí Sess√£o Google Drive expirou. Fa√ßa login novamente.', 'info');
      }
    };
    document.head.appendChild(script);
  }, []);
  
  // ‚úÖ Verifica√ß√£o peri√≥dica do token
  useEffect(() => {
    if (!driveAccessToken) {
      // Limpar intervalo se n√£o houver token
      if (tokenCheckIntervalRef.current) {
        clearInterval(tokenCheckIntervalRef.current);
        tokenCheckIntervalRef.current = null;
      }
      return;
    }
    
    const checkToken = () => {
      const valid = GoogleDriveTokenManager.isTokenValid();
      const timeLeft = GoogleDriveTokenManager.getTimeUntilExpiry();
      
      setDriveTokenValid(valid);
      setDriveTokenTimeLeft(timeLeft);
      
      // Alertar quando token est√° perto de expirar (menos de 10 minutos)
      if (!valid && timeLeft > 0 && timeLeft <= 10) {
        showNotification(
          `‚ö†Ô∏è Token expira em ${timeLeft} minutos. Clique no bot√£o "üîë Renovar Token" para manter a liga√ß√£o.`,
          'warning'
        );
      }
      
      // Se expirou completamente, fazer logout
      if (timeLeft === 0) {
        showNotification('üîí Sess√£o Google Drive expirou. Fa√ßa login novamente.', 'error');
        logoutGoogleDrive();
      }
    };
    
    // Verificar imediatamente
    checkToken();
    
    // Continuar a verificar a cada minuto
    tokenCheckIntervalRef.current = setInterval(checkToken, GoogleDriveTokenManager.CHECK_INTERVAL);
    
    return () => {
      if (tokenCheckIntervalRef.current) {
        clearInterval(tokenCheckIntervalRef.current);
        tokenCheckIntervalRef.current = null;
      }
    };
  }, [driveAccessToken]);

  const calcCusto = (p) => {
    if (!p.receita || !p.receita.length) return 0;
    const custoTotal = (p.receita || []).reduce((t, it) => {
      const ing = ingredientes.find(i => i.id === it.ingredienteId);
      if (!ing) return t;
      
      let q = it.quantidade;
      const unidadeReceita = it.unidade || ing.unidade;
      
      if (ing.unidade === 'kg' && unidadeReceita === 'g') q = it.quantidade / 1000;
      if (ing.unidade === 'L' && unidadeReceita === 'ml') q = it.quantidade / 1000;
      if (ing.unidade === 'g' && unidadeReceita === 'kg') q = it.quantidade * 1000;
      if (ing.unidade === 'ml' && unidadeReceita === 'L') q = it.quantidade * 1000;
      if (unidadeReceita === ing.unidade) q = it.quantidade;
      
      // üî• APLICAR DESPERD√çCIO
      const custoBase = ing.custoUnitario;
      const percentagemDesperdicio = getPercentagemDesperdicio(ing);
      const custoComDesperdicio = custoBase * (1 + percentagemDesperdicio / 100);
      
      return t + (q * custoComDesperdicio);
    }, 0);
    
    // Se tem por√ß√µes, dividir custo por por√ß√£o
    if (p.porcoes && p.porcoes > 1) {
      return custoTotal / p.porcoes;
    }
    
    return custoTotal;
  };

  const calcMargem = (p) => {
    const c = calcCusto(p);
    const ps = p.precoVenda / (1 + p.iva / 100);
    const m = ps - c;
    const mp = ps > 0 ? (m / ps) * 100 : 0;  // ‚úÖ MARGEM BRUTA (margem / pre√ßo)
    return { custo: c, margem: m, margemPercentual: mp, precoSemIva: ps };
  };
  
  // Calcular custos e pre√ßos por modalidade (Local, Take-Away, Delivery)
  const calcPrecosPorModalidade = (produto) => {
    const custoIngredientes = calcCusto(produto);
    const ivaPerc = produto.iva || 6; // Default 6% se n√£o definido
    
    // Custo embalagens (ingredientes com categoria "embalagens")
    const custoEmbalagens = (produto.receita || []).reduce((sum, item) => {
      const ing = ingredientes.find(i => i.id == item.ingredienteId);
      if (ing && ing.categoria === 'embalagens') {
        return sum + (ing.custoUnitario * (item.quantidade || 1));
      }
      return sum;
    }, 0);
    
    const precoLocal = produto.precoVenda || 0;
    const custoLocal = custoIngredientes - custoEmbalagens; // Custo sem embalagens
    const margemLocal = precoLocal / (1 + ivaPerc / 100) - custoLocal;
    
    const custoTakeAway = custoIngredientes; // J√° inclui embalagens
    const precoTakeAway = produto.precoVenda; // Usar pre√ßo do produto
    const margemTakeAway = precoTakeAway / (1 + ivaPerc / 100) - custoTakeAway;
    
    const resultados = {
      local: {
        custo: custoLocal,
        preco: precoLocal,
        margem: margemLocal,
        margemPerc: custoLocal > 0 ? (margemLocal / custoLocal) * 100 : 0
      },
      takeaway: {
        custo: custoTakeAway,
        custoEmbalagens,
        preco: precoTakeAway,
        margem: margemTakeAway,
        margemPerc: custoTakeAway > 0 ? (margemTakeAway / custoTakeAway) * 100 : 0
      },
      delivery: {}
    };
    
    // Calcular para cada app ativa
    deliveryApps.filter(app => app.ativo).forEach(app => {
      const precoDelivery = produto.precosDelivery?.[app.id] || precoTakeAway / (1 - app.comissao / 100);
      const receitaLiquida = precoDelivery * (1 - app.comissao / 100);
      const margemDelivery = receitaLiquida / (1 + ivaPerc / 100) - custoTakeAway;
      
      resultados.delivery[app.id] = {
        custo: custoTakeAway,
        precoSugerido: precoDelivery,
        precoDefinido: produto.precosDelivery?.[app.id] || null,
        comissao: app.comissao,
        receitaLiquida,
        margem: margemDelivery,
        margemPerc: custoTakeAway > 0 ? (margemDelivery / custoTakeAway) * 100 : 0
      };
    });
    
    return resultados;
  };

  const calcLucroVenda = (v) => {
    const p = produtos.find(pr => pr.nome.toLowerCase() === v.produto.toLowerCase());
    if (!p) return { lucro: 0, temCusto: false };
    
    // Verificar se produto TEM receita
    const temReceita = p.receita && p.receita.length > 0;
    
    // Se n√£o tem receita, retornar lucro 0 (n√£o sabemos o custo real)
    if (!temReceita) {
      return { lucro: 0, temCusto: false };
    }
    
    const custo = calcCusto(p);
    const precoSemIva = v.valor / (1 + (v.iva / 100));
    const custoTotal = custo * v.quantidade;
    const lucro = precoSemIva - custoTotal;
    return { lucro: lucro, temCusto: true };
  };


  // Filter data by date
  const getFilteredData = (data, dateField = 'data') => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    return data.filter(item => {
      const itemDate = new Date(item[dateField]);
      
      switch(dateFilter) {
        case 'today':
          return itemDate >= today;
        case 'week':
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          return itemDate >= weekAgo;
        case 'month':
          const monthAgo = new Date(today);
          monthAgo.setMonth(monthAgo.getMonth() - 1);
          return itemDate >= monthAgo;
        case 'custom':
          if (customStartDate && customEndDate) {
            const start = new Date(customStartDate);
            const end = new Date(customEndDate);
            end.setHours(23, 59, 59);
            return itemDate >= start && itemDate <= end;
          }
          return true;
        default:
          return true;
      }
    });
  };

  const getExportFilteredData = (data, dateField = 'data') => {
    if (!exportDateStart && !exportDateEnd) {
      return data;
    }
    
    return data.filter(item => {
      const itemDate = item[dateField];
      if (!itemDate) return false;
      
      if (exportDateStart && itemDate < exportDateStart) return false;
      if (exportDateEnd && itemDate > exportDateEnd) return false;
      
      return true;
    });
  };

  // Apply filters to data
  const filteredVendas = getFilteredData(vendas);
  const filteredDespesas = getFilteredData(despesas);
  const filteredFaturas = getFilteredData(faturas);
  
  // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO (al√©m dos filtros de data)
  // Aplicar filtros por tipo de fatura (FT/FR/FS) - APENAS para c√°lculos de compras
  const filteredFaturasComConfig = filteredFaturas.filter(f => {
    const tipo = f.tipo;
    if (tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
    if (tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
    if (tipo === 'FS') return configuracoes.metricas?.incluirFS !== false;
    return true; // Incluir tipos desconhecidos por seguran√ßa
  });
  
  // ‚úÖ CRIAR ARRAY UNIFICADO: despesas manuais + faturas (convertidas para formato de despesa)
  // ‚ö†Ô∏è FILTRAR: S√≥ faturas que v√£o para contabilista (FT e FR, n√£o FS)
  // ‚úÖ USAR faturas COM filtros de configura√ß√£o aplicados
  const faturasParaContabilista = filteredFaturasComConfig.filter(f => f.paraContabilista !== false);
  const faturasComoDespesas = faturasParaContabilista.map(f => ({
    id: f.id,
    data: f.data,
    descricao: `Fatura ${f.numero || f.id}`,
    valor: f.totais?.total || f.total || 0,
    iva: f.totalIva || 0,
    ivaPercentagem: f.itens?.[0]?.iva || 23, // Taxa de IVA percentual para c√°lculos
    categoria: f.categoria || 'outros', // ‚úÖ Se n√£o tem categoria, marca como 'outros' (n√£o 'compras')
    tipo: f.tipo || 'FT', // FT/FR (FS exclu√≠do)
    fornecedor: f.fornecedorNome || '',
    origem: 'fatura' // Flag para identificar
  }));
  
  void 0;
  
  // Combinar despesas manuais + faturas
  const todasDespesas = [...filteredDespesas, ...faturasComoDespesas];
  
  void 0;

  // Total de vendas do filtro do utilizador COM FILTRO DE M√âTRICAS POR TAGS
  let totV = 0;
  let vendasFiltradas = filteredVendas;
  
  // Aplicar filtro por tags individuais
  vendasFiltradas = filteredVendas.filter(v => {
    const origem = v.origem || 'manual';
    
    if (origem === 'moloni') return configuracoes.metricas?.incluirMoloni !== false;
    if (origem === 'zobaze') return configuracoes.metricas?.incluirZobaze !== false;
    if (origem === 'manual' || v.tipo === 'manual') return configuracoes.metricas?.incluirManual !== false;
    
    // Default: incluir (caso tenha origem desconhecida)
    return true;
  });
  
  totV = vendasFiltradas.reduce((s, v) => s + (v.total || v.valor || 0), 0);
  
  const tagsAtivas = [];
  if (configuracoes.metricas?.incluirMoloni !== false) tagsAtivas.push('MOLONI');
  if (configuracoes.metricas?.incluirZobaze !== false) tagsAtivas.push('ZOBAZE');
  if (configuracoes.metricas?.incluirManual !== false) tagsAtivas.push('MANUAL');
  
  void 0;
  
  // ‚úÖ TOTAL DESPESAS com filtro de configura√ß√µes aplicado
  let totD = 0;
  
  void 0;
  
  todasDespesas.forEach((despesa, idx) => {
    const valor = despesa.valor || 0;
    const tipo = despesa.tipo; // S√≥ faturas t√™m tipo
    const origem = despesa.origem; // 'fatura' ou undefined (manual)
    
    // Aplicar filtro por tags individuais apenas para faturas
    if (origem === 'fatura') {
      let incluir = false;
      
      if (tipo === 'FT' && configuracoes.metricas?.incluirFT !== false) incluir = true;
      if (tipo === 'FR' && configuracoes.metricas?.incluirFR !== false) incluir = true;
      if (tipo === 'FS' && configuracoes.metricas?.incluirFS !== false) incluir = true;
      
      if (incluir) {
        totD += valor;
        void 0;
      } else {
        void 0;
      }
    } else {
      // Despesas manuais: sempre incluir
      totD += valor;
      if (idx < 3) void 0;
    }
  });
  
  const tagsDespesasAtivas = [];
  if (configuracoes.metricas?.incluirFT !== false) tagsDespesasAtivas.push('FT');
  if (configuracoes.metricas?.incluirFR !== false) tagsDespesasAtivas.push('FR');
  if (configuracoes.metricas?.incluirFS !== false) tagsDespesasAtivas.push('FS');
  
  void 0;
  
  // üÜï CALCULAR √çNDICE DE DESPERD√çCIO
  // ‚úÖ FILTRO RESTRITO: Apenas faturas EXPLICITAMENTE marcadas como 'compras'
  // Faturas sem categoria s√£o IGNORADAS (em vez de assumidas como compras)
  // ‚úÖ USAR faturas COM filtros de configura√ß√£o aplicados
  const comprasPeriodo = filteredFaturasComConfig.filter(f => {
    const cat = f.categoria;
    // APENAS aceitar se categoria √© explicitamente 'compras'
    return cat === 'compras';
  });
  
  // üîç DEBUG: Mostrar categorias das faturas para diagn√≥stico
  if (filteredFaturasComConfig.length > 0) {
    const categoriasFaturas = {};
    const faturaSemCategoria = [];
    filteredFaturasComConfig.forEach(f => {
      const cat = f.categoria || 'SEM_CATEGORIA';
      categoriasFaturas[cat] = (categoriasFaturas[cat] || 0) + 1;
      if (!f.categoria) {
        faturaSemCategoria.push({
          numero: f.numero || f.id,
          fornecedor: f.fornecedorNome,
          valor: f.totais?.total || f.total || 0
        });
      }
    });
    console.log('üìä Faturas por Categoria:', categoriasFaturas);
    console.log('üõí Faturas consideradas COMPRAS:', comprasPeriodo.length, 'de', filteredFaturasComConfig.length, 'totais');
    if (faturaSemCategoria.length > 0) {
      console.warn('‚ö†Ô∏è ATEN√á√ÉO: ' + faturaSemCategoria.length + ' faturas SEM CATEGORIA (sendo ignoradas no Food Cost)');
      console.table(faturaSemCategoria);
      console.log('üí° Solu√ß√£o: Edite essas faturas e defina a categoria correta (luz, renda, agua, gas, etc.)');
    }
  }
  
  // ‚úÖ √çNDICE DE DESPERD√çCIO com vendas filtradas
  const indiceDesperdicio = calcularIndiceDesperdicio(comprasPeriodo, vendasFiltradas, produtos);
  
  void 0;
  
  // Limite IVA: TRIMESTRAL (reseta de 3 em 3 meses - regime trimestral portugu√™s)
  const anoAtual = new Date().getFullYear();
  
  // üÜï Calcular trimestre atual
  const now = new Date();
  const currentMonth = now.getMonth() + 1; // 1-12
  const currentYear = now.getFullYear();
  
  let quarter, quarterStart, quarterEnd;
  if (currentMonth >= 1 && currentMonth <= 3) {
    quarter = 1;
    quarterStart = new Date(currentYear, 0, 1);
    quarterEnd = new Date(currentYear, 2, 31);
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    quarter = 2;
    quarterStart = new Date(currentYear, 3, 1);
    quarterEnd = new Date(currentYear, 5, 30);
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    quarter = 3;
    quarterStart = new Date(currentYear, 6, 1);
    quarterEnd = new Date(currentYear, 8, 30);
  } else {
    quarter = 4;
    quarterStart = new Date(currentYear, 9, 1);
    quarterEnd = new Date(currentYear, 11, 31);
  }
  
  // ‚úÖ Filtrar vendas e faturas APENAS do TRIMESTRE ATUAL (n√£o ano)
  const vendasAnoAtual = vendas.filter(v => {
    const dataVenda = new Date(v.data);
    return dataVenda >= quarterStart && dataVenda <= quarterEnd;
  });
  const totalVendasAnoAtual = vendasAnoAtual.reduce((s, v) => s + (v.total || v.valor || 0), 0);
  
  // Filtrar tamb√©m faturas do trimestre atual para c√°lculo de IVA
  const faturasAnoAtual = faturas.filter(f => {
    const dataFatura = new Date(f.data);
    return dataFatura >= quarterStart && dataFatura <= quarterEnd;
  });
  
  // IVA Vendas (a receber do estado) - APENAS TRIMESTRE ATUAL
  // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO POR ORIGEM
  const vendasAnoFiltradas = vendasAnoAtual.filter(v => {
    const origem = v.origem || 'manual';
    if (origem === 'moloni') return configuracoes.metricas?.incluirMoloni !== false;
    if (origem === 'zobaze') return configuracoes.metricas?.incluirZobaze !== false;
    if (origem === 'manual' || v.tipo === 'manual') return configuracoes.metricas?.incluirManual !== false;
    return true;
  });
  const ivaV = vendasAnoFiltradas.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);
  
  // IVA Compras (das faturas - a deduzir) - APENAS TRIMESTRE ATUAL
  // ‚ö†Ô∏è EXCLUIR Faturas Simplificadas (FS) - N√ÉO d√£o direito √† dedu√ß√£o de IVA
  // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO POR TIPO DE FATURA
  const ivaComprasFaturas = faturasAnoAtual
    .filter(f => {
      // Primeiro: FS nunca deduz IVA
      if (f.tipo === 'FS') return false;
      // Aplicar filtros de configura√ß√£o
      if (f.tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
      if (f.tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
      return true; // Incluir tipos desconhecidos por seguran√ßa
    })
    .reduce((s, f) => s + (f.totalIva || 0), 0);
  
  // IVA Compras (das despesas com categoria "compras") - APENAS TRIMESTRE ATUAL
  // ‚úÖ TODAS as despesas com IVA do trimestre atual (n√£o apenas compras)
  const despesasComIvaAnoAtual = despesas.filter(d => {
    const dataDespesa = new Date(d.data);
    return dataDespesa >= quarterStart && dataDespesa <= quarterEnd && d.iva && d.iva > 0;
  });
  
  const ivaComprasDespesas = despesasComIvaAnoAtual
    .reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      const ivaValor = d.valor - valorSemIva;
      return s + ivaValor;
    }, 0);
  
  // Total IVA Compras
  const ivaCompras = ivaComprasFaturas + ivaComprasDespesas;
  
  // IVA a Pagar = IVA Vendas - IVA Compras (reseta a cada trimestre)
  const ivaP = ivaV - ivaCompras;
  
  const ratioDespesaFaturacao = totV > 0 ? (totD / totV) * 100 : 0;

  // ‚úÖ LUCRO REAL com filtros aplicados
  let lucroReal = 0;
  let vComC = 0;
  vendasFiltradas.forEach(v => { 
    const { lucro, temCusto } = calcLucroVenda(v); 
    lucroReal += lucro; 
    if (temCusto) vComC++; 
  });

  const vPorDia = {};
  vendasFiltradas.forEach(v => {
    if (!vPorDia[v.data]) vPorDia[v.data] = { total: 0, lucro: 0, qtd: 0 };
    vPorDia[v.data].total += v.valor;
    vPorDia[v.data].qtd += v.quantidade;
    vPorDia[v.data].lucro += calcLucroVenda(v).lucro;
  });

  const dias = Object.keys(vPorDia).length;
  const medFat = dias > 0 ? totV / dias : 0;
  const medLuc = dias > 0 ? lucroReal / dias : 0;
  
  // ‚úÖ LUCRO L√çQUIDO = Receita - Todas as Despesas - Impostos (IVA a pagar)
  // Nota: ivaP √© calculado mais abaixo baseado no ano atual
  // Para o lucro l√≠quido do per√≠odo filtrado, vamos calcular IVA do per√≠odo
  const ivaVendasPeriodo = vendasFiltradas.reduce((s, v) => s + ((v.total || v.valor || 0) * v.iva / (100 + v.iva)), 0);
  
  // IVA das faturas do per√≠odo
  // ‚ö†Ô∏è EXCLUIR Faturas Simplificadas (FS) - N√ÉO d√£o direito √† dedu√ß√£o de IVA
  // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO POR TIPO DE FATURA
  const ivaFaturasPeriodo = filteredFaturasComConfig
    .filter(f => {
      // Primeiro: FS nunca deduz IVA
      if (f.tipo === 'FS') return false;
      // Aplicar filtros de configura√ß√£o
      if (f.tipo === 'FT') return configuracoes.metricas?.incluirFT !== false;
      if (f.tipo === 'FR') return configuracoes.metricas?.incluirFR !== false;
      return true; // Incluir tipos desconhecidos por seguran√ßa
    })
    .reduce((s, f) => s + (f.totalIva || 0), 0);
  
  // IVA das despesas manuais - INCLUI TODAS AS CATEGORIAS COM IVA DEDUT√çVEL
  // (compras, renda, eletricidade, agua, gas, internet, etc.)
  const ivaDespesasPeriodo = filteredDespesas
    .filter(d => d.iva && d.iva > 0) // Incluir todas as despesas com IVA > 0
    .reduce((s, d) => {
      const ivaPerc = d.iva || 23;
      const valorSemIva = d.valor / (1 + ivaPerc / 100);
      const valorIva = d.valor - valorSemIva;
      return s + valorIva;
    }, 0);
  
  const ivaPagarPeriodo = ivaVendasPeriodo - (ivaFaturasPeriodo + ivaDespesasPeriodo);
  
  // ‚ÑπÔ∏è NOTA: IVA a pagar = IVA cobrado nas vendas - IVA dedut√≠vel das compras/despesas
  // Inclui TODAS as despesas com IVA (compras, renda, eletricidade, etc.)
  
  void 0;
  void 0;
  void 0;
  void 0;

  const dFixas = todasDespesas.filter(d => ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria)).reduce((s, d) => s + d.valor, 0);
  const dFixDia = dFixas / 30;
  
  // Calculate total salaries considering payment frequency (normalize to monthly)
  const totalSalarios = todasDespesas.filter(d => d.categoria === 'salarios').reduce((s, d) => {
    const multiplicador = d.frequencia_pagamento === 'semanal' ? 4 :
                         d.frequencia_pagamento === 'quinzenal' ? 2 : 1;
    return s + (d.valor * multiplicador);
  }, 0);
  const laborCostPercentage = totV > 0 ? (totalSalarios / totV) * 100 : 0;

  // üîß FOOD COST CORRIGIDO - Usar custo REAL das vendas (baseado em receitas)
  // Calcular custo real das vendas (baseado no custoReceita de cada produto vendido)
  let custoRealVendas = 0;
  vendasFiltradas.forEach(venda => {
    // Suportar 2 formatos: venda.itens[] ou venda direta
    if (venda.itens && venda.itens.length > 0) {
      venda.itens.forEach(item => {
        const produto = produtos.find(p => p.id === item.produtoId);
        if (produto && produto.custoReceita && produto.custoReceita > 0) {
          // ‚úÖ VALIDA√á√ïES DE SEGURAN√áA
          const custo = produto.custoReceita;
          const qtd = item.quantidade || 1;
          
          // Validar valores razo√°veis
          if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
            const custoItem = custo * qtd;
            // Custo por venda n√£o pode passar de ‚Ç¨5000
            if (custoItem < 5000) {
              custoRealVendas += custoItem;
            }
          }
        }
      });
    } else if (venda.produtoId) {
      const produto = produtos.find(p => p.id === venda.produtoId);
      if (produto && produto.custoReceita && produto.custoReceita > 0) {
        // ‚úÖ VALIDA√á√ïES DE SEGURAN√áA
        const custo = produto.custoReceita;
        const qtd = venda.quantidade || 1;
        
        // Validar valores razo√°veis
        if (custo > 0 && custo < 500 && qtd > 0 && qtd < 10000) {
          const custoItem = custo * qtd;
          // Custo por venda n√£o pode passar de ‚Ç¨5000
          if (custoItem < 5000) {
            custoRealVendas += custoItem;
          }
        }
      }
    }
  });
  
  const foodCostPercentage = totV > 0 ? (custoRealVendas / totV) * 100 : 0;
  const primeCostPercentage = foodCostPercentage + laborCostPercentage;
  const primeCostTotal = custoRealVendas + totalSalarios;
  
  // ============================================
  // üí∞ C√ÅLCULO CORRETO DO LUCRO L√çQUIDO
  // ============================================
  
  // 1. Fatura√ß√£o SEM IVA (receita l√≠quida)
  const faturacaoSemIva = totV - ivaVendasPeriodo;
  
  // 2. Margem Bruta = Fatura√ß√£o sem IVA - Food Cost
  const margemBruta = faturacaoSemIva - custoRealVendas;
  const margemBrutaPercentage = totV > 0 ? (margemBruta / totV) * 100 : 0;
  
  // 3. Lucro L√≠quido = Margem Bruta - Despesas Operacionais
  const lucroLiquido = margemBruta - totD;
  const margemLiquida = totV > 0 ? (lucroLiquido / totV) * 100 : 0;
  
  void 0;
  void 0;
  void 0;
  void 0;
  void 0;
  
  // üîç DEBUG AUTOM√ÅTICO - Alertas no console se m√©tricas estiverem erradas
  if (foodCostPercentage > 100 || foodCostPercentage < 0) {
    console.error('üö® FOOD COST ANORMAL DETECTADO!');
    console.table({
      'Food Cost %': foodCostPercentage.toFixed(2) + '%',
      'Custo Real Vendas': '‚Ç¨' + custoRealVendas.toFixed(2),
      'Total Vendas': '‚Ç¨' + totV.toFixed(2),
      'Vendas Analisadas': vendasFiltradas.length
    });
    console.log('üí° Poss√≠veis causas:');
    console.log('  1. Produtos com custoReceita muito alto (>‚Ç¨100)');
    console.log('  2. Vendas com quantidades absurdas (>1000)');
    console.log('  3. Dados corrompidos no JSON');
    console.log('\nüìä Execute isto para ver produtos suspeitos:');
    console.log('  produtos.filter(p => p.custoReceita > 50).forEach(p => console.log(p.nome, p.custoReceita))');
  }
  
  // ============================================
  // BREAK-EVEN COMPLETO - Todos os Custos
  // ============================================
  
  // Calcular n√∫mero REAL de dias no per√≠odo filtrado
  let diasReaisPeriodo = 26; // default
  if (vendasFiltradas.length > 0) {
    const datas = vendasFiltradas.map(v => new Date(v.data));
    const dataMin = new Date(Math.min(...datas));
    const dataMax = new Date(Math.max(...datas));
    const diffTime = Math.abs(dataMax - dataMin);
    diasReaisPeriodo = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
  }
  
  // 1. CUSTOS FIXOS (n√£o variam com vendas)
  const fixedCosts = todasDespesas.filter(d => 
    ['renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria)
  ).reduce((s, d) => s + d.valor, 0);
  
  // 2. CUSTOS VARI√ÅVEIS (compras de ingredientes e consum√≠veis)
  const variableCosts = todasDespesas.filter(d => 
    ['compras', 'consumiveis'].includes(d.categoria)
  ).reduce((s, d) => s + d.valor, 0);
  
  // 3. FOOD COST REAL (ingredientes usados nas vendas + desperd√≠cio)
  // custoRealVendas j√° calculado acima = custo dos ingredientes nas receitas vendidas
  // Adicionar desperd√≠cio estimado (baseado nas percentagens configuradas)
  const foodCostComDesperdicio = custoRealVendas * 1.08; // +8% m√©dia de desperd√≠cio
  
  // 4. CUSTO TOTAL DO PER√çODO
  const custoTotalPeriodo = fixedCosts + variableCosts + foodCostComDesperdicio;
  
  // 5. BREAK-EVEN MENSAL (usando 26 dias √∫teis como refer√™ncia)
  const diasUteis = 26;
  
  // Projetar custos fixos e vari√°veis para um m√™s completo (26 dias)
  const fixedCostsProjetados = (fixedCosts / diasReaisPeriodo) * diasUteis;
  const variableCostsProjetados = (variableCosts / diasReaisPeriodo) * diasUteis;
  const foodCostProjetado = (foodCostComDesperdicio / diasReaisPeriodo) * diasUteis;
  
  // Margem de contribui√ß√£o = Receita - Custos Vari√°veis
  const contributionMarginRatio = totV > 0 ? (totV - variableCosts - foodCostComDesperdicio) / totV : 0;
  const breakEvenPoint = contributionMarginRatio > 0 ? fixedCosts / contributionMarginRatio : 0;
  
  // 6. BREAK-EVEN DI√ÅRIO (usando valores projetados para 26 dias)
  const custoTotalDiario = (fixedCostsProjetados + variableCostsProjetados + foodCostProjetado) / diasUteis;
  const fixedCostsDiarios = fixedCostsProjetados / diasUteis;
  const variableCostsDiarios = variableCostsProjetados / diasUteis;
  const foodCostDiario = foodCostProjetado / diasUteis;
  
  // 7. FATURA√á√ÉO NECESS√ÅRIA POR DIA para cobrir TODOS os custos
  const ticketMedio = filteredVendas.length > 0 ? totV / filteredVendas.length : 0;
  const foodCostPorVenda = filteredVendas.length > 0 ? custoRealVendas / filteredVendas.length : 0;
  const margemPorVenda = ticketMedio - foodCostPorVenda;
  const vendasNecessariasPorDia = margemPorVenda > 0 ? custoTotalDiario / margemPorVenda : 0;
  const breakEvenDiario = vendasNecessariasPorDia * ticketMedio;
  
  // 8. FATURA√á√ÉO NECESS√ÅRIA considerando MARGEM de seguran√ßa
  const faturacaoNecessariaDiaria = custoTotalDiario / (contributionMarginRatio > 0 ? contributionMarginRatio : 0.5);
  
  // Efficiency per employee (count unique employees considering frequency) - ‚úÖ USAR todasDespesas
  const numEmployees = todasDespesas
    .filter(d => d.categoria === 'salarios')
    .reduce((sum, d) => sum + (d.num_funcionarios || 1), 0) || 1;
  
  const revenuePerEmployee = numEmployees > 0 ? totV / numEmployees : 0;
  const salesPerEmployee = numEmployees > 0 ? filteredVendas.length / numEmployees : 0;
  
  void 0;
  void 0;
  void 0;
  void 0;
  void 0;


  const vPorProd = {};
  vendas.forEach(v => {
    if (!vPorProd[v.produto]) vPorProd[v.produto] = { quantidade: 0, total: 0, lucro: 0 };
    vPorProd[v.produto].quantidade += v.quantidade;
    vPorProd[v.produto].total += v.valor;
    vPorProd[v.produto].lucro += calcLucroVenda(v).lucro;
  });

  const top5Venda = Object.entries(vPorProd).sort((a, b) => b[1].quantidade - a[1].quantidade).slice(0, 5);
  const top5Lucro = Object.entries(vPorProd).sort((a, b) => b[1].lucro - a[1].lucro).slice(0, 5);
  const pior5Venda = Object.entries(vPorProd).sort((a, b) => a[1].quantidade - b[1].quantidade).slice(0, 5);
  const pior5Lucro = Object.entries(vPorProd).sort((a, b) => a[1].lucro - b[1].lucro).slice(0, 5);

  const dadosPorMes = {};
  
  vendas.forEach(v => {
    const mes = v.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    // Arredondar para evitar erros de ponto flutuante
    dadosPorMes[mes].faturacao = Math.round((dadosPorMes[mes].faturacao + v.valor) * 100) / 100;
    dadosPorMes[mes].lucro = Math.round((dadosPorMes[mes].lucro + calcLucroVenda(v).lucro) * 100) / 100;
    dadosPorMes[mes].vendas += 1;
    dadosPorMes[mes].ivaVendas = Math.round((dadosPorMes[mes].ivaVendas + (v.valor * v.iva / (100 + v.iva))) * 100) / 100;
  });

  despesas.forEach(d => {
    const mes = d.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    dadosPorMes[mes].despesas += d.valor;
    if (d.categoria === 'salarios') {
      dadosPorMes[mes].salarios += d.valor;
    }
  });
  
  // IVA Compras das faturas por m√™s
  faturas.forEach(f => {
    const mes = f.data.substring(0, 7);
    if (!dadosPorMes[mes]) {
      dadosPorMes[mes] = { 
        faturacao: 0, 
        lucro: 0, 
        despesas: 0,
        salarios: 0,
        vendas: 0,
        ivaVendas: 0,
        ivaCompras: 0
      };
    }
    dadosPorMes[mes].ivaCompras += (f.totalIva || 0);
  });

  Object.keys(dadosPorMes).forEach(mes => {
    const dados = dadosPorMes[mes];
    
    // Calculate actual food costs for this month
    let custoAlimentosMes = 0;
    vendas.filter(v => v.data.startsWith(mes)).forEach(v => {
      const p = produtos.find(pr => pr.nome.toLowerCase() === v.produto.toLowerCase());
      if (p) {
        custoAlimentosMes += calcCusto(p) * v.quantidade;
      }
    });
    
    dados.foodCostPct = dados.faturacao > 0 ? ((custoAlimentosMes / dados.faturacao) * 100) : 0;
    dados.laborCostPct = dados.faturacao > 0 ? ((dados.salarios / dados.faturacao) * 100) : 0;
  });

  const mesesOrdenados = Object.keys(dadosPorMes).sort();
  const ultimos6Meses = mesesOrdenados.slice(-6);

  // ===== FUN√á√ïES OCR =====
  const fuzz = window.fuzzball || window.fuzz;
  
  // ===== SISTEMA DE LOGGING OCR (NOVO) =====
  const OCR_DEBUG = {
    enabled: true, // Mudar para false em produ√ß√£o
    logs: [],
    
    log(etapa, mensagem, dados = null) {
      if (!this.enabled) return;
      
      const logEntry = {
        timestamp: new Date().toISOString(),
        etapa,
        mensagem,
        dados
      };
      
      this.logs.push(logEntry);
      console.log(`[OCR ${etapa}] ${mensagem}`, dados || '');
    },
    
    clear() {
      this.logs = [];
    },
    
    exportLogs() {
      return JSON.stringify(this.logs, null, 2);
    },
    
    showSummary() {
      console.log('\n=== RESUMO PROCESSAMENTO OCR ===');
      const etapas = {};
      
      this.logs.forEach(log => {
        if (!etapas[log.etapa]) {
          etapas[log.etapa] = [];
        }
        etapas[log.etapa].push(log);
      });
      
      Object.keys(etapas).forEach(etapa => {
        console.log(`\n${etapa}: ${etapas[etapa].length} eventos`);
        etapas[etapa].slice(0, 3).forEach(log => {
          console.log(`  - ${log.mensagem}`);
        });
      });
    }
  };
  
  window.OCR_DEBUG = OCR_DEBUG;
  
  // Normaliza√ß√£o
  const normalizeForMatching = (text) => {
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^\w\s]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  };
  
  /**
   * Corrige erros t√≠picos de OCR (caracteres confundidos)
   * Aplica ANTES do fuzzy matching
   */
  const corrigirErrosOCR = (texto) => {
    if (!texto) return '';
    
    let corrigido = texto;
    
    // Mapeamento de erros comuns OCR
    const correcoes = {
      // N√∫meros confundidos com letras
      '0': ['O', 'o'],  // 0 confundido com O
      'O': ['0'],       // O confundido com 0
      '1': ['I', 'l'],  // 1 confundido com I ou l
      'I': ['1'],       // I confundido com 1
      '5': ['S'],       // 5 confundido com S
      'S': ['5'],       // S confundido com 5
      '8': ['B'],       // 8 confundido com B
      'B': ['8'],       // B confundido com 8
      
      // Letras trocadas
      'VATAS': ['NATAS'],           // V ‚Üí N (caso espec√≠fico)
      'ANENDOTH': ['AMENDOIM'],     // Erro comum
      'ANENDOIM': ['AMENDOIM'],
      'ANENDOIN': ['AMENDOIM'],
      'ANENDOM': ['AMENDOIM'],
      'QUEUO': ['QUEIJO'],
      'QUEJO': ['QUEIJO'],
      'LARANJA': ['LARANJA'],       // Manter correto
      'LARAN1A': ['LARANJA'],       // 1 ‚Üí J
      'LARANUA': ['LARANJA'],       // U ‚Üí J
      
      // Cervejas (corre√ß√µes espec√≠ficas)
      'CERV': ['CERVEJA'],          // Abrevia√ß√£o comum
      'CERVE1A': ['CERVEJA'],       // 1 ‚Üí J
      'CERVE]A': ['CERVEJA'],       // ] ‚Üí J
      'C/ALC': ['COM ALCOOL'],      // Expandir abrevia√ß√£o
      'S/ALC': ['SEM ALCOOL'],
      'BOCK': ['BOCK'],             // Manter
      'B0CK': ['BOCK'],             // 0 ‚Üí O
      'SUPER': ['SUPER'],           // Manter
      'SUP3R': ['SUPER'],           // 3 ‚Üí E
    };
    
    // Aplicar corre√ß√µes de palavras completas primeiro
    for (const [errado, corretos] of Object.entries(correcoes)) {
      if (errado.length > 2) { // Palavras (n√£o letras individuais)
        for (const correto of corretos) {
          const regex = new RegExp(`\\b${errado}\\b`, 'gi');
          corrigido = corrigido.replace(regex, correto);
        }
      }
    }
    
    // Padr√µes espec√≠ficos
    corrigido = corrigido
      // Remover c√≥digos misturados (IT0235:0 ‚Üí remover)
      .replace(/\b[A-Z]{2}\d{4}:\d\b/g, '')
      // Remover c√≥digos estranhos (NoHEP, etc)
      .replace(/\bNo[A-Z]{2,}\b/g, '')
      // Limpar pontua√ß√£o problem√°tica
      .replace(/[;:]+/g, ' ')
      // "0708" no contexto de ovos ‚Üí OVOS
      .replace(/\b0708\b/g, 'OVOS')
      .replace(/\b07O8\b/gi, 'OVOS')
      // Limpar espa√ßos
      .replace(/\s+/g, ' ')
      .trim();
    
    return corrigido;
  };
  
  /**
   * Limpa lixo comum do OCR ANTES de processar
   * Remove caracteres repetidos, espa√ßos extras, padr√µes sem sentido
   * IMPORTANTE: S√≥ limpar padr√µes espec√≠ficos, n√£o remover linhas de produtos!
   */
  const cleanOCRText = (text) => {
    if (!text) return '';
    
    OCR_DEBUG.log('LIMPEZA', 'Texto original', { tamanho: text.length });
    
    let cleaned = text;
    
    // 1. Remover ATCUD (n√£o √© produto)
    const atcudRemovidos = (cleaned.match(/ATCUD:[A-Z0-9-]+/gi) || []).length;
    cleaned = cleaned.replace(/ATCUD:[A-Z0-9-]+/gi, '');
    if (atcudRemovidos > 0) {
      OCR_DEBUG.log('LIMPEZA', `${atcudRemovidos} ATCUDs removidos`);
    }
    
    // 2. Remover "* CARRO No." que aparece em Recheio
    cleaned = cleaned.replace(/\*\s*CARRO\s+No\.\s*\d*/gi, '');
    
    // 3. Remover frases padr√£o OCR ruins (footer) - S√ì LINHAS COMPLETAS
    // Usar ^ para garantir que s√≥ remove se a linha COME√áA com esse texto
    cleaned = cleaned.replace(/^Produto proveniente de.*$/gm, '');
    cleaned = cleaned.replace(/^No\. de registo.*$/gm, '');
    cleaned = cleaned.replace(/^Valido como recibo.*$/gm, '');
    cleaned = cleaned.replace(/^eGGF-Processado por programa.*$/gm, '');
    cleaned = cleaned.replace(/^GMM-Processado por programa.*$/gm, '');
    cleaned = cleaned.replace(/^AS MERCADORIAS VIAJAM.*$/gm, '');
    cleaned = cleaned.replace(/^IVA\s+Incid√™ncias.*$/gm, '');
    cleaned = cleaned.replace(/^Total Volumes.*$/gm, '');
    
    // 4. Limpar caracteres repetidos sem sentido (√£o √£o √£o ‚Üí √£o)
    // MAS s√≥ se forem palavras CURTAS repetidas 3+ vezes
    cleaned = cleaned.replace(/(\b\w{1,2}\b)(\s+\1){3,}/gi, '$1');
    
    // 5. Limpar espa√ßos m√∫ltiplos (mas N√ÉO quebras de linha)
    cleaned = cleaned.replace(/ {2,}/g, ' ');  // 2+ espa√ßos ‚Üí 1 espa√ßo (S√ì espa√ßos, n√£o \n)
    
    // 6. Remover linhas vazias m√∫ltiplas (mais de 2)
    cleaned = cleaned.replace(/\n\s*\n\s*\n+/g, '\n\n');
    
    OCR_DEBUG.log('LIMPEZA', 'Texto limpo', { 
      tamanho: cleaned.length,
      reduzido: text.length - cleaned.length
    });
    
    return cleaned.trim();
  };
  
  /**
   * NOVA FUN√á√ÉO: Separar produtos que est√£o colados na mesma linha
   * Mesmo SEM c√≥digos de produto, tenta separar por padr√µes
   */
  const separarProdutosColados = (linha) => {
    // Ignorar linhas muito curtas
    if (!linha || linha.length < 15) {
      OCR_DEBUG.log('SEPARACAO', 'Linha muito curta', { linha });
      return [linha];
    }
    
    // M√âTODO 1: Por c√≥digos de produto (6 d√≠gitos + ponto + d√≠gito(s))
    // Padr√£o Recheio: 118971.1, 141407.1, 170245.0, 262503.0, etc.
    const codigos = linha.match(/\d{6}\.\d+/g);
    
    // DEBUG: Sempre logar o que encontrou
    console.log(`üîç [SEPARACAO] Linha: "${linha.substring(0, 60)}..." | C√≥digos: ${codigos ? codigos.join(', ') : 'nenhum'}`);
    
    if (codigos && codigos.length > 1) {
      console.log(`üîç [SEPARACAO] ‚úÖ SEPARANDO ${codigos.length} produtos (por c√≥digos)!`);
      OCR_DEBUG.log('SEPARACAO', `${codigos.length} c√≥digos detectados - SEPARANDO`, { codigos, linha: linha.substring(0, 80) });
      
      const produtos = [];
      let textoRestante = linha;
      
      for (let i = 0; i < codigos.length; i++) {
        const codigoAtual = codigos[i];
        const proximoCodigo = codigos[i + 1];
        
        const posAtual = textoRestante.indexOf(codigoAtual);
        if (posAtual === -1) {
          console.log(`üîç [SEPARACAO] ‚ö†Ô∏è C√≥digo ${codigoAtual} n√£o encontrado no texto restante`);
          continue;
        }
        
        if (proximoCodigo) {
          // H√° mais um c√≥digo depois - cortar at√© ele
          const posProximo = textoRestante.indexOf(proximoCodigo);
          if (posProximo > posAtual) {
            const fragmento = textoRestante.substring(posAtual, posProximo).trim();
            if (fragmento.length > 5) {
              produtos.push(fragmento);
              console.log(`üîç [SEPARACAO] Produto ${i+1}: "${fragmento.substring(0, 50)}..."`);
            }
            textoRestante = textoRestante.substring(posProximo);
          }
        } else {
          // √â o √∫ltimo c√≥digo - pegar at√© ao fim
          const fragmento = textoRestante.substring(posAtual).trim();
          if (fragmento.length > 5) {
            produtos.push(fragmento);
            console.log(`üîç [SEPARACAO] Produto ${i+1} (√∫ltimo): "${fragmento.substring(0, 50)}..."`);
          }
        }
      }
      
      console.log(`üîç [SEPARACAO] ‚úÖ Resultado: ${produtos.length} produtos separados`);
      OCR_DEBUG.log('SEPARACAO', `Separados em ${produtos.length} produtos`, { produtos: produtos.map(p => p.substring(0, 40)) });
      
      return produtos.length > 0 ? produtos : [linha];
    }
    
    // M√âTODO 2: Pingo Doce / Continente - separar por QUANTIDADE + LETRA (novo produto)
    // Padr√£o: "E MOLH INGLES PD 192ML E CACAU PO" ‚Üí quantidade (192ML) seguida de letra (E)
    // Ou: "C REQUEIJAO VC PD 170G BEBIDAS" ‚Üí quantidade (170G) seguida de palavra mai√∫scula
    const padraoQtdNovoProduto = /(\d+(?:,\d+)?(?:ML|GR|G|KG|L|CL|UN|U|DZ))\s+([A-Z])/gi;
    
    // Encontrar todas as posi√ß√µes onde h√° quantidade seguida de letra
    let matches = [];
    let match;
    const regexGlobal = /(\d+(?:,\d+)?(?:ML|GR|G|KG|L|CL|UN|U|DZ))\s+([A-Z])/gi;
    
    while ((match = regexGlobal.exec(linha)) !== null) {
      matches.push({
        index: match.index,
        fullMatch: match[0],
        quantidade: match[1],
        letraSeguinte: match[2],
        posicaoCorte: match.index + match[1].length // Cortar DEPOIS da quantidade
      });
    }
    
    if (matches.length > 0) {
      console.log(`üîç [SEPARACAO] Encontrados ${matches.length} pontos de separa√ß√£o (qtd+letra):`, matches.map(m => m.fullMatch));
      
      const produtos = [];
      let ultimoCorte = 0;
      
      for (const m of matches) {
        // Extrair do √∫ltimo corte at√© INCLUIR a quantidade
        const posicaoFimQuantidade = m.index + m.quantidade.length;
        const fragmento = linha.substring(ultimoCorte, posicaoFimQuantidade).trim();
        
        if (fragmento.length > 3) {
          produtos.push(fragmento);
          console.log(`üîç [SEPARACAO] Produto: "${fragmento}"`);
        }
        
        // Pr√≥ximo corte come√ßa na letra seguinte
        ultimoCorte = posicaoFimQuantidade;
        // Avan√ßar espa√ßos
        while (ultimoCorte < linha.length && linha[ultimoCorte] === ' ') {
          ultimoCorte++;
        }
      }
      
      // √öltimo fragmento (do √∫ltimo corte at√© ao fim)
      const ultimoFragmento = linha.substring(ultimoCorte).trim();
      if (ultimoFragmento.length > 3) {
        produtos.push(ultimoFragmento);
        console.log(`üîç [SEPARACAO] Produto (√∫ltimo): "${ultimoFragmento}"`);
      }
      
      if (produtos.length > 1) {
        console.log(`üîç [SEPARACAO] ‚úÖ Resultado: ${produtos.length} produtos separados (por qtd+letra)`);
        OCR_DEBUG.log('SEPARACAO', `Separados em ${produtos.length} produtos (qtd+letra)`, { produtos });
        return produtos;
      }
    }
    
    // M√âTODO 3: Por padr√µes de quantidade/pre√ßo (fallback antigo)
    const padraoItem = /([A-Z][A-Z\s]+?)(\d+(?:G|ML|L|KG|UN|CL))\s*‚Ç¨?\s*(\d+[.,]\d{2})/gi;
    const matchesPreco = [...linha.matchAll(padraoItem)];
    
    if (matchesPreco && matchesPreco.length > 1) {
      console.log(`üîç [SEPARACAO] ${matchesPreco.length} produtos por padr√£o qtd+pre√ßo`);
      OCR_DEBUG.log('SEPARACAO', `${matchesPreco.length} produtos por padr√£o qtd+pre√ßo`, { matches: matchesPreco.map(m => m[0]) });
      return matchesPreco.map(m => m[0]);
    }
    
    // N√£o conseguiu separar
    OCR_DEBUG.log('SEPARACAO', 'Nenhuma separa√ß√£o necess√°ria', { codigos: codigos ? codigos.length : 0 });
    return [linha];
  };
  
  // Extra√ß√£o nativa
  const extractNativeText = async (pdfBuffer) => {
    try {
      const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
      let fullText = '';
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      return fullText.trim();
    } catch (error) {
      void 0;
      return '';
    }
  };
  
  // PDF para imagens
  const pdfToImages = async (pdfBuffer) => {
    const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
    const images = [];
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      images.push(canvas.toDataURL('image/png'));
    }
    return images;
  };
  
  // OCR
  const extractWithOCR = async (pdfBuffer) => {
    try {
      const images = await pdfToImages(pdfBuffer);
      void 0;
      let fullText = '';
      for (let i = 0; i < images.length; i++) {
        setProgressoOCR(`OCR p√°gina ${i + 1}/${images.length}...`);
        const result = await Tesseract.recognize(images[i], 'por', {
          logger: m => {
            if (m.status === 'recognizing text') {
              setProgressoOCR(`OCR ${Math.round(m.progress * 100)}%`);
            }
          }
        });
        fullText += result.data.text + '\n';
      }
      return fullText.trim();
    } catch (error) {
      throw new Error('OCR falhou: ' + error.message);
    }
  };
  
  // Extra√ß√£o principal - SIMPLIFICADA (sem PDF.js)
  const extractTextFromPdf = async (file) => {
    void 0;
    setProgressoOCR('Preparando OCR...');
    
    try {
      //  Converter PDF para imagem usando FileReader
      const imageData = await convertPdfToImage(file);
      
      void 0;
      setProgressoOCR('Aplicando OCR...');
      
      // Fazer OCR direto
      const result = await Tesseract.recognize(imageData, 'por', {
        logger: m => {
          if (m.status === 'recognizing text') {
            setProgressoOCR(`OCR ${Math.round(m.progress * 100)}%`);
          }
        }
      });
      
      void 0;
      return { text: result.data.text, method: 'ocr' };
      
    } catch (error) {
      throw new Error('Falha OCR: ' + error.message);
    }
  };
  
  // Converter PDF/Imagem para data URL
  const convertPdfToImage = async (file) => {
    // Ler PDF como ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();
    
    // Carregar PDF com PDF.js
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    
    void 0;
    
    // Converter primeira p√°gina para imagem
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 2.0 }); // Scale 2.0 para melhor qualidade
    
    // Criar canvas
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    // Renderizar p√°gina no canvas
    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;
    
    // Converter canvas para data URL (imagem)
    const imageDataUrl = canvas.toDataURL('image/png');
    
    return imageDataUrl;
  };
  
  // Ignorar linhas
  const shouldIgnoreLine = (linha) => {
    // ‚úÖ FILTROS M√çNIMOS - S√≥ valida√ß√µes b√°sicas
    // O resto √© gerido pela BLACKLIST (personaliz√°vel por fornecedor)
    
    // Ignorar linhas muito curtas (< 3 caracteres)
    if (linha.length < 3) {
      OCR_DEBUG.log('FILTRO', 'Linha muito curta', { linha });
      return true;
    }
    
    // Ignorar linhas sem letras (s√≥ n√∫meros/s√≠mbolos)
    if (!/[a-zA-Z√Ä-√ø]/.test(linha)) {
      OCR_DEBUG.log('FILTRO', 'Sem letras', { linha });
      return true;
    }
    
    // ‚úÖ ACEITAR TODO O RESTO
    // Use a BLACKLIST para filtrar linhas indesejadas por fornecedor
    OCR_DEBUG.log('FILTRO', '‚úì Linha aceite', { linha });
    return false;
  };
  
  // Extrair qtd/unidade - MELHORADO
  const extractQuantidadeUnidade = (texto) => {
    OCR_DEBUG.log('EXTRACAO', 'Extraindo qtd/unidade', { texto });
    
    // Patterns mais espec√≠ficos para quantidade + unidade
    const patterns = [
      // Formato Recheio: "1 1 1,000" ou "2 1 2,000"
      /(\d+)\s+(\d+)\s+(\d+[.,]\d{3})/g,  // Ex: "1 1 1,000" ‚Üí quantidade=1000
      
      // Formato normal
      /(\d+[.,]?\d*)\s*(kg|quilos?|kilos?)/gi,
      /(\d+[.,]?\d*)\s*(g|gramas?)/gi,
      /(\d+[.,]?\d*)\s*l\b/gi,  // l isolado (litros)
      /(\d+[.,]?\d*)\s*(ml|mililitros?)/gi,
      /(\d+[.,]?\d*)\s*(cl|centilitros?)/gi,  // Centilitros (cerveja, etc)
      /(\d+[.,]?\d*)\s*(un|unid|unidade|pc|p√ß|pe√ßa|cx|caixa|emb|embalagem|dz|duzia|d√∫zia)/gi,
      
      // N√∫meros decimais com v√≠rgula (ex: "1,000" ou "2,240")
      /(\d+[.,]\d{3})\b/g,  // 3 d√≠gitos ap√≥s v√≠rgula/ponto
    ];
    
    for (const pattern of patterns) {
      const match = texto.match(pattern);
      if (match && match[0]) {
        const full = match[0];
        
        // Se √© formato Recheio "1 1 1,000", pegar o √∫ltimo n√∫mero
        const recheioMatch = full.match(/(\d+)\s+(\d+)\s+(\d+[.,]\d{3})/);
        if (recheioMatch) {
          const qtd = parseFloat(recheioMatch[3].replace(',', '.'));
          // Determinar unidade pelo contexto (ver se tem kg, g, ml, etc na linha)
          let unidade = 'un';  // Default
          if (/kg/i.test(texto)) unidade = 'kg';
          else if (/\bg\b/i.test(texto)) unidade = 'g';
          else if (/ml/i.test(texto)) unidade = 'ml';
          else if (/\bl\b/i.test(texto)) unidade = 'L';
          
          OCR_DEBUG.log('EXTRACAO', 'Qtd/Un extra√≠da (recheio)', { qtd, unidade, match: full });
          return { quantidade: qtd, unidade, match: full };
        }
        
        // Extrair n√∫mero normal
        const numStr = full.match(/\d+[.,]?\d*/);
        if (numStr) {
          const qtd = parseFloat(numStr[0].replace(',', '.'));
          // Extrair unidade
          let unidade = full.replace(/[\d.,\s]/g, '').toLowerCase().trim();
          
          // Se n√£o tem unidade expl√≠cita mas n√∫mero > 10, provavelmente √© gramas
          if (!unidade && qtd > 10 && qtd < 10000) {
            unidade = 'g';
          }
          
          // Normalizar unidades
          const map = {
            'quilos': 'kg', 'quilo': 'kg', 'kilos': 'kg', 'kilo': 'kg',
            'gramas': 'g', 'grama': 'g',
            'litros': 'L', 'litro': 'L',
            'mililitros': 'ml', 'mililitro': 'ml',
            'centilitros': 'cl', 'centilitro': 'cl',
            'unid': 'un', 'unidade': 'un', 'pc': 'un', 'p√ß': 'un', 'pe√ßa': 'un',
            'caixa': 'un', 'emb': 'un', 'embalagem': 'un',
            'duzia': 'un', 'd√∫zia': 'un'
          };
          
          unidade = map[unidade] || unidade;
          
          // Se ficou sem unidade, usar 'un'
          if (!unidade) unidade = 'un';
          
          OCR_DEBUG.log('EXTRACAO', 'Qtd/Un extra√≠da', { qtd, unidade, match: full });
          return { quantidade: qtd, unidade, match: full };
        }
      }
    }
    
    OCR_DEBUG.log('EXTRACAO', 'Nenhuma qtd/un encontrada', null);
    return { quantidade: null, unidade: null, match: '' };
  };
  
  // Extrair pre√ßo
  const extractPreco = (texto) => {
    const match = texto.match(/‚Ç¨?\s*(\d+[.,]\d{2})\s*‚Ç¨?/g);
    if (match) {
      const last = match[match.length - 1];
      const valor = parseFloat(last.replace(/[^\d.,]/g, '').replace(',', '.'));
      OCR_DEBUG.log('EXTRACAO', 'Pre√ßo extra√≠do', { valor, match: last });
      return { valor, match: last };
    }
    OCR_DEBUG.log('EXTRACAO', 'Nenhum pre√ßo encontrado', null);
    return { valor: null, match: '' };
  };
  
  // Parse linha
  const parseLinha = (linha, palavrasLimpar = []) => {
    OCR_DEBUG.log('PARSE', '>>> Iniciando parse', { linha });
    
    // 1. CORRIGIR erros de OCR PRIMEIRO
    let linhaCorrigida = corrigirErrosOCR(linha);
    OCR_DEBUG.log('PARSE', 'Ap√≥s corre√ß√£o OCR', { linhaCorrigida });
    
    // 2. LIMPAR linha
    let linhaLimpa = linhaCorrigida.trim();
    
    // 3. Remover c√≥digo de produto no IN√çCIO se existir (6 d√≠gitos + ponto)
    // Ex: "125019.1 AROMA VAHINE..." ‚Üí "AROMA VAHINE..."
    const codigoMatch = linhaLimpa.match(/^\d{6}\.\d+/);
    if (codigoMatch) {
      OCR_DEBUG.log('PARSE', 'C√≥digo produto removido', { codigo: codigoMatch[0] });
      linhaLimpa = linhaLimpa.replace(/^\d{6}\.\d+\s+/, '');
    }
    
    // 4. Extrair quantidade e pre√ßo
    const qtdUnidade = extractQuantidadeUnidade(linhaLimpa);
    const preco = extractPreco(linhaLimpa);
    
    // 5. Extrair nome do produto (remove quantidade e pre√ßo do texto)
    let nomeProduto = linhaLimpa;
    if (qtdUnidade.match) nomeProduto = nomeProduto.replace(qtdUnidade.match, '');
    if (preco.match) nomeProduto = nomeProduto.replace(preco.match, '');
    
    // 6. Limpeza final do nome
    nomeProduto = nomeProduto
      .replace(/\s+/g, ' ')  // Espa√ßos m√∫ltiplos
      .replace(/^[\d\s,\.]+/, '')  // N√∫meros/s√≠mbolos no in√≠cio
      .replace(/[*]+/g, '')  // Asteriscos
      .replace(/\s+[Ajl]\s*$/, '')  // Remove A, j, l no final
      .replace(/\s+(TN|PA|UN|UNI|EMB|CX)\s*$/i, '')  // Remove siglas no final
      .replace(/[\d\s,\.‚Ç¨]+$/, '')  // Remove n√∫meros/pre√ßos no final
      .trim();
    
    // üßπ 6.5 Limpar palavras da lista (MCHEF, AMANH, etc)
    if (palavrasLimpar && palavrasLimpar.length > 0) {
      palavrasLimpar.forEach(palavra => {
        const regex = new RegExp(`\\b${palavra}\\b`, 'gi'); // Match palavra completa
        nomeProduto = nomeProduto.replace(regex, '').replace(/\s+/g, ' ').trim();
      });
      OCR_DEBUG.log('PARSE', 'Ap√≥s limpeza de palavras', { nomeProduto, palavrasRemovidas: palavrasLimpar });
    }
    
    OCR_DEBUG.log('PARSE', 'Nome produto extra√≠do', { nomeProduto });
    
    // 7. Validar se nome √© v√°lido (m√≠nimo 2 caracteres alfab√©ticos)
    const temLetras = /[a-zA-Z√Ä-√ø]{2,}/.test(nomeProduto);
    
    if (!nomeProduto || nomeProduto.length < 2 || !temLetras) {
      OCR_DEBUG.log('PARSE', '‚úó INV√ÅLIDO - nome muito curto ou sem letras', { nomeProduto });
      return {
        textoOriginal: linha,
        nomeProduto: null, // INV√ÅLIDO
        quantidade: qtdUnidade.quantidade,
        unidade: qtdUnidade.unidade,
        preco: preco.valor,
        invalido: true
      };
    }
    
    OCR_DEBUG.log('PARSE', '‚úì Parse completo', {
      nome: nomeProduto,
      qtd: qtdUnidade.quantidade,
      unidade: qtdUnidade.unidade,
      preco: preco.valor
    });
    
    return {
      textoOriginal: linha,
      textoCorrigido: linhaCorrigida,
      textoLimpo: linhaLimpa,
      nomeProduto,
      quantidade: qtdUnidade.quantidade,
      unidade: qtdUnidade.unidade,
      preco: preco.valor,
      ingredienteSugerido: null,
      ingredienteConfirmado: null
    };
  };
  
  // Parse produtos
  const parseLinhasProdutos = (texto, nifFornecedor = null) => {
    OCR_DEBUG.clear(); // Limpar logs anteriores
    OCR_DEBUG.log('INICIO', '=== INICIANDO PROCESSAMENTO OCR ===', {
      tamanhoTexto: texto.length,
      nifFornecedor
    });
    
    // üÜï DEBUG: Mostrar texto completo recebido
    console.log('='.repeat(80));
    console.log('üîç [OCR DEBUG] TEXTO COMPLETO RECEBIDO:');
    console.log('='.repeat(80));
    console.log(texto);
    console.log('='.repeat(80));
    console.log(`üîç [OCR DEBUG] Total: ${texto.length} caracteres, ${texto.split('\n').length} linhas`);
    console.log('='.repeat(80));
    
    // üö´ CORRIGIDO: Carregar blacklist do fornecedor (se existir)
    let blacklist = [];
    if (nifFornecedor) {
      const template = buscarTemplateOCR(nifFornecedor);
      if (template && template.blacklist) {
        blacklist = template.blacklist;
        
        // üÜï LOG DETALHADO DA BLACKLIST
        console.log(`\nüö´ ============== BLACKLIST ATIVA ==============`);
        console.log(`üìã Total de ${blacklist.length} palavras bloqueadas:`);
        blacklist.forEach((palavra, index) => {
          console.log(`   ${index + 1}. "${palavra}"`);
        });
        console.log(`üö´ ============================================\n`);
        
        OCR_DEBUG.log('BLACKLIST', `${blacklist.length} palavras carregadas`, { blacklist });
      }
    }
    
    // 1. LIMPAR texto completo ANTES de split
    const textoLimpo = cleanOCRText(texto);
    OCR_DEBUG.log('LIMPEZA', 'Texto limpo completo', {
      linhasOriginais: texto.split('\n').length,
      linhasLimpas: textoLimpo.split('\n').length
    });
    
    // 2. Split em linhas
    let linhas = textoLimpo.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    OCR_DEBUG.log('SPLIT', `${linhas.length} linhas ap√≥s split`, null);
    
    // üÜï DEBUG: Mostrar linhas que cont√™m c√≥digos de produto
    console.log('üîç [OCR DEBUG] Linhas com c√≥digos de produto (6 d√≠gitos):');
    linhas.forEach((l, i) => {
      const codigos = l.match(/\d{6}\.\d+/g);
      if (codigos && codigos.length > 0) {
        console.log(`  Linha ${i}: [${codigos.length} c√≥digos] ${l.substring(0, 80)}...`);
      }
    });
    
    // 3. NOVO: Separar produtos colados na mesma linha usando a nova fun√ß√£o
    console.log('üîç [OCR DEBUG] Iniciando separa√ß√£o de produtos colados...');
    const linhasSeparadas = [];
    for (const linha of linhas) {
      const produtos = separarProdutosColados(linha);
      linhasSeparadas.push(...produtos);
    }
    
    linhas = linhasSeparadas;
    console.log(`üîç [OCR DEBUG] Ap√≥s separa√ß√£o: ${linhas.length} linhas (eram ${textoLimpo.split('\n').filter(l => l.trim()).length})`);
    OCR_DEBUG.log('SEPARACAO', `${linhas.length} linhas ap√≥s separa√ß√£o`, null);
    
    // 4. Processar cada linha
    const linhasProdutos = [];
    const stats = {
      total: linhas.length,
      ignoradas: 0,
      semNome: 0,
      blacklist: 0,
      validas: 0
    };
    
    for (const linha of linhas) {
      // üö´ CORRIGIDO: Verificar blacklist ANTES de qualquer outra valida√ß√£o
      if (blacklist.length > 0) {
        const linhaLower = linha.toLowerCase();
        
        // üîç Encontrar QUAL palavra da blacklist bloqueou
        const palavrasBloqueadoras = blacklist.filter(palavra => linhaLower.includes(palavra));
        
        if (palavrasBloqueadoras.length > 0) {
          // üÜï LOG DETALHADO: Mostrar linha bloqueada + palavras que a bloquearam
          const mensagemBlacklist = `Bloqueada por: ${palavrasBloqueadoras.map(p => `"${p}"`).join(', ')}`;
          console.log(`üö´ [BLACKLIST] Linha: "${linha}" - ${mensagemBlacklist}`);
          
          OCR_DEBUG.log('BLACKLIST', mensagemBlacklist, { 
            linha, 
            palavrasBloqueadoras,
            linhaCompleta: linha
          });
          
          stats.blacklist++;
          continue;
        }
      }
      
      if (shouldIgnoreLine(linha)) {
        stats.ignoradas++;
        continue;
      }
      
      const parsed = parseLinha(linha);
      
      if (parsed && parsed.nomeProduto) {
        linhasProdutos.push(parsed);
        stats.validas++;
      } else {
        stats.semNome++;
        OCR_DEBUG.log('PARSE', 'Linha sem nome v√°lido', { linha, parsed });
      }
    }
    
    // 5. Resumo final
    OCR_DEBUG.log('RESUMO', '=== PROCESSAMENTO CONCLU√çDO ===', {
      stats,
      produtosDetectados: linhasProdutos.length
    });
    
    // üÜï RESUMO DA BLACKLIST
    if (stats.blacklist > 0) {
      console.log(`\nüö´ =============== RESUMO BLACKLIST ===============`);
      console.log(`‚ùå Total de ${stats.blacklist} linhas bloqueadas pela blacklist`);
      console.log(`‚úÖ Total de ${stats.validas} linhas v√°lidas processadas`);
      console.log(`‚ÑπÔ∏è  Para ver TODAS as linhas bloqueadas, procure por "[BLACKLIST]" nos logs acima`);
      console.log(`üö´ ================================================\n`);
    }
    
    OCR_DEBUG.showSummary();
    
    // 6. Guardar logs no window para an√°lise
    window.lastOCRLogs = OCR_DEBUG.logs;
    window.lastOCRText = texto;
    
    console.log('\nüí° DICA: Para ver logs detalhados, execute no console:');
    console.log('   window.lastOCRLogs');
    console.log('   OCR_DEBUG.exportLogs()');
    console.log('   // Para ver s√≥ blacklist: console.log(window.lastOCRLogs.filter(l => l.etapa === "BLACKLIST"))');
    
    if (linhasProdutos.length === 0) {
      void 0;
    }
    
    return linhasProdutos;
  };
  
  // Metadata
  const extractFaturaMetadata = (texto) => {
    const linhas = texto.split('\n');
    const metadata = { numeroFatura: null, data: null, nif: null, total: null };
    for (const linha of linhas) {
      if (!metadata.numeroFatura) {
        // Procurar m√∫ltiplos padr√µes de n√∫mero de fatura
        const padroes = [
          /FT[\s\/-]*(\d{4}[\/-]\d+)/gi,                    // FT 2024/123, FT/2024/123
          /FT[\s\/-]*(\d+)/gi,                              // FT 123, FT123
          /(?:fatura|factura)[\s:n¬∫¬∞#]*(\d+\/\d+)/gi,      // Fatura 2024/123
          /(?:fatura|factura)[\s:n¬∫¬∞#]*(\d{4,})/gi,        // Fatura 123456
          /(?:invoice)[\s:#]*(\d+)/gi,                      // Invoice #123
          /N[¬∫¬∞][\s:]*(\d{4,})/gi                          // N¬∫ 123456
        ];
        
        for (const padrao of padroes) {
          const match = linha.match(padrao);
          if (match) {
            // Extrair apenas os n√∫meros/identificador
            const numMatch = match[0].match(/[\d\/\-]+$/);
            if (numMatch) {
              metadata.numeroFatura = numMatch[0];
              break;
            }
          }
        }
      }
      if (!metadata.data) {
        const data = linha.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
        if (data) metadata.data = data[1];
      }
      if (!metadata.nif) {
        const nif = linha.match(/(?:nif|nipc|contribuinte)[:\s]*(\d{9})/i);
        if (nif) metadata.nif = nif[1];
      }
      if (!metadata.total) {
        const total = linha.match(/total[\s:]*‚Ç¨?\s*(\d+[.,]\d{2})/i);
        if (total) metadata.total = parseFloat(total[1].replace(',', '.'));
      }
    }
    void 0;
    return metadata;
  };
  
  // Matching
  /**
   * üÜï Extrai palavras-chave principais do nome do produto
   * Remove ru√≠do comum (marcas, quantidades, c√≥digos, etc.)
   */
  const extrairPalavrasChave = (texto) => {
    if (!texto) return [];
    
    // Normalizar primeiro
    let limpo = texto
      .toUpperCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, ''); // Remove acentos
    
    // Remover padr√µes comuns de ru√≠do
    limpo = limpo
      // Remover quantidades: 250GR, 1KG, 500ML, 2L, etc.
      .replace(/\d+\s*(G|GR|GRAMA|GRAMAS|KG|KILO|QUILOGRAMA|ML|L|LITRO|LITROS|CL|DL|UN|UNI|UNIDADE|UNIDADES|PCT|PACOTE|EMBALAGEM|EMBALGEM|SCO|SACO)\b/gi, '')
      // Remover c√≥digos de produto: 110126.1, etc.
      .replace(/\b\d{5,}\.\d+\b/g, '')
      // Remover marcas comuns
      .replace(/\b(MCHEF|M CHEF|AMANH|AMANH√É|PRIMOR|CHEF|MASTER|ROYAL|FERBAR|SCHOCO|VAHINE|PANTAGRUEL|NIDO)\b/gi, '')
      // Remover palavras de contexto que n√£o s√£o ingredientes
      .replace(/\b(FAT|FT|VIDRO|LATA|PACOTE|PCT|EMBALAGEM|EMBALGEM|SC|SCO|SACO|CAL|RAMA|SECOS|SECA|SECO|SERR|BCO|PAP|GORDO|CULINARIA)\b/gi, '')
      // Remover n√∫meros soltos
      .replace(/\b\d+\b/g, '')
      // Limpar pontua√ß√£o
      .replace(/[^\w\s]/g, ' ')
      // Limpar espa√ßos m√∫ltiplos
      .replace(/\s+/g, ' ')
      .trim();
    
    // Dividir em palavras e filtrar palavras muito curtas
    const palavras = limpo
      .split(' ')
      .filter(p => p.length >= 3) // Palavras com 3+ letras
      .filter(p => !/^\d+$/.test(p)); // Remover n√∫meros puros
    
    return palavras;
  };

  const findBestMatch = (nomeProduto, ingredientes) => {
    if (!nomeProduto || !ingredientes || ingredientes.length === 0) {
      return null;
    }
    
    // Extrair palavras-chave do produto (com limpeza inteligente)
    const palavrasProduto = extrairPalavrasChave(nomeProduto);
    
    if (palavrasProduto.length === 0) {
      return null;
    }
    
    let bestMatch = null;
    let bestScore = 0;
    let bestMethod = '';
    
    for (const ing of ingredientes) {
      const palavrasIng = extrairPalavrasChave(ing.nome);
      let score = 0;
      let method = '';
      
      // ========== CAMADA 1: MATCH EXATO DE PALAVRAS ==========
      // Se TODAS as palavras-chave do ingrediente est√£o no produto ‚Üí 95 pontos
      if (palavrasIng.length > 0) {
        const todasPalavrasPresentes = palavrasIng.every(pIng => 
          palavrasProduto.some(pProd => pProd === pIng)
        );
        
        if (todasPalavrasPresentes) {
          score = 95;
          method = 'MATCH_EXATO_COMPLETO';
        }
      }
      
      // ========== CAMADA 2: MATCH PARCIAL DE PALAVRAS ==========
      // Quantas palavras em comum? Quanto maior o overlap, maior o score
      if (score === 0 && palavrasIng.length > 0 && palavrasProduto.length > 0) {
        const palavrasComuns = palavrasProduto.filter(pProd =>
          palavrasIng.some(pIng => pIng === pProd)
        );
        
        if (palavrasComuns.length > 0) {
          // Score baseado na % de overlap
          const overlapProduto = palavrasComuns.length / palavrasProduto.length;
          const overlapIngrediente = palavrasComuns.length / palavrasIng.length;
          const overlapMedio = (overlapProduto + overlapIngrediente) / 2;
          
          score = Math.round(overlapMedio * 85); // Max 85 pontos
          method = `MATCH_PARCIAL (${palavrasComuns.length}/${palavrasProduto.length} palavras)`;
        }
      }
      
      // ========== CAMADA 3: FUZZY MATCH TRADICIONAL ==========
      // Fallback: se n√£o houve match de palavras, usar fuzzy (max 75 pontos)
      if (score === 0) {
        const produtoNorm = palavrasProduto.join(' ');
        const ingNorm = palavrasIng.join(' ');
        
        if (produtoNorm && ingNorm && typeof fuzz !== 'undefined') {
          const fuzzyScore = fuzz.ratio(produtoNorm, ingNorm);
          score = Math.round(fuzzyScore * 0.75); // Limitar a 75%
          method = 'FUZZY_MATCH';
        }
      }
      
      // Atualizar melhor match
      if (score > bestScore) {
        bestScore = score;
        bestMatch = {
          id: ing.id,
          nome: ing.nome,
          confianca: score,
          metodo: method,
          textoOCR: nomeProduto,
          palavrasChave: palavrasProduto.join(', ')
        };
      }
    }
    
    // Threshold: 40 pontos (mais permissivo para capturar mais matches)
    return bestScore >= 40 ? bestMatch : null;
  };
  
  const matchIngredientes = (linhas, ingredientes) => {
    void 0;
    setProgressoOCR('Relacionando...');
    return linhas.map(linha => ({
      ...linha,
      ingredienteSugerido: findBestMatch(linha.nomeProduto, ingredientes)
    }));
  };
  
  const calculateMatchingStats = (linhas) => {
    const total = linhas.length;
    const comSugestao = linhas.filter(l => l.ingredienteSugerido).length;
    const altaConfianca = linhas.filter(l => l.ingredienteSugerido?.confianca >= 80).length;
    const mediaConfianca = linhas.filter(l => l.ingredienteSugerido?.confianca >= 60 && l.ingredienteSugerido?.confianca < 80).length;
    return {
      total, comSugestao, altaConfianca, mediaConfianca,
      semSugestao: total - comSugestao,
      percentagemAuto: total > 0 ? Math.round((altaConfianca / total) * 100) : 0
    };
  };
  
  const getConfidenceLevel = (score) => {
    if (score >= 80) return { nivel: 'alta', cor: 'green', icone: '‚úì' };
    if (score >= 60) return { nivel: 'media', cor: 'yellow', icone: '‚ö†' };
    return { nivel: 'baixa', cor: 'red', icone: '‚úó' };
  };
  
  // Handler principal
  const handleLerPDFAutomatico = async (event) => {
    const file = event.target.files[0];
    if (!file) {
      showNotification('‚ö†Ô∏è Selecione um ficheiro', 'error');
      return;
    }
    
    // Aceitar PDF ou imagens
    const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      showNotification('‚ö†Ô∏è Selecione um PDF ou imagem (PNG, JPG, WEBP)', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    // Verificar APENAS Tesseract e Fuzzball (PDF.js n√£o √© mais necess√°rio)
    if (typeof Tesseract === 'undefined') {
      showNotification('‚ö†Ô∏è Biblioteca Tesseract ainda n√£o carregou. Aguarde e tente novamente.', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    if (typeof fuzz === 'undefined' && typeof window.fuzzball === 'undefined') {
      showNotification('‚ö†Ô∏è Biblioteca de matching ainda n√£o carregou. Aguarde e tente novamente.', 'error');
      event.target.value = ''; // Limpar input
      return;
    }
    
    let base64 = null;
    
    try {
      setProcessandoOCR(true);
      setProgressoOCR('Carregando...');
      
      // Ler ficheiro e converter para base64 PRIMEIRO
      const arrayBuffer = await file.arrayBuffer();
      base64 = btoa(
        new Uint8Array(arrayBuffer)
          .reduce((data, byte) => data + String.fromCharCode(byte), '')
      );
      
      // Extrair texto (passa file direto agora, n√£o arrayBuffer)
      const { text, method } = await extractTextFromPdf(file);
      void 0;
      
      // Extrair metadata PRIMEIRO (para ter NIF)
      const metadata = extractFaturaMetadata(text);
      metadata.textoCompleto = text; // Guardar para aprender template
      
      // üÜï DETECTAR SE TEM NIF DO CLIENTE
      const nifEmpresa = configuracoes.metricas.nifEmpresa;
      if (nifEmpresa) {
        const temNifCliente = detetarNifCliente(text, nifEmpresa);
        metadata.temNifCliente = temNifCliente;
        metadata.nifClienteDetetado = temNifCliente ? nifEmpresa : null;
        console.log(`üîç [NIF] Dete√ß√£o: ${temNifCliente ? 'ENCONTRADO' : 'N√ÉO encontrado'}`);
      } else {
        metadata.temNifCliente = false;
        metadata.nifClienteDetetado = null;
        console.log('‚ö†Ô∏è [NIF] NIF da empresa n√£o configurado');
      }
      
      // ==================== PROCESSAR FATURA V2.0 ====================
      // Detectar tipo de fatura e extrair dados estruturados
      const dadosFatura = processarTextoFatura(text, fornecedores); // ‚úÖ PASSAR FORNECEDORES
      void 0;
      
      // Criar URL tempor√°rio do PDF para visualiza√ß√£o
      const pdfBlob = new Blob([await file.arrayBuffer()], { type: 'application/pdf' });
      const pdfUrl = URL.createObjectURL(pdfBlob);
      
      // Mostrar modal de confirma√ß√£o ANTES de continuar
      setModalConfirmacaoFatura({
        mostrar: true,
        dados: {
          ...dadosFatura,
          pdfUrl: pdfUrl
        }
      });
      // ==================== FIM PROCESSAMENTO V2.0 ====================
      
      // üìã Usar template se existir
      const template = buscarTemplateOCR(metadata.nif);
      const linhas = template 
        ? parseComTemplate(text, template) 
        : parseLinhasProdutos(text, metadata.nif); // üö´ CORRIGIDO: Passar NIF para usar blacklist
      
      // SEMPRE guardar PDF (independente de ter produtos ou n√£o)
      metadata.pdfBase64 = base64;
      metadata.pdfNome = file.name;
      metadata.precosComIVA = dadosFatura.precosComIVA; // NOVO: passar flag de IVA
      
      // Fazer matching dos ingredientes (pode estar vazio)
      const linhasComMatch = linhas.length > 0 
        ? matchIngredientes(linhas, ingredientes)
        : []; // Lista vazia mas abre modal na mesma
      
      // üö´ N√ÉO ABRIR MODAL 2 AINDA! S√≥ preparar os dados
      // O Modal 2 vai abrir quando o usu√°rio confirmar o Modal 1
      setLinhasOCR(linhasComMatch);
      setMetadataOCR(metadata);
      // setMostrarModalOCR(true); // ‚ùå REMOVIDO - vai abrir no handleConfirmarFatura
      
      if (linhas.length === 0) {
        void 0; // Apenas log, n√£o notificar ainda
      } else {
        void 0;
      }
    } catch (error) {
      void 0;
      
      // MESMO com erro, tenta guardar o PDF se conseguiu converter
      if (base64) {
        setNovaFatura({
          ...novaFatura,
          documentoPDF: base64,
          nomeDocumento: file.name
        });
        showNotification('‚ùå Erro no OCR, mas PDF foi guardado! Adicione dados manualmente.', 'warning');
      } else {
        showNotification('‚ùå Erro ao processar: ' + error.message, 'error');
      }
    } finally {
      setProcessandoOCR(false);
      setProgressoOCR('');
      event.target.value = ''; // ‚úÖ LIMPAR INPUT SEMPRE NO FINAL
    }
  };
  
  // Confirmar
  const handleConfirmarOCR = (linhasValidadas, metadata) => {
    void 0;
    
    // ‚úÖ FECHAR MODAL OCR IMEDIATAMENTE para evitar cliques duplicados
    setMostrarModalOCR(false);
    
    // üÜï VERIFICA√á√ÉO DE SEGURAN√áA: S√≥ processar ingredientes se categoria for COMPRAS
    const categoriaFatura = metadata.categoria || 'compras';
    if (categoriaFatura !== 'compras') {
      void 0;
      showNotification('‚ö†Ô∏è Esta fatura n√£o √© de compras. N√£o √© necess√°rio processar ingredientes.', 'warning');
      return;
    }
    
    // üß† FASE 2: RECONHECIMENTO AUTOM√ÅTICO DE INGREDIENTES
    const nifFornecedor = metadata.nif || novaFatura.fornecedorNIF;
    
    if (nifFornecedor) {
      void 0;
      
      linhasValidadas = linhasValidadas.map(linha => {
        // Se j√° tem ingrediente confirmado, manter
        if (linha.ingredienteConfirmado) {
          void 0;
          return linha;
        }
        
        // Buscar no vocabul√°rio do fornecedor
        const resultado = buscarNoVocabulario(linha.nomeProduto, nifFornecedor);
        
        if (resultado) {
          const { ingredienteId, confianca, similaridade, confirmacoes, correcoes } = resultado;
          const ingrediente = ingredientes.find(i => i.id === ingredienteId);
          
          if (ingrediente) {
            void 0;
            
            // ‚úÖ AUTO-PREENCHER SE CONFIAN√áA >= 80%
            if (confianca >= 80) {
              void 0;
              
              const ingrediente = ingredientes.find(i => i.id === ingredienteId);
              
              // ‚úÖ Criar objeto ingrediente sugerido consistente
              const ingredienteSugeridoObj = ingrediente ? {
                id: ingrediente.id,
                nome: ingrediente.nome,
                confianca: confianca,
                metodo: 'VOCABULARIO'
              } : null;
              
              // üÜï BUSCAR √öLTIMA UNIDADE USADA do hist√≥rico
              const historico = buscarHistoricoIngrediente(ingredienteId, nifFornecedor);
              const unidadeUltimaVez = historico?.unidade || ingrediente?.unidade || 'kg';
              
              // üÜï AUTO-PREENCHER COM PRE√áO ATUAL DO INGREDIENTE + UNIDADE DA √öLTIMA VEZ
              return {
                ...linha,
                ingredienteConfirmado: ingredienteId, // Auto-preencher nome
                ingredienteSugerido: ingredienteSugeridoObj,   // Guardar objeto completo
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes },
                // Usar PRE√áO ATUAL do ingrediente
                precoSugerido: ingrediente?.custoUnitario || null,
                // Usar UNIDADE da √∫ltima compra deste fornecedor
                unidade: linha.unidade || unidadeUltimaVez,
                // Quantidade vem do OCR ou fica vazia para utilizador preencher
                quantidade: linha.quantidade || null
              };
            } else {
              // Confian√ßa baixa - s√≥ sugerir, n√£o auto-preencher
              void 0;
              
              const ingrediente = ingredientes.find(i => i.id === ingredienteId);
              const ingredienteSugeridoObj = ingrediente ? {
                id: ingrediente.id,
                nome: ingrediente.nome,
                confianca: confianca,
                metodo: 'VOCABULARIO'
              } : null;
              
              // S√ì SUGERIR O NOME - sem preencher quantidade/pre√ßo
              return {
                ...linha,
                ingredienteSugerido: ingredienteSugeridoObj, // Objeto completo
                confiancaSugestao: confianca,
                similaridadeSugestao: similaridade,
                historicoSugestao: { confirmacoes, correcoes }
                // N√£o preencher quantidade/pre√ßo/unidade
              };
            }
          }
        }
        
        // Se n√£o encontrou no vocabul√°rio, tentar FUZZY MATCH
        const fuzzyMatch = findBestMatch(linha.nomeProduto, ingredientes);
        
        if (fuzzyMatch && fuzzyMatch.confianca >= 60) {
          void 0;
          
          return {
            ...linha,
            ingredienteSugerido: fuzzyMatch, // Objeto completo
            confiancaSugestao: fuzzyMatch.confianca,
            similaridadeSugestao: fuzzyMatch.confianca,
            historicoSugestao: { confirmacoes: 0, correcoes: 0 }
          };
        }
        
        void 0;
        return linha;
      });
      
      const sugeridos = linhasValidadas.filter(l => l.ingredienteSugerido).length;
      const total = linhasValidadas.length;
      
      if (sugeridos > 0) {
        void 0;
      } else {
        void 0;
      }
    }
    
    // ATUALIZAR PRE√áOS DOS INGREDIENTES
    const ingredientesAtualizados = [...ingredientes];
    
    // üÜï ADICIONAR NOVOS INGREDIENTES CRIADOS NO MODAL
    if (metadata.novosIngredientes && metadata.novosIngredientes.length > 0) {
      const novosIngs = metadata.novosIngredientes;
      setIngredientes([...ingredientes, ...novosIngs]);
      void 0;
      
      // Atualizar lista local para usar nas pr√≥ximas etapas
      ingredientesAtualizados.push(...novosIngs);
    }
    
    // üÜï ADICIONAR NOVOS FORNECEDORES CRIADOS NO MODAL
    if (window._novosFornecedores && window._novosFornecedores.length > 0) {
      const novosForn = window._novosFornecedores;
      setFornecedores([...fornecedores, ...novosForn]);
      void 0;
      
      // Limpar cache
      window._novosFornecedores = [];
    }
    
    let ingredientesModificados = 0;
    const mudancasPreco = []; // NOVO: Coletar mudan√ßas em vez de aplicar
    
    void 0;
    void 0;
    void 0;
    
    linhasValidadas.forEach(l => {
      if (l.ingredienteConfirmado && l.preco && l.quantidade) {
        const index = ingredientesAtualizados.findIndex(i => i.id === l.ingredienteConfirmado);
        
        if (index === -1) {
          void 0;
          return;
        }
        
        const ingrediente = ingredientesAtualizados[index];
        const precoTotal = parseFloat(l.preco);
        const quantidade = parseFloat(l.quantidade);
        const unidadeCompra = l.unidade || ingrediente.unidade; // Unidade da compra
        const unidadeBase = ingrediente.unidade; // Unidade base do ingrediente
        const iva = ingrediente.iva || 23;
        
        void 0;
        void 0;
        void 0;
        void 0;
        void 0;
        
        // ‚úÖ CONVERTER QUANTIDADE PARA UNIDADE BASE
        let quantidadeBase = quantidade;
        if (unidadeCompra === 'g' && unidadeBase === 'kg') {
          quantidadeBase = quantidade / 1000;
          void 0;
        } else if (unidadeCompra === 'ml' && unidadeBase === 'L') {
          quantidadeBase = quantidade / 1000;
          void 0;
        } else if (unidadeCompra === 'kg' && unidadeBase === 'g') {
          quantidadeBase = quantidade * 1000;
          void 0;
        } else if (unidadeCompra === 'L' && unidadeBase === 'ml') {
          quantidadeBase = quantidade * 1000;
          void 0;
        } else if (unidadeCompra === unidadeBase) {
          quantidadeBase = quantidade;
          void 0;
        }
        
        let novoPrecoUnitario;
        
        // ‚úÖ Calcular pre√ßo por unidade BASE (usando quantidade convertida)
        const precoComIVA = precoTotal / quantidadeBase; // Dividir pela quantidade BASE
        novoPrecoUnitario = precoComIVA; // Guardar COM IVA conforme requisitado
        
        const precoAnterior = ingredientesAtualizados[index].custoUnitario || 0;
        
        // Log detalhado do c√°lculo
        void 0;
        void 0;
        void 0;
        void 0;
        void 0;
        
        // COLETAR mudan√ßa se pre√ßo mudou
        if (Math.abs(novoPrecoUnitario - precoAnterior) > 0.01) {
          void 0;
          
          mudancasPreco.push({
            ingredienteId: ingrediente.id,
            ingredienteNome: ingrediente.nome,
            ingredienteIndex: index,
            precoAnterior,
            precoNovo: novoPrecoUnitario
          });
          
          ingredientesModificados++;
        } else {
          void 0;
        }
      }
    });
    
    // Se houver mudan√ßas, iniciar fila de modais
    if (mudancasPreco.length > 0) {
      void 0;
      void 0;
      
      // Guardar contexto no window para handlers do modal acessarem
      window._ocrContext = {
        ingredientesAtualizados,
        linhasValidadas,
        metadata,
        mudancasPreco,
        indiceAtual: 0
      };
      
      // Mostrar primeiro modal usando o sistema existente
      const primeiraMudanca = mudancasPreco[0];
      const ingrediente = ingredientesAtualizados.find(i => i.id === primeiraMudanca.ingredienteId);
      
      setPriceAlertData({
        tipoOperacao: 'ocrPriceUpdate',
        ingrediente: ingrediente,
        precoAtual: primeiraMudanca.precoAnterior,
        precoNovo: primeiraMudanca.precoNovo,
        unidadeBase: ingrediente.unidade,
        produtosAfetados: produtos.filter(p => 
          p.receita && p.receita.some(r => r.ingredienteId === ingrediente.id)
        ),
        totalMudancas: mudancasPreco.length,
        mudancaAtual: 1
      });
      
      setShowPriceAlert(true);
      
      return; // PARA AQUI - modal vai continuar o processo
    }
    
    // Se n√£o houver mudan√ßas, continuar normalmente
    void 0;
    finalizarFaturaOCR(ingredientesAtualizados, linhasValidadas, metadata);
  };
  
  // Fun√ß√£o para finalizar fatura ap√≥s confirma√ß√µes de pre√ßo
  const finalizarFaturaOCR = (ingredientesAtualizados, linhasValidadas, metadata) => {
    void 0;
    
    // Atualizar ingredientes
    setIngredientes(ingredientesAtualizados);
    
    // RECALCULAR FOOD COST DOS PRODUTOS
    const produtosAtualizados = produtos.map(produto => {
      if (!produto.receita || produto.receita.length === 0) return produto;
      
      // Calcular novo custo (usando a mesma l√≥gica do calcCusto)
      const novoCusto = produto.receita.reduce((total, item) => {
        const ing = ingredientesAtualizados.find(i => i.id === item.ingredienteId);
        if (!ing) return total;
        
        let quantidade = parseFloat(item.quantidade) || 0;
        const precoUnit = parseFloat(ing.custoUnitario) || 0;
        
        // ‚úÖ CONVERS√ÉO DE UNIDADES (igual ao calcCusto)
        const unidadeReceita = item.unidade || ing.unidade;
        if (ing.unidade === 'kg' && unidadeReceita === 'g') quantidade = quantidade / 1000;
        if (ing.unidade === 'L' && unidadeReceita === 'ml') quantidade = quantidade / 1000;
        if (ing.unidade === 'g' && unidadeReceita === 'kg') quantidade = quantidade * 1000;
        if (ing.unidade === 'ml' && unidadeReceita === 'L') quantidade = quantidade * 1000;
        
        // ‚úÖ APLICAR DESPERD√çCIO (igual ao calcCusto)
        const percentagemDesperdicio = getPercentagemDesperdicio(ing);
        const custoComDesperdicio = precoUnit * (1 + percentagemDesperdicio / 100);
        
        return total + (quantidade * custoComDesperdicio);
      }, 0);
      
      // ‚úÖ DIVIDIR POR POR√á√ïES (igual ao calcCusto)
      const custoFinal = (produto.porcoes && produto.porcoes > 1) 
        ? novoCusto / produto.porcoes 
        : novoCusto;
      
      // Calcular nova margem
      const precoVenda = parseFloat(produto.precoVenda) || 0;
      const novaMargemLucro = precoVenda > 0 ? ((precoVenda - custoFinal) / precoVenda) * 100 : 0;
      
      // S√≥ atualizar se mudou
      if (Math.abs(custoFinal - (produto.custoReceita || 0)) > 0.01) {
        void 0;
        
        return {
          ...produto,
          custoReceita: custoFinal,
          margemLucro: novaMargemLucro
        };
      }
      
      return produto;
    });
    
    setProdutos(produtosAtualizados);
    
    // Criar itens da fatura COM ESTRUTURA CORRETA
    // üÜï L√ìGICA DIFERENTE CONFORME CATEGORIA
    const categoria = metadata.categoria || 'compras';
    const novosItens = linhasValidadas
      .filter(l => {
        // Se categoria = compras, exigir ingrediente
        if (categoria === 'compras') {
          return l.ingredienteConfirmado;
        }
        // Para outras categorias, aceitar todas as linhas com pre√ßo
        return l.preco && parseFloat(l.preco) > 0;
      })
      .map((l, index) => {
        const quantidade = parseFloat(l.quantidade) || 1;
        const precoTotal = parseFloat(l.preco) || 0; // COM IVA
        
        // Se categoria = compras, buscar ingrediente
        if (categoria === 'compras' && l.ingredienteConfirmado) {
          const ingrediente = ingredientesAtualizados.find(i => i.id === l.ingredienteConfirmado);
          const iva = parseFloat(ingrediente?.iva || 13);
          
          // ‚úÖ REMOVER IVA do pre√ßo
          const precoComIVA = precoTotal / quantidade;
          const precoUnitario = precoComIVA / (1 + iva / 100); // SEM IVA
          const subtotal = precoUnitario * quantidade; // SEM IVA
          
          void 0;
          
          return {
            id: `ocr_${Date.now()}_${index}`,
            ingredienteId: l.ingredienteConfirmado,
            ingredienteNome: ingrediente?.nome || l.nomeProduto,
            descricao: ingrediente?.nome || l.nomeProduto,
            quantidade: quantidade,
            unidade: l.unidade || ingrediente?.unidade || 'un',
            precoUnitario: precoUnitario,
            precoTotal: precoTotal,
            subtotal: subtotal,
            iva: iva,
            num_funcionarios: 1
          };
        }
        
        // Para outras categorias (renda, eletricidade, etc.)
        // Criar item gen√©rico sem ingrediente
        const iva = categoria === 'salarios' ? 0 : 23; // Sal√°rios sem IVA, resto 23%
        const precoComIVA = precoTotal / quantidade;
        const precoUnitario = iva > 0 ? precoComIVA / (1 + iva / 100) : precoComIVA;
        const subtotal = precoUnitario * quantidade;
        
        void 0;
        
        return {
          id: `ocr_${Date.now()}_${index}`,
          descricao: l.nomeProduto || `Item ${index + 1}`,
          quantidade: 1, // Fixo para despesas fixas
          unidade: 'servi√ßo',
          precoUnitario: precoTotal,
          precoTotal: precoTotal,
          subtotal: subtotal,
          iva: iva,
          num_funcionarios: 1
        };
      });
    
    void 0;
    void 0;
    
    // Extrair NIF do fornecedor para aprendizagem
    const nifFornecedor = metadata.nif || novaFatura.fornecedorNIF;
    
    // üß† FASE 2: APRENDER COM AS CONFIRMA√á√ïES DO UTILIZADOR
    if (nifFornecedor) {
      linhasValidadas.forEach(linha => {
        if (linha.ingredienteConfirmado && linha.nomeProduto) {
          const textoOCR = linha.nomeProduto;
          const ingredienteId = linha.ingredienteConfirmado;
          
          // Verificar se foi alterado (corre√ß√£o) ou confirmado (sugest√£o aceite)
          const foiAlterado = linha.ingredienteSugerido && 
                             linha.ingredienteConfirmado !== linha.ingredienteSugerido.id;
          
          // üÜï Passar dados da linha para aprendizagem
          const dadosLinha = {
            quantidade: linha.quantidade,
            unidade: linha.unidade,
            preco: linha.preco
          };
          
          // Aprender a associa√ß√£o COM dados completos
          aprenderAssociacao(textoOCR, ingredienteId, nifFornecedor, foiAlterado, dadosLinha);
          
          if (foiAlterado) {
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);
            void 0;
          } else if (linha.ingredienteSugerido) {
            void 0;
          } else {
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);
            void 0;
          }
        }
      });
    }
    
    // üìã Aprender template do fornecedor
    if (nifFornecedor && metadata.textoCompleto) {
      aprenderTemplateOCR(nifFornecedor, metadata.textoCompleto, linhasValidadas);
    }
    
    // Preencher dados da fatura (preservando PDF!)
    const tipoFatura = metadata.tipoFatura || 'FT';
    const novaFaturaAtualizada = {
      ...novaFatura,
      numero: metadata.numeroFatura || novaFatura.numero,
      tipo: tipoFatura, // ‚úÖ TIPO DE FATURA (FT/FR/FS)
      // üÜï CAMPOS DE NIF DO CLIENTE
      temNifCliente: metadata.temNifCliente || false,
      nifCliente: metadata.nifClienteDetetado || configuracoes.metricas.nifEmpresa || null,
      paraContabilista: (() => {
        const temNif = metadata.temNifCliente;
        // FT e FR sempre v√£o
        if (tipoFatura === 'FT' || tipoFatura === 'FR') return true;
        // FS s√≥ vai se tiver NIF
        if (tipoFatura === 'FS') return temNif === true;
        return false;
      })(),
      tipoDocumento: metadata.tipoDocumento || 'fatura', // ‚Üê tipo do documento
      data: metadata.data ? convertDataToISO(metadata.data) : novaFatura.data,
      itens: novosItens,
      documentoPDF: metadata.pdfBase64 || novaFatura.documentoPDF || null,
      nomeDocumento: metadata.pdfNome || novaFatura.nomeDocumento || '',
      categoria: metadata.categoria || 'compras', // üÜï USAR CATEGORIA DO METADATA
      totais: metadata.totais || { subtotal: 0, iva: 0, total: 0 } // ‚úÖ TOTAIS DA FATURA
    };
    
    // ‚úÖ PRIORIDADE 1: Usar fornecedorId se foi confirmado no Modal 1
    if (metadata.fornecedorId) {
      const fornecedor = fornecedores.find(f => f.id === metadata.fornecedorId);
      if (fornecedor) {
        novaFaturaAtualizada.fornecedorId = fornecedor.id;
        novaFaturaAtualizada.fornecedorNome = fornecedor.nome;
        novaFaturaAtualizada.fornecedorNif = fornecedor.nif || metadata.nif || '';
        void 0;
      }
    }
    // PRIORIDADE 2: Tentar identificar fornecedor pelo NIF (se n√£o foi confirmado)
    else if (metadata.nif) {
      const fornecedor = fornecedores.find(f => f.nif === metadata.nif);
      if (fornecedor) {
        novaFaturaAtualizada.fornecedorId = fornecedor.id;
        novaFaturaAtualizada.fornecedorNome = fornecedor.nome;
        novaFaturaAtualizada.fornecedorNif = metadata.nif;
        void 0;
      }
    }
    
    // PRIORIDADE 3: Se fornecedor foi selecionado manualmente (sem NIF detectado)
    if (metadata.fornecedorManual && !novaFaturaAtualizada.fornecedorId) {
      // Verificar se √© fornecedor tempor√°rio (rec√©m-criado)
      let fornecedorManual = fornecedores.find(f => f.id === metadata.fornecedorManual);
      
      if (!fornecedorManual && window._novosFornecedores) {
        fornecedorManual = window._novosFornecedores.find(f => f.id === metadata.fornecedorManual);
      }
      
      if (fornecedorManual) {
        novaFaturaAtualizada.fornecedorId = fornecedorManual.id;
        novaFaturaAtualizada.fornecedorNome = fornecedorManual.nome;
        novaFaturaAtualizada.fornecedorNif = fornecedorManual.nif;
        void 0;
      }
    }
    
    void 0;
    void 0;
    
    // ‚úÖ MARCAR COMO VINDO DE OCR para evitar re-processar pre√ßos ao guardar
    novaFaturaAtualizada.fromOCR = true;
    
    setNovaFatura(novaFaturaAtualizada);
    // ‚úÖ Modal OCR j√° foi fechado no in√≠cio de handleConfirmarOCR
    
    // ‚úÖ AUTO-SALVAR FATURA ap√≥s processar OCR (evita clique duplicado em "Guardar")
    setTimeout(() => {
      salvarFaturaSemAlerta(novaFaturaAtualizada);
      
      // Limpar formul√°rio para pr√≥xima fatura
      setNovaFatura({
        numero: '',
        tipo: 'FT',
        tipoDocumento: 'fatura',
        data: new Date().toISOString().split('T')[0],
        fornecedorId: '',
        fornecedorNome: '',
        fornecedorNif: '',
        itens: [],
        notas: '',
        categoria: 'compras',
        recorrente: false,
        documentoPDF: null,
        nomeDocumento: ''
      });
      
      const tipoMsg = novaFaturaAtualizada.tipoDocumento === 'fatura' ? 'Fatura' : 'Recibo';
      showNotification(`‚úÖ ${tipoMsg} guardada com ${novosItens.length} produtos!`, 'success');
    }, 100);

  };
  
  // Converter data DD/MM/YYYY para YYYY-MM-DD
  const convertDataToISO = (dataStr) => {
    if (!dataStr) return new Date().toISOString().split('T')[0];
    
    try {
      // Se j√° est√° em formato ISO (YYYY-MM-DD), retorna direto
      if (/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) {
        return dataStr;
      }
      
      // Tentar formatos: DD/MM/YYYY, DD-MM-YYYY, DD/MM/YY
      const patterns = [
        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, // DD/MM/YYYY
        /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/   // DD/MM/YY
      ];
      
      for (const pattern of patterns) {
        const match = dataStr.match(pattern);
        if (match) {
          let [_, dia, mes, ano] = match;
          
          // Converter ano de 2 d√≠gitos
          if (ano.length === 2) {
            ano = parseInt(ano) > 50 ? `19${ano}` : `20${ano}`;
          }
          
          // Adicionar zero √† esquerda se necess√°rio
          dia = dia.padStart(2, '0');
          mes = mes.padStart(2, '0');
          
          // Validar m√™s e dia
          const mesNum = parseInt(mes);
          const diaNum = parseInt(dia);
          
          if (mesNum < 1 || mesNum > 12 || diaNum < 1 || diaNum > 31) {
            console.error('Data inv√°lida detectada:', dataStr, '‚Üí Dia:', dia, 'M√™s:', mes);
            return new Date().toISOString().split('T')[0];
          }
          
          return `${ano}-${mes}-${dia}`;
        }
      }
      
      // Se falhar, retornar data atual
      console.warn('Formato de data n√£o reconhecido:', dataStr);
      return new Date().toISOString().split('T')[0];
    } catch (e) {
      console.error('Erro ao converter data:', dataStr, e);
      return new Date().toISOString().split('T')[0];
    }
  };

  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
    { id: 'gestao', label: 'Gest√£o', icon: FileText },
    { id: 'definicoes', label: 'Defini√ß√µes', icon: Settings }
  ];

  return (
    <div className={`min-h-screen p-2 transition-colors bg-gray-50`}>
      {/* Notification */}
      {notification && (
        <div className={`fixed top-2 right-2 z-50 flex items-center gap-2 px-4 py-2 rounded-lg shadow-lg text-sm ${
          notification.type === 'success' ? 'bg-green-500 text-white' : 
          notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
        }`}>
          {notification.type === 'success' && <Check size={16} />}
          {notification.type === 'error' && <X size={16} />}
          <span>{notification.message}</span>
        </div>
      )}

      {/* Price Change Alert Modal */}
      {showPriceAlert && priceAlertData && (
        <div className="fixed inset-0 bg-black/50 flex items-start justify-center z-[60] overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-2xl max-w-md w-full my-8">
            <div className="bg-orange-500 text-white px-4 py-3 rounded-t-lg flex items-center justify-between">
              <h3 className="font-bold text-lg flex items-center gap-2">
                <AlertCircle size={20} />
                Preco Diferente do Registado
                {priceAlertData.tipoOperacao === 'ocrPriceUpdate' && priceAlertData.totalMudancas > 1 && (
                  <span className="text-sm font-normal opacity-90">
                    ({priceAlertData.mudancaAtual}/{priceAlertData.totalMudancas})
                  </span>
                )}
              </h3>
              <button
                onClick={() => {
                  void 0;
                  setShowPriceAlert(false);
                  setPriceAlertData(null);
                }}
                className="hover:bg-orange-600 rounded p-1 transition"
              >
                <X size={20} />
              </button>
            </div>
            
            <div className="p-4 space-y-3">
              <div className="bg-orange-50 border border-orange-200 rounded p-3">
                <p className="text-sm font-bold text-orange-900 mb-2">{priceAlertData.ingrediente.nome}:</p>
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-700">Pre√ßo atual:</span>
                  <span className="font-semibold">‚Ç¨{priceAlertData.precoAtual.toFixed(2)}/{priceAlertData.ingrediente.unidade}</span>
                </div>
                <div className="flex justify-between items-center text-sm mb-1">
                  <span className="text-gray-700">Pre√ßo novo:</span>
                  <span className="font-bold text-orange-600">‚Ç¨{priceAlertData.precoNovo.toFixed(2)}/{priceAlertData.ingrediente.unidade}</span>
                </div>
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-700">Diferen√ßa:</span>
                  <span className={`font-bold ${priceAlertData.precoNovo > priceAlertData.precoAtual ? 'text-red-600' : 'text-green-600'}`}>
                    {priceAlertData.precoNovo > priceAlertData.precoAtual ? '+' : ''}{(((priceAlertData.precoNovo - priceAlertData.precoAtual) / priceAlertData.precoAtual) * 100).toFixed(1)}%
                  </span>
                </div>
              </div>
              
              {priceAlertData.produtosAfetados.length > 0 && (
                <div className="bg-blue-50 border border-blue-200 rounded p-3">
                  <p className="text-xs font-semibold text-blue-900 mb-2">
                    üçΩÔ∏è {priceAlertData.produtosAfetados.length} produtos afetados:
                  </p>
                  <div className="space-y-1 max-h-32 overflow-y-auto">
                    {priceAlertData.produtosAfetados.slice(0, 5).map((p, idx) => (
                      <div key={idx} className="flex justify-between items-center text-xs bg-white rounded px-2 py-1">
                        <span className="text-gray-700">{p.nome}</span>
                        <span className={`font-semibold ${p.margemDif < 0 ? 'text-red-600' : 'text-green-600'}`}>
                          margem {p.margemDif < 0 ? '‚Üì' : '‚Üë'} ‚Ç¨{Math.abs(p.margemDif).toFixed(2)}
                        </span>
                      </div>
                    ))}
                    {priceAlertData.produtosAfetados.length > 5 && (
                      <p className="text-xs text-gray-500 text-center">+ {priceAlertData.produtosAfetados.length - 5} mais...</p>
                    )}
                  </div>
                </div>
              )}
              
              <p className="text-xs text-gray-600">
                üí° Atualizar o custo base vai recalcular automaticamente as margens de todos os produtos.
              </p>
            </div>
            
            <div className="flex gap-2 px-4 pb-4">
              <button
                onClick={() => {
                  void 0;
                  if (priceAlertData.tipoFatura || priceAlertData.tipoOperacao) {
                    confirmarFaturaSemAtualizar();
                  } else {
                    confirmarDespesaSemAtualizar();
                  }
                }}
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded px-4 py-2 text-sm font-semibold transition"
              >
                Ignorar
              </button>
              <button
                onClick={() => {
                  void 0;
                  // Verificar se √© edi√ß√£o manual de ingrediente
                  if (priceAlertData.tipoFatura === 'ingrediente') {
                    void 0;
                    atualizarIngredienteSemAlerta();
                    setShowPriceAlert(false);
                  } else if (priceAlertData.tipoFatura || priceAlertData.tipoOperacao) {
                    void 0;
                    confirmarFaturaEAtualizar();
                  } else {
                    void 0;
                    confirmarDespesaEAtualizar();
                  }
                }}
                className="flex-1 bg-orange-500 hover:bg-orange-600 text-white rounded px-4 py-2 text-sm font-semibold transition"
              >
                Atualizar Custo Base
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-[1600px] mx-auto">
        {/* Header */}
        <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 rounded-3xl shadow-2xl p-6 mb-4 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="bg-white/20 rounded-lg p-2 backdrop-blur-sm">
                <span className="text-2xl">üçΩÔ∏è</span>
              </div>
              <div>
                <h1 className="text-2xl font-bold tracking-tight">AI Munchi Manager</h1>
                <p className="text-blue-100 text-sm">Controla custos, margens e rentabilidade do teu restaurante em tempo real</p>
              </div>
            </div>
            
            {/* Google Drive Sync - Header */}
            <div className="flex items-center gap-3">
              {driveAccessToken ? (
                <>
                  {/* üÜï Indicador de Status do Drive - CLIC√ÅVEL para renovar */}
                  <button
                    onClick={loginGoogleDrive}
                    className={`backdrop-blur-sm rounded-lg px-3 py-2 border-2 flex items-center gap-2 transition hover:scale-105 ${
                      driveTokenValid 
                        ? 'bg-green-500/20 border-green-300 hover:bg-green-500/30' 
                        : driveTokenTimeLeft > 0 
                          ? 'bg-yellow-500/20 border-yellow-300 hover:bg-yellow-500/30' 
                          : 'bg-red-500/20 border-red-300 hover:bg-red-500/30'
                    }`}
                    title={driveTokenValid 
                      ? 'Clique para renovar token (mesmo que ainda v√°lido)' 
                      : driveTokenTimeLeft > 0 
                        ? `Token expira em ${driveTokenTimeLeft}min - Clique para renovar agora!` 
                        : 'Token expirado - Clique para renovar'}
                  >
                    <div className={`w-2 h-2 rounded-full ${
                      driveTokenValid 
                        ? 'bg-green-400' 
                        : driveTokenTimeLeft > 0 
                          ? 'bg-yellow-400 animate-pulse' 
                          : 'bg-red-400'
                    }`}></div>
                    <div className="text-xs font-semibold text-white">
                      {driveTokenValid 
                        ? 'üîì Drive OK' 
                        : driveTokenTimeLeft > 0 
                          ? `‚ö†Ô∏è ${driveTokenTimeLeft}min` 
                          : 'üîí Expirado'}
                    </div>
                  </button>
                  
                  <button
                    onClick={() => saveToDrive()}
                    disabled={driveSyncing || driveTokenTimeLeft === 0}
                    className="bg-white/20 hover:bg-white/30 disabled:bg-white/10 backdrop-blur-sm text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm"
                    title={driveTokenTimeLeft === 0 
                      ? 'Token expirado - Clique no indicador verde/amarelo para renovar' 
                      : 'Sincronizar manualmente com Google Drive'}
                  >
                    <RefreshCw className={`w-4 h-4 ${driveSyncing ? 'animate-spin' : ''}`} />
                    <span className="hidden sm:inline">{driveSyncing ? 'A sincronizar...' : 'Sync Manual'}</span>
                  </button>
                </>
              ) : (
                <button
                  onClick={() => {
                    setActiveTab('definicoes');
                    setBackupExpanded(true); // ‚úÖ ABRIR DROPDOWN AUTOMATICAMENTE
                    // Scroll para sec√ß√£o Google Drive ap√≥s tab mudar
                    setTimeout(() => {
                      const driveSection = document.getElementById('google-drive-section');
                      if (driveSection) {
                        driveSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                      }
                    }, 100);
                  }}
                  className="bg-yellow-500/90 hover:bg-yellow-600 backdrop-blur-sm text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm"
                  title="Conectar Google Drive"
                >
                  <AlertCircle className="w-4 h-4" />
                  <span className="hidden sm:inline">Conectar Drive</span>
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Storage indicator removido - n√£o √© necess√°rio */}

        {/* Main Tabs */}
        <div className={`rounded-lg shadow mb-3 bg-white`}>
          <div className="flex">
            {tabs.map(t => {
              const Icon = t.icon;
              return (
                <button key={t.id} onClick={() => setActiveTab(t.id)}
                  className={`flex items-center gap-2 px-5 py-3 rounded-xl font-semibold transition-all duration-300 text-sm ${
                    activeTab === t.id ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50 scale-105' : 'text-gray-600 hover:bg-white/80'
                  }`}>
                  <Icon size={16} />{t.label}
                </button>
              );
            })}
          </div>
        </div>

        {activeTab === 'dashboard' && (
          <div className="space-y-3">
            {/* Dashboard Sub-tabs */}
            <div className="backdrop-blur-lg bg-white/60 border border-white/40 rounded-xl shadow-lg">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'resumo', label: 'Resumo', icon: BarChart3 },
                  { id: 'metricas', label: 'M√©tricas', icon: Target },
                  { id: 'compras', label: 'Compras', icon: TrendingUp },
                  ...(deliveryApps.some(app => app.ativo) ? [{ id: 'delivery', label: 'Delivery', icon: TrendingUp }] : []),
                  { id: 'simuladores', label: 'Simuladores', icon: Calculator }
                ].map(tab => {
                  const Icon = tab.icon;
                  return (
                    <button key={tab.id} onClick={() => setDashboardSubTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 font-medium text-xs transition ${
                        dashboardSubTab === tab.id ? 'bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'
                      }`}>
                      <Icon size={14} />{tab.label}
                    </button>
                  );
                })}
              </div>
            </div>

            

            {dashboardSubTab === 'resumo' && (
              <>
            {/* Date Filter */}
            <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
              <div className="flex flex-wrap items-center gap-2">
                <span className="text-xs font-semibold text-gray-700">Per√≠odo:</span>
                <button
                  onClick={() => setDateFilter('all')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  Tudo
                </button>
                <button
                  onClick={() => setDateFilter('today')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'today' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  Hoje
                </button>
                <button
                  onClick={() => setDateFilter('week')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  √öltima Semana
                </button>
                <button
                  onClick={() => setDateFilter('month')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  √öltimo M√™s
                </button>
                <button
                  onClick={() => setDateFilter('custom')}
                  className={`px-3 py-1 rounded text-xs font-medium transition ${
                    dateFilter === 'custom' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  Personalizado
                </button>
                
                {dateFilter === 'custom' && (
                  <div className="flex items-center gap-2 ml-2">
                    <input
                      type="date"
                      value={customStartDate}
                      onChange={(e) => setCustomStartDate(e.target.value)}
                      className="border rounded px-2 py-1 text-xs"
                    />
                    <span className="text-xs text-gray-500">at√©</span>
                    <input
                      type="date"
                      value={customEndDate}
                      onChange={(e) => setCustomEndDate(e.target.value)}
                      className="border rounded px-2 py-1 text-xs"
                    />
                  </div>
                )}
                
                {dateFilter !== 'all' && (
                  <span className="text-xs text-gray-500 ml-2">
                    üìä {filteredVendas.length} vendas ‚Ä¢ {todasDespesas.length} despesas
                  </span>
                )}
              </div>
            </div>

            {/* KPI Cards - 2 filas de 2 */}
          
          <div className="grid grid-cols-2 lg:grid-cols-6 gap-2">
              <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg shadow p-3 text-white">
                <Tooltip text="Total de vendas no per√≠odo (COM IVA). Este √© o valor bruto antes de deduzir impostos e custos." position="bottom">
                  <p className="text-green-100 text-xs mb-1 flex items-center gap-1">
                    Fatura√ß√£o Bruta
                    <span className="text-green-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className="text-xl font-bold">‚Ç¨{totV.toFixed(2)}</p>
                <p className="text-green-100 text-xs">‚Ç¨{medFat.toFixed(2)}/dia</p>
              </div>

              <div className="bg-gradient-to-br from-red-500 to-pink-600 rounded-lg shadow p-3 text-white">
                <div className="flex items-center justify-between mb-1">
                  <Tooltip text="Total de todas as despesas: fixas (renda, sal√°rios) + vari√°veis (ingredientes, utilities). Quanto mais baixas, maior o lucro." position="bottom">
                    <p className="text-red-100 text-xs mb-0 flex items-center gap-1">
                      Despesas
                      <span className="text-red-300 text-sm">‚ìò</span>
                    </p>
                  </Tooltip>
                  <div className="flex items-center gap-1">
                    {(() => {
                      const ratioDespesaFaturacao = totV > 0 ? (totD / totV) * 100 : 0;
                      if (ratioDespesaFaturacao >= 40) {
                        return (
                          <Tooltip text="‚ö†Ô∏è ALERTA: As suas despesas representam mais de 40% da fatura√ß√£o. Considere passar para Contabilidade Organizada para recuperar todo o IVA das despesas e otimizar a carga fiscal." position="left">
                            <span className="text-yellow-300 text-lg animate-pulse cursor-help">‚ö†Ô∏è</span>
                          </Tooltip>
                        );
                      }
                      return null;
                    })()}
                    <button
                      onClick={() => setShowDespesasDetails(!showDespesasDetails)}
                      className="text-red-100 hover:text-white hover:bg-red-600 rounded p-1 transition"
                      title={showDespesasDetails ? "Recolher detalhes" : "Ver detalhes"}
                    >
                      {showDespesasDetails ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                    </button>
                  </div>
                </div>
                <p className="text-xl font-bold">‚Ç¨{totD.toFixed(2)}</p>
                <p className="text-red-100 text-xs">Fixas: ‚Ç¨{dFixas.toFixed(2)}</p>
              </div>

              {/* üÜï CARD EXPANS√çVEL DO LUCRO L√çQUIDO */}
              <div 
                className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg shadow p-3 text-white cursor-pointer hover:shadow-xl transition-all"
                onClick={() => setMostrarBreakdownFinanceiro(!mostrarBreakdownFinanceiro)}
              >
                <div className="flex items-start justify-between">
                  <Tooltip text="Clica para ver como √© calculado. Fatura√ß√£o L√≠quida (sem IVA) - Food Cost - Despesas = Lucro Real." position="bottom">
                    <p className="text-blue-100 text-xs mb-1 flex items-center gap-1">
                      Lucro L√≠quido
                      <span className="text-blue-300 text-sm">‚ìò</span>
                    </p>
                  </Tooltip>
                  <div className="text-blue-200">
                    {mostrarBreakdownFinanceiro ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                  </div>
                </div>
                <p className={`text-xl font-bold ${lucroLiquido >= 0 ? '' : 'text-red-200'}`}>
                  ‚Ç¨{lucroLiquido.toFixed(2)}
                </p>
                <p className="text-blue-100 text-xs">
                  {margemLiquida.toFixed(1)}% margem
                </p>
              </div>

              {/* üÜï CARD DE MARGEM BRUTA */}
              <div className="bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg shadow p-3 text-white">
                <Tooltip text="Fatura√ß√£o L√≠quida (sem IVA) - Food Cost = Dinheiro dispon√≠vel antes de pagar despesas operacionais." position="bottom">
                  <p className="text-teal-100 text-xs mb-1 flex items-center gap-1">
                    Margem Bruta
                    <span className="text-teal-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className="text-xl font-bold">
                  ‚Ç¨{margemBruta.toFixed(2)}
                </p>
                <p className="text-teal-100 text-xs">
                  {margemBrutaPercentage.toFixed(1)}% da fatura√ß√£o
                </p>
              </div>

              <div className="bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg shadow p-3 text-white">
                <div className="flex items-center justify-between mb-1">
                  <Tooltip text="IVA a pagar/receber no ano. Calculado como: IVA cobrado nas vendas - IVA pago nas compras. Valor positivo = tens de pagar ao estado." position="bottom">
                    <p className="text-orange-100 text-xs mb-0 flex items-center gap-1">
                      IVA {ivaP >= 0 ? 'Pagar' : 'Receber'} Q{quarter}/{currentYear}
                      <span className="text-orange-300 text-sm">‚ìò</span>
                    </p>
                  </Tooltip>
                  <button
                    onClick={() => setShowIVADetails(!showIVADetails)}
                    className="text-orange-100 hover:text-white hover:bg-orange-600 rounded p-1 transition"
                    title={showIVADetails ? "Recolher detalhes" : "Ver detalhes"}
                  >
                    {showIVADetails ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                  </button>
                </div>
                <p className="text-xl font-bold">‚Ç¨{Math.abs(ivaP).toFixed(2)}</p>
                <p className="text-orange-100 text-xs">{ivaP >= 0 ? 'Entregar' : 'Cr√©dito'}</p>
              </div>
              
              {/* üÜï CARD DE DESPERD√çCIO */}
              <div className={`bg-gradient-to-br rounded-lg shadow p-3 text-white ${
                indiceDesperdicio.desperdicioPercent > 15 ? 'from-red-500 to-red-700' :
                indiceDesperdicio.desperdicioPercent > 10 ? 'from-yellow-500 to-orange-600' :
                'from-purple-500 to-purple-700'
              }`}>
                <Tooltip text="Desperd√≠cio = Total Compras - Custo Real das Vendas. Inclui stock n√£o vendido, desperd√≠cio real, e perdas. Ideal: 5-10%" position="bottom">
                  <p className="text-purple-100 text-xs mb-1 flex items-center gap-1">
                    Desperd√≠cio
                    <span className="text-purple-300 text-sm">‚ìò</span>
                  </p>
                </Tooltip>
                <p className="text-xl font-bold">
                  {indiceDesperdicio.desperdicioPercent.toFixed(1)}%
                </p>
                <p className="text-purple-100 text-xs">
                  {indiceDesperdicio.status === 'alto' ? '‚ö†Ô∏è Alto' : '‚úÖ Normal'}
                </p>
              </div>
            </div>
            
            {/* üí∞ BREAKDOWN FINANCEIRO EXPANS√çVEL */}
            {mostrarBreakdownFinanceiro && (
              <div className="backdrop-blur-lg bg-gradient-to-br from-blue-50/90 to-indigo-50/90 border-2 border-blue-300/50 rounded-2xl shadow-xl p-4 animate-fadeIn">
                <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  üí∞ Como √© Calculado o Lucro Real
                </h3>
                
                <div className="space-y-2 text-xs">
                  <div className="flex items-start gap-2">
                    <span className="text-green-600 font-bold mt-0.5">1.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Fatura√ß√£o Bruta:</span>
                      <span className="text-gray-600"> ‚Ç¨{totV.toFixed(2)} (com IVA)</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2">
                    <span className="text-blue-600 font-bold mt-0.5">2.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Deduzir IVA das vendas:</span>
                      <span className="text-gray-600"> -‚Ç¨{ivaVendasPeriodo.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 border-l-2 border-blue-300">
                    <span className="text-blue-700 font-bold">‚Üí</span>
                    <div>
                      <span className="font-semibold text-blue-700">Fatura√ß√£o L√≠quida (sem IVA):</span>
                      <span className="text-blue-800 font-bold"> ‚Ç¨{faturacaoSemIva.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 mt-3">
                    <span className="text-orange-600 font-bold mt-0.5">3.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Deduzir Food Cost:</span>
                      <span className="text-gray-600"> -‚Ç¨{custoRealVendas.toFixed(2)} ({foodCostPercentage.toFixed(1)}%)</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 border-l-2 border-teal-300">
                    <span className="text-teal-700 font-bold">‚Üí</span>
                    <div>
                      <span className="font-semibold text-teal-700">Margem Bruta:</span>
                      <span className="text-teal-800 font-bold"> ‚Ç¨{margemBruta.toFixed(2)}</span>
                      <span className="text-teal-600 text-xs"> ({margemBrutaPercentage.toFixed(1)}%)</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 mt-3">
                    <span className="text-red-600 font-bold mt-0.5">4.</span>
                    <div>
                      <span className="font-semibold text-gray-700">Deduzir Despesas Operacionais:</span>
                      <span className="text-gray-600"> -‚Ç¨{totD.toFixed(2)}</span>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-2 pl-4 border-l-2 border-green-400 bg-green-50 -mx-2 px-4 py-2 rounded">
                    <span className="text-green-700 font-bold text-base">‚úì</span>
                    <div>
                      <span className="font-bold text-green-800 text-sm">Lucro L√≠quido Real:</span>
                      <span className={`font-bold text-base ml-2 ${lucroLiquido >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                        ‚Ç¨{lucroLiquido.toFixed(2)}
                      </span>
                      <span className="text-green-600 text-xs ml-1">({margemLiquida.toFixed(1)}% margem)</span>
                    </div>
                  </div>
                </div>
                
                <div className="mt-3 pt-3 border-t border-blue-200">
                  <p className="text-xs text-gray-600 flex items-start gap-1">
                    <span className="text-blue-600 font-bold">üí°</span>
                    <span>
                      <span className="font-semibold">Nota:</span> Este √© o dinheiro real que sobra para lucros, impostos sobre lucros (IRC), 
                      e reinvestimento no neg√≥cio. O IVA n√£o √© inclu√≠do aqui porque √© um imposto "neutro" - o que cobras dos clientes 
                      entregas ao estado (deduzindo o IVA que j√° pagaste nas compras).
                    </span>
                  </p>
                </div>
              </div>
            )}
            
            {/* üßæ DETALHES DO IVA EXPANS√çVEL */}
            {showIVADetails && (
              <div className="backdrop-blur-lg bg-gradient-to-br from-orange-50/90 to-amber-50/90 border-2 border-orange-300/50 rounded-2xl shadow-xl p-4 animate-fadeIn">
                <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  üßæ Pr√≥xima Entrega de IVA
                </h3>
                
                <div className="space-y-3">
                  {/* Resumo do Trimestre */}
                  <div className="bg-white rounded-lg p-3 border border-orange-200">
                    <p className="text-xs font-semibold text-gray-700 mb-2">
                      Estimativa do IVA a pagar no pr√≥ximo trimestre (regime trimestral)
                    </p>
                    <div className="space-y-2">
                      <div className="flex justify-between items-center py-1 border-b border-gray-100">
                        <span className="text-xs text-gray-600 font-medium">{quarter}¬∫ Trimestre {currentYear}</span>
                      </div>
                      <div className="flex justify-between items-center py-1">
                        <span className="text-xs text-gray-600">IVA Vendas:</span>
                        <span className="text-sm font-bold text-green-600">‚Ç¨{ivaV.toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between items-center py-1">
                        <span className="text-xs text-gray-600">IVA Dedut√≠vel:</span>
                        <span className="text-sm font-bold text-blue-600">-‚Ç¨{ivaCompras.toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-t-2 border-orange-300 mt-2">
                        <span className="text-sm font-bold text-gray-700">A {ivaP >= 0 ? 'Pagar' : 'Receber'}:</span>
                        <span className={`text-lg font-bold ${ivaP >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                          ‚Ç¨{ivaP >= 0 ? '' : '-'}{Math.abs(ivaP).toFixed(2)}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Prazo de Entrega */}
                  <div className="bg-gradient-to-br from-orange-100 to-amber-100 rounded-lg p-3 border border-orange-300">
                    <p className="text-sm font-bold text-orange-900 mb-2 flex items-center gap-2">
                      üìÖ Prazo de Entrega
                    </p>
                    <div className="space-y-1">
                      <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-700">Data limite:</span>
                        <span className="text-sm font-bold text-orange-800">
                          {(() => {
                            // Calcular prazo baseado no trimestre atual
                            let deadlineMonth, deadlineYear;
                            if (quarter === 1) {
                              deadlineMonth = 4; // 20 de maio (m√™s 4 = maio, 0-indexed)
                              deadlineYear = currentYear;
                            } else if (quarter === 2) {
                              deadlineMonth = 7; // 20 de agosto
                              deadlineYear = currentYear;
                            } else if (quarter === 3) {
                              deadlineMonth = 10; // 20 de novembro
                              deadlineYear = currentYear;
                            } else {
                              deadlineMonth = 1; // 20 de fevereiro do ano seguinte
                              deadlineYear = currentYear + 1;
                            }
                            const prazo = new Date(deadlineYear, deadlineMonth, 20);
                            return prazo.toLocaleDateString('pt-PT', { day: 'numeric', month: 'long', year: 'numeric' });
                          })()}
                        </span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-xs text-gray-700">Tempo restante:</span>
                        <span className="text-sm font-bold text-orange-800">
                          {(() => {
                            const hoje = new Date();
                            let deadlineMonth, deadlineYear;
                            if (quarter === 1) {
                              deadlineMonth = 4;
                              deadlineYear = currentYear;
                            } else if (quarter === 2) {
                              deadlineMonth = 7;
                              deadlineYear = currentYear;
                            } else if (quarter === 3) {
                              deadlineMonth = 10;
                              deadlineYear = currentYear;
                            } else {
                              deadlineMonth = 1;
                              deadlineYear = currentYear + 1;
                            }
                            const prazo = new Date(deadlineYear, deadlineMonth, 20);
                            const diffTime = prazo - hoje;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return diffDays > 0 ? `Faltam ${diffDays} dias` : 'PRAZO EXPIRADO!';
                          })()}
                        </span>
                      </div>
                    </div>
                    <div className="mt-3 pt-3 border-t border-orange-300">
                      <p className="text-xs text-gray-600">
                        <span className="font-semibold">Declara√ß√£o at√© dia 20</span> ‚Ä¢ <span className="font-semibold">Pagamento at√© dia 25</span>
                      </p>
                    </div>
                  </div>
                  
                  {/* Nota Informativa */}
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800 flex items-start gap-1">
                      <span className="text-blue-600 font-bold">üí°</span>
                      <span>
                        <span className="font-semibold">IVA Dedut√≠vel</span> inclui apenas despesas com Faturas (FT) ou Faturas-Recibo (FR): 
                        compras de mercadorias, renda comercial, eletricidade, √°gua, g√°s, internet, consum√≠veis, etc.
                        <br/><br/>
                        <span className="font-semibold text-red-600">‚ö†Ô∏è Importante:</span> Faturas Simplificadas (FS) <span className="font-semibold">N√ÉO</span> d√£o direito √† dedu√ß√£o de IVA.
                        <br/><br/>
                        <span className="font-semibold">Regime Trimestral:</span> Empresas com volume de neg√≥cios inferior a ‚Ç¨650.000 
                        podem optar pelo regime trimestral de IVA, entregando a declara√ß√£o peri√≥dica 4 vezes por ano. 
                        O pagamento deve ser feito at√© ao dia 25 do segundo m√™s seguinte ao trimestre.
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            )}
            
            {/* üìä BREAKDOWN DE DESPESAS EXPANS√çVEL */}
            {showDespesasDetails && (
              <div className="backdrop-blur-lg bg-gradient-to-br from-red-50/90 to-pink-50/90 border-2 border-red-300/50 rounded-2xl shadow-xl p-4 animate-fadeIn">
                <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                  üìä Breakdown de Despesas
                </h3>
                
                {(() => {
                  // Agrupar despesas por categoria
                  const despesasPorCategoria = {};
                  
                  todasDespesas.forEach(d => {
                    const cat = d.categoria || 'outros';
                    if (!despesasPorCategoria[cat]) {
                      despesasPorCategoria[cat] = {
                        total: 0,
                        itens: 0
                      };
                    }
                    despesasPorCategoria[cat].total += d.valor;
                    despesasPorCategoria[cat].itens += 1;
                  });
                  
                  // Ordenar por valor (maior primeiro)
                  const categoriasOrdenadas = Object.entries(despesasPorCategoria)
                    .sort(([, a], [, b]) => b.total - a.total);
                  
                  const totalGeral = todasDespesas.reduce((s, d) => s + d.valor, 0);
                  
                  // Labels em portugu√™s
                  const labelsCategorias = {
                    'compras': 'üõí Compras',
                    'renda': 'üè† Renda',
                    'salarios': 'üë• Sal√°rios',
                    'eletricidade': '‚ö° Eletricidade',
                    'agua': 'üíß √Ågua',
                    'gas': 'üî• G√°s',
                    'internet': 'üåê Internet',
                    'consumiveis': 'üì¶ Consum√≠veis',
                    'marketing': 'üì¢ Marketing',
                    'manutencao': 'üîß Manuten√ß√£o',
                    'outros': 'üìã Outros'
                  };
                  
                  // Cores por categoria
                  const coresCategorias = {
                    'compras': 'bg-blue-600',
                    'renda': 'bg-purple-600',
                    'salarios': 'bg-green-600',
                    'eletricidade': 'bg-yellow-500',
                    'agua': 'bg-cyan-500',
                    'gas': 'bg-orange-500',
                    'internet': 'bg-indigo-500',
                    'consumiveis': 'bg-pink-500',
                    'marketing': 'bg-red-500',
                    'manutencao': 'bg-gray-600',
                    'outros': 'bg-gray-400'
                  };
                  
                  return (
                    <div className="space-y-3">
                      <div className="space-y-3 bg-white rounded-lg p-3 border border-red-200">
                        {categoriasOrdenadas.map(([categoria, dados]) => {
                          const percentagem = totalGeral > 0 ? (dados.total / totalGeral) * 100 : 0;
                          
                          return (
                            <div key={categoria} className="flex items-center gap-3">
                              <div className="flex-1">
                                <div className="flex justify-between items-center mb-1">
                                  <span className="text-sm font-medium">
                                    {labelsCategorias[categoria] || categoria}
                                  </span>
                                  <span className="text-sm font-bold">
                                    ‚Ç¨{dados.total.toFixed(2)}
                                  </span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                  <div 
                                    className={`${coresCategorias[categoria] || 'bg-gray-400'} h-2.5 rounded-full transition-all`}
                                    style={{ width: `${Math.min(percentagem, 100)}%` }}
                                  ></div>
                                </div>
                                <div className="flex justify-between mt-1">
                                  <span className="text-xs text-gray-500">
                                    {dados.itens} {dados.itens === 1 ? 'item' : 'itens'}
                                  </span>
                                  <span className="text-xs text-gray-500">
                                    {percentagem.toFixed(1)}%
                                  </span>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                        
                        <div className="pt-3 border-t border-gray-200">
                          <div className="flex justify-between items-center">
                            <span className="font-bold text-gray-800">Total Despesas</span>
                            <span className="font-bold text-lg text-red-600">‚Ç¨{totalGeral.toFixed(2)}</span>
                          </div>
                          {dateFilter !== 'all' && dias > 0 && (
                            <div className="text-xs text-gray-500 mt-1">
                              M√©dia di√°ria: ‚Ç¨{(totalGeral / dias).toFixed(2)}/dia
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Nota Informativa */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p className="text-xs text-blue-800 flex items-start gap-1">
                          <span className="text-blue-600 font-bold">üí°</span>
                          <span>
                            <span className="font-semibold">Gest√£o de Despesas:</span> Controlar despesas fixas (renda, sal√°rios) 
                            e vari√°veis (ingredientes, utilities) √© essencial para aumentar a rentabilidade. As despesas fixas 
                            devem representar no m√°ximo 30-40% da fatura√ß√£o para um neg√≥cio saud√°vel.
                          </span>
                        </p>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}
            
            
            {/* üÜï AN√ÅLISE DE DESPERD√çCIO - REMOVIDA */}
                
            {/* Todos os produtos e an√°lises em colunas lado a lado */}
            <div className="grid grid-cols-5 gap-2 overflow-x-auto">
              {/* IVA Limit */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-xs font-bold">Limite IVA {anoAtual}</h3>
                  <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${
                    totalVendasAnoAtual >= 15000 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'
                  }`}>
                    {((totalVendasAnoAtual / 15000) * 100).toFixed(0)}%
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 mb-2">
                  <div className={`h-2 rounded-full ${totalVendasAnoAtual >= 15000 ? 'bg-red-500' : 'bg-blue-500'}`} 
                    style={{ width: `${Math.min((totalVendasAnoAtual / 15000) * 100, 100)}%` }}></div>
                </div>
                <p className="text-xs text-gray-600 mb-1">‚Ç¨{totalVendasAnoAtual.toFixed(0)}</p>
                <p className="text-xs text-gray-500">de ‚Ç¨15.000</p>
              </div>

              {/* Top Vendidos */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-blue-600">üèÜ Top Vendidos</h3>
                <div className="space-y-1">
                  {top5Venda.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-blue-600 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-green-600 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {top5Venda.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>
              
              {/* Top Rent√°veis */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-green-600">üíé Top Rent√°veis</h3>
                <div className="space-y-1">
                  {top5Lucro.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-green-600 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-green-700 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {top5Lucro.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>

              {/* Pior Vendidos */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-red-600">üìâ Pior Vendidos</h3>
                <div className="space-y-1">
                  {pior5Venda.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-red-400 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-red-600 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {pior5Venda.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>

              {/* Pior Rent√°veis */}
              <div className="bg-white rounded-lg shadow p-3 min-w-[180px]">
                <h3 className="font-bold mb-2 text-xs text-orange-600">‚ö†Ô∏è Pior Rent√°veis</h3>
                <div className="space-y-1">
                  {pior5Lucro.slice(0, 5).map(([n, d], i) => (
                    <div key={n} className="flex items-center gap-1 text-xs">
                      <span className="font-bold text-orange-400 w-4">#{i+1}</span>
                      <span className="flex-1 truncate text-gray-700">{n}</span>
                      <span className="text-orange-700 font-semibold text-xs">‚Ç¨{d.lucro.toFixed(0)}</span>
                    </div>
                  ))}
                  {pior5Lucro.length === 0 && <p className="text-center text-gray-400 py-2 text-xs">Sem vendas</p>}
                </div>
              </div>
            </div>

            {/* An√°lise Financeira - REMOVIDA (alerta movido para card de Despesas) */}


              </>
            )}


            {dashboardSubTab === 'metricas' && (
              <>
              {/* Date Filter */}
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <div className="flex flex-wrap items-center gap-2">
                  <span className="text-xs font-semibold text-gray-700">Per√≠odo:</span>
                  <button
                    onClick={() => setDateFilter('all')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Tudo
                  </button>
                  <button
                    onClick={() => setDateFilter('today')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'today' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Hoje
                  </button>
                  <button
                    onClick={() => setDateFilter('week')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    √öltima Semana
                  </button>
                  <button
                    onClick={() => setDateFilter('month')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    √öltimo M√™s
                  </button>
                  <button
                    onClick={() => setDateFilter('custom')}
                    className={`px-3 py-1 rounded text-xs font-medium transition ${
                      dateFilter === 'custom' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    Personalizado
                  </button>
                  
                  {dateFilter === 'custom' && (
                    <div className="flex items-center gap-2 ml-2">
                      <input
                        type="date"
                        value={customStartDate}
                        onChange={(e) => setCustomStartDate(e.target.value)}
                        className="border rounded px-2 py-1 text-xs"
                      />
                      <span className="text-xs text-gray-500">at√©</span>
                      <input
                        type="date"
                        value={customEndDate}
                        onChange={(e) => setCustomEndDate(e.target.value)}
                        className="border rounded px-2 py-1 text-xs"
                      />
                    </div>
                  )}
                  
                  {dateFilter !== 'all' && (
                    <span className="text-xs text-gray-500 ml-2">
                      ({filteredVendas.length} vendas ‚Ä¢ ‚Ç¨{totV.toFixed(2)})
                    </span>
                  )}
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 1: KPIs PRINCIPAIS */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üìä KPIs Principais
                </h2>
                <p className="text-xs text-gray-600 mb-3">Indicadores chave de performance do restaurante</p>
                
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                  {/* Ticket M√©dio */}
                  <div className="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                    <Tooltip text="Valor m√©dio que cada cliente gasta por transa√ß√£o. Calculado como: Fatura√ß√£o Total √∑ N√∫mero de Vendas. Um ticket m√©dio mais alto significa melhor rentabilidade por cliente." position="bottom">
                      <p className="text-xs text-blue-700 mb-1 font-semibold flex items-center gap-1">
                        üí∂ Ticket M√©dio
                        <span className="text-blue-400 text-sm">‚ìò</span>
                      </p>
                    </Tooltip>
                    <p className="text-2xl font-bold text-blue-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (totV / filteredVendas.length).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-blue-600 mt-1">Por venda</p>
                  </div>
                  
                  {/* Food Cost % */}
                  <div className="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                    <Tooltip text="Percentagem da receita gasta em ingredientes (M√âTODO CORRIGIDO). Calculado como: (Custo Real das Vendas √∑ Fatura√ß√£o) √ó 100, onde Custo Real = soma do custoReceita de cada produto vendido. Este √© o m√©todo correto que considera apenas os ingredientes USADOS nas vendas (n√£o inclui stock nem desperd√≠cio). Ideal: 25-35%." position="bottom">
                      <p className="text-xs text-purple-700 mb-1 font-semibold flex items-center gap-1">
                        üçΩÔ∏è Food Cost % ‚úì
                        <span className="text-purple-400 text-sm">‚ìò</span>
                      </p>
                    </Tooltip>
                    <p className={`text-2xl font-bold ${
                      foodCostPercentage > 100 ? 'text-red-700 animate-pulse' :
                      foodCostPercentage > 40 ? 'text-red-700' :
                      foodCostPercentage > 35 ? 'text-orange-700' : 'text-purple-900'
                    }`}>
                      {foodCostPercentage > 100 ? '‚ö†Ô∏è ERRO' : `${foodCostPercentage.toFixed(1)}%`}
                    </p>
                    {foodCostPercentage > 100 && (
                      <p className="text-xs text-red-600 mt-1 font-bold">
                        Dados inv√°lidos! Abra Console (F12)
                      </p>
                    )}
                    {foodCostPercentage <= 100 && (
                      <p className="text-xs text-purple-600 mt-1">Ideal: 25-35%</p>
                    )}
                  </div>
                  
                  {/* Labor Cost % */}
                  <div className="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                    <Tooltip text="Percentagem da receita gasta em sal√°rios e encargos sociais. Calculado como: (Despesas com Pessoal √∑ Fatura√ß√£o) √ó 100. O ideal √© entre 25-30%. Acima de 35% indica excesso de pessoal ou baixa produtividade." position="bottom">
                      <p className="text-xs text-orange-700 mb-1 font-semibold flex items-center gap-1">
                        üë• Labor Cost %
                        <span className="text-orange-400 text-sm">‚ìò</span>
                      </p>
                    </Tooltip>
                    <p className={`text-2xl font-bold ${
                      laborCostPercentage > 35 ? 'text-red-700' : 
                      laborCostPercentage > 30 ? 'text-orange-700' : 'text-orange-900'
                    }`}>
                      {laborCostPercentage.toFixed(1)}%
                    </p>
                    <p className="text-xs text-orange-600 mt-1">Ideal: 25-30%</p>
                  </div>
                  
                  {/* Prime Cost % - THE KING */}
                  <div className="bg-gradient-to-br from-red-50 to-pink-50 rounded-lg p-4 border-l-4 border-red-500">
                    <Tooltip text="O indicador MAIS IMPORTANTE! Soma do Food Cost + Labor Cost. √â a percentagem da receita gasta nos dois maiores custos operacionais. Ideal: 55-60%. Se >65% = problemas graves. Se <55% = gest√£o excelente! Este √© o KPI que determina o sucesso ou fracasso do neg√≥cio." position="bottom">
                      <p className="text-xs text-red-700 mb-1 font-bold flex items-center gap-1">
                        ‚ö° Prime Cost %
                        <span className="text-red-400 text-sm">‚ìò</span>
                        <span className="text-[10px] bg-red-200 px-1 rounded">REI</span>
                      </p>
                    </Tooltip>
                    <p className={`text-2xl font-bold ${
                      primeCostPercentage > 65 ? 'text-red-700' :
                      primeCostPercentage > 60 ? 'text-orange-700' : 'text-green-700'
                    }`}>
                      {primeCostPercentage.toFixed(1)}%
                    </p>
                    <p className="text-xs text-red-600 mt-1">Ideal: 55-60%</p>
                  </div>
                </div>
                
                {/* Prime Cost Explanation - REMOVIDO */}
              </div>

              {/* ============================================ */}
              {/* SECTION 2: BREAK-EVEN DETALHADO (DROPDOWN) */}
              {/* ============================================ */}
              {showBreakEvenDetails && (
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üí∞ Break-Even & Custos Operacionais Detalhados
                  <button
                    onClick={() => setShowBreakEvenDetails(false)}
                    className="ml-auto text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded p-1 transition"
                    title="Recolher"
                  >
                    <X size={20} />
                  </button>
                </h2>
                
                {/* NOVO: Resumo de Custos Mensais */}
                <div className="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-lg p-4 mb-4">
                  <h3 className="text-sm font-bold text-purple-900 mb-3 flex items-center gap-2">
                    üìã Resumo de Custos do Per√≠odo
                  </h3>
                  
                  <div className="grid grid-cols-2 gap-3 mb-3">
                    <div className="bg-white rounded-lg p-3 border border-purple-200">
                      <p className="text-xs text-gray-600 mb-1">Custos Fixos</p>
                      <p className="text-lg font-bold text-purple-900">‚Ç¨{fixedCosts.toFixed(2)}</p>
                      <p className="text-xs text-gray-500">Renda, sal√°rios, utilities</p>
                    </div>
                    
                    <div className="bg-white rounded-lg p-3 border border-purple-200">
                      <p className="text-xs text-gray-600 mb-1">Custos Vari√°veis</p>
                      <p className="text-lg font-bold text-purple-900">‚Ç¨{variableCosts.toFixed(2)}</p>
                      <p className="text-xs text-gray-500">Compras, consum√≠veis</p>
                    </div>
                    
                    <div className="bg-white rounded-lg p-3 border border-orange-200">
                      <p className="text-xs text-gray-600 mb-1">Food Cost Real</p>
                      <p className="text-lg font-bold text-orange-900">‚Ç¨{custoRealVendas.toFixed(2)}</p>
                      <p className="text-xs text-gray-500">Ingredientes vendidos</p>
                    </div>
                    
                    <div className="bg-white rounded-lg p-3 border border-red-200">
                      <p className="text-xs text-gray-600 mb-1">Food Cost + Desperd√≠cio</p>
                      <p className="text-lg font-bold text-red-900">‚Ç¨{foodCostComDesperdicio.toFixed(2)}</p>
                      <p className="text-xs text-gray-500">+8% desperd√≠cio</p>
                    </div>
                  </div>
                  
                  <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-3 border-2 border-purple-400">
                    <div className="flex justify-between items-center">
                      <span className="text-sm font-bold text-purple-900">üí∞ CUSTO TOTAL DO PER√çODO:</span>
                      <span className="text-2xl font-bold text-purple-900">‚Ç¨{custoTotalPeriodo.toFixed(2)}</span>
                    </div>
                    <p className="text-xs text-purple-700 mt-1">
                      = Fixos (‚Ç¨{fixedCosts.toFixed(2)}) + Vari√°veis (‚Ç¨{variableCosts.toFixed(2)}) + Food Cost (‚Ç¨{foodCostComDesperdicio.toFixed(2)})
                    </p>
                  </div>
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
                  {/* Break-Even Di√°rio COMPLETO */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-400">
                    <p className="text-xs text-green-700 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="Quanto precisas faturar POR DIA (26 dias √∫teis) para cobrir TODOS os custos operacionais: fixos, vari√°veis, food cost e desperd√≠cio. Este √© o valor m√≠nimo para n√£o ter preju√≠zo." position="bottom">
                        <span className="flex items-center gap-1">
                          üéØ Break-Even Di√°rio Completo
                          <span className="text-green-500 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    
                    <div className="bg-white rounded-lg p-3 border-2 border-green-300 mb-3">
                      <p className="text-xs text-gray-600 mb-1">Fatura√ß√£o Necess√°ria por Dia</p>
                      <p className="text-3xl font-bold text-green-900">
                        ‚Ç¨{faturacaoNecessariaDiaria.toFixed(2)}
                      </p>
                      <p className="text-xs text-green-700 mt-1">Para cobrir todos os custos</p>
                    </div>
                    
                    <div className="space-y-2 text-xs">
                      <div className="bg-white rounded p-2 border border-green-200">
                        <div className="flex justify-between mb-1">
                          <span className="text-gray-700 font-semibold">üìä Breakdown Di√°rio ({diasUteis} dias):</span>
                        </div>
                        <div className="space-y-1">
                          <div className="flex justify-between">
                            <span className="text-gray-600">‚Ä¢ Custos Fixos/dia:</span>
                            <span className="font-semibold text-purple-700">‚Ç¨{fixedCostsDiarios.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-600">‚Ä¢ Custos Vari√°veis/dia:</span>
                            <span className="font-semibold text-orange-700">‚Ç¨{variableCostsDiarios.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-600">‚Ä¢ Food Cost/dia:</span>
                            <span className="font-semibold text-red-700">‚Ç¨{foodCostDiario.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between border-t border-gray-300 pt-1 mt-1">
                            <span className="text-gray-700 font-bold">= Custo Total/dia:</span>
                            <span className="font-bold text-green-900">‚Ç¨{custoTotalDiario.toFixed(2)}</span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-green-100 border-2 border-green-400 rounded p-2">
                        <div className="flex justify-between items-center">
                          <span className="font-bold text-green-900">Status Atual:</span>
                          <span className={`font-bold text-lg ${
                            medFat >= faturacaoNecessariaDiaria * 1.2 ? 'text-green-600' : 
                            medFat >= faturacaoNecessariaDiaria ? 'text-yellow-600' : 'text-red-600'
                          }`}>
                            {medFat >= faturacaoNecessariaDiaria * 1.2 ? '‚úÖ Excelente' : 
                             medFat >= faturacaoNecessariaDiaria ? '‚ö†Ô∏è No limite' : 'üö® Abaixo'}
                          </span>
                        </div>
                        <div className="flex justify-between mt-1 text-xs">
                          <span className="text-green-700">Fatura√ß√£o m√©dia/dia:</span>
                          <span className="font-bold text-green-900">‚Ç¨{medFat.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between text-xs">
                          <span className="text-green-700">Diferen√ßa:</span>
                          <span className={`font-bold ${
                            medFat >= faturacaoNecessariaDiaria ? 'text-green-600' : 'text-red-600'
                          }`}>
                            {medFat >= faturacaoNecessariaDiaria ? '+' : ''}‚Ç¨{(medFat - faturacaoNecessariaDiaria).toFixed(2)}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Vendas Necess√°rias */}
                  <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-4 border-2 border-blue-300">
                    <p className="text-xs text-blue-700 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="Quantas vendas precisas fazer por dia para atingir o break-even. Baseado no ticket m√©dio atual e na margem de contribui√ß√£o por venda." position="bottom">
                        <span className="flex items-center gap-1">
                          üé´ Vendas Necess√°rias por Dia
                          <span className="text-blue-400 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    
                    <div className="bg-white rounded-lg p-3 border-2 border-blue-300 mb-3">
                      <p className="text-xs text-gray-600 mb-1">N√∫mero de Vendas/Dia</p>
                      <p className="text-3xl font-bold text-blue-900">
                        {Math.ceil(vendasNecessariasPorDia)}
                      </p>
                      <p className="text-xs text-blue-700 mt-1">Vendas para break-even</p>
                    </div>
                    
                    <div className="space-y-2 text-xs">
                      <div className="bg-white rounded p-2 border border-blue-200">
                        <div className="flex justify-between mb-1">
                          <span className="text-gray-700 font-semibold">üìä An√°lise por Venda:</span>
                        </div>
                        <div className="space-y-1">
                          <div className="flex justify-between">
                            <span className="text-gray-600">‚Ä¢ Ticket M√©dio:</span>
                            <span className="font-semibold text-blue-700">‚Ç¨{ticketMedio.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-600">‚Ä¢ Food Cost/venda:</span>
                            <span className="font-semibold text-orange-700">‚Ç¨{foodCostPorVenda.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between border-t border-gray-300 pt-1 mt-1">
                            <span className="text-gray-700 font-bold">= Margem/venda:</span>
                            <span className="font-bold text-green-700">‚Ç¨{margemPorVenda.toFixed(2)}</span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-blue-100 border-2 border-blue-400 rounded p-2">
                        <div className="flex justify-between text-xs">
                          <span className="text-blue-700">Fatura√ß√£o prevista:</span>
                          <span className="font-bold text-blue-900">‚Ç¨{(vendasNecessariasPorDia * ticketMedio).toFixed(2)}/dia</span>
                        </div>
                        <div className="flex justify-between text-xs mt-1">
                          <span className="text-blue-700">Cobertura custos:</span>
                          <span className="font-bold text-blue-900">
                            {custoTotalDiario > 0 ? ((vendasNecessariasPorDia * ticketMedio / custoTotalDiario) * 100).toFixed(0) : 0}%
                          </span>
                        </div>
                      </div>
                      
                      <div className="bg-gradient-to-r from-blue-100 to-cyan-100 rounded p-2 border border-blue-300">
                        <p className="text-xs text-blue-800 font-semibold">
                          üí° Para ter margem de seguran√ßa de 20%, precisas de:
                        </p>
                        <p className="text-lg font-bold text-blue-900 mt-1">
                          {Math.ceil(vendasNecessariasPorDia * 1.2)} vendas/dia
                        </p>
                        <p className="text-xs text-blue-700">
                          = ‚Ç¨{(vendasNecessariasPorDia * 1.2 * ticketMedio).toFixed(2)}/dia
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              )}
              {/* FIM DO DROPDOWN DE BREAK-EVEN DETALHADO */}

              {/* Manter as outras se√ß√µes existentes... */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üë• Efici√™ncia Operacional
                </h2>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
                  {/* Break-Even Point COM BOT√ÉO DE EXPANDIR */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-300">
                    <div className="flex items-center justify-between mb-2">
                      <p className="text-xs text-green-700 font-bold flex items-center gap-1">
                        <Tooltip text="O Break-Even √© o valor m√≠nimo que precisas de faturar para cobrir todos os custos fixos (renda, sal√°rios, utilities) e vari√°veis (ingredientes). Abaixo deste valor, est√°s a ter preju√≠zo." position="bottom">
                          <span className="flex items-center gap-1">
                            üéØ Break-Even Point
                            <span className="text-green-500 text-base">‚ìò</span>
                          </span>
                        </Tooltip>
                      </p>
                      <button
                        onClick={() => setShowBreakEvenDetails(!showBreakEvenDetails)}
                        className="text-green-700 hover:text-green-900 hover:bg-green-200 rounded p-1 transition"
                        title={showBreakEvenDetails ? "Recolher detalhes" : "Ver detalhes completos"}
                      >
                        {showBreakEvenDetails ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                      </button>
                    </div>
                    
                    <p className="text-3xl font-bold text-green-900 mb-1">
                      {breakEvenPoint > 0 ? `‚Ç¨${breakEvenPoint.toFixed(0)}` : 'N/A'}
                    </p>
                    <p className="text-xs text-green-700 mb-2">
                      {breakEvenPoint > 0 ? 'Mensal - Fatura√ß√£o necess√°ria' : 'Adicione despesas fixas'}
                    </p>
                    
                    <div className="bg-white rounded p-2 text-xs space-y-1 mb-2">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Fatura√ß√£o atual:</span>
                        <span className="font-semibold">‚Ç¨{totV.toFixed(2)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Margem seguran√ßa:</span>
                        <span className={`font-bold ${
                          totV >= breakEvenPoint ? 'text-green-600' : 'text-red-600'
                        }`}>
                          ‚Ç¨{(totV - breakEvenPoint).toFixed(2)}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Status:</span>
                        <span className={`font-bold ${
                          totV >= breakEvenPoint * 1.2 ? 'text-green-600' : 
                          totV >= breakEvenPoint ? 'text-yellow-600' : 'text-red-600'
                        }`}>
                          {totV >= breakEvenPoint * 1.2 ? '‚úÖ Excelente' : 
                           totV >= breakEvenPoint ? '‚ö†Ô∏è No limite' : 'üö® Abaixo'}
                        </span>
                      </div>
                    </div>
                    
                    {/* Break-Even Di√°rio Resumido */}
                    <div className="bg-green-100 border border-green-300 rounded p-2 text-xs">
                      <p className="font-bold text-green-900 mb-1">üìÖ Break-Even Di√°rio ({diasUteis} dias):</p>
                      <div className="space-y-0.5">
                        <div className="flex justify-between">
                          <span className="text-green-700">Fatura√ß√£o/dia:</span>
                          <span className="font-bold text-green-900">‚Ç¨{faturacaoNecessariaDiaria.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-green-700">Vendas necess√°rias:</span>
                          <span className="font-bold text-green-900">{Math.ceil(vendasNecessariasPorDia)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-green-700">Margem/venda:</span>
                          <span className="font-bold text-green-900">‚Ç¨{margemPorVenda.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Bot√£o Ver Detalhes */}
                    <button
                      onClick={() => setShowBreakEvenDetails(!showBreakEvenDetails)}
                      className="w-full mt-2 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold py-2 px-3 rounded transition flex items-center justify-center gap-2"
                    >
                      {showBreakEvenDetails ? '‚ñ≤ Recolher Detalhes' : '‚ñº Ver Detalhes Completos'}
                    </button>
                  </div>
                  
                  {/* Efficiency per Employee */}
                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-300">
                    <p className="text-xs text-blue-700 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="Mostra quanto cada colaborador gera de receita em m√©dia. Um valor alto indica boa produtividade. Benchmark: ‚Ç¨2000-3000/m√™s por pessoa em caf√©s/restaurantes." position="bottom">
                        <span className="flex items-center gap-1">
                          üë§ Efici√™ncia por Colaborador
                          <span className="text-blue-400 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    <p className="text-3xl font-bold text-blue-900 mb-1">
                      ‚Ç¨{revenuePerEmployee.toFixed(0)}
                    </p>
                    <p className="text-xs text-blue-700 mb-2">Fatura√ß√£o por colaborador</p>
                    
                    <div className="bg-white rounded p-2 text-xs space-y-1">
                      <div className="flex justify-between">
                        <span className="text-gray-600">N¬∫ Colaboradores:</span>
                        <span className="font-semibold">{numEmployees}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Vendas/Pessoa:</span>
                        <span className="font-semibold">{salesPerEmployee.toFixed(1)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Custo/Pessoa:</span>
                        <span className="font-semibold">
                          ‚Ç¨{numEmployees > 0 ? (totalSalarios / numEmployees).toFixed(0) : '0'}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Salary Calculator */}
                  <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-400">
                    <p className="text-xs text-yellow-800 mb-2 font-bold flex items-center gap-1">
                      <Tooltip text="Calcula quantos colaboradores podes contratar com o lucro dispon√≠vel. Inclui sal√°rio base + subs√≠dio f√©rias + subs√≠dio natal + TSU (23.75%). Baseado nos escal√µes legais portugueses." position="bottom">
                        <span className="flex items-center gap-1">
                          üí∞ Calculadora de Ordenados
                          <span className="text-yellow-600 text-base">‚ìò</span>
                        </span>
                      </Tooltip>
                    </p>
                    {(() => {
                      // Calcular lucro dispon√≠vel
                      const lucroDisponivel = lucroReal - fixedCosts;
                      
                      // Fun√ß√£o para calcular custo real de um ordenado
                      const calcularCustoOrdenado = (salarioBase) => {
                        const salarioComSubsidios = salarioBase + salarioBase / 12 * 2; // +F√©rias +Natal
                        return salarioComSubsidios * 1.2375; // +TSU 23.75%
                      };
                      
                      // Escal√µes
                      const partTime = 460;
                      const ordenadoMinimo = 920;
                      
                      const custoPartTime = calcularCustoOrdenado(partTime);
                      const custoMinimo = calcularCustoOrdenado(ordenadoMinimo);
                      
                      // Gerar sugest√µes
                      const sugestoes = [];
                      
                      // Op√ß√£o 1: M√°ximo de part-times
                      const maxPartTimes = Math.floor(lucroDisponivel / custoPartTime);
                      if (maxPartTimes > 0) {
                        sugestoes.push({
                          tipo: `${maxPartTimes}√ó Part-time`,
                          detalhes: `${maxPartTimes}√ó ‚Ç¨${partTime}`,
                          custo: maxPartTimes * custoPartTime,
                          sobra: lucroDisponivel - (maxPartTimes * custoPartTime)
                        });
                      }
                      
                      // Op√ß√£o 2: Mix ordenado m√≠nimo + part-times
                      const maxMinimos = Math.floor(lucroDisponivel / custoMinimo);
                      if (maxMinimos > 0) {
                        const sobraAposMinimos = lucroDisponivel - (maxMinimos * custoMinimo);
                        const partTimesExtras = Math.floor(sobraAposMinimos / custoPartTime);
                        
                        if (partTimesExtras > 0) {
                          sugestoes.push({
                            tipo: `${maxMinimos}√ó M√≠nimo + ${partTimesExtras}√ó Part-time`,
                            detalhes: `${maxMinimos}√ó ‚Ç¨${ordenadoMinimo} + ${partTimesExtras}√ó ‚Ç¨${partTime}`,
                            custo: (maxMinimos * custoMinimo) + (partTimesExtras * custoPartTime),
                            sobra: lucroDisponivel - ((maxMinimos * custoMinimo) + (partTimesExtras * custoPartTime))
                          });
                        } else {
                          sugestoes.push({
                            tipo: `${maxMinimos}√ó Ordenado M√≠nimo`,
                            detalhes: `${maxMinimos}√ó ‚Ç¨${ordenadoMinimo}`,
                            custo: maxMinimos * custoMinimo,
                            sobra: lucroDisponivel - (maxMinimos * custoMinimo)
                          });
                        }
                      }
                      
                      // Op√ß√£o 3: Pr√≥ximo escal√£o (imposs√≠vel)
                      const proximoEscalao = maxMinimos + 1;
                      const custoProximoEscalao = proximoEscalao * custoMinimo;
                      const faltam = custoProximoEscalao - lucroDisponivel;
                      
                      return (
                        <>
                          <p className="text-lg font-bold text-yellow-900 mb-2">
                            Dispon√≠vel: ‚Ç¨{lucroDisponivel.toFixed(0)}
                          </p>
                          <p className="text-xs text-yellow-700 mb-3">
                            Lucro - Custos Fixos = {lucroReal.toFixed(0)} - {fixedCosts.toFixed(0)}
                          </p>
                          
                          <div className="bg-white rounded p-2 text-xs space-y-2">
                            {sugestoes.slice(0, 2).map((s, i) => (
                              <div key={i} className="pb-2 border-b border-yellow-200 last:border-0">
                                <p className="font-bold text-green-700 mb-1">‚úÖ {s.tipo}</p>
                                <div className="flex justify-between text-gray-600">
                                  <span>{s.detalhes}</span>
                                  <span className="font-semibold">‚Ç¨{s.custo.toFixed(0)}</span>
                                </div>
                                <p className="text-green-600 text-[10px] mt-0.5">Sobra: ‚Ç¨{s.sobra.toFixed(0)}</p>
                              </div>
                            ))}
                            
                            {faltam > 0 && (
                              <div className="pt-1">
                                <p className="font-bold text-red-700 mb-1">‚ùå {proximoEscalao}√ó Ordenado M√≠nimo</p>
                                <p className="text-red-600 text-[10px]">Faltam: ‚Ç¨{faltam.toFixed(0)}</p>
                              </div>
                            )}
                          </div>
                          
                          <p className="text-[10px] text-yellow-700 mt-2">
                            üí° Custo inclui: sal√°rio + f√©rias + natal + TSU (23.75%)
                          </p>
                        </>
                      );
                    })()}
                  </div>
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 3: M√âDIA DI√ÅRIA - REMOVIDA */}
              {/* ============================================ */}

              {/* ============================================ */}
              {/* SECTION: AN√ÅLISE MENSAL COMPARATIVA */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  üìÖ An√°lise Mensal Comparativa
                </h2>
                
                {(() => {
                  const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                  ];
                  
                  // Fun√ß√£o para calcular m√©tricas de um m√™s
                  const calcularMetricasMes = (mes, ano) => {
                    const vendasMes = vendas.filter(v => {
                      const d = new Date(v.data);
                      return d.getMonth() === mes && d.getFullYear() === ano;
                    });
                    
                    const despesasMes = despesas.filter(d => {
                      const data = new Date(d.data);
                      return data.getMonth() === mes && data.getFullYear() === ano;
                    });
                    
                    const faturacao = vendasMes.reduce((s, v) => s + v.valor, 0);
                    const custosDespesas = despesasMes.reduce((s, d) => s + d.valor, 0);
                    const lucroVendas = vendasMes.reduce((s, v) => s + calcLucroVenda(v).lucro, 0);
                    const lucroTotal = lucroVendas - custosDespesas;
                    
                    // Produto mais vendido
                    const produtosPorQtd = {};
                    vendasMes.forEach(v => {
                      produtosPorQtd[v.produto] = (produtosPorQtd[v.produto] || 0) + v.quantidade;
                    });
                    
                    const entries = Object.entries(produtosPorQtd);
                    const maisVendido = entries.length > 0 
                      ? entries.sort((a, b) => b[1] - a[1])[0]
                      : null;
                    const menosVendido = entries.length > 0
                      ? entries.sort((a, b) => a[1] - b[1])[0]
                      : null;
                    
                    return {
                      faturacao,
                      lucroTotal,
                      totalVendas: vendasMes.length,
                      totalQuantidade: vendasMes.reduce((s, v) => s + v.quantidade, 0),
                      maisVendido: maisVendido ? { nome: maisVendido[0], qtd: maisVendido[1] } : null,
                      menosVendido: menosVendido ? { nome: menosVendido[0], qtd: menosVendido[1] } : null
                    };
                  };
                  
                  const mesAtual = calcularMetricasMes(mesSelecionado, anoSelecionado);
                  
                  // M√™s anterior
                  const mesAnteriorNum = mesSelecionado === 0 ? 11 : mesSelecionado - 1;
                  const anoAnteriorNum = mesSelecionado === 0 ? anoSelecionado - 1 : anoSelecionado;
                  const mesAnterior = calcularMetricasMes(mesAnteriorNum, anoAnteriorNum);
                  
                  // C√°lculo de varia√ß√µes
                  const variacaoFaturacao = mesAnterior.faturacao > 0 
                    ? ((mesAtual.faturacao - mesAnterior.faturacao) / mesAnterior.faturacao) * 100 
                    : 0;
                  const variacaoLucro = mesAnterior.lucroTotal > 0
                    ? ((mesAtual.lucroTotal - mesAnterior.lucroTotal) / mesAnterior.lucroTotal) * 100
                    : 0;
                  const variacaoVendas = mesAnterior.totalVendas > 0
                    ? ((mesAtual.totalVendas - mesAnterior.totalVendas) / mesAnterior.totalVendas) * 100
                    : 0;
                  
                  // Verificar se restaurante estava aberto no ano anterior
                  const dataAbertura = new Date('2025-08-01'); // Agosto 2025
                  const mesAnoAnterior = new Date(anoSelecionado - 1, mesSelecionado);
                  const temDadosAnoAnterior = mesAnoAnterior >= dataAbertura;
                  
                  return (
                    <div>
                      {/* Seletor de M√™s */}
                      <div className="mb-4 flex flex-wrap gap-2">
                        {meses.map((mes, idx) => (
                          <button
                            key={idx}
                            onClick={() => setMesSelecionado(idx)}
                            className={`px-3 py-1 rounded text-sm font-semibold transition ${
                              mesSelecionado === idx
                                ? 'bg-blue-600 text-white shadow-lg'
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                          >
                            {mes.substring(0, 3)}
                          </button>
                        ))}
                      </div>
                      
                      {/* Card do M√™s */}
                      <div className="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-6">
                        <h3 className="text-2xl font-bold text-blue-900 mb-4">
                          üìÖ {meses[mesSelecionado]} {anoSelecionado}
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {/* Fatura√ß√£o */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üí∞ Fatura√ß√£o Total</div>
                            <div className="text-2xl font-bold text-green-600">
                              ‚Ç¨{mesAtual.faturacao.toFixed(2)}
                            </div>
                            {mesAnterior.faturacao > 0 && (
                              <div className={`text-sm mt-1 ${variacaoFaturacao >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                vs {meses[mesAnteriorNum]}: {variacaoFaturacao >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoFaturacao).toFixed(1)}%
                                <span className="text-gray-600 ml-1">
                                  ({variacaoFaturacao >= 0 ? '+' : ''}‚Ç¨{(mesAtual.faturacao - mesAnterior.faturacao).toFixed(2)})
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Lucro */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üèÜ Lucro Total</div>
                            <div className={`text-2xl font-bold ${mesAtual.lucroTotal >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                              ‚Ç¨{mesAtual.lucroTotal.toFixed(2)}
                            </div>
                            {mesAnterior.lucroTotal !== 0 && (
                              <div className={`text-sm mt-1 ${variacaoLucro >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                vs {meses[mesAnteriorNum]}: {variacaoLucro >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoLucro).toFixed(1)}%
                                <span className="text-gray-600 ml-1">
                                  ({variacaoLucro >= 0 ? '+' : ''}‚Ç¨{(mesAtual.lucroTotal - mesAnterior.lucroTotal).toFixed(2)})
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Total Vendas */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üì¶ Total Vendas</div>
                            <div className="text-2xl font-bold text-purple-600">
                              {mesAtual.totalQuantidade} un
                            </div>
                            {mesAnterior.totalVendas > 0 && (
                              <div className={`text-sm mt-1 ${variacaoVendas >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                vs {meses[mesAnteriorNum]}: {variacaoVendas >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(variacaoVendas).toFixed(1)}%
                                <span className="text-gray-600 ml-1">
                                  ({variacaoVendas >= 0 ? '+' : ''}{mesAtual.totalVendas - mesAnterior.totalVendas} vendas)
                                </span>
                              </div>
                            )}
                          </div>
                          
                          {/* Produto Mais Vendido */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">ü•á Mais Vendido</div>
                            {mesAtual.maisVendido ? (
                              <>
                                <div className="text-lg font-bold text-amber-600">
                                  {mesAtual.maisVendido.nome}
                                </div>
                                <div className="text-sm text-gray-600">
                                  {mesAtual.maisVendido.qtd}x vendidas
                                </div>
                                {mesAnterior.maisVendido && mesAnterior.maisVendido.nome !== mesAtual.maisVendido.nome && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    {meses[mesAnteriorNum]}: {mesAnterior.maisVendido.nome}
                                  </div>
                                )}
                              </>
                            ) : (
                              <div className="text-gray-400">Sem dados</div>
                            )}
                          </div>
                          
                          {/* Produto Menos Vendido */}
                          <div className="bg-white rounded-lg p-4 shadow">
                            <div className="text-sm text-gray-600 mb-1">üìâ Menos Vendido</div>
                            {mesAtual.menosVendido ? (
                              <>
                                <div className="text-lg font-bold text-gray-600">
                                  {mesAtual.menosVendido.nome}
                                </div>
                                <div className="text-sm text-gray-600">
                                  {mesAtual.menosVendido.qtd}x vendidas
                                </div>
                                {mesAnterior.menosVendido && mesAnterior.menosVendido.nome !== mesAtual.menosVendido.nome && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    {meses[mesAnteriorNum]}: {mesAnterior.menosVendido.nome}
                                  </div>
                                )}
                              </>
                            ) : (
                              <div className="text-gray-400">Sem dados</div>
                            )}
                          </div>
                        </div>
                        
                        {/* Nota sobre ano anterior */}
                        {!temDadosAnoAnterior && (
                          <div className="mt-4 bg-blue-100 border border-blue-300 rounded-lg p-3">
                            <p className="text-sm text-blue-800">
                              ‚ÑπÔ∏è <strong>Compara√ß√£o com {meses[mesSelecionado]} {anoSelecionado - 1}:</strong> Dados n√£o dispon√≠veis
                              <br/>
                              <span className="text-xs">(Restaurante aberto desde Agosto 2025)</span>
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* ============================================ */}
              {/* SECTION: M√âTRICAS POR PRODUTO (GERAL) */}
              {/* ============================================ */}

              <div className="bg-white rounded-lg shadow p-4 mb-3">
                {/* Header clic√°vel */}
                <div 
                  onClick={() => setDesempenhoProdutoExpanded(!desempenhoProdutoExpanded)}
                  className="flex items-center justify-between cursor-pointer hover:bg-gray-50 -m-4 p-4 rounded-lg transition"
                >
                  <h2 className="text-xl font-bold flex items-center gap-2">
                    üìä Desempenho por Produto
                  </h2>
                  <span className="text-2xl text-gray-600 transform transition-transform duration-200" style={{ transform: desempenhoProdutoExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                    ‚ñº
                  </span>
                </div>
                
                {/* Conte√∫do expans√≠vel */}
                {desempenhoProdutoExpanded && (
                  <div className="mt-4">
                    {/* Filtro de Categoria - DROPDOWN */}
                    <div className="mb-4 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                      <label className="text-xs font-semibold text-gray-700 block mb-2">Filtrar por categoria:</label>
                      <select
                        value={categoriaFiltroDesempenho}
                        onChange={(e) => setCategoriaFiltroDesempenho(e.target.value)}
                        className="w-full md:w-64 px-4 py-2 border-2 border-blue-300 rounded-lg text-sm font-semibold bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="todos">üìä Todos os Produtos</option>
                        <option value="cafes">‚òï Caf√©s</option>
                        <option value="bebidas">ü•§ Bebidas</option>
                        <option value="pratos">üç≥ Pratos</option>
                        <option value="sobremesas">üç∞ Sobremesas</option>
                        <option value="takeaway">üì¶ Take Away</option>
                      </select>
                    </div>
                    
                    <p className="text-xs text-gray-600 mb-3">
                      Ranking de vendas, lucro e margens
                      {categoriaFiltroDesempenho !== 'todos' && (
                        <span className="font-bold text-blue-600"> - {categoriaFiltroDesempenho}</span>
                      )}
                    </p>
                
                {(() => {
                  // Calcular vendas por produto
                  const vendasPorProduto = {};
                  
                  filteredVendas.forEach(v => {
                    if (!vendasPorProduto[v.produto]) {
                      vendasPorProduto[v.produto] = {
                        nome: v.produto,
                        quantidade: 0,
                        faturacao: 0,
                        lucro: 0
                      };
                    }
                    
                    // Arredondar TUDO para evitar erros de ponto flutuante
                    vendasPorProduto[v.produto].quantidade = Math.round((vendasPorProduto[v.produto].quantidade + v.quantidade) * 100) / 100;
                    vendasPorProduto[v.produto].faturacao = Math.round((vendasPorProduto[v.produto].faturacao + v.valor) * 100) / 100;
                    vendasPorProduto[v.produto].lucro = Math.round((vendasPorProduto[v.produto].lucro + calcLucroVenda(v).lucro) * 100) / 100;
                  });
                  
                  const produtosArray = Object.values(vendasPorProduto)
                    .sort((a, b) => b.faturacao - a.faturacao);
                  
                  // Aplicar filtro de categoria
                  let produtosFiltrados = produtosArray;
                  if (categoriaFiltroDesempenho !== 'todos') {
                    produtosFiltrados = produtosArray.filter(pVenda => {
                      const produto = produtos.find(p => p.nome === pVenda.nome);
                      return produto && produto.categoria === categoriaFiltroDesempenho;
                    });
                  }
                  
                  if (produtosFiltrados.length === 0) {
                    return (
                      <div className="text-center py-8 bg-gray-50 rounded-lg">
                        <p className="text-gray-600">
                          üì¶ Sem vendas de produtos da categoria "{categoriaFiltroDesempenho}" no per√≠odo selecionado
                        </p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gradient-to-r from-blue-100 to-indigo-100 border-b-2 border-blue-300">
                            <th className="text-left p-2 font-bold text-blue-900">#</th>
                            <th className="text-left p-2 font-bold text-blue-900">Produto</th>
                            <th className="text-right p-2 font-bold text-blue-900">Qtd Vendida</th>
                            <th className="text-right p-2 font-bold text-blue-900">Fatura√ß√£o</th>
                            <th className="text-right p-2 font-bold text-blue-900">Lucro</th>
                            <th className="text-right p-2 font-bold text-blue-900">Margem %</th>
                            <th className="text-right p-2 font-bold text-blue-900">Ticket M√©dio</th>
                          </tr>
                        </thead>
                        <tbody>
                          {produtosFiltrados.map((p, idx) => {
                            const margemPerc = p.faturacao > 0 ? (p.lucro / p.faturacao) * 100 : 0;
                            const ticketMedio = p.quantidade > 0 ? p.faturacao / p.quantidade : 0;
                            
                            // Verificar se produto tem receita
                            const produto = produtos.find(pr => pr.nome === p.nome);
                            const temReceita = produto && produto.receita && produto.receita.length > 0;
                            
                            // DEBUG apenas para primeiro produto
                            if (idx === 0) {
                              void 0;
                              void 0;
                              void 0;
                              void 0;
                              if (produto) {
                                void 0;
                                void 0;
                              }
                            }
                            
                            return (
                              <tr key={p.nome} className="border-b hover:bg-blue-50 transition">
                                <td className="p-2 font-bold text-blue-600">#{idx + 1}</td>
                                <td className="p-2 font-semibold">
                                  {p.nome}
                                  {!temReceita && (
                                    <span className="ml-2 text-xs text-orange-600 font-bold" title="Produto sem receita - margem n√£o calculada">
                                      ‚ö†Ô∏è
                                    </span>
                                  )}
                                </td>
                                <td className="p-2 text-right font-semibold">{p.quantidade}</td>
                                <td className="p-2 text-right font-semibold text-green-700">‚Ç¨{p.faturacao.toFixed(2)}</td>
                                <td className="p-2 text-right font-semibold text-blue-700">‚Ç¨{p.lucro.toFixed(2)}</td>
                                <td className={`p-2 text-right font-bold ${
                                  !temReceita ? 'text-red-600' :
                                  margemPerc > 60 ? 'text-green-600' :
                                  margemPerc > 40 ? 'text-blue-600' : 'text-orange-600'
                                }`}>
                                  {!temReceita && '‚ö†Ô∏è '}
                                  {margemPerc.toFixed(1)}%
                                </td>
                                <td className="p-2 text-right text-gray-700">‚Ç¨{ticketMedio.toFixed(2)}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                        <tfoot>
                          <tr className="bg-gradient-to-r from-gray-100 to-gray-200 border-t-2 border-gray-400 font-bold">
                            <td className="p-2" colspan="2">TOTAL</td>
                            <td className="p-2 text-right text-blue-900">
                              {produtosFiltrados.reduce((s, p) => s + p.quantidade, 0)}
                            </td>
                            <td className="p-2 text-right text-green-700">
                              ‚Ç¨{produtosFiltrados.reduce((s, p) => s + p.faturacao, 0).toFixed(2)}
                            </td>
                            <td className="p-2 text-right text-blue-700">
                              ‚Ç¨{produtosFiltrados.reduce((s, p) => s + p.lucro, 0).toFixed(2)}
                            </td>
                            <td className="p-2 text-right text-gray-700">
                              {(() => {
                                const totalFat = produtosFiltrados.reduce((s, p) => s + p.faturacao, 0);
                                const totalLucro = produtosFiltrados.reduce((s, p) => s + p.lucro, 0);
                                return totalFat > 0 ? ((totalLucro / totalFat) * 100).toFixed(1) : '0.0';
                              })()}%
                            </td>
                            <td className="p-2 text-right text-gray-700">
                              ‚Ç¨{(() => {
                                const totalQtd = produtosFiltrados.reduce((s, p) => s + p.quantidade, 0);
                                const totalFat = produtosFiltrados.reduce((s, p) => s + p.faturacao, 0);
                                return totalQtd > 0 ? (totalFat / totalQtd).toFixed(2) : '0.00';
                              })()}
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  );
                })()}
                </div>
              )}
              </div>

              {/* ============================================ */}
              {/* SECTION: M√âTRICAS POR CATEGORIA */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                  <Tooltip text="Agrupa as vendas por tipo de produto (Caf√©s, Lanches, Sobremesas, etc). √ötil para identificar quais categorias geram mais receita e t√™m melhores margens." position="right">
                    <span className="flex items-center gap-2">
                      üìä M√©tricas por Categoria de Produto
                      <span className="text-gray-400 text-lg">‚ìò</span>
                    </span>
                  </Tooltip>
                </h2>
                <p className="text-xs text-gray-600 mb-3">Vendas agrupadas por categoria (Caf√©s, Bebidas, Pratos, Sobremesas...)</p>
                
                {(() => {
                  // Agrupar vendas por categoria de produto
                  const vendasPorCategoria = {};
                  
                  filteredVendas.forEach(v => {
                    // Encontrar o produto para pegar a categoria
                    const produto = produtos.find(p => p.nome === v.produto);
                    const categoria = produto?.categoria || 'outros';
                    
                    if (!vendasPorCategoria[categoria]) {
                      vendasPorCategoria[categoria] = {
                        quantidade: 0,
                        faturacao: 0,
                        lucro: 0
                      };
                    }
                    
                    // Arredondar TUDO para evitar erros de ponto flutuante
                    vendasPorCategoria[categoria].quantidade = Math.round((vendasPorCategoria[categoria].quantidade + v.quantidade) * 100) / 100;
                    vendasPorCategoria[categoria].faturacao = Math.round((vendasPorCategoria[categoria].faturacao + v.valor) * 100) / 100;
                    vendasPorCategoria[categoria].lucro = Math.round((vendasPorCategoria[categoria].lucro + calcLucroVenda(v).lucro) * 100) / 100;
                  });
                  
                  const categorias = {
                    'cafes': { nome: '‚òï Caf√©s', cor: 'brown' },
                    'bebidas': { nome: 'ü•§ Bebidas', cor: 'blue' },
                    'pratos': { nome: 'üçΩÔ∏è Pratos', cor: 'orange' },
                    'sobremesas': { nome: 'üç∞ Sobremesas', cor: 'pink' },
                    'lanches': { nome: 'ü•™ Lanches', cor: 'yellow' },
                    'outros': { nome: 'üì¶ Outros', cor: 'gray' }
                  };
                  
                  const categoriasComDados = Object.entries(vendasPorCategoria)
                    .filter(([_, dados]) => dados.quantidade > 0)
                    .sort((a, b) => b[1].faturacao - a[1].faturacao);
                  
                  if (categoriasComDados.length === 0) {
                    return (
                      <div className="text-center py-8 bg-gray-50 rounded-lg">
                        <p className="text-gray-600">üì¶ Sem vendas no per√≠odo selecionado</p>
                        <p className="text-xs text-gray-500 mt-2">Adicione produtos com categorias para ver m√©tricas</p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
                      {categoriasComDados.map(([cat, dados]) => {
                        const info = categorias[cat] || { nome: cat, cor: 'gray' };
                        const margemPerc = dados.faturacao > 0 ? (dados.lucro / dados.faturacao) * 100 : 0;
                        
                        return (
                          <div key={cat} className={`bg-${info.cor}-50 border-2 border-${info.cor}-300 rounded-lg p-3`}>
                            <p className="text-xs font-bold mb-1">{info.nome}</p>
                            <p className="text-2xl font-bold text-gray-900 mb-1">
                              {Math.round(dados.quantidade)}
                            </p>
                            <p className="text-xs text-gray-600 mb-2">unidades vendidas</p>
                            
                            <div className="bg-white rounded p-2 text-xs space-y-1">
                              <div className="flex justify-between">
                                <span className="text-gray-600">Fatura√ß√£o:</span>
                                <span className="font-bold text-green-700">‚Ç¨{dados.faturacao.toFixed(0)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Lucro:</span>
                                <span className="font-bold text-blue-700">‚Ç¨{dados.lucro.toFixed(0)}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Margem:</span>
                                <span className={`font-bold ${
                                  margemPerc > 60 ? 'text-green-600' :
                                  margemPerc > 40 ? 'text-blue-600' : 'text-orange-600'
                                }`}>
                                  {margemPerc.toFixed(1)}%
                                </span>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>

              {/* ============================================ */}
              {/* SECTION 3: AN√ÅLISE POR CLIENTE */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3">üë§ An√°lise por Cliente</h2>
                <p className="text-xs text-gray-600 mb-3">Custos e margens por venda individual</p>
                
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
                  <div className="bg-blue-50 rounded p-3 border-l-4 border-blue-500">
                    <p className="text-xs text-blue-700 mb-1">Custo Alimentos</p>
                    <p className="text-lg font-bold text-blue-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (
                        todasDespesas
                          .filter(d => d.categoria === 'compras')
                          .reduce((s, d) => s + d.valor, 0) / filteredVendas.length
                      ).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-blue-600 mt-1">Por venda</p>
                  </div>
                  
                  <div className="bg-purple-50 rounded p-3 border-l-4 border-purple-500">
                    <p className="text-xs text-purple-700 mb-1">Custo Consum√≠veis</p>
                    <p className="text-lg font-bold text-purple-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (
                        todasDespesas
                          .filter(d => d.categoria === 'consumiveis')
                          .reduce((s, d) => s + d.valor, 0) / filteredVendas.length
                      ).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-purple-600 mt-1">Por venda</p>
                  </div>
                  
                  <div className="bg-orange-50 rounded p-3 border-l-4 border-orange-500">
                    <p className="text-xs text-orange-700 mb-1">Pre√ßo M√©dio Venda</p>
                    <p className="text-lg font-bold text-orange-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (totV / filteredVendas.length).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-orange-600 mt-1">Por venda</p>
                  </div>
                  
                  <div className="bg-green-50 rounded p-3 border-l-4 border-green-500">
                    <p className="text-xs text-green-700 mb-1">Margem por Cliente</p>
                    <p className="text-lg font-bold text-green-900">
                      ‚Ç¨{filteredVendas.length > 0 ? (
                        (totV - todasDespesas.filter(d => d.categoria === 'compras' || d.categoria === 'consumiveis').reduce((s, d) => s + d.valor, 0)) / filteredVendas.length
                      ).toFixed(2) : '0.00'}
                    </p>
                    <p className="text-xs text-green-600 mt-1">Por venda</p>
                  </div>
                </div>
              </div>

              {/* ============================================ */}
              {/* SECTION 4: FISCAL (IVA) */}
              {/* ============================================ */}
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-xl font-bold mb-3">üßÆ An√°lise Fiscal (IVA)</h2>
                
                <div className="grid grid-cols-3 gap-3 mb-3">
                  <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                    <p className="text-xs text-green-700 mb-1 font-semibold">IVA Vendas</p>
                    <p className="text-xl font-bold text-green-900">
                      ‚Ç¨{filteredVendas.reduce((s, v) => {
                        // Vendas podem ter produtoId OU produto (nome)
                        const prod = v.produtoId 
                          ? produtos.find(p => p.id === v.produtoId)
                          : produtos.find(p => p.nome.toLowerCase() === v.produto.toLowerCase());
                        if (!prod) return s;
                        const precoSemIva = prod.precoVenda / (1 + prod.iva / 100);
                        return s + (prod.precoVenda - precoSemIva) * v.quantidade;
                      }, 0).toFixed(2)}
                    </p>
                    <p className="text-xs text-green-600 mt-1">Cobrado aos clientes</p>
                  </div>
                  
                  <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <p className="text-xs text-blue-700 mb-1 font-semibold">IVA Dedut√≠vel</p>
                    <p className="text-xl font-bold text-blue-900">
                      ‚Ç¨{ivaCompras.toFixed(2)}
                    </p>
                    <p className="text-xs text-blue-600 mt-1">Despesas dedut√≠veis</p>
                  </div>
                  
                  <div className={`rounded-lg p-4 border ${ivaP >= 0 ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200'}`}>
                    <p className={`text-xs mb-1 font-semibold ${ivaP >= 0 ? 'text-orange-700' : 'text-green-700'}`}>
                      {ivaP >= 0 ? 'IVA a Pagar' : 'IVA a Receber'} Q{quarter}/{currentYear}
                    </p>
                    <p className={`text-xl font-bold ${ivaP >= 0 ? 'text-orange-900' : 'text-green-900'}`}>
                      ‚Ç¨{Math.abs(ivaP).toFixed(2)}
                    </p>
                    <p className={`text-xs mt-1 ${ivaP >= 0 ? 'text-orange-600' : 'text-green-600'}`}>
                      {ivaP >= 0 ? 'A entregar ao Estado' : 'Estado deve-te (cr√©dito IVA)'}
                    </p>
                  </div>
                </div>
                
                <div className={`rounded p-2 text-xs mb-3 ${ivaP >= 0 ? 'bg-blue-50 text-blue-800' : 'bg-green-50 text-green-800'}`}>
                  üí° <strong>C√°lculo:</strong> IVA {ivaP >= 0 ? 'a Pagar' : 'a Receber'} = IVA Vendas - IVA Dedut√≠vel
                  {ivaP < 0 && (
                    <><br/>‚úÖ As tuas despesas dedut√≠veis t√™m mais IVA que as tuas vendas. O Estado deve-te este valor!</>
                  )}
                  <br/>üìÖ <strong>Regime Trimestral:</strong> Valores resetam de 3 em 3 meses (Q{quarter}/{currentYear})
                </div>
                
                {/* IVA Breakdown */}
                <div className="border-t pt-3">
                  <h4 className="text-sm font-semibold mb-2 text-gray-700">üìã Breakdown IVA Dedut√≠vel</h4>
                  <div className="grid grid-cols-2 gap-2">
                    <div className="bg-blue-50 rounded p-2 border border-blue-200">
                      <p className="text-xs text-blue-700 mb-1">IVA Compras Alimentos</p>
                      <p className="text-base font-bold text-blue-900">
                        ‚Ç¨{(() => {
                          // IVA das despesas manuais categoria compras
                          const ivaDespesas = filteredDespesas
                            .filter(d => d.categoria === 'compras')
                            .reduce((s, d) => {
                              const valorSemIva = d.valor / (1 + (d.iva || 23) / 100);
                              return s + (d.valor - valorSemIva);
                            }, 0);
                          
                          // IVA das faturas de COMPRAS apenas (excluir FS)
                          // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO
                          const ivaFaturasCompras = filteredFaturasComConfig
                            .filter(f => f.categoria === 'compras' && f.tipo !== 'FS')
                            .reduce((s, f) => s + (f.totalIva || 0), 0);
                          
                          return (ivaDespesas + ivaFaturasCompras).toFixed(2);
                        })()}
                      </p>
                      <p className="text-xs text-blue-600 mt-1">Ingredientes</p>
                    </div>
                    
                    <div className="bg-purple-50 rounded p-2 border border-purple-200">
                      <p className="text-xs text-purple-700 mb-1">IVA Consum√≠veis</p>
                      <p className="text-base font-bold text-purple-900">
                        ‚Ç¨{filteredDespesas
                          .filter(d => d.categoria === 'consumiveis')
                          .reduce((s, d) => {
                            const valorSemIva = d.valor / (1 + (d.iva || 23) / 100);
                            return s + (d.valor - valorSemIva);
                          }, 0).toFixed(2)}
                      </p>
                      <p className="text-xs text-purple-600 mt-1">Material</p>
                    </div>
                    
                    <div className="bg-orange-50 rounded p-2 border border-orange-200">
                      <p className="text-xs text-orange-700 mb-1">IVA Despesas Fixas</p>
                      <p className="text-base font-bold text-orange-900">
                        ‚Ç¨{(() => {
                          // IVA de despesas manuais fixas (renda, eletricidade, etc.)
                          const ivaDespesasFixas = filteredDespesas
                            .filter(d => ['renda', 'eletricidade', 'agua', 'gas', 'internet'].includes(d.categoria))
                            .reduce((s, d) => {
                              const valorSemIva = d.valor / (1 + (d.iva || 23) / 100);
                              return s + (d.valor - valorSemIva);
                            }, 0);
                          
                          // IVA de faturas fixas (excluir FS)
                          // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO
                          const ivaFaturasFixas = filteredFaturasComConfig
                            .filter(f => ['renda', 'eletricidade', 'agua', 'gas', 'internet'].includes(f.categoria) && f.tipo !== 'FS')
                            .reduce((s, f) => s + (f.totalIva || 0), 0);
                          
                          return (ivaDespesasFixas + ivaFaturasFixas).toFixed(2);
                        })()}
                      </p>
                      <p className="text-xs text-orange-600 mt-1">Renda, Utilidades</p>
                    </div>
                    
                    <div className="bg-gray-50 rounded p-2 border border-gray-200">
                      <p className="text-xs text-gray-700 mb-1">IVA Outros</p>
                      <p className="text-base font-bold text-gray-900">
                        ‚Ç¨{(() => {
                          // IVA de outras despesas
                          const ivaOutrasDespesas = filteredDespesas
                            .filter(d => !['compras', 'consumiveis', 'renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(d.categoria))
                            .reduce((s, d) => {
                              const valorSemIva = d.valor / (1 + (d.iva || 23) / 100);
                              return s + (d.valor - valorSemIva);
                            }, 0);
                          
                          // IVA de outras faturas (excluir FS)
                          // ‚úÖ APLICAR FILTROS DE CONFIGURA√á√ÉO
                          const ivaOutrasFaturas = filteredFaturasComConfig
                            .filter(f => !['compras', 'renda', 'eletricidade', 'agua', 'gas', 'internet', 'salarios'].includes(f.categoria) && f.tipo !== 'FS')
                            .reduce((s, f) => s + (f.totalIva || 0), 0);
                          
                          return (ivaOutrasDespesas + ivaOutrasFaturas).toFixed(2);
                        })()}
                      </p>
                      <p className="text-xs text-gray-600 mt-1">Marketing, etc.</p>
                    </div>
                  </div>
                </div>
              </div>
              
            </>
            )}
            {dashboardSubTab === 'compras' && (
              <ComprasAnalysis 
                despesas={despesas}
                faturas={faturas}
                ingredientes={ingredientes}
                fornecedores={fornecedores}
              />
            )}
            {dashboardSubTab === 'delivery' && deliveryApps.some(app => app.ativo) && (
              <>
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                  üöó An√°lise de Delivery
                </h2>
                
                <div className="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-lg p-4 mb-4">
                  <p className="text-sm text-gray-700 mb-2">
                    üí° <strong>Compara√ß√£o de Pre√ßos e Margens</strong> - Produtos Take-Away vs Apps Delivery
                  </p>
                  <p className="text-xs text-gray-600">
                    Apps ativas: {deliveryApps.filter(app => app.ativo).map(app => `${app.nome} (${app.comissao}%)`).join(', ')}
                  </p>
                </div>
                
                {/* Barra de Pesquisa de Produtos Take-Away */}
                <div className="mb-4">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar produto take-away..."
                      value={searchTakeAway}
                      onChange={(e) => setSearchTakeAway(e.target.value)}
                      className="w-full px-4 py-2 border-2 border-orange-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50"
                    />
                    {searchTakeAway && (
                      <button
                        onClick={() => setSearchTakeAway('')}
                        className="absolute right-3 top-2.5 text-orange-500 hover:text-orange-700 font-bold text-lg"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  {searchTakeAway && (
                    <p className="text-xs text-gray-600 mt-1 ml-1">
                      A filtrar por: <span className="font-semibold text-orange-600">{searchTakeAway}</span>
                    </p>
                  )}
                </div>
                
                {/* Filtrar produtos com embalagens */}
                {(() => {
                  void 0;
                  void 0;
                  void 0;
                  
                  // Debug ingredientes embalagens
                  const embalagens = ingredientes.filter(i => i.categoria === 'embalagens');
                  void 0;
                  
                  const produtosTakeAway = produtos
                    .filter(p => {
                      if (!p.embalagens || !Array.isArray(p.embalagens) || p.embalagens.length === 0) {
                        void 0;
                        return false;
                      }
                      
                      const temEmbalagem = p.embalagens.some(e => {
                        const ing = ingredientes.find(i => i.id == e.ingredienteId);
                        if (ing && ing.categoria === 'embalagens') {
                          void 0;
                          return true;
                        }
                        return false;
                      });
                      
                      return temEmbalagem;
                    })
                    .filter(p => 
                      p.nome.toLowerCase().includes(searchTakeAway.toLowerCase())
                    );
                  
                  void 0;
                  void 0;
                  
                  if (produtosTakeAway.length === 0) {
                    // Verificar se √© porque a pesquisa n√£o encontrou ou porque n√£o h√° produtos take-away
                    const totalTakeAway = produtos.filter(p => {
                      if (!p.embalagens || !Array.isArray(p.embalagens) || p.embalagens.length === 0) {
                        return false;
                      }
                      return p.embalagens.some(e => {
                        const ing = ingredientes.find(i => i.id == e.ingredienteId);
                        return ing && ing.categoria === 'embalagens';
                      });
                    }).length;
                    
                    if (searchTakeAway && totalTakeAway > 0) {
                      // A pesquisa n√£o encontrou nada mas existem produtos take-away
                      return (
                        <div className="text-center py-12 bg-orange-50 rounded-lg border-2 border-orange-200">
                          <p className="text-orange-700 mb-2 font-bold">üîç Nenhum resultado encontrado</p>
                          <p className="text-sm text-orange-600 mb-3">
                            N√£o h√° produtos take-away com o nome "<strong>{searchTakeAway}</strong>"
                          </p>
                          <button
                            onClick={() => setSearchTakeAway('')}
                            className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm font-semibold"
                          >
                            ‚úï Limpar Pesquisa
                          </button>
                          <p className="text-xs text-gray-600 mt-3">
                            {totalTakeAway} produto{totalTakeAway !== 1 ? 's' : ''} take-away dispon√≠ve{totalTakeAway !== 1 ? 'is' : 'l'}
                          </p>
                        </div>
                      );
                    }
                    
                    // N√£o h√° produtos take-away criados
                    return (
                      <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed">
                        <p className="text-gray-600 mb-2">üì¶ Nenhum produto Take-Away encontrado</p>
                        <p className="text-sm text-gray-500 mb-2">
                          Adicione produtos com embalagens (categoria "Embalagens") para ver an√°lise de delivery
                        </p>
                        <div className="text-xs text-left bg-white p-4 rounded mx-auto max-w-md mt-4">
                          <p className="font-bold mb-2">Debug Info:</p>
                          <p>Total produtos: {(produtos || []).length}</p>
                          <p>Total ingredientes: {(ingredientes || []).length}</p>
                          <p>Ingredientes "embalagens": {embalagens.length}</p>
                          <p className="mt-2 text-gray-600">Categorias encontradas:</p>
                          <p className="text-xs">{[...new Set((ingredientes || []).map(i => i.categoria))].join(', ')}</p>
                        </div>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="space-y-4">
                      {searchTakeAway && (
                        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-sm">
                          <p className="text-blue-700">
                            <span className="font-bold">{produtosTakeAway.length}</span> produto{produtosTakeAway.length !== 1 ? 's' : ''} encontrado{produtosTakeAway.length !== 1 ? 's' : ''} para "<strong>{searchTakeAway}</strong>"
                          </p>
                        </div>
                      )}
                      {produtosTakeAway.map(produto => {
                        const precos = calcPrecosPorModalidade(produto);
                        const appsAtivas = deliveryApps.filter(app => app.ativo);
                        
                        return (
                          <div key={produto.id} className="border-2 border-gray-200 rounded-lg overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-3 border-b-2 border-blue-200">
                              <h3 className="font-bold text-lg">{produto.nome}</h3>
                              <p className="text-xs text-gray-600">
                                Custo ingredientes: ‚Ç¨{precos.takeaway.custo - precos.takeaway.custoEmbalagens || 0} | 
                                Custo embalagens: ‚Ç¨{precos.takeaway.custoEmbalagens.toFixed(2)} | 
                                <strong> Total: ‚Ç¨{precos.takeaway.custo.toFixed(2)}</strong>
                              </p>
                            </div>
                            
                            <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                              {/* Take-Away Direto */}
                              <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-2xl">üõçÔ∏è</span>
                                  <div>
                                    <p className="font-bold text-sm">Take-Away Direto</p>
                                    <p className="text-xs text-gray-600">Sem comiss√µes</p>
                                  </div>
                                </div>
                                <div className="space-y-1">
                                  <div className="flex justify-between text-xs">
                                    <span>Pre√ßo:</span>
                                    <span className="font-bold">‚Ç¨{precos.takeaway.preco.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-xs">
                                    <span>Margem:</span>
                                    <span className="font-bold text-green-700">‚Ç¨{precos.takeaway.margem.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-xs">
                                    <span>Margem %:</span>
                                    <span className="font-bold text-green-700">{precos.takeaway.margemPerc.toFixed(0)}%</span>
                                  </div>
                                </div>
                              </div>
                              
                              {/* Apps de Delivery */}
                              {appsAtivas.map(app => {
                                const dados = precos.delivery[app.id];
                                const diferencaMargem = ((dados.margemPerc - precos.takeaway.margemPerc) / precos.takeaway.margemPerc * 100);
                                
                                return (
                                  <div key={app.id} className="bg-orange-50 border-2 border-orange-300 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-2xl">üöó</span>
                                      <div>
                                        <p className="font-bold text-sm">{app.nome}</p>
                                        <p className="text-xs text-gray-600">Comiss√£o {app.comissao}%</p>
                                      </div>
                                    </div>
                                    <div className="space-y-1">
                                      <div className="flex justify-between text-xs">
                                        <span>Pre√ßo sugerido:</span>
                                        <span className="font-bold">‚Ç¨{dados.precoSugerido.toFixed(2)}</span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Receita l√≠quida:</span>
                                        <span className="font-semibold text-blue-600">‚Ç¨{dados.receitaLiquida.toFixed(2)}</span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Margem:</span>
                                        <span className={`font-bold ${dados.margem > 0 ? 'text-green-700' : 'text-red-700'}`}>
                                          ‚Ç¨{dados.margem.toFixed(2)}
                                        </span>
                                      </div>
                                      <div className="flex justify-between text-xs">
                                        <span>Margem %:</span>
                                        <span className={`font-bold ${dados.margem > 0 ? 'text-green-700' : 'text-red-700'}`}>
                                          {dados.margemPerc.toFixed(0)}%
                                        </span>
                                      </div>
                                      <div className="pt-1 border-t border-orange-200">
                                        <p className={`text-xs font-semibold ${diferencaMargem < 0 ? 'text-red-600' : 'text-green-600'}`}>
                                          {diferencaMargem >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(diferencaMargem).toFixed(0)}% vs direto
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            
                            {/* Recomenda√ß√£o */}
                            <div className="bg-blue-50 p-3 border-t-2 border-blue-200">
                              <p className="text-xs text-blue-900">
                                <strong>üí° Recomenda√ß√£o:</strong> {(() => {
                                  const melhorApp = appsAtivas.reduce((melhor, app) => {
                                    const dados = precos.delivery[app.id];
                                    const melhorDados = precos.delivery[melhor.id];
                                    return dados.margemPerc > melhorDados.margemPerc ? app : melhor;
                                  });
                                  
                                  const melhorDados = precos.delivery[melhorApp.id];
                                  
                                  if (melhorDados.margemPerc < precos.takeaway.margemPerc * 0.7) {
                                    return `‚ö†Ô∏è Todas as apps reduzem margem >30%. Considere aumentar pre√ßos ou venda direta.`;
                                  }
                                  
                                  return `Melhor app: ${melhorApp.nome} (margem ${melhorDados.margemPerc.toFixed(0)}%)`;
                                })()}
                              </p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>
              </>
            )}

            {dashboardSubTab === 'simuladores' && (
              <>
                {/* Simulador de Custos Laborais */}
                <div className="bg-white rounded-lg shadow p-4 mb-3">
                  <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
                    üí∞ Simulador de Custos Laborais
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">
                    Calcula o custo real de um funcion√°rio incluindo subs√≠dios obrigat√≥rios e encargos da Seguran√ßa Social
                  </p>
                  
                  {/* Seletor de Modo */}
                  <div className="mb-4 flex gap-2">
                    <button
                      onClick={() => setModoSimulador('fulltime')}
                      className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${
                        modoSimulador === 'fulltime' 
                          ? 'bg-blue-500 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üëî Full-Time (40h/semana)
                    </button>
                    <button
                      onClick={() => setModoSimulador('parttime')}
                      className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${
                        modoSimulador === 'parttime' 
                          ? 'bg-green-500 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ‚è∞ Part-Time
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {/* Input */}
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                      <h3 className="font-semibold text-blue-900 mb-3">üìù Dados do Sal√°rio</h3>
                      
                      <div className="space-y-3">
                        {modoSimulador === 'parttime' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Horas Semanais
                            </label>
                            <div className="relative">
                              <input
                                type="number"
                                value={horasSemanaisPartTime}
                                onChange={(e) => setHorasSemanaisPartTime(parseFloat(e.target.value) || 0)}
                                className="w-full border rounded px-3 py-2 pr-12"
                                placeholder="8"
                                min="1"
                                max="30"
                              />
                              <span className="absolute right-3 top-2.5 text-gray-500 text-sm">h/sem</span>
                            </div>
                            <p className="text-xs text-gray-600 mt-1">
                              = {((horasSemanaisPartTime / 40) * 100).toFixed(0)}% de um full-time
                            </p>
                          </div>
                        )}
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {modoSimulador === 'fulltime' ? 'Sal√°rio Bruto Mensal' : 'Sal√°rio Refer√™ncia Full-Time'}
                          </label>
                          <div className="relative">
                            <input
                              type="number"
                              value={ordenadoDesejado}
                              onChange={(e) => setOrdenadoDesejado(parseFloat(e.target.value) || 0)}
                              className="w-full border rounded px-3 py-2 pr-8"
                              placeholder="920"
                            />
                            <span className="absolute right-3 top-2.5 text-gray-500 font-semibold">‚Ç¨</span>
                          </div>
                          {modoSimulador === 'parttime' && (
                            <p className="text-xs text-green-700 mt-1 font-medium">
                              ‚Üí Part-time: ‚Ç¨{(ordenadoDesejado * horasSemanaisPartTime / 40).toFixed(2)}/m√™s
                            </p>
                          )}
                        </div>
                        
                        {/* Subs√≠dio de Alimenta√ß√£o */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirSubsidioAlimentacao}
                              onChange={(e) => setIncluirSubsidioAlimentacao(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Subs√≠dio de Alimenta√ß√£o</span>
                          </label>
                          
                          {incluirSubsidioAlimentacao && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="0.10"
                                  value={valorSubsidioAlimentacao}
                                  onChange={(e) => setValorSubsidioAlimentacao(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">
                                  ‚Ç¨/dia √ó {modoSimulador === 'parttime' ? Math.ceil(horasSemanaisPartTime / 5) : '22'} dias
                                </span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                {modoSimulador === 'fulltime' ? (
                                  `= ‚Ç¨${(valorSubsidioAlimentacao * 22).toFixed(2)}/m√™s`
                                ) : (
                                  <>
                                    {horasSemanaisPartTime < 25 ? (
                                      `= ‚Ç¨${(valorSubsidioAlimentacao * Math.ceil(horasSemanaisPartTime / 5) * 0.8).toFixed(2)}/m√™s (proporcional <5h/dia)`
                                    ) : (
                                      `= ‚Ç¨${(valorSubsidioAlimentacao * Math.ceil(horasSemanaisPartTime / 5)).toFixed(2)}/m√™s`
                                    )}
                                  </>
                                )}
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° N√£o obrigat√≥rio no setor privado. Refer√™ncia: ‚Ç¨6.00/dia (fun√ß√£o p√∫blica)
                          </p>
                        </div>
                        
                        {/* Medicina no Trabalho */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirMedicinaTrabalho}
                              onChange={(e) => setIncluirMedicinaTrabalho(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Medicina no Trabalho</span>
                          </label>
                          
                          {incluirMedicinaTrabalho && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="1"
                                  value={valorMedicinaTrabalho}
                                  onChange={(e) => setValorMedicinaTrabalho(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">‚Ç¨/ano</span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                = ‚Ç¨{(valorMedicinaTrabalho / 12).toFixed(2)}/m√™s
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° Obrigat√≥rio. M√©dia: ‚Ç¨80-150/ano por trabalhador
                          </p>
                        </div>
                        
                        {/* Seguro Contra Acidentes */}
                        <div className="pt-2 border-t border-blue-300">
                          <label className="flex items-center gap-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={incluirSeguroAcidentes}
                              onChange={(e) => setIncluirSeguroAcidentes(e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="text-sm font-medium text-gray-700">Incluir Seguro Contra Acidentes</span>
                          </label>
                          
                          {incluirSeguroAcidentes && (
                            <div className="mt-2 pl-6">
                              <div className="flex items-center gap-2">
                                <input
                                  type="number"
                                  step="1"
                                  value={valorSeguroAcidentes}
                                  onChange={(e) => setValorSeguroAcidentes(parseFloat(e.target.value) || 0)}
                                  className="w-20 border rounded px-2 py-1 text-sm"
                                />
                                <span className="text-sm text-gray-600">‚Ç¨/ano</span>
                              </div>
                              <p className="text-xs text-blue-700 mt-1">
                                = ‚Ç¨{(valorSeguroAcidentes / 12).toFixed(2)}/m√™s
                              </p>
                            </div>
                          )}
                          
                          <p className="text-xs text-gray-500 mt-1 pl-6">
                            üí° Obrigat√≥rio. M√©dia restaura√ß√£o: ‚Ç¨100-200/ano por trabalhador
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Output */}
                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4">
                      <h3 className="font-semibold text-green-900 mb-3">üíµ Custo Real para a Empresa</h3>
                      
                      {(() => {
                        // Calcular sal√°rio base (proporcional se part-time)
                        const proporcaoPartTime = modoSimulador === 'parttime' ? horasSemanaisPartTime / 40 : 1;
                        const salarioBase = ordenadoDesejado * proporcaoPartTime;
                        
                        // Calcular subs√≠dio alimenta√ß√£o
                        let subsidioAlimentacaoMensal = 0;
                        if (incluirSubsidioAlimentacao) {
                          if (modoSimulador === 'fulltime') {
                            subsidioAlimentacaoMensal = valorSubsidioAlimentacao * 22;
                          } else {
                            const diasTrabalhados = Math.ceil(horasSemanaisPartTime / 5); // aprox dias/semana
                            const valorDiario = horasSemanaisPartTime < 25 ? valorSubsidioAlimentacao * 0.8 : valorSubsidioAlimentacao;
                            subsidioAlimentacaoMensal = valorDiario * diasTrabalhados;
                          }
                        }
                        
                        const salarioComSubsidios = salarioBase + salarioBase / 12 * 2;
                        const tsuBase = salarioComSubsidios * 0.2375;
                        
                        // Calcular custos adicionais mensais
                        const medicinaTrabalhoMensal = incluirMedicinaTrabalho ? valorMedicinaTrabalho / 12 : 0;
                        const seguroAcidentesMensal = incluirSeguroAcidentes ? valorSeguroAcidentes / 12 : 0;
                        
                        const custoTotal = salarioComSubsidios * 1.2375 + subsidioAlimentacaoMensal + medicinaTrabalhoMensal + seguroAcidentesMensal;
                        
                        return (
                          <>
                            {modoSimulador === 'parttime' && (
                              <div className="bg-green-100 border border-green-300 rounded p-2 mb-3">
                                <p className="text-xs font-semibold text-green-900">
                                  ‚è∞ Part-Time: {horasSemanaisPartTime}h/semana ({(proporcaoPartTime * 100).toFixed(0)}%)
                                </p>
                              </div>
                            )}
                            
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between items-center pb-2 border-b border-green-200">
                                <span className="text-gray-700">Sal√°rio mensal base:</span>
                                <span className="font-semibold">‚Ç¨{salarioBase.toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-xs text-gray-600">
                                <span>Subs√≠dio de F√©rias (1/12):</span>
                                <span>‚Ç¨{(salarioBase / 12).toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-xs text-gray-600 pb-2 border-b border-green-200">
                                <span>Subs√≠dio de Natal (1/12):</span>
                                <span>‚Ç¨{(salarioBase / 12).toFixed(2)}</span>
                              </div>
                              
                              {incluirSubsidioAlimentacao && (
                                <div className="flex justify-between items-center text-xs text-blue-700 pb-2 border-b border-green-200">
                                  <span>Subs√≠dio de Alimenta√ß√£o:</span>
                                  <span>‚Ç¨{subsidioAlimentacaoMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              <div className="flex justify-between items-center pb-2 border-b border-green-200">
                                <span className="text-gray-700">Subtotal com subs√≠dios:</span>
                                <span className="font-semibold">‚Ç¨{(salarioComSubsidios + subsidioAlimentacaoMensal).toFixed(2)}</span>
                              </div>
                              
                              <div className="flex justify-between items-center text-orange-700 pb-2 border-b border-green-300">
                                <span className="font-medium">TSU Patronal (23.75%):</span>
                                <span className="font-semibold">‚Ç¨{tsuBase.toFixed(2)}</span>
                              </div>
                              
                              {incluirMedicinaTrabalho && (
                                <div className="flex justify-between items-center text-xs text-purple-700 pt-1">
                                  <span>Medicina no Trabalho:</span>
                                  <span>‚Ç¨{medicinaTrabalhoMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              {incluirSeguroAcidentes && (
                                <div className="flex justify-between items-center text-xs text-purple-700 pb-2 border-b-2 border-green-300">
                                  <span>Seguro Contra Acidentes:</span>
                                  <span>‚Ç¨{seguroAcidentesMensal.toFixed(2)}</span>
                                </div>
                              )}
                              
                              <div className="flex justify-between items-center pt-2">
                                <span className="text-lg font-bold text-green-900">CUSTO TOTAL MENSAL:</span>
                                <span className="text-2xl font-bold text-green-900">
                                  ‚Ç¨{custoTotal.toFixed(2)}
                                </span>
                              </div>
                            </div>
                            
                            <div className="mt-3 pt-3 border-t border-green-300">
                              <div className="text-xs text-green-800 space-y-1">
                                <p>üí° <strong>Custo anual:</strong> ‚Ç¨{(custoTotal * 12).toFixed(2)}</p>
                                <p>üìä <strong>Encargos adicionais:</strong> +{((custoTotal / salarioBase - 1) * 100).toFixed(1)}% sobre sal√°rio base</p>
                              </div>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>
                  
                  {/* Info Box */}
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>‚ÑπÔ∏è O que est√° inclu√≠do:</strong>
                    </p>
                    <ul className="text-xs text-blue-700 mt-2 space-y-1 ml-4">
                      <li>‚Ä¢ <strong>Subs√≠dio de F√©rias</strong>: 1 m√™s de sal√°rio (14¬∫ m√™s) - obrigat√≥rio por lei</li>
                      <li>‚Ä¢ <strong>Subs√≠dio de Natal</strong>: 1 m√™s de sal√°rio (13¬∫ m√™s) - obrigat√≥rio por lei</li>
                      <li>‚Ä¢ <strong>Subs√≠dio de Alimenta√ß√£o</strong>: Opcional (n√£o obrigat√≥rio no setor privado). Isento at√© ‚Ç¨6/dia em dinheiro ou ‚Ç¨10.20/dia em cart√£o</li>
                      <li>‚Ä¢ <strong>TSU Patronal</strong>: 23.75% sobre sal√°rio + subs√≠dios de f√©rias e natal (n√£o incide sobre subs√≠dio alimenta√ß√£o at√© limites isentos)</li>
                      <li>‚Ä¢ <strong>Medicina no Trabalho</strong>: Obrigat√≥rio. Consultas m√©dicas peri√≥dicas para vigil√¢ncia da sa√∫de. M√©dia: ‚Ç¨80-150/ano</li>
                      <li>‚Ä¢ <strong>Seguro Contra Acidentes</strong>: Obrigat√≥rio. Seguro de acidentes de trabalho. M√©dia restaura√ß√£o: ‚Ç¨100-200/ano</li>
                      <li>‚Ä¢ <strong>Nota</strong>: Trabalhador tamb√©m desconta 11% (retido do sal√°rio), mas n√£o est√° inclu√≠do aqui</li>
                    </ul>
                  </div>
                </div>

              </>
            )}
          </div>
        )}


        {activeTab === 'gestao' && (
          <div className="space-y-3">
            {/* Gest√£o Sub-tabs */}
            <div className="backdrop-blur-lg bg-white/60 border border-white/40 rounded-xl shadow-lg">
              <div className="flex border-b overflow-x-auto">
                {[
                  { id: 'ingredientes', label: 'Ingredientes', icon: FileText },
                  { id: 'produtos', label: 'Produtos', icon: Package },
                  { id: 'faturas', label: 'Faturas', icon: FileText },
                  { id: 'vendas', label: 'Vendas', icon: Upload }
                ].map(tab => {
                  const Icon = tab.icon;
                  return (
                    <button key={tab.id} onClick={() => setGestaoSubTab(tab.id)}
                      className={`flex items-center gap-2 px-4 py-2 font-medium text-xs transition ${
                        gestaoSubTab === tab.id ? 'bg-blue-500 text-white' : 'text-gray-600 hover:bg-blue-50'
                      }`}>
                      <Icon size={14} />{tab.label}
                    </button>
                  );
                })}
              </div>
            </div>
            

            {gestaoSubTab === 'ingredientes' && (
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <h2 className="text-lg font-bold mb-3">Ingredientes</h2>
                
                <div className={`rounded p-3 mb-3 border ${editandoIngrediente ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-200'}`}>
                  <h3 className="font-semibold text-xs mb-2">{editandoIngrediente ? 'Editar Ingrediente' : 'Adicionar Ingrediente'}</h3>
                  <div className="grid grid-cols-6 gap-2">
                    <input type="text" placeholder="Nome" value={novoIngrediente.nome}
                      onChange={(e) => {
                        const nome = e.target.value;
                        const catDetectada = detectarCategoria(nome);
                        setNovoIngrediente({ ...novoIngrediente, nome: nome, categoria: catDetectada });
                      }}
                      className="border rounded px-2 py-1.5 text-xs" />
                    <select value={novoIngrediente.categoria || 'outros'}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, categoria: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs"
                      title="Categoria auto-detectada (pode editar)">
                      <option value="vegetais">Vegetais</option>
                      <option value="frutas">Frutas</option>
                      <option value="carnes">Carnes</option>
                      <option value="peixe">Peixe</option>
                      <option value="latic√≠nios">Latic√≠nios</option>
                      <option value="padaria">Padaria</option>
                      <option value="pastelaria">Pastelaria</option>
                      <option value="compotas">Compotas</option>
                      <option value="bebidas">Bebidas</option>
                      <option value="temperos">Temperos</option>
                      <option value="embalagens">Embalagens</option>
                      <option value="limpeza">Limpeza</option>
                      <option value="outros">Outros</option>
                    </select>
                    <select value={novoIngrediente.unidade}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, unidade: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs">
                      <option value="kg">kg</option>
                      <option value="g">g</option>
                      <option value="L">L</option>
                      <option value="ml">ml</option>
                      <option value="un">un</option>
                    </select>
                    <input type="number" step="0.01" placeholder="Custo ‚Ç¨" value={novoIngrediente.custoUnitario}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, custoUnitario: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs" />
                    <select value={novoIngrediente.iva}
                      onChange={(e) => setNovoIngrediente({ ...novoIngrediente, iva: e.target.value })}
                      className="border rounded px-2 py-1.5 text-xs">
                      <option value="6">IVA 6%</option>
                      <option value="13">IVA 13%</option>
                      <option value="23">IVA 23%</option>
                    </select>
                    {editandoIngrediente ? (
                      <div className="flex gap-1">
                        <button onClick={atualizarIngrediente}
                          className="flex-1 bg-yellow-600 text-white rounded px-2 py-1.5 text-xs hover:bg-yellow-700 flex items-center justify-center font-semibold">
                          <Save size={14} />
                        </button>
                        <button onClick={cancelarEdicaoIngrediente}
                          className="bg-gray-400 text-white rounded px-2 py-1.5 text-xs hover:bg-gray-500">
                          X
                        </button>
                      </div>
                    ) : (
                      <button onClick={adicionarIngrediente}
                        className="bg-blue-600 text-white rounded px-3 py-1.5 text-xs hover:bg-blue-700 flex items-center justify-center gap-1 font-semibold">
                        <Plus size={14} />Add
                      </button>
                    )}
                  </div>
                </div>

                {/* Search Bar e Filtro de Categoria */}
                <div className="mb-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar ingrediente..."
                      value={searchIngredienteGlobal}
                      onChange={(e) => setSearchIngredienteGlobal(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {searchIngredienteGlobal && (
                      <button
                        onClick={() => setSearchIngredienteGlobal('')}
                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 font-bold"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                  
                  <select
                    value={categoriaFiltro}
                    onChange={(e) => setCategoriaFiltro(e.target.value)}
                    className="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                  >
                    <option value="todas">üìÅ Todas as Categorias</option>
                    <option value="padaria">üçû Padaria</option>
                    <option value="lacteos">ü•õ Lactic√≠nios</option>
                    <option value="latic√≠nios">üßÄ Latic√≠nios</option>
                    <option value="carnes">ü•© Carnes</option>
                    <option value="peixe">üêü Peixe</option>
                    <option value="vegetais">ü•¨ Vegetais</option>
                    <option value="frutas">üçé Frutas</option>
                    <option value="bebidas">ü•§ Bebidas</option>
                    <option value="cafe">‚òï Caf√©</option>
                    <option value="especiarias">üå∂Ô∏è Especiarias</option>
                    <option value="temperos">üßÇ Temperos</option>
                    <option value="oleos">ü´í √ìleos</option>
                    <option value="cereais">üåæ Cereais</option>
                    <option value="compotas">üçØ Compotas</option>
                    <option value="consumiveis">üß¥ Consum√≠veis</option>
                    <option value="pastelaria">üßÅ Pastelaria</option>
                    <option value="limpeza">üßπ Limpeza</option>
                    <option value="outros">üì¶ Outros</option>
                  </select>
                </div>

                {/* Contador de Resultados e Bot√£o Movimenta√ß√µes */}
                <div className="mb-2 flex items-center justify-between">
                  <div className="text-sm text-gray-600">
                    {(() => {
                      const total = (ingredientes || []).length;
                      const filtrados = (ingredientes || []).filter(ing => {
                        const matchNome = normalizeText(ing.nome).includes(normalizeText(searchIngredienteGlobal));
                        const matchCategoria = categoriaFiltro === 'todas' || ing.categoria === categoriaFiltro;
                        return matchNome && matchCategoria;
                      }).length;
                      
                      if (categoriaFiltro !== 'todas' || searchIngredienteGlobal) {
                        return <p>üìä A mostrar <span className="font-bold">{filtrados}</span> de {total} ingredientes</p>;
                      }
                      return <p>üìä Total: <span className="font-bold">{total}</span> ingredientes</p>;
                    })()}
                  </div>
                  
                  <button
                    onClick={() => setMostrarModalMovimentacoes(true)}
                    className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-xs shadow"
                  >
                    <BarChart3 className="w-4 h-4" />
                    üìä Ver Movimenta√ß√µes
                  </button>
                </div>

                <div className="overflow-x-auto rounded border">
                  <table className="w-full text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left font-semibold">Nome</th>
                        <th className="px-2 py-2 text-left font-semibold">Categoria</th>
                        <th className="px-2 py-2 text-left font-semibold">Unid</th>
                        <th className="px-2 py-2 text-right font-semibold">Custo</th>
                        <th className="px-2 py-2 text-center font-semibold">IVA</th>
                        <th className="px-2 py-2 text-left font-semibold">üì¶ Stock</th>
                        <th className="px-2 py-2 text-left font-semibold">‚ôªÔ∏è Desperd√≠cio</th>
                        <th className="px-2 py-2 text-center font-semibold">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {(() => {
                        const ingredientesFiltrados = (ingredientes || []).filter(ing => {
                          const matchNome = normalizeText(ing.nome).includes(normalizeText(searchIngredienteGlobal));
                          const matchCategoria = categoriaFiltro === 'todas' || ing.categoria === categoriaFiltro;
                          return matchNome && matchCategoria;
                        });
                        
                        if (ingredientesFiltrados.length === 0) {
                          return (
                            <tr>
                              <td colSpan="8" className="px-4 py-8 text-center text-gray-400 text-sm">
                                {categoriaFiltro !== 'todas' 
                                  ? `Nenhum ingrediente encontrado na categoria "${categoriaFiltro}"` 
                                  : 'Nenhum ingrediente encontrado'}
                              </td>
                            </tr>
                          );
                        }
                        
                        return ingredientesFiltrados.map((ing, idx) => (
                        <tr key={ing.id} className={`border-t ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 py-2 font-medium">{ing.nome}</td>
                          <td className="px-2 py-2">
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded">{ing.categoria || 'outros'}</span>
                          </td>
                          <td className="px-2 py-2">{ing.unidade}</td>
                          <td className="px-2 py-2 text-right">
                            <div className="text-xs">
                              <div className="font-bold text-gray-900">‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}</div>
                              {ing.custoUnitario && ing.iva && (
                                <div className="text-gray-500 text-[10px]">
                                  s/IVA: ‚Ç¨{(ing.custoUnitario / (1 + ing.iva / 100)).toFixed(2)}
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">{ing.iva}%</span>
                          </td>
                          <td className="px-2 py-2">
                            {(() => {
                              const status = getStockStatus(ing);
                              const editandoEste = ingredienteEditandoMin === ing.id;
                              
                              return (
                                <div className="space-y-1">
                                  {/* ALERTA INLINE se stock cr√≠tico/baixo */}
                                  {(status.status === 'CRITICO' || status.status === 'BAIXO') && (
                                    <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${
                                      status.status === 'CRITICO' 
                                        ? 'bg-red-100 text-red-700' 
                                        : 'bg-orange-100 text-orange-700'
                                    }`}>
                                      {status.status === 'CRITICO' ? 'üî¥ CR√çTICO!' : 'üü† BAIXO'}
                                    </div>
                                  )}
                                  
                                  <div className="flex items-center gap-1">
                                    <span className="text-base">{status.icone}</span>
                                    <div className="flex-1">
                                      <p className="text-xs font-semibold">{ing.stockAtual || 0} {ing.unidade}</p>
                                      {editandoEste ? (
                                        <div className="flex items-center gap-1 mt-0.5">
                                          <input
                                            type="number"
                                            step="0.1"
                                            value={valorMinEdicao}
                                            onChange={(e) => setValorMinEdicao(e.target.value)}
                                            className="w-12 px-1 py-0 text-[10px] border rounded"
                                            autoFocus
                                            onKeyPress={(e) => {
                                              if (e.key === 'Enter') {
                                                const val = parseFloat(valorMinEdicao) || 0;
                                                setIngredientes(ingredientes.map(i => 
                                                  i.id === ing.id ? {...i, stockMinimo: val} : i
                                                ));
                                                showNotification(`Stock m√≠nimo atualizado para ${val}`, 'success');
                                                setIngredienteEditandoMin(null);
                                              }
                                            }}
                                          />
                                          <button
                                            onClick={() => {
                                              const val = parseFloat(valorMinEdicao) || 0;
                                              setIngredientes(ingredientes.map(i => 
                                                i.id === ing.id ? {...i, stockMinimo: val} : i
                                              ));
                                              showNotification(`Stock m√≠nimo atualizado`, 'success');
                                              setIngredienteEditandoMin(null);
                                            }}
                                            className="text-green-600 hover:text-green-800 text-xs"
                                            title="Salvar"
                                          >
                                            ‚úì
                                          </button>
                                          <button
                                            onClick={() => {
                                              setIngredienteEditandoMin(null);
                                            }}
                                            className="text-red-600 hover:text-red-800 text-xs"
                                            title="Cancelar"
                                          >
                                            ‚úï
                                          </button>
                                        </div>
                                      ) : (
                                        <button
                                          onClick={() => {
                                            setIngredienteEditandoMin(ing.id);
                                            setValorMinEdicao(ing.stockMinimo || 0);
                                          }}
                                          className="text-[10px] text-gray-500 hover:text-blue-600 hover:underline"
                                          title="Clica para editar stock m√≠nimo"
                                        >
                                          Min: {ing.stockMinimo || 0} ‚úèÔ∏è
                                        </button>
                                      )}
                                    </div>
                                  </div>
                                  <button
                                    onClick={() => abrirContagem(ing)}
                                    className="text-[10px] px-2 py-0.5 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded font-semibold w-full"
                                    title="Fazer contagem de stock"
                                  >
                                    üìä Contar
                                  </button>
                                </div>
                              );
                            })()}
                          </td>
                          <td className="px-2 py-2">
                            {(() => {
                              const analise = calcularDesperdicio(ing);
                              if (!analise || !analise.temDados || movimentacoesStock.length === 0) {
                                return <span className="text-gray-400 text-xs">-</span>;
                              }
                              
                              return (
                                <div>
                                  <div className={`font-bold text-sm ${
                                    analise.percentualDesperdicio > 25 ? 'text-red-600' :
                                    analise.percentualDesperdicio > 15 ? 'text-orange-600' :
                                    analise.percentualDesperdicio > 10 ? 'text-yellow-600' :
                                    'text-green-600'
                                  }`}>
                                    {analise.percentualDesperdicio.toFixed(1)}%
                                  </div>
                                  <div className="text-xs text-gray-500">
                                    Te√≥rico: {analise.stockTeorico.toFixed(1)} {ing.unidade}
                                  </div>
                                </div>
                              );
                            })()}
                          </td>
                          <td className="px-2 py-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button onClick={() => editarIngrediente(ing)}
                                className="text-yellow-600 hover:bg-yellow-50 p-1 rounded">
                                <Edit2 size={14} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar?')) {
                                  setIngredientes(ingredientes.filter(i => i.id !== ing.id));
                                  showNotification('Eliminado!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1 rounded">
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ));
                      })()}
                    </tbody>
                  </table>
                </div>
                {!(ingredientes || []).length && <p className="text-center text-gray-400 py-6 text-xs">Nenhum ingrediente</p>}
              </div>
            )}

            {gestaoSubTab === 'produtos' && (
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <h2 className="text-lg font-bold mb-3">Produtos & Fichas T√©cnicas</h2>
                
                {/* Add Product Form */}
                <div className={`rounded p-3 mb-3 border ${editandoProduto ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-200'}`}>
                  <h3 className="font-semibold text-sm mb-2">{editandoProduto ? 'Editar Produto' : 'Adicionar Produto'}</h3>
                  <div className="space-y-3">
                    <div className="grid grid-cols-5 gap-2">
                      <input type="text" placeholder="Nome do produto" value={novoProduto.nome}
                        onChange={(e) => setNovoProduto({ ...novoProduto, nome: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm" />
                      <input type="number" step="0.01" placeholder="Pre√ßo ‚Ç¨" value={novoProduto.precoVenda}
                        onChange={(e) => setNovoProduto({ ...novoProduto, precoVenda: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm" />
                      <select value={novoProduto.iva}
                        onChange={(e) => setNovoProduto({ ...novoProduto, iva: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm">
                        <option value="6">IVA 6%</option>
                        <option value="13">IVA 13%</option>
                        <option value="23">IVA 23%</option>
                      </select>
                      <select value={novoProduto.categoria || 'cafes'}
                        onChange={(e) => setNovoProduto({ ...novoProduto, categoria: e.target.value })}
                        className="border rounded px-2 py-1.5 text-sm">
                        <option value="cafes">‚òï Caf√©s</option>
                        <option value="bebidas">ü•§ Bebidas</option>
                        <option value="pratos">üçΩÔ∏è Pratos</option>
                        <option value="sobremesas">üç∞ Sobremesas</option>
                        <option value="lanches">ü•™ Lanches</option>
                        <option value="outros">üì¶ Outros</option>
                      </select>
                      <input
                        type="number"
                        min="1"
                        value={novoProduto.porcoes || 1}
                        onChange={(e) => setNovoProduto({...novoProduto, porcoes: parseInt(e.target.value) || 1})}
                        placeholder="N¬∫ Por√ß√µes"
                        title="N¬∫ Por√ß√µes (para bolos/sobremesas)"
                        className="border rounded px-2 py-1.5 text-sm"
                      />
                    </div>
                    
                    {(ingredientes || []).length > 0 && (
                      <div className="border rounded p-2 bg-white">
                        <p className="font-medium mb-2 text-xs flex items-center gap-1">
                          <FileText size={14} />Receita (Ingredientes):
                        </p>
                        
                        {/* Search bar - SEM √≠cone overlay! */}
                        <div className="relative mb-2">
                          <input 
                            type="text" 
                            placeholder="üîç Procurar ingrediente..." 
                            value={searchIngrediente}
                            onChange={(e) => {
                              setSearchIngrediente(e.target.value);
                              setShowIngredienteSuggestions(e.target.value.length > 0);
                            }}
                            onFocus={() => setShowIngredienteSuggestions(searchIngrediente.length > 0)}
                            className="w-full px-3 py-1.5 border rounded text-sm focus:border-green-500 focus:ring-1 focus:ring-green-200"
                          />
                          
                          {/* Suggestions dropdown */}
                          {showIngredienteSuggestions && searchIngrediente && searchIngrediente.length > 0 && (
                            <div className="absolute z-10 w-full bg-white border rounded shadow-lg mt-1 max-h-40 overflow-y-auto">
                              {ingredientes
                                .filter(ing => 
                                  normalizeText(ing.nome).includes(normalizeText(searchIngrediente)) &&
                                  !novoProduto.receita.find(r => r.ingredienteId === ing.id)
                                )
                                .map(ing => (
                                  <button
                                    key={ing.id}
                                    type="button"
                                    onClick={() => {
                                      setNovoProduto({ 
                                        ...novoProduto, 
                                        receita: [...novoProduto.receita, { ingredienteId: ing.id, quantidade: 0, unidade: ing.unidade }] 
                                      });
                                      setSearchIngrediente('');
                                      setShowIngredienteSuggestions(false);
                                    }}
                                    className="w-full text-left px-3 py-2 hover:bg-green-50 flex justify-between items-center text-sm border-b last:border-b-0"
                                  >
                                    <span className="font-medium">{ing.nome}</span>
                                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
                                      ‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}/{ing.unidade}
                                    </span>
                                  </button>
                                ))}
                              {ingredientes.filter(ing => 
                                normalizeText(ing.nome).includes(normalizeText(searchIngrediente)) &&
                                !novoProduto.receita.find(r => r.ingredienteId === ing.id)
                              ).length === 0 && (
                                <div className="px-3 py-4 text-gray-400 text-center text-xs">
                                  Nenhum ingrediente encontrado
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* Selected ingredients */}
                        <div className="space-y-1">
                          {(novoProduto.receita || []).map((item, idx) => {
                            const ing = ingredientes.find(i => i.id === item.ingredienteId);
                            if (!ing) return null;
                            
                            return (
                              <div key={idx} className="flex items-center gap-2 bg-green-50 p-1.5 rounded border border-green-200">
                                <span className="text-xs font-medium flex-1">{ing.nome}</span>
                                <input 
                                  type="number" 
                                  step="0.01" 
                                  placeholder="Qtd"
                                  value={item.quantidade || ''}
                                  onChange={(e) => {
                                    const newReceita = [...novoProduto.receita];
                                    newReceita[idx].quantidade = parseFloat(e.target.value) || 0;
                                    setNovoProduto({ ...novoProduto, receita: newReceita });
                                  }}
                                  className="border rounded px-2 py-1 text-xs w-20" 
                                />
                                <select
                                  value={item.unidade || ing.unidade}
                                  onChange={(e) => {
                                    const newReceita = [...novoProduto.receita];
                                    newReceita[idx].unidade = e.target.value;
                                    setNovoProduto({ ...novoProduto, receita: newReceita });
                                  }}
                                  className="border rounded px-1 py-1 text-xs w-14"
                                >
                                  <option value="kg">kg</option>
                                  <option value="g">g</option>
                                  <option value="L">L</option>
                                  <option value="ml">ml</option>
                                  <option value="un">un</option>
                                </select>
                                <button
                                  type="button"
                                  onClick={() => {
                                    setNovoProduto({ 
                                      ...novoProduto, 
                                      receita: novoProduto.receita.filter((_, i) => i !== idx) 
                                    });
                                  }}
                                  className="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            );
                          })}
                          {novoProduto.receita.length === 0 && (
                            <p className="text-center text-gray-400 italic py-2 text-xs">
                              Nenhum ingrediente adicionado. Use a pesquisa acima.
                            </p>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {editandoProduto ? (
                      <div className="flex gap-2">
                        <button onClick={atualizarProduto}
                          className="flex-1 bg-yellow-600 text-white rounded px-4 py-2 text-sm hover:bg-yellow-700 flex items-center justify-center gap-2 font-semibold">
                          <Save size={16} />Atualizar Produto
                        </button>
                        <button onClick={cancelarEdicaoProduto}
                          className="bg-gray-400 text-white rounded px-4 py-2 text-sm hover:bg-gray-500 font-semibold">
                          Cancelar
                        </button>
                      </div>
                    ) : (
                      <button onClick={adicionarProduto}
                        className="w-full bg-green-600 text-white rounded px-4 py-2 text-sm hover:bg-green-700 flex items-center justify-center gap-2 font-semibold">
                        <Plus size={16} />Adicionar Produto
                      </button>
                    )}
                  </div>
                </div>

                {/* Search Bar Produtos */}
                <div className="mb-3">
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="üîç Procurar produto..."
                      value={searchProdutoGlobal}
                      onChange={(e) => setSearchProdutoGlobal(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                    {searchProdutoGlobal && (
                      <button
                        onClick={() => setSearchProdutoGlobal('')}
                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 font-bold"
                      >
                        ‚úï
                      </button>
                    )}
                  </div>
                </div>

                {/* Products List */}
                <div className="space-y-2">
                  {produtos.filter(p => 
                    p.nome.toLowerCase().includes(searchProdutoGlobal.toLowerCase())
                  ).map((p) => {
                    const { custo, margem, margemPercentual } = calcMargem(p);
                    const isExpanded = expandedProduct === p.id;
                    
                    return (
                      <div key={p.id} className="border rounded overflow-hidden hover:shadow transition bg-white">
                        <div className="p-3">
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <h3 className="font-bold text-base">{p.nome}</h3>
                              <p className="text-xs text-gray-600">
                                Pre√ßo: <span className="font-semibold text-blue-600">‚Ç¨{p.precoVenda.toFixed(2)}</span>
                                <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                                  IVA {p.iva}%
                                </span>
                                {(() => {
                                  const categoriaInfo = {
                                    'cafes': { emoji: '‚òï', label: 'Caf√©s', cor: 'brown' },
                                    'bebidas': { emoji: 'ü•§', label: 'Bebidas', cor: 'blue' },
                                    'pratos': { emoji: 'üçΩÔ∏è', label: 'Pratos', cor: 'orange' },
                                    'sobremesas': { emoji: 'üç∞', label: 'Sobremesas', cor: 'pink' },
                                    'lanches': { emoji: 'ü•™', label: 'Lanches', cor: 'yellow' },
                                    'outros': { emoji: 'üì¶', label: 'Outros', cor: 'gray' }
                                  };
                                  const cat = categoriaInfo[p.categoria] || categoriaInfo['outros'];
                                  return (
                                    <span className={`ml-2 px-2 py-0.5 bg-${cat.cor}-100 text-${cat.cor}-700 rounded text-xs font-semibold`}>
                                      {cat.emoji} {cat.label}
                                    </span>
                                  );
                                })()}
                                {p.porcoes && p.porcoes > 1 && (
                                  <span className="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-semibold">
                                    üç∞ {p.porcoes} por√ß√µes
                                  </span>
                                )}
                                {p.receita && p.receita.some(r => {
                                  const ing = ingredientes.find(i => i.id == r.ingredienteId);
                                  return ing && ing.categoria === 'embalagens';
                                }) && (
                                  <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold">
                                    üì¶ Take-Away
                                  </span>
                                )}
                              </p>
                            </div>
                            <div className="flex gap-1">
                              {p.receita && p.receita.length > 0 && (
                                <button 
                                  onClick={() => setExpandedProduct(isExpanded ? null : p.id)}
                                  className="text-blue-600 hover:bg-blue-50 p-1.5 rounded transition"
                                  title={isExpanded ? "Ocultar receita" : "Ver receita"}
                                >
                                  {isExpanded ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                                </button>
                              )}
                              <button onClick={() => editarProduto(p)}
                                className="text-yellow-600 hover:bg-yellow-50 p-1.5 rounded transition">
                                <Edit2 size={18} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar este produto?')) {
                                  setProdutos(produtos.filter(x => x.id !== p.id));
                                  showNotification('Produto eliminado!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1.5 rounded transition">
                                <Trash2 size={18} />
                              </button>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-3 gap-2">
                            <div className="bg-red-50 rounded p-2 border border-red-200">
                              <p className="text-xs text-red-700 mb-0.5">Custo</p>
                              <p className="font-bold text-sm text-red-800">‚Ç¨{custo.toFixed(2)}</p>
                            </div>
                            <div className="bg-green-50 rounded p-2 border border-green-200 relative group">
                              <p className="text-xs text-green-700 mb-0.5">
                                Margem 
                                <span className="ml-1 text-gray-400 cursor-help">‚ÑπÔ∏è</span>
                              </p>
                              <p className="font-bold text-sm text-green-800">‚Ç¨{margem.toFixed(2)}</p>
                              
                              {/* Tooltip com breakdown do c√°lculo */}
                              <div className="absolute left-0 top-full mt-1 bg-gray-900 text-white text-xs rounded p-2 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 whitespace-nowrap">
                                <div className="font-semibold mb-1 border-b border-gray-600 pb-1">C√°lculo da Margem:</div>
                                <div>PVP: ‚Ç¨{p.precoVenda.toFixed(2)}</div>
                                <div className="text-gray-400">- IVA ({p.iva}%): ‚Ç¨{(p.precoVenda - p.precoVenda / (1 + p.iva / 100)).toFixed(2)}</div>
                                <div className="border-t border-gray-600 pt-1 mt-1">= Pre√ßo s/IVA: ‚Ç¨{(p.precoVenda / (1 + p.iva / 100)).toFixed(2)}</div>
                                <div className="text-red-300">- Custo: ‚Ç¨{custo.toFixed(2)}</div>
                                <div className="border-t border-gray-600 pt-1 mt-1 font-bold text-green-300">= Margem: ‚Ç¨{margem.toFixed(2)}</div>
                              </div>
                            </div>
                            <div className={`rounded p-2 border ${
                              margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                ? 'bg-green-100 border-green-300'
                                : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                  ? 'bg-yellow-100 border-yellow-300'
                                  : 'bg-red-100 border-red-300'
                            }`}>
                              <p className={`text-xs mb-0.5 ${
                                margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                  ? 'text-green-700'
                                  : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                    ? 'text-yellow-700'
                                    : 'text-red-700'
                              }`}>
                                Margem % {margemPercentual < (configuracoes?.alertas?.margemCritica || 55) ? '‚ö†Ô∏è' : ''}
                              </p>
                              <p className={`font-bold text-sm ${
                                margemPercentual >= (configuracoes?.alertas?.margemBaixa || 70)
                                  ? 'text-green-800'
                                  : margemPercentual >= (configuracoes?.alertas?.margemCritica || 55)
                                    ? 'text-yellow-800'
                                    : 'text-red-800'
                              }`}>
                                {margemPercentual.toFixed(1)}%
                              </p>
                            </div>
                          </div>
                          
                          {margemPercentual < (configuracoes?.alertas?.margemCritica || 55) && (
                            <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                              <p className="text-xs text-red-700 font-semibold">
                                ‚ö†Ô∏è Margem abaixo de {configuracoes?.alertas?.margemCritica || 55}% - A√ß√£o sugerida: rever pre√ßo ou receita
                              </p>
                            </div>
                          )}
                          
                          {isExpanded && p.receita && p.receita.length > 0 && (
                            <div className="mt-3 pt-3 border-t">
                              <p className="text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                <FileText size={12} />Ingredientes da Receita:
                              </p>
                              <div className="space-y-1">
                                {(p.receita || []).map((item, idx) => {
                                  const ing = ingredientes.find(i => i.id === item.ingredienteId);
                                  if (!ing) return null;
                                  const custoParcial = (() => {
                                    let q = item.quantidade;
                                    const unidadeReceita = item.unidade || ing.unidade;
                                    if (ing.unidade === 'kg' && unidadeReceita === 'g') q = item.quantidade / 1000;
                                    if (ing.unidade === 'L' && unidadeReceita === 'ml') q = item.quantidade / 1000;
                                    if (ing.unidade === 'g' && unidadeReceita === 'kg') q = item.quantidade * 1000;
                                    if (ing.unidade === 'ml' && unidadeReceita === 'L') q = item.quantidade * 1000;
                                    if (unidadeReceita === ing.unidade) q = item.quantidade;
                                    return q * ing.custoUnitario;
                                  })();
                                  
                                  return (
                                    <div key={idx} className="flex justify-between items-center text-xs bg-gray-50 p-2 rounded">
                                      <span className="font-medium text-gray-800">{ing.nome}</span>
                                      <div className="flex items-center gap-3">
                                        <span className="text-gray-600">{item.quantidade} {item.unidade || ing.unidade}</span>
                                        <span className="font-semibold text-blue-600">‚Ç¨{custoParcial.toFixed(2)}</span>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}

                </div>
              </div>
            )}

            {gestaoSubTab === 'faturas' && (
              <div className="bg-white rounded-lg shadow p-4">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                  üõí Gest√£o de Compras
                </h2>
                
                {/* Formul√°rio Nova Compra/Editar */}
                <div className={`rounded-lg p-4 mb-4 border-2 ${editandoFatura ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-300'}`}>
                  <div className="mb-3">
                    <h3 className="font-semibold text-sm flex items-center gap-2">
                      {editandoFatura ? '‚úèÔ∏è Editar Fatura' : '‚ûï Nova Fatura'}
                    </h3>
                  </div>
                  
                  {/* Bot√£o OCR Unificado com Escolha de M√©todo */}
                  <div className="mb-4 p-3 bg-gradient-to-r from-purple-50 to-green-50 border-2 border-purple-300 rounded-lg">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìÑ Ler Fatura Automaticamente (OCR)
                    </label>
                    
                    {/* Grid de Bot√µes */}
                    <div className="grid grid-cols-2 gap-2">
                      {/* Bot√£o Tesseract (Local) */}
                      <div>
                        <input
                          type="file"
                          accept=".pdf,image/*"
                          onChange={handleLerPDFAutomatico}
                          className="hidden"
                          id="pdf-ocr-input"
                          disabled={processandoOCR}
                        />
                        <label
                          htmlFor="pdf-ocr-input"
                          className={`block ${
                            processandoOCR 
                              ? 'bg-gray-400 cursor-not-allowed' 
                              : 'bg-purple-600 hover:bg-purple-700 cursor-pointer'
                          } text-white px-3 py-2 rounded-lg font-semibold text-center transition text-sm`}
                        >
                          üì∏ OCR Local
                        </label>
                        <p className="text-xs text-gray-500 mt-1 text-center">R√°pido</p>
                      </div>
                      
                      {/* Bot√£o Google Drive OCR */}
                      {driveAccessToken ? (
                        <div>
                          <button
                            onClick={handleImportarDriveComOCR}
                            disabled={processandoOCR}
                            className={`w-full ${
                              processandoOCR 
                                ? 'bg-gray-400 cursor-not-allowed' 
                                : 'bg-green-600 hover:bg-green-700 cursor-pointer'
                            } text-white px-3 py-2 rounded-lg font-semibold text-center transition text-sm`}
                          >
                            ‚ö° Google OCR
                          </button>
                          <p className="text-xs text-gray-500 mt-1 text-center">Melhor qualidade</p>
                        </div>
                      ) : (
                        <div>
                          <button
                            onClick={() => setActiveTab('definicoes')}
                            className="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg font-semibold text-center transition text-sm"
                          >
                            üîå Conectar Drive
                          </button>
                          <p className="text-xs text-gray-500 mt-1 text-center">Para Google OCR</p>
                        </div>
                      )}
                    </div>
                    
                    {/* Status */}
                    {processandoOCR && (
                      <div className="mt-2 flex items-center justify-center gap-2 text-sm text-gray-600">
                        <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                        </svg>
                        <span>{progressoOCR || 'Processando...'}</span>
                      </div>
                    )}
                  </div>
                  
                  {/* Formul√°rio Fatura */}
                  <>
                      {/* Linha 1: N√∫mero, Data, Fornecedor */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            N√∫mero Fatura *
                          </label>
                          <input
                            type="text"
                            value={novaFatura.numero}
                            onChange={(e) => setNovaFatura({...novaFatura, numero: e.target.value})}
                            placeholder="F/2025/001"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            Data *
                          </label>
                          <input
                            type="date"
                            value={novaFatura.data}
                            onChange={(e) => setNovaFatura({...novaFatura, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Campo Fornecedor - N√ÉO aparece para Sal√°rios */}
                        {novaFatura.categoria !== 'salarios' && (
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Fornecedor *
                            </label>
                            <select
                              value={novaFatura.fornecedorId}
                              onChange={(e) => setNovaFatura({...novaFatura, fornecedorId: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="">Selecionar fornecedor...</option>
                              {(fornecedores || []).map(f => (
                                <option key={f.id || f} value={f.id || f}>
                                  {f.nome || f} {f.nif ? `(NIF: ${f.nif})` : ''}
                                </option>
                              ))}
                            </select>
                          </div>
                        )}
                      </div>
                      
                      {/* Linha 2: Categoria, Ingrediente (se categoria=compras) e Criar Novo */}
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">
                            Categoria *
                          </label>
                          <select
                            value={novaFatura.categoria}
                            onChange={(e) => setNovaFatura({...novaFatura, categoria: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="compras">üõí Compras</option>
                            <option value="renda">üè† Renda</option>
                            <option value="eletricidade">üí° Eletricidade</option>
                            <option value="agua">üíß √Ågua</option>
                            <option value="gas">üî• G√°s</option>
                            <option value="internet">üåê Internet/Telefone</option>
                            <option value="salarios">üë• Sal√°rios</option>
                            <option value="marketing">üì¢ Marketing</option>
                            <option value="consumiveis">üßª Consum√≠veis</option>
                            <option value="manutencao">üîß Manuten√ß√£o</option>
                            <option value="outros">üì¶ Outros</option>
                          </select>
                          <p className="text-xs text-blue-600 mt-1">
                            ‚ÑπÔ∏è Todas as categorias com IVA s√£o dedut√≠veis (incluindo renda de im√≥veis comerciais)
                          </p>
                        </div>
                        
                        {/* Campo Ingrediente - s√≥ aparece quando categoria = compras */}
                        {novaFatura.categoria === 'compras' && !criandoIngrediente && (
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Ingrediente *
                            </label>
                            <div className="relative">
                              <input
                                type="text"
                                value={searchIngredienteFatura}
                                onChange={(e) => {
                                  setSearchIngredienteFatura(e.target.value);
                                  setShowDropdownIngrediente(true);
                                }}
                                onFocus={() => setShowDropdownIngrediente(true)}
                                placeholder="üîç Pesquisar ingrediente..."
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                              />
                              
                              {/* Dropdown de Resultados */}
                              {showDropdownIngrediente && (
                                <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                  {ingredientes
                                    .filter(ing => !searchIngredienteFatura || normalizeText(ing.nome).includes(normalizeText(searchIngredienteFatura)))
                                    .map(ing => (
                                      <div
                                        key={ing.id}
                                        onClick={() => {
                                          setItemFatura({
                                            ...itemFatura,
                                            ingredienteId: ing.id,
                                            quantidade: '1',
                                            unidade: ing.unidade,
                                            precoTotal: ing.custoUnitario.toString(),
                                            iva: ing.iva.toString()
                                          });
                                          setSearchIngredienteFatura(ing.nome);
                                          setShowDropdownIngrediente(false);
                                        }}
                                        className="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                      >
                                        <div className="font-medium text-sm">{ing.nome}</div>
                                        <div className="text-xs text-gray-600">
                                          ‚Ç¨{(ing.custoUnitario || ing.preco || 0).toFixed(2)}/{ing.unidade} ‚Ä¢ IVA {ing.iva}%
                                        </div>
                                      </div>
                                    ))}
                                  
                                  {/* Nenhum resultado */}
                                  {ingredientes.filter(ing => !searchIngredienteFatura || normalizeText(ing.nome).includes(normalizeText(searchIngredienteFatura))).length === 0 && (
                                    <div className="px-3 py-4 text-center text-gray-500 text-sm">
                                      {searchIngredienteFatura ? 'Nenhum ingrediente encontrado' : 'Nenhum ingrediente criado ainda'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                        
                        {/* Bot√£o Criar Novo - s√≥ aparece quando categoria = compras */}
                        {novaFatura.categoria === 'compras' && !criandoIngrediente && (
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              &nbsp;
                            </label>
                            <button
                              type="button"
                              onClick={() => {
                                setNovoIngrediente({ 
                                  ...novoIngrediente, 
                                  nome: searchIngredienteFatura,
                                  iva: itemFatura.iva || '6',
                                  precoTotal: itemFatura.precoTotal || '',
                                  quantidade: itemFatura.quantidade || '1'
                                });
                                setCriandoIngrediente(true);
                              }}
                              className="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold flex items-center justify-center gap-2"
                            >
                              <Plus size={16} /> Criar Novo
                            </button>
                          </div>
                        )}

                      </div>
                      
                      {/* Items da Fatura */}
                      <div className="border-t border-gray-200 pt-3 mb-3">
                        <h4 className="font-semibold text-sm mb-2">Items da Fatura:</h4>
                        
                        {/* Adicionar Item */}
                        <div className="bg-white rounded-lg border border-gray-300 p-3 mb-3">
                          {/* MODO COMPRAS - Com ingrediente */}
                          {novaFatura.categoria === 'compras' && (
                            <>
                              {/* Form Inline para Criar Ingrediente */}
                              {criandoIngrediente && (
                                  <div className="bg-green-50 border border-green-200 rounded-lg p-3 space-y-2">
                                    <div className="flex items-center justify-between mb-2">
                                      <h5 className="font-semibold text-sm text-green-800">‚ú® Criar Novo Ingrediente</h5>
                                      <button
                                        onClick={() => {
                                          setCriandoIngrediente(false);
                                          setSearchIngredienteFatura('');
                                          setNovoIngrediente({ nome: '', unidade: 'kg', custoUnitario: '', iva: '6', quantidade: '1', categoria: 'outros', precoTotal: '', quantidadeEmbalagem: '' });
                                        }}
                                        className="text-gray-500 hover:text-gray-700"
                                      >
                                        <X size={16} />
                                      </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Nome *</label>
                                        <input
                                          type="text"
                                          value={novoIngrediente.nome}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, nome: e.target.value})}
                                          placeholder="Ex: Pink Punk Party"
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        />
                                      </div>
                                      
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Unidade *</label>
                                        <select
                                          value={novoIngrediente.unidade}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, unidade: e.target.value})}
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        >
                                          <option value="kg">kg</option>
                                          <option value="g">g</option>
                                          <option value="L">L (litro)</option>
                                          <option value="ml">ml</option>
                                          <option value="un">unidade</option>
                                        </select>
                                      </div>
                                      
                                      {/* NOVA SEC√á√ÉO: Pre√ßo Total e Quantidade na Embalagem */}
                                      <div className="col-span-2 bg-blue-50 border-2 border-blue-300 rounded-lg p-3 space-y-2">
                                        <div className="flex items-center gap-2 mb-2">
                                          <h6 className="font-semibold text-sm text-blue-800">üì¶ M√©todo Pr√°tico (Recomendado)</h6>
                                        </div>
                                        <p className="text-xs text-blue-700 mb-2">
                                          Insira o pre√ßo total da embalagem e quantas unidades v√™m dentro. O custo unit√°rio ser√° calculado automaticamente!
                                        </p>
                                        
                                        <div className="grid grid-cols-2 gap-2">
                                          <div>
                                            <label className="block text-xs font-medium text-blue-800 mb-1">Pre√ßo Total da Embalagem (‚Ç¨)</label>
                                            <input
                                              type="number"
                                              step="0.01"
                                              value={novoIngrediente.precoTotal}
                                              onChange={(e) => setNovoIngrediente({...novoIngrediente, precoTotal: e.target.value})}
                                              placeholder="21.29"
                                              className="w-full px-2 py-1.5 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white"
                                            />
                                            <p className="text-xs text-blue-600 mt-0.5">Ex: ‚Ç¨21.29 (total na fatura)</p>
                                          </div>
                                          
                                          <div>
                                            <label className="block text-xs font-medium text-blue-800 mb-1">Qtd. de Unidades na Embalagem</label>
                                            <input
                                              type="number"
                                              step="1"
                                              value={novoIngrediente.quantidadeEmbalagem}
                                              onChange={(e) => setNovoIngrediente({...novoIngrediente, quantidadeEmbalagem: e.target.value})}
                                              placeholder="12"
                                              className="w-full px-2 py-1.5 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-500 bg-white"
                                            />
                                            <p className="text-xs text-blue-600 mt-0.5">Ex: 12 (cervejas na caixa)</p>
                                          </div>
                                        </div>
                                        
                                        {/* Preview do c√°lculo autom√°tico */}
                                        {novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem && (
                                          <div className="bg-white border border-blue-400 rounded p-2 mt-2">
                                            <div className="flex justify-between items-center">
                                              <span className="text-xs font-medium text-gray-600">üí° Custo Unit√°rio Calculado:</span>
                                              <span className="text-sm font-bold text-green-600">
                                                ‚Ç¨{(parseFloat(novoIngrediente.precoTotal) / parseFloat(novoIngrediente.quantidadeEmbalagem)).toFixed(3)}/{novoIngrediente.unidade}
                                              </span>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">
                                              ‚Ç¨{novoIngrediente.precoTotal} √∑ {novoIngrediente.quantidadeEmbalagem} {novoIngrediente.unidade} = ‚Ç¨{(parseFloat(novoIngrediente.precoTotal) / parseFloat(novoIngrediente.quantidadeEmbalagem)).toFixed(3)}/{novoIngrediente.unidade}
                                            </p>
                                          </div>
                                        )}
                                      </div>
                                      
                                      {/* Divisor OU */}
                                      <div className="col-span-2 flex items-center gap-2 my-1">
                                        <div className="flex-1 border-t border-gray-300"></div>
                                        <span className="text-xs text-gray-500 font-medium">OU</span>
                                        <div className="flex-1 border-t border-gray-300"></div>
                                      </div>
                                      
                                      {/* M√âTODO ALTERNATIVO: Custo Unit√°rio Direto */}
                                      <div className="col-span-2 bg-gray-50 border border-gray-300 rounded-lg p-3">
                                        <h6 className="font-semibold text-xs text-gray-700 mb-2">üìä M√©todo Alternativo</h6>
                                        <p className="text-xs text-gray-600 mb-2">Ou insira diretamente o custo unit√°rio se j√° o conhecer:</p>
                                        
                                        <div>
                                          <label className="block text-xs font-medium text-gray-700 mb-1">
                                            Custo Unit√°rio (‚Ç¨/{novoIngrediente.unidade === 'g' ? 'kg' : novoIngrediente.unidade === 'ml' ? 'L' : novoIngrediente.unidade})
                                          </label>
                                          <input
                                            type="number"
                                            step="0.001"
                                            value={novoIngrediente.custoUnitario}
                                            onChange={(e) => setNovoIngrediente({...novoIngrediente, custoUnitario: e.target.value})}
                                            placeholder="1.77"
                                            className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-gray-400"
                                            disabled={novoIngrediente.precoTotal && novoIngrediente.quantidadeEmbalagem}
                                          />
                                          <p className="text-xs text-gray-500 mt-0.5">
                                            {novoIngrediente.unidade === 'g' && '(pre√ßo por kg, mesmo comprando em g)'}
                                            {novoIngrediente.unidade === 'ml' && '(pre√ßo por L, mesmo comprando em ml)'}
                                            {novoIngrediente.unidade === 'kg' && '(pre√ßo por kg)'}
                                            {novoIngrediente.unidade === 'L' && '(pre√ßo por litro)'}
                                            {novoIngrediente.unidade === 'un' && '(pre√ßo por unidade)'}
                                          </p>
                                        </div>
                                      </div>
                                      
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">IVA *</label>
                                        <select
                                          value={novoIngrediente.iva}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, iva: e.target.value})}
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        >
                                          <option value="6">6%</option>
                                          <option value="13">13%</option>
                                          <option value="23">23%</option>
                                        </select>
                                      </div>
                                      
                                      <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Categoria *</label>
                                        <select
                                          value={novoIngrediente.categoria}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, categoria: e.target.value})}
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        >
                                          <option value="bebidas">Bebidas</option>
                                          <option value="cafe">Caf√©</option>
                                          <option value="lacteos">Latic√≠nios</option>
                                          <option value="padaria">Padaria</option>
                                          <option value="carnes">Carnes</option>
                                          <option value="vegetais">Vegetais</option>
                                          <option value="embalagens">Embalagens</option>
                                          <option value="consumiveis">Consum√≠veis</option>
                                          <option value="outros">Outros</option>
                                        </select>
                                      </div>
                                      
                                      {/* Quantidade para fatura (opcional) */}
                                      <div className="col-span-2 border-t border-gray-200 pt-2 mt-1">
                                        <label className="block text-xs font-medium text-gray-700 mb-1">
                                          Quantidade Comprada (para esta fatura)
                                        </label>
                                        <input
                                          type="number"
                                          step="0.01"
                                          value={novoIngrediente.quantidade || '1'}
                                          onChange={(e) => setNovoIngrediente({...novoIngrediente, quantidade: e.target.value})}
                                          placeholder="12"
                                          className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                        />
                                        <p className="text-xs text-gray-500 mt-0.5">
                                          Quantas {novoIngrediente.unidade === 'un' ? 'unidades' : novoIngrediente.unidade} comprou nesta fatura?
                                        </p>
                                      </div>
                                    </div>
                                    
                                    <button
                                      onClick={criarIngredienteInline}
                                      className="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-semibold"
                                    >
                                      ‚ú® Criar e Adicionar √† Fatura
                                    </button>
                                  </div>
                              )}
                              
                              {/* Resto dos campos (s√≥ mostra se ingrediente selecionado) */}
                              {itemFatura.ingredienteId && (
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Quantidade *
                                </label>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={itemFatura.quantidade}
                                  onChange={(e) => setItemFatura({...itemFatura, quantidade: e.target.value})}
                                  placeholder="300"
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Unidade *
                                </label>
                                <select
                                  value={itemFatura.unidade}
                                  onChange={(e) => setItemFatura({...itemFatura, unidade: e.target.value})}
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                >
                                  <option value="">Selecione</option>
                                  <option value="kg">kg</option>
                                  <option value="g">g</option>
                                  <option value="L">L</option>
                                  <option value="ml">ml</option>
                                  <option value="unidade">unidade</option>
                                </select>
                                <p className="text-xs text-gray-500 mt-0.5">Unidade comprada</p>
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Pre√ßo Total (‚Ç¨) *
                                </label>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={itemFatura.precoTotal}
                                  onChange={(e) => setItemFatura({...itemFatura, precoTotal: e.target.value})}
                                  placeholder="0.24"
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                />
                                <p className="text-xs text-gray-500 mt-0.5">Total pago</p>
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  IVA
                                </label>
                                <select
                                  value={itemFatura.iva}
                                  onChange={(e) => setItemFatura({...itemFatura, iva: e.target.value})}
                                  className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                                >
                                  <option value="6">6%</option>
                                  <option value="13">13%</option>
                                  <option value="23">23%</option>
                                </select>
                              </div>
                              
                              <div className="flex items-end">
                                <button
                                  onClick={adicionarItemFatura}
                                  className="w-full bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-semibold transition flex items-center justify-center gap-1"
                                >
                                  <Plus size={14} /> Adicionar
                                </button>
                              </div>
                            </div>
                              )}
                            </>
                          )}
                          
                          {/* MODO OUTRAS DESPESAS - Com descri√ß√£o */}
                          {novaFatura.categoria !== 'compras' && (
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                              <div className="md:col-span-2">
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Descri√ß√£o *
                                </label>
                                <input
                                  type="text"
                                  value={itemFatura.descricao}
                                  onChange={(e) => setItemFatura({...itemFatura, descricao: e.target.value})}
                                  placeholder="Ex: Renda Janeiro, Conta Luz Dezembro..."
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Valor Total (‚Ç¨) *
                                </label>
                                <input
                                  type="number"
                                  step="0.01"
                                  value={itemFatura.precoTotal}
                                  onChange={(e) => setItemFatura({...itemFatura, precoTotal: e.target.value})}
                                  placeholder="650.00"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              
                              {/* Campo IVA - N√ÉO aparece para Sal√°rios */}
                              {novaFatura.categoria !== 'salarios' && (
                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">
                                    IVA
                                  </label>
                                  <select
                                    value={itemFatura.iva}
                                    onChange={(e) => setItemFatura({...itemFatura, iva: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="6">6%</option>
                                    <option value="13">13%</option>
                                    <option value="23">23%</option>
                                  </select>
                                </div>
                              )}
                              
                              {/* Campo N¬∫ Funcion√°rios - S√ì para Sal√°rios */}
                              {novaFatura.categoria === 'salarios' && (
                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">
                                    N¬∫ Funcion√°rios *
                                  </label>
                                  <input
                                    type="number"
                                    min="1"
                                    value={itemFatura.num_funcionarios || 1}
                                    onChange={(e) => setItemFatura({
                                      ...itemFatura,
                                      num_funcionarios: parseInt(e.target.value) || 1
                                    })}
                                    placeholder="1"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  />
                                  <p className="text-xs text-gray-500 mt-1">
                                    üí° Quantas pessoas recebem este sal√°rio
                                  </p>
                                </div>
                              )}
                              
                              <div className="flex items-end md:col-span-4">
                                <button
                                  onClick={adicionarItemFatura}
                                  className="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2"
                                >
                                  <Plus size={16} /> Adicionar Item
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                    
                    {/* Lista de Items */}
                    {(novaFatura.itens || []).length > 0 ? (
                      <div className="space-y-2">
                        {(novaFatura.itens || []).map(item => (
                          <div key={item.id} className="bg-gray-50 rounded-lg p-3 flex items-center justify-between border border-gray-200">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <span className="font-semibold text-sm">{item.ingredienteNome}</span>
                                <span className="text-xs text-gray-500">({item.unidade})</span>
                              </div>
                              <div className="text-xs text-gray-600 mt-1">
                                {item.quantidade} √ó ‚Ç¨{item.precoUnitario.toFixed(2)} = <strong>‚Ç¨{item.subtotal.toFixed(2)}</strong>
                                <span className="ml-2 text-gray-500">(IVA {item.iva}%)</span>
                              </div>
                            </div>
                            <button
                              onClick={() => removerItemFatura(item.id)}
                              className="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition"
                            >
                              <Trash2 size={16} />
                            </button>
                          </div>
                        ))}
                        
                        {/* Totais */}
                        <div className="bg-blue-50 rounded-lg p-3 border border-blue-200 mt-3">
                          <div className="flex justify-between text-sm mb-1">
                            <span>Subtotal:</span>
                            <span className="font-semibold">‚Ç¨{novaFatura.itens.reduce((s, i) => s + i.subtotal, 0).toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between text-sm mb-1">
                            <span>IVA Total:</span>
                            <span className="font-semibold">‚Ç¨{novaFatura.itens.reduce((s, i) => s + (i.subtotal * i.iva / 100), 0).toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between text-base font-bold border-t border-blue-300 pt-2 mt-1">
                            <span>Total c/ IVA:</span>
                            <span className="text-blue-700">‚Ç¨{novaFatura.itens.reduce((s, i) => s + (i.subtotal * (1 + i.iva / 100)), 0).toFixed(2)}</span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="text-center text-gray-500 text-sm py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        Nenhum item adicionado. Adicione items acima.
                      </div>
                    )}
                  </div>
                  
                  {/* Bot√µes */}
                  <div className="flex gap-2">
                    {editandoFatura ? (
                      <>
                        <button
                          onClick={atualizarFatura}
                          className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                        >
                          <Save size={16} /> Atualizar Fatura
                        </button>
                        <button
                          onClick={cancelarEdicaoFatura}
                          className="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition"
                        >
                          Cancelar
                        </button>
                      </>
                    ) : (
                      <button
                        onClick={salvarFatura}
                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                      >
                        <Save size={16} /> Guardar
                      </button>
                    )}
                  </div>
                </>
              )}
              
            </div>
                
                {/* Lista de Faturas */}
                <div>
                  {/* Search Box */}
                  <div className="mb-3">
                    <div className="relative">
                      <input
                        type="text"
                        value={searchFatura}
                        onChange={(e) => setSearchFatura(e.target.value)}
                        placeholder="üîç Pesquisar faturas (n√∫mero, fornecedor, NIF...)"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      />
                      {searchFatura && (
                        <button
                          onClick={() => setSearchFatura('')}
                          className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                        >
                          <X size={18} />
                        </button>
                      )}
                    </div>
                  </div>
                  
                  {/* üÜï FILTROS DE ANO, M√äS E FORNECEDOR */}
                  <div className="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      {/* Filtro de Ano */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Ano</label>
                        <select
                          value={anoFaturaSelecionado}
                          onChange={(e) => setAnoFaturaSelecionado(Number(e.target.value))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          {(() => {
                            const anos = [...new Set(
                              (faturas || [])
                                .filter(f => f.data) // Filtrar faturas sem data
                                .map(f => {
                                  const ano = new Date(f.data).getFullYear();
                                  return isNaN(ano) ? null : ano; // Filtrar anos inv√°lidos
                                })
                                .filter(ano => ano !== null) // Remover nulls
                            )].sort((a, b) => b - a);
                            
                            // Se n√£o houver anos v√°lidos, adicionar o ano atual
                            if (anos.length === 0) {
                              anos.push(new Date().getFullYear());
                            }
                            
                            return anos.map(ano => (
                              <option key={ano} value={ano}>{ano}</option>
                            ));
                          })()}
                        </select>
                      </div>
                      
                      {/* Filtro de M√™s */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üìÜ M√™s</label>
                        <select
                          value={mesFaturaSelecionado || ''}
                          onChange={(e) => setMesFaturaSelecionado(e.target.value === '' ? null : Number(e.target.value))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <option value="">Todos os meses</option>
                          <option value="0">Janeiro</option>
                          <option value="1">Fevereiro</option>
                          <option value="2">Mar√ßo</option>
                          <option value="3">Abril</option>
                          <option value="4">Maio</option>
                          <option value="5">Junho</option>
                          <option value="6">Julho</option>
                          <option value="7">Agosto</option>
                          <option value="8">Setembro</option>
                          <option value="9">Outubro</option>
                          <option value="10">Novembro</option>
                          <option value="11">Dezembro</option>
                        </select>
                      </div>
                      
                      {/* Filtro de Fornecedor */}
                      <div>
                        <label className="block text-xs font-semibold text-gray-700 mb-1">üè™ Fornecedor</label>
                        <select
                          value={fornecedorFiltro}
                          onChange={(e) => setFornecedorFiltro(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <option value="">Todos os fornecedores</option>
                          {(() => {
                            const fornecedoresUnicos = [...new Set((faturas || [])
                              .filter(f => f.fornecedorNome)
                              .map(f => f.fornecedorNome)
                            )].sort();
                            return fornecedoresUnicos.map(nome => (
                              <option key={nome} value={nome}>{nome}</option>
                            ));
                          })()}
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <h3 className="font-semibold text-sm mb-3 flex items-center justify-between">
                    <span>üõí Compras Registadas ({
                      (() => {
                        const total = (faturas || []).length;
                        if (!searchFatura && !fornecedorFiltro && mesFaturaSelecionado === null) return total;
                        const filtered = (faturas || []).filter(fatura => {
                          // Filtro de ano
                          const dataFatura = new Date(fatura.data);
                          if (dataFatura.getFullYear() !== anoFaturaSelecionado) return false;
                          
                          // Filtro de m√™s
                          if (mesFaturaSelecionado !== null && dataFatura.getMonth() !== mesFaturaSelecionado) return false;
                          
                          // Filtro de fornecedor
                          if (fornecedorFiltro && fatura.fornecedorNome !== fornecedorFiltro) return false;
                          
                          // Filtro de pesquisa
                          if (searchFatura) {
                            const search = searchFatura.toLowerCase();
                            return (
                              (fatura.numero || '').toLowerCase().includes(search) ||
                              (fatura.fornecedorNome || '').toLowerCase().includes(search) ||
                              (fatura.fornecedorNif || '').toLowerCase().includes(search) ||
                              (fatura.tipo || '').toLowerCase().includes(search) ||
                              (fatura.itens || []).some(item => 
                                (item.ingredienteNome || '').toLowerCase().includes(search)
                              )
                            );
                          }
                          
                          return true;
                        }).length;
                        return `${filtered} de ${total}`;
                      })()
                    })</span>
                    <div className="flex items-center gap-3 text-xs">
                      <span className="flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded font-semibold">
                        <FilePdf size={14} />
                        {(faturas || []).filter(f => f.documentoPDF).length} com PDF
                      </span>
                      <span className="flex items-center gap-1 bg-red-100 text-red-700 px-2 py-1 rounded font-semibold">
                        <AlertCircle size={14} />
                        {(faturas || []).filter(f => !f.documentoPDF).length} sem PDF
                      </span>
                    </div>
                  </h3>
                  
                  {(faturas || []).length === 0 ? (
                    <div className="text-center text-gray-500 text-sm py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                      Nenhuma fatura registada. Crie a primeira fatura acima!
                    </div>
                  ) : (
                    <div className="space-y-3 pt-16">
                      {(faturas || [])
                        .filter(fatura => {
                          // Filtro de ano
                          const dataFatura = new Date(fatura.data);
                          if (dataFatura.getFullYear() !== anoFaturaSelecionado) return false;
                          
                          // Filtro de m√™s
                          if (mesFaturaSelecionado !== null && dataFatura.getMonth() !== mesFaturaSelecionado) return false;
                          
                          // Filtro de fornecedor
                          if (fornecedorFiltro && fatura.fornecedorNome !== fornecedorFiltro) return false;
                          
                          // Filtro de pesquisa
                          if (searchFatura) {
                            const search = searchFatura.toLowerCase();
                            return (
                              (fatura.numero || '').toLowerCase().includes(search) ||
                              (fatura.fornecedorNome || '').toLowerCase().includes(search) ||
                              (fatura.fornecedorNif || '').toLowerCase().includes(search) ||
                              (fatura.tipo || '').toLowerCase().includes(search) ||
                              (fatura.itens || []).some(item => 
                                (item.ingredienteNome || '').toLowerCase().includes(search)
                              )
                            );
                          }
                          
                          return true;
                        })
                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                        .map(fatura => (
                        <div key={fatura.id} className="border rounded-lg hover:shadow-md transition relative group">
                          {/* üÜï Tooltip com nome do PDF (hover) - MELHORADO */}
                          {fatura.nomeDocumento && fatura.id === ultimaFaturaInserida && (
                            <div className="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-sm px-4 py-2 rounded-lg shadow-xl invisible group-hover:visible transition-all duration-200 whitespace-nowrap z-50 pointer-events-none">
                              <div className="flex items-center gap-2">
                                <FilePdf size={16} className="text-red-400" />
                                <span className="font-mono font-semibold">{fatura.nomeDocumento}</span>
                              </div>
                              {/* Seta para baixo */}
                              <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                <div className="border-8 border-transparent border-t-gray-800"></div>
                              </div>
                            </div>
                          )}
                          
                          {/* Cabe√ßalho da Fatura (sempre vis√≠vel) */}
                          <div 
                            onClick={() => setExpandedFatura(expandedFatura === fatura.id ? null : fatura.id)}
                            className={`p-4 cursor-pointer transition rounded-lg ${
                              fatura.id === ultimaFaturaInserida
                                ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 hover:from-green-100 hover:to-emerald-100'
                                : 'bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-1">
                                  {/* üÜï Badge √öLTIMA INSERIDA */}
                                  {fatura.id === ultimaFaturaInserida && (
                                    <span className="flex items-center gap-1 bg-green-600 text-white text-xs px-2 py-1 rounded font-bold shadow-md">
                                      ‚ö° √öLTIMA INSERIDA
                                    </span>
                                  )}
                                  
                                  <span className="font-bold text-blue-700">
                                    {fatura.tipo === 'rapido' ? '‚ö°' : 'üìÑ'} {fatura.numero || 'Recibo'}
                                  </span>
                                  
                                  {/* Badge Tipo de Documento (FT/FR/FS) */}
                                  {(() => {
                                    const tipo = fatura.tipo || 'FT';
                                    const tipoDoc = fatura.tipoDocumento || 'fatura';
                                    
                                    // Determinar cor e texto baseado no tipo
                                    let bgColor, textColor, borderColor, emoji, label;
                                    
                                    if (tipo === 'FR' || tipo.includes('FR')) {
                                      bgColor = 'bg-blue-100';
                                      textColor = 'text-blue-700';
                                      borderColor = 'border-blue-300';
                                      emoji = 'üìÑ';
                                      label = 'FR - Fatura Recibo';
                                    } else if (tipo === 'FS' || tipo.includes('FS')) {
                                      bgColor = 'bg-purple-100';
                                      textColor = 'text-purple-700';
                                      borderColor = 'border-purple-300';
                                      emoji = 'üßæ';
                                      label = 'FS - Fatura Simplificada';
                                    } else if (tipo === 'FT' || tipoDoc === 'fatura') {
                                      bgColor = 'bg-green-100';
                                      textColor = 'text-green-700';
                                      borderColor = 'border-green-300';
                                      emoji = 'üßæ';
                                      label = 'FT - Fatura';
                                    } else {
                                      bgColor = 'bg-gray-100';
                                      textColor = 'text-gray-700';
                                      borderColor = 'border-gray-300';
                                      emoji = 'üìù';
                                      label = 'Recibo';
                                    }
                                    
                                    return (
                                      <span className={`text-xs px-2 py-1 rounded font-bold ${bgColor} ${textColor} border ${borderColor}`}>
                                        {emoji} {label}
                                      </span>
                                    );
                                  })()}
                                  
                                  {/* Indicador de PDF */}
                                  {fatura.documentoPDF ? (
                                    <span 
                                      className="flex items-center gap-1 text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-semibold"
                                      title="PDF anexado"
                                    >
                                      <FilePdf size={14} />
                                      <Check size={12} />
                                      PDF
                                    </span>
                                  ) : (
                                    <span 
                                      className="flex items-center gap-1 text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-semibold"
                                      title="SEM PDF - Adicione o documento fiscal!"
                                    >
                                      <AlertCircle size={14} />
                                      SEM PDF
                                    </span>
                                  )}
                                  
                                  <span className="text-sm text-gray-600">{fatura.fornecedorNome}</span>
                                  <span className="text-xs text-gray-500">{new Date(fatura.data).toLocaleDateString('pt-PT')}</span>
                                  
                                  {/* üÜï Nome do PDF - SEMPRE VIS√çVEL se for √∫ltima inserida (na mesma linha) */}
                                  {fatura.nomeDocumento && fatura.id === ultimaFaturaInserida && (
                                    <span className="text-xs bg-yellow-50 border border-yellow-300 px-2 py-1 rounded font-mono text-gray-800 font-semibold">
                                      {fatura.nomeDocumento}
                                    </span>
                                  )}
                                </div>
                                
                                <div className="flex items-center gap-4 text-sm">
                                  <span className="text-gray-600">{(fatura.itens || []).length} {(fatura.itens || []).length === 1 ? 'item' : 'items'}</span>
                                  <span className="font-bold text-blue-700">Total: ‚Ç¨{(fatura.total || 0).toFixed(2)}</span>
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    editarFatura(fatura);
                                  }}
                                  className="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-2 rounded transition"
                                >
                                  <Edit2 size={16} />
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    apagarFatura(fatura.id);
                                  }}
                                  className="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition"
                                >
                                  <Trash2 size={16} />
                                </button>
                                <button className="text-gray-600">
                                  {expandedFatura === fatura.id ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                                </button>
                              </div>
                            </div>
                          </div>
                          
                          {/* Detalhes da Fatura (expans√≠vel) */}
                          {expandedFatura === fatura.id && (
                            <div className="bg-white p-4 border-t">
                              <div className="mb-3">
                                <h4 className="font-semibold text-sm mb-2 text-gray-700">Fornecedor:</h4>
                                <div className="bg-gray-50 rounded p-2 text-sm">
                                  <p><strong>{fatura.fornecedorNome}</strong></p>
                                  {fatura.fornecedorNif && <p className="text-gray-600 text-xs">NIF: {fatura.fornecedorNif}</p>}
                                </div>
                              </div>
                              
                              <div className="mb-3">
                                <h4 className="font-semibold text-sm mb-2 text-gray-700">Items:</h4>
                                <div className="space-y-2">
                                  {(fatura.itens || []).map(item => {
                                    const ingredienteNome = item.ingredienteNome || 'N/A';
                                    const quantidade = item.quantidade || 0;
                                    const precoUnitario = item.precoUnitario || 0;
                                    const subtotal = item.subtotal || 0;
                                    const unidade = item.unidade || '';
                                    const iva = item.iva || 6;
                                    
                                    return (
                                    <div key={item.id || Math.random()} className="bg-gray-50 rounded p-3 text-sm">
                                      <div className="flex justify-between items-start mb-1">
                                        <span className="font-medium">{ingredienteNome}</span>
                                        <span className="font-semibold text-blue-700">‚Ç¨{subtotal.toFixed(2)}</span>
                                      </div>
                                      <div className="text-xs text-gray-600">
                                        {quantidade} {unidade} √ó ‚Ç¨{precoUnitario.toFixed(2)}
                                        <span className="ml-2">(IVA {iva}%: +‚Ç¨{(subtotal * iva / 100).toFixed(2)})</span>
                                      </div>
                                    </div>
                                    );
                                  })}
                                </div>
                              </div>
                              
                              <div className="bg-blue-50 rounded p-3 border border-blue-200">
                                <div className="flex justify-between text-sm mb-1">
                                  <span>Subtotal:</span>
                                  <span className="font-semibold">‚Ç¨{(fatura.subtotal || fatura.total || 0).toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between text-sm mb-1">
                                  <span>IVA Total:</span>
                                  <span className="font-semibold">‚Ç¨{(fatura.totalIva || 0).toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between text-base font-bold border-t border-blue-300 pt-2 mt-1">
                                  <span>Total c/ IVA:</span>
                                  <span className="text-blue-700">‚Ç¨{(fatura.total || 0).toFixed(2)}</span>
                                </div>
                              </div>
                              
                              {fatura.notas && (
                                <div className="mt-3 bg-yellow-50 rounded p-2 border border-yellow-200">
                                  <p className="text-xs text-gray-700"><strong>Notas:</strong> {fatura.notas}</p>
                                </div>
                              )}
                              
                              {/* Sec√ß√£o de PDF */}
                              <div className="mt-3">
                                {fatura.documentoPDF ? (
                                  <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center gap-3">
                                        <div>
                                          <p className="text-sm font-semibold text-green-900">
                                            üìÑ {fatura.nomeDocumento || 'Documento.pdf'}
                                          </p>
                                          <p className="text-xs text-green-700">
                                            PDF anexado ‚úÖ
                                          </p>
                                        </div>
                                      </div>
                                      <button
                                        onClick={() => {
                                          try {
                                            // Converter base64 para Blob
                                            const base64Data = fatura.documentoPDF.split(',')[1] || fatura.documentoPDF;
                                            const byteCharacters = atob(base64Data);
                                            const byteNumbers = new Array(byteCharacters.length);
                                            for (let i = 0; i < byteCharacters.length; i++) {
                                              byteNumbers[i] = byteCharacters.charCodeAt(i);
                                            }
                                            const byteArray = new Uint8Array(byteNumbers);
                                            const blob = new Blob([byteArray], { type: 'application/pdf' });
                                            
                                            // Criar URL do blob
                                            const blobUrl = URL.createObjectURL(blob);
                                            
                                            // Abrir em nova janela
                                            window.open(blobUrl, '_blank');
                                          } catch (error) {
                                            void 0;
                                            alert('Erro ao abrir PDF. Verifique a consola para detalhes.');
                                          }
                                        }}
                                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition"
                                      >
                                        <Eye size={18} />
                                        Visualizar PDF
                                      </button>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="bg-red-50 border-2 border-red-300 rounded-lg p-3">
                                    <div className="flex items-center gap-3">
                                      <div className="flex-1">
                                        <p className="text-sm font-semibold text-red-900">
                                          ‚ö†Ô∏è SEM PDF Anexado
                                        </p>
                                        <p className="text-xs text-red-700 mt-1">
                                          Sem o documento fiscal original, a AT pode rejeitar a dedu√ß√£o de IVA!
                                          Edite a fatura e adicione o PDF.
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              

</div>
            )}

            {gestaoSubTab === 'vendas' && (
              <div className="backdrop-blur-lg bg-white/70 border-2 border-white/50 rounded-2xl shadow-xl p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-lg font-bold">Gest√£o de Vendas</h2>
                  <button
                    onClick={() => setMostrarVendaManual(true)}
                    className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition flex items-center gap-2 font-semibold shadow"
                  >
                    <Plus size={18} />
                    Adicionar Venda Manual
                  </button>
                </div>
                
                {/* NOVO: Importa√ß√£o com Mapeamento Autom√°tico */}
                <div className="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
                  <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                    <Upload size={20} />
                    üì• Importar Vendas
                  </h3>
                  <p className="text-sm text-gray-600 mb-3">
                    Importe vendas do Moloni (CSV) ou Zobaze (Excel) com mapeamento autom√°tico de produtos.
                  </p>
                  <button
                    onClick={() => setMostrarImportacao(true)}
                    className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition flex items-center gap-2 font-bold shadow-lg w-full justify-center"
                  >
                    <Upload size={18} />
                    üöÄ Importar com Mapeamento Autom√°tico
                  </button>
                </div>

                {/* Sales Table */}
                <div className="overflow-x-auto rounded border">
                  <table className="w-full text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left font-semibold">Data</th>
                        <th className="px-2 py-2 text-left font-semibold">Produto</th>
                        <th className="px-2 py-2 text-right font-semibold">Quantidade</th>
                        <th className="px-2 py-2 text-right font-semibold">Valor</th>
                        <th className="px-2 py-2 text-center font-semibold">IVA</th>
                        <th className="px-2 py-2 text-center font-semibold">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {vendas.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 100).map((v, idx) => (
                        <tr key={v.id} className={`border-t hover:bg-gray-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 py-2">{new Date(v.data).toLocaleDateString('pt-PT')}</td>
                          <td className="px-2 py-2 font-medium">
                            <div className="flex items-center gap-2">
                              {v.produto}
                              {/* Tag de Origem */}
                              {v.origem === 'moloni' && (
                                <span className="px-1.5 py-0.5 bg-green-100 text-green-700 rounded text-[10px] font-bold" title="Importado do Moloni">
                                  MOLONI
                                </span>
                              )}
                              {v.origem === 'zobaze' && (
                                <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-[10px] font-bold" title="Importado do Zobaze">
                                  ZOBAZE
                                </span>
                              )}
                              {!v.origem && v.tipo === 'manual' && (
                                <span className="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded text-[10px] font-bold" title="Venda manual">
                                  MANUAL
                                </span>
                              )}
                              {!v.produtoId && (
                                <span className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold" title="Produto n√£o emparelhado">
                                  ‚ö†Ô∏è Sem emparelhamento
                                </span>
                              )}
                            </div>
                          </td>
                          <td className="px-2 py-2 text-right">{v.quantidade}</td>
                          <td className="px-2 py-2 text-right font-bold text-green-600">‚Ç¨{v.valor.toFixed(2)}</td>
                          <td className="px-2 py-2 text-center">
                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                              {v.iva}%
                            </span>
                          </td>
                          <td className="px-2 py-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button 
                                onClick={() => {
                                  setVendaEditando(v.id);
                                  setNovaVenda({
                                    data: v.data,
                                    produtoId: v.produtoId || '',
                                    produto: v.produto,
                                    quantidade: v.quantidade,
                                    valorManual: v.valor.toString(),
                                    usarValorManual: true
                                  });
                                  setMostrarEditarVenda(true);
                                }}
                                className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                title="Editar venda"
                              >
                                <Edit size={14} />
                              </button>
                              <button onClick={() => {
                                if (confirm('Eliminar esta venda?')) {
                                  setVendas(vendas.filter(x => x.id !== v.id));
                                  showNotification('Venda eliminada!', 'success');
                                }
                              }}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="Eliminar venda"
                              >
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                {(vendas || []).length > 100 && (
                  <p className="text-center text-xs text-gray-500 mt-2">
                    A mostrar as 100 vendas mais recentes de {(vendas || []).length} totais
                  </p>
                )}
                
                {!(vendas || []).length && (
                  <div className="text-center py-12">
                    <p className="text-gray-400 text-sm">Nenhuma venda importada</p>
                    <p className="text-gray-400 text-xs mt-1">Importe um ficheiro CSV do Moloni ou adicione vendas manualmente</p>
                  </div>
                )}
                
                {/* Modal Venda Manual */}
                {mostrarVendaManual && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 pt-8 overflow-y-auto">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold">Adicionar Venda Manual</h3>
                        <button
                          onClick={() => setMostrarVendaManual(false)}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <X size={24} />
                        </button>
                      </div>
                      
                      <div className="space-y-4">
                        {/* Data */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Data *
                          </label>
                          <input
                            type="date"
                            value={novaVenda.data}
                            onChange={(e) => setNovaVenda({...novaVenda, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          />
                        </div>
                        
                        {/* Produto */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Produto * {produtos.length === 0 && <span className="text-red-500 text-xs">(Nenhum produto dispon√≠vel)</span>}
                          </label>
                          <select
                            value={novaVenda.produtoId}
                            onChange={(e) => setNovaVenda({...novaVenda, produtoId: e.target.value ? parseInt(e.target.value) : ''})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          >
                            <option value="">Selecione um produto</option>
                            {produtos.map(p => (
                              <option key={p.id} value={p.id}>
                                {p.nome} - ‚Ç¨{p.precoVenda.toFixed(2)} (IVA {p.iva}%)
                              </option>
                            ))}
                          </select>
                        </div>
                        
                        {/* Quantidade */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Quantidade *
                          </label>
                          <input
                            type="number"
                            min="1"
                            step="1"
                            value={novaVenda.quantidade}
                            onChange={(e) => setNovaVenda({...novaVenda, quantidade: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                          />
                        </div>
                        
                        {/* Informa√ß√£o do produto selecionado */}
                        {novaVenda.produtoId && (() => {
                          const produtoSelecionado = produtos.find(p => p.id === novaVenda.produtoId);
                          if (!produtoSelecionado) return null;
                          
                          const valorCalculado = produtoSelecionado.precoVenda * parseFloat(novaVenda.quantidade || 0);
                          
                          return (
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg space-y-2">
                              <div className="flex justify-between text-sm">
                                <span className="text-gray-600">Pre√ßo unit√°rio:</span>
                                <span className="font-semibold">‚Ç¨{produtoSelecionado.precoVenda.toFixed(2)}</span>
                              </div>
                              <div className="flex justify-between text-sm">
                                <span className="text-gray-600">IVA:</span>
                                <span className="font-semibold">{produtoSelecionado.iva}%</span>
                              </div>
                              <div className="flex justify-between text-sm pt-2 border-t border-blue-300">
                                <span className="text-gray-700 font-medium">Valor total:</span>
                                <span className="font-bold text-green-600 text-lg">‚Ç¨{valorCalculado.toFixed(2)}</span>
                              </div>
                            </div>
                          );
                        })()}
                        
                        {/* Valor manual (opcional) */}
                        {novaVenda.produtoId && (
                          <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <label className="flex items-center gap-2 cursor-pointer mb-2">
                              <input
                                type="checkbox"
                                checked={novaVenda.usarValorManual}
                                onChange={(e) => setNovaVenda({...novaVenda, usarValorManual: e.target.checked})}
                                className="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                              />
                              <span className="text-sm text-gray-700 font-medium">Sobrescrever valor total</span>
                            </label>
                            
                            {novaVenda.usarValorManual && (
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">Valor personalizado:</label>
                                <input
                                  type="number"
                                  step="0.01"
                                  min="0"
                                  value={novaVenda.valorManual}
                                  onChange={(e) => setNovaVenda({...novaVenda, valorManual: e.target.value})}
                                  placeholder="‚Ç¨0.00"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                  Use isto para descontos ou promo√ß√µes especiais
                                </p>
                              </div>
                            )}
                          </div>
                        )}
                        
                        {/* Campos de Documenta√ß√£o Oficial (Expand√≠vel) */}
                        <details className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                          <summary className="cursor-pointer font-medium text-sm text-gray-700 flex items-center gap-2">
                            üìã Documenta√ß√£o Oficial (Opcional)
                          </summary>
                          <div className="space-y-3 mt-3">
                            {/* N√∫mero do Documento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                N¬∫ Documento
                              </label>
                              <input
                                type="text"
                                value={novaVenda.numeroDocumento}
                                onChange={(e) => setNovaVenda({...novaVenda, numeroDocumento: e.target.value})}
                                placeholder="Ex: VD-2026-0001"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              />
                            </div>
                            
                            {/* Tipo de Documento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Tipo de Documento
                              </label>
                              <select
                                value={novaVenda.tipoDocumento}
                                onChange={(e) => setNovaVenda({...novaVenda, tipoDocumento: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              >
                                <option value="Venda">Venda</option>
                                <option value="Fatura Simplificada">Fatura Simplificada</option>
                                <option value="Fatura">Fatura</option>
                                <option value="Recibo">Recibo</option>
                                <option value="Nota de Cr√©dito">Nota de Cr√©dito</option>
                              </select>
                            </div>
                            
                            {/* Forma de Pagamento */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Forma de Pagamento
                              </label>
                              <select
                                value={novaVenda.formaPagamento}
                                onChange={(e) => setNovaVenda({...novaVenda, formaPagamento: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              >
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="MB Way">MB Way</option>
                                <option value="Multibanco">Multibanco</option>
                                <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
                                <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
                                <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                                <option value="Cheque">Cheque</option>
                              </select>
                            </div>
                            
                            {/* Observa√ß√µes */}
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">
                                Observa√ß√µes
                              </label>
                              <textarea
                                value={novaVenda.observacoes}
                                onChange={(e) => setNovaVenda({...novaVenda, observacoes: e.target.value})}
                                placeholder="Informa√ß√µes adicionais..."
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                              />
                            </div>
                          </div>
                        </details>
                        
                        {/* Bot√µes */}
                        <div className="flex gap-3 pt-4">
                          <button
                            onClick={() => setMostrarVendaManual(false)}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={adicionarVendaManual}
                            className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                          >
                            Adicionar Venda
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Modal Editar Venda */}
                {mostrarEditarVenda && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 pt-8 overflow-y-auto">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 my-8">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold">‚úèÔ∏è Editar Venda</h3>
                        <button
                          onClick={() => {
                            setMostrarEditarVenda(false);
                            setVendaEditando(null);
                          }}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <X size={20} />
                        </button>
                      </div>
                      
                      <div className="space-y-4">
                        {/* Nome do Produto Original */}
                        <div className="bg-gray-50 border rounded-lg p-3">
                          <p className="text-xs text-gray-600 mb-1">Produto importado:</p>
                          <p className="font-bold text-gray-800">{novaVenda.produto}</p>
                        </div>
                        
                        {/* Emparelhar com Produto */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">
                            üîó Emparelhar com Produto:
                          </label>
                          <select
                            value={novaVenda.produtoId}
                            onChange={(e) => {
                              const prodId = e.target.value;
                              const prod = produtos.find(p => p.id === prodId);
                              setNovaVenda({
                                ...novaVenda, 
                                produtoId: prodId,
                                valorManual: prod ? prod.precoVenda.toString() : novaVenda.valorManual
                              });
                            }}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- Sem emparelhamento --</option>
                            {produtos.map(p => (
                              <option key={p.id} value={p.id}>
                                {p.nome} (‚Ç¨{p.precoVenda})
                              </option>
                            ))}
                          </select>
                          <p className="text-xs text-gray-500 mt-1">
                            {novaVenda.produtoId 
                              ? '‚úÖ Produto emparelhado - aparecer√° nas m√©tricas' 
                              : '‚ö†Ô∏è Sem emparelhamento - n√£o afeta m√©tricas de produto'}
                          </p>
                        </div>
                        
                        {/* Data */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Data:</label>
                          <input
                            type="date"
                            value={novaVenda.data}
                            onChange={(e) => setNovaVenda({...novaVenda, data: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Quantidade */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Quantidade:</label>
                          <input
                            type="number"
                            min="1"
                            value={novaVenda.quantidade}
                            onChange={(e) => setNovaVenda({...novaVenda, quantidade: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Valor */}
                        <div>
                          <label className="block text-sm font-semibold mb-2">Valor (‚Ç¨):</label>
                          <input
                            type="number"
                            step="0.01"
                            min="0"
                            value={novaVenda.valorManual}
                            onChange={(e) => setNovaVenda({...novaVenda, valorManual: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        
                        {/* Bot√µes */}
                        <div className="flex gap-2 pt-4">
                          <button
                            onClick={() => {
                              setMostrarEditarVenda(false);
                              setVendaEditando(null);
                            }}
                            className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={() => {
                              const vendaAtualizada = {
                                ...vendas.find(v => v.id === vendaEditando),
                                data: novaVenda.data,
                                produtoId: novaVenda.produtoId || null,
                                produto: novaVenda.produtoId 
                                  ? produtos.find(p => p.id === novaVenda.produtoId)?.nome || novaVenda.produto
                                  : novaVenda.produto,
                                quantidade: novaVenda.quantidade,
                                valor: parseFloat(novaVenda.valorManual)
                              };
                              
                              setVendas(vendas.map(v => 
                                v.id === vendaEditando ? vendaAtualizada : v
                              ));
                              
                              setMostrarEditarVenda(false);
                              setVendaEditando(null);
                              showNotification('‚úÖ Venda atualizada!', 'success');
                            }}
                            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                          >
                            üíæ Guardar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* TAB DEFINI√á√ïES */}
        {activeTab === 'definicoes' && (
          <div className="space-y-3">
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-2xl font-bold mb-4">
                ‚öôÔ∏è Defini√ß√µes
              </h2>
              <p className="text-gray-600 mb-6">Configure as prefer√™ncias do Munchi Manager</p>
              
              <div className="space-y-6">
                {/* ==================== CONFIGURA√á√ïES V2.0 ==================== */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-green-50 to-blue-50">
                  <button
                    onClick={() => setConfiguracoesExpanded(!configuracoesExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-green-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        ‚öôÔ∏è Configura√ß√µes do Sistema
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Filtros de m√©tricas e alertas de margem
                      </p>
                    </div>
                    {configuracoesExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {configuracoesExpanded && (
                    <div className="p-4 border-t border-green-200 bg-white">
                      <PainelConfiguracoes
                        configuracoes={configuracoes}
                        onSalvar={handleSalvarConfiguracoes}
                        vendas={vendas}
                        setVendas={setVendas}
                        showNotification={showNotification}
                      />
                    </div>
                  )}
                </div>
                {/* ==================== FIM CONFIGURA√á√ïES V2.0 ==================== */}
                
                {/* Dados da Empresa */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-blue-50 to-purple-50">
                  <button
                    onClick={() => setDadosEmpresaExpanded(!dadosEmpresaExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-blue-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üè¢ Dados da Empresa
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Informa√ß√µes fiscais da sua empresa
                      </p>
                    </div>
                    {dadosEmpresaExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {dadosEmpresaExpanded && (
                    <div className="p-4 border-t border-blue-200 bg-white">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        NIF/NIPC *
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).nif}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), nif: e.target.value})}
                        placeholder="123456789"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Nome da Empresa *
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).nome}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), nome: e.target.value})}
                        placeholder="Munchi Restaurant, Lda"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Morada Fiscal
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).morada}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), morada: e.target.value})}
                        placeholder="Rua Example, 123"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        C√≥digo Postal
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).codigoPostal}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), codigoPostal: e.target.value})}
                        placeholder="1000-001"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Cidade
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).cidade}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), cidade: e.target.value})}
                        placeholder="Lisboa"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        CAE (C√≥digo Atividade)
                      </label>
                      <input
                        type="text"
                        value={(dadosEmpresa || {}).cae}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), cae: e.target.value})}
                        placeholder="56101"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Email
                      </label>
                      <input
                        type="email"
                        value={(dadosEmpresa || {}).email}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), email: e.target.value})}
                        placeholder="geral@munchi.pt"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Telefone
                      </label>
                      <input
                        type="tel"
                        value={(dadosEmpresa || {}).telefone}
                        onChange={(e) => setDadosEmpresa({...(dadosEmpresa || {}), telefone: e.target.value})}
                        placeholder="+351 21 123 4567"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                  </div>
                  
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-xs text-blue-800">
                      <strong>üí° Dica:</strong> Estes dados ser√£o inclu√≠dos nos exports CSV para o contabilista e em futuros exports certificados (SAF-T).
                    </p>
                  </div>
                  
                  {(dadosEmpresa.nif && dadosEmpresa.nome) && (
                    <div className="mt-3 bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                      <span className="text-green-600">‚úÖ</span>
                      <p className="text-xs text-green-800 font-medium">
                        Dados da empresa configurados!
                      </p>
                    </div>
                  )}
                </div>
              )}
                </div>
                
                {/* Fornecedores */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-purple-50 to-pink-50">
                  <button
                    onClick={() => setFornecedoresExpanded(!fornecedoresExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-purple-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üë• Fornecedores
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Gerir contactos de fornecedores
                      </p>
                    </div>
                    {fornecedoresExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {fornecedoresExpanded && (
                    <div className="p-4 border-t border-purple-200 bg-white">
                      {/* Formul√°rio Novo Fornecedor */}
                      <div id="fornecedor-form" className="bg-purple-50 rounded-lg p-4 mb-4 border-2 border-purple-200">
                        <h4 className="font-semibold text-sm mb-3">
                          {editandoFornecedor ? '‚úèÔ∏è Editar Fornecedor' : '‚ûï Adicionar Fornecedor'}
                        </h4>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Nome do Fornecedor *
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.nome}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, nome: e.target.value})}
                              placeholder="Ex: Mercearia Silva"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              NIF
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.nif}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, nif: e.target.value})}
                              placeholder="123456789"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div className="md:col-span-2">
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Morada
                            </label>
                            <input
                              type="text"
                              value={dadosFornecedor.morada}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, morada: e.target.value})}
                              placeholder="Rua Example, 123"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Email
                            </label>
                            <input
                              type="email"
                              value={dadosFornecedor.email}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, email: e.target.value})}
                              placeholder="contacto@fornecedor.pt"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Telefone
                            </label>
                            <input
                              type="tel"
                              value={dadosFornecedor.telefone}
                              onChange={(e) => setDadosFornecedor({...dadosFornecedor, telefone: e.target.value})}
                              placeholder="+351 21 123 4567"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                        </div>
                        
                        {editandoFornecedor ? (
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={salvarEdicaoFornecedor}
                              className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                            >
                              <Save size={16} /> Guardar Altera√ß√µes
                            </button>
                            <button
                              onClick={cancelarEdicaoFornecedor}
                              className="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition"
                            >
                              Cancelar
                            </button>
                          </div>
                        ) : (
                          <button
                            onClick={adicionarNovoFornecedor}
                            className="w-full mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center gap-2"
                          >
                            <Plus size={16} /> Adicionar Fornecedor
                          </button>
                        )}
                      </div>
                      
                      {/* Lista de Fornecedores */}
                      <div>
                        <h4 className="font-semibold text-sm mb-3">
                          üìã Fornecedores Registados ({(fornecedores || []).length})
                        </h4>
                        
                        {(fornecedores || []).length === 0 ? (
                          <div className="text-center text-gray-500 text-sm py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                            Nenhum fornecedor registado.
                          </div>
                        ) : (
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {(fornecedores || []).map(fornecedor => {
                              const isOldFormat = typeof fornecedor === 'string';
                              const id = isOldFormat ? fornecedor : fornecedor.id;
                              const nome = isOldFormat ? fornecedor : fornecedor.nome;
                              const nif = isOldFormat ? '' : fornecedor.nif;
                              const morada = isOldFormat ? '' : fornecedor.morada;
                              const email = isOldFormat ? '' : fornecedor.email;
                              const telefone = isOldFormat ? '' : fornecedor.telefone;
                              
                              return (
                                <div key={id} className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-200">
                                  <div className="flex items-start justify-between mb-2">
                                    <div className="flex-1">
                                      <h5 className="font-bold text-purple-900 text-sm">{nome}</h5>
                                      {nif && <p className="text-xs text-gray-600 mt-1">NIF: {nif}</p>}
                                    </div>
                                    {!isOldFormat && (
                                      <div className="flex gap-1">
                                        <button
                                          onClick={() => editarFornecedor(fornecedor)}
                                          className="text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 p-1 rounded transition"
                                          title="Editar fornecedor"
                                        >
                                          <Edit2 size={14} />
                                        </button>
                                        <button
                                          onClick={() => apagarFornecedor(id)}
                                          className="text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded transition"
                                          title="Apagar fornecedor"
                                        >
                                          <Trash2 size={14} />
                                        </button>
                                      </div>
                                    )}
                                  </div>
                                  
                                  {!isOldFormat && (
                                    <div className="text-xs text-gray-600 space-y-1">
                                      {morada && <p>üìç {morada}</p>}
                                      {email && <p>‚úâÔ∏è {email}</p>}
                                      {telefone && <p>üìû {telefone}</p>}
                                    </div>
                                  )}
                                  
                                  <div className="mt-2 pt-2 border-t border-purple-200 flex items-center justify-between text-xs">
                                    <span className="text-gray-600">
                                      Compras: <strong>{(faturas || []).filter(f => f.fornecedorId === id).length}</strong>
                                    </span>
                                    <span className="text-gray-600">
                                      Total: <strong>‚Ç¨{(faturas || []).filter(f => f.fornecedorId === id).reduce((sum, f) => sum + f.total, 0).toFixed(2)}</strong>
                                    </span>
                                  </div>
                                  
                                  {/* üö´ FILTROS OCR - BLACKLIST E PALAVRAS A LIMPAR */}
                                  {nif && (() => {
                                    const template = templatesOCR.find(t => t.nifFornecedor === nif);
                                    const temBlacklist = template?.blacklist && template.blacklist.length > 0;
                                    const temPalavras = template?.palavrasLimpar && template.palavrasLimpar.length > 0;
                                    const totalFiltros = (template?.blacklist?.length || 0) + (template?.palavrasLimpar?.length || 0);
                                    
                                    if (!temBlacklist && !temPalavras) return null;
                                    
                                    const isExpanded = fornecedoresExpandidos[nif];
                                    
                                    return (
                                      <div className="mt-2 pt-2 border-t border-purple-200">
                                        <button
                                          onClick={() => setFornecedoresExpandidos(prev => ({
                                            ...prev,
                                            [nif]: !prev[nif]
                                          }))}
                                          className="w-full flex items-center justify-between hover:bg-purple-50 -mx-3 px-3 py-1.5 rounded transition"
                                        >
                                          <span className="text-xs font-semibold text-purple-900 flex items-center gap-1">
                                            üö´ Filtros OCR
                                            <span className="bg-purple-200 text-purple-800 px-1.5 py-0.5 rounded-full text-[10px] font-bold">
                                              {totalFiltros}
                                            </span>
                                          </span>
                                          {isExpanded ? <ChevronUp size={14} /> : <ChevronDown size={14} />}
                                        </button>
                                        
                                        {isExpanded && (
                                          <div className="mt-2 space-y-2">
                                            {/* BLACKLIST */}
                                            {temBlacklist && (
                                              <div className="bg-red-50 rounded-lg p-2 border border-red-200">
                                                <div className="flex items-center justify-between mb-1.5">
                                                  <h5 className="text-[10px] font-bold text-red-900 uppercase tracking-wide">
                                                    üö´ Blacklist ({template.blacklist.length})
                                                  </h5>
                                                </div>
                                                <div className="space-y-1 max-h-32 overflow-y-auto">
                                                  {template.blacklist.map((item, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-white p-1.5 rounded border border-red-100 text-[10px]">
                                                      <span className="font-mono text-gray-700 flex-1 truncate" title={item}>
                                                        {item}
                                                      </span>
                                                      <button
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          if (confirm(`Remover "${item.substring(0, 40)}..." da blacklist?`)) {
                                                            const novaBlacklist = template.blacklist.filter(b => b !== item);
                                                            const index = templatesOCR.findIndex(t => t.nifFornecedor === nif);
                                                            const novos = [...templatesOCR];
                                                            novos[index] = { ...template, blacklist: novaBlacklist };
                                                            setTemplatesOCR(novos);
                                                            showNotification('‚úÖ Removido da blacklist!', 'success');
                                                          }
                                                        }}
                                                        className="text-red-600 hover:text-red-800 px-1 hover:bg-red-100 rounded ml-1"
                                                      >
                                                        ‚ùå
                                                      </button>
                                                    </div>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                            
                                            {/* PALAVRAS A LIMPAR */}
                                            {temPalavras && (
                                              <div className="bg-blue-50 rounded-lg p-2 border border-blue-200">
                                                <div className="flex items-center justify-between mb-1.5">
                                                  <h5 className="text-[10px] font-bold text-blue-900 uppercase tracking-wide">
                                                    üßπ Palavras Limpar ({template.palavrasLimpar.length})
                                                  </h5>
                                                </div>
                                                <div className="space-y-1 max-h-32 overflow-y-auto">
                                                  {template.palavrasLimpar.map((palavra, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-white p-1.5 rounded border border-blue-100 text-[10px]">
                                                      <span className="font-mono text-gray-700 flex-1 truncate" title={palavra}>
                                                        {palavra}
                                                      </span>
                                                      <button
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          if (confirm(`Restaurar "${palavra}"?`)) {
                                                            const novasPalavras = template.palavrasLimpar.filter(p => p !== palavra);
                                                            const index = templatesOCR.findIndex(t => t.nifFornecedor === nif);
                                                            const novos = [...templatesOCR];
                                                            novos[index] = { ...template, palavrasLimpar: novasPalavras };
                                                            setTemplatesOCR(novos);
                                                            showNotification('‚úÖ Palavra restaurada!', 'success');
                                                          }
                                                        }}
                                                        className="text-blue-600 hover:text-blue-800 px-1 hover:bg-blue-100 rounded ml-1"
                                                      >
                                                        ‚Ü©Ô∏è
                                                      </button>
                                                    </div>
                                                  ))}
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })()}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Apps de Delivery */}
                <div className="border rounded-lg overflow-hidden shadow-sm bg-gradient-to-br from-orange-50 to-yellow-50 border-orange-200">
                  <button
                    onClick={() => setDeliveryAppsExpanded(!deliveryAppsExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-orange-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üöó Apps de Delivery
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Configurar Uber Eats, Glovo, Bolt Food, etc
                      </p>
                    </div>
                    {deliveryAppsExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {deliveryAppsExpanded && (
                    <div className="p-4 border-t border-orange-200 bg-white">
                      <p className="text-xs text-gray-600 mb-4">
                        üí° Ative as apps que utiliza para ver simula√ß√µes de pre√ßos e margens no Dashboard
                      </p>
                      
                      {/* Lista de Apps */}
                      <div className="space-y-3 mb-4">
                        {(deliveryApps || []).map(app => (
                          <div key={app.id} className={`border-2 rounded-lg p-3 ${app.ativo ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-3">
                                <button
                                  onClick={() => toggleApp(app.id)}
                                  className={`w-12 h-6 rounded-full transition ${app.ativo ? 'bg-green-500' : 'bg-gray-300'} relative`}
                                >
                                  <div className={`w-5 h-5 rounded-full bg-white absolute top-0.5 transition-all ${app.ativo ? 'left-6' : 'left-0.5'}`}></div>
                                </button>
                                <div>
                                  <h4 className="font-bold text-sm">{app.nome}</h4>
                                  <p className="text-xs text-gray-500">
                                    {app.ativo ? '‚úÖ Ativa' : '‚ùå Inativa'}
                                  </p>
                                </div>
                              </div>
                              
                              <button
                                onClick={() => apagarApp(app.id)}
                                className="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="Apagar app"
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">Comiss√£o (%)</label>
                                {editandoApp === app.id ? (
                                  <div className="flex gap-1">
                                    <input
                                      type="number"
                                      step="0.1"
                                      defaultValue={app.comissao}
                                      id={`comissao-${app.id}`}
                                      className="w-full px-2 py-1 border rounded text-sm"
                                    />
                                    <button
                                      onClick={() => {
                                        const novaComissao = document.getElementById(`comissao-${app.id}`).value;
                                        atualizarComissaoApp(app.id, novaComissao);
                                      }}
                                      className="bg-green-500 text-white px-2 rounded hover:bg-green-600"
                                    >
                                      ‚úì
                                    </button>
                                  </div>
                                ) : (
                                  <div className="flex items-center gap-2">
                                    <span className="font-bold text-lg">{app.comissao}%</span>
                                    <button
                                      onClick={() => setEditandoApp(app.id)}
                                      className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                                    >
                                      <Edit2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                              
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">√öltima atualiza√ß√£o</label>
                                <span className="text-xs text-gray-500">{new Date(app.dataAtualizacao).toLocaleDateString('pt-PT')}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      {/* Adicionar Nova App */}
                      <div className="bg-orange-50 rounded-lg p-3 border-2 border-orange-200">
                        <h4 className="font-semibold text-sm mb-2">‚ûï Adicionar Nova App</h4>
                        <div className="grid grid-cols-2 gap-2">
                          <input
                            type="text"
                            placeholder="Nome (ex: Just Eat)"
                            value={novaApp.nome}
                            onChange={(e) => setNovaApp({...novaApp, nome: e.target.value})}
                            className="px-2 py-1.5 border rounded text-sm"
                          />
                          <div className="flex gap-1">
                            <input
                              type="number"
                              step="0.1"
                              placeholder="Comiss√£o %"
                              value={novaApp.comissao}
                              onChange={(e) => setNovaApp({...novaApp, comissao: e.target.value})}
                              className="flex-1 px-2 py-1.5 border rounded text-sm"
                            />
                            <button
                              onClick={adicionarNovaApp}
                              className="bg-orange-500 text-white px-3 rounded hover:bg-orange-600 font-semibold text-sm"
                            >
                              +
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Backup e Sincroniza√ß√£o */}
                <div className="border rounded-lg overflow-hidden bg-gradient-to-r from-gray-50 to-blue-50">
                  <button
                    onClick={() => setBackupExpanded(!backupExpanded)}
                    className="w-full p-4 flex items-center justify-between hover:bg-blue-100 transition"
                  >
                    <div>
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üíæ Backup e Sincroniza√ß√£o
                      </h3>
                      <p className="text-sm text-gray-600 text-left mt-1">
                        Sincronize automaticamente com a cloud ou fa√ßa backup/restauro manual.
                      </p>
                    </div>
                    {backupExpanded ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
                  </button>
                  
                  {backupExpanded && (
                  <div className="border-t border-gray-200 bg-white p-4">
                  
                  {/* Grid: Export/Import + GitHub + Google Drive */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    
                    {/* Coluna Esquerda: Export/Import + GitHub */}
                    <div className="space-y-3">
                      {/* Exportar/Importar Local */}
                      <div className="grid grid-cols-2 gap-3">
                        {/* Exportar */}
                        <div className="bg-white rounded-lg p-3 border-2 border-green-200">
                          <h4 className="font-semibold text-green-800 text-sm mb-2 flex items-center gap-1">
                            <Download size={14} />
                            Exportar
                          </h4>
                          <p className="text-xs text-gray-600 mb-2">
                            Backup local (JSON) - Dados do Google Drive
                          </p>
                          <button 
                            onClick={exportarDados}
                            className="w-full bg-green-600 hover:bg-green-700 text-white rounded px-3 py-2 text-xs font-semibold flex items-center justify-center gap-1 transition"
                            title="Exporta os dados atuais (mesmos que est√£o no Google Drive)"
                          >
                            <Download size={12} />
                            Exportar
                          </button>
                        </div>
                        
                        {/* Importar */}
                        <div className="bg-white rounded-lg p-3 border-2 border-blue-200">
                          <h4 className="font-semibold text-blue-800 text-sm mb-2 flex items-center gap-1">
                            <Upload size={14} />
                            Importar
                          </h4>
                          <p className="text-xs text-gray-600 mb-2">
                            Restaurar backup
                          </p>
                          <label className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-2 text-xs font-semibold flex items-center justify-center gap-1 transition cursor-pointer">
                            <Upload size={12} />
                            Importar
                            <input type="file" accept=".json" onChange={importarDados} className="hidden" />
                          </label>
                        </div>
                      </div>
                      
                      {/* GitHub Backup */}
                      <GitHubBackupPanel 
                        onSync={async () => {
                          const token = GitHubSync.getToken();
                          if (!token) {
                            showNotification('Configure o GitHub primeiro!', 'error');
                            return;
                          }
                          
                          const allData = {
                            produtos,
                            ingredientes,
                            vendas,
                            despesas,
                            faturas,
                            fornecedores,
                            deliveryApps,
                            embalagens,
                            dadosEmpresa,
                            version: '2.0'
                          };
                          
                          const result = await GitHubSync.saveToGist(allData, token);
                          if (result.success) {
                            showNotification('‚úÖ Backup sincronizado com GitHub!', 'success');
                          } else {
                            showNotification(`‚ùå Erro: ${result.error}`, 'error');
                          }
                        }}
                      />
                    </div>

                    {/* Coluna Direita: Google Drive */}
                    <div id="google-drive-section">
                      {!driveAccessToken ? (
                        <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 h-full">
                          <div className="flex items-start gap-3 mb-3">
                            <div className="bg-blue-600 rounded-lg p-2 flex-shrink-0">
                              <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12.945 1.379l-.652.763c-.026-.008-.052-.014-.078-.023L6.364 7.97l3.352 5.796 2.32-4.01a1.158 1.158 0 011.099-.706c.326.006.611.177.78.435l.033.053 8.684 15.07h-6.666L13.185 18h-2.37l-.003.001L6.277 7.965 6.209 8h-.012L1.363 16l3.314 5.735 8.716.002c.276 0 .509-.137.709-.356l9.677-16.91-.002-.002c-.01-.017-.022-.032-.033-.049-.288-.52-.754-.882-1.308-.988L12.945 1.379z"/>
                              </svg>
                            </div>
                            <div className="flex-1">
                              <h4 className="font-bold text-blue-900 mb-1 text-sm">
                                ‚òÅÔ∏è Google Drive
                              </h4>
                              <p className="text-xs text-gray-700 mb-2">
                                Sincroniza√ß√£o autom√°tica entre dispositivos.
                              </p>
                              <ul className="text-xs text-gray-600 space-y-0.5 mb-3">
                                <li>‚úÖ Multi-dispositivo</li>
                                <li>‚úÖ Backup autom√°tico</li>
                                <li>‚úÖ 15GB gr√°tis</li>
                              </ul>
                            </div>
                          </div>
                          
                          <button
                            onClick={loginGoogleDrive}
                            className="w-full bg-white border-2 border-gray-300 hover:border-blue-500 hover:shadow-lg rounded-lg px-3 py-2.5 text-sm font-semibold flex items-center justify-center gap-2 transition"
                          >
                            <svg className="w-4 h-4" viewBox="0 0 24 24">
                              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Conectar
                          </button>
                          
                          <p className="text-xs text-gray-500 mt-2 text-center">
                            üîí Acesso s√≥ aos ficheiros do Munchi
                          </p>
                        </div>
                      ) : (
                        <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 h-full">
                          <div className="flex items-center gap-2 mb-3">
                            {driveUser?.image && (
                              <img 
                                src={driveUser.image} 
                                alt={driveUser.name}
                                className="w-10 h-10 rounded-full border-2 border-green-400"
                              />
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="font-bold text-green-900 text-sm truncate">{driveUser?.name || 'Utilizador'}</p>
                              <p className="text-xs text-green-700 truncate">{driveUser?.email || ''}</p>
                              <p className="text-xs text-gray-600 mt-0.5">
                                {driveSyncing ? (
                                  <span className="flex items-center gap-1">
                                    <svg className="animate-spin h-3 w-3" viewBox="0 0 24 24">
                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                    </svg>
                                    A sincronizar...
                                  </span>
                                ) : driveLastSync ? (
                                  `‚úÖ Sync h√° ${Math.round((new Date() - driveLastSync) / 60000)} min`
                                ) : (
                                  '‚è≥ Aguardando sync'
                                )}
                              </p>
                            </div>
                            <button
                              onClick={logoutGoogleDrive}
                              className="text-xs text-red-600 hover:text-red-800 px-2 py-1 border border-red-300 rounded hover:bg-red-50 transition flex-shrink-0"
                            >
                              Sair
                            </button>
                          </div>
                          
                          {/* ‚úÖ Indicador de Status do Token */}
                          <div className={`mb-3 p-2 rounded-lg border-2 ${
                            driveTokenValid 
                              ? 'bg-green-100 border-green-400' 
                              : driveTokenTimeLeft > 0 
                                ? 'bg-yellow-100 border-yellow-400' 
                                : 'bg-red-100 border-red-400'
                          }`}>
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${
                                  driveTokenValid 
                                    ? 'bg-green-500' 
                                    : driveTokenTimeLeft > 0 
                                      ? 'bg-yellow-500 animate-pulse' 
                                      : 'bg-red-500'
                                }`}></div>
                                <span className="text-xs font-semibold">
                                  {driveTokenValid 
                                    ? 'üîì Conectado' 
                                    : driveTokenTimeLeft > 0 
                                      ? '‚ö†Ô∏è A expirar' 
                                      : 'üîí Expirado'}
                                </span>
                              </div>
                              {driveTokenTimeLeft > 0 && (
                                <span className={`text-xs font-mono ${
                                  driveTokenTimeLeft < 10 ? 'text-red-600 font-bold' : 'text-gray-700'
                                }`}>
                                  {driveTokenTimeLeft}min
                                </span>
                              )}
                            </div>
                          </div>
                          
                          {driveError && (
                            <div className="bg-red-100 border border-red-300 rounded p-2 mb-2">
                              <p className="text-xs text-red-800">‚ö†Ô∏è {driveError}</p>
                            </div>
                          )}
                          
                          <div className="grid grid-cols-2 gap-2 mb-2">
                            <button
                              onClick={saveToDrive}
                              disabled={driveSyncing || !driveTokenValid}
                              className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                            >
                              <Upload size={12} />
                              Sync
                            </button>
                            
                            <button
                              onClick={() => loadFromDrive()}
                              disabled={driveSyncing || !driveTokenValid}
                              className="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                            >
                              <Download size={12} />
                              Carregar
                            </button>
                          </div>
                          
                          {/* üÜï Bot√£o Restaurar Backups Versionados */}
                          <button
                            onClick={async () => {
                              setLoadingBackups(true);
                              const backups = await listDriveBackups(driveAccessToken);
                              setDriveBackups(backups);
                              setShowBackupRecovery(true);
                              setLoadingBackups(false);
                            }}
                            disabled={driveSyncing || !driveTokenValid}
                            className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition mb-2"
                          >
                            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd"/>
                            </svg>
                            Restaurar Backup Anterior
                          </button>
                          
                          {/* ‚úÖ Bot√£o de Renova√ß√£o de Token */}
                          <button
                            onClick={loginGoogleDrive}
                            className="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-xs font-semibold flex items-center justify-center gap-1 transition"
                          >
                            üîë Renovar Token
                          </button>
                          
                          {driveFileId && (
                            <p className="text-xs text-gray-500 mt-2 text-center">
                              üìÅ {GOOGLE_DRIVE_CONFIG.FILE_NAME}
                            </p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                    <p className="text-xs text-yellow-800">
                      <strong>üí° Dica:</strong> Use GitHub ou Google Drive para backup autom√°tico. Export/Import para backup manual.
                    </p>
                  </div>
                  </div>
                  )}
                </div>
                
                {/* Exportar para Contabilista - Dropdown */}
                <div className="border rounded-lg overflow-hidden">
                  <button
                    onClick={() => setExportarExpanded(!exportarExpanded)}
                    className="w-full p-4 flex items-center justify-between bg-gradient-to-r from-blue-50 to-green-50 hover:from-blue-100 hover:to-green-100 transition"
                  >
                    <div className="text-left">
                      <h3 className="font-bold text-lg flex items-center gap-2">
                        üìä Exportar para Contabilista
                      </h3>
                      <p className="text-sm text-gray-600">
                        Gerar CSV/ZIP com faturas do per√≠odo selecionado
                      </p>
                    </div>
                    {exportarExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                  </button>
                  
                  {exportarExpanded && (
                    <div className="border-t bg-white p-4 space-y-4">
                      
                      {/* Filtro de Datas */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 className="font-semibold text-sm mb-3 flex items-center gap-2">
                          üìÖ Per√≠odo para Exportar
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Data In√≠cio
                            </label>
                            <input
                              type="date"
                              value={exportDateStart}
                              onChange={(e) => setExportDateStart(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Data Fim
                            </label>
                            <input
                              type="date"
                              value={exportDateEnd}
                              onChange={(e) => setExportDateEnd(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>
                        
                        {/* Atalhos r√°pidos */}
                        <div className="flex flex-wrap gap-2 mt-3">
                          <button
                            onClick={() => {
                              const hoje = new Date();
                              const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                              setExportDateStart(inicioMes.toISOString().split('T')[0]);
                              setExportDateEnd(hoje.toISOString().split('T')[0]);
                            }}
                            className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                          >
                            Este M√™s
                          </button>
                          <button
                            onClick={() => {
                              const hoje = new Date();
                              const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
                              const fimMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
                              setExportDateStart(inicioMesAnterior.toISOString().split('T')[0]);
                              setExportDateEnd(fimMesAnterior.toISOString().split('T')[0]);
                            }}
                            className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                          >
                            M√™s Anterior
                          </button>
                          <button
                            onClick={() => {
                              setExportDateStart('');
                              setExportDateEnd('');
                            }}
                            className="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700"
                          >
                            Todas as Datas
                          </button>
                        </div>
                        
                        <p className="text-xs text-blue-700 mt-2">
                          üí° <strong>Em Portugal:</strong> Enviar faturas ao contabilista <strong>mensalmente at√© dia 10</strong> do m√™s seguinte
                        </p>
                      </div>
                  
                      {/* Export Combinado */}
                      <div className="bg-gradient-to-br from-white to-blue-50 rounded-lg border-2 border-blue-300 p-4">
                        <h4 className="font-bold text-blue-900 mb-3">
                          üìã Relat√≥rio de Apoio Contabil√≠stico
                        </h4>
                        
                        {/* Estat√≠sticas do per√≠odo selecionado */}
                        <div className="bg-purple-50 border border-purple-200 rounded p-3 mb-4">
                          <div className="flex items-center gap-2 mb-2">
                            <h5 className="font-bold text-purple-900 text-sm">üìÑ Documentos no Per√≠odo</h5>
                          </div>
                          <div className="grid grid-cols-3 gap-2 mb-3">
                            <div className="bg-white rounded-lg p-2 text-center border border-purple-200">
                              <p className="text-lg font-bold text-purple-600">{(() => {
                                // Usar FATURAS em vez de despesas
                                if (!exportDateStart && !exportDateEnd) return faturas.filter(f => f.tipoDocumento === 'fatura' || !f.tipoDocumento).length;
                                return faturas.filter(f => {
                                  if (f.tipoDocumento === 'recibo') return false; // Excluir recibos
                                  const dataFatura = f.data;
                                  if (!dataFatura) return false;
                                  if (exportDateStart && dataFatura < exportDateStart) return false;
                                  if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                  return true;
                                }).length;
                              })()}</p>
                              <p className="text-purple-600 text-xs mt-1">Total</p>
                            </div>
                            <div className="bg-green-50 rounded-lg p-2 text-center border border-green-200">
                              <p className="text-lg font-bold text-green-600">{(() => {
                                if (!exportDateStart && !exportDateEnd) return faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && f.documentoPDF).length;
                                return faturas.filter(f => {
                                  if (f.tipoDocumento === 'recibo') return false;
                                  const dataFatura = f.data;
                                  if (!dataFatura) return false;
                                  if (exportDateStart && dataFatura < exportDateStart) return false;
                                  if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                  return f.documentoPDF;
                                }).length;
                              })()}</p>
                              <p className="text-green-600 text-xs mt-1">‚úÖ Com PDF</p>
                            </div>
                            <div className="bg-red-50 rounded-lg p-2 text-center border border-red-200">
                              <p className="text-lg font-bold text-red-600">{(() => {
                                if (!exportDateStart && !exportDateEnd) return faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && !f.documentoPDF).length;
                                return faturas.filter(f => {
                                  if (f.tipoDocumento === 'recibo') return false;
                                  const dataFatura = f.data;
                                  if (!dataFatura) return false;
                                  if (exportDateStart && dataFatura < exportDateStart) return false;
                                  if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                  return !f.documentoPDF;
                                }).length;
                              })()}</p>
                              <p className="text-red-600 text-xs mt-1">‚ö†Ô∏è Sem PDF</p>
                            </div>
                          </div>
                          
                          {/* Breakdown por tipo de fatura */}
                          <div className="bg-blue-50 border-t border-blue-200 pt-2 mt-2">
                            <p className="text-xs font-semibold text-blue-900 mb-2">Por Tipo de Documento:</p>
                            <div className="grid grid-cols-3 gap-2 text-xs">
                              <div className="bg-white rounded p-1.5 text-center">
                                <p className="font-bold text-green-700">{(() => {
                                  const filtered = faturas.filter(f => {
                                    if (f.tipoDocumento === 'recibo') return false;
                                    const dataFatura = f.data;
                                    if (!dataFatura) return false;
                                    if (exportDateStart && dataFatura < exportDateStart) return false;
                                    if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                    return (f.tipo === 'FT' || !f.tipo);
                                  });
                                  return exportDateStart || exportDateEnd ? filtered.length : faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && (f.tipo === 'FT' || !f.tipo)).length;
                                })()}</p>
                                <p className="text-green-700">‚úÖ FT</p>
                              </div>
                              <div className="bg-white rounded p-1.5 text-center">
                                <p className="font-bold text-blue-700">{(() => {
                                  const filtered = faturas.filter(f => {
                                    if (f.tipoDocumento === 'recibo') return false;
                                    const dataFatura = f.data;
                                    if (!dataFatura) return false;
                                    if (exportDateStart && dataFatura < exportDateStart) return false;
                                    if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                    return f.tipo === 'FR';
                                  });
                                  return exportDateStart || exportDateEnd ? filtered.length : faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && f.tipo === 'FR').length;
                                })()}</p>
                                <p className="text-blue-700">‚úÖ FR</p>
                              </div>
                              <div className="bg-white rounded p-1.5 text-center">
                                <p className="font-bold text-orange-700">{(() => {
                                  const filtered = faturas.filter(f => {
                                    if (f.tipoDocumento === 'recibo') return false;
                                    const dataFatura = f.data;
                                    if (!dataFatura) return false;
                                    if (exportDateStart && dataFatura < exportDateStart) return false;
                                    if (exportDateEnd && dataFatura > exportDateEnd) return false;
                                    return f.tipo === 'FS';
                                  });
                                  return exportDateStart || exportDateEnd ? filtered.length : faturas.filter(f => (f.tipoDocumento === 'fatura' || !f.tipoDocumento) && f.tipo === 'FS').length;
                                })()}</p>
                                <p className="text-orange-700">‚ùå FS</p>
                              </div>
                            </div>
                            <p className="text-xs text-blue-800 mt-2 italic">
                              * Apenas FT e FR ser√£o exportadas para o contabilista
                            </p>
                          </div>
                        </div>
                        
                        {/* Bot√µes de Export */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <button 
                            onClick={exportarRelatorioCompletoCSV}
                            className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-6 py-3 text-base font-bold flex items-center justify-center gap-2 transition shadow-lg"
                          >
                            <FileText size={18} />
                            S√≥ CSV (R√°pido)
                          </button>
                          
                          <button 
                            onClick={exportarPacoteCompleto}
                            className="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white rounded-lg px-6 py-3 text-base font-bold flex items-center justify-center gap-2 transition shadow-lg"
                          >
                            <Download size={18} />
                            Pacote Completo (ZIP)
                          </button>
                        </div>
                        
                        <p className="text-xs text-gray-600 mt-3">
                          <strong>CSV:</strong> Dados estruturados para lan√ßamento<br/>
                          <strong>ZIP:</strong> CSV + PDFs das faturas (recomendado)
                        </p>
                      </div>
                      
                      {/* AVISO LEGAL */}
                      <div className="bg-red-50 border border-red-300 rounded p-3">
                        <p className="text-xs font-bold text-red-900 mb-1">‚ö†Ô∏è AVISO LEGAL</p>
                        <ul className="text-xs text-red-800 space-y-1">
                          <li>‚Ä¢ CSV √© APOIO, n√£o substitui documentos fiscais</li>
                          <li>‚Ä¢ PDFs das faturas s√£o OBRIGAT√ìRIOS</li>
                          <li>‚Ä¢ <strong>Apenas FT e FR</strong> s√£o exportadas (FS n√£o pode ser deduzida)</li>
                          <li>‚Ä¢ Conservar documentos 10 anos (Lei Geral Tribut√°ria)</li>
                        </ul>
                      </div>
                    </div>
                  )}
                </div>
                
                <div>
                  <h3 className="font-semibold mb-2">‚ÑπÔ∏è Sobre</h3>
                  <p className="text-sm text-gray-600">
                    <strong>Munchi Manager</strong> v1.0<br/>
                    Sistema de gest√£o para restaurantes
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
      
      {/* Modal OCR */}
      {mostrarModalOCR && (
        <ModalConfirmacaoOCR 
          linhas={linhasOCR}
          ingredientes={ingredientes}
          metadata={metadataOCR}
          fornecedores={fornecedores}
          onConfirmar={handleConfirmarOCR}
          onCancelar={() => setMostrarModalOCR(false)}
          showNotification={showNotification}
          setFornecedores={setFornecedores}
        />
      )}
      
      {/* ==================== MODAL CONFIRMA√á√ÉO FATURA V2.0 ==================== */}
      {modalConfirmacaoFatura.mostrar && modalConfirmacaoFatura.dados && (
        <ModalConfirmacaoFatura
          dadosFatura={modalConfirmacaoFatura.dados}
          fornecedores={fornecedores}
          onConfirmar={handleConfirmarFatura}
          onCancelar={handleCancelarFatura}
          showNotification={showNotification}
          setFornecedores={setFornecedores}
        />
      )}
      {/* ==================== FIM MODAL V2.0 ==================== */}
      
      {/* ==================== üÜï MODAL DESPESA SIMPLES (RENDA/LUZ/√ÅGUA) ==================== */}
      {modalDespesaSimples.mostrar && modalDespesaSimples.dados && (
        <ModalDespesaSimples
          dadosDespesa={modalDespesaSimples.dados}
          onConfirmar={handleConfirmarDespesaSimples}
          onCancelar={handleCancelarDespesaSimples}
        />
      )}
      {/* ==================== FIM MODAL DESPESA SIMPLES ==================== */}
      
      {/* Modal de Importa√ß√£o com Mapeamento Autom√°tico */}
      {mostrarImportacao && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 pt-8 overflow-y-auto">
          <div className="bg-white rounded-lg p-6 max-w-md w-full my-8">
            <h3 className="text-lg font-bold mb-4">üì¶ Importar Vendas (Autom√°tico)</h3>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Fonte dos Dados:</label>
              <select
                value={fonteImportacao}
                onChange={(e) => setFonteImportacao(e.target.value)}
                className="w-full border rounded p-2"
              >
                <option value="moloni">üè¢ Moloni</option>
                <option value="zobaze">üì± Zobaze</option>
              </select>
            </div>
            
            <div className="bg-purple-50 border border-purple-200 rounded p-3 mb-4">
              <p className="text-xs text-purple-800 mb-2 font-semibold">
                ‚ú® Mapeamento Autom√°tico Ativado!
              </p>
              <p className="text-xs text-purple-700">
                ‚Ä¢ <strong>134 regras</strong> de convers√£o autom√°ticas<br/>
                ‚Ä¢ Nomes corrigidos instantaneamente<br/>
                ‚Ä¢ Ex: "Expresso" ‚Üí "Caf√© Expresso"
              </p>
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold mb-2">Formato CSV esperado:</label>
              <div className="bg-gray-50 border rounded p-2 text-xs font-mono">
                Data,Produto,Valor<br/>
                2026-02-01,Expresso,1.35<br/>
                2026-02-01,Croissant,10.00
              </div>
            </div>
            
            <div className="mb-4">
              <label className="bg-purple-600 text-white rounded px-4 py-2 text-sm hover:bg-purple-700 cursor-pointer inline-flex items-center gap-2 font-semibold shadow hover:shadow-lg transition w-full justify-center">
                <Upload size={16} />
                Escolher Arquivo CSV
                <input
                  type="file"
                  accept={fonteImportacao === 'moloni' ? '.csv' : '.xlsx,.xls'}
                  onChange={fonteImportacao === 'moloni' ? importarVendasCSV : processarZobaze}
                  className="hidden"
                />
              </label>
            </div>
            
            <div className="flex gap-2">
              <button
                onClick={() => setMostrarImportacao(false)}
                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üÜï MODAL DE CONTAGEM MANUAL */}
      {modalContagem && ingredienteContagem && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 my-8">
            <h3 className="text-xl font-bold mb-4">
              üìä Contagem de Stock - {ingredienteContagem.nome}
            </h3>
            
            <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
              <p className="text-sm text-gray-700">
                <span className="font-semibold">Modo:</span> {ingredienteContagem.modoWaste === 'manual' ? 'üë§ Manual' : 'ü§ñ Autom√°tico'}
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-semibold">Stock Atual:</span> {ingredienteContagem.stockAtual || 0} {ingredienteContagem.unidade}
              </p>
              <p className="text-sm text-gray-700">
                <span className="font-semibold">Stock M√≠nimo:</span> {ingredienteContagem.stockMinimo || 0} {ingredienteContagem.unidade}
              </p>
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Stock Real Contado (hoje):
              </label>
              <div className="flex gap-2 items-center">
                <input
                  type="number"
                  step="0.01"
                  value={valorContagem}
                  onChange={(e) => setValorContagem(e.target.value)}
                  className="flex-1 px-3 py-2 border rounded text-lg font-bold"
                  placeholder="0.00"
                  autoFocus
                />
                <span className="text-gray-600 font-semibold">{ingredienteContagem.unidade}</span>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                üí° Conta fisicamente o stock atual e insere o valor
              </p>
            </div>
            
            {ingredienteContagem.modoWaste === 'manual' && (
              <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-xs text-yellow-800">
                  ‚ö†Ô∏è <span className="font-semibold">Modo Manual:</span> O sistema calcular√° automaticamente a % real de desperd√≠cio comparando com o stock te√≥rico.
                </p>
              </div>
            )}
            
            <div className="flex gap-2">
              <button
                onClick={() => {
                  setModalContagem(false);
                  setIngredienteContagem(null);
                  setValorContagem(0);
                }}
                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 font-semibold"
              >
                Cancelar
              </button>
              <button
                onClick={salvarContagem}
                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold"
              >
                ‚úÖ Salvar Stock
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* üìä MODAL DE MOVIMENTA√á√ïES DE STOCK */}
      {mostrarModalMovimentacoes && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="bg-gradient-to-r from-indigo-600 to-blue-600 px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">üìä Hist√≥rico de Movimenta√ß√µes de Stock</h2>
              <div className="flex items-center gap-2">
                <button 
                  onClick={recalcularMovimentacoes} 
                  className="text-white hover:bg-white/20 rounded-lg px-3 py-2 transition flex items-center gap-2 text-sm font-semibold"
                  title="Recalcular todo o hist√≥rico baseado nas compras e vendas atuais"
                >
                  <RefreshCw className="w-4 h-4" />
                  Recalcular
                </button>
                <button onClick={() => setMostrarModalMovimentacoes(false)} className="text-white hover:bg-white/20 rounded-full p-2 transition">
                  <X className="w-5 h-5" />
                </button>
              </div>
            </div>
            <div className="bg-gray-50 px-6 py-3 border-b grid grid-cols-4 gap-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">{movimentacoesStock.filter(m => m.tipo === 'entrada').length}</div>
                <div className="text-xs text-gray-600">Entradas</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-red-600">{movimentacoesStock.filter(m => m.tipo === 'saida').length}</div>
                <div className="text-xs text-gray-600">Sa√≠das</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">{movimentacoesStock.filter(m => m.tipo === 'ajuste').length}</div>
                <div className="text-xs text-gray-600">Ajustes</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-gray-700">{movimentacoesStock.length}</div>
                <div className="text-xs text-gray-600">Total</div>
              </div>
            </div>
            <div className="flex-1 overflow-auto p-6">
              {movimentacoesStock.length === 0 ? (
                <div className="text-center py-12">
                  <BarChart3 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-500 font-medium">Nenhuma movimenta√ß√£o registrada ainda</p>
                  <p className="text-xs text-gray-400 mt-2">As movimenta√ß√µes ser√£o registradas automaticamente</p>
                </div>
              ) : (
                <table className="w-full"><thead className="bg-gray-100 sticky top-0"><tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Data</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Tipo</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Ingrediente</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold">Quantidade</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold">Stock Antes</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold">Stock Depois</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold">Observa√ß√£o</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold">A√ß√µes</th>
                </tr></thead><tbody className="divide-y divide-gray-200">
                  {movimentacoesStock.sort((a, b) => new Date(b.data) - new Date(a.data)).map((mov, idx) => (
                    <tr key={mov.id || idx} className="hover:bg-gray-50">
                      <td className="px-4 py-3 text-sm">{new Date(mov.data).toLocaleDateString('pt-PT')}</td>
                      <td className="px-4 py-3">
                        <span className={`px-2 py-1 text-xs font-semibold rounded ${
                          mov.tipo === 'entrada' ? 'bg-green-100 text-green-700' : 
                          mov.tipo === 'ajuste' ? 'bg-purple-100 text-purple-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {mov.tipo === 'entrada' ? '‚Üë Entrada' : 
                           mov.tipo === 'ajuste' ? '‚öôÔ∏è Ajuste' :
                           '‚Üì Sa√≠da'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-sm font-medium">{mov.ingredienteNome}</td>
                      <td className="px-4 py-3 text-sm text-right font-mono">
                        <span className={
                          mov.tipo === 'entrada' ? 'text-green-600' : 
                          mov.tipo === 'ajuste' ? (mov.quantidade >= 0 ? 'text-purple-600' : 'text-orange-600') :
                          'text-red-600'
                        }>
                          {mov.tipo === 'entrada' || (mov.tipo === 'ajuste' && mov.quantidade >= 0) ? '+' : '-'}
                          {Math.abs(mov.quantidade).toFixed(2)} {mov.unidade}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-sm text-right font-mono text-gray-600">{mov.stockAnterior ? mov.stockAnterior.toFixed(2) : '0.00'}</td>
                      <td className="px-4 py-3 text-sm text-right font-mono font-semibold">{mov.stockNovo ? mov.stockNovo.toFixed(2) : '0.00'}</td>
                      <td className="px-4 py-3 text-xs text-gray-600">{mov.observacao}</td>
                      <td className="px-4 py-3 text-center">
                        {mov.tipo === 'ajuste' ? (
                          <button
                            onClick={() => removerMovimentacao(mov.id)}
                            className="text-red-600 hover:bg-red-50 rounded p-1 transition"
                            title="Remover ajuste manual"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        ) : (
                          <span className="text-gray-300 text-xs">‚Äî</span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody></table>
              )}
            </div>
            <div className="bg-gray-50 px-6 py-3 border-t flex justify-between items-center">
              <div className="text-xs text-gray-500">üí° Movimenta√ß√µes autom√°ticas de vendas e compras</div>
              <button onClick={() => setMostrarModalMovimentacoes(false)} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold text-sm">Fechar</button>
            </div>
          </div>
        </div>
      )}
      
      {/* üÜï MODAL DE RECOVERY DE BACKUPS VERSIONADOS */}
      {showBackupRecovery && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="bg-gradient-to-r from-purple-600 to-blue-600 px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white flex items-center gap-2">
                <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd"/>
                </svg>
                Restaurar Backup Anterior
              </h2>
              <button 
                onClick={() => setShowBackupRecovery(false)}
                className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="p-6 overflow-y-auto flex-1">
              {loadingBackups ? (
                <div className="flex items-center justify-center py-12">
                  <svg className="animate-spin h-8 w-8 text-purple-600" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                  </svg>
                </div>
              ) : driveBackups.length === 0 ? (
                <div className="text-center py-12">
                  <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  <p className="text-gray-600 font-semibold">Nenhum backup encontrado</p>
                  <p className="text-sm text-gray-500 mt-2">Os backups s√£o criados automaticamente ao sincronizar</p>
                </div>
              ) : (
                <div className="space-y-3">
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-blue-800">
                      <strong>üí° Dica:</strong> Backups s√£o criados automaticamente a cada sincroniza√ß√£o. 
                      Os √∫ltimos {GOOGLE_DRIVE_CONFIG.MAX_BACKUPS} backups s√£o mantidos.
                    </p>
                  </div>
                  
                  {driveBackups.map((backup, index) => {
                    const date = new Date(backup.modifiedTime);
                    const isRecent = index === 0;
                    const size = (backup.size / 1024).toFixed(1);
                    
                    return (
                      <div 
                        key={backup.id}
                        className={`border-2 rounded-lg p-4 transition hover:shadow-md ${
                          isRecent 
                            ? 'border-green-400 bg-green-50' 
                            : 'border-gray-200 bg-white'
                        }`}
                      >
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              {isRecent && (
                                <span className="bg-green-600 text-white text-xs px-2 py-0.5 rounded-full font-semibold">
                                  MAIS RECENTE
                                </span>
                              )}
                              <span className="text-gray-500 text-xs">#{driveBackups.length - index}</span>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2 text-sm">
                              <div>
                                <span className="text-gray-600">üìÖ Data:</span>
                                <span className="ml-2 font-semibold">{date.toLocaleDateString('pt-PT')}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">‚è∞ Hora:</span>
                                <span className="ml-2 font-semibold">{date.toLocaleTimeString('pt-PT')}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">üíæ Tamanho:</span>
                                <span className="ml-2 font-mono text-xs">{size} KB</span>
                              </div>
                              <div>
                                <span className="text-gray-600">üïê H√°:</span>
                                <span className="ml-2 font-semibold">
                                  {Math.round((new Date() - date) / 60000)} min
                                </span>
                              </div>
                            </div>
                            
                            <p className="text-xs text-gray-500 mt-2 font-mono truncate">
                              {backup.name}
                            </p>
                          </div>
                          
                          <button
                            onClick={async () => {
                              if (confirm(`‚ö†Ô∏è CONFIRMAR RESTAURO\n\nVai restaurar o backup de:\n${date.toLocaleString('pt-PT')}\n\nOs dados atuais ser√£o substitu√≠dos.\n\nContinuar?`)) {
                                const success = await loadSpecificBackup(driveAccessToken, backup.id);
                                if (success) {
                                  setShowBackupRecovery(false);
                                }
                              }
                            }}
                            className={`px-4 py-2 rounded-lg font-semibold text-sm transition flex items-center gap-2 ${
                              isRecent
                                ? 'bg-green-600 hover:bg-green-700 text-white'
                                : 'bg-purple-600 hover:bg-purple-700 text-white'
                            }`}
                          >
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd"/>
                            </svg>
                            Restaurar
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            
            <div className="bg-gray-50 px-6 py-3 border-t flex justify-end">
              <button 
                onClick={() => setShowBackupRecovery(false)}
                className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<RestauranteGestor />);
    </script>
</body>
</html>
